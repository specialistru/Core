# üß† –ë–ª–æ–∫ 1.5 ‚Äî NUMA-aware —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ó–Ω–∞—á–µ–Ω–∏–µ                            |
| --------- | ----------------------------------- |
| üì¶ –ü–∞–∫–µ—Ç  | 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ         |
| üî¢ –ë–ª–æ–∫   | 1.5 ‚Äî NUMA-aware —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é |

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

NUMA-aware —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é –ø–æ–∑–≤–æ–ª—è–µ—Ç:

* –ü–æ–≤—ã—Å–∏—Ç—å –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–º—è—Ç–∏,
* –ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å **remote memory latency**,
* –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å —Ä–µ—Å—É—Ä—Å—ã –º–µ–∂–¥—É shard-–∞–º–∏, –ø–æ—Ç–æ–∫–∞–º–∏ –∏ —Å–µ—Å—Å–∏—è–º–∏.

–î–≤–∏–∂–æ–∫ –¥–æ–ª–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å **–ø–∞–º—è—Ç—å, –ø–æ—Ç–æ–∫–∏ –∏ —à–∞—Ä–¥** –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É NUMA-—É–∑–ª—É –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å NUMA-statistics –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞       | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                |
| ---------------- | ----------------------------------------------------------------------- |
| –ê–ª–ª–æ–∫–∞—Ç–æ—Ä        | NUMA-aware allocator: –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É–∑–ª—É (local vs interleave vs remote) |
| –ü–æ—Ç–æ–∫–∏           | CPU-pinning –ø–æ—Ç–æ–∫–æ–≤ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á, executor'–æ–≤, WAL writer'–æ–≤           |
| –†–∞–∑–º–µ—â–µ–Ω–∏–µ shard | –ü—Ä–∏–≤—è–∑–∫–∞ shard –∫ NUMA-—É–∑–ª—É (affinity)                                   |
| –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫      | –£—á–∏—Ç—ã–≤–∞–µ—Ç affinity –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –ø–æ—Ç–æ–∫–æ–≤ –∏ shard –¥–ª—è –∑–∞–¥–∞—á–∏                |
| –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞       | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `numa_stats`, `local_alloc_ratio`, `remote_miss_ratio`        |

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏               | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                         | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                               |
| ------------------------- | ------------------------------------------------ | ---------------------------------------- |
| `numa_alloc_onnode()`     | `void *numa_alloc_onnode(size_t size, int node)` | –í—ã–¥–µ–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º NUMA-—É–∑–ª–µ |
| `numa_node_of_ptr()`      | `int numa_node_of_ptr(void *ptr)`                | –ü–æ–ª—É—á–µ–Ω–∏–µ NUMA-—É–∑–ª–∞ –¥–ª—è —É–∫–∞–∑–∞—Ç–µ–ª—è        |
| `numa_bind_thread()`      | `void numa_bind_thread(int cpu, int node)`       | –ü—Ä–∏–≤—è–∑–∫–∞ –ø–æ—Ç–æ–∫–∞ –∫ —è–¥—Ä—É –∏ —É–∑–ª—É            |
| `shard_set_numa_node()`   | `void shard_set_numa_node(shard_t *, int node)`  | –£—Å—Ç–∞–Ω–æ–≤–∫–∞ NUMA-affinity –¥–ª—è shard'–∞      |
| `memory_get_node_usage()` | `numa_stats_t memory_get_node_usage(int node)`   | –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —É–∑–ª—É             |

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞                     | –ò—Å—Ç–æ—á–Ω–∏–∫            | –¶–µ–ª—å               |
| --------------------------- | ------------------- | ------------------ |
| `local_alloc_ratio`         | –ê–ª–ª–æ–∫–∞—Ç–æ—Ä           | > 95%              |
| `remote_page_miss_ratio`    | Hardware counter    | < 5%               |
| `thread_affinity_violation` | Scheduler           | = 0                |
| `numa_node_balance_index`   | Memory load monitor | –º–µ–∂–¥—É —É–∑–ª–∞–º–∏ ‚â§ 20% |
| `shard_cpu_numa_coherence`  | shard planner       | > 90%              |

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

```
src/memory.c
src/allocator_numa.c
src/shard.c
src/numa.c
src/planner.c
include/numa.h
include/allocator.h
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –í—ã–¥–µ–ª–µ–Ω–∏–µ –±–æ–ª—å—à–∏—Ö –±–ª–æ–∫–æ–≤ (arena) –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö NUMA-—É–∑–ª–∞—Ö
* –ü–æ—Ç–æ–∫–∏ WAL, GC –∏ ETL ‚Äî —Å—Ç—Ä–æ–≥–æ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ NUMA node
* Shard —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–∞ NUMA-—É–∑–ª–µ, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –æ–±—ä—ë–º –¥–æ—Å—Ç—É–ø–Ω–æ–π –ø–∞–º—è—Ç–∏
* NUMA-statistics –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ –º–µ—Ç—Ä–∏–∫–∏

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

| –í–∏–¥ —Ç–µ—Å—Ç–∞   | –ú–µ—Ç–æ–¥–∏–∫–∞ / –ø–æ–∫—Ä—ã—Ç–∏–µ                    | –ì–¥–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω               |
| ----------- | -------------------------------------- | ---------------------------- |
| Integration | WAL+shard+GC —Å 4 NUMA-—É–∑–ª–∞–º–∏           | `tests/numa/test_affinity.c` |
| Stress      | –ü–æ—Ç–æ–∫–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ —Å pinning           | `tests/stress/numa_shard.c`  |
| Metrics     | –ü—Ä–æ–≤–µ—Ä–∫–∞ `local_alloc_ratio`           | `bench/numa_stat_bench.c`    |
| Fault-inj   | –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞—Ä—É—à–µ–Ω–∏–µ NUMA-affinity | `fuzz/fuzz_numa_rebind.c`    |

---

## üìê UML ‚Äî NUMA-aware —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤

```plantuml
@startuml
node "NUMA Node 0" {
  [Allocator_0]
  [Shard_0]
  [WAL_Thread_0]
}
node "NUMA Node 1" {
  [Allocator_1]
  [Shard_1]
  [WAL_Thread_1]
}
[Planner] --> [Shard_0]
[Planner] --> [Shard_1]
@enduml
```

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                      | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                     |
| ----------------------------- | ------ | ------------------------------- |
| NUMA-aware –∞–ª–ª–æ–∫–∞—Ü–∏—è          | 100    | –í—ã–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É–∑–ª–∞–º              |
| CPU/thread affinity           | 95     | –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è system calls       |
| –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ NUMA –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏  | 90     | –ï—Å—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ alloc –∏ miss |
| NUMA-aware shard distribution | 90     | –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏    |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
void *mem = numa_alloc_onnode(4096, 1); // –í—ã–¥–µ–ª–∏—Ç—å 4–ö–ë –Ω–∞ NUMA-—É–∑–ª–µ 1
numa_bind_thread(3, 1); // –ó–∞–∫—Ä–µ–ø–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø–æ—Ç–æ–∫ –∑–∞ CPU 3 –∏ NUMA node 1
```

---

## üìå –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –°–Ω–∏–∂–µ–Ω–∏–µ latency –ø—Ä–∏ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–º –¥–æ—Å—Ç—É–ø–µ –∫ shard'–∞–º
* –ü–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ WAL –∏ ingest
* –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –±–æ–ª–µ–µ –ø–ª–æ—Ç–Ω–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Ñ–∏–ª–∏–∞–ª–æ–≤ –ø–æ NUMA-–Ω–∞–≥—Ä—É–∑–∫–µ
