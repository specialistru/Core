# üíæ –ë–ª–æ–∫ 1.4 ‚Äî Tiered Storage (NVMe/SSD)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ó–Ω–∞—á–µ–Ω–∏–µ                        |
| --------- | ------------------------------- |
| üì¶ –ü–∞–∫–µ—Ç  | 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ     |
| üî¢ –ë–ª–æ–∫   | 1.4 ‚Äî Tiered Storage (NVMe/SSD) |

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

Tiered Storage —Ä–µ–∞–ª–∏–∑—É–µ—Ç –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É —Ö—Ä–∞–Ω–µ–Ω–∏—è, –≤ –∫–æ—Ç–æ—Ä–æ–π **–≥–æ—Ä—è—á–∏–µ –¥–∞–Ω–Ω—ã–µ** —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ **RAM (In-Memory)**, –∞ **—Ö–æ–ª–æ–¥–Ω—ã–µ** ‚Äî –≤ **NVMe/SSD**-–¥–∏—Å–∫–∞—Ö.
–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–Ω–æ—Å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞ SSD,
* –ë—ã—Å—Ç—Ä—ã–π –≤–æ–∑–≤—Ä–∞—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –ø–∞–º—è—Ç—å –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ (auto-promote),
* –ü–æ–¥–¥–µ—Ä–∂–∫—É TTL, LRU –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ —Ö—Ä–∞–Ω–µ–Ω–∏—è,
* –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Å–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –¥–∏—Å–∫ (flush/evict),
* –í—Å—Ç—Ä–æ–µ–Ω–Ω—É—é —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é –∏ —Å–∂–∞—Ç–∏–µ.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞        | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                               |
| ----------------- | ------------------------------------------------------ |
| –ò–µ—Ä–∞—Ä—Ö–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏—è | Level-0 (RAM) ‚Üí Level-1 (SSD, mmaped, compressed)      |
| –ü–µ—Ä–µ–Ω–æ—Å –¥–∞–Ω–Ω—ã—Ö    | Background thread —Å eviction policy                    |
| –î–æ—Å—Ç—É–ø            | Transparent access (in-memory ‚Üí SSD) —á–µ—Ä–µ–∑ unified API |
| –°—Ç—Ä–∞—Ç–µ–≥–∏–∏         | FIFO, LRU, TTL-aware eviction, read-promote            |
| –§–æ—Ä–º–∞—Ç            | –ë–∏–Ω–∞—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å compressible pages (gzip, delta)     |

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏           | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                        | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                          |
| --------------------- | ----------------------------------------------- | ----------------------------------- |
| `tier_storage_init()` | `bool tier_storage_init(const char *path)`      | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è NVMe-—É—Ä–æ–≤–Ω—è           |
| `tier_flush_table()`  | `bool tier_flush_table(table_t *)`              | –°–±—Ä–æ—Å —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ SSD                |
| `tier_load_page()`    | `void *tier_load_page(tier_page_id_t)`          | –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –ø–∞–º—è—Ç—å          |
| `tier_promote()`      | `bool tier_promote(const char *table, rowid_t)` | –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –æ–±—Ä–∞—Ç–Ω–æ –≤ –ø–∞–º—è—Ç—å |
| `tier_evict_idle()`   | `size_t tier_evict_idle(uint64_t max_age)`      | –í—ã–≥—Ä—É–∑–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü         |

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞                    | –ò—Å—Ç–æ—á–Ω–∏–∫          | –¶–µ–ª—å       |
| -------------------------- | ----------------- | ---------- |
| `hot_data_residency_ratio` | Memory/SSD –±–∞–ª–∞–Ω—Å | > 95%      |
| `flush_latency_ms`         | –°–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö      | < 20 –º—Å    |
| `eviction_throughput_mb_s` | SSD-–≤—ã–≥—Ä—É–∑–∫–∞      | > 300 –ú–ë/—Å |
| `ssd_page_read_latency_us` | mmap/disk read    | < 150 –º–∫—Å  |
| `tier_write_amplification` | WAL + flush       | < 1.2      |

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

```
src/tiered_storage.c
src/page_cache.c
src/evictor.c
src/ssd_serializer.c
include/tiered_storage.h
include/page_cache.h
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –í—ã–≥—Ä—É–∑–∫–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∫–∞–∫ —Ñ–æ–Ω–æ–≤—ã–π –ø–æ—Ç–æ–∫ (`thrd_t`)
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ mmap-—Ñ–∞–π–ª–æ–≤ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π CRC32
* Unified API: —á—Ç–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å —Ä–∞–±–æ—Ç–∞—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ –¥–ª—è RAM –∏ SSD
* –§–æ—Ä–º–∞—Ç —Å—Ç—Ä–∞–Ω–∏—Ü: `{header, [compressed blocks], footer}`
* –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π eviction-–ª–æ–≥ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ hot/cold-–¥–∞–Ω–Ω—ã–º

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

| –í–∏–¥ —Ç–µ—Å—Ç–∞ | –ú–µ—Ç–æ–¥–∏–∫–∞ / –ø–æ–∫—Ä—ã—Ç–∏–µ                      | –ì–¥–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω             |
| --------- | ---------------------------------------- | -------------------------- |
| Unit      | –°–±—Ä–æ—Å –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã           | `tests/test_tier.c`        |
| Soak      | –ù–∞–≥—Ä—É–∑–∫–∞ 100 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π —Å –∞–≤—Ç–æ-eviction | `tests/soak/tier_stress.c` |
| Crash     | –¢–µ—Å—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Å–±–æ—è           | `tests/crash/tier_crash.c` |
| Perf      | Eviction latency / flush throughput      | `bench/tier_flush_bench.c` |

---

## üìê UML ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ tiered storage

```plantuml
@startuml
database "RAM (Level 0)"
database "NVMe SSD (Level 1)"
component "Evictor"
component "Promoter"

"RAM (Level 0)" --> "Evictor" : age > threshold
"Evictor" --> "NVMe SSD (Level 1)"
"Promoter" --> "RAM (Level 0)" : on access
@enduml
```

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                         | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                   |
| -------------------------------- | ------ | ----------------------------- |
| –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏—è | 100    | RAM + SSD + auto-eviction     |
| –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≤—ã–≥—Ä—É–∑–∫–∞          | 95     | TTL, LRU, flush-on-pressure   |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ mmap –∏ prefetch        | 90     | –ï—Å—Ç—å, –Ω–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å —Å ZNS |
| –°–∂–∞—Ç–∏–µ / —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü    | 90     | gzip + delta compression      |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
tier_storage_init("/data/tier0");
table_t *t = table_create(schema, STORE_ROW);
for (int i = 0; i < 1000000; i++) {
    table_insert(t, generate_row(i));
}
tier_flush_table(t);
```

---

## üìå –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö/–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –¥–æ—Å—Ç—É–ø–∞
* –£–º–µ–Ω—å—à–∞–µ—Ç RAM-–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –Ω–∞ 70‚Äì90% –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ
* –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ "—Ö–æ–ª–æ–¥–Ω—ã—Ö" –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫

