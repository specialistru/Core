–í–æ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ –±–ª–æ–∫—É **1.10 ‚Äî Write-Ahead Logging (WAL)** –∏–∑ –ü–∞–∫–µ—Ç–∞ 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ.

---

# üßæ –ë–ª–æ–∫ 1.10 ‚Äî Write-Ahead Logging (WAL)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ó–Ω–∞—á–µ–Ω–∏–µ                         |
| --------- | -------------------------------- |
| üì¶ –ü–∞–∫–µ—Ç  | 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ      |
| üî¢ –ë–ª–æ–∫   | 1.10 ‚Äî Write-Ahead Logging (WAL) |

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

WAL (–∂—É—Ä–Ω–∞–ª –ø—Ä–µ–¥–∑–∞–ø–∏—Å–∏) –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö, –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—è, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è –Ω–∞ –¥–∏—Å–∫–µ **–¥–æ** –∏—Ö –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤ –ø–∞–º—è—Ç–∏. –û–Ω —è–≤–ª—è–µ—Ç—Å—è –±–∞–∑–∏—Å–æ–º –¥–ª—è:

* –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Å–±–æ–µ–≤ (crash recovery),
* —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ MVCC –∏ snapshot isolation,
* –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –∏ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞        | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                            |
| ----------------- | ------------------------------------------------------------------- |
| WAL Writer        | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å –ª–æ–≥–æ–≤ –≤ –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (log\_buffer ‚Üí WAL file) |
| Log Compaction    | –£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é snapshot                  |
| WAL Segments      | –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–∑ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ (–ø–æ 16‚Äì64 –ú–ë) —Å –∞–≤—Ç–æ-—Ä–æ—Ç–∞—Ü–∏–µ–π                |
| Sync Modes        | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `fsync`, `fdatasync`, `O_DSYNC`, async                    |
| WAL Checkpointing | –ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è snapshot/recovery                          |

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏        | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                          | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                           |
| ------------------ | ------------------------------------------------- | ------------------------------------ |
| `wal_init()`       | `bool wal_init(const char *wal_path)`             | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WAL –∏ –±—É—Ñ–µ—Ä–æ–≤          |
| `wal_append()`     | `bool wal_append(const void *record, size_t len)` | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –ª–æ–≥              |
| `wal_flush()`      | `void wal_flush(bool force_sync)`                 | –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å –±—É—Ñ–µ—Ä–∞ –Ω–∞ –¥–∏—Å–∫ |
| `wal_rotate()`     | `void wal_rotate(void)`                           | –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –Ω–æ–≤—ã–π —Ñ–∞–π–ª —Å–µ–≥–º–µ–Ω—Ç–∞       |
| `wal_checkpoint()` | `void wal_checkpoint(snapshot_t *snap)`           | –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ—á–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è       |
| `wal_shutdown()`   | `void wal_shutdown(void)`                         | –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –±—É—Ñ–µ—Ä–æ–≤      |

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞                     | –ò—Å—Ç–æ—á–Ω–∏–∫     | –¶–µ–ª—å         |
| --------------------------- | ------------ | ------------ |
| `wal_write_latency_us`      | WAL Writer   | < 100 –º–∫—Å    |
| `wal_flush_throughput_mb_s` | I/O Layer    | > 500 –ú–ë/—Å–µ–∫ |
| `wal_buffer_utilization`    | WAL Buffer   | 60‚Äì90%       |
| `wal_segment_count`         | WAL Manager  | ‚â§ 100        |
| `wal_compaction_ratio`      | Checkpointer | > 3.0x       |

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

```
src/wal.c
src/wal_writer.c
src/wal_segment.c
include/wal.h
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö WAL writers —Å lock-free –±—É—Ñ–µ—Ä–æ–º
* Log records —Å–µ—Ä–∏–∞–ª–∏–∑—É—é—Ç—Å—è –≤ –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Å—É–º–º–æ–π (CRC32)
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è mmap + `msync()` –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞ NVMe
* WAL –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–µ–ø–ª–∏—Ü–∏—Ä–æ–≤–∞–Ω –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω—ã–µ —É–∑–ª—ã (–ª–æ–≥–∏—á–µ—Å–∫–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è)
* –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è page-aligned –∑–∞–ø–∏—Å–∏ –∏ zero-copy –±—É—Ñ–µ—Ä—ã

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

| –í–∏–¥ —Ç–µ—Å—Ç–∞ | –ú–µ—Ç–æ–¥–∏–∫–∞ / –ø–æ–∫—Ä—ã—Ç–∏–µ            | –ì–¥–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω                 |
| --------- | ------------------------------ | ------------------------------ |
| Unit      | –¢–µ—Å—Ç—ã –Ω–∞ append, flush, rotate | `tests/wal/test_writer.c`      |
| Stress    | 10 –º–ª–Ω txn/sec WAL-–ø–æ—Ç–æ–∫       | `tests/stress/wal_load.c`      |
| Recovery  | –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ WAL | `tests/recovery/wal_recover.c` |
| Fuzz      | –ü–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–µ WAL-—Å–µ–≥–º–µ–Ω—Ç—ã      | `fuzz/fuzz_wal_read.c`         |

---

## üìê UML ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ WAL

```plantuml
@startuml
class WALBuffer
class WALWriter
class WALSegment
class WALCheckpoint

WALBuffer --> WALWriter
WALWriter --> WALSegment
WALCheckpoint --> WALSegment
@enduml
```

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π          | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                          |
| ----------------- | ------ | ------------------------------------ |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ WAL     | 100    | –ü–æ–ª–Ω—ã–π –¥–≤–æ–∏—á–Ω—ã–π WAL —Å writer threads |
| Log Compaction    | 90     | –£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π        |
| Recovery –∏–∑ WAL   | 95     | –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ snapshot + –ª–æ–≥        |
| –†–æ—Ç–∞—Ü–∏—è —Å–µ–≥–º–µ–Ω—Ç–æ–≤ | 100    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ rollover, metadata         |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
wal_init("/var/db/wal");
wal_append(&logrec, sizeof(logrec));
wal_flush(false);
wal_rotate();
wal_checkpoint(&snap);
```

---

## üìå –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* WAL –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ ACID: `Durability`
* –ö–ª—é—á–µ–≤–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –∏ disaster-recovery
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±—ä–µ–º–∞ –≤ 2+ —Ç—Ä–ª–Ω –∑–∞–ø–∏—Å–µ–π/–≥–æ–¥ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞ –±–µ–∑ WAL

---

–ì–æ—Ç–æ–≤ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –±–ª–æ–∫—É: **1.11 ‚Äî Snapshot –∏ Recovery**? –ù–∞–ø–∏—à–∏ **"–¥–∞"**.

