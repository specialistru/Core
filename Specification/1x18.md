# üß¨ –ë–ª–æ–∫ 1.18 ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞ PAX / Apache Arrow layout

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ó–Ω–∞—á–µ–Ω–∏–µ                                   |
| --------- | ------------------------------------------ |
| üì¶ –ü–∞–∫–µ—Ç  | 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ                |
| üî¢ –ë–ª–æ–∫   | 1.18 ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞ PAX / Apache Arrow layout |

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –≥–∏–±–∫–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –ø–∞–º—è—Ç–∏ –∏ –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ –º–µ–∂–¥—É –ø–æ–¥—Å–∏—Å—Ç–µ–º–∞–º–∏. –û–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:

* **PAX (Partition Attributes Across)** ‚Äî –≥–∏–±—Ä–∏–¥ row-/column-store layout,
* **Apache Arrow** ‚Äî –∫—ç—à-—Ñ—Ä–µ–Ω–¥–ª–∏ columnar layout —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ zero-copy –ø–µ—Ä–µ–¥–∞—á–∏.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞            | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                         |
| --------------------- | ---------------------------------------------------------------- |
| PAX Storage Layout    | –°—Ç—Ä–∞–Ω–∏—Ü–∞ = –±–ª–æ–∫ —Å—Ç—Ä–æ–∫ + —Å—Ç–æ–ª–±—Ü—ã –ø–æ –∞—Ç—Ä–∏–±—É—Ç–∞–º                     |
| Arrow Format          | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ FFI, schema metadata, buffers, validity bitmaps        |
| Vectorized execution  | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–µ–∫—Ç–æ—Ä–Ω—ã—Ö –∞–≥—Ä–µ–≥–∞—Ç–æ–≤, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏, join –ø–æ Arrow batches |
| Zero-copy integration | Arrow-–ø–µ—Ä–µ–¥–∞—á–∞ –º–µ–∂–¥—É –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–º, –∞–≥–≥—Ä–µ–≥–∞—Ç–æ—Ä–æ–º, UDF            |
| Batch Encoding        | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ batch-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫             |

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏                | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                              | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                             |
| -------------------------- | --------------------------------------------------------------------- | -------------------------------------- |
| `pax_page_init()`          | `pax_page_t *pax_page_init(schema_t *, size_t rows_per_page)`         | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è PAX-—Å—Ç—Ä–∞–Ω–∏—Ü—ã             |
| `pax_page_insert()`        | `bool pax_page_insert(pax_page_t *, row_t *)`                         | –í—Å—Ç–∞–≤–∫–∞ —Å—Ç—Ä–æ–∫–∏ –≤ PAX-–±–ª–æ–∫              |
| `arrow_batch_from_table()` | `arrow_batch_t *arrow_batch_from_table(table_t *, size_t batch_size)` | –°–æ–∑–¥–∞–Ω–∏–µ Arrow batch –∏–∑ —Ç–∞–±–ª–∏—Ü—ã        |
| `arrow_batch_iter_next()`  | `bool arrow_batch_iter_next(arrow_batch_iter_t *, rowvec_t *)`        | –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ö–æ–¥ –ø–æ Arrow batch |
| `arrow_export_to_buffer()` | `bool arrow_export_to_buffer(arrow_batch_t *, arrow_buffer_t *)`      | –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è Arrow batch               |

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞                     | –ò—Å—Ç–æ—á–Ω–∏–∫          | –¶–µ–ª—å                           |
| --------------------------- | ----------------- | ------------------------------ |
| `pax_rows_per_page`         | Storage Planner   | ‚â• 512                          |
| `arrow_batch_latency_us`    | Execution Engine  | < 100 –º–∫—Å                      |
| `arrow_zero_copy_transfers` | UDF Subsystem     | ‚â• 99%                          |
| `row_size_variance_ratio`   | Layout Analyzer   | < 1.5                          |
| `vectorized_op_speedup_x`   | Executor Profiler | ‚â• 3x –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å row-by-row |

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

```
src/layout_pax.c
src/layout_arrow.c
src/vector_executor.c
include/layout_pax.h
include/layout_arrow.h
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* PAX layout —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –≤ Page Cache: –∫–∞–∂–¥–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–∞–∑–±–∏–≤–∞–µ—Ç—Å—è –ø–æ –∞—Ç—Ä–∏–±—É—Ç–∞–º
* Arrow layout —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ Arrow IPC + FFI –¥–ª—è C/C++
* –í—ã–¥–µ–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏: aligned + prefetching + cache line tuning
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ validity bitmap (nulls), offset buffer (—Å—Ç—Ä–æ–∫–∏/—Å–ø–∏—Å–∫–∏), type metadata
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å UDF —á–µ—Ä–µ–∑ FFI-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–¥–ª—è WASM, Lua, C)

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

| –í–∏–¥ —Ç–µ—Å—Ç–∞   | –ú–µ—Ç–æ–¥–∏–∫–∞ / –ø–æ–∫—Ä—ã—Ç–∏–µ                                   | –ì–¥–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω                   |
| ----------- | ----------------------------------------------------- | -------------------------------- |
| Unit        | –í—Å—Ç–∞–≤–∫–∞, —á—Ç–µ–Ω–∏–µ, —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è PAX/Arrow               | `tests/layout/test_pax.c`        |
| Arrow       | Arrow reader/writer, null-handling, slicing           | `tests/layout/test_arrow.c`      |
| Vector Exec | –ë–µ–Ω—á–º–∞—Ä–∫–∏ –ø–æ –∞–≥—Ä–µ–≥–∞—Ç–∞–º, join, filter –ø–æ Arrow batches | `bench/vector/bench_vector.c`    |
| Fuzz        | –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ Arrow buffers, –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã–µ —Å—Ö–µ–º—ã        | `fuzz/arrow/fuzz_arrow_buffer.c` |

---

## üìê UML ‚Äî –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Arrow batch

```plantuml
@startuml
class ArrowBatch {
  +schema : ArrowSchema
  +buffers : ArrowBuffer[]
  +validity_bitmap : bitset
}

class ArrowBuffer {
  +data : void *
  +length : size_t
}

ArrowBatch --> ArrowBuffer
@enduml
```

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                          | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                          |
| --------------------------------- | ------ | ---------------------------------------------------- |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ layout (PAX) | 100    | –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω                                 |
| Apache Arrow —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å        | 95     | –ß–∞—Å—Ç–∏—á–Ω–æ: –±–µ–∑ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Dictionary-Encoding –ø–æ–∫–∞     |
| –í–µ–∫—Ç–æ—Ä–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ              | 95     | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö –∞–≥–≥—Ä–µ–≥–∞—Ç–æ–≤, join, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ Arrow |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
pax_page_t *page = pax_page_init(schema, 1024);
pax_page_insert(page, &row);

arrow_batch_t *batch = arrow_batch_from_table(table, 512);
arrow_export_to_buffer(batch, &buf);
```

---

## üìå –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
* –£—Å–∫–æ—Ä–µ–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ BI / ML —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞–º–∏ (Arrow)
* –ü–æ–≤—ã—à–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –∑–∞ —Å—á—ë—Ç –≥–∏–±—Ä–∏–¥–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
