–í–æ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ –±–ª–æ–∫—É **1.11 ‚Äî Snapshot –∏ Recovery** –∏–∑ –ü–∞–∫–µ—Ç–∞ 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ.

---

# üß¨ –ë–ª–æ–∫ 1.11 ‚Äî Snapshot –∏ Recovery

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ó–Ω–∞—á–µ–Ω–∏–µ                    |
| --------- | --------------------------- |
| üì¶ –ü–∞–∫–µ—Ç  | 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ |
| üî¢ –ë–ª–æ–∫   | 1.11 ‚Äî Snapshot –∏ Recovery  |

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º **–±—ã—Å—Ç—Ä–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã (snapshot)** –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (recovery) –≤ —Å–ª—É—á–∞–µ —Å–±–æ—è –∏–ª–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–∞. –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–æ–≤–º–µ—Å—Ç–Ω—É—é —Ä–∞–±–æ—Ç—É —Å WAL, MVCC –∏ buffer pool.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞      | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                |
| --------------- | ----------------------------------------------------------------------- |
| Snapshot Writer | –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Ñ–∏–∫—Å–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö, –∏–Ω–¥–µ–∫—Å–æ–≤      |
| Snapshot Format | –ë–∏–Ω–∞—Ä–Ω—ã–π, —Å–∂–∞—Ç—ã–π, –≤–∫–ª—é—á–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É—é —Å—É–º–º—É                            |
| Snapshot Loader | –ë—ã—Å—Ç—Ä–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–∞–∑—ã –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ snapshot           |
| Log Replay      | –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ snapshot –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è WAL replay –¥–æ –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è |
| Background Task | –°–Ω–∏–º–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ —Ñ–æ–Ω–µ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π                    |

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏              | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                  | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                          |
| ------------------------ | ----------------------------------------- | ----------------------------------- |
| `snapshot_create()`      | `bool snapshot_create(const char *path)`  | –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ snapshot            |
| `snapshot_load()`        | `bool snapshot_load(const char *path)`    | –ó–∞–≥—Ä—É–∑–∫–∞ snapshot –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ       |
| `snapshot_gc_old()`      | `void snapshot_gc_old(size_t keep_count)` | –£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö snapshot-—Ñ–∞–π–ª–æ–≤ |
| `snapshot_flush_async()` | `void snapshot_flush_async(void)`         | –ò–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ–Ω–æ–≤—É—é —Ñ–∏–∫—Å–∞—Ü–∏—é       |

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞                  | –ò—Å—Ç–æ—á–Ω–∏–∫       | –¶–µ–ª—å                  |
| ------------------------ | -------------- | --------------------- |
| `snapshot_time_ms`       | Profiler       | < 500 –º—Å              |
| `recovery_time_ms`       | Startup Logger | < 800 –º—Å              |
| `snapshot_size_mb`       | FS Stats       | < 20% –æ—Ç in-memory    |
| `log_replay_time_ms`     | WAL subsystem  | < 200 –º—Å              |
| `snapshot_frequency_sec` | Configurable   | –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 120 —Å–µ–∫ |

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

```
src/snapshot.c
src/recovery.c
src/snapshot_writer.c
src/snapshot_loader.c
include/snapshot.h
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –§–æ—Ä–º–∞—Ç —Å–Ω–∞–ø—à–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **delta-encoding** –∏ **frame-of-reference** –∫–æ–º–ø—Ä–µ—Å—Å–∏—é
* –ü—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–∏—Å—Ç–µ–º–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–∞–ª–∏–¥–Ω—É—é —Ç–æ—á–∫—É
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è CRC32 / SHA-256 –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≥–æ—Ä—è—á–∏—Ö snapshot –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–∏—Å–∞
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π –º–µ—Ç—Ä–∏–∫, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∞–ª–µ—Ä—Ç–æ–≤

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

| –í–∏–¥ —Ç–µ—Å—Ç–∞ | –ú–µ—Ç–æ–¥–∏–∫–∞ / –ø–æ–∫—Ä—ã—Ç–∏–µ                                | –ì–¥–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω                |
| --------- | -------------------------------------------------- | ----------------------------- |
| Unit      | –°–æ–∑–¥–∞–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞ snapshot, –≤–∞–ª–∏–¥–∞—Ü–∏—è CRC          | `tests/snapshot/test_basic.c` |
| Stress    | 10 –º–ª–Ω —Å—Ç—Ä–æ–∫, –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–∞—è —Ñ–∏–∫—Å–∞—Ü–∏—è/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ | `tests/stress/snap_loop.c`    |
| Recovery  | –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ snapshot + WAL replay     | `tests/recovery/snapshot.c`   |
| Fuzz      | –ü–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã snapshot                        | `fuzz/fuzz_snapshot.c`        |

---

## üìê UML ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Snapshot

```plantuml
@startuml
class SnapshotManager {
  +create()
  +load()
  +gc_old()
}

SnapshotManager --> SnapshotFile
SnapshotManager --> WALReader
SnapshotFile --> TableData
@enduml
```

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                      | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                       |
| ----------------------------- | ------ | --------------------------------- |
| –ì–æ—Ä—è—á–∏–µ snapshot              | 100    | –ë–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏                    |
| Snapshot + WAL recovery       | 100    | –ü–æ–ª–Ω—ã–π state –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º          |
| –°–∂–∞—Ç—ã–π –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç        | 95     | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è FoR –∏ delta encoding |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö snapshot | 90     | Keep count / TTL                  |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
if (!snapshot_load("/var/db/snapshots/last.snap")) {
    log_error("recovery", "–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–Ω–∞–ø—à–æ—Ç–∞");
    exit(1);
}
snapshot_create("/var/db/snapshots/new.snap");
```

---

## üìå –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–∏–∑–Ω–µ—Å-–∫—Ä–∏—Ç–∏—á–Ω—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
* –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å disaster recovery –∏ –æ—Ç–∫–∞—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
* –£—Å–∫–æ—Ä—è–µ—Ç cold start –¥–æ —É—Ä–æ–≤–Ω—è < 1 —Å–µ–∫—É–Ω–¥—ã

---

–ì–æ—Ç–æ–≤ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –±–ª–æ–∫—É: **1.12 ‚Äî –ì–æ—Ä—è—á–∏–µ / —Ö–æ–ª–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**? –ù–∞–ø–∏—à–∏ **"–¥–∞"**.

