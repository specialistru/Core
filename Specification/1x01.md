# üß± –ë–ª–æ–∫ 1.1 ‚Äî In-Memory –¥–≤–∏–∂–æ–∫

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ó–Ω–∞—á–µ–Ω–∏–µ                    |
| --------- | --------------------------- |
| üì¶ –ü–∞–∫–µ—Ç  | 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ |
| üî¢ –ë–ª–æ–∫   | 1.1 ‚Äî In-Memory –¥–≤–∏–∂–æ–∫      |

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ in-memory –¥–≤–∏–∂–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–µ–≥–æ **–Ω—É–ª–µ–≤—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º**, **–≤—ã—Å–æ–∫—É—é –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å**, **–ø–æ–¥–¥–µ—Ä–∂–∫—É MVCC**, –∏ **—Ä–∞–±–æ—Ç—É –±–µ–∑ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –¥–∏—Å–∫—É –Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º –ø—É—Ç–∏**.

–í –æ—Å–Ω–æ–≤–µ –ª–µ–∂–∏—Ç —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–º—É –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—é –¥–∞–Ω–Ω—ã—Ö (—Å—Ç—Ä–æ–∫–æ–≤–æ–µ –∏ –∫–æ–ª–æ–Ω–∫–æ–≤–æ–µ), –±—ã—Å—Ç—Ä–∞—è –∞–ª–ª–æ–∫–∞—Ü–∏—è, –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏ NUMA-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞         | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                   |
| ------------------ | ---------------------------------------------------------- |
| –ê–ª–ª–æ–∫–∞—Ü–∏—è –ø–∞–º—è—Ç–∏   | NUMA-aware, preallocated arenas, lock-free page management |
| Layout             | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ row-store, column-store –∏ hybrid layout          |
| –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å    | Copy-on-write + MVCC chain –≤ in-memory                     |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–∏–ø–æ–≤    | Native: INT, FLOAT, STRING, TIMESTAMP, JSON                |
| –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å      | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ —á–µ—Ä–µ–∑ `type_desc_t`                 |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | Cache alignment, prefetch, SIMD friendly layout            |

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏                 | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                    | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                           |
| --------------------------- | ----------------------------------------------------------- | ------------------------------------ |
| `memory_init()`             | `bool memory_init(memory_config_t *)`                       | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è in-memory –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã   |
| `allocator_alloc()`         | `void *allocator_alloc(allocator_t *, size_t)`              | –í—ã–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã/—è—á–µ–π–∫–∏            |
| `row_store_insert()`        | `bool row_store_insert(row_store_t *, const row_t *)`       | –í—Å—Ç–∞–≤–∫–∞ —Å—Ç—Ä–æ–∫–∏ –≤ —Å—Ç—Ä–æ–∫–æ–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ |
| `column_store_insert()`     | `bool column_store_insert(column_store_t *, const row_t *)` | –í—Å—Ç–∞–≤–∫–∞ –≤ –∫–æ–ª–æ–Ω–∫–æ–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ       |
| `memory_get_available_mb()` | `uint64_t memory_get_available_mb()`                        | –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—ä—ë–º–∞ –¥–æ—Å—Ç—É–ø–Ω–æ–π –ø–∞–º—è—Ç–∏    |

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞                      | –ò—Å—Ç–æ—á–Ω–∏–∫            | –¶–µ–ª—å                    |
| ---------------------------- | ------------------- | ----------------------- |
| `memory_used_mb`             | allocator / metrics | ‚â§ 90% –æ—Ç –æ–±—ä–µ–º–∞         |
| `alloc_latency_ns`           | alocator perf       | < 50 –Ω—Å                 |
| `insert_throughput_rows_sec` | row/column insert   | > 1 –º–ª–Ω —Å—Ç—Ä–æ–∫/—Å–µ–∫       |
| `cache_hit_ratio`            | page/row cache      | > 99%                   |
| `type_support_ratio`         | registry of types   | 100% (–≤—Å–µ –±–∞–∑–æ–≤—ã–µ —Ç–∏–ø—ã) |

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

```
src/memory.c
src/row_store.c
src/column_store.c
src/allocator.c
src/datatype.c
include/memory.h
include/allocator.h
include/datatype.h
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–≥–æ auto-eviction –≤ NVMe-tier –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ –ø–∞–º—è—Ç–∏
* Copy-on-write –¥–ª—è snapshot –∏ read consistency
* Preallocated page pool —Å bitmap-based tracking
* Adaptive row size allocation –ø–æ schema fingerprint
* Minimal false sharing —á–µ—Ä–µ–∑ cache-line separation

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

| –í–∏–¥ —Ç–µ—Å—Ç–∞  | –ú–µ—Ç–æ–¥–∏–∫–∞ / –ø–æ–∫—Ä—ã—Ç–∏–µ                            | –ì–¥–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω             |
| ---------- | ---------------------------------------------- | -------------------------- |
| Unit       | malloc, insert, lookup                         | `tests/test_memory.c`      |
| Stress     | –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ insert/delete/alloc –Ω–∞ 10 –º–ª–Ω —Å—Ç—Ä–æ–∫ | `tests/stress/mem_alloc.c` |
| Fuzz       | –ü–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –º–∞—Å—Å–∏–≤—ã                   | `fuzz/fuzz_allocator.c`    |
| Benchmarks | insert throughput, latency, memory reuse       | `bench/memory_bench.c`     |

---

## üìê UML ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ in-memory —Å–ª–æ—è

```plantuml
@startuml
package "In-Memory Engine" {
  [Memory Manager] --> [Row Store]
  [Memory Manager] --> [Column Store]
  [Row Store] --> [Allocator]
  [Column Store] --> [Allocator]
  [Allocator] --> [Page Pool]
  [Column Store] --> [SIMD Layout]
}
@enduml
```

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                      | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                            |
| ----------------------------- | ------ | -------------------------------------- |
| In-Memory only execution      | 100    | –î–∞–Ω–Ω—ã–µ –Ω–µ —á–∏—Ç–∞—é—Ç—Å—è —Å –¥–∏—Å–∫–∞ –≤ OLTP-–ø—É—Ç–∏ |
| Copy-on-write MVCC            | 95     | –¶–µ–ø–æ—á–∫–∏ –≤ –ø–∞–º—è—Ç–∏ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫        |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ row+column store    | 100    | –ì–∏–±—Ä–∏–¥–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã                      |
| NUMA –∏ prefetch optimizations | 90     | –ù–∞ —É—Ä–æ–≤–Ω–µ –∞–ª–ª–æ–∫–∞—Ç–æ—Ä–∞ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞    |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
allocator_t *arena = allocator_create(ARENA_DEFAULT);
row_store_t *rs = row_store_create(schema, arena);
row_t row = row_init(schema);
row_set(&row, "id", 42);
row_store_insert(rs, &row);
```

---

## üìå –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ü–æ–∑–≤–æ–ª—è–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –º–∏–ª–ª–∏–∞—Ä–¥—ã –∑–∞–ø–∏—Å–µ–π –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏
* –ö–ª—é—á –∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—é <1–º—Å latency –≤ OLTP –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ
* –û—Å–Ω–æ–≤–∞ –≥–∏–±—Ä–∏–¥–Ω–æ–π OLTP/OLAP –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (HTAP)
