# ‚öñÔ∏è –ë–ª–æ–∫ 1.14 ‚Äî –ê–≤—Ç–æ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ó–Ω–∞—á–µ–Ω–∏–µ                                   |
| --------- | ------------------------------------------ |
| üì¶ –ü–∞–∫–µ—Ç  | 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ                |
| üî¢ –ë–ª–æ–∫   | 1.14 ‚Äî –ê–≤—Ç–æ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ |

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–≠—Ç–æ—Ç –±–ª–æ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ **–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏** –∏ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É shard'–∞–º–∏, —É–∑–ª–∞–º–∏ –∏ —É—Ä–æ–≤–Ω—è–º–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è. –û–Ω –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ,
* –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫—É hot-spot'–æ–≤,
* –ü–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ SLA –≤ —É—Å–ª–æ–≤–∏—è—Ö –Ω–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞              | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                 |
| ----------------------- | -------------------------------------------------------- |
| Auto-rebalancer         | –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ shard‚Äô–æ–≤ –∏ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö           |
| Load Tracker            | –û—Ü–µ–Ω–∫–∞ CPU, IOPS, –æ–±—ä—ë–º–∞ in-memory –Ω–∞ shard‚Äô–∞—Ö / –Ω–æ–¥–∞—Ö   |
| Online Migration Engine | –ë–µ–∑–æ—Å—Ç–∞–Ω–æ–≤–æ—á–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É shard‚Äô–∞–º–∏ / –Ω–æ–¥–∞–º–∏ |
| Partition Split / Merge | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ª–µ–Ω–∏—è / —Å–ª–∏—è–Ω–∏—è –ø–∞—Ä—Ç–∏—Ü–∏–π       |
| Coordinated Movement    | –ü–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å —É—á—ë—Ç–æ–º latency, affinity –∏ NUMA      |

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏           | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                           | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                         |
| --------------------- | -------------------------------------------------- | ---------------------------------- |
| `rebalance_init()`    | `void rebalance_init(void)`                        | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã —Ä–µ–±–∞–ª–∞–Ω—Å–∞ |
| `rebalance_tick()`    | `void rebalance_tick(void)`                        | –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏    |
| `migrate_partition()` | `bool migrate_partition(part_t *p, node_id_t dst)` | –û–Ω–ª–∞–π–Ω-–ø–µ—Ä–µ–Ω–æ—Å –ø–∞—Ä—Ç–∏—Ü–∏–∏            |
| `partition_split()`   | `bool partition_split(part_t *p)`                  | –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–Ω–æ–π –ø–∞—Ä—Ç–∏—Ü–∏–∏  |
| `partition_merge()`   | `bool partition_merge(part_t *a, part_t *b)`       | –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ö–æ–ª–æ–¥–Ω—ã—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π      |

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞                  | –ò—Å—Ç–æ—á–Ω–∏–∫         | –¶–µ–ª—å                           |
| ------------------------ | ---------------- | ------------------------------ |
| `rebalanced_partitions`  | Rebalancer       | ‚â• 100/—á–∞—Å –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ |
| `hotspot_skew`           | Load Tracker     | ‚â§ 20% –º–µ–∂–¥—É shard‚Äô–∞–º–∏          |
| `migration_latency_ms`   | Migration Engine | < 50 –º—Å                        |
| `partition_split_events` | Planner          | ‚â• 50/—Å—É—Ç–∫–∏                     |
| `load_variance`          | Load Balancer    | ‚Üí 0 –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —Ä–∞–≤–Ω–æ–≤–µ—Å–∏—è  |

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

```
src/rebalancer.c
src/partition.c
src/load_tracker.c
include/rebalance.h
include/partition.h
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –û—Å–Ω–æ–≤–∞–Ω –Ω–∞ –º–µ—Ö–∞–Ω–∏–∑–º–µ —Ñ–æ–Ω–æ–≤–æ-–ø–ª–∞–Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ (no-stop rebalancing)
* –ú–µ—Ç—Ä–∏–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ `perf`-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ Prometheus
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ø–æ–ª–æ–≥–∏—é NUMA/cluster-aware –¥–ª—è –≤—ã–±–æ—Ä–∞ shard'–æ–≤
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ (2x —Ö—Ä–∞–Ω–µ–Ω–∏–µ)
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å query planner –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ –≤–æ –≤—Ä–µ–º—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

| –í–∏–¥ —Ç–µ—Å—Ç–∞   | –ú–µ—Ç–æ–¥–∏–∫–∞ / –ø–æ–∫—Ä—ã—Ç–∏–µ                          | –ì–¥–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω                   |
| ----------- | -------------------------------------------- | -------------------------------- |
| Unit        | –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ, —Å–ø–ª–∏—Ç, merge –ø–∞—Ä—Ç–∏—Ü–∏–π           | `tests/rebalance/test_core.c`    |
| Stress      | –ú–∞—Å—Å–æ–≤–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ 1M –ø–∞—Ä—Ç–∏—Ü–∏–π             | `tests/stress/migrate.c`         |
| Fuzz        | –°–ª—É—á–∞–π–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –Ω–∞–≥—Ä—É–∑–∫–∏ + —á–∞—Å—Ç–∏—á–Ω—ã–π —Å–±–æ–π | `fuzz/fuzz_rebalance.c`          |
| Integration | –°–∫–≤–æ–∑–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ OLTP / OLAP –Ω–∞–≥—Ä—É–∑–∫–∏  | `tests/integration/shard_flow.c` |

---

## üìê UML ‚Äî –ê–≤—Ç–æ-—Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –∏ –º–∏–≥—Ä–∞—Ü–∏—è

```plantuml
@startuml
class Partition {
  +id
  +load
}

class Node {
  +shards
  +metrics
}

class Rebalancer {
  +tick()
  +migrate()
  +split()
  +merge()
}

Partition --> Node
Rebalancer --> Partition
Rebalancer --> Node
@enduml
```

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                    | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                   |
| --------------------------- | ------ | ----------------------------- |
| Auto-rebalance –ø–æ –Ω–∞–≥—Ä—É–∑–∫–µ  | 100    | –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏ –º–∏–≥—Ä–∞—Ü–∏—è |
| –û–Ω–ª–∞–π–Ω –º–∏–≥—Ä–∞—Ü–∏—è –±–µ–∑ –ø—Ä–æ—Å—Ç–æ—è | 95     | –ë–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ—Ç–æ–∫–∞          |
| Partition split/merge       | 90     | –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è    |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
rebalance_tick(); // –∞–Ω–∞–ª–∏–∑ –Ω–∞–≥—Ä—É–∑–∫–∏
if (partition_needs_split(part)) {
    partition_split(part);
}
migrate_partition(part, get_least_loaded_node());
```

---

## üìå –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
* –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç SLA –≤ —É—Å–ª–æ–≤–∏—è—Ö –Ω–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏
* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—é –ø—Ä–∏ –≤—Å–ø–ª–µ—Å–∫–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏–ª–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏

