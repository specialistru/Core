# üß± –ë–ª–æ–∫ 9.1 ‚Äî –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ (UDF / UDAF)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 9 ‚Äî –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å
* **–ë–ª–æ–∫:** 9.1 ‚Äî –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ (UDF / UDAF)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π (UDF ‚Äî User-Defined Functions –∏ UDAF ‚Äî User-Defined Aggregates) –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å —è–¥—Ä–∞ –°–£–ë–î –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –ø–æ–¥ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –¥–æ–º–µ–Ω—ã (ERP, BI, ML, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤) –∏ —Å–æ–∑–¥–∞–Ω–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –≤ —Å—Ç–∏–ª–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                               |
| ------------------------- | ------------------------------------------------------ |
| –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è UDF           | –ß–µ—Ä–µ–∑ SQL: `CREATE FUNCTION` –∏–ª–∏ API                   |
| –Ø–∑—ã–∫–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏          | C/C++, Lua, JS, WebAssembly (WASM), Python             |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ     | Sandbox, timeouts, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –ø–∞–º—è—Ç—å –∏ CPU         |
| –ê–≥—Ä–µ–≥–∞—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (UDAF) | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏, merge, —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è |
| –†–∞—Å—à–∏—Ä–µ–Ω–∏—è —á–µ—Ä–µ–∑ –º–æ–¥—É–ª–∏   | Dlopen / LoadLibrary, –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞            |
| –ò–Ω—Ç—Ä–æ—Å–ø–µ–∫—Ü–∏—è –∏ –¥–µ–±–∞–≥      | `SHOW FUNCTIONS`, –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∫–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è              |
| –í–µ—Ä—Å–∏–∏ —Ñ—É–Ω–∫—Ü–∏–π            | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π –∏ rollback           |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

–§—É–Ω–∫—Ü–∏–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö –∫–∞—Ç–∞–ª–æ–≥–∞ (`system.udf_functions`, `system.udaf_functions`) —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–æ–ª—è–º–∏:

```c
typedef struct {
    char name[64];
    char language[16];
    char source_code[2048];
    bool is_aggregate;
    uint64_t version;
    bool is_sandboxed;
} udf_entry_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
package "9. –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å" {
  [9.1 –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏] --> [3.1 SQL –Ø–¥—Ä–æ –∏ –ü–∞—Ä—Å–µ—Ä]
  [9.1 –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏] --> [3.2 SQL-–æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä]
  [9.1 –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏] --> [4.5 –í–Ω–µ—à–Ω–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∏ Webhooks]
  [9.1 –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏] --> [9.3 Sandbox API]
}
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –Ω–∞ C/C++ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –∫–∞–∫ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∏–ª–∏ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é.
* UDF –≤ Lua –∏ JS –∏—Å–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä—ã —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º —Å—ç–Ω–¥–±–æ–∫—Å–æ–º.
* WASM-–º–æ–¥—É–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏ –∏–∑–æ–ª–∏—Ä—É–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é wasm runtime (–Ω–∞–ø—Ä–∏–º–µ—Ä, Wasmtime –∏–ª–∏ WAMR).
* –ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–µ—Å—É—Ä—Å–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –≤—Ä–µ–º—è, –ø–∞–º—è—Ç—å –∏ –∏–∑–æ–ª—è—Ü–∏—é —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–µ namespace.

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/udf/udf.c`
* `src/udf/udf_lua.c`
* `src/udf/udf_wasm.c`
* `include/udf.h`
* `include/catalog/udf_catalog.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏         | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                 | –û–ø–∏—Å–∞–Ω–∏–µ                                       |
| ------------------- | ------------------------------------------------------------------------ | ---------------------------------------------- |
| `udf_register`      | `bool udf_register(udf_entry_t *entry);`                                 | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏                      |
| `udf_execute`       | `bool udf_execute(const char *name, db_value_t *args, db_value_t *ret);` | –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ –∏–º–µ–Ω–∏                    |
| `udaf_merge`        | `bool udaf_merge(void *state, db_value_t *value);`                       | –°–ª–∏—è–Ω–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –∞–≥—Ä–µ–≥–∞—Ç–æ–≤                |
| `udf_load_dynamic`  | `bool udf_load_dynamic(const char *path);`                               | –ó–∞–≥—Ä—É–∑–∫–∞ –≤–Ω–µ—à–Ω–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏                    |
| `udf_sandbox_check` | `bool udf_sandbox_check(const udf_entry_t *entry);`                      | –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–ª–∏—Ç–∏–∫–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit-—Ç–µ—Å—Ç—ã: `tests/udf/test_udf.c`
* Fuzzing –¥–ª—è Lua/JS –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä–æ–≤
* Stress-—Ç–µ—Å—Ç—ã –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ UDF
* Coverage-–∞–Ω–∞–ª–∏–∑: `make coverage-udf`

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* –ó–∞–¥–µ—Ä–∂–∫–∞ –≤—ã–∑–æ–≤–∞ UDF (C): \~70‚Äì150 –Ω—Å
* –ó–∞–¥–µ—Ä–∂–∫–∞ –≤—ã–∑–æ–≤–∞ UDF (Lua): \~500‚Äì1200 –Ω—Å
* WASM cold start: \~2‚Äì3 –º—Å, –≥–æ—Ä—è—á–µ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ \~500‚Äì700 –Ω—Å
* –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ UDF –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ –¥–æ 2 MB –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                          | –í—ã–ø–æ–ª–Ω–µ–Ω–æ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                      |
| --------------------------------- | --------- | ------------------------------------------------ |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ UDF/UDAF                | ‚úÖ         | –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —è–∑—ã–∫–∏, –≤–∫–ª—é—á–∞—è WASM                |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ             | ‚úÖ         | Sandbox + –∫–æ–Ω—Ç—Ä–æ–ª—å —Ä–µ—Å—É—Ä—Å–æ–≤                      |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π | ‚úÖ         | Dlopen / LoadLibrary + runtime –∑–∞–≥—Ä—É–∑–∫–∞          |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SQL                  | ‚úÖ         | –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ CREATE FUNCTION / DROP FUNCTION |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
udf_entry_t entry = {
  .name = "add_one",
  .language = "C",
  .source_code = "int add_one(int x) { return x + 1; }",
  .is_aggregate = false,
  .version = 1,
  .is_sandboxed = true
};
udf_register(&entry);
```

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏
* –ó–∞–ø—Ä–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤, –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ç–∏, —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ
* –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è, –ª–∏–º–∏—Ç–æ–≤ –∏ –≤–µ—Ä—Å–∏–π

## üîÑ UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
class udf_entry_t {
  +char name[64]
  +char language[16]
  +char source_code[2048]
  +bool is_aggregate
  +uint64_t version
  +bool is_sandboxed
}
```

## üíº –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã –¥–ª—è ERP/BI —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤, –≤–∫–ª—é—á–∞—è —Ä–∞—Å—á—ë—Ç—ã, –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å, –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∞–≥—Ä–µ–≥–∞—Ç—ã, –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É.

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Å–µ–º–∞–Ω—Ç–∏–∫–∞ –≤–µ—Ä—Å–∏–π UDF
* –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∞ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é
* –ê—É–¥–∏—Ç –≤—Å–µ—Ö CREATE / ALTER / DROP FUNCTION

## üì¢ –û—à–∏–±–∫–∏ –∏ —Å–æ–æ–±—â–µ–Ω–∏—è

* `ERR_UDF_NOT_FOUND` ‚Äî –ø–æ–ø—ã—Ç–∫–∞ –≤—ã–∑–æ–≤–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏
* `ERR_UDF_SECURITY` ‚Äî –Ω–∞—Ä—É—à–µ–Ω–∏–µ sandbox-–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
* `ERR_UDF_COMPILE` ‚Äî –æ—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –≤–Ω–µ—à–Ω–µ–π —Ñ—É–Ω–∫—Ü–∏–∏
* `WARN_UDF_DEPRECATED` ‚Äî –≤—ã–∑–æ–≤ —É—Å—Ç–∞—Ä–µ–≤—à–µ–π –≤–µ—Ä—Å–∏–∏ —Ñ—É–Ω–∫—Ü–∏–∏

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Python —á–µ—Ä–µ–∑ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä —Å sandbox
* –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –∫–æ–º–ø–∏–ª—è—Ü–∏—è UDF –≤ LLVM
* –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ UDF
