# 6.10 ‚Äî –ñ—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∞—É–¥–∏—Ç DML/DDL-–æ–ø–µ—Ä–∞—Ü–∏–π (Immutable Chain Logging)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 6 ‚Äî –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
**–ë–ª–æ–∫ 6.10 ‚Äî –ñ—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∞—É–¥–∏—Ç DML/DDL-–æ–ø–µ—Ä–∞—Ü–∏–π (Immutable Chain Logging)**

---

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –±–ª–æ–∫ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (DML) –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ë–î (DDL) –≤ –Ω–µ–∏–∑–º–µ–Ω—è–µ–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ. –ñ—É—Ä–Ω–∞–ª —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Ü–µ–ø–æ—á–∫—É –∑–∞–ø–∏—Å–µ–π —Å —Ö–µ—à-—Å–≤—è–∑—è–º–∏ (Immutable Chain), –ø–æ–∑–≤–æ–ª—è—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å, –Ω–µ–∏–∑–º–µ–Ω–Ω–æ—Å—Ç—å –∏ –¥–æ–∫–∞–∑—É–µ–º–æ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è —Ü–µ–ª–µ–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è (compliance), –æ—Ç–ª–∞–¥–∫–∏ –∏ —Ä–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞          | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                      |
| ------------------- | ------------------------------------------------------------- |
| –ê—É–¥–∏—Ç DML           | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ INSERT/UPDATE/DELETE —Å –¥–µ—Ç–∞–ª—è–º–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π         |
| –ê—É–¥–∏—Ç DDL           | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ CREATE/ALTER/DROP/GRANT –∏ –ø—Ä–æ—á–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π         |
| Immutable Chain     | –ö–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å –≤–∫–ª—é—á–∞–µ—Ç —Ö–µ—à –ø—Ä–µ–¥—ã–¥—É—â–µ–π (hash chaining)         |
| –ü–æ–¥–ø–∏—Å–∏ –∏ —Ö–µ—à–∏      | SHA-256 –ø–æ–¥–ø–∏—Å–∏ —Å–æ–±—ã—Ç–∏–π, —Ü–∏—Ñ—Ä–æ–≤–∞—è –Ω–µ–ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤–æ—Å—Ç—å          |
| –ó–∞—â–∏—Ç–∞ –æ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π | –õ–æ–≥ —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (append-only), –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct audit_log_entry_t {
  uint64_t entry_id;
  timestamp_t ts;
  char user[64];
  char operation[16]; // DML / DDL
  char object_name[64];
  char change_sql[512];
  uint8_t prev_hash[32];
  uint8_t curr_hash[32];
} audit_log_entry_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
DMLExecutor --> AuditLogger
DDLSchemaManager --> AuditLogger
AuditLogger --> HashEngine
AuditLogger --> StorageAppender
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –¶–µ–ø–æ—á–∫–∞ –∑–∞–ø–∏—Å–µ–π (hash chaining) —Å SHA-256
* –•–µ—à–∏ –∑–∞–ø–∏—Å–µ–π –∑–∞–≤–∏—Å—è—Ç –æ—Ç –≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏ ‚Äî tamper-proof
* –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ (thread-safe) –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π
* –ò–º–º—É—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∏–≥–∞–µ—Ç—Å—è –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ–º —Ñ—É–Ω–∫—Ü–∏–π update/delete

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/security/audit_logger.c`
* `src/sql/dml_executor.c`
* `src/sql/ddl_manager.c`
* `include/security/audit_log_entry.h`
* `src/crypto/sha256.c`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –ò–º—è                      | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                 | –û–ø–∏—Å–∞–Ω–∏–µ                                             |
| ------------------------ | ------------------------------------------------------------------------ | ---------------------------------------------------- |
| `audit_log_write`        | `int audit_log_write(db_session_t *s, const char *sql, const char *obj)` | –î–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –≤ –∞—É–¥–∏—Ç-–∂—É—Ä–Ω–∞–ª                      |
| `audit_log_init`         | `void audit_log_init(void)`                                              | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ö–µ—à-—Ü–µ–ø–æ—á–∫–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ö–µ—à–∞ |
| `audit_log_verify_chain` | `bool audit_log_verify_chain(void)`                                      | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ —Ü–µ–ø–æ—á–∫–∏ –ø–æ —Ö–µ—à–∞–º                |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/security/test_audit_logger.c`
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ DML/DDL –¥–æ–ª–∂–Ω—ã –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å—Å—è
* Fuzz: SQL –≤—Ö–æ–¥—ã –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∏ –ø–æ–ª–Ω–æ—Ç—É –ª–æ–≥–æ–≤
* –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–ø–æ—á–∫–∏ –∏–∑ –∂—É—Ä–Ω–∞–ª–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ö–µ—à–µ–π

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è                | –ú–µ—Ç—Ä–∏–∫–∞                |
| ----------------------- | ---------------------- |
| –í—Å—Ç–∞–≤–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –∂—É—Ä–Ω–∞–ª | \~1.5‚Äì2.0 –º–∫—Å          |
| –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏      | \~320‚Äì420 –Ω—Å           |
| –ü–æ–ª–Ω–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è      | < 45 –º—Å / 100K –∑–∞–ø–∏—Å–µ–π |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                             | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                   |
| ------------------------------------ | ------ | --------------------------------------------- |
| –ê—É–¥–∏—Ç –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π                  | 100    | DML –∏ DDL –ø–æ–ª–Ω–æ—Ü–Ω–æ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è                 |
| –ü–æ–¥–ø–∏—Å–∏ –∏ —Ö–µ—à–∏                       | 100    | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ SHA-256                 |
| –¶–µ–ø–æ—á–∫–∞ –Ω–µ–∏–∑–º–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π           | 100    | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ö–µ—à-—Ü–µ–ø–æ—á–∫–∞                    |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å—Ç–∞–ª—å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é | 100    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ RBAC/ABAC –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
audit_log_write(session, "INSERT INTO clients ...", "clients");
```

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏—è SELECT (optionally, –¥–ª—è compliance)
* –≠–∫—Å–ø–æ—Ä—Ç –ª–æ–≥–æ–≤ –≤ SIEM-—Å–∏—Å—Ç–µ–º—ã
* –í—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ —Ü–∏—Ñ—Ä–æ–≤—ã—Ö –ø–æ–¥–ø–∏—Å–µ–π

---

## üìä UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity "DMLExecutor" as DML
entity "DDLSchemaManager" as DDL
entity "AuditLogger" as AUDIT
entity "HashEngine" as HASH
entity "StorageAppender" as STORE

DML --> AUDIT
DDL --> AUDIT
AUDIT --> HASH
AUDIT --> STORE
@enduml
```

---

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö
* –î–æ–∫–∞–∑—É–µ–º–æ—Å—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ø–æ–¥–º–µ–Ω—ã –∑–∞–ø–∏—Å–µ–π (non-repudiation)
* –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º PCI DSS, GDPR, ISO 27001

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* Immutable chain ‚Äî –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏
* –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —Ä–æ–ª–∏ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
* –ó–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –∏–ª–∏ –∑–∞–º–µ–Ω—ã –∂—É—Ä–Ω–∞–ª–∞

---

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –í–µ—Ä—Å–∏—è | –ò–∑–º–µ–Ω–µ–Ω–∏–µ                                    |
| ------ | -------------------------------------------- |
| v1.0   | –ë–∞–∑–æ–≤—ã–π –∞—É–¥–∏—Ç DML/DDL                        |
| v1.1   | –•–µ—à-—Ü–µ–ø–æ—á–∫–∞ –Ω–∞ SHA-256                       |
| v1.2   | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ —Ü–µ–ø–æ—á–∫–∏                 |
| v1.3   | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–µ—Ö–∞–Ω–∏–∑–º–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞ (RBAC/ABAC) |

---

## üõë –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

| –ö–æ–¥             | –£—Å–ª–æ–≤–∏–µ                      | –û–ø–∏—Å–∞–Ω–∏–µ                               |
| --------------- | ---------------------------- | -------------------------------------- |
| `E_AUDIT_FAIL`  | –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø–∏—Å–∞—Ç—å –≤ –∂—É—Ä–Ω–∞–ª | –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏           |
| `W_CHAIN_BREAK` | –ù–∞—Ä—É—à–µ–Ω–∏–µ —Ü–µ–ø–æ—á–∫–∏ —Ö–µ—à–µ–π      | –í–æ–∑–º–æ–∂–Ω–∞ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –∏–ª–∏ —Å–±–æ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è |
