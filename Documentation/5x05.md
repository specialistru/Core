# 5.5 ‚Äî BI-—Ñ—É–Ω–∫—Ü–∏–∏ –∏ –∞–≥—Ä–µ–≥–∞—Ç—ã (rank, percentiles, clustering)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 5 ‚Äî BI, ML –∏ OLAP**
**–ë–ª–æ–∫ 5.5 ‚Äî BI-—Ñ—É–Ω–∫—Ü–∏–∏ –∏ –∞–≥—Ä–µ–≥–∞—Ç—ã (rank, percentiles, clustering)**

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ BI-—É—Ä–æ–≤–Ω—è, –≤–∫–ª—é—á–∞—è —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤, –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª–µ–π, –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —ç–ª–µ–º–µ–Ω—Ç HTAP –∏ real-time BI-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞           | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                 |
| -------------------- | ---------------------------------------- |
| RANK/–†ERCENTILE      | SQL-—Ñ—É–Ω–∫—Ü–∏–∏ —Å –æ–∫–æ–Ω–Ω—ã–º–∏ –∞–≥—Ä–µ–≥–∞—Ç–∞–º–∏        |
| KMeans/–∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è | SQL-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è, UDF/—Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–ø—É—Å–∫–∏      |
| WINDOW/Aggregate API | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ANSI SQL:2011+ –∏ –ø—Ä–æ—Ä–µ–∑–∫–∞ –æ–∫–æ–Ω |

## üìÄ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è

```c
typedef struct bi_agg_state_t {
  uint64_t count;
  double sum;
  double min;
  double max;
  double *buckets; // –¥–ª—è percentiles
} bi_agg_state_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```plantuml
SQLPlanner --> BIWindowProcessor
SQLPlanner --> BIClusterEngine
BIWindowProcessor --> WindowExec
BIClusterEngine --> KMeansRuntime
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

* –í–µ–∫—Ç–æ—Ä–Ω–æ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –æ–∫–æ–Ω
* NUMA-aware –∞–≥—Ä–µ–≥–∞—Ç—ã
* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–∫–Ω–∞

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

* `src/sql/bi_window.c`
* `src/sql/bi_cluster.c`
* `include/sql/bi_agg.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –ò–º—è               | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                         | –û–ø–∏—Å–∞–Ω–∏–µ                       |
| ----------------- | ---------------------------------------------------------------- | ------------------------------ |
| `rank_eval`       | `int rank_eval(bi_agg_state_t *st, row_t *in)`                   | –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–æ–≤–æ–≥–æ —Å—á–µ—Ç–∞  |
| `percentile_calc` | `double percentile_calc(bi_agg_state_t *st, double p)`           | –†–∞—Å—á–µ—Ç —Ä–∞–∑–±–∏–≤–∫–∏ –ø–æ percentiles |
| `kmeans_cluster`  | `int kmeans_cluster(result_iter_t *rows, int k, cluster_t *out)` | –§–æ–Ω–æ–≤–∞—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è k-means  |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* `tests/sql/test_bi_agg.c`
* `tests/sql/test_cluster_kmeans.c`
* `coverage/bi_agg.cover`

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è                 | –ó–∞–¥–µ—Ä–∂–∫–∞ |
| ------------------------ | -------- |
| Rank over 10M rows       | ‚àº3.1 –º—Å  |
| Percentile –ø–æ 1M –∑–∞–ø–∏—Å–µ–π | ‚àº1.2 –º—Å  |
| KMeans (k=8, 100K)       | ‚àº5.7 –º—Å  |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π             | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                    |
| -------------------- | ------ | ------------------------------ |
| Rank/Percentile/–æ–∫–Ω–∞ | 100    | –°–æ–≤—Ä–µ—Ç—Å—Ç–≤–∏–µ ANSI SQL:2011+     |
| Clustering/KMeans    | 95     | –ï—Å—Ç—å —Ñ–æ–Ω–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏ UDF |

## üìå –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```sql
SELECT customer_id,
       RANK() OVER (PARTITION BY region ORDER BY total_spend DESC) AS rnk
FROM customers;
```

## üß∞ –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –î–æ–±–∞–≤–∏—Ç—å DBSCAN –¥–ª—è –ø–ª–æ—Ç–Ω–æ—Å—Ç–Ω–æ–π –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏
* –ò–Ω–¥–µ–∫—Å—ã –ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∞–º
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ approximate median

## üìä UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity "SQLPlanner" as SQL
entity "BIWindowProcessor" as WIN
entity "BIClusterEngine" as CLU
entity "KMeansRuntime" as KM
entity "WindowExec" as WINX

SQL --> WIN
SQL --> CLU
WIN --> WINX
CLU --> KM
@enduml
```

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥–∞–∂ –ø–æ —Å–µ–≥–º–µ–Ω—Ç–∞–º
* –†–µ–π—Ç–∏–Ω–≥–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –¥–∏–ª–µ—Ä–æ–≤
* –û—Ü–µ–Ω–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫ –≤ real-time

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –û—Ç–¥–µ–ª—å–Ω—ã–µ RBAC-–ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–∑–æ–≤ –∞–≥—Ä–µ–≥–∞—Ç–æ–≤
* –ê—É–¥–∏—Ç —Å–∏—Å—Ç–µ–º–Ω—ã—Ö BI-–∑–∞–ø—Ä–æ—Å–æ–≤
* –õ–∏–º–∏—Ç –Ω–∞ –æ–±—ä–µ–º –∏ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ CPU

## üîÑ –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

* v1.0 ‚Äî rank/percentile –∏ –æ–∫–Ω–∞
* v1.1 ‚Äî KMeans –Ω–∞ —Ñ–æ–Ω–æ–≤—ã—Ö worker-–∞—Ö
* v1.2 ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è BI-–∞–≥—Ä–µ–≥–∞—Ç–æ—Ä–æ–≤ –≤ planner

## ‚õîÔ∏è –°–æ–æ–±

