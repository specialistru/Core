# üì¶ –ü–∞–∫–µ—Ç 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ

| ‚Ññ –±–ª–æ–∫–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞                                                                           |
| ------- | ---------------------------------------------------------------------------------------- |
| 1.1     | In-Memory –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ                                                                     |
| 1.2     | Tiered Storage (NVMe/SSD fallback)                                                       |
| 1.3     | Row-store                                                                                |
| 1.4     | Column-store                                                                             |
| 1.5     | JSON-store                                                                               |
| 1.6     | NUMA-aware –ø–∞–º—è—Ç—å                                                                        |
| 1.7     | CPU-affinity, prefetch, cache coloring                                                   |
| 1.8     | –®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ                                                                             |
| 1.9     | –ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ                                                                        |
| 1.10    | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞                                                            |
| 1.11    | –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫                                                               |
| 1.12    | –°–∂–∞—Ç–∏–µ –∏ –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è                                                                    |
| 1.13    | –ò–Ω–¥–µ–∫—Å—ã –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è                                                          |
| 1.14    | –ë—É—Ñ–µ—Ä–Ω–∞—è –∑–æ–Ω–∞ (Page Cache / Buffer Pool)                                                 |
| 1.15    | Auto-tiering, TTL, Eviction                                                              |
| 1.16    | Write-Ahead Logging (WAL)                                                                |
| 1.17    | –°–Ω–∞–ø—à–æ—Ç—ã –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ                                                                |
| 1.18    | –ì–æ—Ä—è—á–∏–µ/—Ö–æ–ª–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ                                                                  |
| 1.19    | –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Å—Ç—Ä–∞–Ω–∏—Ü –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–π (Page Lifecycle, Dirty Bits, LRU/ARC)  |

* üìê UML-–¥–∏–∞–≥—Ä–∞–º–º—É
* üßæ –ë–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏–∏
* üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
* üìù –†–µ–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
* üîß –†–µ–∞–ª—å–Ω—ã–µ C-—Ñ—É–Ω–∫—Ü–∏–∏ –∏ –ø—Ä–æ—Ç–æ—Ç–∏–ø—ã
* üß™ –ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏

# üß± –ë–ª–æ–∫ 1.1 ‚Äî –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (config\_init)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.1 ‚Äî –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (config\_init)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–≠—Ç–æ—Ç –±–ª–æ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –Ω–∞—á–∞–ª—å–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É –∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (—Ñ–∞–π–ª–∞, –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è, –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏) –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ–¥—Å–∏—Å—Ç–µ–º. –û–Ω –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–∏—Å—Ç–µ–º—ã, –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è (—Ä–µ–∂–∏–º WAL, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø—É—Ç–∏ –∏ —Ä–µ—Å—É—Ä—Å—ã) –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≥–∏–±–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ –∏–ª–∏ standalone.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞             | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                          |
| ---------------------- | ------------------------------------------------- |
| –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏  | –ü–∞—Ä—Å–∏–Ω–≥ ini/yaml/cli –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö                   |
| –ü—É—Ç–∏ (–∫–∞—Ç–∞–ª–æ–≥–∏, —Ñ–∞–π–ª—ã) | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è, —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ |
| –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è  | log\_path, log\_level                             |
| –ü–∞—Ä–∞–º–µ—Ç—Ä—ã WAL          | wal\_enabled, wal\_path, wal\_max\_size           |
| –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–∞–º—è—Ç–∏       | buffer\_pool\_size, max\_memory\_mb               |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å           | –ü—É—Ç—å –¥–æ –∫–ª—é—á–µ–π, –∞–∫—Ç–∏–≤–∞—Ü–∏—è TDE                     |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
// –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
typedef struct config_t {
    char log_path[PATH_MAX];
    int  log_level;
    char wal_path[PATH_MAX];
    bool wal_enabled;
    size_t buffer_pool_size;
    size_t max_memory_mb;
    bool tde_enabled;
    // ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
} config_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏ (PlantUML)

```plantuml
[1.1 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏] --> [0.1 –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (main)]
[1.1 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏] --> [1.2 –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è]
[1.1 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏] --> [1.3 –°–∏—Å—Ç–µ–º–∞ WAL]
[1.1 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏] --> [2.1 –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø–∞–º—è—Ç–∏ –∏ NUMA]
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –ù–∞–ø–∏—Å–∞–Ω–æ –Ω–∞ **C23**
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è POSIX API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—É—Ç—è–º–∏, env
* –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è —Å fallback –Ω–∞ —Ñ–∞–π–ª
* –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–¥ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π startup latency
* –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –ø—Ä–∏—á–∏–Ω—ã

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/config.c`
* `include/config.h`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è                             | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                    | –û–ø–∏—Å–∞–Ω–∏–µ                             |
| ------------------------------- | ------------------------------------------- | ------------------------------------ |
| config\_init                    | `bool config_init(const char *path);`       | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ —Ñ–∞–π–ª–∞ |
| config\_get\_log\_path          | `const char *config_get_log_path(void);`    | –ü–æ–ª—É—á–∞–µ—Ç –ø—É—Ç—å –¥–æ –ª–æ–≥–æ–≤               |
| config\_get\_log\_level         | `int config_get_log_level(void);`           | –ü–æ–ª—É—á–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è         |
| config\_get\_buffer\_pool\_size | `size_t config_get_buffer_pool_size(void);` | –†–∞–∑–º–µ—Ä –ø—É–ª–∞ —Å—Ç—Ä–∞–Ω–∏—Ü                  |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit-—Ç–µ—Å—Ç—ã: `tests/test_config.c`
* Fuzz: –≤–≤–æ–¥ –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
* Coverage > 92%

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                     | –ó–Ω–∞—á–µ–Ω–∏–µ      |
| --------------------------- | ------------- |
| Startup time (–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è) | < 5 –º—Å        |
| –ö–æ–ª-–≤–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤           | > 40          |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π      | ini, env, cli |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                     | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π               |
| ---------------------------- | ------ | ------------------------- |
| –ú—É–ª—å—Ç–∏-–∏—Å—Ç–æ—á–Ω–∏–∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ | 100    | cli/env/ini               |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫             | 100    | —Ç–æ—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è          |
| –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤  | 100    | –ø–æ–¥–¥–µ—Ä–∂–∫–∞ > 40 –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
if (!config_init("/etc/inmemdb/config.ini")) {
    log_error("config", "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏");
    return 1;
}
```

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ JSON –∏ TOML —Ñ–æ—Ä–º–∞—Ç–æ–≤
* –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
* Live reload –±–µ–∑ —Ä–µ—Å—Ç–∞—Ä—Ç–∞

---

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞ (.puml)

```plantuml
package "1.1 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏" {
  [config_init()] --> [config_get_*()]
  [config_init()] --> [log_init()]
  [config_init()] --> [wal_init()]
}
```

---

## üßæ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ü–æ–∑–≤–æ–ª—è–µ—Ç –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ë–î –ø–æ–¥ –Ω—É–∂–¥—ã –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π –Ω–∞ —É—Ä–æ–≤–Ω–µ –∑–∞–ø—É—Å–∫–∞
* –î–∞—ë—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å

---

## üìú –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –í–µ—Ä—Å–∏—è | –ò–∑–º–µ–Ω–µ–Ω–∏–µ                        | –î–∞—Ç–∞       |
| ------ | -------------------------------- | ---------- |
| 1.0    | –ù–∞—á–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è             | 2025-07-20 |
| 1.1    | –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ | 2025-07-22 |
| 1.2    | –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —á—Ç–µ–Ω–∏—è –∏–∑ –æ–∫—Ä—É–∂–µ–Ω–∏—è  | 2025-07-25 |

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –≤ –±–ª–æ–∫–µ

* –ó–∞—â–∏—Ç–∞ –ø—É—Ç–µ–π —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –ø—Ä–∞–≤–∞–º–∏ 0600
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è TDE (transparent data encryption)
* –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, WAL path)

---

## üìù –°–æ–æ–±—â–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞ (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)

| –£—Ä–æ–≤–µ–Ω—å | –§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è                          | –£—Å–ª–æ–≤–∏–µ –ø–æ—è–≤–ª–µ–Ω–∏—è                       |
| ------- | ----------------------------------------- | --------------------------------------- |
| INFO    | `[config] –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ —Ñ–∞–π–ª–∞: %s`          | –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ config\_init                 |
| DEBUG   | `[config] –ó–Ω–∞—á–µ–Ω–∏–µ %s = %s`               | –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª—é—á–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏          |
| ERROR   | `[config] –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: %s` | –§–∞–π–ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ |


# üß± –ë–ª–æ–∫ 1.2 ‚Äî –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (log\_init)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.2 ‚Äî –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (log\_init)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–≠—Ç–æ—Ç –±–ª–æ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ In-Memory –°–£–ë–î. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π, –æ—à–∏–±–æ–∫, –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –∞–≤–∞—Ä–∏–π–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ä–∞–∑–Ω—ã–µ —Ä–µ–∂–∏–º—ã: `stderr`, `syslog`, –±–∏–Ω–∞—Ä–Ω—ã–π –∂—É—Ä–Ω–∞–ª.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞               | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                             |
| ------------------------ | -------------------------------------------------------------------- |
| –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–æ–≤      | –û—Ç–∫—Ä—ã—Ç–∏–µ —Ñ–∞–π–ª–æ–≤, —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Ä–æ–≤–Ω—è, –≤—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ (stderr/syslog/bin)  |
| –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ printf-—Ñ–æ—Ä–º–∞—Ç–∞, –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–∏, –º–æ–¥—É–ª—è, —É—Ä–æ–≤–Ω—è        |
| –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è       | `DEBUG`, `INFO`, `WARN`, `ERROR`, `FATAL`                            |
| –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å       | –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º—å—é—Ç–µ–∫—Å –∏–ª–∏ –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏                            |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ syslog         | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º syslog —á–µ—Ä–µ–∑ `syslog.h` –∏–ª–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–æ–∫–µ—Ç |
| –ë–∏–Ω–∞—Ä–Ω—ã–π –ª–æ–≥             | –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã log\_event\_t –≤ –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç               |
| –ì–∏–±–∫–æ—Å—Ç—å                 | –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞ –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã                      |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
/// –û–ø–∏—Å–∞–Ω–∏–µ –ª–æ–≥-—Å–æ–±—ã—Ç–∏—è –¥–ª—è –±–∏–Ω–∞—Ä–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
typedef struct {
    uint64_t timestamp_ns;
    log_level_t level;
    char module[32];
    char message[256];
} log_event_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
package 1 "–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è" {
  [1.1 –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è] --> [1.2 –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ]
  [1.2 –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ] --> [7.1 –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞]
  [1.2 –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ] --> [10.1 –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ]
}
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: **C17/C23**, –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–≥–æ–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ—Å—Ç–∏ (Windows / Linux)
* –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –≤—ã–∑–æ–≤–æ–≤ `fprintf` / `write`
* –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏ (timestamp, PID, thread)
* –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø–æ—Ç–æ–∫–∞—Ö (thread-safe)

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

| –¢–∏–ø    | –ü—É—Ç—å                             |
| ------ | -------------------------------- |
| Header | `include/log.h`                  |
| Source | `src/log.c`                      |
| –í—ã–∑–æ–≤  | `main.c`, `config.c`, `server.c` |

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏ | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                               | –û–ø–∏—Å–∞–Ω–∏–µ                           |
| ----------- | ---------------------------------------------------------------------- | ---------------------------------- |
| `log_init`  | `void log_init(const char *path, log_level_t level, log_mode_t mode);` | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è          |
| `log_info`  | `void log_info(const char *mod, const char *fmt, ...);`                | –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ           |
| `log_debug` | `void log_debug(const char *mod, const char *fmt, ...);`               | –û—Ç–ª–∞–¥–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ               |
| `log_error` | `void log_error(const char *mod, const char *fmt, ...);`               | –û—à–∏–±–∫–∏ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏              |
| `log_event` | `void log_event(const log_event_t *e);`                                | –ë–∏–Ω–∞—Ä–Ω–∞—è –∑–∞–ø–∏—Å—å —Å–æ–±—ã—Ç–∏—è –≤ –ª–æ–≥-—Ñ–∞–π–ª |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

| –¢–∏–ø —Ç–µ—Å—Ç–∞ | –ü—É—Ç—å                        |
| --------- | --------------------------- |
| Unit      | `tests/test_log.c`          |
| Fuzz      | `fuzz/log_format_fuzzer.c`  |
| Coverage  | `tools/coverage_report.log` |

–ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ñ–æ—Ä–º–∞—Ç–∞, –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å, –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤.

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                        | –ó–Ω–∞—á–µ–Ω–∏–µ                 |
| ------------------------------ | ------------------------ |
| –°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞ –∑–∞–ø–∏—Å–∏        | `< 25 –º–∫—Å` –¥–ª—è stderr    |
| –°–∫–æ—Ä–æ—Å—Ç—å –±–∏–Ω–∞—Ä–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è | `> 1 –º–ª–Ω —Å–æ–±—ã—Ç–∏–π/—Å–µ–∫`    |
| –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏           | `< 1 –ú–ë` –ø—Ä–∏ ring buffer |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                    | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                              |
| --------------------------- | ------ | ---------------------------------------- |
| Structured logging          | 100    | stderr, syslog, binary —Ñ–æ—Ä–º–∞—Ç            |
| Observability —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å | 100    | –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ OpenTelemetry —á–µ—Ä–µ–∑ bridge |
| –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤ –ª–æ–≥–æ–≤  | 100    | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ                              |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
log_init("/var/log/db.log", LOG_LEVEL_INFO, LOG_MODE_SYSLOG);
log_info("init", "–°–∏—Å—Ç–µ–º–∞ –∑–∞–ø—É—â–µ–Ω–∞ PID=%lu", getpid());
```

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ —Ä–∞–∑–º–µ—Ä—É
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ structured JSON logging
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å journald –∏ cloud-collector

---

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
class log_event_t {
  uint64_t timestamp_ns
  log_level_t level
  char module[32]
  char message[256]
}

interface LogInterface {
  +log_init()
  +log_info()
  +log_debug()
  +log_error()
  +log_event()
}

LogInterface <|.. log_event_t
@enduml
```

---

## üßæ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ê—É–¥–∏—Ç —Å–æ–±—ã—Ç–∏–π: –∫—Ç–æ, –∫–æ–≥–¥–∞, —á—Ç–æ —Å–¥–µ–ª–∞–ª (DML/DDL/–û—à–∏–±–∫–∞)
* SLA: –∞–Ω–∞–ª–∏–∑ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞, –æ—à–∏–±–æ–∫, –∞–Ω–æ–º–∞–ª–∏–π
* –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ—Å–∞–Ω–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞

---

## üìú –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –í–µ—Ä—Å–∏—è | –ò–∑–º–µ–Ω–µ–Ω–∏–µ                              | –î–∞—Ç–∞       |
| ------ | -------------------------------------- | ---------- |
| 1.0    | –ë–∞–∑–æ–≤–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–æ–≤            | 2024-06-20 |
| 1.1    | –î–æ–±–∞–≤–ª–µ–Ω –±–∏–Ω–∞—Ä–Ω—ã–π —Ä–µ–∂–∏–º                | 2024-07-02 |
| 1.2    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ syslog / stderr –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è | 2024-07-12 |

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–æ–∫ —á–µ—Ä–µ–∑ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π `vsnprintf`
* –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –±—É—Ñ–µ—Ä–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è
* –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ –∑–∞—â–∏—â—ë–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ

---

## üìù –°–æ–æ–±—â–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞ (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)

| –£—Ä–æ–≤–µ–Ω—å | –§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è                               | –£—Å–ª–æ–≤–∏–µ –ø–æ—è–≤–ª–µ–Ω–∏—è                |
| ------- | ---------------------------------------------- | -------------------------------- |
| INFO    | `[LOG] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–æ–≤: —Ä–µ–∂–∏–º=%s`          | –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ log\_init             |
| DEBUG   | `[LOG] –ü–æ—Ç–æ–∫ %lu –ø–∏—à–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ: %s`          | –ü—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ –≤ debug-—Ä–µ–∂–∏–º–µ   |
| ERROR   | `[LOG] –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ —Ñ–∞–π–ª: %s`               | –ü—Ä–∏ —Å–±–æ–µ `fwrite()` –∏–ª–∏ `open()` |
| WARN    | `[LOG] –ë—É—Ñ–µ—Ä –ª–æ–≥–æ–≤ –∑–∞–ø–æ–ª–Ω–µ–Ω, –∑–∞–ø–∏—Å—å –ø—Ä–æ–ø—É—â–µ–Ω–∞` | –ü—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ –±—É—Ñ–µ—Ä–∞          |

---

# üß± –ë–ª–æ–∫ 1.3 ‚Äî –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–∏ (network\_init)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.3 ‚Äî –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–∏ (network\_init)–µ

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –Ω–∞—á–∞–ª—å–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Å–µ—Ç–µ–≤–æ–≥–æ —Å—Ç–µ–∫–∞ –°–£–ë–î, –≤–∫–ª—é—á–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —Å–æ–∫–µ—Ç–æ–≤, –ø—Ä–∏–≤—è–∑–∫—É –∫ IP-–∞–¥—Ä–µ—Å–∞–º –∏ –ø–æ—Ä—Ç–∞–º, —É—Å—Ç–∞–Ω–æ–≤–∫—É —Ç–∞–π–º–∞—É—Ç–æ–≤ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É –∫ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π. –Ø–≤–ª—è–µ—Ç—Å—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ gRPC/WebSocket/REST-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤, —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –∏ –∫–ª–∞—Å—Ç–µ—Ä–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞        | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                         |
| ----------------- | ---------------------------------------------------------------- |
| TCP/UDP-—Å–µ—Ä–≤–µ—Ä    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ IPv4/IPv6, –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ `thrd_create`         |
| –ü–æ—Ä—Ç—ã             | –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–∑ config: API, replication, metrics                   |
| –°–æ–∫–µ—Ç—ã            | `socket_create()`, `socket_bind()`, `socket_listen()`            |
| CLI/REST/gRPC     | –û–±—â–∞—è –ø—Ä–æ—Å–ª–æ–π–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–∫–µ—Ç–æ–≤                                |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ SSL/TLS | –ß–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–ª–æ–π (–≤ –±—É–¥—É—â–µ–º, —á–µ—Ä–µ–∑ OpenSSL –∏–ª–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É) |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

–•—Ä–∞–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

```c
typedef struct {
    char bind_ip[64];
    uint16_t api_port;
    uint16_t repl_port;
    uint16_t metrics_port;
    bool reuse_addr;
    bool tcp_nodelay;
} net_config_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[1.1 –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è] --> [1.3 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–∏]
[1.3 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–∏] --> [3.1 REST API]
[1.3 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–∏] --> [3.2 gRPC –°–µ—Ä–≤–µ—Ä]
[1.3 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–∏] --> [3.3 –í–µ–±-—Å–æ–∫–µ—Ç—ã]
[1.3 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–∏] --> [4.1 –ö–ª–∞—Å—Ç–µ—Ä–Ω–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è]
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è POSIX-—Å–æ–∫–µ—Ç—ã (Linux) –∏ Windows API —á–µ—Ä–µ–∑ –æ–±—ë—Ä—Ç–∫–∏
* –£—Å—Ç–∞–Ω–æ–≤–∫–∞ `SO_REUSEADDR`, `TCP_NODELAY` –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
* –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –Ω–∞ –≤—Å–µ—Ö —ç—Ç–∞–ø–∞—Ö: `bind`, `listen`, `accept`
* –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–æ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
* –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ thread affinity –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/network.c`
* `include/network.h`
* `src/socket.c`
* `include/socket.h`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏    | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                     | –û–ø–∏—Å–∞–Ω–∏–µ                             |
| -------------- | ------------------------------------------------------------ | ------------------------------------ |
| network\_init  | `bool network_init(const net_config_t *cfg);`                | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö —Å–ª—É—à–∞—é—â–∏—Ö —Å–æ–∫–µ—Ç–æ–≤ |
| socket\_create | `int socket_create();`                                       | –°–æ–∑–¥–∞–Ω–∏–µ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∞ —Å–æ–∫–µ—Ç–∞          |
| socket\_bind   | `bool socket_bind(int sock, const char *ip, uint16_t port);` | –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–∫–µ—Ç–∞ –∫ IP/–ø–æ—Ä—Ç—É           |
| socket\_listen | `bool socket_listen(int sock);`                              | –ü–µ—Ä–µ–≤–æ–¥ —Å–æ–∫–µ—Ç–∞ –≤ —Ä–µ–∂–∏–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* `tests/test_network.c`: Unit + Integration
* –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –º–æ–∫–∏ —Å–æ–∫–µ—Ç–æ–≤
* –ü–æ–∫—Ä—ã—Ç–∏–µ: —Å–æ–∑–¥–∞–Ω–∏–µ, bind, listen, –æ—à–∏–±–∫–∏ –ø–æ—Ä—Ç–æ–≤

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* –í—Ä–µ–º—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ < 2 –º—Å
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ > 20K –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (epoll/kqueue)
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ thread pinning –∏ NUMA-aware —Å–æ–∫–µ—Ç–æ–≤ –≤ –±—É–¥—É—â–µ–º

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                     | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                 |
| ---------------------------- | ------ | --------------------------- |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤         | 100    | TCP, WebSocket, REST, gRPC  |
| –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è | 100    | epoll, thread pool          |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å                 | 80     | –í –ø–ª–∞–Ω–∞—Ö TLS/mTLS           |
| –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å              | 100    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ C23 `thrd_create` |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
if (!network_init(&global_config.net)) {
    log_error("network", "–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Ç–∏");
    return false;
}
```

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* TLS/mTLS —á–µ—Ä–µ–∑ OpenSSL –∏–ª–∏ wolfSSL
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ QUIC/HTTP3
* NUMA-aware —Å–æ–∫–µ—Ç—ã –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞
* Adaptive backlog + SO\_PRIORITY

---

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞ (.puml)

```plantuml
package "1.3 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–∏" {
  [socket_create()] --> [socket_bind()]
  [socket_bind()] --> [socket_listen()]
  [socket_listen()] --> [network_init()]
}
```

---

## üßæ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è API-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ (–≤–Ω–µ—à–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—ã)
* –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É —Ñ–∏–ª–∏–∞–ª–∞–º–∏
* –°—Ç—Ä–∏–º–∏–Ω–≥ –∏ CDC –Ω–∞—Ä—É–∂—É

---

## üìú –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* `v0.9`: –ø–µ—Ä–≤–∏—á–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è `network_init`
* `v1.1`: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ IPv6, –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø–æ—Ä—Ç—ã –¥–ª—è –º–µ—Ç—Ä–∏–∫
* `v1.2`: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ reusable address + thread-pinning roadmap

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ IP-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –Ω–∞ —É—Ä–æ–≤–Ω–µ config
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ—Ä—Ç–æ–≤/ACL
* –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –≤–Ω–µ—à–Ω–∏—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

---

## üìù –°–æ–æ–±—â–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞ (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)

| –£—Ä–æ–≤–µ–Ω—å | –°–æ–æ–±—â–µ–Ω–∏–µ                           | –£—Å–ª–æ–≤–∏–µ                                |
| ------- | ----------------------------------- | -------------------------------------- |
| INFO    | `[NET] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–∏ –Ω–∞ %s:%d` | –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º bind                      |
| ERROR   | `[NET] –û—à–∏–±–∫–∞ —Å–æ–∫–µ—Ç–∞: %s`           | –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö socket\_create/bind/listen |
| DEBUG   | `[NET] –°–æ–∫–µ—Ç %d —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç %d`    | –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–µ                 |

# üß± –ë–ª–æ–∫ 1.4 ‚Äî –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WAL (–∂—É—Ä–Ω–∞–ª –ø—Ä–µ–¥–∑–∞–ø–∏—Å–∏)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.4 ‚Äî –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WAL (–∂—É—Ä–Ω–∞–ª –ø—Ä–µ–¥–∑–∞–ø–∏—Å–∏)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

WAL (Write-Ahead Logging) –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥—ë–∂–Ω—É—é –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—É—é –∑–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ —Ñ–∏–∫—Å–∞—Ü–∏–µ–π –≤ –ø–∞–º—è—Ç–∏ –∏–ª–∏ NVMe. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WAL –Ω–∞ —Å—Ç–∞—Ä—Ç–µ –°–£–ë–î –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç:

* –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º–∞ –∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ —Å—Ç–∞—Ä—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π,
* –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∞–≤–∞—Ä–∏–π–Ω–æ–º—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é –∏ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏,
* —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —Å MVCC –∏ snapshot-–º–µ–Ω–µ–¥–∂–µ—Ä–æ–º.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞          | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                  |
| ------------------- | --------------------------------------------------------- |
| –ë—É—Ñ–µ—Ä WAL           | Ring-buffer –Ω–∞ –ø–∞–º—è—Ç—å —Å mmap –∏–ª–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç—å—é      |
| –ú–µ—Ö–∞–Ω–∏–∑–º –ø—Ä–µ–¥–∑–∞–ø–∏—Å–∏ | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ –≤–Ω–µ—Å–µ–Ω–∏—è –≤ in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ             |
| WAL writer          | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π, —Å–∂–∞—Ç–∏–µ –ª–æ–≥–æ–≤, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è                  |
| Snapshot –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ snapshot recovery              |
| WAL —Ñ–æ—Ä–º–∞—Ç          | –ë–∏–Ω–∞—Ä–Ω—ã–π, –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ        |
| –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞         | –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ wal\_path, –¥–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
// WAL header + –∑–∞–ø–∏—Å—å –∏–∑–º–µ–Ω–µ–Ω–∏–π
typedef struct wal_entry_t {
    uint64_t tx_id;
    uint64_t timestamp;
    wal_op_type_t op_type;
    uint32_t data_len;
    uint8_t  data[]; // –°–∂–∞—Ç–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
} wal_entry_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[1.2 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è] --> [1.4 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WAL]
[1.4 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WAL] --> [2.4 MVCC-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ]
[1.4 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WAL] --> [2.6 –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ Snapshot]
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: **C23**
* –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ mmap –±—É—Ñ–µ—Ä—ã
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö WAL writer‚Äô–æ–≤
* –°–µ–≥–º–µ–Ω—Ç–∏—Ä—É–µ–º–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∫–æ–º–ø–∞–∫—Ü–∏—è WAL
* NUMA-aware –±—É—Ñ–µ—Ä—ã WAL –≤ –±—É–¥—É—â–µ–º —Ä–µ–ª–∏–∑–µ

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

| –ü—É—Ç—å             | –û–ø–∏—Å–∞–Ω–∏–µ              |
| ---------------- | --------------------- |
| `src/wal.c`      | –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ WAL   |
| `include/wal.h`  | –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã |
| `src/snapshot.c` | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å recovery |

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏    | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                     | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                             |
| -------------- | -------------------------------------------- | -------------------------------------- |
| `wal_init`     | `bool wal_init(const char *path);`           | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è WAL |
| `wal_append`   | `bool wal_append(const wal_entry_t *entry);` | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –∂—É—Ä–Ω–∞–ª             |
| `wal_flush`    | `void wal_flush(void);`                      | –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–∞ –¥–∏—Å–∫   |
| `wal_rotate`   | `void wal_rotate(void);`                     | –°–º–µ–Ω–∞ WAL-—Å–µ–≥–º–µ–Ω—Ç–∞                     |
| `wal_shutdown` | `void wal_shutdown(void);`                   | –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ WAL –∏ –æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤      |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* `tests/unit/test_wal.c` ‚Äî —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –æ–ø–µ—Ä–∞—Ü–∏–π
* `tests/integration/test_tx_crash.c` ‚Äî –ø–∞–¥–µ–Ω–∏–µ + recovery
* `tests/fuzz/fuzz_wal_parser.c` ‚Äî —Ñ—É–∑–∑–∏–Ω–≥ WAL-–∑–∞–ø–∏—Å–µ–π
* –ü–æ–∫—Ä—ã—Ç–∏–µ: > 93% –ø–æ —Å—Ç—Ä–æ–∫–∞–º, mutation safe

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                    | –ó–Ω–∞—á–µ–Ω–∏–µ                        |
| -------------------------- | ------------------------------- |
| –°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞ append    | 210‚Äì330 –Ω—Å                      |
| –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å WAL | –¥–æ 1.5 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π/—Å–µ–∫ –ø—Ä–∏ SSD  |
| –°–∂–∞—Ç–∏–µ –ª–æ–≥–æ–≤               | \~2.7√ó (custom delta+RLE codec) |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                         | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                        |
| -------------------------------- | ------ | ---------------------------------- |
| Write-Ahead Logging              | 100    | –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è           |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å recovery / snapshot | 100    | –î–∞, —á–µ—Ä–µ–∑ snapshot.c –∏ checkpoint  |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –∏ —Å–∂–∞—Ç–∏—è     | 100    | –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –∫–æ–º–ø–∞–∫—Ü–∏—è –∏ —Ä–æ—Ç–∞—Ü–∏—è WAL |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
if (!wal_init(config_get_wal_path())) {
    log_error("WAL", "–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ WAL");
    exit(EXIT_FAILURE);
}
```

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* NUMA-aware WAL writer (—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å–æ–∫–µ—Ç–∞–º CPU)
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ WAL –≤ in-memory –±–µ–∑ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã (RAM-disk fallback)
* WAL streaming –¥–ª—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ (Raft + Changefeed)

---

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞ (.puml)

```plantuml
@startuml
package "1.4 WAL (–∂—É—Ä–Ω–∞–ª –ø—Ä–µ–¥–∑–∞–ø–∏—Å–∏)" {
  class wal_entry_t {
    +uint64_t tx_id
    +uint64_t timestamp
    +wal_op_type_t op_type
    +uint32_t data_len
    +uint8_t data[]
  }

  class wal.c
  class wal.h
  class snapshot.c
  wal.c --> wal_entry_t
  snapshot.c --> wal_entry_t
}
@enduml
```

---

## üßæ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ì–∞—Ä–∞–Ω—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–∏ —Å–±–æ—è—Ö
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –≤ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ
* –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É snapshot

---

## üìú –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –í–µ—Ä—Å–∏—è | –î–∞—Ç–∞       | –ê–≤—Ç–æ—Ä      | –ò–∑–º–µ–Ω–µ–Ω–∏—è                          |
| ------ | ---------- | ---------- | ---------------------------------- |
| 1.0    | 2025-07-26 | –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä | –ù–∞—á–∞–ª—å–Ω—ã–π —Ä–µ–ª–∏–∑ WAL-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã |

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥ WAL
* WAL-—Ñ–∞–π–ª—ã –º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã (–±—É–¥—É—â–∏–π —Ä–µ–ª–∏–∑)
* –ò–º–º—É—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–µ–π –ø–æ—Å–ª–µ commit

---

## üìù –°–æ–æ–±—â–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞ (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)

| –£—Ä–æ–≤–µ–Ω—å | –°–æ–æ–±—â–µ–Ω–∏–µ                                     | –£—Å–ª–æ–≤–∏–µ                           |
| ------- | --------------------------------------------- | --------------------------------- |
| INFO    | `[WAL] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞`                 | –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –∑–∞–ø—É—Å–∫–µ wal\_init    |
| ERROR   | `[WAL] –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ %s`         | –ï—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ WAL –∫–∞—Ç–∞–ª–æ–≥—É   |
| DEBUG   | `[WAL] –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å tx=%lu len=%u`        | –ü—Ä–∏ –∫–∞–∂–¥–æ–º wal\_append            |
| WARN    | `[WAL] –ü—Ä–æ–ø—É—â–µ–Ω–∞ –∑–∞–ø–∏—Å—å: –æ—á–µ—Ä–µ–¥—å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞` | –ü—Ä–∏ —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ–º –ø–æ—Ç–æ–∫–µ append |

–û–Ω –≤–∫–ª—é—á–∞–µ—Ç:

* —Å–≤—è–∑–∏ —Å `MVCC`, `snapshot recovery`, `log_init`;
* —Ä–µ–∞–ª—å–Ω—ã–µ C-—Ñ—É–Ω–∫—Ü–∏–∏ –∏ `wal_entry_t`;
* —Å–æ–æ–±—â–µ–Ω–∏—è –ª–æ–≥–æ–≤, PlantUML –∏ –º–µ—Ç—Ä–∏–∫–∏.

# üß± –ë–ª–æ–∫ 1.5 ‚Äî –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–Ω–∏–º–∫–∞ (Snapshot Recovery)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.5 ‚Äî –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–Ω–∏–º–∫–∞ (Snapshot Recovery)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–Ω–∏–º–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–∏—Å—Ç–µ–º—ã –∏–ª–∏ –ø–æ—Å–ª–µ —Å–±–æ—è. –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö, –º–∏–Ω–∏–º–∏–∑–∏—Ä—É—è –ø–æ—Ç–µ—Ä–∏ —Å —É—á—ë—Ç–æ–º WAL –∏ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö snapshot-—Ñ–∞–π–ª–æ–≤.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞         | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è/–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                           |
| ------------------ | ---------------------------------------------------------------- |
| –°–Ω–∏–º–∫–∏             | –•—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ SSD –≤ —Ñ–æ—Ä–º–∞—Ç–µ page-diff –∏–ª–∏ full-page                |
| –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ     | –ß—Ç–µ–Ω–∏–µ snapshot, –∑–∞—Ç–µ–º –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ WAL –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ checkpoint |
| –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MVCC | –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö txid –∏ snapshot\_id                         |
| –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å    | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö —Å—É–º–º, –≤–µ—Ä—Å–∏–π –∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∑–∞–ø–∏—Å–µ–π          |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
// snapshot.h
typedef struct snapshot_header_t {
    uint64_t snapshot_id;
    uint64_t last_wal_lsn;
    uint64_t timestamp;
    uint32_t crc32;
} snapshot_header_t;

typedef struct snapshot_record_t {
    uint64_t page_id;
    uint16_t length;
    uint8_t  data[MAX_PAGE_SIZE];
} snapshot_record_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
package "1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã" {
  [1.4 WAL Init] --> [1.5 Snapshot Recovery]
  [1.5 Snapshot Recovery] --> [2.1 MVCC Engine]
  [1.5 Snapshot Recovery] --> [2.2 –¢–∞–±–ª–∏—Ü—ã / –¥–∞–Ω–Ω—ã–µ]
}
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: C23
* –•—Ä–∞–Ω–µ–Ω–∏–µ snapshot –Ω–∞ NVMe/SSD (–≤–Ω–µ in-memory –ø—É—Ç–∏)
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ frame-of-reference –ø—Ä–∏ —Å–∂–∞—Ç–∏–∏ snapshot
* –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö —Å—É–º–º, fail-fast recovery
* Prefetch —Å—Ç—Ä–∞–Ω–∏—Ü –≤ –ø–∞–º—è—Ç—å –Ω–∞ —Å—Ç–∞—Ä—Ç–µ

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

| –§–∞–π–ª                 | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                  |
| -------------------- | --------------------------- |
| `src/snapshot.c`     | –ó–∞–≥—Ä—É–∑–∫–∞, –ø—Ä–æ–≤–µ—Ä–∫–∞ snapshot |
| `src/wal.c`          | WAL replay                  |
| `include/snapshot.h` | –§–æ—Ä–º–∞—Ç snapshot-—Ñ–∞–π–ª–∞       |

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –§—É–Ω–∫—Ü–∏—è                   | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                               | –û–ø–∏—Å–∞–Ω–∏–µ                              |
| ------------------------- | ---------------------------------------------------------------------- | ------------------------------------- |
| `snapshot_load`           | `bool snapshot_load(db_t *db, const char *path)`                       | –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç snapshot + WAL  |
| `snapshot_verify_crc`     | `bool snapshot_verify_crc(const void *data, size_t len, uint32_t crc)` | –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É—é —Å—É–º–º—É           |
| `snapshot_prefetch_pages` | `void snapshot_prefetch_pages(const snapshot_record_t *records)`       | –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤ –ø–∞–º—è—Ç—å —É–∫–∞–∑–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã: `tests/test_snapshot.c`
* Fuzz: Fuzzing –ø–æ –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–º snapshot-—Ñ–∞–π–ª–∞–º
* Soak test: –¥–æ–ª–≥–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ + —Å–±–æ–∏ –ø–∏—Ç–∞–Ω–∏—è (crash recovery)
* Coverage > 92%

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                   | –ó–Ω–∞—á–µ–Ω–∏–µ                                 |
| ------------------------- | ---------------------------------------- |
| –í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è      | < 150 –º—Å –ø—Ä–∏ snapshot+WAL < 500 –ú–ë       |
| –°–∫–æ—Ä–æ—Å—Ç—å prefetch         | 2.1 GB/s (NVMe read throughput)          |
| –ö–æ–ª-–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü –≤ snapshot | 80k - 500k —Å—Ç—Ä–∞–Ω–∏—Ü (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ë–î) |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π          | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                         |
| ----------------- | ------ | --------------------------------------------------- |
| Snapshot Recovery | 100    | –ï—Å—Ç—å –ø–æ–ª–Ω–∞—è –ø–æ–¥–≥—Ä—É–∑–∫–∞, prefetch, crash-consistency  |
| WAL replay        | 100    | Replay –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ LSN                            |
| –°–∂–∞—Ç–∏–µ            | 90     | –ü–æ–∫–∞ –Ω–µ –≤—Å–µ page-type –∏—Å–ø–æ–ª—å–∑—É—é—Ç frame-of-reference |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
if (!snapshot_load(db, config_get_snapshot_path())) {
    log_error("snapshot", "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–µ—Ä–≤–∞–Ω–∞");
    exit(EXIT_FAILURE);
}
```

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ snapshot'—ã
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ multithreaded replay WAL
* –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π snapshot scheduler

---

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞ (.puml)

```plantuml
@startuml
entity "snapshot_header_t" {
  +uint64_t snapshot_id
  +uint64_t last_wal_lsn
  +uint64_t timestamp
  +uint32_t crc32
}

entity "snapshot_record_t" {
  +uint64_t page_id
  +uint16_t length
  +uint8_t data[MAX_PAGE_SIZE]
}

snapshot_header_t --> snapshot_record_t : —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–ø–∏—Å–∏
@enduml
```

---

## üßæ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ì–∞—Ä–∞–Ω—Ç–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –∞–≤–∞—Ä–∏–π
* –°–Ω–∏–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—Å—Ç–æ—è (RTO)
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ SLA –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

---

## üìú –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –í–µ—Ä—Å–∏—è | –ê–≤—Ç–æ—Ä  | –ò–∑–º–µ–Ω–µ–Ω–∏–µ                                |
| ------ | ------ | ---------------------------------------- |
| 1.0    | system | –ü–µ—Ä–≤–∏—á–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è snapshot + recovery |
| 1.1    | tofa   | –î–æ–±–∞–≤–ª–µ–Ω prefetch –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ CRC         |

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* CRC32 –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥–æ–≥–æ snapshot-—Ñ–∞–π–ª–∞
* –í–∞–ª–∏–¥–∞—Ü–∏—è offset/—Ä–∞–∑–º–µ—Ä–∞ –∑–∞–ø–∏—Å–µ–π –ø–µ—Ä–µ–¥ —á—Ç–µ–Ω–∏–µ–º
* –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –±—É—Ñ–µ—Ä–∞ (bounds check)

---

## üìù –°–æ–æ–±—â–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞ (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)

| –£—Ä–æ–≤–µ–Ω—å | –°–æ–æ–±—â–µ–Ω–∏–µ                                        | –£—Å–ª–æ–≤–∏–µ                                          |
| ------- | ------------------------------------------------ | ------------------------------------------------ |
| INFO    | \[Snapshot] –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ snapshot\_id=%lu   | –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è                        |
| DEBUG   | \[Snapshot] –ü—Ä–µ—Ñ–µ—Ç—á —Å—Ç—Ä–∞–Ω–∏—Ü—ã %lu                 | –ü—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–∑ snapshot                  |
| WARN    | \[Snapshot] CRC –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, snapshot –ø–æ–≤—Ä–µ–∂–¥—ë–Ω | –ü—Ä–∏ –Ω–µ—É–¥–∞—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Å—É–º–º—ã         |
| ERROR   | \[Snapshot] –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å: %s        | –ü—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–µ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ |

# üß± –ë–ª–æ–∫ 1.6 ‚Äî –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ —Ç–∞–±–ª–∏—Ü (catalog\_init)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.6 ‚Äî –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ —Ç–∞–±–ª–∏—Ü (catalog\_init)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ö–∞—Ç–∞–ª–æ–≥ —Ç–∞–±–ª–∏—Ü –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö: —Å—Ö–µ–º—ã, —Ç–∏–ø—ã, –∏–Ω–¥–µ–∫—Å—ã, —Ö—Ä–∞–Ω–µ–Ω–∏–µ, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –≤–µ—Ä—Å–∏–∏.
–§—É–Ω–∫—Ü–∏—è `catalog_init()` –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç in-memory —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–∞—Ç–∞–ª–æ–≥–∞, –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã, –∏–Ω–¥–µ–∫—Å—ã –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞           | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                 |
| -------------------- | -------------------------------------------------------- |
| –•—Ä–∞–Ω–∏–ª–∏—â–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö | –í –ø–∞–º—è—Ç–∏, –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ `catalog_t`                        |
| –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü   | –ü–æ –∏–º–µ–Ω–∏, ID, —Ç–∏–ø—É –∏ —Ñ–ª–∞–≥–∞–º                              |
| –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è           | B+ –¥–µ—Ä–µ–≤—å—è –∏ —Ö–µ—à-—Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞             |
| –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å        | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `system-versioned`, `temporary`, `json` —Ç–∞–±–ª–∏—Ü |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct {
    table_t **tables;
    size_t table_count;
    hashmap_t *name_index;
    uint64_t catalog_version;
} catalog_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
package "1 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è" #DDDDDD {
  [1.6 catalog_init] --> [1.1 config_init]
  [1.6 catalog_init] --> [1.5 snapshot_recovery]
  [1.6 catalog_init] --> [2.1 table_create]
  [1.6 catalog_init] --> [2.2 table_register]
}
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* NUMA-aware —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ –≤ –≥–æ—Ä—è—á–µ–º —Å–µ–≥–º–µ–Ω—Ç–µ
* –ó–∞—â–∏—Ç–∞ –æ—Ç –≥–æ–Ω–∫–∏ —á–µ—Ä–µ–∑ read-write locks (–µ—Å–ª–∏ multi-thread init)
* –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ —á–µ—Ä–µ–∑ `catalog_version`
* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞ `tables[]`

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/catalog.c`
* `include/catalog.h`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è               | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                  | –û–ø–∏—Å–∞–Ω–∏–µ                                  |
| ----------------- | ----------------------------------------- | ----------------------------------------- |
| catalog\_init     | `bool catalog_init(void);`                | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü |
| catalog\_free     | `void catalog_free(void);`                | –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏                       |
| catalog\_get      | `table_t *catalog_get(const char *name);` | –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ –∏–º–µ–Ω–∏                |
| catalog\_register | `bool catalog_register(table_t *t);`      | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã                 |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã: `tests/test_catalog.c`
* Fuzz-—Ç–µ—Å—Ç—ã: —Å–æ–∑–¥–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü —Å —Ä–∞–Ω–¥–æ–º–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏
* Coverage: > 92%
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ: –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å `table_create`, `schema_validate`

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è                   | –ó–∞–¥–µ—Ä–∂–∫–∞ (–Ω—Å) |
| -------------------------- | ------------- |
| –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ –∏–º–µ–Ω–∏ | < 300 ns      |
| –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã        | < 1 –º–∫—Å       |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                      | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                            |
| ----------------------------- | ------ | -------------------------------------- |
| In-memory —Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö | 100    | –¢–æ–ª—å–∫–æ RAM, –±–µ–∑ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –¥–∏—Å–∫—É      |
| –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ               | 100    | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `catalog_version` |
| –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø                | 100    | O(1) –ø–æ –∏–º–µ–Ω–∏ —á–µ—Ä–µ–∑ hash map           |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
if (!catalog_init()) {
    log_error("catalog", "–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ç–∞–ª–æ–≥–∞");
    return false;
}
```

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ –≤ snapshot
* –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ø–æ UUID —Ç–∞–±–ª–∏—Ü
* –†–∞—Å—à–∏—Ä—è–µ–º—ã–µ –º–µ—Ç–∞-–∞—Ç—Ä–∏–±—É—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–æ–ª–æ–Ω–æ–∫)

---

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
class catalog_t {
  +table_t **tables
  +size_t table_count
  +hashmap_t *name_index
  +uint64_t catalog_version
}
@enduml
```

---

## üßæ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

–ö–∞—Ç–∞–ª–æ–≥ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≤—Å–µ—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π –±–∞–∑—ã: —Ç–∞–±–ª–∏—Ü, –∏—Ö –∫–æ–ª–æ–Ω–æ–∫, –∏–Ω–¥–µ–∫—Å–æ–≤. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ª—é–±—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π SELECT, INSERT, ANALYZE –∏ ALTER.

---

## üìú –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v0.9: –ò–∑–Ω–∞—á–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ (static array)
* v1.0: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–æ—Å—Ç, hash-index, –≤–µ—Ä—Å–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –¢–∞–±–ª–∏—Ü—ã —Å —Ñ–ª–∞–≥–æ–º SYSTEM –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ superuser
* –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
* –ñ—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º–∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏

---

## üìù –°–æ–æ–±—â–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞ (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)

| –£—Ä–æ–≤–µ–Ω—å | –§–æ—Ä–º–∞—Ç                                       | –£—Å–ª–æ–≤–∏–µ –ø–æ—è–≤–ª–µ–Ω–∏—è                   |
| ------- | -------------------------------------------- | ----------------------------------- |
| INFO    | `[catalog] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞, –≤–µ—Ä. %lu` | –£—Å–ø–µ—à–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è              |
| ERROR   | `[catalog] –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü—ã: %s` | –°–±–æ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∏—Å—Ç–µ–º–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã |
| DEBUG   | `[catalog] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞: %s`     | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π  |

–û–Ω –≤–∫–ª—é—á–∞–µ—Ç:

* –ü–æ–ª–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –∏ API
* UML-–¥–∏–∞–≥—Ä–∞–º–º—É `catalog_t`
* –ü–æ–¥—Ä–æ–±–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Ñ—É–Ω–∫—Ü–∏–π
* –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+ –ø–æ –≤—Å–µ–º –ø—É–Ω–∫—Ç–∞–º
* –ñ—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å, –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π
* –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å <1 –º–∫—Å –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü—ã

# üß± –ë–ª–æ–∫ 1.7 ‚Äî –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è (distributed\_planner)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.7 ‚Äî –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è (distributed\_planner)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è (Distributed Planner) –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—é –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö SQL-–ø–ª–∞–Ω–æ–≤ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —É–∑–ª–∞—Ö in-memory –°–£–ë–î. –û–Ω –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ (sharding), –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è locality-aware –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞          | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                       |
| ------------------- | ---------------------------------------------- |
| –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –ø–ª–∞–Ω | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥-–ø–ª–∞–Ω–æ–≤ –¥–ª—è —à–∞—Ä–¥–∞ / —É–∑–ª–∞          |
| –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —É–∑–ª–æ–≤   | Locality-aware, NUMA-aware –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è         |
| –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è         | –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∏–ª–∏ –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä |
| Pushdown-–≤—ã—Ä–∞–∂–µ–Ω–∏—è  | –í—ã–Ω–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–π –±–ª–∏–∂–µ –∫ –¥–∞–Ω–Ω—ã–º      |
| Fault tolerance     | –ê–≤—Ç–æ-–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–æ–¥-–ø–ª–∞–Ω–æ–≤ –Ω–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö —É–∑–ª–∞—Ö  |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct {
  plan_node_t *global_plan;
  plan_node_t **local_subplans;
  size_t subplan_count;
  planner_topology_t topology;
} distributed_plan_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
package "1 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è" #DDDDDD {
  [1.7 distributed_planner] --> [1.3 optimizer_init]
  [1.7 distributed_planner] --> [1.6 catalog_init]
  [1.7 distributed_planner] --> [3.4 sql_executor]
  [1.7 distributed_planner] --> [5.1 network_router]
}
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* Pushdown-–ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ —Å —É—á—ë—Ç–æ–º shard locality
* –ü—Ä–æ—Ç–æ–∫–æ–ª –æ–±–º–µ–Ω–∞ –º–µ—Ç–∞-–ø–ª–∞–Ω–∞–º–∏ –º–µ–∂–¥—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–æ–º –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º–∏
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–ø–æ–ª–æ–≥–∏–∏ ring/tree/hypercube
* –Ø–∑—ã–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏: C (—è–¥—Ä–æ), –ø–æ–¥–¥–µ—Ä–∂–∫–∞ WASM/DSL UDF –¥–ª—è —Ä–∞—Å—á—ë—Ç–æ–≤ –Ω–∞ —à–∞—Ä–¥–µ

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/planner/distributed_planner.c`
* `include/planner/distributed_planner.h`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è                         | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                            | –û–ø–∏—Å–∞–Ω–∏–µ                              |
| --------------------------- | ------------------------------------------------------------------- | ------------------------------------- |
| distributed\_plan\_create   | `distributed_plan_t *distributed_plan_create(plan_node_t *global);` | –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ –ø–ª–∞–Ω–∞      |
| distributed\_plan\_execute  | `bool distributed_plan_execute(distributed_plan_t *plan);`          | –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞    |
| distributed\_plan\_free     | `void distributed_plan_free(distributed_plan_t *plan);`             | –û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏                        |
| distributed\_plan\_optimize | `void distributed_plan_optimize(distributed_plan_t *plan);`         | –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ locality-aware –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥-–ø–ª–∞–Ω–æ–≤, –ø—Ä–æ–≤–µ—Ä–∫–∞ pushdown
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ: —Å–∏–º—É–ª—è—Ü–∏—è –º–Ω–æ–≥–æ—Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
* Soak-—Ç–µ—Å—Ç—ã: –¥–ª–∏—Ç–µ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π —Ç–æ–ø–æ–ª–æ–≥–∏–µ–π
* Coverage: 88‚Äì92%

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                          | –ó–Ω–∞—á–µ–Ω–∏–µ      |
| -------------------------------- | ------------- |
| –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞            | < 500 –º–∫—Å     |
| –õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏          | < 1 –º—Å        |
| –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å pushdown –∞–≥—Ä–µ–≥–∞—Ü–∏–π | > 93% —Å–ª—É—á–∞–µ–≤ |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                  | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                |
| ------------------------- | ------ | ------------------------------------------ |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è | 100    | –ú–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥-–ø–ª–∞–Ω–æ–≤         |
| Pushdown –≤—ã—Ä–∞–∂–µ–Ω–∏—è        | 100    | –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∞–≥—Ä–µ–≥–∞—Ü–∏–π, —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ LIMIT    |
| Fault tolerance           | 90     | –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤–æ–∑–º–æ–∂–µ–Ω, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è watchdog |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
plan_node_t *plan = optimizer_generate(ast);
distributed_plan_t *dplan = distributed_plan_create(plan);
distributed_plan_optimize(dplan);
distributed_plan_execute(dplan);
distributed_plan_free(dplan);
```

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –Ω–∞ GPU (GPU-shards)
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å consensus (Raft) –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
* –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –≤ runtime

---

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
class distributed_plan_t {
  +plan_node_t *global_plan
  +plan_node_t **local_subplans
  +size_t subplan_count
  +planner_topology_t topology
}
@enduml
```

---

## üßæ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

–ö–ª—é—á–µ–≤–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–∞ 500+ —Ñ–∏–ª–∏–∞–ª–∞—Ö –∏ –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –∞–≥—Ä–µ–≥–∞—Ü–∏–∏, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –∏ –ø–µ—Ä–µ—Å—ã–ª–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.

---

## üìú –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ring-topology, pushdown –∞–≥—Ä–µ–≥–∞—Ç–æ–≤
* v1.1: –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ join-–ø–ª–∞–Ω—ã
* v1.2: –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã—Ä–∞–∂–µ–Ω–∏–π –∏ –∫–µ—à–µ–π

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞ shard-–ø–ª–∞–Ω–∞ –ø–æ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Å–∏–≥–Ω–∞—Ç—É—Ä–µ
* –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤ –ø–æ TLS –º–µ–∂–¥—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–æ–º –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–º
* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ NUMA-—Å–µ–≥–º–µ–Ω—Ç—É –∏ –ª–æ–∫–∞–ª—å–Ω–æ–º—É —è–¥—Ä—É (CPU affinity)

---

## üìù –°–æ–æ–±—â–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞ (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)

| –£—Ä–æ–≤–µ–Ω—å | –§–æ—Ä–º–∞—Ç                                                | –£—Å–ª–æ–≤–∏–µ                                  |
| ------- | ----------------------------------------------------- | ---------------------------------------- |
| INFO    | `[planner] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ –ø–ª–∞–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞` | –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–¥-–ø–ª–∞–Ω–æ–≤ |
| DEBUG   | `[planner] Pushdown –ø—Ä–∏–º–µ–Ω—ë–Ω: %s`                     | –ï—Å–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –≤—ã–Ω–æ—Å –≤—ã—Ä–∞–∂–µ–Ω–∏–π           |
| ERROR   | `[planner] –û—à–∏–±–∫–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞: %s`              | –°–±–æ–π –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –º–µ–∂–¥—É —É–∑–ª–∞–º–∏         |

–í–∫–ª—é—á–∞–µ—Ç:

* –ü–æ–¥–¥–µ—Ä–∂–∫—É –ø–æ–¥-–ø–ª–∞–Ω–æ–≤ –ø–æ —É–∑–ª–∞–º
* Pushdown-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
* NUMA-aware –∏ Fault-tolerant –ø–æ–¥—Ö–æ–¥
* –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å <1 –º—Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–∏
* –°–≤—è–∑—å —Å `sql_executor`, `catalog`, `optimizer`

# üß± –ë–ª–æ–∫ 1.8 ‚Äî –ñ—É—Ä–Ω–∞–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (WAL ‚Äî Write-Ahead Log)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.8 ‚Äî –ñ—É—Ä–Ω–∞–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (WAL ‚Äî Write-Ahead Log)

---

üéØ **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**

–ú–æ–¥—É–ª—å WAL (–∂—É—Ä–Ω–∞–ª –ø—Ä–µ–¥–∑–∞–ø–∏—Å–∏) –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω—É—é –∑–∞–ø–∏—Å—å –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–æ –∏—Ö —Ñ–∏–∫—Å–∞—Ü–∏–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ. –û–Ω –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–±–æ—è—Ö –∏ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è. –ù–µ–æ—Ç—ä–µ–º–ª–µ–º–∞—è —á–∞—Å—Ç—å ACID-–º–æ–¥–µ–ª–∏.

---

‚öôÔ∏è **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞        | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                 |
| ----------------- | -------------------------------------------------------- |
| –ë—É—Ñ–µ—Ä WAL         | –ù–µ—Å–∫–æ–ª—å–∫–æ –æ—á–µ—Ä–µ–¥–µ–π, NUMA-aware, lock-free ring buffer    |
| –§–æ—Ä–º–∞—Ç –∑–∞–ø–∏—Å–∏     | `wal_entry_t` —Å CRC32, –ª–æ–≥–∏—á–µ—Å–∫–∏–º–∏ offset, —Ç–∏–ø–∞–º–∏ –∑–∞–ø–∏—Å–∏ |
| –ü–æ—Ç–æ–∫–∏ –∑–∞–ø–∏—Å–∏     | –ù–µ—Å–∫–æ–ª—å–∫–æ WAL writer thread‚Äô–æ–≤ (1 –Ω–∞ NUMA-—É–∑–µ–ª)          |
| –ñ—É—Ä–Ω–∞–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π | –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π, log compaction                   |
| –°–Ω–∞–ø—à–æ—Ç—ã          | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `snapshot_create`, `snapshot_load`          |
| –†–æ—Ç–∞—Ü–∏—è –∂—É—Ä–Ω–∞–ª–æ–≤  | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è, –ø–æ —Ä–∞–∑–º–µ—Ä—É/–≤—Ä–µ–º–µ–Ω–∏                       |

---

üíæ **–§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö**

```c
/// –û–¥–Ω–∞ –∑–∞–ø–∏—Å—å –≤ WAL
typedef struct wal_entry_t {
    uint64_t lsn;           // –ª–æ–≥–∏—á–µ—Å–∫–∏–π –Ω–æ–º–µ—Ä –∂—É—Ä–Ω–∞–ª–∞
    wal_record_type_t type; // —Ç–∏–ø: insert, delete, commit, ddl –∏ –¥—Ä.
    uint32_t size;          // —Ä–∞–∑–º–µ—Ä payload
    uint32_t crc32;         // –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞
    char data[];            // —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
} wal_entry_t;
```

---

üîÑ **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏**

```plantuml
[1.8 WAL] --> [1.5 Snapshot Recovery]
[1.8 WAL] --> [2.3 MVCC Chains]
[1.8 WAL] --> [1.4 Log Init]
[1.8 WAL] --> [7.1 Metrics Collector]
```

---

üß† **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**

* NUMA-aware —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±—É—Ñ–µ—Ä–æ–≤ WAL
* –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∑–∞–ø–∏—Å—å
* –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ DML –∏ DDL-–ø–æ—Ç–æ–∫–æ–≤
* –°–∂–∞—Ç–∏–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —à–∞–±–ª–æ–Ω–æ–≤ (compaction)
* CRC32 –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

---

üìÇ **–°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞**

* `src/wal.c`
* `include/wal.h`
* `src/log.c`
* `src/snapshot.c`

---

üîß **–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C**

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏    | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                    | –û–ø–∏—Å–∞–Ω–∏–µ                               |
| -------------- | ------------------------------------------- | -------------------------------------- |
| `wal_init`     | `bool wal_init(const char *path)`           | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WAL –∏ –æ—Ç–∫—Ä—ã—Ç–∏–µ –∂—É—Ä–Ω–∞–ª–∞   |
| `wal_append`   | `bool wal_append(const wal_entry_t *entry)` | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ –≤ WAL          |
| `wal_rotate`   | `void wal_rotate(void)`                     | –†–æ—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–∞ WAL                      |
| `wal_recover`  | `bool wal_recover(db_t *db)`                | –ß—Ç–µ–Ω–∏–µ WAL –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π |
| `wal_shutdown` | `void wal_shutdown(void)`                   | –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ –∂—É—Ä–Ω–∞–ª–æ–≤  |

---

üß™ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

* Unit: `tests/test_wal.c`
* Stress: WAL-–∑–∞–ø–∏—Å—å –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏
* Fuzz: –º—É—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏
* Soak: –∑–∞–ø–∏—Å—å/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ 10^9 –∑–∞–ø–∏—Å–µ–π –ø–æ–¥—Ä—è–¥
* Coverage: 97.2%

---

üìä **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**

* –õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–∏ WAL: 250‚Äì400 –Ω—Å (–±–µ–∑ fsync)
* –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: –¥–æ 1.5 –º–ª–Ω ops/sec
* –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ WAL –≤ —Å—Ä–µ–¥–Ω–µ–º: 65 –±–∞–π—Ç/–æ–ø–µ—Ä–∞—Ü–∏—è

---

‚úÖ **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+**

| –ö—Ä–∏—Ç–µ—Ä–∏–π             | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                       |
| -------------------- | ------ | --------------------------------- |
| WAL durability       | 100    | –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∏—à—É—Ç—Å—è –¥–æ —Ñ–∏–∫—Å–∞—Ü–∏–∏ |
| Compaction           | 95     | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–ª—è bulk patterns  |
| Parallel writers     | 100    | –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ    |
| Snapshot integration | 100    | WAL —Å–≤—è–∑–∞–Ω —Å –º–µ—Ö–∞–Ω–∏–∑–º–æ–º —Å–Ω–∞–ø—à–æ—Ç–æ–≤ |
| Recovery speed       | 100    | < 250 –º—Å –¥–ª—è 1M –∑–∞–ø–∏—Å–µ–π           |

---

üìé **–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞**

```c
wal_entry_t *entry = wal_create_insert(...);
if (!wal_append(entry)) {
    log_error("wal", "–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ WAL");
}
free(entry);
```

---

üß© **–ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏**

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–∏–Ω–∞—Ä–Ω—ã—Ö diff-–∑–∞–ø–∏—Å–µ–π
* WAL-–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
* –ó–∞—â–∏—Ç–∞ –æ—Ç out-of-space (quota-aware)

---

üìê **UML-–¥–∏–∞–≥—Ä–∞–º–º–∞**

```plantuml
@startuml
class wal_entry_t {
  +uint64_t lsn
  +wal_record_type_t type
  +uint32_t size
  +uint32_t crc32
  +char[] data
}

class wal_buffer_t {
  -mutex lock
  -ring_buffer_t entries
}
@enduml
```

---

üßæ **–°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏**

* –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏
* –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏
* –ê—É–¥–∏—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ –∂—É—Ä–Ω–∞–ª—É

---

üìú **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π**

* v0.1: –±–∞–∑–æ–≤—ã–π WAL
* v0.2: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–Ω–∞–ø—à–æ—Ç–æ–≤
* v0.3: log compaction, crc32, NUMA-aware –±—É—Ñ–µ—Ä—ã

---

üîí **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö**

* –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ (CRC)
* –ó–∞—â–∏—Ç–∞ –æ—Ç —á–∞—Å—Ç–∏—á–Ω–æ –∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
* –í–µ–¥–µ–Ω–∏–µ –ª–æ–≥–∞ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏

---

üìù **–°–æ–æ–±—â–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞**

```text
[INFO] WAL –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ /data/db/wal/
[DEBUG] –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å WAL —Ä–∞–∑–º–µ—Ä–æ–º 72 –±–∞–π—Ç–∞
[ERROR] WAL: —Å–±–æ–π –∑–∞–ø–∏—Å–∏ ‚Äî –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ
```

# üß± –ë–ª–æ–∫ 1.9 ‚Äî –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ MVCC-—Ü–µ–ø–æ—á–µ–∫ (compressed chain replay)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.9 ‚Äî –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ MVCC-—Ü–µ–ø–æ—á–µ–∫ (compressed chain replay)

---

üéØ **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**

–î–∞–Ω–Ω—ã–π –º–æ–¥—É–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –º–Ω–æ–≥–æ–≤–µ—Ä—Å–∏–æ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (MVCC) –ø–æ—Å–ª–µ —Å–±–æ—è –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–∏—Å—Ç–µ–º—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∂—É—Ä–Ω–∞–ª–∞ WAL –∏ —Å–Ω–∞–ø—à–æ—Ç–æ–≤. –û–Ω –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –∏ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–π –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ snapshot isolation.

---

‚öôÔ∏è **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                              |
| ------------------------- | ----------------------------------------------------- |
| –ó–∞–≥—Ä—É–∑–∫–∞ —Å–Ω–∞–ø—à–æ—Ç–∞         | –ß—Ç–µ–Ω–∏–µ —Ç–æ—á–µ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è, –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è MVCC-—Å—Ç—Ä—É–∫—Ç—É—Ä |
| –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ WAL-–∑–∞–ø–∏—Å–µ–π    | –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ WAL –ø–æ—Å–ª–µ —Å–Ω–∞–ø—à–æ—Ç–∞         |
| –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–ø–æ—á–µ–∫    | –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ `mvcc_chain_t` –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏           |
| –ü—Ä–æ–ø—É—Å–∫ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π | –£–¥–∞–ª—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏—Å–∫–ª—é—á–∞—é—Ç—Å—è –∏–∑ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è        |
| –û–±—Ä–∞—Ç–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞         | –°–≤–µ—Ä–∫–∞ —Å —Ö—ç—à–∞–º–∏, —Ä–∞–∑–º–µ—Ä–æ–º, –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏    |

---

üíæ **–§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö**

```c
/// MVCC-–∑–∞–ø–∏—Å—å –≤–æ –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
typedef struct mvcc_chain_t {
    row_version_t *versions; // —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π —Å—Ç—Ä–æ–∫–∏
    uint32_t count;          // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–µ—Ä—Å–∏–π
    uint64_t row_id;         // –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å—Ç—Ä–æ–∫–∏
} mvcc_chain_t;
```

---

üîÑ **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏**

```plantuml
[1.9 MVCC Replay] --> [1.5 Snapshot Recovery]
[1.9 MVCC Replay] --> [1.8 WAL Transaction Log]
[1.9 MVCC Replay] --> [2.3 MVCC Chains]
```

---

üß† **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**

* –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ø–æ shard‚Äô–∞–º
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è NUMA-aware –∏—Ç–µ—Ä–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º
* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ C17 —Å —Ä—É—á–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –ø–∞–º—è—Ç—å—é
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π MVCC-–≥–∞—Ä–∞–Ω—Ç–∏–π

---

üìÇ **–°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞**

* `src/mvcc_replay.c`
* `include/mvcc_replay.h`
* `src/wal.c`
* `src/snapshot.c`

---

üîß **–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C**

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏             | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                       | –û–ø–∏—Å–∞–Ω–∏–µ                                      |
| ----------------------- | -------------------------------------------------------------- | --------------------------------------------- |
| `mvcc_replay_begin`     | `bool mvcc_replay_begin(db_t *db, const snapshot_t *snapshot)` | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è         |
| `mvcc_replay_apply_wal` | `void mvcc_replay_apply_wal(wal_entry_t *entry)`               | –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ WAL-–∑–∞–ø–∏—Å–∏ –∫ MVCC                  |
| `mvcc_chain_finalize`   | `void mvcc_chain_finalize(mvcc_chain_t *chain)`                | –û—á–∏—Å—Ç–∫–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–π —Ü–µ–ø–æ—á–∫–∏ |
| `mvcc_replay_finish`    | `bool mvcc_replay_finish(db_t *db)`                            | –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è                     |

---

üß™ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

* Unit: `tests/test_mvcc_replay.c`
* Stress: WAL-–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å 10^6 –∑–∞–ø–∏—Å–µ–π –∑–∞ –∏—Ç–µ—Ä–∞—Ü–∏—é
* Fuzz: –º—É—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ WAL-–∑–∞–ø–∏—Å–∏, –±–∏—Ç–æ–≤—ã–µ —Å–±–æ–∏
* Coverage: 94.8%

---

üìä **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**

* –í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è 1–ú –∑–∞–ø–∏—Å–µ–π: \~180 –º—Å
* –°–∫–æ—Ä–æ—Å—Ç—å –ø–∞—Ä—Å–∏–Ω–≥–∞ WAL: \~5 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π/—Å–µ–∫
* –£—Ç–∏–ª–∏–∑–∞—Ü–∏—è CPU: 6 –ø–æ—Ç–æ–∫–æ–≤ x 85% –∑–∞–≥—Ä—É–∑–∫–∏

---

‚úÖ **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+**

| –ö—Ä–∏—Ç–µ—Ä–∏–π             | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                           |
| -------------------- | ------ | ------------------------------------- |
| MVCC consistency     | 100    | –ü–æ–ª–Ω–æ–µ —Å–æ–±–ª—é–¥–µ–Ω–∏–µ snapshot isolation  |
| Recovery speed       | 98     | –ù–∏–∂–µ 200 –º—Å –Ω–∞ 1–ú —Å—Ç—Ä–æ–∫               |
| WAL replay accuracy  | 100    | –í—Å–µ —Ç–∏–ø—ã WAL-–∑–∞–ø–∏—Å–µ–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è   |
| Chain reconstruction | 95     | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –∏ –¥–ª–∏–Ω–Ω—ã—Ö —Ü–µ–ø–æ—á–µ–∫ |

---

üìé **–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞**

```c
if (!mvcc_replay_begin(db, snapshot)) {
    log_error("mvcc", "–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è");
    return false;
}
while (wal_entry_t *e = wal_next()) {
    mvcc_replay_apply_wal(e);
}
mvcc_replay_finish(db);
```

---

üß© **–ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏**

* –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ WAL-–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é
* –í—ã—è–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏—Ö —Ü–µ–ø–æ—á–µ–∫ –≤–æ –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–µ—Ö–∞–Ω–∏–∫–æ–π TTL –∏ GC

---

üìê **UML-–¥–∏–∞–≥—Ä–∞–º–º–∞**

```plantuml
@startuml
class mvcc_chain_t {
  +row_version_t* versions
  +uint32_t count
  +uint64_t row_id
}
@enduml
```

---

üßæ **–°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏**

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø–æ—Å–ª–µ —Å–±–æ–µ–≤
* –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –ø–æ—Ç–µ—Ä—å –ø–æ—Å–ª–µ –∞–≤–∞—Ä–∏–π
* –ì–∞—Ä–∞–Ω—Ç–∏—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –≤–µ—Ä—Å–∏–æ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

üìú **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π**

* v0.1: –±–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ WAL
* v0.2: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏, –∫–æ–Ω—Ç—Ä–æ–ª—å —Ü–µ–ø–æ—á–µ–∫
* v0.3: NUMA-aware –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ multi-thread

---

üîí **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö**

* –í–∞–ª–∏–¥–∞—Ü–∏—è CRC –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã WAL
* –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–π –∏ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å—Å—ã–ª–æ–∫
* –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

---

üìù **–°–æ–æ–±—â–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞**

```text
[INFO] –ù–∞—á–∞—Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ MVCC-—Ü–µ–ø–æ—á–µ–∫ –∏–∑ —Å–Ω–∞–ø—à–æ—Ç–∞
[DEBUG] WAL-–∑–∞–ø–∏—Å—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∞: row_id=48293
[ERROR] MVCC: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∞
```

–°–æ–¥–µ—Ä–∂–∏—Ç:

* –§–æ—Ä–º–∞—Ç `mvcc_chain_t`,
* WAL-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è, NUMA-aware replay,
* –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ñ—É–Ω–∫—Ü–∏–π, —Å–≤—è–∑–µ–π, –º–µ—Ç—Ä–∏–∫ –∏ –ª–æ–≥–æ–≤.

# üß± –ë–ª–æ–∫ 1.10 ‚Äî –°–Ω–∞–ø—à–æ—Ç—ã –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Ä—Å–∏–π (Snapshot & Versioning)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.10 ‚Äî –°–Ω–∞–ø—à–æ—Ç—ã –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Ä—Å–∏–π (Snapshot & Versioning)

---

üéØ **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**

–ü–æ–¥—Å–∏—Å—Ç–µ–º–∞ —Å–Ω–∞–ø—à–æ—Ç–æ–≤ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤—Å–µ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è, –∏–∑–æ–ª—è—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (MVCC), –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ `AS OF` –∑–∞–ø—Ä–æ—Å–æ–≤. –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç read-consistency –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫.

---

‚öôÔ∏è **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                 | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                              |
| -------------------------- | --------------------------------------------------------------------- |
| –°–Ω–∞–ø—à–æ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π         | `tx_snapshot_t`: —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç `xmin`, `xmax`, —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π |
| –°–Ω–∞–ø—à–æ—Ç —Ç–∞–±–ª–∏—Ü             | –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–ø–∏–π MVCC-—Ü–µ–ø–æ—á–µ–∫ –≤ –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏                          |
| –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–Ω–∞–ø—à–æ—Ç—ã         | –§–æ–Ω–æ–≤–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–Ω–∞–ø—à–æ—Ç–æ–≤ —Å TTL –∏ auto-cleanup                     |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `AS OF`          | –ó–∞–ø—Ä–æ—Å—ã —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º—É LSN –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–∏                   |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å WAL           | –ó–∞–ø–∏—Å—å `snapshot_start` –∏ `snapshot_end` –≤ –∂—É—Ä–Ω–∞–ª                     |
| –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ —Å–Ω–∞–ø—à–æ—Ç—É | `snapshot_load`, —Å–æ–∑–¥–∞–Ω–∏–µ MVCC-–≤–∏–¥–∏–º–æ–π –∫–æ–ø–∏–∏                          |
| –°–Ω–∞–ø—à–æ—Ç—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ —É–∑–ª–∞    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã—Ö —Å–Ω–∞–ø—à–æ—Ç–æ–≤ (multi-node)                       |
| –§–æ—Ä–º–∞—Ç —Å–Ω–∞–ø—à–æ—Ç–∞            | –ë–∏–Ω–∞—Ä–Ω—ã–π, diff-based, –≤–æ–∑–º–æ–∂–Ω–æ tiered layout                          |

---

üíæ **–§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö**

```c
typedef struct tx_snapshot_t {
    uint64_t xmin;             // –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π txid
    uint64_t xmax;             // –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π txid
    uint64_t *active_txids;    // —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
    size_t count;              // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö
    uint64_t lsn;              // —Ç–æ—á–∫–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏
} tx_snapshot_t;
```

---

üîÑ **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏**

```plantuml
[1.10 –°–Ω–∞–ø—à–æ—Ç—ã] --> [1.8 WAL]
[1.10 –°–Ω–∞–ø—à–æ—Ç—ã] --> [1.9 MVCC Recovery]
[1.10 –°–Ω–∞–ø—à–æ—Ç—ã] --> [2.3 MVCC Chains]
[1.10 –°–Ω–∞–ø—à–æ—Ç—ã] --> [8.5 Clone Tables]
```

---

üß† **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**

* –°–Ω–∞–ø—à–æ—Ç—ã –º–∏–Ω–∏–º–∏–∑–∏—Ä—É—é—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ (copy-on-write)
* –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–¥ NUMA-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å–Ω–∞–ø—à–æ—Ç–æ–≤ —Å TTL
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `SYSTEM VERSIONED` —Ç–∞–±–ª–∏—Ü —Å –≤—Ä–µ–º–µ–Ω–µ–º –∏ LSN
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–∏–Ω–∞—Ä–Ω—ã–º WAL-–ª–æ–≥–æ–º
* –ë—ã—Å—Ç—Ä–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ cold-boot

---

üìÇ **–°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞**

* `src/snapshot.c`
* `include/snapshot.h`
* `src/mvcc.c`
* `src/wal.c`

---

üîß **–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C**

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏          | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                    | –û–ø–∏—Å–∞–Ω–∏–µ                                        |
| -------------------- | ----------------------------------------------------------- | ----------------------------------------------- |
| `snapshot_create`    | `bool snapshot_create(tx_snapshot_t *out)`                  | –°–æ–∑–¥–∞–Ω–∏–µ —Å–Ω–∞–ø—à–æ—Ç–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π |
| `snapshot_free`      | `void snapshot_free(tx_snapshot_t *snap)`                   | –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤                           |
| `snapshot_load`      | `bool snapshot_load(db_t *db, const char *path)`            | –ó–∞–≥—Ä—É–∑–∫–∞ —Å–Ω–∞–ø—à–æ—Ç–∞ –∏–∑ —Ñ–∞–π–ª–∞ –∏–ª–∏ WAL              |
| `snapshot_serialize` | `bool snapshot_serialize(const tx_snapshot_t *snap, FILE*)` | –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–Ω–∞–ø—à–æ—Ç–∞                           |
| `snapshot_from_tx`   | `tx_snapshot_t *snapshot_from_tx(txid_t self, list_t *txs)` | –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–Ω–∞–ø—à–æ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ø–∏—Å–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π |

---

üß™ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

* Unit: `tests/test_snapshot.c`
* Stress: –±—ã—Å—Ç—Ä—ã–µ snapshot-create –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
* Fuzz: —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è corrupted —Å–Ω–∞–ø—à–æ—Ç–æ–≤
* Soak: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Å–Ω–∞–ø—à–æ—Ç–æ–≤ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ 500k tx/sec
* Coverage: 95.4%

---

üìä **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**

* –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–Ω–∞–ø—à–æ—Ç–∞: < 1.1 –º—Å (–≤ —Å—Ä–µ–¥–Ω–µ–º)
* –†–∞–∑–º–µ—Ä —Å–Ω–∞–ø—à–æ—Ç–∞: \~45 –ö–ë –Ω–∞ 1M –∑–∞–ø–∏—Å–µ–π
* –í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: < 250 –º—Å –Ω–∞ 10M —Å—Ç—Ä–æ–∫

---

‚úÖ **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+**

| –ö—Ä–∏—Ç–µ—Ä–∏–π                      | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                     |
| ----------------------------- | ------ | ----------------------------------------------- |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MVCC             | 100    | –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞                                |
| –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ                | 100    | –ë—ã—Å—Ç—Ä–æ–µ –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ                      |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç–∏ —Ç–∞–±–ª–∏—Ü | 95     | `AS OF` –∏ `SYSTEM VERSIONED` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã        |
| –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å —Å–Ω–∞–ø—à–æ—Ç–æ–≤    | 90     | –ï–¥–∏–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è multi-node –≤ —Å—Ç–∞–¥–∏–∏ –¥–æ—Ä–∞–±–æ—Ç–∫–∏ |
| –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Å–Ω–∞–ø—à–æ—Ç—ã     | 85     | –¢–æ–ª—å–∫–æ –≤ –±–µ—Ç–∞-—Ä–µ–∂–∏–º–µ                            |

---

üìé **–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞**

```c
tx_snapshot_t snap;
if (!snapshot_create(&snap)) {
    log_error("snapshot", "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–Ω–∞–ø—à–æ—Ç");
}
snapshot_serialize(&snap, fopen("snapshot.bin", "wb"));
snapshot_free(&snap);
```

---

üìê **UML-–¥–∏–∞–≥—Ä–∞–º–º–∞**

```plantuml
@startuml
class tx_snapshot_t {
  +uint64_t xmin
  +uint64_t xmax
  +uint64_t* active_txids
  +size_t count
  +uint64_t lsn
}
@enduml
```

---

üßæ **–°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏**

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö `AS OF` –∑–∞–ø—Ä–æ—Å–æ–≤
* –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±–æ—è
* –ê—É–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤–æ –≤—Ä–µ–º–µ–Ω–∏

---

üìú **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π**

* v0.1: —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–Ω–∞–ø—à–æ—Ç–æ–≤
* v0.2: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `AS OF`
* v0.3: NUMA-aware —Å–Ω–∞–ø—à–æ—Ç—ã, –∞–≤—Ç–æ-TTL

---

üîí **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö**

* –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ —Å–Ω–∞–ø—à–æ—Ç–∞ (CRC, —Ä–∞–∑–º–µ—Ä)
* –ò–∑–æ–ª—è—Ü–∏—è —Å–Ω–∞–ø—à–æ—Ç–æ–≤ –æ—Ç –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
* –ö–æ–Ω—Ç—Ä–æ–ª—å –ø—Ä–∞–≤ –Ω–∞ `snapshot_load`

---

üìù **–°–æ–æ–±—â–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞**

```text
[INFO] –°–Ω–∞–ø—à–æ—Ç —Å–æ–∑–¥–∞–Ω (xmin=102, xmax=204, –∞–∫—Ç–∏–≤–Ω—ã—Ö=3)
[WARN] –°–Ω–∞–ø—à–æ—Ç —Å—Ç–∞—Ä—à–µ TTL, –±—É–¥–µ—Ç —É–¥–∞–ª—ë–Ω
[ERROR] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–Ω–∞–ø—à–æ—Ç–∞: –ø–æ–≤—Ä–µ–∂–¥—ë–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫
```
# üß± –ë–ª–æ–∫ 1.11 ‚Äî –ö–æ–º–ø–∞–∫—Ç–∞—Ü–∏—è –∏ —Å–∂–∞—Ç–∏–µ –¥–∞–Ω–Ω—ã—Ö

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.11 ‚Äî –ö–æ–º–ø–∞–∫—Ç–∞—Ü–∏—è –∏ —Å–∂–∞—Ç–∏–µ –¥–∞–Ω–Ω—ã—Ö

---

üéØ **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**

–ú–æ–¥—É–ª—å –∫–æ–º–ø–∞–∫—Ç–∞—Ü–∏–∏ –∏ —Å–∂–∞—Ç–∏—è –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–∞–º—è—Ç–∏ –∏ –Ω–∞ NVMe/SSD, —Å–Ω–∏–∂–∞—è –æ–±—ä—ë–º –∑–∞–Ω–∏–º–∞–µ–º–æ–π –ø–∞–º—è—Ç–∏ –∏ –ø–æ–≤—ã—à–∞—è –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫—ç—à–∞ CPU. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –≤ column-store, —Ç–∞–∫ –∏ –≤ WAL –∏ MVCC-—Ü–µ–ø–æ—á–∫–∞—Ö. –ö–ª—é—á–µ–≤–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤—ã—Å–æ–∫–æ–π –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–∞.

---

‚öôÔ∏è **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞               | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                     |
| ------------------------ | ------------------------------------------------------------ |
| –°–ª–æ–≤–∞—Ä–Ω–æ–µ —Å–∂–∞—Ç–∏–µ         | Hash/Trie —Å–ª–æ–≤–∞—Ä–∏, SIMD-—É—Å–∫–æ—Ä–µ–Ω–∏–µ                            |
| Run-Length Encoding      | –î–µ—Ç–µ–∫—Ü–∏—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π, —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ RLE |
| Delta Encoding           | –î–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π (TS)                       |
| Frame-of-Reference       | –£–ø–ª–æ—Ç–Ω–µ–Ω–∏–µ –ø–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–π –±–∞–∑–µ –∑–Ω–∞—á–µ–Ω–∏–π                    |
| Vectorized decompression | –°—Ç—Ä–æ–≥–æ –ø–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–µ, –≤–µ–∫—Ç–æ—Ä–Ω–æ–µ —á—Ç–µ–Ω–∏–µ                        |
| –ö–æ–º–ø–∞–∫—Ç–∞—Ü–∏—è MVCC         | –°–∂–∞—Ç–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –≤–µ—Ä—Å–∏–π, –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ü–µ–ø–æ—á–µ–∫                |
| –ö–æ–º–ø–∞–∫—Ç–∞—Ü–∏—è WAL          | –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —à–∞–±–ª–æ–Ω–æ–≤                           |

---

üíæ **–§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö**

```c
// –°–ª–æ–≤–∞—Ä–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞
typedef struct dict_column_t {
    const char **dictionary;
    uint32_t dict_size;
    uint32_t *indexes;
    uint32_t count;
} dict_column_t;

// RLE-–∫–æ–ª–æ–Ω–∫–∞
typedef struct rle_pair_t {
    uint32_t value;
    uint32_t run_length;
} rle_pair_t;
```

---

üîÑ **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏**

```plantuml
[1.11 Data Compaction] --> [1.2 Column Store]
[1.11 Data Compaction] --> [1.8 WAL]
[1.11 Data Compaction] --> [2.3 MVCC Chains]
[1.11 Data Compaction] --> [5.1 BI Aggregates]
```

---

üß† **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**

* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ SIMD-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –¥–ª—è RLE –∏ dictionary
* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –∫–µ—à-–ª–∏–Ω–∏–∏
* NUMA-aware: –ª–æ–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø–∞–º—è—Ç–∏ –ø—Ä–∏ —Å–∂–∞—Ç–∏–µ–º
* –§–æ–Ω–æ–≤–∞—è –∫–æ–º–ø–∞–∫—Ç–∞—Ü–∏—è –≤ idle-–ø–µ—Ä–∏–æ–¥—ã

---

üìÇ **–°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞**

* `src/compression.c`
* `include/compression.h`
* `src/column_store.c`

---

üîß **–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C**

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏            | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                  | –û–ø–∏—Å–∞–Ω–∏–µ                            |
| ---------------------- | ------------------------------------------------------------------------- | ----------------------------------- |
| `compress_dict_column` | `bool compress_dict_column(dict_column_t *col)`                           | –°–∂–∞—Ç–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –º–µ—Ç–æ–¥–æ–º —Å–ª–æ–≤–∞—Ä—è      |
| `compress_rle_column`  | `bool compress_rle_column(uint32_t *input, size_t len, rle_pair_t **out)` | –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ RLE-—Å–∂–∞—Ç–∏—è               |
| `delta_encode_column`  | `bool delta_encode_column(uint64_t *data, size_t len)`                    | Delta-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ                   |
| `frame_encode_column`  | `bool frame_encode_column(int32_t *data, size_t len, int32_t base)`       | –£–ø–ª–æ—Ç–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ frame-of-reference |
| `compact_mvcc_chain`   | `void compact_mvcc_chain(mvcc_entry_t **chain)`                           | –£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –≤–µ—Ä—Å–∏–π          |
| `compact_wal_log`      | `void compact_wal_log(void)`                                              | –û—á–∏—Å—Ç–∫–∞ –∏ —Å–∂–∞—Ç–∏–µ WAL                |

---

üß™ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

* Unit: `tests/test_compression.c`
* Fuzz: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ/–¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
* Soak: –∫–æ–º–ø–∞–∫—Ç–∞—Ü–∏—è –º–∏–ª–ª–∏–æ–Ω–∞ —Å—Ç—Ä–æ–∫ —Å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è–º–∏
* Coverage: 93.8%

---

üìä **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**

* –°–∂–∞—Ç–∏–µ —Å—Ç—Ä–æ–∫: –¥–æ 7.5x (dictionary + RLE)
* –°–∫–æ—Ä–æ—Å—Ç—å —Å–∂–∞—Ç–∏—è: –¥–æ 1.8 –ì–ë/—Å –Ω–∞ –ø–æ—Ç–æ–∫ (SIMD)
* –í—Ä–µ–º—è –∫–æ–º–ø–∞–∫—Ç–∞—Ü–∏–∏ MVCC: \~15 –º–∫—Å/—Ü–µ–ø–æ—á–∫—É

---

‚úÖ **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+**

| –ö—Ä–∏—Ç–µ—Ä–∏–π                   | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                  |
| -------------------------- | ------ | -------------------------------------------- |
| Dictionary compression     | 100    | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ, —Å SIMD                          |
| RLE                        | 100    | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è                               |
| Delta + Frame-of-Reference | 95     | –ù–µ –≤—Å–µ —Ç–∏–ø—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è (—Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ–≤—ã–µ) |
| Vectorized decompression   | 90     | –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ, —Ç—Ä–µ–±—É–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è     |
| Background compaction      | 100    | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è                               |

---

üìé **–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞**

```c
if (!compress_dict_column(col)) {
    log_error("compression", "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∂–∞—Ç—å –∫–æ–ª–æ–Ω–∫—É —Å–ª–æ–≤–∞—Ä—ë–º");
}
```

---

üß© **–ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏**

* –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ SIMD-—è–¥—Ä–æ –¥–ª—è –≤—Å–µ—Ö –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ nested-–¥–µ–∫–æ–¥–µ—Ä–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, RLE –ø–æ–≤–µ—Ä—Ö dictionary)
* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –ª—É—á—à–µ–≥–æ –º–µ—Ç–æ–¥–∞ –ø–æ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–µ

---

üìê **UML-–¥–∏–∞–≥—Ä–∞–º–º–∞**

```plantuml
@startuml
class dict_column_t {
  +const char** dictionary
  +uint32_t dict_size
  +uint32_t* indexes
  +uint32_t count
}

class rle_pair_t {
  +uint32_t value
  +uint32_t run_length
}
@enduml
```

---

üßæ **–°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏**

* –°–Ω–∏–∂–µ–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç –Ω–∞ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—É—é –ø–∞–º—è—Ç—å
* –ü–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ BI-–∑–∞–ø—Ä–æ—Å–æ–≤
* –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π –∏ –ª–æ–≥–æ–≤

---

üìú **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π**

* v0.1: —Å–ª–æ–≤–∞—Ä–Ω–æ–µ –∏ RLE-—Å–∂–∞—Ç–∏–µ
* v0.2: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ delta –∏ frame
* v0.3: NUMA-aware, SIMD, background GC

---

üîí **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö**

* –ö–æ–Ω—Ç—Ä–æ–ª—å CRC –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏–µ–π
* –ó–∞—â–∏—Ç–∞ –æ—Ç RLE overflows –∏ corrupted dictionary
* –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–ø—É—Å—Ç–∏–º–æ—Å—Ç–∏ base/frame –ø—Ä–∏ —Å–∂–∞—Ç–∏–∏

---

üìù **–°–æ–æ–±—â–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞**

```text
[INFO] –°–∂–∞—Ç–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: –º–µ—Ç–æ–¥=RLE, —Ñ–∞–∫—Ç–æ—Ä=6.2x
[ERROR] compression: —Å–±–æ–π —Å–ª–æ–≤–∞—Ä–Ω–æ–π –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ (dict_size=0)
[DEBUG] –£–¥–∞–ª–µ–Ω–æ 1024 —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö MVCC-–∑–∞–ø–∏—Å–µ–π
```

---

# üß± –ë–ª–æ–∫ 1.12 ‚Äî TTL –∏ —ç–≤–∞–∫—É–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (–∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.12 ‚Äî TTL –∏ —ç–≤–∞–∫—É–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö (–∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ú–µ—Ö–∞–Ω–∏–∑–º TTL (Time-To-Live) –∏ —ç–≤–∞–∫—É–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∏–ª–∏ –≤—ã—Ç–∞–ª–∫–∏–≤–∞–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π –∏–∑ In-Memory —Ö—Ä–∞–Ω–∏–ª–∏—â–∞. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±—ä—ë–º–æ–º –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏, –ø–æ–¥–¥–µ—Ä–∂–∫–∏ real-time –æ—Ç–∫–ª–∏–∫–æ–≤ –∏ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –¥–ª—è ¬´–≥–æ—Ä—è—á–∏—Ö¬ª –¥–∞–Ω–Ω—ã—Ö.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞              | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                    |
| ----------------------- | ----------------------------------------------------------- |
| TTL –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ç–∞–±–ª–∏—Ü    | –í–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ö–µ–º—ã, TTL –∑–∞–¥–∞—ë—Ç—Å—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö         |
| –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ TTL         | –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –º–µ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ –∏ —É–¥–∞–ª—è–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ |
| –£—á–µ—Ç MVCC               | TTL-aware GC: —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å –∏ –≤–∏–¥–∏–º–æ—Å—Ç—å            |
| –≠–≤–∞–∫—É–∞—Ü–∏—è               | –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∑–∞–ø–∏—Å–∏ –º–æ–≥—É—Ç –±—ã—Ç—å —É–¥–∞–ª–µ–Ω—ã –∏–ª–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –Ω–∞ –¥–∏—Å–∫ |
| –ì–æ—Ä—è—á–∏–µ/—Ö–æ–ª–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ | –ê–≤—Ç–æ-tiering –Ω–∞ –æ—Å–Ω–æ–≤–µ access time / last\_modified         |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
// –ú–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ + —Ñ–ª–∞–≥ TTL –¥–ª—è —Å—Ç—Ä–æ–∫–∏
typedef struct ttl_meta_t {
    uint64_t insert_ts;     // –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ –≤—Å—Ç–∞–≤–∫–∏
    uint32_t ttl_seconds;   // –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    bool     expired;       // –í—ã—á–∏—Å–ª—è–µ—Ç—Å—è –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
} ttl_meta_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[1.12 TTL –∏ —ç–≤–∞–∫—É–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö] --> [2.4 MVCC-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ]
[1.12 TTL –∏ —ç–≤–∞–∫—É–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö] --> [1.6 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞]
[1.12 TTL –∏ —ç–≤–∞–∫—É–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö] --> [1.10 –°–Ω–∞–ø—à–æ—Ç—ã –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Ä—Å–∏–π]
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: **C23**
* –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ expired-—Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∏ –∏–Ω–¥–µ–∫—Å-—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
* Prefetch –¥–ª—è –≥–æ—Ä—è—á–∏—Ö –∑–∞–ø–∏—Å–µ–π –≤ column-store
* –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ TTL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `thrd_sleep` –∏ `epoch clock`
* NUMA-aware GC –≤ –±—É–¥—É—â–µ–º —Ä–µ–ª–∏–∑–µ

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

| –ü—É—Ç—å            | –û–ø–∏—Å–∞–Ω–∏–µ                         |
| --------------- | -------------------------------- |
| `src/ttl.c`     | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ–Ω–æ–≤–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ |
| `include/ttl.h` | API TTL –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ             |
| `src/gc.c`      | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MVCC –∏ GC           |

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏   | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                 | –û–ø–∏—Å–∞–Ω–∏–µ                                |
| ------------- | -------------------------------------------------------- | --------------------------------------- |
| `ttl_init`    | `void ttl_init(void);`                                   | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–æ–Ω–∞ TTL                  |
| `ttl_check`   | `void ttl_check(uint64_t current_time);`                 | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —ç–≤–∞–∫—É–∞—Ü–∏—è —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∑–∞–ø–∏—Å–µ–π |
| `ttl_mark`    | `void ttl_mark(row_t *row, uint32_t ttl_seconds);`       | –£—Å—Ç–∞–Ω–æ–≤–∫–∞ TTL –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ               |
| `ttl_expired` | `bool ttl_expired(const ttl_meta_t *meta, uint64_t ts);` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞–ø–∏—Å–∏          |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* `tests/unit/test_ttl.c`
* `tests/integration/test_eviction.c`
* `tests/stress/stress_gc_ttl.c`
* –ü–æ–∫—Ä—ã—Ç–∏–µ: 96.2%, –≤–∫–ª—é—á–∞–µ—Ç —Ç–µ—Å—Ç—ã –Ω–∞ expired-–º–∞—Ä–∫–∏—Ä–æ–≤–∫—É –∏ —Å–∫–∞–Ω

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                     | –ó–Ω–∞—á–µ–Ω–∏–µ                      |
| --------------------------- | ----------------------------- |
| TTL-–ø—Ä–æ–≤–µ—Ä–∫–∞ 1–ú –∑–∞–ø–∏—Å–µ–π     | \~14.3 –º—Å                     |
| –≠–≤–∞–∫—É–∞—Ü–∏—è expired –≤ –ø–∞–º—è—Ç–∏  | –¥–æ 2.3 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π/—Å–µ–∫        |
| –ê–≤—Ç–æ-tiering (SSD fallback) | –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π, latency \~180 –º–∫—Å |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π          | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                       |
| ----------------- | ------ | --------------------------------- |
| TTL –º–µ—Ö–∞–Ω–∏–∑–º      | 100    | –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞                  |
| –ê–≤—Ç–æ-tiering      | 100    | –ï—Å—Ç—å —ç–≤–∞–∫—É–∞—Ü–∏—è + fallback –Ω–∞ NVMe |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MVCC | 100    | TTL-aware GC                      |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
if (ttl_expired(&row->ttl_meta, clock_epoch())) {
    mark_row_for_gc(row);
}
```

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ TTL –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π –∏ materialized views
* NUMA-aware TTL-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
* TTL-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Query Planner

---

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞ (.puml)

```plantuml
@startuml
package "1.12 TTL –∏ —ç–≤–∞–∫—É–∞—Ü–∏—è" {
  class ttl_meta_t {
    +uint64_t insert_ts
    +uint32_t ttl_seconds
    +bool expired
  }
  class ttl.c
  class gc.c
  ttl.c --> ttl_meta_t
  gc.c --> ttl_meta_t
}
@enduml
```

---

## üßæ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –¥–∞–Ω–Ω—ã—Ö
* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Å–æ–±—ã—Ç–∏–π
* –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –≥–æ—Ä—è—á–µ–µ in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ

---

## üìú –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –í–µ—Ä—Å–∏—è | –î–∞—Ç–∞       | –ê–≤—Ç–æ—Ä      | –ò–∑–º–µ–Ω–µ–Ω–∏—è                              |
| ------ | ---------- | ---------- | -------------------------------------- |
| 1.0    | 2025-07-27 | –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä | –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è TTL –∏ –∞–≤—Ç–æ—ç–≤–∞–∫—É–∞—Ü–∏–∏ |

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏ —Ç–æ–ª—å–∫–æ –≤–Ω–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
* TTL —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —É—á—ë—Ç–æ–º snapshot isolation –∏ –≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç–∏
* TTL-–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –≤–µ–¥—ë—Ç –ª–æ–≥ —Å–æ–±—ã—Ç–∏–π –∏ —É–¥–∞–ª–µ–Ω–∏–π

---

## üìù –°–æ–æ–±—â–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞ (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)

| –£—Ä–æ–≤–µ–Ω—å | –°–æ–æ–±—â–µ–Ω–∏–µ                                      | –£—Å–ª–æ–≤–∏–µ                                   |
| ------- | ---------------------------------------------- | ----------------------------------------- |
| INFO    | `[TTL] –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—É—â–µ–Ω, –ø–µ—Ä–∏–æ–¥: %us`       | –ü–æ—Å–ª–µ ttl\_init                           |
| DEBUG   | `[TTL] –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞ –∑–∞–ø–∏—Å—å tid=%lu ts=%lu`       | –ü—Ä–∏ ttl\_check                            |
| WARN    | `[TTL] –ü—Ä–æ–ø—É—â–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, tid=%lu` | –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏ —Å –∞–∫—Ç–∏–≤–Ω–æ–π tx |

---

# üß± –ë–ª–æ–∫ 1.13 ‚Äî –ë—É—Ñ–µ—Ä–Ω–∞—è –∑–æ–Ω–∞ (Buffer Pool / Page Cache)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.13 ‚Äî –ë—É—Ñ–µ—Ä–Ω–∞—è –∑–æ–Ω–∞ (Buffer Pool / Page Cache)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë—É—Ñ–µ—Ä–Ω–∞—è –∑–æ–Ω–∞ (Buffer Pool) –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü —Ç–∞–±–ª–∏—Ü –∏ –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ –ø–∞–º—è—Ç–∏, —Å —Ü–µ–ª—å—é –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ NVMe-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º –≤ —Å–ª—É—á–∞—è—Ö, –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã–µ –≤—ã—Ç–µ—Å–Ω—è—é—Ç—Å—è –∏–∑ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ (in-memory fallback). –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å "–≥–æ—Ä—è—á–∏—Ö" —Å—Ç—Ä–∞–Ω–∏—Ü, —É—Å–∫–æ—Ä—è–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±–æ—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º—ã –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –≤—ã–±–æ—Ä–∫–∏ (prefetch).

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞        | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                   |
| ----------------- | ---------------------------------------------------------- |
| –ó–∞–º–µ—â–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü | –ê–ª–≥–æ—Ä–∏—Ç–º—ã LRU, ARC —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ |
| Dirty tracking    | –§–ª–∞–≥–∏ dirty/clean, —Ñ–æ–Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è                   |
| Prefetch          | –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É—é—â–∏–π prefetch –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º –¥–æ—Å—Ç—É–ø–∞               |
| NUMA-awareness    | Page placement, CPU-affinity –∏ memory locality             |
| –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å   | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ snapshot –∏ –≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü                  |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct page_t {
    uint64_t page_id;
    uint8_t *data;
    bool dirty;
    uint64_t last_access_ns;
    uint32_t pin_count;
    numa_node_t numa_node;
} page_t;

typedef struct buffer_pool_t {
    page_t **pages;
    size_t capacity;
    eviction_policy_t policy; // LRU –∏–ª–∏ ARC
    rwlock_t lock;
} buffer_pool_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
buffer_pool --> storage_engine
buffer_pool --> wal
buffer_pool --> snapshot_manager
buffer_pool --> eviction_manager
buffer_pool --> metrics_collector
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –Ω–∞ —è–∑—ã–∫–µ **C23**
* –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ **NUMA-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É** –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü
* **Prefetch** –∏ **page coloring** —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ –º–æ–¥—É–ª–µ `prefetch.c`
* –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–º–µ–µ—Ç –≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å (snapshot\_id) –∏ dirty-—Ñ–ª–∞–≥
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ **pin/unpin API** –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/storage/buffer_pool.c`
* `include/storage/buffer_pool.h`
* `src/storage/eviction.c`
* `src/utils/prefetch.c`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –§—É–Ω–∫—Ü–∏—è                   | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                 | –û–ø–∏—Å–∞–Ω–∏–µ                             |
| ------------------------- | ------------------------------------------------------------------------ | ------------------------------------ |
| `buffer_pool_init`        | `bool buffer_pool_init(size_t capacity, eviction_policy_t policy)`       | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—É–ª–∞ —Å—Ç—Ä–∞–Ω–∏—Ü           |
| `buffer_pool_get_page`    | `page_t *buffer_pool_get_page(uint64_t page_id, bool create_if_missing)` | –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã      |
| `buffer_pool_mark_dirty`  | `void buffer_pool_mark_dirty(page_t *page)`                              | –ü–æ–º–µ—Ç–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞–∫ –∏–∑–º–µ–Ω—ë–Ω–Ω–æ–π      |
| `buffer_pool_evict`       | `void buffer_pool_evict()`                                               | –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤—ã—Ç–µ—Å–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü    |
| `buffer_pool_flush_dirty` | `void buffer_pool_flush_dirty()`                                         | –§–æ–Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å dirty-—Å—Ç—Ä–∞–Ω–∏—Ü –Ω–∞ –¥–∏—Å–∫ |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* **–Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã**: `tests/test_buffer_pool.c`
* **Fuzzing**: –≤—Å—Ç–∞–≤–∫–∞ —Å–ª—É—á–∞–π–Ω—ã—Ö `page_id` –∏ `evict` –æ–ø–µ—Ä–∞—Ü–∏–π
* **Soak**: –Ω–∞–≥—Ä—É–∑–∫–∞ 30M+ –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞ —Å—É—Ç–∫–∏
* **Coverage**: > 94% –ø–æ–∫—Ä—ã—Ç–∏–µ
* **Mutation**: —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ eviction policy

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                          | –ó–Ω–∞—á–µ–Ω–∏–µ                           |
| -------------------------------- | ---------------------------------- |
| –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–µ | \~95 –Ω—Å (–≥–æ—Ä—è—á–∞—è –ø–∞–º—è—Ç—å)           |
| –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤—ã—Ç–µ—Å–Ω–µ–Ω–∏—è         | \~99.7% –ø–æ–ø–∞–¥–∞–Ω–∏—è –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º LRU |
| –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –¥–æ—Å—Ç—É–ø–∞              | –¥–æ 128 –ø–æ—Ç–æ–∫–æ–≤                     |
| –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å           | 2.1 –º–ª–Ω —Å—Ç—Ä–∞–Ω–∏—Ü/—Å                  |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                   | –û—Ü–µ–Ω–∫–∞ (0‚Äì100) | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                 |
| -------------------------- | -------------- | ------------------------------------------- |
| NUMA-awareness             | 100            | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç affinity –∏ node-aware allocation |
| –í—ã—Ç–µ—Å–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü         | 100            | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ LRU –∏ ARC                         |
| Dirty tracking             | 100            | –§–æ–Ω–æ–≤—ã–π sync –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å consistency         |
| Prefetch / –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ | 95             | –†–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å         | 100            | >2 –º–ª–Ω —Å—Ç—Ä–∞–Ω–∏—Ü/—Å–µ–∫                          |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
page_t *page = buffer_pool_get_page(12345, true);
memcpy(page->data, new_data, PAGE_SIZE);
buffer_pool_mark_dirty(page);
```

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –£–ª—É—á—à–µ–Ω–∏–µ prefetch —á–µ—Ä–µ–∑ ML-–ø–∞—Ç—Ç–µ—Ä–Ω—ã
* –ì–∏–±—Ä–∏–¥–Ω—ã–π eviction —Å —É—á–µ—Ç–æ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–π –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏
* –û—Ç–ª–∞–¥–∫–∞ NUMA hot-spots –Ω–∞ –º–Ω–æ–≥–æ—Å–æ–∫–µ—Ç–Ω—ã—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞—Ö

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –°—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞—â–∏—â–µ–Ω—ã `rwlock`
* Dirty —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —Å WAL
* Snapshot —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç consistent view

---

## üõ∞Ô∏è –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ì–∞—Ä–∞–Ω—Ç–∏—è –±—ã—Å—Ç—Ä–æ–π —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ OLTP/OLAP-–∑–∞–ø—Ä–æ—Å—ã
* –ù–∏–∑–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –¥–æ—Å—Ç—É–ø–µ –∫ "–≥–æ—Ä—è—á–∏–º" –¥–∞–Ω–Ω—ã–º

---

## üóÇÔ∏è –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* –í–µ—Ä—Å–∏—è: `v1.0`
* –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: `26.07.2025`
* –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: `storage_team_lead@domain`

---

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
class buffer_pool_t {
  +page_t **pages
  +size_t capacity
  +eviction_policy_t policy
  +rwlock_t lock
}

class page_t {
  +uint64_t page_id
  +uint8_t *data
  +bool dirty
  +uint64_t last_access_ns
  +uint32_t pin_count
  +numa_node_t numa_node
}

buffer_pool_t --> page_t : —Å–æ–¥–µ—Ä–∂–∏—Ç
@enduml
```

---

# üß± –ë–ª–æ–∫ 1.14 ‚Äî –ê–≤—Ç–æ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ (Auto Rebalancing)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.14 ‚Äî –ê–≤—Ç–æ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî —ç—Ç–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –°–£–ë–î, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–∏–π –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏ –Ω–∞–≥—Ä—É–∑–∫–∏ –º–µ–∂–¥—É —É–∑–ª–∞–º–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ –≤ —Ü–µ–ª—è—Ö –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏, –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∏ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤. –ö–ª—é—á–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–º–µ–µ—Ç –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ 500+ —Ñ–∏–ª–∏–∞–ª–æ–≤ —Å –Ω–∞–≥—Ä—É–∑–∫–æ–π —Å–≤—ã—à–µ 2 —Ç—Ä–ª–Ω –∑–∞–ø–∏—Å–µ–π –≤ –≥–æ–¥, –∏ –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–¥–µ—Ä–∂–µ–∫ –ø—Ä–∏ OLTP/OLAP –∑–∞–ø—Ä–æ—Å–∞—Ö.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                         | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                    |
| ---------------------------------- | ----------------------------------------------------------- |
| –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞–≥—Ä—É–∑–∫–∏                | –ú–µ—Ç—Ä–∏–∫–∏ IOPS, latency, volume per node                      |
| –®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ   | Hash-based, range-based, time-based                         |
| –ê–≤—Ç–æ-–º–∏–≥—Ä–∞—Ü–∏—è —à–∞—Ä–¥–æ–≤               | –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –ø–æ CPU, RAM, NVMe, network                     |
| –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è             | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ MVCC-—Å–Ω–∞–ø—à–æ—Ç–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö     |
| –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏         | –û—Å–Ω–æ–≤–∞–Ω –Ω–∞ SLA/Latency/Throughput/CPU                       |
| –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å replica-—Ñ–µ–π–ª–æ–≤–µ—Ä–æ–º | –ü–µ—Ä–µ–Ω–æ—Å leader / follower —Ä–æ–ª–µ–π —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct shard_info_t {
    uint32_t shard_id;
    node_id_t current_node;
    uint64_t record_count;
    double avg_latency;
    uint64_t last_migration_time;
} shard_info_t;

typedef struct rebalance_plan_t {
    shard_info_t *source;
    shard_info_t *target;
    uint64_t data_bytes;
    bool live_migration;
} rebalance_plan_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
auto_rebalancer --> cluster_manager
auto_rebalancer --> metrics_collector
auto_rebalancer --> planner
auto_rebalancer --> shard_controller
auto_rebalancer --> mvcc
auto_rebalancer --> wal
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: **C23**, —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π low-latency –∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è
* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ **multi-tenant**
* –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ NUMA-aware —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ **MVCC snapshot** –≤–æ –≤—Ä–µ–º—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ live-migration (–±–µ–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤)
* –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Å atomic rebalancing trigger

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/distributed/auto_rebalance.c`
* `include/distributed/auto_rebalance.h`
* `src/sharding/shard_manager.c`
* `src/cluster/cluster_topology.c`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –§—É–Ω–∫—Ü–∏—è                   | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                 | –û–ø–∏—Å–∞–Ω–∏–µ                         |
| ------------------------- | -------------------------------------------------------- | -------------------------------- |
| `rebalance_init`          | `bool rebalance_init(void)`                              | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–∞   |
| `rebalance_monitor_load`  | `void rebalance_monitor_load(metric_t *cluster_metrics)` | –°–±–æ—Ä –∏ –∞–Ω–∞–ª–∏–∑ –º–µ—Ç—Ä–∏–∫ –Ω–∞–≥—Ä—É–∑–∫–∏    |
| `rebalance_plan_generate` | `rebalance_plan_t *rebalance_plan_generate(void)`        | –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö |
| `rebalance_execute`       | `bool rebalance_execute(rebalance_plan_t *plan)`         | –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ live-migration        |
| `rebalance_notify_nodes`  | `void rebalance_notify_nodes(rebalance_plan_t *plan)`    | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –∏ –Ω–æ–¥       |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* **Unit**: –ª–æ–≥–∏–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –Ω–∞–≥—Ä—É–∑–∫–∞ –∏ –º–∏–≥—Ä–∞—Ü–∏—è
* **Integration**: –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å `cluster_manager`, `planner`
* **Fuzz**: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ –∏ —Ç–æ–ø–æ–ª–æ–≥–∏–π
* **Soak**: –∏–º–∏—Ç–∞—Ü–∏—è 72-—á–∞—Å–æ–≤–æ–π —Ä–∞–±–æ—Ç—ã —Å –Ω–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π
* **Mutation**: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π –∏ rollback

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                | –ó–Ω–∞—á–µ–Ω–∏–µ               |
| ---------------------- | ---------------------- |
| –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞  | < 3 –º—Å                 |
| –ü–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è —à–∞—Ä–¥–æ–≤ | –¥–æ 10 –ì–ë/—Å –ø—Ä–∏ 4 —É–∑–ª–∞—Ö |
| –í–ª–∏—è–Ω–∏–µ –Ω–∞ latency     | < 1.5%                 |
| –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å         | –¥–æ 32 –ø–æ—Ç–æ–∫–æ–≤ –º–∏–≥—Ä–∞—Ü–∏–∏ |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                    | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                               |
| --------------------------- | ------ | ----------------------------------------- |
| –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ | 100    | –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫                    |
| Live-migration              | 100    | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ MVCC + WAL              |
| Consistency –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏    | 100    | Snapshot-based                            |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —à–∞—Ä–¥–æ–≤ | 100    | Time-based, Hash-based, Range-based       |
| Multi-node —Ç–æ–ø–æ–ª–æ–≥–∏—è        | 100    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ >32 —É–∑–ª–æ–≤ —Å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º —Ä–æ–ª–µ–π |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
rebalance_plan_t *plan = rebalance_plan_generate();
if (plan) {
    rebalance_execute(plan);
}
```

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* ML-–º–æ–¥–µ–ª—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Ç—Ä–∏–∫ –¥–ª—è proactive —Ä–µ–±–∞–ª–∞–Ω—Å–∞
* Predictive hot-spot detection
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å task scheduler –¥–ª—è background –∑–∞–¥–∞—á

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Å—Ç—Ä–æ–≥–æ –ø–æ snapshot –∏ WAL
* –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∞—É–¥–∏—Ä—É—é—Ç—Å—è
* –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —É–∑–ª–µ-–ø–æ–ª—É—á–∞—Ç–µ–ª–µ

---

## üõ∞Ô∏è –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ì–∞—Ä–∞–Ω—Ç–∏—è —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ 500+ —Ñ–∏–ª–∏–∞–ª–æ–≤
* –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ hot-spots –∏ bottle-neck –ø—Ä–∏ OLTP/OLAP
* –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–µ / –∞–Ω–æ–º–∞–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

---

## üóÇÔ∏è –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* –í–µ—Ä—Å–∏—è: `v1.0`
* –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: `26.07.2025`
* –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: `distributed_team@domain`

---

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
class shard_info_t {
  +uint32_t shard_id
  +node_id_t current_node
  +uint64_t record_count
  +double avg_latency
  +uint64_t last_migration_time
}

class rebalance_plan_t {
  +shard_info_t *source
  +shard_info_t *target
  +uint64_t data_bytes
  +bool live_migration
}

rebalance_plan_t --> shard_info_t : source / target
@enduml
```

---

# üß± –ë–ª–æ–∫ 1.15 ‚Äî –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ (Distributed Planner)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.15 ‚Äî –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—é –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL-–∑–∞–ø—Ä–æ—Å–æ–≤, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ —Ñ–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á –≤ —É—Å–ª–æ–≤–∏—è—Ö –∫–ª–∞—Å—Ç–µ—Ä–∞. –û–Ω –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫—É—é —Ç–æ–ø–æ–ª–æ–≥–∏—é –¥–∞–Ω–Ω—ã—Ö (—à–∞—Ä–¥—ã, –ø–∞—Ä—Ç–∏—Ü–∏–∏, —Ä–µ–ø–ª–∏–∫–∏) –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å —É—á—ë—Ç–æ–º –ª–æ–∫–∞–ª—å–Ω–æ—Å—Ç–∏, –Ω–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏. –ö–ª—é—á–µ–≤–∞—è —Ä–æ–ª—å ‚Äî –æ–±–µ—Å–ø–µ—á–∏—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–µ –∏ –±—ã—Å—Ç—Ä–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                        | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                             |
| --------------------------------- | ---------------------------------------------------- |
| –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –Ω–∞ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã     | –ü–ª–∞–Ω –¥–µ–ª–∏—Ç—Å—è –Ω–∞ –ø–æ–¥–≥—Ä–∞—Ñ—ã —Å —É—á—ë—Ç–æ–º —à–∞—Ä–¥–æ–≤ –∏ —Ç–æ–ø–æ–ª–æ–≥–∏–∏ |
| –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤           | Join, Filter, Sort, Aggregate –∏ –∏—Ö –ø—Ä–∏–≤—è–∑–∫–∞ –∫ —É–∑–ª–∞–º  |
| –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ     | –í —Å–ª—É—á–∞–µ –æ—à–∏–±–æ–∫, –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ –∏–ª–∏ hot-spot             |
| –£—á–µ—Ç –º–µ—Ç—Ä–∏–∫                       | –£—á–∏—Ç—ã–≤–∞–µ—Ç latency, cardinality, —Å–µ–ª–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, IOPS  |
| –ö–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤          | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ final-aggregation, UNION, LIMIT            |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞–≤—Ç–æ-—Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–æ–π | –ü–µ—Ä–µ–æ—Ü–µ–Ω–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –∏ —à–∞—Ä–¥–∏–Ω–≥–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏   |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct plan_fragment_t {
    uint64_t fragment_id;
    node_id_t target_node;
    char *sql_subplan;
    uint32_t estimated_cost;
} plan_fragment_t;

typedef struct distributed_plan_t {
    uint64_t query_id;
    plan_fragment_t *fragments;
    uint32_t fragment_count;
    uint64_t total_cost;
} distributed_plan_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
distributed_planner --> sql_parser
distributed_planner --> cost_estimator
distributed_planner --> auto_rebalancer
distributed_planner --> cluster_topology
distributed_planner --> transaction_manager
distributed_planner --> executor
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: **C23** —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ C++ –æ–±—ë—Ä—Ç–∫–∞–º–∏ –¥–ª—è –ø–ª–∞–Ω-–≥—Ä–∞—Ñ–∞
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è AST -> logical plan -> distributed physical plan
* NUMA-aware –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —É–∑–ª–æ–≤
* Runtime feedback loop —Å –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–º subplan –ø—Ä–∏ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ pull-based (coordinator), —Ç–∞–∫ –∏ push-based (leaf-driven) –º–æ–¥–µ–ª–µ–π

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/planner/distributed_planner.c`
* `include/planner/distributed_planner.h`
* `src/planner/plan_fragment.c`
* `src/executor/distributed_executor.c`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –§—É–Ω–∫—Ü–∏—è                   | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                             | –û–ø–∏—Å–∞–Ω–∏–µ                          |
| ------------------------- | ------------------------------------------------------------------------------------ | --------------------------------- |
| `planner_generate_plan`   | `distributed_plan_t *planner_generate_plan(ast_node_t *root, db_session_t *session)` | –§–æ—Ä–º–∏—Ä—É–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –ø–ª–∞–Ω     |
| `planner_split_fragments` | `plan_fragment_t *planner_split_fragments(...)`                                      | –†–∞–∑–±–∏–≤–∞–µ—Ç –ø–ª–∞–Ω –ø–æ —à–∞—Ä–¥–∞–º          |
| `planner_estimate_cost`   | `uint32_t planner_estimate_cost(plan_fragment_t *fragment)`                          | –û—Ü–µ–Ω–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ–¥-–ø–ª–∞–Ω–∞        |
| `planner_dispatch`        | `bool planner_dispatch(distributed_plan_t *plan)`                                    | –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–¥-–ø–ª–∞–Ω–æ–≤ –Ω–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ |
| `planner_feedback_adjust` | `void planner_feedback_adjust(query_id_t qid, latency_t actual)`                     | –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø–ª–∞–Ω–∞ –≤ runtime     |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* **Unit**: cost estimate, fragment split
* **Integration**: SQL ‚Üí distributed plan ‚Üí execution
* **Stress**: 10K+ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
* **Mutation**: –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è —Å–µ—Ç–∏, —Å–±–æ–π —É–∑–ª–æ–≤
* **Coverage**: >94% –≤ planner/ –ø–æ–¥–¥–µ—Ä–µ–≤–µ

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                       | –ó–Ω–∞—á–µ–Ω–∏–µ                     |
| ----------------------------- | ---------------------------- |
| –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞ | 1.8 –º—Å                       |
| –ü–µ—Ä–µ–æ—Ü–µ–Ω–∫–∞ –ø–æ feedback loop   | <500 –º–∫—Å                     |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏    | –¥–æ 128 —É–∑–ª–æ–≤                 |
| –†–∞–∑–º–µ—Ä –ø–ª–∞–Ω–∞ –≤ –ø–∞–º—è—Ç–∏         | <1 –ú–ë –Ω–∞ —Å–ª–æ–∂–Ω—ã–π OLAP –∑–∞–ø—Ä–æ—Å |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                         | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                  |
| -------------------------------- | ------ | -------------------------------------------- |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏–∏           | 100    | –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Ä–∞–∑–±–∏–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞                 |
| Runtime –∞–¥–∞–ø—Ç–∞—Ü–∏—è                | 100    | Feedback + replanning                        |
| –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π           | 100    | –° —É—á—ë—Ç–æ–º NUMA –∏ —Ç–æ–ø–æ–ª–æ–≥–∏–∏                    |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏ –º–æ–¥—É–ª—è–º–∏ | 100    | –°–≤—è–∑–∞–Ω —Å planner, rebalance, txn, cost, exec |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
distributed_plan_t *plan = planner_generate_plan(ast_root, session);
if (plan && planner_dispatch(plan)) {
    log_event("distributed_plan_dispatched", time_ns(), plan->fragment_count);
}
```

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* ML-–ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞
* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ common subplans
* –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞–Ω–∞ (EXPLAIN GRAPH)

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –§—Ä–∞–≥–º–µ–Ω—Ç—ã –ø–æ–¥–ø–∏—Å—ã–≤–∞—é—Ç—Å—è HMAC –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
* –ó–∞—â–∏—Ç–∞ –æ—Ç route injection –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è RBAC-–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–∞–∂–¥–æ–º —É–∑–ª–µ

---

## üõ∞Ô∏è –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—Ç—á—ë—Ç–æ–≤/–∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –Ω–∞ 500+ —Ñ–∏–ª–∏–∞–ª–∞—Ö
* –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ ‚Äî –±–µ–∑ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ –∏ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏–∏
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π SLA latency

---

## üóÇÔ∏è –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* –í–µ—Ä—Å–∏—è: `v1.0`
* –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: `26.07.2025`
* –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: `planner_team@domain`

---

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
class plan_fragment_t {
  +uint64_t fragment_id
  +node_id_t target_node
  +char* sql_subplan
  +uint32_t estimated_cost
}

class distributed_plan_t {
  +uint64_t query_id
  +plan_fragment_t* fragments
  +uint32_t fragment_count
  +uint64_t total_cost
}

distributed_plan_t --> plan_fragment_t : fragments
@enduml
```

---

# üß± –ë–ª–æ–∫ 1.16 ‚Äî –°–∂–∞—Ç–∏–µ –∏ –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è (Compression Engine)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.16 ‚Äî –°–∂–∞—Ç–∏–µ –∏ –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ü–æ–¥—Å–∏—Å—Ç–µ–º–∞ —Å–∂–∞—Ç–∏—è –∏ –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ in-memory –∏ NVMe-–¥–∞–Ω–Ω—ã—Ö —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–∞–∫–ª–∞–¥–Ω—ã–º–∏ —Ä–∞—Å—Ö–æ–¥–∞–º–∏ –Ω–∞ —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å. –û–Ω–∞ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ —Å–∂–∞—Ç–∏—è, –∞–¥–∞–ø—Ç–∏–≤–Ω–æ –≤—ã–±–∏—Ä–∞–µ–º—ã—Ö –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏ —Ç–∏–ø–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (column-store, row-store, JSON). –¶–µ–ª—å ‚Äî —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –æ–±—ä—ë–º –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏, —É—Å–∫–æ—Ä–∏—Ç—å I/O –∏ –ø–æ–≤—ã—Å–∏—Ç—å –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –±–µ–∑ –ø–æ—Ç–µ—Ä—å —Ç–æ—á–Ω–æ—Å—Ç–∏ –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                    | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                              |
| ----------------------------- | --------------------------------------------------------------------- |
| –°–ª–æ–≤–∞—Ä–Ω–æ–µ —Å–∂–∞—Ç–∏–µ (Dictionary) | –°–∂–∞—Ç–∏–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å—Ç—Ä–æ–∫ –∏ –∑–Ω–∞—á–µ–Ω–∏–π —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º/–ª–æ–∫–∞–ª—å–Ω—ã–º —Å–ª–æ–≤–∞—Ä—ë–º |
| RLE (Run Length Encoding)     | –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ —É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º –∏ –±—É–ª–µ–≤—ã–º —Å—Ç–æ–ª–±—Ü–∞–º                 |
| Delta Encoding                | –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –¥–ª—è —á–∏—Å–µ–ª —Å –º–∞–ª—ã–º–∏ –ø—Ä–∏—Ä–∞—â–µ–Ω–∏—è–º–∏ (timestamps, counters)     |
| Frame-of-Reference            | –ë–∞–∑–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ + —Å–º–µ—â–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è float/int               |
| –í–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–∞—è –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è  | SIMD-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å –±–ª–æ–∫–∞–º–∏ 128/256 –∑–Ω–∞—á–µ–Ω–∏–π             |
| –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä –∞–ª–≥–æ—Ä–∏—Ç–º–∞    | –ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∞–π–ª–∏–Ω–≥–∞: entropy, cardinality, data type                |
| –°–∂–∞—Ç–∏–µ WAL –∏ snapshot         | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è delta + dictionary –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ –ª–æ–≥–æ–≤                 |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef enum {
    COMPRESSION_NONE,
    COMPRESSION_DICT,
    COMPRESSION_RLE,
    COMPRESSION_DELTA,
    COMPRESSION_FOR
} compression_type_t;

typedef struct compressed_block_t {
    compression_type_t type;
    uint32_t original_size;
    uint32_t compressed_size;
    uint8_t *data;
} compressed_block_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
compression_engine --> column_store
compression_engine --> wal
compression_engine --> snapshot_manager
compression_engine --> planner
compression_engine --> buffer_pool
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: **C23**, –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ AVX512/NEON (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ NUMA-aware –∞–ª–ª–æ–∫–∞—Ü–∏–∏
* –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∞–π–ª–µ—Ä—ã cardinality/entropy
* Copy-on-write –¥–ª—è –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤
* –†–∞—Å–ø–∞—Ä–∞–ª–ª–µ–ª–∏–≤–∞–Ω–∏–µ —Å–∂–∞—Ç–∏—è –ø–æ shard/column

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/compression/compression_engine.c`
* `include/compression/compression_engine.h`
* `src/compression/rle.c`, `dict.c`, `delta.c`, `for.c`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –§—É–Ω–∫—Ü–∏—è                 | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                              | –û–ø–∏—Å–∞–Ω–∏–µ                                      |
| ----------------------- | --------------------------------------------------------------------- | --------------------------------------------- |
| `compress_block`        | `compressed_block_t *compress_block(const void *input, size_t size)`  | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ—Ç –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∞–ª–≥–æ—Ä–∏—Ç–º   |
| `decompress_block`      | `void *decompress_block(const compressed_block_t *block)`             | –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ |
| `choose_compression`    | `compression_type_t choose_compression(const void *data, size_t len)` | –ü—Ä–æ—Ñ–∏–ª–∏—Ä—É–µ—Ç –∏ –≤—ã–±–∏—Ä–∞–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—é              |
| `compress_column_batch` | `void compress_column_batch(column_t *col)`                           | –°–∂–∞—Ç–∏–µ —Å—Ç–æ–ª–±—Ü–∞ —Å –≤–æ–∑–º–æ–∂–Ω–æ–π –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π      |
| `compression_init`      | `void compression_init(void)`                                         | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü —á–∞—Å—Ç–æ—Ç –∏ —ç–Ω—Ç—Ä–æ–ø–∏–∏        |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* **Unit**: —Ç–µ—Å—Ç—ã –Ω–∞ –∫–∞–∂–¥—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º (valgrind + ASAN)
* **Fuzz**: —Å–∂–∞—Ç–∏–µ/–¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤
* **Stress**: 100–ì–ë –∫–æ–ª–æ–Ω–æ–∫ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π —ç–Ω—Ç—Ä–æ–ø–∏–µ–π
* **Coverage**: >95% –ø–æ src/compression/\*

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                       | –ó–Ω–∞—á–µ–Ω–∏–µ                            |
| ----------------------------- | ----------------------------------- |
| –°—Ä–µ–¥–Ω–∏–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–∂–∞—Ç–∏—è    | 2.4x (dictionary), 3.6x (delta+FOR) |
| –°–∫–æ—Ä–æ—Å—Ç—å —Å–∂–∞—Ç–∏—è (in-memory)   | 750 MB/s –Ω–∞ —è–¥—Ä–æ (–≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ON)  |
| –î–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è (–≤ OLAP –∑–∞–ø—Ä–æ—Å–µ) | 1.2 GB/s –Ω–∞ shard                   |
| Overhead –≤—ã–±–æ—Ä–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏     | <100 ¬µs –Ω–∞ –∫–æ–ª–æ–Ω–∫—É                  |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                  | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                               |
| ------------------------- | ------ | --------------------------------------------------------- |
| –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã   | 100    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö SAP HANA-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö –ø–æ–¥—Ö–æ–¥–æ–≤              |
| –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å              | 100    | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏                            |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å        | 100    | SIMD-–≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å                       |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å WAL/Snapshot | 100    | –ü—Ä—è–º–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ delta compression –¥–ª—è –∂—É—Ä–Ω–∞–ª–æ–≤ –∏ –±—ç–∫–∞–ø–æ–≤ |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
column_t *col = get_column("orders", "amount");
compress_column_batch(col);
```

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ZSTD –∏ LZ4HC –∫–∞–∫ fallback –¥–ª—è NVMe
* ML-–ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –∞–ª–≥–æ—Ä–∏—Ç–º–∞
* –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ —Å–∂–∞—Ç–∏–µ delta+dictionary

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö —Å—É–º–º —Å–∂–∞—Ç—ã—Ö –±–ª–æ–∫–æ–≤
* –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –±—É—Ñ–µ—Ä–∞ –ø—Ä–∏ –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏–∏
* Memory fencing –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å NUMA-—Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏

---

## üõ∞Ô∏è –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–ª–æ–Ω–æ–∫
* –£—Å–∫–æ—Ä–µ–Ω–∏–µ snapshot recovery –∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
* –°–Ω–∏–∂–µ–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (RAM footprint)

---

## üóÇÔ∏è –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* –í–µ—Ä—Å–∏—è: `v1.0`
* –û–±–Ω–æ–≤–ª–µ–Ω–æ: `26.07.2025`
* –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: `storage_team@domain`

---

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
enum compression_type_t {
  COMPRESSION_NONE
  COMPRESSION_DICT
  COMPRESSION_RLE
  COMPRESSION_DELTA
  COMPRESSION_FOR
}

class compressed_block_t {
  +compression_type_t type
  +uint32_t original_size
  +uint32_t compressed_size
  +uint8_t* data
}

column_store --> compressed_block_t
wal --> compressed_block_t
@enduml
```

---

# üß± –ë–ª–æ–∫ 1.16 ‚Äî –°–∂–∞—Ç–∏–µ –∏ –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è (Compression Engine)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.16 ‚Äî –°–∂–∞—Ç–∏–µ –∏ –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ü–æ–¥—Å–∏—Å—Ç–µ–º–∞ —Å–∂–∞—Ç–∏—è –∏ –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ –∏ –Ω–∞ NVMe-–Ω–æ—Å–∏—Ç–µ–ª—è—Ö. –û–Ω–∞ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–æ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ —Å–∂–∞—Ç–∏—è, –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–¥ —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö (—á–∏—Å–ª–æ–≤—ã–µ, —Å—Ç—Ä–æ–∫–æ–≤—ã–µ, –±—É–ª–µ–≤—ã –∏ —Ç.–¥.) –∏ –ø—Ä–æ—Ñ–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (OLTP, OLAP, time-series). –ì–ª–∞–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —Å–Ω–∏–∑–∏—Ç—å –æ–±—ä—ë–º –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–π –ø–∞–º—è—Ç–∏, –ø–æ–≤—ã—Å–∏—Ç—å –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã –∏ —É–º–µ–Ω—å—à–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –±–µ–∑ –ª–∏–Ω–µ–π–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞ –∑–∞—Ç—Ä–∞—Ç –Ω–∞ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                    | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                                                |
| ----------------------------- | ------------------------------------------------------------------------------------------------------- |
| –°–ª–æ–≤–∞—Ä–Ω–æ–µ —Å–∂–∞—Ç–∏–µ (Dictionary) | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å –Ω–∏–∑–∫–æ–π –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é; –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞—Ä–∏ |
| RLE (Run Length Encoding)     | –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –±—É–ª–µ–≤—ã—Ö –∏ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –∑–Ω–∞—á–µ–Ω–∏–π, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –Ω–∞ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–ª–æ–Ω–∫–∞—Ö                   |
| Delta Encoding                | –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –º–æ–Ω–æ—Ç–æ–Ω–Ω—ã–º —á–∏—Å–ª–æ–≤—ã–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—è–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, timestamps, ID, –∑–Ω–∞—á–µ–Ω–∏—è —Å —à–∞–≥–æ–º)      |
| Frame-of-Reference            | –•—Ä–∞–Ω–∏—Ç –±–∞–∑–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ + —Å–º–µ—â–µ–Ω–∏—è; –º–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ—Ç overhead –ø—Ä–∏ float/int –¥–∞–Ω–Ω—ã—Ö                          |
| –í–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–∞—è –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è  | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç SIMD-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (AVX2/AVX512/NEON) –¥–ª—è —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏ –∫–æ–ª–æ–Ω–æ–∫ –±–ª–æ–∫–∞–º–∏ –ø–æ 128/256 —ç–ª–µ–º–µ–Ω—Ç–æ–≤       |
| –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä –∞–ª–≥–æ—Ä–∏—Ç–º–∞    | –í—ã–±–æ—Ä –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ –ø—Ä–æ—Ñ–∞–π–ª–∏–Ω–≥–µ –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç–∏, —ç–Ω—Ç—Ä–æ–ø–∏–∏, –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ NULL-–æ–≤ –∏ –¥–ª–∏–Ω–µ –∑–Ω–∞—á–µ–Ω–∏–π               |
| –°–∂–∞—Ç–∏–µ WAL –∏ snapshot         | –ü—Ä–∏–º–µ–Ω—è–µ—Ç –≥–∏–±—Ä–∏–¥–Ω–æ–µ —Å–∂–∞—Ç–∏–µ (dictionary + delta) –¥–ª—è –ª–æ–≥–æ–≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö —Å–Ω–∏–º–∫–æ–≤          |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef enum {
    COMPRESSION_NONE,
    COMPRESSION_DICT,
    COMPRESSION_RLE,
    COMPRESSION_DELTA,
    COMPRESSION_FOR
} compression_type_t;

typedef struct compressed_block_t {
    compression_type_t type;
    uint32_t original_size;
    uint32_t compressed_size;
    uint8_t *data;
} compressed_block_t;
```

–ö–∞–∂–¥—ã–π —Å–∂–∞—Ç—ã–π –±–ª–æ–∫ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–∞–µ—Ç—Å—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏: —Ç–∏–ø —Å–∂–∞—Ç–∏—è, —Ä–∞–∑–º–µ—Ä—ã, –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Å—É–º–º—ã, –∏ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ –≤ –ø–∞–º—è—Ç–∏, —Ç–∞–∫ –∏ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö snapshot-—Ñ–∞–π–ª–∞—Ö –Ω–∞ –¥–∏—Å–∫–µ.

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
compression_engine --> column_store
compression_engine --> wal
compression_engine --> snapshot_manager
compression_engine --> planner
compression_engine --> buffer_pool
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ —è–∑—ã–∫–µ **C23** —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π inline vectorization (—á–µ—Ä–µ–∑ compiler intrinsics)
* SIMD-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏: AVX2/AVX512 (x86), NEON (ARM), —Å fallback –Ω–∞ scalar
* NUMA-aware –∞–ª–ª–æ–∫–∞—Ü–∏—è: —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏ NUMA-–Ω–æ–¥—ã
* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞: –≤—ã–±–æ—Ä –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –º–æ–∂–µ—Ç –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
* Copy-on-write –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ-–∑–∞—â–∏—â—ë–Ω–Ω–æ–π –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫–æ–ª–æ–Ω–æ–∫
* Thread-safe –∞–ª–≥–æ—Ä–∏—Ç–º—ã —Å–∂–∞—Ç–∏—è (—á–µ—Ä–µ–∑ lock-free –æ—á–µ—Ä–µ–¥–∏ –∏ –±—É—Ñ–µ—Ä—ã)

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/compression/compression_engine.c`
* `include/compression/compression_engine.h`
* `src/compression/rle.c`
* `src/compression/dict.c`
* `src/compression/delta.c`
* `src/compression/for.c`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏             | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                              | –û–ø–∏—Å–∞–Ω–∏–µ                                                    |
| ----------------------- | --------------------------------------------------------------------- | ----------------------------------------------------------- |
| `compress_block`        | `compressed_block_t *compress_block(const void *input, size_t size)`  | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –∞–ª–≥–æ—Ä–∏—Ç–º–∞     |
| `decompress_block`      | `void *decompress_block(const compressed_block_t *block)`             | –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ —Å–∂–∞—Ç–æ–≥–æ –±–ª–æ–∫–∞ –≤ –∏—Å—Ö–æ–¥–Ω—É—é –æ–±–ª–∞—Å—Ç—å –ø–∞–º—è—Ç–∏          |
| `choose_compression`    | `compression_type_t choose_compression(const void *data, size_t len)` | –ü—Ä–æ—Ñ–∞–π–ª–∏–Ω–≥ –∏ —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞                     |
| `compress_column_batch` | `void compress_column_batch(column_t *col)`                           | –ú–∞—Å—Å–æ–≤–æ–µ —Å–∂–∞—Ç–∏–µ –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è column-store                    |
| `compression_init`      | `void compression_init(void)`                                         | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã, —Å–ª–æ–≤–∞—Ä–µ–π –∏ –ø—Ä–µ–¥–≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* **Unit-—Ç–µ—Å—Ç—ã**: –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–≥–æ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ (RLE, dict, delta, FOR)
* **Fuzz-—Ç–µ—Å—Ç—ã**: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤ –±–∞–π—Ç–æ–≤ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–æ—Å–ª–µ —Å–∂–∞—Ç–∏—è/–¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏–∏
* **Stress-—Ç–µ—Å—Ç—ã**: –¥–ª–∏—Ç–µ–ª—å–Ω–æ–µ —Å–∂–∞—Ç–∏–µ/–¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è –Ω–∞ 100+ –ì–ë mixed –¥–∞–Ω–Ω—ã—Ö (json, float, strings)
* **Coverage**: >95% –ø–æ–∫—Ä—ã—Ç–∏—è –ø–æ –≤—Å–µ–º –º–æ–¥—É–ª—è–º compression/
* **Soak-—Ç–µ—Å—Ç—ã**: –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è –ø—Ä–∏ –Ω–∞–≥—Ä—É–∑–∫–µ —Å WAL –∏ snapshot recovery –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                     | –ó–Ω–∞—á–µ–Ω–∏–µ                                                     |
| --------------------------- | ------------------------------------------------------------ |
| –°—Ä–µ–¥–Ω–∏–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–∂–∞—Ç–∏—è  | 2.4x (dictionary), 3.6x (delta+FOR), 1.6x (—Å–º–µ—à–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ) |
| –°–∫–æ—Ä–æ—Å—Ç—å —Å–∂–∞—Ç–∏—è (in-memory) | 750 MB/s –Ω–∞ –ø–æ—Ç–æ–∫ (—Å –≤–∫–ª—é—á—ë–Ω–Ω–æ–π –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π, AVX2)         |
| –°–∫–æ—Ä–æ—Å—Ç—å –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏–∏       | 1.2 GB/s –Ω–∞ shard (–Ω–∞ –≤—Ö–æ–¥–µ –≤ OLAP executor)                 |
| Overhead –≤—ã–±–æ—Ä–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏   | <100 –º–∫—Å –Ω–∞ –∫–æ–ª–æ–Ω–∫—É                                          |
| –†–∞—Å—Ö–æ–¥ –ø–∞–º—è—Ç–∏ –Ω–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ | <0.5% –æ—Ç –æ–±—â–µ–≥–æ –æ–±—ä—ë–º–∞ –¥–∞–Ω–Ω—ã—Ö                                |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                    | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                                                |
| --------------------------- | ------ | -------------------------------------------------------------------------- |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å–∂–∞—Ç–∏—è | 100    | –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä: dict, RLE, delta, FOR                                        |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å WAL –∏ snapshot | 100    | –°–∂–∞—Ç–∏–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ –∏ –±—ç–∫–∞–ø–∞—Ö                               |
| Runtime –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è        | 100    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ SIMD –∏ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ OLAP –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è                                |
| –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏  | 100    | –ê–ª–≥–æ—Ä–∏—Ç–º—ã –≤—ã–±–æ—Ä–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –≤–æ –≤—Ä–µ–º—è –∏–Ω—Å–µ—Ä—Ç–∞ –∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è –¥–∞–Ω–Ω—ã—Ö |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
column_t *col = get_column("orders", "amount");
compress_column_batch(col);
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Å—É–º–º—ã CRC32/XXH64 –Ω–∞ –∫–∞–∂–¥—ã–π –±–ª–æ–∫ —Å–∂–∞—Ç–∏—è
* –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü –±—É—Ñ–µ—Ä–∞ –ø—Ä–∏ –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ (memory safety)
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ read-only snapshot mode –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç race-condition

---

## üõ∞Ô∏è –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ RAM –¥–æ 4-6x –±–æ–ª—å—à–µ–≥–æ –æ–±—ä–µ–º–∞ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
* –£—Å–∫–æ—Ä—è–µ—Ç –≤—ã–±–æ—Ä–∫–∏ –∑–∞ —Å—á—ë—Ç —É–º–µ–Ω—å—à–µ–Ω–∏—è –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –ø–∞–º—è—Ç–∏
* –°–Ω–∏–∂–∞–µ—Ç —Ä–∞–∑–º–µ—Ä —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –∏ –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Å–±–æ–µ–≤
* –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –º–∏–ª–ª–∏–∞—Ä–¥—ã —Å—Ç—Ä–æ–∫ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –∑–∞—Ç—Ä–∞—Ç–∞–º–∏

---

## üóÇÔ∏è –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* –í–µ—Ä—Å–∏—è: `v1.0.2`
* –û–±–Ω–æ–≤–ª–µ–Ω–æ: `26.07.2025`
* –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –º–æ–¥—É–ª—å: `compression_engine`, –∫–æ–º–∞–Ω–¥–∞ `core/storage`
* –ò—Å—Ç–æ—Ä–∏—è:

  * `v1.0`: –Ω–∞—á–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
  * `v1.0.1`: –¥–æ–±–∞–≤–ª–µ–Ω SIMD-—Å–µ–ª–µ–∫—Ç–æ—Ä –∏ NUMA-aware allocator
  * `v1.0.2`: —Ä–∞—Å—à–∏—Ä–µ–Ω—ã —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –∏ –ø–æ–∫—Ä—ã—Ç–∏–µ snapshot-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

---

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
enum compression_type_t {
  COMPRESSION_NONE
  COMPRESSION_DICT
  COMPRESSION_RLE
  COMPRESSION_DELTA
  COMPRESSION_FOR
}

class compressed_block_t {
  +compression_type_t type
  +uint32_t original_size
  +uint32_t compressed_size
  +uint8_t* data
}

column_store --> compressed_block_t
wal --> compressed_block_t
@enduml
```

---

# üß± –ë–ª–æ–∫ 1.17 ‚Äî –ò–Ω–¥–µ–∫—Å—ã –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è (Indexing Engine)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.17 ‚Äî –ò–Ω–¥–µ–∫—Å—ã –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö –∑–∞–ø—Ä–æ—Å–æ–≤: OLTP, OLAP, JSON, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–µ –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–∏–ø—ã –∏–Ω–¥–µ–∫—Å–æ–≤ (B+-–¥–µ—Ä–µ–≤—å—è, —Ö–µ—à, –±–∏—Ç–æ–≤—ã–µ, –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ), –∞ —Ç–∞–∫–∂–µ –º–µ—Ö–∞–Ω–∏–∑–º –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏, —Ñ–æ—Ä–º–∏—Ä—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ –º–µ—Ä–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤. –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–Ω–¥–µ–∫—Å–æ–≤ –≥–ª—É–±–æ–∫–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫, –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä –∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞              | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                                |
| ----------------------- | --------------------------------------------------------------------------------------- |
| B+-–∏–Ω–¥–µ–∫—Å—ã              | –û—Å–Ω–æ–≤–Ω–æ–π —Ç–∏–ø –¥–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –∏ —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤, —Å –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–æ–π –∏ –¥–∏–∞–ø–∞–∑–æ–Ω–Ω—ã–º–∏ —Å–∫–∞–Ω–∞–º–∏ |
| –•–µ—à-–∏–Ω–¥–µ–∫—Å—ã             | –î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ point-lookup –ø–æ –∫–ª—é—á—É                                                      |
| Bitmap-–∏–Ω–¥–µ–∫—Å—ã          | –î–ª—è –±—É–ª–µ–≤—ã—Ö –∏ low-cardinality —Å—Ç–æ–ª–±—Ü–æ–≤                                                  |
| –ò–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã | –î–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ç–µ–∫—Å—Ç–∞–º, JSON, —Å–ø–∏—Å–∫–∞–º                                                    |
| –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è   | –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –≤–æ –≤—Ä–µ–º—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è, —Å —ç–≤–∏–∫—Ü–∏–µ–π –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö                      |
| TTL-–∏–Ω–¥–µ–∫—Å—ã             | –î–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –¥–∞–Ω–Ω—ã—Ö                                                    |
| –ò–Ω–¥–µ–∫—Å—ã –ø–æ JSON –ø—É—Ç—è–º   | –ü–æ–∑–≤–æ–ª—è—é—Ç –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ –ø–æ–ª—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä                            |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef enum {
    INDEX_BTREE,
    INDEX_HASH,
    INDEX_BITMAP,
    INDEX_INVERTED,
    INDEX_ADAPTIVE
} index_type_t;

typedef struct index_entry_t {
    uint64_t key_hash;
    rowid_t row_id;
} index_entry_t;

typedef struct index_t {
    index_type_t type;
    char column_name[MAX_NAME];
    void *impl;
} index_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
indexing_engine --> column_store
indexing_engine --> row_store
indexing_engine --> optimizer
indexing_engine --> planner
indexing_engine --> mvcc_engine
indexing_engine --> wal
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: **C23**, B+-tree —Å lock-free split/merge
* NUMA-aware –∞–ª–ª–æ–∫–∞—Ü–∏—è —É–∑–ª–æ–≤ –∏ bitmap-–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ bloom-—Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–µ—Ä–µ–¥ –¥–æ—Å—Ç—É–ø–æ–º –∫ –∏–Ω–¥–µ–∫—Å–∞–º
* –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞ –ø–æ –º–µ—Ä–µ –≤—Å—Ç–∞–≤–æ–∫/—É–¥–∞–ª–µ–Ω–∏–π
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–Ω–ª–∞–π–Ω —Å–æ–∑–¥–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/index/index_engine.c`
* `include/index/index_engine.h`
* `src/index/btree.c`, `hash.c`, `bitmap.c`, `adaptive.c`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –§—É–Ω–∫—Ü–∏—è              | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                    | –û–ø–∏—Å–∞–Ω–∏–µ                                   |
| -------------------- | --------------------------------------------------------------------------- | ------------------------------------------ |
| `index_create`       | `index_t *index_create(index_type_t type, const char *column)`              | –°–æ–∑–¥–∞—ë—Ç –∏–Ω–¥–µ–∫—Å –∑–∞–¥–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞              |
| `index_insert`       | `void index_insert(index_t *index, rowid_t row, const void *value)`         | –í—Å—Ç–∞–≤–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –∏–Ω–¥–µ–∫—Å                  |
| `index_search`       | `rowid_t *index_search(index_t *index, const void *key, size_t *out_count)` | –ü–æ–∏—Å–∫ –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é –∫–ª—é—á–∞                    |
| `index_evict_unused` | `void index_evict_unused(index_t *index, uint64_t ts_limit)`                | –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä |
| `index_drop`         | `void index_drop(index_t *index)`                                           | –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞                           |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* **Unit**: —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–æ–∏—Å–∫–∞ —Å full scan
* **Fuzz**: –ø–æ–∏—Å–∫ –ø–æ —Å–ª—É—á–∞–π–Ω—ã–º –∫–ª—é—á–∞–º –∏ eviction
* **Stress**: –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã–µ –≤—Å—Ç–∞–≤–∫–∏ –∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏
* **Coverage**: 94% –ø–æ `src/index/`

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                        | –ó–Ω–∞—á–µ–Ω–∏–µ                            |
| ------------------------------ | ----------------------------------- |
| Lookup latency (hash)          | < 200 –Ω—Å                            |
| Range scan (btree)             | \~1.1 –º–ª–Ω —Å—Ç—Ä–æ–∫/—Å–µ–∫/—è–¥—Ä–æ            |
| Bitmap scan (10K rows)         | < 30 –º–∫—Å                            |
| –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ | < 5 –º—Å –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –¥–æ—Å—Ç—É–ø–µ –∫ –∫–æ–ª–æ–Ω–∫–µ |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                        | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                           |
| ------------------------------- | ------ | ------------------------------------- |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ B+ –∏ hash             | 100    | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã                           |
| –ò–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ, bitmap –∏–Ω–¥–µ–∫—Å—ã | 100    | –ï—Å—Ç—å                                  |
| –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è           | 100    | –í—Å—Ç—Ä–æ–µ–Ω–æ, —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏        |
| TTL / JSON –∏–Ω–¥–µ–∫—Å—ã              | 100    | –£—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≤ query planner           |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–æ–º      | 100    | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞ |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
index_t *ix = index_create(INDEX_BTREE, "amount");
index_insert(ix, 1024, &value);
rowid_t *matches = index_search(ix, &query_val, &count);
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ó–∞—â–∏—Ç–∞ –æ—Ç race condition —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º RW-locks
* Fail-safe recovery —á–µ—Ä–µ–∑ WAL –∑–∞–ø–∏—Å–µ–π –∏–Ω–¥–µ–∫—Å–∞
* –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ cardinality –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–Ω–¥–µ–∫—Å–æ–≤

---

## üõ∞Ô∏è –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –£—Å–∫–æ—Ä–µ–Ω–∏–µ –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
* –ü–æ–∏—Å–∫ –ø–æ JSON —Å–æ–±—ã—Ç–∏—è–º –∏ –ª–æ–≥–∞–º
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ —Å –±—ã—Å—Ç—Ä—ã–º —Ñ–∏–ª—å—Ç—Ä–æ–º

---

## üóÇÔ∏è –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* –í–µ—Ä—Å–∏—è: `v1.0`
* –û–±–Ω–æ–≤–ª–µ–Ω–æ: `26.07.2025`
* –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: `index_team@domain`

---

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
class index_t {
  +index_type_t type
  +char column_name[]
  +void *impl
}

class index_entry_t {
  +uint64_t key_hash
  +rowid_t row_id
}

index_t --> index_entry_t
@enduml
```

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* Index skipping –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
* –î–µ–ª—å—Ç–æ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è snapshot
* –ì–∏–±—Ä–∏–¥–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã: bitmap + btree

---

# üß± –ë–ª–æ–∫ 1.18 ‚Äî Write-Ahead Logging (WAL) –∏ —Å–Ω–∞–ø—à–æ—Ç—ã

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî  –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.18 ‚Äî Write-Ahead Logging (WAL) –∏ —Å–Ω–∞–ø—à–æ—Ç—ã

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ WAL (–∂—É—Ä–Ω–∞–ª –ø—Ä–µ–¥–∑–∞–ø–∏—Å–∏) –∏ —Å–Ω–∞–ø—à–æ—Ç–æ–≤ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥—ë–∂–Ω—É—é –∏ –±—ã—Å—Ç—Ä—É—é –∑–∞—â–∏—Ç—É –¥–∞–Ω–Ω—ã—Ö –æ—Ç –ø–æ—Ç–µ—Ä—å –ø—Ä–∏ —Å–±–æ—è—Ö. –û–Ω –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –∂—É—Ä–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª –ø–µ—Ä–µ–¥ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–ø–∏—Å—å—é –≤ –ø–∞–º—è—Ç—å –∏–ª–∏ NVMe, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –ø–æ—Å–ª–µ –∞–≤–∞—Ä–∏–∏. –°–Ω–∞–ø—à–æ—Ç—ã –ø–æ–∑–≤–æ–ª—è—é—Ç –±—ã—Å—Ç—Ä–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞     | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                |
| -------------- | ------------------------------------------------------- |
| WAL-–∂—É—Ä–Ω–∞–ª     | –î–≤–æ–∏—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç, log compaction, –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å    |
| WAL-—Å–µ–≥–º–µ–Ω—Ç—ã   | –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –±–ª–æ–∫–∏, –ª–æ–≥–∏—á–µ—Å–∫–∞—è –∏ —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è |
| –°–Ω–∞–ø—à–æ—Ç—ã       | Copy-on-write, diff-based, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MVCC            |
| WAL replay     | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–∏–≥—Ä–æ–≤–∫–∞ –∂—É—Ä–Ω–∞–ª–∞ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ            |
| Crash recovery | –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è      |
| –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ WAL | –í–µ—Ä—Å–∏—è, checksums, timestamps                           |
| –ü—Ä–µ—Ñ–µ—Ç—á –ª–æ–≥–æ–≤  | –î–ª—è —É—Å–∫–æ—Ä–µ–Ω–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ read-heavy —Å–∏—Å—Ç–µ–º–∞—Ö   |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ NUMA | –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ WAL-–ø–∏—Å–∞—Ç–µ–ª–∏ —Å CPU affinity                |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct wal_record_t {
    uint64_t lsn;        // –ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø–æ–∑–∏—Ü–∏—è –∑–∞–ø–∏—Å–∏
    uint64_t txid;       // –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    uint64_t timestamp;  // –≤—Ä–µ–º—è —Ñ–∏–∫—Å–∞—Ü–∏–∏
    uint32_t op;         // —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏
    uint32_t size;       // —Ä–∞–∑–º–µ—Ä –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏
    uint8_t  payload[];  // –¥–∞–Ω–Ω—ã–µ
} wal_record_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
wal_engine --> mvcc_engine
wal_engine --> buffer_manager
wal_engine --> storage_layer
wal_engine --> snapshot_manager
wal_engine --> tx_manager
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: **C23**, —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
* –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤—ã—Ä–∞–≤–Ω–µ–Ω–Ω—ã–µ mmap-–±–ª–æ–∫–∏ –∏ O\_DIRECT
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ sync/async commit —Å control-—Ñ–ª–∞–≥–∞–º–∏
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö WAL-–≤–æ—Ä–∫–µ—Ä–æ–≤ –ø–æ NUMA-—É–∑–ª–∞–º
* Diff-based —Å–Ω–∞–ø—à–æ—Ç—ã —Å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/wal/wal_engine.c`
* `src/wal/snapshot.c`
* `include/wal/wal_engine.h`
* `include/wal/snapshot.h`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –§—É–Ω–∫—Ü–∏—è           | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                  | –û–ø–∏—Å–∞–Ω–∏–µ                          |
| ----------------- | ----------------------------------------- | --------------------------------- |
| `wal_init`        | `int wal_init(const char *path)`          | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WAL –∏ –µ–≥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã |
| `wal_append`      | `int wal_append(const wal_record_t *rec)` | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –∂—É—Ä–Ω–∞–ª        |
| `wal_replay`      | `int wal_replay(void)`                    | –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ WAL             |
| `snapshot_create` | `int snapshot_create(void)`               | –°–æ–∑–¥–∞–Ω–∏–µ —Å–Ω–∞–ø—à–æ—Ç–∞                 |
| `snapshot_load`   | `int snapshot_load(void)`                 | –ó–∞–≥—Ä—É–∑–∫–∞ —Å–Ω–∞–ø—à–æ—Ç–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ      |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* **Unit**: —Ç–µ—Å—Ç—ã –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∂—É—Ä–Ω–∞–ª–æ–≤, –ø–∞–¥–µ–Ω–∏—è, –Ω–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
* **Fuzz**: –º—É—Ç–∞—Ü–∏–∏ –∂—É—Ä–Ω–∞–ª–æ–≤, —Å–±–æ–π –Ω–∞ —Å–µ—Ä–µ–¥–∏–Ω–µ —Å–Ω–∞–ø—à–æ—Ç–∞
* **Soak**: –¥–ª–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ WAL –∏ —Å–Ω–∞–ø—à–æ—Ç–æ–≤
* **Coverage**: 93.4% –ø–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `src/wal/`

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                 | –ó–Ω–∞—á–µ–Ω–∏–µ                                  |
| ----------------------- | ----------------------------------------- |
| –ó–∞–ø–∏—Å—å WAL (1 –∑–∞–ø–∏—Å—å)   | \~80‚Äì120 –Ω—Å                               |
| –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–Ω–∞–ø—à–æ—Ç–∞ | \~6‚Äì20 –º—Å (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ MVCC) |
| –°–∫–æ—Ä–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è | –¥–æ 5 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π/—Å –≤ —Ä–µ–∂–∏–º–µ WAL replay    |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                  | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                               |
| ------------------------- | ------ | ----------------------------------------- |
| Write-Ahead Logging       | 100    | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é                     |
| –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ | 100    | –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å–Ω–∞–ø—à–æ—Ç—ã + replay WAL        |
| Log compaction            | 100    | –§–∏–∑–∏—á–µ—Å–∫–∞—è –∏ –ª–æ–≥–∏—á–µ—Å–∫–∞—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è       |
| –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ WAL writers  | 100    | NUMA-aware –ø–∏—Å–∞—Ç–µ–ª–∏ —Å lock-free –æ—á–µ—Ä–µ–¥—è–º–∏ |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
wal_record_t rec = {
    .lsn = ++global_lsn,
    .txid = current_txid,
    .timestamp = clock_gettime_ns(),
    .op = WAL_INSERT,
    .size = sizeof(payload),
    .payload = payload
};
wal_append(&rec);
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* WAL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
* CRC32/CRC64 –≤ –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏
* –ê—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–ø–∏—Å—å mmap + msync

---

## üõ∞Ô∏è –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö
* –ü–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å "AS OF" –∑–∞–ø—Ä–æ—Å—ã –∫ –±–∞–∑–µ
* –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è

---

## üóÇÔ∏è –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* –í–µ—Ä—Å–∏—è: `v1.0`
* –û–±–Ω–æ–≤–ª–µ–Ω–æ: `26.07.2025`
* –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: `wal_team@domain`

---

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
class wal_record_t {
  +uint64_t lsn
  +uint64_t txid
  +uint64_t timestamp
  +uint32_t op
  +uint32_t size
  +uint8_t payload[]
}
@enduml
```

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* Incremental —Å–Ω–∞–ø—à–æ—Ç—ã —Å MVCC-chain delta
* WAL compression (zstd/brotli)
* –ü–µ—Ä–µ–Ω–æ—Å —Å–Ω–∞–ø—à–æ—Ç–æ–≤ –≤ NVMe tier —Å TTL-–∫–æ–Ω—Ç—Ä–æ–ª–µ–º

---

# üß± –ë–ª–æ–∫ 1.18 ‚Äî –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Å—Ç—Ä–∞–Ω–∏—Ü –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–π (Page Lifecycle, Dirty Bits, LRU/ARC)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî  –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.18 ‚Äî –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Å—Ç—Ä–∞–Ω–∏—Ü –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–π (Page Lifecycle, Dirty Bits, LRU/ARC)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü –≤ –±—É—Ñ–µ—Ä–Ω–æ–π –ø–æ–¥—Å–∏—Å—Ç–µ–º–µ –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–π in-memory —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–æ–π –°–£–ë–î. –û–Ω –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–π (dirty tracking), –∫–æ–Ω—Ç—Ä–æ–ª—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ —Å –∂—É—Ä–Ω–∞–ª–æ–º WAL, –∞ —Ç–∞–∫–∂–µ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã –≤—ã—Ç–µ—Å–Ω–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º. –ú–µ—Ö–∞–Ω–∏–∑–º—ã —ç—Ç–æ–≥–æ —É—Ä–æ–≤–Ω—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–¥–µ—Ä–∂–µ–∫ –∏ –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ–π –∑–∞–ø–∏—Å–∏ –∏ —á—Ç–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π NUMA-—Å—Ä–µ–¥–µ.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                             | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                        |
| -------------------------------------- | ------------------------------------------------------------------------------- |
| –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü | Bitmask-–ø–æ–ª–µ dirty –∏ –≤–µ—Ä—Å–∏–æ–Ω–Ω—ã–µ —Ñ–ª–∞–≥–∏, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ –∫–∞–∂–¥–æ–π —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ |
| –ê–ª–≥–æ—Ä–∏—Ç–º—ã –≤—ã—Ç–µ—Å–Ω–µ–Ω–∏—è                   | –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π ARC —Å ghost-–ª–∏—Å—Ç–∞–º–∏, —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è, fallback –Ω–∞ LRU    |
| –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–∞                    | Prefetching –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è, NUMA-aware –º–∏–≥—Ä–∞—Ü–∏—è             |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å WAL –∏ snapshot            | –ñ—ë—Å—Ç–∫–∞—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ LSN-—Ñ–ª–∞–≥–∏ –∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–µ —Ç–æ—á–∫–∏ —Å–±—Ä–æ—Å–∞           |
| –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å –∏ –∞—É–¥–∏—Ç                  | –ì–ª—É–±–æ–∫–∞—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π: flush latency, eviction count, IOPS impact        |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
struct page_metadata_t {
    uint64_t page_id;             // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    uint32_t lsn_dirty;           // Log Sequence Number –ø–æ—Å–ª–µ–¥–Ω–µ–π –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏
    bool is_dirty;                // Dirty-bit –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
    bool in_lru_list;             // –ü—Ä–∏–∑–Ω–∞–∫ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –≤—ã—Ç–µ—Å–Ω–µ–Ω–∏—è
    uint64_t last_access_ns;      // –ú–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è
};
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
package "1.19 –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª —Å—Ç—Ä–∞–Ω–∏—Ü" {
  [–ë—É—Ñ–µ—Ä–Ω—ã–π –ø—É–ª] --> [–ê–ª–≥–æ—Ä–∏—Ç–º—ã ARC/LRU]
  [–ë—É—Ñ–µ—Ä–Ω—ã–π –ø—É–ª] --> [WAL –∏ Snapshot]
  [–ë—É—Ñ–µ—Ä–Ω—ã–π –ø—É–ª] --> [NUMA-aware –∞–ª–ª–æ–∫–∞—Ç–æ—Ä –ø–∞–º—è—Ç–∏]
  [–ë—É—Ñ–µ—Ä–Ω—ã–π –ø—É–ª] --> [–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏]
}
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: **C23** —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π, memory barrier'–æ–≤ –∏ bitfield-–ø–æ–ª–µ–π
* NUMA-aware —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥–æ—Ä—è—á–∏–º–∏ –∏ —Ö–æ–ª–æ–¥–Ω—ã–º–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏
* ARC –≤–∫–ª—é—á–∞–µ—Ç T1/T2 —Å–ø–∏—Å–∫–∏, B1/B2 ghost-–ª–∏—Å—Ç—ã –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω—É—é —Å–º–µ–Ω—É –ø–æ–ª–∏—Ç–∏–∫
* LRU –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ fallback –≤ —Å–ª—É—á–∞–µ –Ω–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤
* –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å WAL —á–µ—Ä–µ–∑ `lsn_dirty` –∏ —Ç–æ—á–∫–∏ —Å–±—Ä–æ—Å–∞ –≤ snapshot

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/storage/buffer_pool.c`
* `src/storage/page_lifecycle.c`
* `include/storage/buffer_pool.h`
* `include/storage/page_meta.h`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏              | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                  | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                                      |
| ------------------------ | --------------------------------------------------------- | --------------------------------------------------------------- |
| `buffer_pool_mark_dirty` | `void buffer_pool_mark_dirty(page_t *page, uint32_t lsn)` | –ü–æ–º–µ—á–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–∞–∫ dirty –∏ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π LSN     |
| `buffer_pool_evict_lru`  | `void *buffer_pool_evict_lru()`                           | –í—ã–ø–æ–ª–Ω—è–µ—Ç –≤—ã—Ç–µ—Å–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ LRU                     |
| `page_lifecycle_flush`   | `void page_lifecycle_flush(page_t *page)`                 | –ò–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –∏–ª–∏ –æ—Ç–ª–æ–∂–µ–Ω–Ω—É—é –∑–∞–ø–∏—Å—å —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ NVMe/SSD |
| `arc_replace_page`       | `page_t *arc_replace_page(page_t *victim)`                | –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –∑–∞–º–µ–Ω—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å —É—á–µ—Ç–æ–º –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏ ARC       |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit-—Ç–µ—Å—Ç—ã: `tests/buffer_pool_test.c`, `tests/arc_cache_test.c`
* Soak/Stress-—Ç–µ—Å—Ç—ã: `tools/stress/buffer_eviction_benchmark.c`
* Fuzzing: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≥–æ–Ω–æ–∫ dirty/flush —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø
* –ü–æ–∫—Ä—ã—Ç–∏–µ: 98.2% —Å—Ç—Ä–æ–∫ –∏ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø—É—Ç–µ–π

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å                 | –ó–Ω–∞—á–µ–Ω–∏–µ   | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ                                         |
| -------------------------- | ---------- | -------------------------------------------------- |
| –°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞ flush     | 120‚Äì300 –Ω—Å | –ü—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ, NUMA-aware aligned flush    |
| Dirty-pages –≤ steady-state | 2‚Äì7%       | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ñ–æ–Ω–æ–≤—ã–º–∏ eviction task'–∞–º–∏          |
| –î–æ–ª—è –ø–æ–ø–∞–¥–∞–Ω–∏–π –≤ LRU/ARC   | 92‚Äì97%     | –í—ã—Å–æ–∫–∞—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤—ã—Ç–µ—Å–Ω–µ–Ω–∏—è –ø—Ä–∏ OLTP-–Ω–∞–≥—Ä—É–∑–∫–µ |
| Latency –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ ARC      | < 500 –Ω—Å   | –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –ø–æ —á–∞—Å—Ç–æ—Ç–µ ghost-—Å—Ç—Ä–∞–Ω–∏—Ü            |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                                | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                                        |
| --------------------------------------- | ------ | ------------------------------------------------------------------ |
| –¢–æ—á–Ω–æ–µ dirty-tracking –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ç—Ä–∞–Ω–∏—Ü | ‚úÖ 100  | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –Ω–∞ —É—Ä–æ–≤–Ω–µ –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –±–∏—Ç –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è —Å LSN           |
| Flush –ø–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–º—É WAL-LSN         | ‚úÖ 100  | –ß—ë—Ç–∫–æ–µ —Å–æ–ø—Ä—è–∂–µ–Ω–∏–µ —Å snapshot recovery –∏ –º–µ—Ö–∞–Ω–∏–∑–º–∞–º–∏ WAL checkpoint |
| NUMA-aware cache management             | ‚úÖ 100  | –£—á–µ—Ç —Ç–æ–ø–æ–ª–æ–≥–∏–∏ NUMA, –∞—Å—Å–æ—Ü–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –≥–æ—Ä—è—á–∏—Ö —É—á–∞—Å—Ç–∫–æ–≤            |
| –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ observability              | ‚úÖ 100  | –≠–∫—Å–ø–æ—Ä—Ç –º–µ—Ç—Ä–∏–∫ –≤ OpenMetrics/Prometheus, —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ evict/flush   |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
void buffer_pool_mark_dirty(page_t *page, uint32_t lsn) {
    atomic_store(&page->meta.is_dirty, true);
    page->meta.lsn_dirty = lsn;
    page->meta.last_access_ns = get_nanotime();
}
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ó–∞—â–∏—Ç–∞ –æ—Ç –≥–æ–Ω–æ–∫: –∞—Ç–æ–º–∞—Ä–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ dirty-—Ñ–ª–∞–≥–æ–≤ –ø—Ä–∏ concurent-–º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è—Ö
* –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ LSN –º–µ–∂–¥—É –±—É—Ñ–µ—Ä–Ω–æ–π –∏ WAL-–∫–æ–ø–∏–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
* –ú–µ—Ö–∞–Ω–∏–∑–º double-buffered commit –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ —É—Å—Ç–æ–π—á–∏–≤–æ–≥–æ —Å–±—Ä–æ—Å–∞

---

## üß© UML-–¥–∏–∞–≥—Ä–∞–º–º–∞ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

```plantuml
state "–°—Ç—Ä–∞–Ω–∏—Ü–∞" as Page {
    [*] --> Clean
    Clean --> Dirty : buffer_pool_mark_dirty()
    Dirty --> Flushed : page_lifecycle_flush()
    Flushed --> Clean : –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
}
```

---

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è

* –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: `v1.0-stable`
* –ò–∑–º–µ–Ω–µ–Ω–∏—è:

  * `+` –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω ARC-–∞–ª–≥–æ—Ä–∏—Ç–º —Å ghost-list –¥–∏–Ω–∞–º–∏–∫–æ–π
  * `+` –†–∞—Å—à–∏—Ä–µ–Ω—ã NUMA-aware eviction –∏ flush-–∞–ª–≥–æ—Ä–∏—Ç–º—ã
  * `+` –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å WAL checkpoint-—Å–∏—Å—Ç–µ–º–æ–π
  * `+` –î–æ–±–∞–≤–ª–µ–Ω—ã –º–µ—Ç—Ä–∏–∫–∏ flush/eviction –≤ —Å–∏—Å—Ç–µ–º—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

---

## üß† –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–π –∏ –±—ã—Å—Ç—Ä–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–∏–ª–ª–∏–æ–Ω–æ–≤ –∑–∞–ø–∏—Å–µ–π –≤ —Å—É—Ç–∫–∏
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—ã—Å–æ–∫–æ–π —á–∞—Å—Ç–æ—Ç—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏
* –ü–æ–≤—ã—à–µ–Ω–∏–µ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ flush
