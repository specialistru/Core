# üìò 5.1 ‚Äî HTAP –∏ –≥–∏–±—Ä–∏–¥–Ω—ã–µ –Ω–∞–≥—Ä—É–∑–∫–∏ (Hybrid Transactional/Analytical Processing)

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* –ü–∞–∫–µ—Ç 5 ‚Äî BI, ML –∏ OLAP
* –ë–ª–æ–∫ 5.1 ‚Äî HTAP –∏ –≥–∏–±—Ä–∏–¥–Ω—ã–µ –Ω–∞–≥—Ä—É–∑–∫–∏

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É –≥–∏–±—Ä–∏–¥–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö –∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (HTAP ‚Äî Hybrid Transactional/Analytical Processing), —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–¥–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ OLTP (–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ) –∏ OLAP (–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ) –∑–∞–ø—Ä–æ—Å—ã —Å –Ω–∏–∑–∫–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ ERP, BI –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏, –≥–¥–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Å–≤–µ–∂–∏–º –¥–∞–Ω–Ω—ã–º –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è –±–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞             | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                            |
| ---------------------- | ------------------------------------------------------------------- |
| OLTP –¥–≤–∏–∂–æ–∫            | Row-store, MVCC, fast insert/update, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å <1 –º—Å latency     |
| OLAP –¥–≤–∏–∂–æ–∫            | Column-store, –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, –∞–≥—Ä–µ–≥–∞—Ü–∏–∏, –∫–æ–º–ø—Ä–µ—Å—Å–∏—è, –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º      |
| Dual-execution planner | –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫, —É–º–µ—é—â–∏–π —Ä–∞–∑–¥–µ–ª—è—Ç—å –∏ –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä–æ–≤–∞—Ç—å OLTP –∏ OLAP –ø–ª–∞–Ω—ã   |
| Data freshness         | Read-your-write –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏, –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ view refresh         |
| Workload-aware routing | –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –Ω—É–∂–Ω—ã–π execution engine –ø–æ —Ç–∏–ø—É –Ω–∞–≥—Ä—É–∑–∫–∏ |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

–ì–∏–±—Ä–∏–¥–Ω–∞—è –º–æ–¥–µ–ª—å: –æ–¥–Ω–∞ –∏ —Ç–∞ –∂–µ —Ç–∞–±–ª–∏—Ü–∞ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å row- –∏ column-–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ:

```c
typedef struct htap_table_t {
    table_row_store_t *row;
    table_column_store_t *column;
    bool sync_required;
    ts_t last_sync_ts;
} htap_table_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[HTAP Layer] --> [Row Store]
[HTAP Layer] --> [Column Store]
[HTAP Layer] --> [Query Planner]
[Query Planner] --> [Optimizer]
[Optimizer] --> [Executor]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* Adaptive Execution Layer –¥–ª—è –≤—ã–±–æ—Ä–∞ –º–µ–∂–¥—É OLTP/OLAP –ø–ª–∞–Ω–∞–º–∏
* –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è row‚Üícolumn –∏ –Ω–∞–æ–±–æ—Ä–æ—Ç
* –ü—Ä—è–º–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ mixed workloads (–Ω–∞–ø—Ä–∏–º–µ—Ä, SELECT + INSERT –≤ –æ–¥–Ω—É —Å–µ—Å—Å–∏—é)
* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º (batch prefetch, cache locality)

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/htap/htap_layer.c`
* `include/htap/htap_layer.h`
* `src/exec/query_planner.c`
* `src/storage/row_store.c`, `column_store.c`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏         | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                 | –û–ø–∏—Å–∞–Ω–∏–µ                                  |
| ------------------- | -------------------------------------------------------- | ----------------------------------------- |
| `htap_route_query`  | `int htap_route_query(query_t *q, htap_table_t *table);` | –í—ã–±–æ—Ä –º–µ–∂–¥—É OLTP –∏ OLAP –¥–≤–∏–∂–∫–æ–º           |
| `htap_sync`         | `int htap_sync(htap_table_t *table);`                    | –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è row- –∏ column-–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π |
| `htap_analyze_load` | `int htap_analyze_load(workload_t *wl);`                 | –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∫–∞–∫ OLTP –∏–ª–∏ OLAP   |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: –≤—ã–±–æ—Ä HTAP-—Å—Ç—Ä–∞—Ç–µ–≥–∏–π, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å row/column sync
* Integration: —Å–º–µ—à–∞–Ω–Ω—ã–µ workloads, real-time BI –∑–∞–ø—Ä–æ—Å—ã
* Soak: –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–∞—è mixed –Ω–∞–≥—Ä—É–∑–∫–∞
* Performance regression: OLTP latency / OLAP throughput

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* OLTP insert latency: \~300 –Ω—Å
* OLAP aggregation (100M rows): \~200 –º—Å (–±–µ–∑ –∫–µ—à–∞)
* HTAP latency under mixed load: < 1 –º—Å (p95)

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π         | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                          |
| ---------------- | ------ | ---------------------------------------------------- |
| OLTP performance | 100    | Vectorized execution + row-store, latency <1 –º—Å      |
| OLAP performance | 95     | –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –∏ –∫–æ–º–ø—Ä–µ—Å—Å–∏—è, —Ö–æ—Ä–æ—à–∞—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å   |
| HTAP-—Å—Ü–µ–Ω–∞—Ä–∏–∏    | 90     | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω split planner, –Ω–æ –Ω–µ—Ç query rewrite layer |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
query_t q = parse_query("SELECT SUM(sales) FROM orders");
htap_table_t *tbl = get_htap_table("orders");
htap_route_query(&q, tbl);
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ columnar updates (–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ)
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å adaptive query rewriter
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ tiered HTAP (OLAP –Ω–∞ —Ö–æ–ª–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)

## üß∞ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* BI-–Ω–∞–≥—Ä—É–∑–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –ø–æ —Å–≤–µ–∂–∏–º –¥–∞–Ω–Ω—ã–º ERP
* –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –æ–ø–µ—Ä–∞—Ü–∏—è–º: –∑–∞–∫–∞–∑—ã, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
* –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ –±–µ–∑ ETL

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ê—É–¥–∏—Ç mixed workload (–∏–∑ –æ–¥–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ access policies –Ω–∞ —É—Ä–æ–≤–Ω–µ HTAP execution path
* –ò–∑–æ–ª—è—Ü–∏—è OLTP –∏ OLAP —Å–µ—Å—Å–∏–π –≤ tenant-aware –æ–∫—Ä—É–∂–µ–Ω–∏–∏

## üßæ –°–æ–æ–±—â–µ–Ω–∏—è, –æ—à–∏–±–∫–∏, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

* `WARN_HTAP_DESYNC_DETECTED`
* `ERR_HTAP_QUERY_UNSUPPORTED`
* `INFO_HTAP_PLAN_CHOSEN`

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî Dual-engine HTAP routing, row/column sync
* v1.1 ‚Äî –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π refresh OLAP –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
* v1.2 ‚Äî Workload router + auto-hints from optimizer

## üìà UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
package "HTAP Layer" {
  class htap_table_t {
    +row: table_row_store_t*
    +column: table_column_store_t*
    +sync_required: bool
    +last_sync_ts: ts_t
  }
  htap_table_t --> row_store
  htap_table_t --> column_store
  htap_table_t --> query_planner
}
@enduml
```
