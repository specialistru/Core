# 5.15 ‚Äî SQL-–ø—Ä–æ—Ç–æ–∫–æ–ª –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 5 ‚Äî BI, ML –∏ OLAP**
**–ë–ª–æ–∫ 5.15 ‚Äî SQL-–ø—Ä–æ—Ç–æ–∫–æ–ª –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è**

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø—Ä–æ—Ç–æ–∫–æ–æ–ª SQL-–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å PostgreSQL wire protocol, —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –±–∏–Ω–∞—Ä–Ω–æ–≥–æ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö RPC-–∑–∞–ø—Ä–æ—Å–æ–≤.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞               | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                     |
| ------------------------ | -------------------------------------------- |
| PostgreSQL Wire Protocol | –°–æ–≤–º–µ—Å—Ç–∏–º –¥–ª—è –¥—Ä–∞–π–≤–µ—Ä–æ–≤ JDBC/ODBC            |
| –ë–∏–Ω–∞—Ä–Ω—ã–π SQL-–ø—Ä–æ—Ç–æ–∫–æ–ª    | –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ |
| –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å API        | REST, gRPC, WebSocket, JSON\:API, CLI        |
| –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Ñ—Ä–æ–Ω—Ç–∞–º–∏ | JDBC/ODBC, GraphQL –≤ —Å–æ—Å—Ç–∞–≤–µ Graph-API       |

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```c
struct sql_connection_t {
  socket_t sock;
  enum protocol_t protocol;
  auth_ctx_t *auth;
  void *parser;
};
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```plantuml
PostgresWire --> SQLExecutor
BinaryProtocol --> SQLExecutor
WebSocket --> SQLExecutor
REST --> SQLExecutor
GraphQL --> SQLExecutor
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ TLS/–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
* –í—ã–±–æ—Ä –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –ø—Ä–∏ handshake
* –ë–∞—Ç—á-–∑–∞–ø—Ä–æ—Å—ã –∏ —Å—Ç—Ä–∏–º–∏–Ω–≥

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

* `src/net/postgres_wire.c`
* `src/net/binary_proto.c`
* `src/net/sql_connection.c`
* `include/net/sql_connection.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –ò–º—è                | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                    | –û–ø–∏—Å–∞–Ω–∏–µ                              |
| ------------------ | ----------------------------------------------------------- | ------------------------------------- |
| `sql_conn_init`    | `sql_connection_t *sql_conn_init(socket_t s, protocol_t p)` | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω–Ω–µ–∫—Ç–∞                |
| `sql_conn_accept`  | `int sql_conn_accept(sql_connection_t *c)`                  | –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –≤—ã–±–æ—Ä –ø—Ä–æ—Ç–æ–∫–æ–ª–∞      |
| `sql_conn_process` | `int sql_conn_process(sql_connection_t *c)`                 | –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ |

## ü•∫ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/net/test_postgres.c`, `test_binary.c`
* Integration: PostgreSQL JDBC client

## üìä –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å

* –†–µ–∂–∏–º binary protocol: \~250K req/s per core
* –ü–∏–Ω–≥ —Å PostgreSQL JDBC: < 1 –º—Å

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                    | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                       |
| --------------------------- | ------ | --------------------------------- |
| PostgreSQL Wire Protocol    | 100    | –°–æ–≤–º–µ—Å—Ç–∏–º –¥–ª—è –≤—Å–µ—Ö SQL-–∫–ª–∏–µ–Ω—Ç–æ–≤   |
| Binary Protocol             | 100    | –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–æ –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏      |
| REST/gRPC/WebSocket/GraphQL | 100    | –î–æ–ø–æ–ª–Ω—è—é—Ç SQL API –¥–ª—è BI/—Å–µ—Ä–≤–∏—Å–æ–≤ |

## üìå –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
sql_connection_t *c = sql_conn_init(sock, PROTO_PGSQL);
sql_conn_accept(c);
while (1) {
   sql_conn_process(c);
}
```

## üìä UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity "PostgresWire" as PG
entity "BinaryProtocol" as BIN
entity "SQLExecutor" as EXEC
entity "REST" as R
entity "gRPC" as G
entity "GraphQL" as QL

PG --> EXEC
BIN --> EXEC
R --> EXEC
G --> EXEC
QL --> EXEC
@enduml
```

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* BI-—Å—Ç–µ–∫: PostgreSQL/ODBC/JDBC —á–µ—Ä–µ–∑ wire-protocol
* –§—Ä–æ–Ω—Ç–µ–Ω–¥—ã: GraphQL, REST
* ETL/–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: gRPC, JSON\:API

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –†–æ–ª–µ–≤–æ–π –¥–æ—Å—Ç—É–ø –∫ API
* TLS/–ºTLS —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ
* –ü—Ä–æ—Ç–æ–∫–æ–ª—å–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è

## üîÑ –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

* v1.0 ‚Äî Wire Protocol (PostgreSQL)
* v1.1 ‚Äî Binary Protocol + REST/gRPC
* v1.2 ‚Äî GraphQL/JSON\:API
* v1.3 ‚Äî TLS, auth, role-based access

## ‚ö†Ô∏è –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

| –ö–æ–¥               | –£—Å–ª–æ–≤–∏–µ                   | –°–æ–æ–±—â–µ–Ω–∏–µ                      |
| ----------------- | ------------------------- | ------------------------------ |
| `E_PROTO_INVALID` | –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª | –û—à–∏–±–∫–∞ —Ä–∞—Å–ø–∞—Ä—Å–∏–≤–∞–Ω–∏—è –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ |
| `E_AUTH_FAILED`   | –ù–µ—É—Å–ø–µ—à–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è | –î–æ—Å—Ç—É–ø                         |


