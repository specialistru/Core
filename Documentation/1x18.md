# üß± –ë–ª–æ–∫ 1.18 ‚Äî Write-Ahead Logging (WAL) –∏ —Å–Ω–∞–ø—à–æ—Ç—ã

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî  –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.18 ‚Äî Write-Ahead Logging (WAL) –∏ —Å–Ω–∞–ø—à–æ—Ç—ã

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ WAL (–∂—É—Ä–Ω–∞–ª –ø—Ä–µ–¥–∑–∞–ø–∏—Å–∏) –∏ —Å–Ω–∞–ø—à–æ—Ç–æ–≤ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥—ë–∂–Ω—É—é –∏ –±—ã—Å—Ç—Ä—É—é –∑–∞—â–∏—Ç—É –¥–∞–Ω–Ω—ã—Ö –æ—Ç –ø–æ—Ç–µ—Ä—å –ø—Ä–∏ —Å–±–æ—è—Ö. –û–Ω –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤—Å–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –∂—É—Ä–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª –ø–µ—Ä–µ–¥ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–ø–∏—Å—å—é –≤ –ø–∞–º—è—Ç—å –∏–ª–∏ NVMe, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –ø–æ—Å–ª–µ –∞–≤–∞—Ä–∏–∏. –°–Ω–∞–ø—à–æ—Ç—ã –ø–æ–∑–≤–æ–ª—è—é—Ç –±—ã—Å—Ç—Ä–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞     | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                |
| -------------- | ------------------------------------------------------- |
| WAL-–∂—É—Ä–Ω–∞–ª     | –î–≤–æ–∏—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç, log compaction, –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å    |
| WAL-—Å–µ–≥–º–µ–Ω—Ç—ã   | –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –±–ª–æ–∫–∏, –ª–æ–≥–∏—á–µ—Å–∫–∞—è –∏ —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è |
| –°–Ω–∞–ø—à–æ—Ç—ã       | Copy-on-write, diff-based, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MVCC            |
| WAL replay     | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–∏–≥—Ä–æ–≤–∫–∞ –∂—É—Ä–Ω–∞–ª–∞ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ            |
| Crash recovery | –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è      |
| –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ WAL | –í–µ—Ä—Å–∏—è, checksums, timestamps                           |
| –ü—Ä–µ—Ñ–µ—Ç—á –ª–æ–≥–æ–≤  | –î–ª—è —É—Å–∫–æ—Ä–µ–Ω–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ read-heavy —Å–∏—Å—Ç–µ–º–∞—Ö   |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ NUMA | –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ WAL-–ø–∏—Å–∞—Ç–µ–ª–∏ —Å CPU affinity                |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct wal_record_t {
    uint64_t lsn;        // –ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø–æ–∑–∏—Ü–∏—è –∑–∞–ø–∏—Å–∏
    uint64_t txid;       // –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    uint64_t timestamp;  // –≤—Ä–µ–º—è —Ñ–∏–∫—Å–∞—Ü–∏–∏
    uint32_t op;         // —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏
    uint32_t size;       // —Ä–∞–∑–º–µ—Ä –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏
    uint8_t  payload[];  // –¥–∞–Ω–Ω—ã–µ
} wal_record_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
wal_engine --> mvcc_engine
wal_engine --> buffer_manager
wal_engine --> storage_layer
wal_engine --> snapshot_manager
wal_engine --> tx_manager
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: **C23**, —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–µ–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
* –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤—ã—Ä–∞–≤–Ω–µ–Ω–Ω—ã–µ mmap-–±–ª–æ–∫–∏ –∏ O\_DIRECT
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ sync/async commit —Å control-—Ñ–ª–∞–≥–∞–º–∏
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö WAL-–≤–æ—Ä–∫–µ—Ä–æ–≤ –ø–æ NUMA-—É–∑–ª–∞–º
* Diff-based —Å–Ω–∞–ø—à–æ—Ç—ã —Å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/wal/wal_engine.c`
* `src/wal/snapshot.c`
* `include/wal/wal_engine.h`
* `include/wal/snapshot.h`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –§—É–Ω–∫—Ü–∏—è           | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                  | –û–ø–∏—Å–∞–Ω–∏–µ                          |
| ----------------- | ----------------------------------------- | --------------------------------- |
| `wal_init`        | `int wal_init(const char *path)`          | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WAL –∏ –µ–≥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã |
| `wal_append`      | `int wal_append(const wal_record_t *rec)` | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –∂—É—Ä–Ω–∞–ª        |
| `wal_replay`      | `int wal_replay(void)`                    | –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ WAL             |
| `snapshot_create` | `int snapshot_create(void)`               | –°–æ–∑–¥–∞–Ω–∏–µ —Å–Ω–∞–ø—à–æ—Ç–∞                 |
| `snapshot_load`   | `int snapshot_load(void)`                 | –ó–∞–≥—Ä—É–∑–∫–∞ —Å–Ω–∞–ø—à–æ—Ç–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ      |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* **Unit**: —Ç–µ—Å—Ç—ã –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∂—É—Ä–Ω–∞–ª–æ–≤, –ø–∞–¥–µ–Ω–∏—è, –Ω–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
* **Fuzz**: –º—É—Ç–∞—Ü–∏–∏ –∂—É—Ä–Ω–∞–ª–æ–≤, —Å–±–æ–π –Ω–∞ —Å–µ—Ä–µ–¥–∏–Ω–µ —Å–Ω–∞–ø—à–æ—Ç–∞
* **Soak**: –¥–ª–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ WAL –∏ —Å–Ω–∞–ø—à–æ—Ç–æ–≤
* **Coverage**: 93.4% –ø–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `src/wal/`

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                 | –ó–Ω–∞—á–µ–Ω–∏–µ                                  |
| ----------------------- | ----------------------------------------- |
| –ó–∞–ø–∏—Å—å WAL (1 –∑–∞–ø–∏—Å—å)   | \~80‚Äì120 –Ω—Å                               |
| –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–Ω–∞–ø—à–æ—Ç–∞ | \~6‚Äì20 –º—Å (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ MVCC) |
| –°–∫–æ—Ä–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è | –¥–æ 5 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π/—Å –≤ —Ä–µ–∂–∏–º–µ WAL replay    |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                  | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                               |
| ------------------------- | ------ | ----------------------------------------- |
| Write-Ahead Logging       | 100    | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é                     |
| –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ | 100    | –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å–Ω–∞–ø—à–æ—Ç—ã + replay WAL        |
| Log compaction            | 100    | –§–∏–∑–∏—á–µ—Å–∫–∞—è –∏ –ª–æ–≥–∏—á–µ—Å–∫–∞—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è       |
| –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ WAL writers  | 100    | NUMA-aware –ø–∏—Å–∞—Ç–µ–ª–∏ —Å lock-free –æ—á–µ—Ä–µ–¥—è–º–∏ |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
wal_record_t rec = {
    .lsn = ++global_lsn,
    .txid = current_txid,
    .timestamp = clock_gettime_ns(),
    .op = WAL_INSERT,
    .size = sizeof(payload),
    .payload = payload
};
wal_append(&rec);
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* WAL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —á—Ç–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
* CRC32/CRC64 –≤ –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏
* –ê—Ç–æ–º–∞—Ä–Ω–∞—è –∑–∞–ø–∏—Å—å mmap + msync

---

## üõ∞Ô∏è –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö
* –ü–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å "AS OF" –∑–∞–ø—Ä–æ—Å—ã –∫ –±–∞–∑–µ
* –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è

---

## üóÇÔ∏è –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* –í–µ—Ä—Å–∏—è: `v1.0`
* –û–±–Ω–æ–≤–ª–µ–Ω–æ: `26.07.2025`
* –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: `wal_team@domain`

---

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
class wal_record_t {
  +uint64_t lsn
  +uint64_t txid
  +uint64_t timestamp
  +uint32_t op
  +uint32_t size
  +uint8_t payload[]
}
@enduml
```

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* Incremental —Å–Ω–∞–ø—à–æ—Ç—ã —Å MVCC-chain delta
* WAL compression (zstd/brotli)
* –ü–µ—Ä–µ–Ω–æ—Å —Å–Ω–∞–ø—à–æ—Ç–æ–≤ –≤ NVMe tier —Å TTL-–∫–æ–Ω—Ç—Ä–æ–ª–µ–º
