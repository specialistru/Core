# 8.4 ‚Äî –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (Adaptive Joins: Hash, Merge, Nested Loop)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 8 ‚Äî –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
**–ë–ª–æ–∫ 8.4 ‚Äî –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (Adaptive Joins: Hash, Merge, Nested Loop)**

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã—Ö –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Ç–∞–±–ª–∏—Ü —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –≤—ã–±–æ—Ä–æ–º –∞–ª–≥–æ—Ä–∏—Ç–º–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫, —Ä–∞–∑–º–µ—Ä–∞ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, —Ç–∏–ø–∞ –∏–Ω–¥–µ–∫—Å–æ–≤ –∏ —É—Å–ª–æ–≤–∏–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É `Hash Join`, `Merge Join`, `Index Nested Loop` –∏ `Grace Hash Join` –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞             | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                   |
| ---------------------- | ---------------------------------------------------------- |
| Hash Join              | –í–µ–∫—Ç–æ—Ä–Ω–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ö—ç—à-—Ç–∞–±–ª–∏—Ü—ã –∏ –ø—Ä–æ–±–∏–Ω–≥                 |
| Merge Join             | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤—Ö–æ–¥—ã            |
| Index Nested Loop Join | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç B+-–∏–Ω–¥–µ–∫—Å—ã –∏ bitmap-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏                 |
| Grace Hash Join        | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ –ø–∞–º—è—Ç–∏ (spill –Ω–∞ SSD)          |
| –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å           | –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –≤ —Ä–∞–Ω—Ç–∞–π–º–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct join_plan_t {
  join_type_t type; // HASH, MERGE, NESTED, GRACE
  join_condition_t condition;
  table_t *left;
  table_t *right;
  index_t *index; // –º–æ–∂–µ—Ç –±—ã—Ç—å NULL
} join_plan_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
QueryPlanner --> JoinPlanner
JoinPlanner --> AdaptiveJoinExecutor
AdaptiveJoinExecutor --> HashEngine
AdaptiveJoinExecutor --> MergeEngine
AdaptiveJoinExecutor --> IndexAccess
AdaptiveJoinExecutor --> DiskSpillManager
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –ê–¥–∞–ø—Ç–∞—Ü–∏—è join-–ø–ª–∞–Ω–∞ –Ω–∞ —ç—Ç–∞–ø–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫–æ–º –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞–º–∏
* NUMA-aware –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ö—ç—à-—Ç–∞–±–ª–∏—Ü
* –ü—Ä–µ–¥–∏–∫–∞—Ç–Ω–æ–µ pushdown-—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ join'–æ–º
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ bloom-—Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ hash joins

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/exec/join/adaptive_join.c`
* `src/exec/join/hash_join.c`
* `src/exec/join/merge_join.c`
* `src/exec/join/nested_loop.c`
* `include/exec/join_plan.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –ò–º—è                    | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                          | –û–ø–∏—Å–∞–Ω–∏–µ                                     |
| ---------------------- | ----------------------------------------------------------------- | -------------------------------------------- |
| `join_execute`         | `int join_execute(join_plan_t *plan, result_iter_t *out)`         | –í—ã–ø–æ–ª–Ω—è–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ø–ª–∞–Ω–æ–º |
| `adaptive_join_select` | `join_type_t adaptive_join_select(stats_t *left, stats_t *right)` | –í—ã–±–∏—Ä–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è    |
| `hash_join_exec`       | `int hash_join_exec(join_plan_t *plan, result_iter_t *out)`       | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è hash join                         |
| `merge_join_exec`      | `int merge_join_exec(join_plan_t *plan, result_iter_t *out)`      | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è merge join                        |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/exec/test_join_hash.c`, `test_join_merge.c`
* Stress: —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü >10M —Å—Ç—Ä–æ–∫
* Soak: –¥–ª–∏—Ç–µ–ª—å–Ω—ã–µ OLAP-–∑–∞–ø—Ä–æ—Å—ã —Å —Ä–∞–∑–Ω—ã–º–∏ cardinality
* Fuzz: —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ join-—É—Å–ª–æ–≤–∏–π –∏ spill-–ø–µ—Ä–µ—Ö–æ–¥–æ–≤

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –°—Ü–µ–Ω–∞—Ä–∏–π                       | –ú–µ—Ç—Ä–∏–∫–∞         |
| ------------------------------ | --------------- |
| Hash Join 10M —Å—Ç—Ä–æ–∫            | \~4.3 –º—Å        |
| Merge Join (sorted inputs)     | \~2.9 –º—Å        |
| Index Nested Join (indexed)    | \~1.2 –º—Å        |
| Grace Hash Join (spill to SSD) | \~6.8 –º—Å (NVMe) |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                     | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                    |
| ---------------------------- | ------ | ---------------------------------------------- |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 4 —Å—Ç—Ä–∞—Ç–µ–≥–∏–π Join   | 100    | –í—Å–µ –∫–ª—é—á–µ–≤—ã–µ join-–∞–ª–≥–æ—Ä–∏—Ç–º—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã        |
| –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è      | 100    | Runtime –≤—ã–±–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫    |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫–æ–º | 100    | –ü–ª–∞–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω –ø–æ feedback –ø—Ä–æ—Ñ–∏–ª—é |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
join_plan_t plan = {
  .type = JOIN_AUTO,
  .left = get_table("orders"),
  .right = get_table("customers"),
  .condition = JOIN_ON("orders.cust_id", "customers.id")
};
join_execute(&plan, &result_iter);
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ GPU-accelerated join (cuDF backend)
* ML-–ø–æ–¥—Å–∫–∞–∑–∫–∏ –Ω–∞ —Å—Ç–∞–¥–∏–∏ Join Planner
* –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ join‚Äô—ã (inter-node execution)

## üìä UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity "JoinPlanner" as JP
entity "AdaptiveJoinExecutor" as AJE
entity "HashEngine" as HE
entity "MergeEngine" as ME
entity "IndexAccess" as IA
entity "DiskSpillManager" as DSM

JP --> AJE
AJE --> HE
AJE --> ME
AJE --> IA
AJE --> DSM
@enduml
```

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –°–ª–æ–∂–Ω—ã–µ –æ—Ç—á—ë—Ç—ã —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏
* –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Å–æ–±—ã—Ç–∏–π –∏ –ª–æ–≥–æ–≤
* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* Join-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞—Ä—É—à–∞–µ—Ç row-level security
* –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–∞–º –ø—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
* –ó–∞—â–∏—Ç–∞ –æ—Ç join-based side-channel –∞—Ç–∞–∫

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è hash/merge
* v1.1 ‚Äî –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä –≤ —Ä–∞–Ω—Ç–∞–π–º–µ
* v1.2 ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø—Ä–æ—Ñ–∞–π–ª–µ—Ä–æ–º
* v1.3 ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ spill –Ω–∞ NVMe

## üõë –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

| –ö–æ–¥ / –¢–∏–ø            | –£—Å–ª–æ–≤–∏–µ                     | –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏                             |
| -------------------- | --------------------------- | ------------------------------------------- |
| `E_JOIN_TYPE_UNDEF`  | –ù–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω —Ç–∏–ø —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è | –û—à–∏–±–∫–∞ –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ –∏–ª–∏ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–º –≤—ã–±–æ—Ä–µ |
| `W_JOIN_SPILL`       | Spill –Ω–∞ –¥–∏—Å–∫ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω   | –ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏               |
| `E_JOIN_INCOMP_KEYS` | –ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ —Ç–∏–ø—ã –∫–ª—é—á–µ–π   | –û—à–∏–±–∫–∞ –≤ —É—Å–ª–æ–≤–∏—è—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è                |
