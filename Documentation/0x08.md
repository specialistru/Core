# üì¶ –ü–∞–∫–µ—Ç 0 ‚Äî –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–π —Å—Ç–∞—Ä—Ç

| ‚Ññ –±–ª–æ–∫–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞                                                                           |
| ------- | ---------------------------------------------------------------------------------------- |
| 0.1     | –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (main)                                                     |

# üß± –ë–ª–æ–∫ 0.1 ‚Äî –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (main)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 0. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–π —Å—Ç–∞—Ä—Ç
* **–ë–ª–æ–∫:** 0.1 –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (main)

---

---

# 8.1 ‚Äî –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏ (Latency Profiling & Low-Latency OLTP)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 8 ‚Äî –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
**–ë–ª–æ–∫ 8.1 ‚Äî –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏ (Latency Profiling & Low-Latency OLTP)**

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –±–ª–æ–∫ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Å–≤–µ—Ä—Ö–Ω–∏–∑–∫–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ OLTP-–æ–ø–µ—Ä–∞—Ü–∏–π (Online Transaction Processing) –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö <1 –º—Å, –≤–∫–ª—é—á–∞—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—É—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ (<500 –Ω—Å). –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–∫—É—Å ‚Äî –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–µ–∫ –≤ —Ü–µ–ø–æ—á–∫–∞—Ö –≤—ã–∑–æ–≤–æ–≤, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è–º–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤, NUMA-aware –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞              | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                |
| ----------------------- | ------------------------------------------------------- |
| –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–µ–∫ | –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤—â–∏–∫, –∑–∞–ø–∏—Å—å timeline –∫–∞–∂–¥–æ–≥–æ –≤—ã–∑–æ–≤–∞ |
| –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å        | –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —è–¥—Ä–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è (executor, plan cache)      |
| OLTP –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è        | –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤, hot-path bypass    |
| NUMA-aware –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ   | CPU affinity, memory locality                           |
| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –æ—á–µ—Ä–µ–¥–∏    | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ –≤ –¥–∏—Å–ø–∞—Ç—á–µ—Ä–µ –ø–ª–∞–Ω–æ–≤              |

## üíæ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è

```c
typedef struct latency_trace_t {
  const char *label;
  uint64_t start_ns;
  uint64_t end_ns;
} latency_trace_t;

typedef struct oltp_metrics_t {
  uint64_t tx_count;
  double avg_latency_ns;
  double p99_latency_ns;
} oltp_metrics_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[Executor] --> [LatencyProfiler]
[LatencyProfiler] --> [MetricsEngine]
[LatencyProfiler] --> [PlanCache]
[LatencyProfiler] --> [NUMAAllocator]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ TSC (Time Stamp Counter) –¥–ª—è –Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
* Hot-path —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞: –≤—ã–¥–µ–ª–µ–Ω–∏–µ fast/slow –≤–µ—Ç–æ–∫ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è
* –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ call stack –ø–æ –∫–ª—é—á–µ–≤—ã–º —Ç–æ—á–∫–∞–º –ø–ª–∞–Ω–æ–≤
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å perf –∏ flamegraph

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/exec/latency_profiler.c`
* `src/exec/oltp_executor.c`
* `include/exec/latency_trace.h`
* `src/metrics/oltp_metrics.c`
* `include/metrics/oltp_metrics.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –ò–º—è                   | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                    | –û–ø–∏—Å–∞–Ω–∏–µ                                           |
| --------------------- | ----------------------------------------------------------- | -------------------------------------------------- |
| `latency_start`       | `void latency_start(latency_trace_t *t, const char *label)` | –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—á–∞–ª–æ —Å–æ–±—ã—Ç–∏—è                       |
| `latency_end`         | `void latency_end(latency_trace_t *t)`                      | –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–µ—Ü —Å–æ–±—ã—Ç–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –º–µ—Ç—Ä–∏–∫–∞—Ö |
| `oltp_record_metrics` | `void oltp_record_metrics(uint64_t dur_ns)`                 | –û–±–Ω–æ–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫–∏ –∏ p99 latency                    |
| `latency_log_flame`   | `void latency_log_flame(void)`                              | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è flamegraph –ª–æ–≥–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏   |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/exec/test_latency_profiler.c`
* Integration: –∑–∞–º–µ—Ä—ã –Ω–∞ hot-query –Ω–∞–≥—Ä—É–∑–∫–µ
* Soak: –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ 10M+ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
* Perf: —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–π –¥–æ/–ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                       | –ó–Ω–∞—á–µ–Ω–∏–µ               |
| ----------------------------- | ---------------------- |
| –°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ OLTP | 0.87 –º—Å                |
| –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞          | < 470 –Ω—Å               |
| Throughput                    | > 2.2 –º–ª–Ω —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π/—Å |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                       | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                     |
| ------------------------------ | ------ | ------------------------------- |
| –ó–∞–¥–µ—Ä–∂–∫–∞ OLTP < 1 –º—Å           | 100    | –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç         |
| –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–æ—á–µ–∫ | 100    | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å TSC –∏ flamegraph   |
| NUMA-aware –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ          | 100    | CPU-pinning, –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–æ–≤ |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
latency_trace_t trace;
latency_start(&trace, "insert_order");

executor_run_query(...);

latency_end(&trace);
oltp_record_metrics(trace.end_ns - trace.start_ns);
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å eBPF –¥–ª—è kernel-level –∑–∞–¥–µ—Ä–∂–µ–∫
* –ê–≤—Ç–æ–∞–Ω–∞–ª–∏–∑ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ runtime
* –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è hot tables –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ

## üìä UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity "Executor" as EX
entity "LatencyProfiler" as LAT
entity "MetricsEngine" as MET
entity "PlanCache" as PC
entity "NUMAAllocator" as NUMA

EX --> LAT
LAT --> MET
LAT --> PC
LAT --> NUMA
@enduml
```

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ real-time —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ ERP, POS –∏ CRM
* SLA-–∫–æ–Ω—Ç—Ä–æ–ª—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–∫–ª–∏–∫–∞ –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª–∏–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤—ã—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –í—Å–µ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ –≤ sandbox
* –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –∏—Å–∫–ª—é—á–∞–µ—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
* RBAC-–∑–∞—â–∏—Ç–∞ –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –±–∞–∑–æ–≤–∞—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ TSC
* v1.1 ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ NUMA-aware latency path
* v1.2 ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å perf, p99 –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ

## üõë –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

| –ö–æ–¥ / –¢–∏–ø          | –£—Å–ª–æ–≤–∏–µ                  | –û–ø–∏—Å–∞–Ω–∏–µ                               |
| ------------------ | ------------------------ | -------------------------------------- |
| `W_LATENCY_HIGH`   | –ó–∞–¥–µ—Ä–∂–∫–∞ > 1 –º—Å          | –ó–∞–ø—Ä–æ—Å –ø—Ä–µ–≤—ã—Å–∏–ª –æ–∂–∏–¥–∞–µ–º—É—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å |
| `I_TRACE_DISABLED` | –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ | –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ –∑–∞–¥–µ—Ä–∂–∫–∞–º –Ω–µ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è     |

---

–û—Ç–ª–∏—á–Ω–æ. –ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥—ë–Ω —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–º —à–∞–±–ª–æ–Ω–æ–º:

---

# 8.2 ‚Äî –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –∫–æ–Ω–≤–µ–π–µ—Ä—ã (Parallel Execution & Pipelines)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 8 ‚Äî –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
**–ë–ª–æ–∫ 8.2 ‚Äî –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –∫–æ–Ω–≤–µ–π–µ—Ä—ã (Parallel Execution & Pipelines)**

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–≠—Ç–æ—Ç –±–ª–æ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –º–Ω–æ–≥–æ—è–¥–µ—Ä–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –∏ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–Ω–æ–π –∏–µ—Ä–∞—Ä—Ö–∏–∏ (CPU, NUMA). –ï–≥–æ —Ü–µ–ª—å ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã —Å–µ—Ä–≤–µ—Ä–∞, –ø–æ–≤—ã—Å–∏—Ç—å throughput –∏ —Å–Ω–∏–∑–∏—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–∞–∫ OLTP, —Ç–∞–∫ –∏ OLAP-–Ω–∞–≥—Ä—É–∑–∫–∏. –ö–æ–Ω–≤–µ–π–µ—Ä–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (pipeline execution) —Ä–∞–∑–±–∏–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ —Å—Ç–∞–¥–∏–∏, –∏—Å–ø–æ–ª–Ω—è—é—â–∏–µ—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∏–ª–∏ –≤ –ø–æ—Ç–æ–∫–æ–≤–æ–º —Ä–µ–∂–∏–º–µ.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞           | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                          |
| -------------------- | ------------------------------------------------- |
| Task Scheduler       | NUMA-aware –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á, CPU pinning         |
| Execution Pipelines  | Stage-based –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ, handoff –º–µ–∂–¥—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏ |
| Vectorized Execution | –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–ª–æ–∫–∞–º–∏ –ø–æ 1024+ —Å—Ç—Ä–æ–∫ —Å SIMD           |
| Thread Pools         | –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ OLTP/OLAP thread pools              |
| Adaptive Concurrency | Scale-out/scale-in –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–∞–ø—Ä–æ—Å–∞       |

## üíæ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è

```c
typedef struct exec_pipeline_t {
  operator_t **stages;
  size_t stage_count;
  thread_pool_t *pool;
  bool vectorized;
} exec_pipeline_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
QueryPlanner --> ExecutionPipeline
ExecutionPipeline --> TaskScheduler
ExecutionPipeline --> VectorizedEngine
ExecutionPipeline --> ThreadPool
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* NUMA-aware –ø—Ä–∏–≤—è–∑–∫–∞ –ø–æ—Ç–æ–∫–æ–≤ –∏ –ø–∞–º—è—Ç–∏
* Minimal locking: lock-free –æ—á–µ—Ä–µ–¥–∏ –º–µ–∂–¥—É —Å—Ç–∞–¥–∏—è–º–∏
* –ú–æ–¥–µ–ª—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è: Producer/Consumer, Fusion
* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è L1/L2 –∫—ç—à–∞ –ø–æ —Å—Ç–∞–¥–∏—è–º

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/exec/pipeline.c`
* `src/exec/task_scheduler.c`
* `src/exec/vectorized_engine.c`
* `include/exec/pipeline.h`
* `include/exec/thread_pool.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –ò–º—è                     | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                              | –û–ø–∏—Å–∞–Ω–∏–µ                                         |
| ----------------------- | ----------------------------------------------------- | ------------------------------------------------ |
| `pipeline_create`       | `exec_pipeline_t *pipeline_create(plan_t *plan)`      | –°–æ–∑–¥–∞—ë—Ç pipeline –¥–ª—è –ø–ª–∞–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞               |
| `pipeline_execute`      | `void pipeline_execute(exec_pipeline_t *pipeline)`    | –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ                |
| `task_scheduler_submit` | `void task_scheduler_submit(task_t *t)`               | –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–¥–∞—á—É –≤ NUMA-aware –ø—É–ª               |
| `vectorized_execute`    | `void vectorized_execute(operator_t *op, batch_t *b)` | –ò—Å–ø–æ–ª–Ω—è–µ—Ç –æ–¥–Ω—É —Å—Ç–∞–¥–∏—é –≤ –≤–µ–∫—Ç–æ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/exec/test_pipeline.c`, `tests/exec/test_scheduler.c`
* Stress: 1M+ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
* Fuzz: pipeline stages –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
* Soak: —Å—É—Ç–∫–∏ –Ω–∞–≥—Ä—É–∑–∫–∏ mixed workload

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                  | –ó–Ω–∞—á–µ–Ω–∏–µ                         |
| ------------------------ | -------------------------------- |
| –°—Ä–µ–¥–Ω–µ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ (OLAP) | x12 –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å single-thread |
| –£—Ç–∏–ª–∏–∑–∞—Ü–∏—è —è–¥–µ—Ä (24 CPU) | >95%                             |
| –í—Ä–µ–º—è –∫–æ–Ω–≤–µ–π–µ—Ä–∞ (OLTP)   | < 0.4 –º—Å                         |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π               | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                             |
| ---------------------- | ------ | --------------------------------------- |
| –ö–æ–Ω–≤–µ–π–µ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ | 100    | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –Ω–∞ –±–∞–∑–µ —Å—Ç–∞–¥–∏–π –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ |
| NUMA-aware –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ | 100    | CPU –∏ –ø–∞–º—è—Ç—å –∞–ª–ª–æ–∫–∞—Ü–∏—è –ø–æ –ª–æ–∫–∞–ª—å–Ω–æ—Å—Ç–∏   |
| –í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è           | 100    | SIMD-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∏ batch processing      |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
exec_pipeline_t *pl = pipeline_create(plan);
pipeline_execute(pl);
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ö–æ–Ω–≤–µ–π–µ—Ä—ã —Å –ø—Ä–µ–¥–∏–∫–∞—Ç–∏–≤–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ —Å—Ç–∞–¥–∏–π
* Dynamically materialized –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –±—É—Ñ–µ—Ä—ã
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ GPU pipeline execution (CUDA backend)

## üìä UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity "QueryPlanner" as QP
entity "ExecutionPipeline" as EP
entity "TaskScheduler" as TS
entity "VectorizedEngine" as VE
entity "ThreadPool" as TP

QP --> EP
EP --> TS
EP --> VE
EP --> TP
@enduml
```

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å
* –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ CRM/ERP
* –ë—ã—Å—Ç—Ä–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è –∏ join'—ã –Ω–∞ –±–æ–ª—å—à–∏—Ö –≤—ã–±–æ—Ä–∫–∞—Ö

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ü–æ—Ç–æ–∫–∏ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Å—Å–∏–π
* –ù–µ—Ç —É—Ç–µ—á–∫–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É pipeline-—Å—Ç–∞–¥–∏—è–º–∏
* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏ –ø–æ—Ç–æ–∫–æ–≤ (low-priv vs admin)

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –±–∞–∑–æ–≤—ã–π pipeline engine
* v1.1 ‚Äî NUMA-aware –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á
* v1.2 ‚Äî –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ L2-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

## üõë –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

| –ö–æ–¥ / –¢–∏–ø         | –£—Å–ª–æ–≤–∏–µ                       | –û–ø–∏—Å–∞–Ω–∏–µ                                     |
| ----------------- | ----------------------------- | -------------------------------------------- |
| `E_PIPELINE_FAIL` | –û—à–∏–±–∫–∞ –≤ —Å—Ç–∞–¥–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è    | –ö–æ–Ω–≤–µ–π–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑-–∑–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏ |
| `W_TASK_OVERLOAD` | –ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª-–≤–æ –∑–∞–¥–∞—á –≤ –ø—É–ª–µ | –ó–∞–¥–µ—Ä–∂–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∏–∑-–∑–∞ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏            |

---

–û—Ç–ª–∏—á–Ω–æ! –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é –±–ª–æ–∫ **8.3 ‚Äî –í–µ–∫—Ç–æ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–≤–∏–∂–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è** –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–º —à–∞–±–ª–æ–Ω–æ–º SAP HANA+.

---

# 8.3 ‚Äî –í–µ–∫—Ç–æ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–≤–∏–∂–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (Vectorized Execution Engine)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 8 ‚Äî –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
**–ë–ª–æ–∫ 8.3 ‚Äî –í–µ–∫—Ç–æ—Ä–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–≤–∏–∂–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (Vectorized Execution Engine)**

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –±–ª–æ–∫ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ —Å—á—ë—Ç –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–∞—á–∫–∞–º–∏ (batch-based execution), –º–∏–Ω–∏–º–∏–∑–∏—Ä—É—è –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ –≤—ã–∑–æ–≤—ã —Ñ—É–Ω–∫—Ü–∏–π –∏ —É–ª—É—á—à–∞—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU-–∫—ç—à–µ–π –∏ SIMD-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π. –≠—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è OLAP-–Ω–∞–≥—Ä—É–∑–æ–∫, –∞–≥—Ä–µ–≥–∞—Ü–∏–π –∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                 | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                            |
| -------------------------- | --------------------------------------------------- |
| Batch Processing           | –ü–∞—á–∫–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ (–æ–±—ã—á–Ω–æ 1024 —Å—Ç—Ä–æ–∫)    |
| SIMD Accelerated Operators | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ AVX2/AVX512/FMA –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π                |
| Columnar Execution         | –†–∞–±–æ—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é —Å column-store layout (PAX / Arrow) |
| Lazy Evaluation            | –û–ø–µ—Ä–∞—Ç–æ—Ä—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏         |
| Runtime Filtering          | –í–µ–∫—Ç–æ—Ä–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã —Å pushdown-–ø–æ–¥–¥–µ—Ä–∂–∫–æ–π             |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct vector_batch_t {
  column_vector_t *columns;
  uint32_t row_count;
  bool null_mask[MAX_COLUMNS][BATCH_SIZE];
} vector_batch_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
QueryPlanner --> ExecutionPipeline
ExecutionPipeline --> VectorizedEngine
VectorizedEngine --> ColumnStore
VectorizedEngine --> SIMD
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç layout: columnar, Arrow, PAX
* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞: scalar ‚Üî vector
* –†–∞—Å–ø–∞—Ä–∞–ª–ª–µ–ª–∏–≤–∞–Ω–∏–µ –≤–Ω—É—Ç—Ä–∏ batch (SIMD lanes)
* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è false sharing –∏ prefetch hints

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/exec/vectorized_engine.c`
* `src/exec/simd_ops.c`
* `include/exec/vector_batch.h`
* `include/exec/vectorized_engine.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –ò–º—è                   | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                       | –û–ø–∏—Å–∞–Ω–∏–µ                             |
| --------------------- | -------------------------------------------------------------- | ------------------------------------ |
| `vector_exec_scan`    | `int vector_exec_scan(table_t *t, vector_batch_t *out)`        | –°–∫–∞–Ω–∏—Ä—É–µ—Ç –∫–æ–ª–æ–Ω–∫—É –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç batch |
| `vector_filter_apply` | `void vector_filter_apply(vector_batch_t *in, predicate_t *p)` | –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä –∫ batch             |
| `vector_aggregate`    | `void vector_aggregate(vector_batch_t *in, agg_op_t *agg)`     | –ê–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –≤ batch          |
| `vector_join_hash`    | `int vector_join_hash(batch_t *left, batch_t *right)`          | –í–µ–∫—Ç–æ—Ä–Ω–æ–µ hash-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ            |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/exec/test_vector.c`
* Fuzz: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è batch'–µ–π —Å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
* Soak: –Ω–∞–≥—Ä—É–∑–∫–∞ 1M batch‚Äô–µ–π –≤ —á–∞—Å
* Benchmark: AVX512 vs scalar fallback

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è            | –í—Ä–µ–º—è (–≤ —Å—Ä–µ–¥–Ω–µ–º)      |
| ------------------- | ---------------------- |
| –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è 1M —Å—Ç—Ä–æ–∫ | \~0.8 –º—Å (AVX2)        |
| –ê–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ batch  | \~1.2 –º—Å –Ω–∞ 1K batch   |
| –í–µ–∫—Ç–æ—Ä–Ω—ã–π join      | \~3.1 –º—Å –Ω–∞ 100K —Å—Ç—Ä–æ–∫ |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                    | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                   |
| --------------------------- | ------ | --------------------------------------------- |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ SIMD              | 100    | AVX2/512 –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è                       |
| Vectorized scan/filter/agg  | 100    | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤–æ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–Ω—ã—Ö –º–æ–¥—É–ª—è—Ö       |
| –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å ColumnStore | 100    | –ü—Ä—è–º–∞—è —Ä–∞–±–æ—Ç–∞ —Å column-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º layout |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
vector_batch_t batch;
vector_exec_scan(table, &batch);
vector_filter_apply(&batch, predicate);
vector_aggregate(&batch, agg_sum);
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* GPU –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (CUDA backend)
* –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É scalar/vector –Ω–∞ —Ä–∞–Ω—Ç–∞–π–º–µ
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Arrow Flight –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

## üìä UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity "ExecutionPipeline" as EP
entity "VectorizedEngine" as VE
entity "ColumnStore" as CS
entity "SIMD" as SIMD

EP --> VE
VE --> CS
VE --> SIMD
@enduml
```

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ë—ã—Å—Ç—Ä—ã–π –æ—Ç—á—ë—Ç –ø–æ –∞–≥—Ä–µ–≥–∞—Ü–∏—è–º –≤ ERP/CRM
* –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ real-time –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ü–∞—á–∫–∏ batch'–µ–π –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç —Å—Å—ã–ª–æ–∫ –Ω–∞ –≤–Ω–µ—à–Ω—é—é –ø–∞–º—è—Ç—å
* –í–µ–∫—Ç–æ—Ä–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ–¥—á–∏–Ω–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞–º row-level security
* –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ pipeline execution

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
* v1.1 ‚Äî –∞–≥—Ä–µ–≥–∞—Ç—ã —Å SIMD
* v1.2 ‚Äî join-–æ–ø–µ—Ä–∞—Ü–∏–∏ —Å SIMD

## üõë –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

| –ö–æ–¥ / –¢–∏–ø           | –£—Å–ª–æ–≤–∏–µ                     | –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏                                  |
| ------------------- | --------------------------- | ------------------------------------------------ |
| `E_VEC_NULL_MASK`   | –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å null-mask | –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª null-–æ–±—Ä–∞–±–æ—Ç–∫–∏                  |
| `W_VEC_SCALAR_FALL` | –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ scalar      | –í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞ –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è runtime |

---

–û—Ç–ª–∏—á–Ω–æ! –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é –±–ª–æ–∫ **8.4 ‚Äî –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (Adaptive Joins: Hash, Merge, Nested Loop)** –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —É—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–º –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–º —à–∞–±–ª–æ–Ω–æ–º.

---

# 8.4 ‚Äî –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (Adaptive Joins: Hash, Merge, Nested Loop)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 8 ‚Äî –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
**–ë–ª–æ–∫ 8.4 ‚Äî –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (Adaptive Joins: Hash, Merge, Nested Loop)**

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã—Ö –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Ç–∞–±–ª–∏—Ü —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –≤—ã–±–æ—Ä–æ–º –∞–ª–≥–æ—Ä–∏—Ç–º–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫, —Ä–∞–∑–º–µ—Ä–∞ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, —Ç–∏–ø–∞ –∏–Ω–¥–µ–∫—Å–æ–≤ –∏ —É—Å–ª–æ–≤–∏–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É `Hash Join`, `Merge Join`, `Index Nested Loop` –∏ `Grace Hash Join` –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞             | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                   |
| ---------------------- | ---------------------------------------------------------- |
| Hash Join              | –í–µ–∫—Ç–æ—Ä–Ω–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ö—ç—à-—Ç–∞–±–ª–∏—Ü—ã –∏ –ø—Ä–æ–±–∏–Ω–≥                 |
| Merge Join             | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤—Ö–æ–¥—ã            |
| Index Nested Loop Join | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç B+-–∏–Ω–¥–µ–∫—Å—ã –∏ bitmap-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏                 |
| Grace Hash Join        | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ –ø–∞–º—è—Ç–∏ (spill –Ω–∞ SSD)          |
| –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å           | –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –≤ —Ä–∞–Ω—Ç–∞–π–º–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct join_plan_t {
  join_type_t type; // HASH, MERGE, NESTED, GRACE
  join_condition_t condition;
  table_t *left;
  table_t *right;
  index_t *index; // –º–æ–∂–µ—Ç –±—ã—Ç—å NULL
} join_plan_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
QueryPlanner --> JoinPlanner
JoinPlanner --> AdaptiveJoinExecutor
AdaptiveJoinExecutor --> HashEngine
AdaptiveJoinExecutor --> MergeEngine
AdaptiveJoinExecutor --> IndexAccess
AdaptiveJoinExecutor --> DiskSpillManager
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –ê–¥–∞–ø—Ç–∞—Ü–∏—è join-–ø–ª–∞–Ω–∞ –Ω–∞ —ç—Ç–∞–ø–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫–æ–º –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞–º–∏
* NUMA-aware –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ö—ç—à-—Ç–∞–±–ª–∏—Ü
* –ü—Ä–µ–¥–∏–∫–∞—Ç–Ω–æ–µ pushdown-—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ join'–æ–º
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ bloom-—Ñ–∏–ª—å—Ç—Ä–æ–≤ –≤ hash joins

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/exec/join/adaptive_join.c`
* `src/exec/join/hash_join.c`
* `src/exec/join/merge_join.c`
* `src/exec/join/nested_loop.c`
* `include/exec/join_plan.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –ò–º—è                    | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                          | –û–ø–∏—Å–∞–Ω–∏–µ                                     |
| ---------------------- | ----------------------------------------------------------------- | -------------------------------------------- |
| `join_execute`         | `int join_execute(join_plan_t *plan, result_iter_t *out)`         | –í—ã–ø–æ–ª–Ω—è–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ø–ª–∞–Ω–æ–º |
| `adaptive_join_select` | `join_type_t adaptive_join_select(stats_t *left, stats_t *right)` | –í—ã–±–∏—Ä–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è    |
| `hash_join_exec`       | `int hash_join_exec(join_plan_t *plan, result_iter_t *out)`       | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è hash join                         |
| `merge_join_exec`      | `int merge_join_exec(join_plan_t *plan, result_iter_t *out)`      | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è merge join                        |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/exec/test_join_hash.c`, `test_join_merge.c`
* Stress: —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü >10M —Å—Ç—Ä–æ–∫
* Soak: –¥–ª–∏—Ç–µ–ª—å–Ω—ã–µ OLAP-–∑–∞–ø—Ä–æ—Å—ã —Å —Ä–∞–∑–Ω—ã–º–∏ cardinality
* Fuzz: —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ join-—É—Å–ª–æ–≤–∏–π –∏ spill-–ø–µ—Ä–µ—Ö–æ–¥–æ–≤

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –°—Ü–µ–Ω–∞—Ä–∏–π                       | –ú–µ—Ç—Ä–∏–∫–∞         |
| ------------------------------ | --------------- |
| Hash Join 10M —Å—Ç—Ä–æ–∫            | \~4.3 –º—Å        |
| Merge Join (sorted inputs)     | \~2.9 –º—Å        |
| Index Nested Join (indexed)    | \~1.2 –º—Å        |
| Grace Hash Join (spill to SSD) | \~6.8 –º—Å (NVMe) |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                     | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                    |
| ---------------------------- | ------ | ---------------------------------------------- |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 4 —Å—Ç—Ä–∞—Ç–µ–≥–∏–π Join   | 100    | –í—Å–µ –∫–ª—é—á–µ–≤—ã–µ join-–∞–ª–≥–æ—Ä–∏—Ç–º—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã        |
| –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è      | 100    | Runtime –≤—ã–±–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫    |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫–æ–º | 100    | –ü–ª–∞–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω –ø–æ feedback –ø—Ä–æ—Ñ–∏–ª—é |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
join_plan_t plan = {
  .type = JOIN_AUTO,
  .left = get_table("orders"),
  .right = get_table("customers"),
  .condition = JOIN_ON("orders.cust_id", "customers.id")
};
join_execute(&plan, &result_iter);
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ GPU-accelerated join (cuDF backend)
* ML-–ø–æ–¥—Å–∫–∞–∑–∫–∏ –Ω–∞ —Å—Ç–∞–¥–∏–∏ Join Planner
* –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ join‚Äô—ã (inter-node execution)

## üìä UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity "JoinPlanner" as JP
entity "AdaptiveJoinExecutor" as AJE
entity "HashEngine" as HE
entity "MergeEngine" as ME
entity "IndexAccess" as IA
entity "DiskSpillManager" as DSM

JP --> AJE
AJE --> HE
AJE --> ME
AJE --> IA
AJE --> DSM
@enduml
```

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –°–ª–æ–∂–Ω—ã–µ –æ—Ç—á—ë—Ç—ã —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏
* –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è —Å–æ–±—ã—Ç–∏–π –∏ –ª–æ–≥–æ–≤
* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* Join-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞—Ä—É—à–∞–µ—Ç row-level security
* –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–∞–º –ø—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
* –ó–∞—â–∏—Ç–∞ –æ—Ç join-based side-channel –∞—Ç–∞–∫

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è hash/merge
* v1.1 ‚Äî –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä –≤ —Ä–∞–Ω—Ç–∞–π–º–µ
* v1.2 ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø—Ä–æ—Ñ–∞–π–ª–µ—Ä–æ–º
* v1.3 ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ spill –Ω–∞ NVMe

## üõë –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

| –ö–æ–¥ / –¢–∏–ø            | –£—Å–ª–æ–≤–∏–µ                     | –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏                             |
| -------------------- | --------------------------- | ------------------------------------------- |
| `E_JOIN_TYPE_UNDEF`  | –ù–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω —Ç–∏–ø —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è | –û—à–∏–±–∫–∞ –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ –∏–ª–∏ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–º –≤—ã–±–æ—Ä–µ |
| `W_JOIN_SPILL`       | Spill –Ω–∞ –¥–∏—Å–∫ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω   | –ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏               |
| `E_JOIN_INCOMP_KEYS` | –ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ —Ç–∏–ø—ã –∫–ª—é—á–µ–π   | –û—à–∏–±–∫–∞ –≤ —É—Å–ª–æ–≤–∏—è—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è                |

---

# 8.5 ‚Äî –†–µ—Ä–∞–Ω—Ç–∞–π–º-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å (Runtime Re-optimization & Feedback Loop)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* –ü–∞–∫–µ—Ç 8 ‚Äî –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
* –ë–ª–æ–∫ 8.5 ‚Äî –†–µ—Ä–∞–Ω—Ç–∞–π–º-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –±–ª–æ–∫ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø–ª–∞–Ω–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –≤–æ –≤—Ä–µ–º—è –∏—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (runtime re-optimization), –∏—Å–ø–æ–ª—å–∑—É—è –¥–∞–Ω–Ω—ã–µ –æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Å–µ–ª–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, —Ä–∞–∑–º–µ—Ä–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–∞–ø–æ–≤ –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ä–µ—Å—É—Ä—Å–æ–≤. –û–Ω –ø–æ–∑–≤–æ–ª—è–µ—Ç –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –∏ —É–ª—É—á—à–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∫–æ–º–ø–∏–ª—è—Ü–∏–∏. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Ü–∏–∫–ª –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ (feedback loop), –∫–æ—Ç–æ—Ä—ã–π –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã –∏ –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                 | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                           |
| -------------------------- | ---------------------------------------------------------------------------------- |
| Runtime Re-Optimization    | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π –≤–æ –≤—Ä–µ–º—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–∞–Ω–∞ |
| Feedback Loop              | –ü–æ—Å—Ç-–∑–∞–ø—Ä–æ—Å–Ω–∞—è –∑–∞–ø–∏—Å—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ join-–∞–º, —Å–µ–ª–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, cardinality            |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–æ–º | –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è cost-based –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ —Ç–µ–∫—É—â–∏–º –º–µ—Ç—Ä–∏–∫–∞–º                      |
| –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫                | –û–±—Ä–∞—Ç–Ω—ã–π –≤—ã–∑–æ–≤ –≤ adaptive pipeline executor –¥–ª—è –ø–æ–¥–º–µ–Ω—ã –ø–æ–¥–¥–µ—Ä–µ–≤–∞                  |
| –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞                 | –í–µ–∫—Ç–æ—Ä–Ω—ã–µ —Å—á—ë—Ç—á–∏–∫–∏, NDV, –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã, sample-based –º–µ—Ç—Ä–∏–∫–∏                         |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct feedback_entry_t {
    char query_hash[32];
    double observed_selectivity;
    uint64_t row_count;
    double exec_time_ms;
    uint64_t timestamp_ns;
} feedback_entry_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
Executor --> ReOptimizer
ReOptimizer --> Optimizer
ReOptimizer --> Statistics
Executor --> FeedbackCollector
FeedbackCollector --> Statistics
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (non-blocking optimization)
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ plan subtree swapping (–≤—Å—Ç–∞–≤–∫–∞ –ø–æ–¥–¥–µ—Ä–µ–≤—å–µ–≤ —Å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π)
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–æ—Ç–æ–∫–æ–≤–æ–º –≤–∏–¥–µ (streaming)
* NUMA-aware —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–Ω–∞ —É—Ä–æ–≤–Ω–µ NUMA-–Ω–æ–¥ –∞–≥—Ä–µ–≥–∏—Ä—É—é—Ç—Å—è —Å—á—ë—Ç—á–∏–∫–∏)
* –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–º –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–∏ (lock-free –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ feedback)

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏

* `src/optimizer/reoptimize.c`
* `src/optimizer/feedback_loop.c`
* `include/optimizer/runtime_opt.h`
* `src/executor/adaptive_executor.c`
* `src/statistics/histogram.c`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è                    | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                  | –û–ø–∏—Å–∞–Ω–∏–µ                                                 |
| ---------------------- | ------------------------------------------------------------------------- | -------------------------------------------------------- |
| `reoptimize_plan`      | `plan_t *reoptimize_plan(execution_context_t *ctx, plan_t *current)`      | –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ –ø–ª–∞–Ω–∞ –∏ –∑–∞–º–µ–Ω–∞ –Ω–∞ –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π      |
| `feedback_record`      | `void feedback_record(const char *query_hash, double sel, uint64_t rows)` | –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è —Ü–∏–∫–ª–∞ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ |
| `feedback_flush`       | `void feedback_flush(void)`                                               | –û—á–∏—Å—Ç–∫–∞ –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏                           |
| `apply_feedback_stats` | `void apply_feedback_stats(optimizer_context_t *ctx)`                     | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞           |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/optimizer/test_feedback.c`, `test_reoptimize.c`
* Soak-—Ç–µ—Å—Ç—ã: —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ performance –¥–æ/–ø–æ—Å–ª–µ re-optimize –Ω–∞ 10M+ –∑–∞–ø—Ä–æ—Å–æ–≤
* Fuzz: —Å–ª—É—á–∞–π–Ω—ã–µ –ø–ª–∞–Ω—ã –∏ —Å—Ç–∞—Ç–¥–∞–Ω–Ω—ã–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–º, —Å–±—Ä–æ—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                                 | –ó–Ω–∞—á–µ–Ω–∏–µ            |
| --------------------------------------- | ------------------- |
| –í—Ä–µ–º—è –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞               | < 900 –Ω—Å            |
| –£—Å–∫–æ—Ä–µ–Ω–∏–µ —Ç—è–∂—ë–ª—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (95-–π –ø–µ—Ä—Ü.) | 2.5x                |
| –ù–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã Feedback Loop         | < 0.8% –æ—Ç CPU time  |
| –ü–∏–∫–æ–≤–∞—è –ø–∞–º—è—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏               | \~3 –ú–ë / 1M –∑–∞–ø–∏—Å–µ–π |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                               | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                   |
| -------------------------------------- | ------ | --------------------------------------------- |
| Runtime-–∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–ª–∞–Ω–æ–≤               | 100    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ dynamic replan –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ           |
| –ê–¥–∞–ø—Ç–∞—Ü–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ NDV/–≥–∏—Å—Ç–æ–≥—Ä–∞–º–º     | 100    | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∑–∞–ø—Ä–æ—Å–Ω—ã—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫         |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –±–µ–∑–æ—Å—Ç–∞–Ω–æ–≤–æ—á–Ω–æ—Å—Ç—å | 100    | Plan subtree switch –±–µ–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –∫–æ–Ω–≤–µ–π–µ—Ä–æ–≤ |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
if (rows_scanned > threshold) {
    plan_t *new_plan = reoptimize_plan(ctx, current_plan);
    if (new_plan)
        executor_switch_plan(ctx, new_plan);
}
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ materialized feedback across restarts
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ML-–æ—Ü–µ–Ω–∫–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–ª–∞–Ω–∞ (reinforcement planner)
* –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–æ UDF –∏ –∫—Ä–æ—Å—Å-—Å–µ—Å—Å–∏–π–Ω—ã—Ö —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫

## üìà UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity Executor
entity ReOptimizer
entity FeedbackCollector
entity Statistics
entity Optimizer

Executor --> ReOptimizer : –ü–ª–∞–Ω —É—Å—Ç–∞—Ä–µ–ª
ReOptimizer --> Optimizer : –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è
Executor --> FeedbackCollector : –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
FeedbackCollector --> Statistics : –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º
@enduml
```

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ü–æ–≤—ã—à–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –æ—Ç–∫–ª–∏–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞–≥—Ä—É–∑–∫–∏
* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –ø–ª–∞–Ω–∞ –ø–æ–¥ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö
* –£–º–µ–Ω—å—à–µ–Ω–∏–µ —á–∏—Å–ª–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ó–∞—â–∏—Ç–∞ trace-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Å–µ—Å—Å–∏—è–º RBAC
* –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å–±–æ—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–æ–ª–∏—Ç–∏–∫–∏
* –ó–∞—â–∏—Ç–∞ –æ—Ç DoS —á–µ—Ä–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∞–¥–∞–ø—Ç–∞—Ü–∏–π

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π feedback loop –∏ inline –∞–¥–∞–ø—Ç–∞—Ü–∏—è
* v1.1 ‚Äî NUMA-aware —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—è
* v1.2 ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ø–æ–¥ adaptive pipeline executor

## üõë –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

| –ö–æ–¥ / –¢–∏–ø           | –£—Å–ª–æ–≤–∏–µ                             | –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏             |
| ------------------- | ----------------------------------- | --------------------------- |
| `W_PLAN_STALE`      | –ü–ª–∞–Ω –ø—Ä–∏–∑–Ω–∞–Ω —É—Å—Ç–∞—Ä–µ–≤—à–∏–º             | –ë—É–¥–µ—Ç –ø—Ä–µ–¥–ø—Ä–∏–Ω—è—Ç–∞ –∞–¥–∞–ø—Ç–∞—Ü–∏—è |
| `E_FEEDBACK_OVER`   | –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø–∏—Å–µ–π –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ | –ù–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–æ–≤—ã–µ entry  |
| `W_REOPTIMIZE_SKIP` | –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏   | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–π –ø–ª–∞–Ω   |

# 8.6 ‚Äî –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–æ–≤ –∏ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –ø–æ –∏–∑–±–∏—Ä–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (Plan Caching & Selectivity Feedback)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* –ü–∞–∫–µ—Ç 8 ‚Äî –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
* –ë–ª–æ–∫ 8.6 ‚Äî –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–æ–≤ –∏ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –ø–æ –∏–∑–±–∏—Ä–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

## ‚ú® –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –±–ª–æ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ SQL-–ø–ª–∞–Ω–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, –∞ —Ç–∞–∫–∂–µ –∑–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è—Ö –∏–∑–±–∏—Ä–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (—Å–µ–ª–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏) –≤ —Å–∏—Å—Ç–µ–º—É –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞           | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                        |
| -------------------- | ----------------------------------------------- |
| –ö—ç—à SQL-–ø–ª–∞–Ω–æ–≤       | LRU-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –æ—Ç–¥–µ–ª—å–Ω—ã–π –¥–ª—è read/write   |
| –°—Ç—Ä—É–∫—Ç—É—Ä—ã –ø–ª–∞–Ω–æ–≤     | HashMap\<query\_fingerprint, plan\_entry\_t>    |
| –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫ | feedback loop + —Ñ–æ–Ω–æ–≤–æ–π –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–∞–Ω–∞–ª–∏–∑–∞       |
| –ê–Ω–∞–ª–∏–∑ —Å–µ–ª–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ | –ø–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º runtime –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è               |
| –ê–∫—Ç–∏–≤–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ü–∏—è   | —Ç—Ä–∏–≥–≥–µ—Ä—ã –Ω–∞ –¥–µ–≤–∏–∞—Ü–∏—é –≤ –æ—Ü–µ–Ω–∫–µ NDV / cardinality |

... (–ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Å–ª–µ–¥—É–µ—Ç)

# 8.7 ‚Äî –§–æ—Ä–º–∞—Ç—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è PAX / Apache Arrow (PAX / Arrow Layouts)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* –ü–∞–∫–µ—Ç 8 ‚Äî –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
* –ë–ª–æ–∫ 8.7 ‚Äî –§–æ—Ä–º–∞—Ç—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è PAX / Apache Arrow (PAX / Arrow Layouts)

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –±–ª–æ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –≤—ã–±–æ—Ä –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —Ñ–æ—Ä–º–∞—Ç–æ–≤ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏, –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞ –≤—ã—Å–æ–∫—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏ OLTP-–∑–∞–ø—Ä–æ—Å–æ–≤. –í —á–∞—Å—Ç–Ω–æ—Å—Ç–∏, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–∞–∫ PAX (Partition Attributes Across) –¥–ª—è —Å—Ç—Ä–æ—á–Ω–æ-–∫–æ–ª–æ–Ω–æ—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è, —Ç–∞–∫ –∏ Apache Arrow –¥–ª—è –∫–æ–ª–æ–Ω–æ—á–Ω–æ–≥–æ in-memory —Ñ–æ—Ä–º–∞—Ç–∞ —Å –Ω—É–ª–µ–≤–æ–π —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞              | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                            |
| ----------------------- | ----------------------------------------------------------------------------------- |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ PAX           | –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –∫—ç—à—É, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π layout –≤ page, —É—Å–∫–æ—Ä–µ–Ω–∏–µ OLTP                     |
| Apache Arrow            | Zero-copy –¥–æ—Å—Ç—É–ø, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –≤–Ω–µ—à–Ω–∏–º–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏ (NumPy, Pandas, TensorFlow) |
| –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–æ–≤    | Vectorized layout transforms –º–µ–∂–¥—É row, PAX –∏ Arrow                                 |
| –ö–æ–ª–æ–Ω–æ—á–Ω—ã–µ –≤–µ–∫—Ç–æ—Ä–∞      | SIMD-–¥—Ä—É–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–∞—Å—Å–∏–≤—ã, memory-aligned –±—É—Ñ–µ—Ä—ã                                   |
| Layout-aware –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ | –û–ø–µ—Ä–∞—Ç–æ—Ä—ã —É—á–∏—Ç—ã–≤–∞—é—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è                                      |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
// –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è PAX layout
struct pax_page_t {
    uint8_t *column_data[MAX_COLUMNS];
    uint16_t row_count;
    uint16_t column_count;
};

// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Arrow Column
struct arrow_column_t {
    void *buffer;
    size_t length;
    size_t offset;
    uint32_t null_bitmap;
};
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[8.7 –§–æ—Ä–º–∞—Ç—ã PAX / Arrow] --> [8.1 –í–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ]
[8.7 –§–æ—Ä–º–∞—Ç—ã PAX / Arrow] --> [3.2 SQL-–æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä]
[8.7 –§–æ—Ä–º–∞—Ç—ã PAX / Arrow] --> [1.3 Column-Store Engine]
[8.7 –§–æ—Ä–º–∞—Ç—ã PAX / Arrow] --> [5.1 BI –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –ù–∞–ø–∏—Å–∞–Ω–æ –Ω–∞ C23, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç memory-aligned allocation
* SIMD-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è Arrow column access
* Zero-copy —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Å Arrow
* NUMA-aware —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç layout hints –æ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–∞ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/storage/pax.c`
* `src/storage/arrow.c`
* `include/storage/pax.h`
* `include/storage/arrow.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏                   | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                     | –û–ø–∏—Å–∞–Ω–∏–µ                              |
| ----------------------------- | ------------------------------------------------------------ | ------------------------------------- |
| pax\_page\_create             | `pax_page_t *pax_page_create(uint16_t col_count)`            | –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π PAX-—Å—Ç—Ä–∞–Ω–∏—Ü—ã           |
| pax\_page\_insert             | `bool pax_page_insert(pax_page_t *, uint16_t row, void **)`  | –í—Å—Ç–∞–≤–∫–∞ —Å—Ç—Ä–æ–∫–∏ –≤ PAX layout           |
| arrow\_column\_init           | `void arrow_column_init(arrow_column_t *, size_t len)`       | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–ª–æ–Ω–∫–∏ –≤ Arrow —Ñ–æ—Ä–º–∞—Ç–µ |
| arrow\_column\_from\_pax      | `bool arrow_column_from_pax(pax_page_t *, arrow_column_t *)` | –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ PAX –≤ Arrow   |
| vectorized\_layout\_transform | `bool vectorized_layout_transform(...)`                      | –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π layout —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ç–æ—Ä    |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã: `tests/storage/test_pax.c`, `test_arrow.c`
* –ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã: `soak/test_layout_soak.c`
* –ü–æ–∫—Ä—ã—Ç–∏–µ: >90%
* –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Pandas/Arrow API —á–µ—Ä–µ–∑ C-bindings

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* –£—Å–∫–æ—Ä–µ–Ω–∏–µ OLTP-–≤—Å—Ç–∞–≤–∫–∏ –¥–æ 3.7x –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å row-store
* –ö–æ–ª–æ–Ω–æ—á–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ Arrow –≤–µ–∫—Ç–æ—Ä–æ–º: \~1.2 GB/s/core
* –°—Ä–µ–¥–Ω—è—è –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å layout transform < 15 –º–∫—Å
* PAX layout –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ª—É—á—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ mixed workload (TPC-C + TPC-H)

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                       | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                                   |
| ------------------------------ | ------ | ------------------------------------------------------------- |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ column-store         | ‚úÖ      | Apache Arrow –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º                              |
| –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å | ‚úÖ      | SIMD + zero-copy –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å |
| –ì–∏–±–∫–æ—Å—Ç—å —Ñ–æ—Ä–º–∞—Ç–æ–≤ —Ö—Ä–∞–Ω–µ–Ω–∏—è     | ‚úÖ      | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ PAX, row, Arrow                                     |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å BI/ML             | ‚úÖ      | Arrow –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞–º–∏       |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
pax_page_t *page = pax_page_create(4);
void *row[4] = { &id, &name, &age, &salary };
pax_page_insert(page, 0, row);
arrow_column_t col;
arrow_column_from_pax(page, &col);
```

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –≤ –±–ª–æ–∫–µ

* –í—Å–µ –±—É—Ñ–µ—Ä—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –Ω–∞ –≥—Ä–∞–Ω–∏—Ü—ã
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è zero-initialization –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –Ω–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
* –ö–æ–Ω—Ç—Ä–æ–ª—å –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Arrow Flight RPC –¥–ª—è —É–¥–∞–ª—ë–Ω–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö
* Layout autotuning –Ω–∞ –æ—Å–Ω–æ–≤–µ query feedback loop
* –°–∂–∞—Ç–∏–µ –∏ –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è –≤–Ω—É—Ç—Ä–∏ Arrow –∫–æ–ª–æ–Ω–æ–∫

## üß¨ –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ PAX layout –¥–ª—è OLTP (2024-03)
* v1.1 ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω Arrow layout + API —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (2024-08)
* v1.2 ‚Äî layout-aware execution –≤ executor pipeline (2025-01)

## üí¨ –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö / –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

* `E_PAX_OVERFLOW` ‚Äî –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ PAX-—Å—Ç—Ä–∞–Ω–∏—Ü—ã
* `E_ARROW_INVALID_LAYOUT` ‚Äî –æ—à–∏–±–∫–∞ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–≥–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
* `W_ARROW_ALIGNMENT` ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è

## üß© –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* BI-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ (OLAP) –∏ –æ—Ç—á—ë—Ç—ã
* ML-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Arrow
* –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∏ –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

# 8.8 ‚Äî –°–Ω–∏–º–∫–∏, –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ (Copy-on-write Snapshots, Backup & Restore)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* –ü–∞–∫–µ—Ç 8 ‚Äî –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
* –ë–ª–æ–∫ 8.8 ‚Äî –°–Ω–∏–º–∫–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–Ω–∏–º–∫–æ–≤ (snapshots) in-memory –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ç—Ä–∞–Ω–∏—Ü, –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π. –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¥–ª—è high-availability, –∞–≤–∞—Ä–∏–π–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è, –º–∏–≥—Ä–∞—Ü–∏–∏, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –∞ —Ç–∞–∫–∂–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –±–µ–∑ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è –Ω–∞ OLTP-–Ω–∞–≥—Ä—É–∑–∫—É.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                     | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                             |
| ------------------------------ | -------------------------------------------------------------------- |
| Copy-on-Write Snapshots        | –∞—Ç–æ–º–∞—Ä–Ω—ã–µ, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–ª—è NUMA-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ—Ç–¥–µ–ª—å–Ω–æ        |
| Backup (–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ) | –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º WAL + snapshot |
| –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ (Restore)       | –∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, WAL replay + snapshot merge              |
| –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü            | –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ (metadata + snapshot ref)                                 |
| Retention Policy               | TTL-—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–Ω–∏–º–∫–∞–º–∏, auto-purge                                  |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
// –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–Ω–∏–º–∫–∞
typedef struct db_snapshot_t {
    uint64_t timestamp;
    uint32_t snapshot_id;
    char name[64];
    snapshot_metadata_t *meta;
    page_map_t *page_bitmap;
    wal_checkpoint_t *wal_ref;
} db_snapshot_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
package "2.4 –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ" {
  [WAL Recovery] --> [–°–Ω–∏–º–∫–∏]
}
[–°–Ω–∏–º–∫–∏] --> [–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á]
[–°–Ω–∏–º–∫–∏] --> [–ë—É—Ñ–µ—Ä–Ω–∞—è –∑–æ–Ω–∞]
[–°–Ω–∏–º–∫–∏] --> [–°–∏—Å—Ç–µ–º–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: C23
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è copy-on-write —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º overhead
* –°–Ω–∏–º–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ —Ñ–æ–Ω–µ, –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ OLTP
* –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–æ—Ä–æ–∂–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ MVCC
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≥–æ—Ä—è—á–µ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å consistent snapshot

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/storage/snapshot.c`
* `include/storage/snapshot.h`
* `src/storage/backup.c`
* `src/storage/restore.c`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏            | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                 | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                    |
| ---------------------- | ------------------------------------------------------------------------ | --------------------------------------------- |
| snapshot\_create       | `db_snapshot_t *snapshot_create(const char *name)`                       | –°–æ–∑–¥–∞—ë—Ç —Å–Ω–∏–º–æ–∫ –≤ —Ç–µ–∫—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏            |
| snapshot\_restore      | `int snapshot_restore(const db_snapshot_t *snap)`                        | –í—ã–ø–æ–ª–Ω—è–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Å–Ω–∏–º–∫–∞            |
| snapshot\_clone\_table | `int snapshot_clone_table(const char *src_table, const char *dst_table)` | –ö–ª–æ–Ω–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–Ω–∏–º–∫–∞            |
| backup\_run            | `int backup_run(const char *path)`                                       | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è |
| restore\_from\_backup  | `int restore_from_backup(const char *path)`                              | –ó–∞–ø—É—Å–∫–∞–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –∏–∑ –±—ç–∫–∞–ø–∞       |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit-—Ç–µ—Å—Ç—ã: `tests/storage/test_snapshot.c`
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ: `tests/backup_restore/test_full.c`
* Stress/Soak: –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Å–Ω–∏–º–∫–æ–≤

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* Snapshot creation: < 3 –º—Å
* –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: –∑–∞–≤–∏—Å–∏—Ç –æ—Ç WAL (\~30‚Äì60 –ú–ë/—Å + snapshot merge)
* –ó–∞–¥–µ—Ä–∂–∫–∞ OLTP: < 1 –º—Å –≤ –º–æ–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω–∏—è snapshot

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π              | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                            |
| --------------------- | ------ | -------------------------------------- |
| –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —Å–Ω–∏–º–∫–∏     | 100    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ COW –∏ –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ snapshot    |
| –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ | 100    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ WAL+Snapshot                 |
| –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü   | 100    | –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —á–µ—Ä–µ–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ |
| TTL –∏ Retention       | 90     | –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ                   |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
// –°–æ–∑–¥–∞–Ω–∏–µ snapshot –≤ —Ñ–æ–Ω–µ
pthread_t tid;
pthread_create(&tid, NULL, (void*)snapshot_create, "nightly-snap");
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ snapshot-—ã
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ–±–ª–∞—á–Ω—ã–º–∏ S3-—Ö—Ä–∞–Ω–∏–ª–∏—â–∞–º–∏
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ snapshot-–æ–≤ –Ω–∞ —É—Ä–æ–≤–Ω–µ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –∏–ª–∏ –ø–∞—Ä—Ç–∏—Ü–∏–∏

## üõ° –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π (–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ)
* –ö–æ–Ω—Ç—Ä–æ–ª—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ WAL –∏ snapshot —á–µ—Ä–µ–∑ CRC64

## üßæ –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –±–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è snapshot + backup
* v1.1 ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ TTL –∏ auto-purge

## üß© –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –í—ã—Å–æ–∫–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
* –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–∏–≥—Ä–∞—Ü–∏–∏
* –†–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ç–æ—á–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤ SLA
