# 9.2 ‚Äî –í–Ω–µ—à–Ω–∏–µ –º–æ–¥—É–ª–∏ (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞: dlopen / LoadLibrary)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* –ü–∞–∫–µ—Ç 9 ‚Äî –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å
* –ë–ª–æ–∫ 9.2 ‚Äî –í–Ω–µ—à–Ω–∏–µ –º–æ–¥—É–ª–∏ (dlopen / LoadLibrary)

## ‚ú® –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é –∑–∞–≥—Ä—É–∑–∫—É –≤–Ω–µ—à–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ (–Ω–∞–ø—Ä., –º–æ–¥—É–ª–∏ –Ω–∞ C/C++, —Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è) –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –±–µ–∑ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ —è–¥—Ä–∞ –°–£–ë–î.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞            | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                          |
| --------------------- | ------------------------------------------------- |
| dlopen (Linux)        | POSIX API, RTLD\_NOW / RTLD\_LOCAL                |
| LoadLibrary (Windows) | WinAPI –¥–ª—è –¥–∏–Ω–∞–º. –∑–∞–≥—Ä—É–∑–∫–∏ DLL                    |
| –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è API       | –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –æ–±—Ä–∞–∑–µ—Ü –¥–ª—è entry points              |
| –ú–µ—Ö–∞–Ω–∏–∑–º —Å–∞–Ω–¥–±–æ–∫—Å–∞    | –û—Ç–¥–µ–ª—å–Ω—ã–µ PID/–Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ syscalls / —Å–µ–∫—é—Ä–Ω–æ–µ API |

## üìÇ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è

–ú–æ–¥—É–ª–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∫–∞—Ç–∞–ª–æ–≥–µ `/usr/lib/udb/modules` –∏–ª–∏ –ø–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è ELF, PE –∏ Mach-O —Ñ–æ—Ä–º–∞—Ç—ã.

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: C17 / C23
* –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –ø–æ—Ç–æ–∫–æ–≤–∞—è –∏–∑–æ–ª—è—Ü–∏—è, –æ–±–µ—Ä—Ç–∫–∏ API, –≤–∞–ª–∏–¥–∞—Ü–∏—è entry points
* NUMA-aware –∑–∞–≥—Ä—É–∑–∫–∞ –∏ –∫–µ—à-–∞—Ñ—Ñ–∏–Ω–Ω–æ—Å—Ç—å –º–æ–¥—É–ª–µ–π

## üìÅ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/plugins/loader.c`
* `include/plugin_loader.h`
* `src/security/sandbox.c`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –ò–º—è              | –ü—Ä–æ—Ç–æ—Ç–∏–ø                              | –û–ø–∏—Å–∞–Ω–∏–µ                             |
| ---------------- | ------------------------------------- | ------------------------------------ |
| plugin\_load     | `bool plugin_load(const char *path);` | –ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏                  |
| plugin\_register | `bool plugin_register(void *handle);` | –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è entry points |
| plugin\_sandbox  | `bool plugin_sandbox(pid_t pid);`     | –ó–∞–ø—É—Å–∫ –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π —Å—Ä–µ–¥–µ          |
| plugin\_unload   | `bool plugin_unload(void *handle);`   | –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è                    |

## üîÆ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/plugin_loader_test.c`
* Fuzz: AFL++ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–æ–≤ ELF / PE
* Stress: –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ —Ü–∏–∫–ª—ã –∑–∞–≥—Ä—É–∑–∫–∏/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* –ù–µ–≤–æ–∑–º—É—â–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ < 20 –º—Å
* –û—Ç–≤–µ—Ç –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é API < 5 –º—Å

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                 | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                  |
| ------------------------ | ------ | ---------------------------- |
| –î–∏–Ω–∞–º–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏        | 100    | –ë–µ–∑ —Ä–µ—Å—Ç–∞—Ä—Ç–∞ –∏ —Å –æ—Ç–∫–∞—Ç–æ–º API |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Å–∞–Ω–¥–±–æ–∫—Å—ã | 100    | –°–µ–∫—å—é—Ä–Ω—ã–π PID/—Ç—Ä–∞–ø—ã/—Ñ–æ—Ä–∫     |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤       | 95     | ELF / PE / Mach-O            |

## üìå –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
void *handle = dlopen("/usr/lib/udb/modules/libmy_ext.so", RTLD_NOW);
if (handle) {
   plugin_register(handle);
}
```

## üß∞ –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –º–æ–¥—É–ª–µ–π (–∑–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ HTTP/S)
* –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –ø–æ–¥–ø–∏—Å—å –ø–ª–∞–≥–∏–Ω–æ–≤
* –†–æ–ª–µ–≤–æ–π –¥–æ—Å—Ç—É–ø –∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º –º–æ–¥—É–ª—è–º

## üîç UML-–¥–∏–∞–≥—Ä–∞–º–º–∞ (PlantUML)

```plantuml
@startuml
package "9.2 –í–Ω–µ—à–Ω–∏–µ –º–æ–¥—É–ª–∏" {
  [plugin_loader.c] --> [plugin_register]
  [plugin_register] --> [plugin_sandbox]
  [plugin_sandbox] --> [plugin_unload]
}
@enduml
```

## üìÑ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–ª–∞–≥–∏–Ω–æ–≤ –¥–ª—è ERP/–í

