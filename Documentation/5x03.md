# 5.3 ‚Äî Time Series –∏ Downsampling

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 5 ‚Äî BI, ML –∏ OLAP**
**–ë–ª–æ–∫ 5.3 ‚Äî Time Series –∏ Downsampling (—Ä—è–¥—ã –≤—Ä–µ–º–µ–Ω–∏, —Ä–µ—Ç–µ–Ω—à–Ω, —Å–∂–∞—Ç–∏–µ)**

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ Time Series –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞—Ç–∏–≤–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤ —Å –Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –æ–ø–µ—Ä–∞—Ü–∏–π –Ω–∞–¥ –æ–∫–Ω–∞–º–∏ –≤—Ä–µ–º–µ–Ω–∏, —Å–∂–∞—Ç–∏—è, —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–∏—è, —Ä–µ—Ç–µ–Ω—à–Ω-–ø–æ–ª–∏—Ç–∏–∫.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞          | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                      |
| ------------------- | --------------------------------------------- |
| Time Series storage | –§–æ—Ä–º–∞—Ç—ã TSColumn + timestamp index            |
| Gap-fill            | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: linear, LOCF, ZOH                |
| Downsampling        | –ê–≥—Ä–µ–≥–∞—Ü–∏–∏: avg, min, max, median, percentiles |
| Retention policy    | TTL, compression, auto-purge                  |
| Window functions    | –û–∫–Ω–∞: fixed, sliding, hopping                 |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct ts_segment_t {
  timestamp_t *timestamps;
  double *values;
  uint32_t count;
  bool gap_fill_enabled;
  uint8_t compression_type; // 0=none, 1=delta, 2=for
} ts_segment_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
TimeSeriesEngine --> StorageEngine
TimeSeriesEngine --> QueryPlanner
TimeSeriesEngine --> Aggregator
TimeSeriesEngine --> VacuumManager
TimeSeriesEngine --> RetentionPolicy
```

## üßê –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –°–µ–≥–º–µ–Ω—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤ (vectorized, SIMD-enabled)
* –†–µ–∂–∏–º –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è + —Å–∂–∞—Ç–∏–µ –ø–æ –¥–µ–ª—å—Ç–µ –∏ —Å—Å—ã–ª–æ—á–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º
* –°–∫–æ–∑—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ time\_bucket(), ts\_downsample(), gap\_fill()

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/ts/ts_engine.c`
* `src/ts/ts_gapfill.c`
* `src/ts/ts_retention.c`
* `include/ts/ts_api.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è               | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                | –û–ø–∏—Å–∞–Ω–∏–µ                               |
| ----------------- | ----------------------------------------------------------------------- | -------------------------------------- |
| `ts_append_point` | `int ts_append_point(ts_id_t id, timestamp_t ts, double val);`          | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—á–∫–∏ –≤ TS-—Ä—è–¥              |
| `ts_downsample`   | `rowset_t *ts_downsample(ts_id_t id, interval_t win, const char *agg);` | –°–∂–∞—Ç–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ä—è–¥–∞                 |
| `ts_gap_fill`     | `rowset_t *ts_gap_fill(ts_id_t id, range_t r);`                         | –í—Å—Ç–∞–≤–∫–∞ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π           |
| `ts_gc_segments`  | `void ts_gc_segments(void);`                                            | –§–æ–Ω–æ–≤–∞—è —Å–±–æ—Ä–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö TS-—Å–µ–≥–º–µ–Ω—Ç–æ–≤ |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/ts/test_ts_engine.c`
* Fuzz: –≥—Ä–∞–Ω–∏—á–Ω—ã–µ ts\_downsample(–ø—É—Å—Ç—ã–µ, –Ω–µ–ø–æ–ª–Ω—ã–µ –æ–∫–Ω–∞)
* Coverage: 97.2%

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è             | –ú–µ—Ç—Ä–∏–∫–∞                       |
| -------------------- | ----------------------------- |
| Write throughput     | > 2.5 –º–ª–Ω —Ç–æ—á–µ–∫/—Å –Ω–∞ 64 —è–¥—Ä–∞—Ö |
| Downsampling 1B rows | < 4.5 —Å–µ–∫ –ø–æ 256 –∫—É–±–∞–º        |
| GC latency           | < 10 –º—Å –¥–ª—è 500K —Å–µ–≥–º–µ–Ω—Ç–æ–≤    |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                       | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                    |
| ------------------------------ | ------ | ---------------------------------------------- |
| TS-—Ç–∏–ø—ã —Å nanosecond —Ç–æ—á–Ω–æ—Å—Ç—å—é | 100    | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ                                    |
| Gap fill / Downsampling        | 100    | –§—É–Ω–∫—Ü–∏–∏ ts\_gap\_fill(), ts\_downsample() –Ω–∞ C |
| Retention / TTL                | 100    | –§–æ–Ω–æ–≤–æ–π GC, —É–¥–∞–ª–µ–Ω–∏–µ expired —Ü–µ–ø–æ—á–µ–∫           |

## üìå –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```sql
-- –°–æ–∑–¥–∞–Ω–∏–µ TS-—Ä—è–¥–∞
CREATE TABLE temperature_ts (
  ts TIMESTAMP(9),
  value DOUBLE
) WITH (ts_column = 'ts');

-- Downsampling
SELECT time_bucket('5 min', ts) as window, avg(value)
FROM temperature_ts
WHERE ts BETWEEN now() - interval '1 hour' AND now()
GROUP BY window;
```

## üßé‚Äç‚ôÇÔ∏è –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ irregular sampling –∏ uneven buckets
* –†–µ–∂–∏–º forecast –∏ extrapolate()
* –ö–æ–º–ø–∞–∫—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ TS-—Ä—è–¥–æ–≤ –≤ column-store

