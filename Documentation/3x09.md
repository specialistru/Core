# ðŸ§± Ð‘Ð»Ð¾Ðº 3.9 â€” Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ñ SQL: FILTER, MATCH\_RECOGNIZE, MERGE

---

## ðŸ†” Ð˜Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð±Ð»Ð¾ÐºÐ°

* **ÐŸÐ°ÐºÐµÑ‚:** 3 â€” SQL Ð¸ Ð¯Ð·Ñ‹ÐºÐ¸
* **Ð‘Ð»Ð¾Ðº:** 3.9 â€” Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ñ SQL: FILTER, MATCH\_RECOGNIZE, MERGE

---

## ðŸŽ¯ ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ

Ð‘Ð»Ð¾Ðº Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸ÑŽ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ñ‹Ñ… SQL-ÐºÐ¾Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¹, Ð¿Ð¾Ð²Ñ‹ÑˆÐ°ÑŽÑ‰Ð¸Ñ… Ð²Ñ‹Ñ€Ð°Ð·Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ ÑÐ·Ñ‹ÐºÐ° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²: `FILTER` (Ð´Ð»Ñ Ð°Ð³Ñ€ÐµÐ³Ð°Ñ†Ð¸Ð¸ Ñ ÑƒÑÐ»Ð¾Ð²Ð¸ÐµÐ¼), `MERGE` (upsert-Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸), Ð¸ `MATCH_RECOGNIZE` (Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ ÑˆÐ°Ð±Ð»Ð¾Ð½Ð¾Ð² Ð²Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ñ€ÑÐ´Ð°Ñ…). Ð­Ñ‚Ð¸ ÐºÐ¾Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹ Ð´Ð»Ñ BI- Ð¸ real-time-Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¸, Ð³Ð´Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð° Ð²Ñ‹ÑÐ¾ÐºÐ°Ñ Ð¿Ð»Ð¾Ñ‚Ð½Ð¾ÑÑ‚ÑŒ Ð²Ñ‹Ñ€Ð°Ð¶Ð°ÐµÐ¼Ð¾Ð¹ Ð»Ð¾Ð³Ð¸ÐºÐ¸ Ð±ÐµÐ· Ð¿Ñ€Ð¾Ñ†ÐµÐ´ÑƒÑ€Ð½Ð¾Ð³Ð¾ ÐºÐ¾Ð´Ð°.

## âš™ï¸ Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ

| ÐŸÐ¾Ð´ÑÐ¸ÑÑ‚ÐµÐ¼Ð°       | Ð ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ / Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸                                                       |
| ---------------- | ------------------------------------------------------------------------------ |
| FILTER           | ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Ð² Ð°Ð³Ñ€ÐµÐ³Ð°Ñ‚Ð½Ñ‹Ñ… Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑÑ…: `COUNT(*) FILTER (WHERE x > 0)`               |
| MERGE            | ANSI SQL:2011 MERGE Ñ ÑƒÑÐ»Ð¾Ð²Ð¸ÑÐ¼Ð¸ Ð¸ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¾Ð¹ INSERT/UPDATE/DELETE              |
| MATCH\_RECOGNIZE | ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ñ€Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ð²Ð°Ð½Ð¸Ðµ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ñ€ÐµÐ³ÑƒÐ»ÑÑ€Ð½Ñ‹Ñ… Ð²Ñ‹Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹ Ð½Ð°Ð´ Ð¾ÐºÐ½Ð°Ð¼Ð¸ |
| TIME PATTERN DSL | Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ñ‹Ð¹ ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ: `DEFINE`, `MEASURES`, `AFTER MATCH SKIP`                |
| ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ      | ÐŸÐµÑ€ÐµÐ¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ MERGE Ð¸ MATCH Ð¿Ð¾ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐµ Ð¸ NDV                             |

## ðŸ’¾ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…

MATCH\_RECOGNIZE Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ Ð¿Ñ€Ð¾Ð¼ÐµÐ¶ÑƒÑ‚Ð¾Ñ‡Ð½Ñ‹Ð¹ automaton cache:

```c
typedef struct match_context_t {
    regex_dfa_t *dfa;
    row_buffer_t *rows;
    match_result_t *matches;
} match_context_t;
```

## ðŸ”„ Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¸ ÑÐ²ÑÐ·Ð¸

```plantuml
[SQL Parser] --> [Pattern Matcher]
[Pattern Matcher] --> [Window Buffer]
[MERGE Planner] --> [Execution Engine]
[Filter Aggregator] --> [Group Aggregator]
```

## ðŸ§  ÐžÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸

* Ð ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ NFA/DFA-ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ‚Ð¾Ñ€Ð° Ð¸Ð· `DEFINE` ÑÐµÐºÑ†Ð¸Ð¹ MATCH\_RECOGNIZE
* MERGE Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ñ MVCC snapshot, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑ upsert-Ñ€ÐµÐ¶Ð¸Ð¼ Ð±ÐµÐ· race conditions
* FILTER Ñ€ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½ ÐºÐ°Ðº predicate pushdown Ð² Ð°Ð³Ñ€ÐµÐ³Ð°Ñ‚Ð½Ñ‹Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñ‹
* ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° skip strategies: `SKIP TO NEXT ROW`, `SKIP PAST LAST ROW`

## ðŸ“‚ Ð¡Ð²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ Ð¼Ð¾Ð´ÑƒÐ»Ð¸ ÐºÐ¾Ð´Ð°

* `src/sql/extensions/filter_agg.c`
* `src/sql/extensions/merge_stmt.c`
* `src/sql/extensions/match_recognize.c`
* `include/sql/extensions/`

## ðŸ”§ ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð½Ð° C

| Ð˜Ð¼Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸           | ÐŸÑ€Ð¾Ñ‚Ð¾Ñ‚Ð¸Ð¿                                                             | ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ                                                 |
| --------------------- | -------------------------------------------------------------------- | -------------------------------------------------------- |
| `merge_exec`          | `int merge_exec(sql_stmt_t *stmt, db_session_t *sess);`              | Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ MERGE-Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ñ upsert-ÑÐµÐ¼Ð°Ð½Ñ‚Ð¸ÐºÐ¾Ð¹             |
| `filter_agg_apply`    | `int filter_agg_apply(agg_fn_t *fn, row_t *row, bool cond);`         | ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ FILTER-ÑƒÑÐ»Ð¾Ð²Ð¸Ñ Ðº Ð°Ð³Ñ€ÐµÐ³Ð°Ñ‚Ð½Ð¾Ð¹ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸           |
| `match_recognize_run` | `int match_recognize_run(match_context_t *ctx, row_buffer_t *rows);` | Ð—Ð°Ð¿ÑƒÑÐº Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð½Ð¾Ð³Ð¾ ÑˆÐ°Ð±Ð»Ð¾Ð½Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð¸ÑÐºÐ° Ð¿Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼ Ð´Ð°Ð½Ð½Ñ‹Ð¼ |

## ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

* Ð®Ð½Ð¸Ñ‚: `tests/sql/extensions/merge_test.c`, `match_test.c`
* Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ: MERGE + MVCC, MATCH + WINDOW, FILTER + GROUP BY
* Soak: ÑÐµÑ€Ð¸Ñ MERGE-Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð² OLTP/OLAP-ÑÐ¼ÐµÑˆÐ°Ð½Ð½Ð¾Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼Ðµ
* ÐŸÐ¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ: 93% MATCH\_RECOGNIZE, 88% MERGE execution

## ðŸ“Š ÐŸÑ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ

* MERGE throughput: 150K UPSERT/ÑÐµÐº
* MATCH\_RECOGNIZE latency: 0.5â€“1.2 Ð¼Ñ/ÑˆÐ°Ð±Ð»Ð¾Ð½ Ð½Ð° Ð¾ÐºÐ½Ð¾ 1000 ÑÑ‚Ñ€Ð¾Ðº
* FILTER Ð°Ð³Ñ€ÐµÐ³Ð°Ñ‚Ñ‹: overhead \~0.8% Ð¿Ð¾ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸ÑŽ Ñ Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾Ð¹ Ð°Ð³Ñ€ÐµÐ³Ð°Ñ†Ð¸ÐµÐ¹

## âœ… Ð¡Ð¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ SAP HANA+

| ÐšÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¹         | ÐžÑ†ÐµÐ½ÐºÐ° | ÐšÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹                                                          |
| ---------------- | ------ | -------------------------------------------------------------------- |
| FILTER           | 100    | ÐŸÐ¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð¾ Ð² ÑÑ‚Ð¸Ð»Ðµ SQL:2011                               |
| MERGE            | 95     | ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°, Ð½ÐµÑ‚ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸ MERGE ... WHEN NOT MATCHED BY SOURCE |
| MATCH\_RECOGNIZE | 90     | Ð ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½ NFA->DFA, Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Ð±Ð¾Ð»ÑŒÑˆÐ¸Ð½ÑÑ‚Ð²Ð° ÑÑ‚Ñ€Ð°Ñ‚ÐµÐ³Ð¸Ð¹                 |

## ðŸ“Ž ÐŸÑ€Ð¸Ð¼ÐµÑ€ ÐºÐ¾Ð´Ð°

```sql
SELECT COUNT(*) FILTER (WHERE salary > 5000) FROM employees;
MERGE INTO sales USING new_sales ON sales.id = new_sales.id
WHEN MATCHED THEN UPDATE SET amount = new_sales.amount
WHEN NOT MATCHED THEN INSERT VALUES (...);

SELECT * FROM trades
MATCH_RECOGNIZE (
  PARTITION BY symbol ORDER BY ts
  MEASURES A.ts AS start_ts, B.ts AS end_ts
  PATTERN (A B+)
  DEFINE B AS B.price > PREV(B.price)
);
```

## ðŸ§© Ð‘ÑƒÐ´ÑƒÑ‰Ð¸Ðµ Ð´Ð¾Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸

* ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° `MERGE ... WHEN NOT MATCHED BY SOURCE`
* Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ðµ MATCH DSL: `WITHIN INTERVAL`, nested patterns
* Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ pattern\_score() Ð¸ explain\_pattern()

## ðŸ§° Ð¡Ð²ÑÐ·ÑŒ Ñ Ð±Ð¸Ð·Ð½ÐµÑ-Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑÐ¼Ð¸

* BI-Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ° ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹ Ð¸ Ñ†ÐµÐ¿Ð¾Ñ‡ÐµÐº (MATCH\_RECOGNIZE)
* ÐœÐ°ÑÑÐ¾Ð²Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¿Ñ€Ð°Ð²Ð¾Ñ‡Ð½Ð¸ÐºÐ¾Ð² Ð¸ Ñ„Ð°ÐºÑ‚Ð¾Ð² (MERGE)
* ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒ Ð°Ð³Ñ€ÐµÐ³Ð°Ñ‚Ð¾Ð² Ñ ÑƒÑÐ»Ð¾Ð²Ð¸ÑÐ¼Ð¸ (FILTER â†’ KPI)

## ðŸ” Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ñ…

* ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° ÑÐ¾Ð²Ð¿Ð°Ð´ÐµÐ½Ð¸Ð¹ Ð² MATCH Ð´Ð»Ñ Ð¿Ñ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ñ DoS
* Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ñ MERGE-Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹ Ð¿Ð¾ ACL/Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€Ð°Ð¼
* ÐŸÑ€ÐµÐ´Ð¸ÐºÐ°Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° Ð½Ð° FILTER

## ðŸ§¾ Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ, Ð¾ÑˆÐ¸Ð±ÐºÐ¸, Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ñ

* `ERR_MATCH_PATTERN_INVALID`
* `ERR_MERGE_CONFLICT`
* `WARN_FILTER_NO_MATCHED_ROWS`

## ðŸ•“ Ð’ÐµÑ€ÑÐ¸Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹

* v1.0 â€” FILTER + MERGE (basic), MATCH\_RECOGNIZE parser
* v1.1 â€” DFA runtime, pattern skip strategies, partial match tracing

## ðŸ“ˆ UML-Ð´Ð¸Ð°Ð³Ñ€Ð°Ð¼Ð¼Ð°

```plantuml
@startuml
package "SQL Extensions" {
  class MergeEngine {
    +exec()
  }
  class PatternMatcher {
    +run()
  }
  class FilterAggregator {
    +apply()
  }
  MergeEngine --> MVCC
  PatternMatcher --> WindowBuffer
  FilterAggregator --> Aggregator
}
@enduml
```
