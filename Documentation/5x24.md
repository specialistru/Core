# 5.24 ‚Äî –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã –∏ –∞–≥—Ä–µ–≥–∞—Ç—ã (TS Types, Downsampling, Retention)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 5 ‚Äî BI, ML –∏ OLAP**
**–ë–ª–æ–∫ 5.24 ‚Äî –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã –∏ –∞–≥—Ä–µ–≥–∞—Ç—ã**

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ö—Ä–∞–Ω–µ–Ω–∏—è, –∞–Ω–∞–ª–∏–∑–∞ –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤. –ö–ª—é—á–µ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏: downsampling, gap-fill, retention, rollup.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞       | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏               |
| ---------------- | -------------------------------------- |
| TS —Ç–∏–ø—ã          | ts\_double, ts\_int, ts\_timestamp     |
| Downsampling     | avg, min, max, first, last, count      |
| Gap-fill         | –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è, LOCF, –ª–∏–Ω–µ–π–Ω–∞—è —Ä–µ–≥—Ä–µ—Å—Å–∏—è |
| Retention Policy | TTL-–¥–∞–Ω–Ω—ã–µ, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–µ–∂–∏–º–æ–≤ hot/cold |

## üíæ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è

```c
typedef struct ts_point_t {
  timestamp_ns_t ts;
  union {
    double dval;
    int64_t ival;
  } value;
  ts_type_t type;
} ts_point_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```plantuml
TimeSeriesEngine --> ColumnStore
TimeSeriesEngine --> BufferManager
TimeSeriesEngine --> SQLParser
TimeSeriesEngine --> StorageRetention
```

## üßê –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è (shard –∏ time-range)
* NUMA-aware —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä—è–¥–æ–≤
* Hot-path —á—Ç–µ–Ω–∏–µ —á–µ—Ä–µ–∑ SIMD

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

* `src/ts/ts_engine.c`
* `src/ts/downsampling.c`
* `src/ts/gapfill.c`
* `include/ts/ts_point.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –ò–º—è               | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                   | –û–ø–∏—Å–∞–Ω–∏–µ                  |
| ----------------- | ---------------------------------------------------------- | ------------------------- |
| `ts_insert_point` | `int ts_insert_point(table_t*, ts_point_t*)`               | –í—Å—Ç–∞–≤–∫–∞ —Ç–æ—á–∫–∏ —Ä—è–¥–∞        |
| `ts_downsample`   | `int ts_downsample(ts_range_t*, agg_type_t, ts_output_t*)` | Downsampling –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É |
| `ts_gap_fill`     | `int ts_gap_fill(ts_series_t*, gapfill_method_t)`          | –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–æ–≤      |
| `ts_gc_expire`    | `int ts_gc_expire(table_t*, timestamp_ns_t cutoff)`        | Retention –æ—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö  |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/ts/test_ts_engine.c`
* Soak: 10M —Ç–æ—á–µ–∫ –Ω–∞ –≤—Å—Ç–∞–≤–∫—É –≤ —Å–µ–∫—É–Ω–¥—É
* Fuzz: —Ä–∞–∑–±—Ä–æ—Å –ø–æ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ TS

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –°—Ü–µ–Ω–∞—Ä–∏–π           | –ó–∞–¥–µ—Ä–∂–∫–∞ / –æ–±—ä—ë–º |
| ------------------ | ---------------- |
| –í—Å—Ç–∞–≤–∫–∞ 10M —Ç–æ—á–µ–∫  | < 1.2 —Å–µ–∫        |
| Downsample 1y —Ä—è–¥–∞ | < 350 –º—Å         |
| Gap-fill 7 –¥–Ω–µ–π    | < 80 –º—Å          |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                 | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                       |
| ------------------------ | ------ | --------------------------------- |
| Native TimeSeries types  | 100    | ts\_point\_t, ts\_double, ts\_int |
| Downsampling, retention  | 100    | –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –æ–∫–Ω–∞, TTL            |
| SQL –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ gapfill | 100    | gapfill, rollup —Ñ—É–Ω–∫—Ü–∏–∏           |

## üìå –ü—Ä–∏–º–µ—Ä

```sql
SELECT time_bucket('1h', ts), avg(value)
FROM metrics_ts
WHERE name = 'cpu_usage'
AND ts > now() - interval '7 days'
GROUP BY 1
```

## üß∞ –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* Materialized views for TS aggregates
* Adaptive retention based on usage
* Streaming ingest API

## üé≠ UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity "SQLParser" as SQL
entity "TimeSeriesEngine" as TSE
entity "ColumnStore" as COL
entity "StorageRetention" as RET

SQL --> TSE
TSE --> COL
TSE --> RET
@enduml
```

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–Ω–∞–ª–∏–∑ –Ω–∞–≥—Ä—É–∑–æ–∫
* –î–µ—Ç–µ–∫—Ü–∏—è –ø–∏–∫–æ–≤, —Ç—Ä–µ–Ω–¥–æ–≤
* SLA –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤ —Ü–µ–ø–æ—á–∫–µ –ø–æ—Å—Ç–∞–≤–æ–∫

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ access –∫ TS —Ç–∏–ø–∞–º
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å row-level security

## üìä –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

* v1.0 ‚Äî TS —Ç–∏–ø—ã –∏ –≤—Å—Ç–∞–≤–∫–∞
* v1.1 ‚Äî downsampling + gapfill
* v1.2 ‚Äî TTL retention engine

## ‚ö†Ô∏è –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

| –ö–æ–¥ / –¢–∏–ø            | –£—Å–ª–æ–≤–∏–µ                 | –û–ø–∏—Å–∞–Ω–∏–µ                  |
| -------------------- | ----------------------- | ------------------------- |
| E\_TS\_BAD\_TYPE     | –ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π TS —Ç–∏–ø     | –¢–∏–ø –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Å—Ö–µ–º–æ–π |
| E\_TS\_GAPFILL\_FAIL | –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏ | Gap-fill –Ω–µ —É—Å–ø–µ—à–µ–Ω       |


