# 8.1 ‚Äî –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏ (Latency Profiling & Low-Latency OLTP)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 8 ‚Äî –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
**–ë–ª–æ–∫ 8.1 ‚Äî –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏ (Latency Profiling & Low-Latency OLTP)**

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –±–ª–æ–∫ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Å–≤–µ—Ä—Ö–Ω–∏–∑–∫–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ OLTP-–æ–ø–µ—Ä–∞—Ü–∏–π (Online Transaction Processing) –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö <1 –º—Å, –≤–∫–ª—é—á–∞—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—É—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ (<500 –Ω—Å). –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–∫—É—Å ‚Äî –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–µ–∫ –≤ —Ü–µ–ø–æ—á–∫–∞—Ö –≤—ã–∑–æ–≤–æ–≤, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è–º–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤, NUMA-aware –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞              | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                |
| ----------------------- | ------------------------------------------------------- |
| –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–µ–∫ | –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤—â–∏–∫, –∑–∞–ø–∏—Å—å timeline –∫–∞–∂–¥–æ–≥–æ –≤—ã–∑–æ–≤–∞ |
| –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—É—Ç—å        | –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —è–¥—Ä–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è (executor, plan cache)      |
| OLTP –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è        | –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤, hot-path bypass    |
| NUMA-aware –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ   | CPU affinity, memory locality                           |
| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –æ—á–µ—Ä–µ–¥–∏    | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ –≤ –¥–∏—Å–ø–∞—Ç—á–µ—Ä–µ –ø–ª–∞–Ω–æ–≤              |

## üíæ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è

```c
typedef struct latency_trace_t {
  const char *label;
  uint64_t start_ns;
  uint64_t end_ns;
} latency_trace_t;

typedef struct oltp_metrics_t {
  uint64_t tx_count;
  double avg_latency_ns;
  double p99_latency_ns;
} oltp_metrics_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[Executor] --> [LatencyProfiler]
[LatencyProfiler] --> [MetricsEngine]
[LatencyProfiler] --> [PlanCache]
[LatencyProfiler] --> [NUMAAllocator]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ TSC (Time Stamp Counter) –¥–ª—è –Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏
* Hot-path —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞: –≤—ã–¥–µ–ª–µ–Ω–∏–µ fast/slow –≤–µ—Ç–æ–∫ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è
* –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ call stack –ø–æ –∫–ª—é—á–µ–≤—ã–º —Ç–æ—á–∫–∞–º –ø–ª–∞–Ω–æ–≤
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å perf –∏ flamegraph

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/exec/latency_profiler.c`
* `src/exec/oltp_executor.c`
* `include/exec/latency_trace.h`
* `src/metrics/oltp_metrics.c`
* `include/metrics/oltp_metrics.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –ò–º—è                   | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                    | –û–ø–∏—Å–∞–Ω–∏–µ                                           |
| --------------------- | ----------------------------------------------------------- | -------------------------------------------------- |
| `latency_start`       | `void latency_start(latency_trace_t *t, const char *label)` | –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—á–∞–ª–æ —Å–æ–±—ã—Ç–∏—è                       |
| `latency_end`         | `void latency_end(latency_trace_t *t)`                      | –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–µ—Ü —Å–æ–±—ã—Ç–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –º–µ—Ç—Ä–∏–∫–∞—Ö |
| `oltp_record_metrics` | `void oltp_record_metrics(uint64_t dur_ns)`                 | –û–±–Ω–æ–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫–∏ –∏ p99 latency                    |
| `latency_log_flame`   | `void latency_log_flame(void)`                              | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è flamegraph –ª–æ–≥–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏   |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/exec/test_latency_profiler.c`
* Integration: –∑–∞–º–µ—Ä—ã –Ω–∞ hot-query –Ω–∞–≥—Ä—É–∑–∫–µ
* Soak: –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ 10M+ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
* Perf: —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–π –¥–æ/–ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                       | –ó–Ω–∞—á–µ–Ω–∏–µ               |
| ----------------------------- | ---------------------- |
| –°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ OLTP | 0.87 –º—Å                |
| –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞          | < 470 –Ω—Å               |
| Throughput                    | > 2.2 –º–ª–Ω —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π/—Å |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                       | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                     |
| ------------------------------ | ------ | ------------------------------- |
| –ó–∞–¥–µ—Ä–∂–∫–∞ OLTP < 1 –º—Å           | 100    | –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç         |
| –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–æ—á–µ–∫ | 100    | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å TSC –∏ flamegraph   |
| NUMA-aware –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ          | 100    | CPU-pinning, –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–æ–≤ |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
latency_trace_t trace;
latency_start(&trace, "insert_order");

executor_run_query(...);

latency_end(&trace);
oltp_record_metrics(trace.end_ns - trace.start_ns);
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å eBPF –¥–ª—è kernel-level –∑–∞–¥–µ—Ä–∂–µ–∫
* –ê–≤—Ç–æ–∞–Ω–∞–ª–∏–∑ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ runtime
* –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è hot tables –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–µ

## üìä UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity "Executor" as EX
entity "LatencyProfiler" as LAT
entity "MetricsEngine" as MET
entity "PlanCache" as PC
entity "NUMAAllocator" as NUMA

EX --> LAT
LAT --> MET
LAT --> PC
LAT --> NUMA
@enduml
```

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ real-time —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ ERP, POS –∏ CRM
* SLA-–∫–æ–Ω—Ç—Ä–æ–ª—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–∫–ª–∏–∫–∞ –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª–∏–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤—ã—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –í—Å–µ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ –≤ sandbox
* –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –∏—Å–∫–ª—é—á–∞–µ—Ç —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
* RBAC-–∑–∞—â–∏—Ç–∞ –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –±–∞–∑–æ–≤–∞—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ TSC
* v1.1 ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ NUMA-aware latency path
* v1.2 ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å perf, p99 –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ

## üõë –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

| –ö–æ–¥ / –¢–∏–ø          | –£—Å–ª–æ–≤–∏–µ                  | –û–ø–∏—Å–∞–Ω–∏–µ                               |
| ------------------ | ------------------------ | -------------------------------------- |
| `W_LATENCY_HIGH`   | –ó–∞–¥–µ—Ä–∂–∫–∞ > 1 –º—Å          | –ó–∞–ø—Ä–æ—Å –ø—Ä–µ–≤—ã—Å–∏–ª –æ–∂–∏–¥–∞–µ–º—É—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å |
| `I_TRACE_DISABLED` | –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ | –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ –∑–∞–¥–µ—Ä–∂–∫–∞–º –Ω–µ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è     |
