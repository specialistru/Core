# üß± –ë–ª–æ–∫ 7.7 ‚Äî Crash Recovery –∏ Full Restart Logic

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 7 ‚Äî Observability –∏ DevOps
* **–ë–ª–æ–∫:** 7.7 ‚Äî Crash Recovery –∏ Full Restart Logic

---

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –∞–≤–∞—Ä–∏–π–Ω—ã—Ö –æ—Å—Ç–∞–Ω–æ–≤–æ–≤, –≤–∫–ª—é—á–∞—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è in-memory —Ç–∞–±–ª–∏—Ü, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö —Ü–µ–ø–æ—á–µ–∫, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, WAL-–∂—É—Ä–Ω–∞–ª–∞ –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö. –†–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –∫–∞–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∏ –≥–∞—Ä–∞–Ω—Ç–∏–∏ —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–ª–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π snapshot-based recovery, parallel replay WAL –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —É–∑–ª–æ–≤.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞             | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                            |
| ---------------------- | ------------------------------------------------------------------- |
| WAL replay             | –ü–æ—Ç–æ–∫–æ–≤–∞—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∂—É—Ä–Ω–∞–ª–æ–≤                           |
| Snapshot recovery      | –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–∞–ª–∏–¥–Ω–æ–≥–æ —Å–Ω–∏–º–∫–∞ –≤ NUMA-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–∞–º—è—Ç—å |
| Distributed recovery   | –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö –Ω–æ–¥–∞—Ö (Raft/Paxos)             |
| Recovery planner       | –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º (B-–¥–µ—Ä–µ–≤—å—è, MVCC)        |
| –ú–µ—Ç—Ä–∏–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è | –í—Ä–µ–º—è, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π, –ø–æ—Ç–µ—Ä–∏                                  |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct crash_recovery_ctx_t {
  snapshot_t *snapshot;
  wal_iterator_t *wal_iter;
  bool distributed_mode;
  uint64_t recovery_start_ts;
} crash_recovery_ctx_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[Crash Recovery Engine] --> [WAL Manager]
[Crash Recovery Engine] --> [Snapshot Loader]
[Crash Recovery Engine] --> [Storage Engine]
[Crash Recovery Engine] --> [Transaction Manager]
[Crash Recovery Engine] --> [Cluster Manager]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* NUMA-aware recovery –±—É—Ñ–µ—Ä—ã
* Replay WAL —Å –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–æ–º –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ–≥–º–µ–Ω—Ç–æ–≤
* –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å —Ç–∞–π–º–∞—É—Ç–∞–º–∏

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/recovery/crash_recovery.c`
* `src/storage/wal_replay.c`
* `src/snapshot/snapshot_loader.c`
* `src/cluster/distributed_recovery.c`
* `include/recovery/recovery_ctx.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –ò–º—è                      | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                               | –û–ø–∏—Å–∞–Ω–∏–µ                                |
| ------------------------ | ------------------------------------------------------ | --------------------------------------- |
| `recovery_run`           | `int recovery_run(crash_recovery_ctx_t *ctx)`          | –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è  |
| `recovery_apply_wal`     | `int recovery_apply_wal(wal_iterator_t *iter)`         | –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π WAL |
| `recovery_load_snapshot` | `snapshot_t *recovery_load_snapshot(const char *path)` | –ó–∞–≥—Ä—É–∑–∫–∞ —Å–Ω–∏–º–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–∞–∑—ã          |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Integration: –∞–≤–∞—Ä–∏–π–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ + –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
* Mutation: –∏—Å–∫–∞–∂–µ–Ω–∏–µ WAL –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ fallback-–ª–æ–≥–∏–∫–∏
* Stress: 10M+ –∑–∞–ø–∏—Å–µ–π + —Å–±–æ–π –≤–æ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏
* Distributed tests: —Å–∏–º—É–ª—è—Ü–∏—è network partition –≤ recovery

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                      | –ó–Ω–∞—á–µ–Ω–∏–µ             |
| ---------------------------- | -------------------- |
| –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è | < 2.7 —Å              |
| –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å WAL   | > 150K –æ–ø–µ—Ä–∞—Ü–∏–π/—Å    |
| –ü–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–±–æ–µ       | 0 (–ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º WAL) |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                   | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                          |
| -------------------------- | ------ | ------------------------------------ |
| WAL replay                 | 100    | –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è, –±–µ–∑–æ–ø–∞—Å–Ω–∞—è             |
| Snapshot recovery          | 100    | –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ NUMA-aware     |
| Distributed crash recovery | 100    | –ß–µ—Ä–µ–∑ Raft + —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–µ —á–µ–∫–ø–æ–∏–Ω—Ç—ã |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
crash_recovery_ctx_t ctx = {
  .snapshot = recovery_load_snapshot("last.snapshot"),
  .wal_iter = wal_open_replay("wal.log"),
  .distributed_mode = true
};
recovery_run(&ctx);
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* Fast-path recovery –¥–ª—è hot tables
* –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ–º –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ recovery
* –°–∂–∞—Ç—ã–µ WAL-–±–ª–æ–∫–∏ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è

## üìä UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity "Crash Recovery Engine" as RE
entity "WAL Manager" as WAL
entity "Snapshot Loader" as SNAP
entity "Storage Engine" as ST
entity "Transaction Manager" as TX
entity "Cluster Manager" as CM

RE --> WAL
RE --> SNAP
RE --> ST
RE --> TX
RE --> CM
@enduml
```

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ì–∞—Ä–∞–Ω—Ç–∏—è –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ—Å—Ç–∏ –±–∏–∑–Ω–µ—Å–∞ –ø–æ—Å–ª–µ —Å–±–æ–µ–≤
* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ –ø–æ—Ç–µ—Ä—å
* –ó–∞—â–∏—Ç–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Å—É–º–º—ã WAL –∏ snapshot
* –ó–∞–ø—Ä–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤
* –ê—É–¥–∏—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –ª–æ–≥–∞—Ö —Å –∑–∞—â–∏—Ç–æ–π –¥–æ—Å—Ç—É–ø–∞

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –±–∞–∑–æ–≤–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ WAL
* v1.1 ‚Äî NUMA-aware snapshot recovery
* v1.2 ‚Äî parallel WAL replay + integrity checker
* v1.3 ‚Äî distributed node replay —á–µ—Ä–µ–∑ Raft –ª–æ–≥

## üõë –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

| –ö–æ–¥ / –¢–∏–ø            | –£—Å–ª–æ–≤–∏–µ                            | –û–ø–∏—Å–∞–Ω–∏–µ                                         |
| -------------------- | ---------------------------------- | ------------------------------------------------ |
| `E_REC_SNAP_INVALID` | –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å–Ω–∏–º–æ–∫                | –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ snapshot-—Ñ–∞–π–ª–∞ –∏–ª–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏–π —Ñ–æ—Ä–º–∞—Ç |
| `E_REC_WAL_CORRUPT`  | –ü–æ–≤—Ä–µ–∂–¥—ë–Ω WAL                      | –ù–∞—Ä—É—à–µ–Ω–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å WAL-–∂—É—Ä–Ω–∞–ª–∞                 |
| `I_REC_DONE`         | –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è | –ë–∞–∑–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –≤ —Ä–∞–±–æ—á–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ       |
