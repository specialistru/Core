# 5.2 ‚Äî BI: views, materialized views, adaptive cubes

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç**: 5 ‚Äî BI, ML –∏ OLAP
* **–ë–ª–æ–∫**: 5.2 ‚Äî BI: views, materialized views, adaptive cubes

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É –±–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π (views), –≤–∫–ª—é—á–∞—è –æ–±—ã—á–Ω—ã–µ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è, –∞ —Ç–∞–∫–∂–µ —Å–∏—Å—Ç–µ–º—É –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö –∞–≥—Ä–µ–≥–∞—Ç–æ–≤ –∏ –∫—É–±–æ–≤ –¥–ª—è OLAP-–Ω–∞–≥—Ä—É–∑–æ–∫. –û–Ω –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞—Ä–∞–Ω–µ–µ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞—Ç—å –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ –±–æ–ª—å—à–∏–º –æ–±—ä—ë–º–∞–º –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏, —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —Å–Ω–∏–∂–∞—è –∑–∞–¥–µ—Ä–∂–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–ª–æ–∂–Ω—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                      | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                          |
| ------------------------------- | --------------------------------------------------------------------------------- |
| –û–±—ã—á–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è           | –õ–æ–≥–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–∏ –Ω–∞–¥ SQL-–∑–∞–ø—Ä–æ—Å–∞–º–∏, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π       |
| –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, —Å—Ç—Ä–∞—Ç–µ–≥–∏–π refresh on demand –∏ async        |
| –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∞–≥—Ä–µ–≥–∞—Ç—ã             | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –∞–≥—Ä–µ–≥–∞—Ç–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è –ø–æ –∑–∞–ø—Ä–æ—Å—É, –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫ –∏ —á–∞—Å—Ç–æ—Ç—ã |
| –ö—É–±—ã                            | –†–æ–ª–ª–∞–ø/–¥—Ä–∏–ª–ª–¥–∞—É–Ω, precomputed –∞–≥—Ä–µ–≥–∞—Ç—ã, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ sparse/partial –∫—É–±–æ–≤            |
| Dependency Tracking             | –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –º–µ–∂–¥—É –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è–º–∏              |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

–ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏ –∫—É–±—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã —Å –º–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π:

```c
typedef struct matview_t {
    char *name;
    char *base_query;
    timestamp_t last_refresh;
    bool is_incremental;
} matview_t;

typedef struct cube_dim_t {
    char *dimension;
    bool is_sparse;
} cube_dim_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[BI Engine] --> [SQL –Ø–¥—Ä–æ]
[BI Engine] --> [–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞–Ω–∏–π]
[BI Engine] --> [–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –∞–≥—Ä–µ–≥–∞—Ç—ã]
[–ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è] --> [–•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö]
[BI Engine] --> [–ö–∞—Ç–∞–ª–æ–≥ —Å—Ö–µ–º]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ refresh policies: ON COMMIT, SCHEDULED, ON DEMAND
* –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Directed Acyclic Graph (DAG)
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ adaptive execution plan –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∞–≥—Ä–µ–≥–∞—Ç–æ–≤
* –°–∂–∞—Ç–∏–µ –∫—É–±–æ–≤: dictionary + RLE + frame-of-reference
* –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É–±–æ–≤ (multi-threaded)

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/bi/bi_engine.c`
* `include/bi/bi_engine.h`
* `src/bi/materialized_view.c`
* `include/bi/materialized_view.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏               | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                           | –û–ø–∏—Å–∞–Ω–∏–µ                                   |
| ------------------------- | ------------------------------------------------------------------ | ------------------------------------------ |
| `bi_create_view`          | `int bi_create_view(const char *name, const char *query);`         | –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è         |
| `bi_create_materialized`  | `int bi_create_materialized(const char *name, const char *query);` | –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è  |
| `bi_refresh_materialized` | `int bi_refresh_materialized(const char *name, bool incremental);` | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ MV (–ø–æ–ª–Ω–æ–µ –∏–ª–∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ) |
| `bi_query_cube`           | `int bi_query_cube(const char *cube_name, query_t *q);`            | –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –∫ –∫—É–±—É                  |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* –Æ–Ω–∏—Ç: `tests/bi/bi_view_test.c`, `tests/bi/bi_cube_test.c`
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ: —Å–∫–≤–æ–∑–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ BI-–Ω–∞–≥—Ä—É–∑–æ–∫
* Fuzz: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è DAG –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏
* –ü–æ–∫—Ä—ã—Ç–∏–µ: \~91% —Å—Ç—Ä–æ–∫, 100% —Ñ—É–Ω–∫—Ü–∏–π —è–¥—Ä–∞

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* Materialized View Refresh: 10‚Äì50 ms –ø—Ä–∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
* OLAP Query Latency: < 200 –º–∫—Å –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ç–æ–≤ –¥–æ 1M —Å—Ç—Ä–æ–∫
* Cube Build Time: \~50K row/sec –Ω–∞ –ø–æ—Ç–æ–∫, –ø—Ä–∏ 4+ —è–¥—Ä–∞—Ö ‚Äî –ª–∏–Ω–µ–π–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                           | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                             |
| ---------------------------------- | ------ | ------------------------------------------------------- |
| Views / Materialized Views         | 95     | –í—Å–µ –∫–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã, –Ω–µ–¥–æ—Å—Ç–∞—ë—Ç UI-–¥–∏–∑–∞–π–Ω–µ—Ä |
| –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∫—É–±—ã                    | 90     | –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –∞–≥—Ä–µ–≥–∞—Ç–æ–≤         |
| –ê–≤—Ç–æ-–∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –∏ Refresh Mechanism | 100    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π, DAG –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è  |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
bi_create_materialized("mv_sales_summary", 
    "SELECT region, SUM(sales) FROM orders GROUP BY region");

bi_refresh_materialized("mv_sales_summary", true);
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –í–∏–∑—É–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ –∞–≥—Ä–µ–≥–∞—Ç–æ–≤
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∞–≥—Ä–µ–≥–∞—Ü–∏–π –≤–Ω—É—Ç—Ä–∏ –∫—É–±–æ–≤
* Auto-tuning —á–∞—Å—Ç–æ—Ç—ã refresh –ø–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

## üß∞ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –≤–∏—Ç—Ä–∏–Ω –¥–ª—è –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏
* –ê–≥—Ä–µ–≥–∞—Ç—ã –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º, —Ñ–∏–ª–∏–∞–ª–∞–º, –∫–ª–∏–µ–Ω—Ç–∞–º
* OLAP-–∫—É–±—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–¥–∞–∂ –∏ —Ü–µ–ø–æ—á–µ–∫ –ø–æ—Å—Ç–∞–≤–æ–∫

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –†–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ BI-–∞–≥—Ä–µ–≥–∞—Ç–∞–º (row-level policies)
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ views —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ user-context
* –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è MV/–∫—É–±–æ–≤

## üßæ –°–æ–æ–±—â–µ–Ω–∏—è, –æ—à–∏–±–∫–∏, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

* `ERR_BI_VIEW_EXISTS`
* `WARN_CUBE_SPARSE_DIMENSION`
* `ERR_MV_REFRESH_FAILED`

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞ views, materialized views
* v1.1 ‚Äî –ö—É–±—ã –∏ DAG –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
* v1.2 ‚Äî –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∞–≥—Ä–µ–≥–∞—Ç—ã –∏ auto-refresh

## üìà UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
package "BI Engine" {
  class View {
    +name
    +query
  }
  class MaterializedView {
    +name
    +base_query
    +last_refresh
    +refresh()
  }
  class Cube {
    +dimensions
    +aggregates
    +build()
    +query()
  }

  View --> SQLCore
  MaterializedView --> Storage
  Cube --> Aggregator
}
@enduml
```
