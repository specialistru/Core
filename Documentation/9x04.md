# 9.6 â€” Ğ’Ğ½ĞµÑˆĞ½Ğ¸Ğµ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑÑ‹: REST, gRPC Ğ¸ JSON\:API

## ğŸ¢ Ğ˜Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ Ğ±Ğ»Ğ¾ĞºĞ°

* ĞŸĞ°ĞºĞµÑ‚ 9 â€” Ğ Ğ°ÑÑˆĞ¸Ñ€ÑĞµĞ¼Ğ¾ÑÑ‚ÑŒ
* Ğ‘Ğ»Ğ¾Ğº 9.6 â€” Ğ’Ğ½ĞµÑˆĞ½Ğ¸Ğµ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑÑ‹: REST, gRPC Ğ¸ JSON\:API

## ğŸ¯ ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ

Ğ”Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº Ğ¾Ğ±ĞµÑĞ¿ĞµÑ‡Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºÑƒ ÑĞ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ¾Ğ² Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ñ Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ğ¼Ğ¸ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ÑĞ¼Ğ¸, Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ RESTful API, Ğ´Ğ²Ğ¾Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ²Ñ‹ÑĞ¾ĞºĞ¾Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ» gRPC Ğ¸ ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ JSON\:API. ĞĞ½ Ğ¸Ğ³Ñ€Ğ°ĞµÑ‚ ĞºĞ»ÑÑ‡ĞµĞ²ÑƒÑ Ñ€Ğ¾Ğ»ÑŒ Ğ² Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¡Ğ£Ğ‘Ğ” Ğ² Ğ¼Ğ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸ÑĞ½Ñ‹Ğµ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹, Ğ¾Ğ±Ğ»Ğ°Ñ‡Ğ½Ñ‹Ğµ Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ğ¸ Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ğµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹, Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ·Ñƒ ĞºĞ°Ğº Ñ‡Ğ°ÑÑ‚ÑŒ API-Ğ¸Ğ½Ñ„Ñ€Ğ°ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹.

## âš™ï¸ Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ

| ĞŸĞ¾Ğ´ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°     | Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ / Ğ¾ÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸                                                  |
| -------------- | ------------------------------------------------------------------------- |
| REST API       | ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° OpenAPI 3.0, Ğ°Ğ²Ñ‚Ğ¾-Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑÑ…ĞµĞ¼, JSON/HTTP                     |
| gRPC           | ĞŸÑ€Ğ¾Ñ‚Ğ¾ĞºĞ¾Ğ» IDL + ProtoBuf, Ğ´Ğ²Ğ¾Ğ¸Ñ‡Ğ½Ğ°Ñ ÑĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ, TLS, bidirectional stream |
| JSON\:API      | Ğ¡Ğ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ JSON\:API v1.1, Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° sparse fieldsets      |
| Routing Engine | ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ°Ğ¼, Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ°Ğ¼, ÑÑ…ĞµĞ¼Ğ°Ğ¼                              |
| AuthN/AuthZ    | JWT, OAuth2 scopes, IP-based access, TLS client certs                     |

## ğŸ’¾ Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

Ğ¢Ñ€Ğ°Ğ½ÑĞ¿Ğ¾Ñ€Ñ‚Ğ½Ñ‹Ğ¹ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·ÑƒĞµÑ‚ ÑĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ/Ğ´ĞµÑĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€ SQL-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ¸ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ² Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ°Ñ… JSON Ğ¸Ğ»Ğ¸ ProtoBuf. REST Ğ¸ JSON\:API Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ½ÑƒÑ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ:

```c
typedef struct {
    char *endpoint;
    http_method_t method;
    json_object_t *payload;
} rest_request_t;

typedef struct {
    char *proto_service;
    char *method;
    grpc_message_t *message;
} grpc_call_t;
```

## ğŸ”„ Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¸ ÑĞ²ÑĞ·Ğ¸

```plantuml
[REST Engine] --> [SQL Executor]
[gRPC Engine] --> [SQL Executor]
[Auth Manager] --> [REST Engine]
[Auth Manager] --> [gRPC Engine]
[REST Engine] --> [Schema Registry]
[gRPC Engine] --> [Security Module]
```

## ğŸ§  ĞÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸

* Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ libmicrohttpd Ğ´Ğ»Ñ REST Ğ¸ gRPC C-core runtime
* ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ OpenAPI/Swagger ÑÑ…ĞµĞ¼
* ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° HTTP/2 Ğ´Ğ»Ñ gRPC Ñ multiplexed streams
* Bidirectional streaming Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ½Ğ° gRPC
* Ğ¡Ğ¶Ğ°Ñ‚Ğ¸Ğµ JSON-Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ² Ñ‡ĞµÑ€ĞµĞ· Gzip/Deflate Ğ¿Ğ¾ Accept-Encoding

## ğŸ“‚ Ğ¡Ğ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ´ÑƒĞ»Ğ¸ ĞºĞ¾Ğ´Ğ°

* `src/net/rest_api.c`
* `src/net/grpc_server.c`
* `include/net/rest_api.h`
* `include/net/grpc_api.h`

## ğŸ”§ ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ½Ğ° C

| Ğ˜Ğ¼Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸         | ĞŸÑ€Ğ¾Ñ‚Ğ¾Ñ‚Ğ¸Ğ¿                                                        | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ                                         |
| ------------------- | --------------------------------------------------------------- | ------------------------------------------------ |
| `rest_dispatch`     | `int rest_dispatch(rest_request_t *req, rest_response_t *res);` | ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° REST-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°                           |
| `grpc_handle_call`  | `int grpc_handle_call(grpc_call_t *call);`                      | ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ° gRPC                            |
| `jsonapi_transform` | `int jsonapi_transform(json_t *input, sql_query_t *query);`     | ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ JSON\:API-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ² SQL-Ğ²Ñ‹Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ |

## ğŸ§ª Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

* REST/Swagger Ñ‚ĞµÑÑ‚Ñ‹ Ñ‡ĞµÑ€ĞµĞ· Postman, cURL, Autotests
* gRPC: integration tests Ñ‡ĞµÑ€ĞµĞ· `grpc_cli`, proto-Ñ„Ğ°Ğ¹Ğ»Ñ‹
* ĞĞ°Ğ³Ñ€ÑƒĞ·Ğ¾Ñ‡Ğ½Ñ‹Ğµ: wrk2 (REST), ghz (gRPC) Ñ TLS Ğ¸ streaming
* ĞŸĞ¾ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ ĞºĞ¾Ğ´Ğ°: >90% Ğ¿Ğ¾ API-ÑĞ»Ğ¾Ñ

## ğŸ“Š ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ

* REST latency (avg): 3â€“5 Ğ¼Ñ
* gRPC latency (avg): 1.2 Ğ¼Ñ
* Throughput (REST): 12K RPS
* Throughput (gRPC): 30K RPS

## âœ… Ğ¡Ğ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²Ğ¸Ğµ SAP HANA+

| ĞšÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸Ğ¹      | ĞÑ†ĞµĞ½ĞºĞ° | ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹                                      |
| ------------- | ------ | ------------------------------------------------ |
| REST/HTTP API | 100    | ĞŸĞ¾Ğ»Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° OpenAPI, Ğ°Ğ²Ñ‚Ğ¾-Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ, JWT |
| gRPC          | 100    | Ğ”Ğ²ÑƒĞ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ¾Ñ‚Ğ¾Ğº, TLS, protobuf, streaming  |
| JSON\:API     | 90     | Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ° ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ, Ğ½Ğ¾ Ğ±ĞµĞ· bulk insert     |

## ğŸ“ ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ ĞºĞ¾Ğ´Ğ°

```c
rest_request_t req = { .endpoint="/query", .method=POST, .payload=json_payload };
rest_dispatch(&req, &response);
```

## ğŸ§© Ğ‘ÑƒĞ´ÑƒÑ‰Ğ¸Ğµ Ğ´Ğ¾Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸

* ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° GraphQL Ğ² Ğ²Ğ¸Ğ´Ğµ Ğ½Ğ°Ğ´ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ½Ğ°Ğ´ SQL Executor
* ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ° WebSockets Ğ´Ğ»Ñ push-ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹
* REST-ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ CDC Ñ‡ĞµÑ€ĞµĞ· SSE (Server-Sent Events)

## ğŸ§° Ğ¡Ğ²ÑĞ·ÑŒ Ñ Ğ±Ğ¸Ğ·Ğ½ĞµÑ-Ñ„ÑƒĞ½ĞºÑ†Ğ¸ÑĞ¼Ğ¸

* Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ REST/gRPC ĞºĞ°Ğº API-ÑˆĞ»ÑĞ·Ğ° Ğ´Ğ»Ñ Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ñ… ERP ÑĞ¸ÑÑ‚ĞµĞ¼
* Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ Ğ¾Ğ±Ğ»Ğ°Ñ‡Ğ½Ñ‹Ğ¼Ğ¸ ETL/BI ÑÑ€ĞµĞ´ÑÑ‚Ğ²Ğ°Ğ¼Ğ¸ Ñ‡ĞµÑ€ĞµĞ· HTTP/gRPC
* Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ ÑÑ…ĞµĞ¼Ğ°Ğ¼Ğ¸ Ğ¸ Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ°ĞºÑ†Ğ¸ÑĞ¼Ğ¸ Ğ¸Ğ· Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ñ… UI

## ğŸ” Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

* TLS 1.3, HTTPS-only Ñ€ĞµĞ¶Ğ¸Ğ¼, ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ñ‹ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ°
* ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ IP, Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸, Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ñƒ Ñ‚ĞµĞ»Ğ° Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°
* JWT-Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ñ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑŒÑ, expiration, scopes

## ğŸ§¾ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ, Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸, Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ñ

* `ERR_HTTP_400_BAD_REQUEST`
* `ERR_GRPC_CALL_FAILED`
* `WARN_JSONAPI_DEPRECATED_FIELD`

## ğŸ•“ Ğ’ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹

* v1.0 â€” REST GET/POST, gRPC Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ñ‹
* v1.1 â€” TLS, JWT, OpenAPI Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼Ñ‹Ğ¹ swagger.json
* v1.2 â€” JSON\:API, streaming RPC, gzip support

## ğŸ“ˆ UML-Ğ´Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ°

```plantuml
@startuml
package "External API Interfaces" {
  class RESTEngine {
    +dispatch()
  }
  class gRPCEngine {
    +handle_call()
  }
  class JSONAPIAdapter {
    +transform()
  }

  RESTEngine --> SQLExecutor
  gRPCEngine --> SQLExecutor
  JSONAPIAdapter --> SQLParser
  RESTEngine --> AuthManager
  gRPCEngine --> AuthManager
}
@enduml
```

