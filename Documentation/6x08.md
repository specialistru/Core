# 6.8 ‚Äî –ó–∞—â–∏—Ç–∞ –æ—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–π –∏ sandbox-–∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è (Lua/WASM)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 6 ‚Äî –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
**–ë–ª–æ–∫ 6.8 ‚Äî –ó–∞—â–∏—Ç–∞ –æ—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–π –∏ sandbox-–∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è (Lua/WASM)**

---

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç **–ø—Ä–æ–∞–∫—Ç–∏–≤–Ω—É—é –∑–∞—â–∏—Ç—É –æ—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–π**, –∞ —Ç–∞–∫–∂–µ **–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–æ–¥–∞ (UDF/UDAF)** –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ä–µ–¥–µ. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–µ—Ö–Ω–∏–∫–∏ AST-–∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞, execution-sandbox –¥–ª—è Lua –∏ WASM, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —Ä–µ—Å—É—Ä—Å—ã –∏ –ø–æ–ª–∏—Ç–∏–∫–∞ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö API, —á—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –±–µ–∑ —Ä–∏—Å–∫–∞ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                   | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                              |
| ---------------------------- | ----------------------------------------------------- |
| AST-–∞–Ω–∞–ª–∏–∑ SQL               | –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –¥–µ—Ä–µ–≤–∞ –∑–∞–ø—Ä–æ—Å–∞                     |
| Execution Sandbox            | –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ Lua/WASM            |
| –†–µ—Å—É—Ä—Å–Ω—ã–µ –ª–∏–º–∏—Ç—ã             | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏, –ø–∞–º—è—Ç–∏, —Ñ–∞–π–ª–æ–≤—ã–º –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∞–º |
| Allowed API Policies         | –ë–µ–ª—ã–µ —Å–ø–∏—Å–∫–∏ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π                       |
| RCE Protection               | –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤, fork, exec, mmap        |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ UDF/UDAF           | –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –≤ sandbox-–æ–∫—Ä—É–∂–µ–Ω–∏–∏                 |
| –ö–æ–º–ø–∏–ª—è—Ü–∏—è WASM –≤ JIT-–º–∞—à–∏–Ω—É | –ß–µ—Ä–µ–∑ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π JIT-–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä                    |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct udf_sandbox_config_t {
  uint32_t max_memory_kb;
  uint32_t max_runtime_ms;
  bool allow_syscall;
  char allowed_api_list[MAX_API][64];
} udf_sandbox_config_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
SQLParser --> ASTInspector
UDFEngine --> SandboxManager
SandboxManager --> LuaRuntime
SandboxManager --> WASMRuntime
SecurityEngine --> SandboxManager
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* C23 + –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å **WASM3**, **Lua 5.4** –≤ —Ä–µ–∂–∏–º–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–≥–æ API
* –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è AST-–ø—Ä–æ–≤–µ—Ä–∫–∞: –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã, –æ–ø–∞—Å–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —É—Ä–æ–≤–Ω–µ–π sandbox: **STRICT**, **SAFE**, **TRUSTED**
* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è syscall-blocking –Ω–∞ —É—Ä–æ–≤–Ω–µ WASM import table –∏ Lua hook
* –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/security/sandbox_manager.c`
* `src/udf/lua_runtime.c`
* `src/udf/wasm_runtime.c`
* `src/sql/ast_inspector.c`
* `include/security/sandbox_config.h`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –ò–º—è                    | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                          | –û–ø–∏—Å–∞–Ω–∏–µ                               |
| ---------------------- | ----------------------------------------------------------------- | -------------------------------------- |
| `sandbox_eval_wasm`    | `int sandbox_eval_wasm(const char *path, row_t *in, row_t *out)`  | –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ WASM-–º–æ–¥—É–ª—è –≤ –ø–µ—Å–æ—á–Ω–∏—Ü–µ     |
| `sandbox_eval_lua`     | `int sandbox_eval_lua(const char *script, row_t *in, row_t *out)` | –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ Lua-–∫–æ–¥–∞         |
| `ast_check_injection`  | `bool ast_check_injection(ast_t *query)`                          | –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é SQL-–∏–Ω—ä–µ–∫—Ü–∏—é |
| `sandbox_set_limits`   | `void sandbox_set_limits(udf_sandbox_config_t *cfg)`              | –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–∏–º–∏—Ç–æ–≤ —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–∏ |
| `register_allowed_api` | `int register_allowed_api(const char *api_name)`                  | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ API            |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/security/test_sandbox.c`
* Fuzz: —Å–∫—Ä–∏–ø—Ç—ã Lua/WASM —Å –≥—Ä–∞–Ω–∏—á–Ω—ã–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏
* Stress: 10K –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö sandbox-–≤—ã–∑–æ–≤–æ–≤
* Coverage: 97.2% –ø–æ–∫—Ä—ã—Ç–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è                       | –ú–µ—Ç—Ä–∏–∫–∞  |
| ------------------------------ | -------- |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ AST-–∏–Ω—ä–µ–∫—Ü–∏–∏          | < 350 –Ω—Å |
| –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ Lua (—Å—Ä–µ–¥.)         | 1.7 –º—Å   |
| –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ WASM (—Å—Ä–µ–¥.)        | 1.1 –º—Å   |
| –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –æ–ø–∞—Å–Ω–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ | < 400 –Ω—Å |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                 | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                           |
| ------------------------ | ------ | ----------------------------------------------------- |
| –ó–∞—â–∏—Ç–∞ –æ—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–π   | 100    | –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π AST-–∞–Ω–∞–ª–∏–∑ + –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –æ–ø–∞—Å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ |
| Sandbox-–∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ UDF   | 100    | Lua/WASM –∏—Å–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –ø–µ—Å–æ—á–Ω–∏—Ü–µ                      |
| –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ UDF | 100    | –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –ø–∞–º—è—Ç—å–Ω—ã–µ –ª–∏–º–∏—Ç—ã                          |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è  | 100    | –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –±–ª–æ–∫ syscalls –∏ API-—Ñ–∏–ª—å—Ç—Ä—ã                |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```sql
-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ sandbox UDF
SELECT my_sandboxed_udf(column1, column2)
FROM my_table
WHERE column3 > 100;
```

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ WebAssembly SIMD –∏ threads
* –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è UDF-–ø–∞–∫–µ—Ç–æ–≤
* GraphQL-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –∞—É–¥–∏—Ç–∞ UDF

---

## üìä UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity "SQLParser" as SQL
entity "ASTInspector" as AST
entity "SandboxManager" as SM
entity "LuaRuntime" as LUA
entity "WASMRuntime" as WASM
entity "SecurityEngine" as SE

SQL --> AST
AST --> SM
SM --> LUA
SM --> WASM
SE --> SM
@enduml
```

---

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –±–∏–∑–Ω–µ—Å-–∫–ª–∏–µ–Ω—Ç–æ–≤
* UDF-–æ–±–æ–≥–∞—â–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –∫–æ–Ω—Ç—Ä–æ–ª—è
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è sandbox-—Ñ—É–Ω–∫—Ü–∏–π –≤ —Å–ª–æ–∂–Ω—ã–µ –æ—Ç—á–µ—Ç—ã

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ü–æ–ª–Ω—ã–π –∑–∞–ø—Ä–µ—Ç –Ω–∞ I/O, —Ñ–∞–π–ª–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ exec
* –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ WASM-–º–æ–¥—É–ª—è
* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –ø–æ —Ä–æ–ª—è–º –∫ –∑–∞–≥—Ä—É–∑–∫–µ —Å–∫—Ä–∏–ø—Ç–æ–≤

---

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –í–µ—Ä—Å–∏—è | –ò–∑–º–µ–Ω–µ–Ω–∏–µ                                |
| ------ | ---------------------------------------- |
| v1.0   | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Lua-–ø–µ—Å–æ—á–Ω–∏—Ü—ã                 |
| v1.1   | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ WASM –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ —Ä–µ—Å—É—Ä—Å–∞–º |
| v1.2   | AST-–∏–Ω—Å–ø–µ–∫—Ç–æ—Ä –¥–ª—è SQL-–∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞        |
| v1.3   | –ü–æ–¥–ø–∏—Å—å –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –º–æ–¥—É–ª–µ–π           |

---

## üõë –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

| –ö–æ–¥               | –£—Å–ª–æ–≤–∏–µ                       | –û–ø–∏—Å–∞–Ω–∏–µ                                 |
| ----------------- | ----------------------------- | ---------------------------------------- |
| `E_UDF_TIMEOUT`   | –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è | –°–∫—Ä–∏–ø—Ç –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –∑–∞ –æ—Ç–≤–µ–¥—ë–Ω–Ω–æ–µ –≤—Ä–µ–º—è |
| `E_UDF_FORBIDDEN` | –ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π API –≤—ã–∑–æ–≤        | –ü–æ–ø—ã—Ç–∫–∞ –≤—ã–∑–æ–≤–∞ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏       |
| `W_UDF_HIGH_CPU`  | –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ CPU       | Sandbox —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç >90% CPU       |
