# üì¶ –ü–∞–∫–µ—Ç 0 ‚Äî –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–π —Å—Ç–∞—Ä—Ç

| ‚Ññ –±–ª–æ–∫–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞                                                                           |
| ------- | ---------------------------------------------------------------------------------------- |
| 0.1     | –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (main)                                                     |

# üß± –ë–ª–æ–∫ 0.1 ‚Äî –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (main)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 0. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–π —Å—Ç–∞—Ä—Ç
* **–ë–ª–æ–∫:** 0.1 –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (main)

---

# 4.1 ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞ HTAP (Hybrid Transactional/Analytical Processing)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 4 ‚Äî BI, ML –∏ OLAP**
**–ë–ª–æ–∫ 4.1 ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞ HTAP (Hybrid Transactional/Analytical Processing)**

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

HTAP –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç OLTP (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞) –∏ OLAP (–∞–Ω–∞–ª–∏—Ç–∏–∫–∞) –≤ –µ–¥–∏–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –µ–¥–∏–Ω—ã—Ö ETL/–∫–æ–ø–∏–π. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Å—Ç—Ä–∏–º–∏–Ω–≥–∞, –¥–∞—à–±–æ—Ä–¥–æ–≤, –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ –∏ –∞–Ω–æ–º–∞–ª–∏–π –≤ –ø—Ä–∞–∫—Ç–∏–∫–µ.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞        | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                   |
| ----------------- | ------------------------------------------ |
| OLTP-–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ   | In-memory, vectorized, MVCC                |
| OLAP-–∞–≥—Ä–µ–≥–∞—Ü–∏–∏    | column-store + parallel pipeline execution |
| –†–µ–∂–∏–º HTAP        | –ì–∏–±—Ä–∏–¥–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ OLTP/–æ—á–µ—Ä–µ–¥–µ–π OLAP    |
| –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –¥–∂–æ–π–Ω—ã | hash, index-nested, merge                  |
| –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏       | CBO, adaptive join reordering              |

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏

* `src/executor/vectorized_executor.c`
* `src/planner/htap_optimizer.c`
* `src/storage/column_store.c`
* `src/sql/htap_query.c`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –ò–º—è             | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                 | –û–ø–∏—Å–∞–Ω–∏–µ                                |
| --------------- | -------------------------------------------------------- | --------------------------------------- |
| `htap_optimize` | `plan_t *htap_optimize(ast_t *ast, stats_t *stats);`     | –†–µ—à–µ–Ω–∏–µ: HTAP –∏–ª–∏ —á–∏—Å—Ç–æ OLTP/–æ–ª–∞–ø-–≤–µ—Ç–∫–∞ |
| `execute_htap`  | `result_t *execute_htap(plan_t *plan, db_session_t *s);` | –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞           |

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* HTAP-–∑–∞–ø—Ä–æ—Å—ã < 1 –º—Å –Ω–∞ OLTP-–≤–µ—Ç–∫–µ, < 20 –º—Å –Ω–∞ –æ–ª–∞–ø-–∞–≥—Ä–µ–≥–∞—Ü–∏—é
* OLAP-–ø–∏–ø–µ–ª–∞–π–Ω—ã –∏–∑ > 4 stage –¥–æ 10—Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ traditional executor

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

* –û—Ç–¥–µ–ª—å–Ω—ã–µ –ø–ª–∞–Ω–µ—Ä—ã –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã OLTP/–æ–ª–∞–ø
* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–µ–º, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ OLAP —Å–µ—Å—Å–∏–∏

## üí° –ë—É–¥—É—â–∏–µ —Ä–∞–∑–≤–∏—Ç–∏—è

* –¢–æ–ø–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å—Ç–∞–¥–∏–π OLAP
* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –≤ Planner

## üîÑ –°–≤—è–∑–∏ (PlantUML)

```plantuml
@startuml
package HTAP {
  [OLTP-Executor] --> [Vectorized Executor]
  [HTAP Planner] --> [HTAP Optimizer]
  [HTAP Optimizer] --> [OLAP Pipeline]
  [HTAP Optimizer] --> [Join Planner]
  [OLAP Pipeline] --> [Column Store]
  [HTAP Query] --> [HTAP Planner]
}
@enduml
```

## üè¢ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –ø–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º
* –ü–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏–π scoring, –¥–∞—à–±–æ—Ä–¥—ã –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã

## üìÖ –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

* v1.0: HTAP planner, OLAP pipeline, OLTP –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ (2025)
* v1.1: –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ plan reuse

## üìÉ –§–æ—Ä–º–∞—Ç—ã/—Å—Ç—Ä—É–∫—Ç—É—Ä—ã

```c
// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ HTAP-–ø–ª–∞–Ω–∞
typedef struct htap_plan_t {
  plan_node_t *oltp_path;
  plan_node_t *olap_path;
  bool is_parallel;
  join_method_t adaptive_join;
} htap_plan_t;
```

## üì¢ –°–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—à–∏–±–∫–∏

| –ö–æ–¥    | –°–æ–æ–±—â–µ–Ω–∏–µ              | –û–ø–∏—Å–∞–Ω–∏–µ                           |
| ------ | ---------------------- | ---------------------------------- |
| HTAP01 | "HTAP planner failed"  | –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å HTAP-–ø–ª–∞–Ω |
| HTAP02 | "Pipeline too deep"    | –°–ª–∏—à–∫–æ–º –≥–ª—É–±–æ–∫–∞—è OLAP-—Å—Ü–µ–Ω–∞—Ä–∏—è     |
| HTAP03 | "Join strategy failed" | –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ –≤–æ–∑–º–æ–∂–Ω–æ |

```
```

# 4.2 ‚Äî –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å BI: Views, Materialized Views, Adaptive Aggregates

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 4 ‚Äî BI, ML –∏ OLAP**
**–ë–ª–æ–∫ 4.2 ‚Äî –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å BI: Views, Materialized Views, Adaptive Aggregates**

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, —Ñ–æ—Ä–º–∏—Ä—É–µ–º—ã—Ö BI-—Å–∏—Å—Ç–µ–º–∞–º–∏. –í–∫–ª—é—á–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π (`VIEW`), –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π (`MATERIALIZED VIEW`) –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö –∞–≥—Ä–µ–≥–∞—Ç–æ–≤. –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è, –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, —á–∞—Å—Ç–∏—á–Ω–æ–π –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ —É—Å–∫–æ—Ä–µ–Ω–Ω–æ–π –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –ø–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–∑–º–µ–Ω—è—é—â–∏–º—Å—è –¥–∞–Ω–Ω—ã–º.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞              | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                            |
| ----------------------- | ------------------------------------------------------------------- |
| –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (Views)   | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±—ã—á–Ω—ã—Ö SQL-–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π                                 |
| –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ View  | –°–æ–∑–¥–∞–Ω–∏–µ —Å `REFRESH`, `ON COMMIT`, `ON DEMAND`                      |
| –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∞–≥—Ä–µ–≥–∞—Ç—ã     | –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ ROLLUP, CUBE, —á–∞—Å—Ç–∏—á–Ω—ã—Ö –∞–≥—Ä–µ–≥–∞—Ü–∏–π                       |
| –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è | –§–æ–Ω–æ–≤—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (`REFRESH MATERIALIZED`)             |
| –ê–≤—Ç–æ-–∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è        | –¢—Ä–µ–∫–∏–Ω–≥ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
typedef struct view_def_t {
  char *name;
  char *query;
  bool is_materialized;
  timestamp_t last_refresh;
} view_def_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```
QueryPlanner --> ViewRegistry
ViewRegistry --> StorageEngine
ViewRegistry --> AggregationEngine
ViewRegistry --> UpdateScheduler
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: C23
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–µ–Ω–∏–≤–æ–µ –∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
* –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å —á–∞—Å—Ç–∏—á–Ω–æ–π (–ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º –¥–∞–Ω–Ω—ã—Ö)
* –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –º–µ—Ö–∞–Ω–∏–∑–º—ã hot/cold data –∏ tiering

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/sql/view.c`
* `src/sql/materialized_view.c`
* `src/sql/adaptive_agg.c`
* `include/sql/view.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è                 | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                   | –û–ø–∏—Å–∞–Ω–∏–µ                                               |
| ------------------- | -------------------------------------------------------------------------- | ------------------------------------------------------ |
| `view_create`       | `int view_create(const char *name, const char *query, bool materialized);` | –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ã—á–Ω–æ–≥–æ –∏–ª–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è |
| `view_refresh`      | `int view_refresh(const char *name);`                                      | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è            |
| `adaptive_agg_exec` | `result_t *adaptive_agg_exec(const char *query);`                          | –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ —Å –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π –∞–≥—Ä–µ–≥–∞—Ü–∏–µ–π             |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/sql/test_views.c`, `test_mview.c`, `test_adaptive_agg.c`
* Integration: —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Å BI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ (Power BI, Superset)
* Fuzz: —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –±–æ–ª—å—à–∏–µ –≤—ã–±–æ—Ä–∫–∏
* Coverage: > 90% coverage –ø–æ –≤–µ—Ç–≤—è–º –∞–≥—Ä–µ–≥–∞—Ü–∏–∏

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è                     | –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å                        |
| ---------------------------- | --------------------------------- |
| –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ materialized view | < 50 –º—Å (–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ)          |
| –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ BI-–∑–∞–ø—Ä–æ—Å–∞      | < 300 –º—Å –Ω–∞ 1B –∑–∞–ø–∏—Å–µ–π            |
| –ß–∞—Å—Ç–∏—á–Ω–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è          | x4 —É—Å–∫–æ—Ä–µ–Ω–∏–µ –ø—Ä–æ—Ç–∏–≤ –ø–æ–ª–Ω–æ–≥–æ —Å–∫–∞–Ω–∞ |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                        | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                              |
| ------------------------------- | ------ | ---------------------------------------- |
| –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è | 100    | –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ REFRESH –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π  |
| –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ      | 95     | –ù–µ –≤—Å–µ —Ç–∏–ø—ã –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç delta |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```sql
CREATE MATERIALIZED VIEW top_customers AS
SELECT customer_id, SUM(amount) AS total
FROM orders
GROUP BY customer_id
ORDER BY total DESC
LIMIT 100;
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ DISTRIBUTED VIEW –Ω–∞ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
* –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –±–∞–∑–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü
* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–≥—Ä–µ–≥–∞—Ç–æ–≤ –ø–æ —Ç–∏–ø—É PAX

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞ (PlantUML)

```plantuml
@startuml
entity "ViewRegistry" as VR
entity "StorageEngine" as SE
entity "AggregationEngine" as AE
entity "UpdateScheduler" as US
VR --> SE
VR --> AE
VR --> US
@enduml
```

## üè¢ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ OLAP-–æ—Ç—á–µ—Ç–æ–≤ –∏ BI-–¥–æ—Å–æ–∫
* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏—Ç—Ä–∏–Ω –¥–∞–Ω–Ω—ã—Ö –∏ KPI-–¥–∞—à–±–æ—Ä–¥–æ–≤
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–∏—Ç—Ä–∏–Ω –¥–ª—è ML

## üìú –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0: —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è Views –∏ MView, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ ROLLUP, CUBE (2025-07)
* v1.1: –∞–≤—Ç–æ-–∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (2025-08)

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* Row-level security –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ View
* –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ —Å side-effect
* –ö–æ–Ω—Ç—Ä–æ–ª—å –ø—Ä–∞–≤ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π

## üì¢ –°–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—à–∏–±–∫–∏

| –ö–æ–¥       | –°–æ–æ–±—â–µ–Ω–∏–µ                          | –û–ø–∏—Å–∞–Ω–∏–µ                                 |
| --------- | ---------------------------------- | ---------------------------------------- |
| `VIEW001` | "View not found"                   | –£–∫–∞–∑–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç    |
| `VIEW002` | "Refresh failed: dependency error" | –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑-–∑–∞ –Ω–∞—Ä—É—à–µ–Ω–Ω–æ–π —Å–≤—è–∑–∏ |
| `VIEW003` | "Aggregation engine timeout"       | –í—ã—à–ª–æ –≤—Ä–µ–º—è –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏      |

# 4.5 ‚Äî –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: —Ä–∞–Ω–≥–∏, –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª—å, –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è, –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 4 ‚Äî BI, ML –∏ OLAP**
**–ë–ª–æ–∫ 4.5 ‚Äî –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: —Ä–∞–Ω–≥–∏, –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª—å, –∫–æ—Ä—Ä–µ–ª—è—Ü–∏—è, –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è**

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–µ—Ä–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è, –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏, –∞–Ω–∞–ª–∏–∑–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∂–∏–º–µ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ BI-–∑–∞–ø—Ä–æ—Å–∞—Ö, OLAP-–∫—É–±–∞—Ö, –ø—Ä–µ–¥–∏–∫—Ç–∏–≤–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–µ –∏ ML-–ø—Ä–µ–ø—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥–µ.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞          | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                           |
| ------------------- | -------------------------------------------------- |
| –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ        | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `RANK()`, `DENSE_RANK()`, `ROW_NUMBER()` |
| –ü—Ä–æ—Ü–µ–Ω—Ç–∏–ª—å          | –ê–≥—Ä–µ–≥–∞—Ç—ã `PERCENTILE_CONT()`, `PERCENTILE_DISC()`  |
| –ö–æ—Ä—Ä–µ–ª—è—Ü–∏—è          | `CORR()`, `COVAR_POP()`, `COVAR_SAMP()`            |
| –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è       | K-means UDF –Ω–∞ C / WASM, —Å SQL-–æ–±—ë—Ä—Ç–∫–æ–π            |
| –£—Ç–æ—á–Ω—ë–Ω–Ω—ã–µ –∞–≥—Ä–µ–≥–∞—Ç—ã | –†–∞—Å—á—ë—Ç —Å–∫–æ–ª—å–∑—è—â–∏—Ö –æ–∫–æ–Ω, percent\_rank, ntile       |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞–≥—Ä–µ–≥–∞—Ç–∞ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏
typedef struct stat_state_t {
  uint64_t count;
  double sum_x;
  double sum_y;
  double sum_x2;
  double sum_y2;
  double sum_xy;
} stat_state_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```
SQLExecutor --> AnalyticFunctions
AnalyticFunctions --> StatAggregates
AnalyticFunctions --> RankingEngine
AnalyticFunctions --> UDFEngine
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –ø–æ–¥ column-store –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ (vectorized batch)
* –ú–µ—Ö–∞–Ω–∏–∑–º—ã –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏ —Ä–∞–∑–±–∏–µ–Ω–∏—è –ø–æ partition
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
* –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ UDF –Ω–∞ C –∏ WASM

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/sql/analytic.c`
* `src/udf/kmeans_udf.c`
* `include/sql/aggregate.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è                  | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                   | –û–ø–∏—Å–∞–Ω–∏–µ                            |
| -------------------- | -------------------------------------------------------------------------- | ----------------------------------- |
| `rank_fn`            | `int64_t rank_fn(const row_t *rows, size_t count);`                        | –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ä–∞–Ω–≥–æ–≤ –ø–æ –æ–∫–Ω—É           |
| `percentile_cont_fn` | `double percentile_cont(double *values, size_t count, double percentile);` | –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª—å              |
| `stat_accumulate`    | `void stat_accumulate(stat_state_t *s, double x, double y);`               | –ê–∫–∫—É–º—É–ª—è—Ü–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ |
| `kmeans_udf`         | `void kmeans_udf(const column_t *cols, size_t nrows, result_t *out);`      | –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –ø–æ k-means            |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/sql/test_analytic.c`, `tests/udf/test_kmeans.c`
* Fuzz: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã—Ö –≤—Ö–æ–¥–Ω—ã—Ö –æ–∫–æ–Ω
* Soak: –∞–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ –º–∏–ª–ª–∏–∞—Ä–¥–∞–º —Å—Ç—Ä–æ–∫ –≤ –∫—É–±–∞—Ö
* Coverage: 100% –ø–æ —Ñ—É–Ω–∫—Ü–∏—è–º —Ä–∞—Å—á—ë—Ç–∞

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è             | –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å                      |
| -------------------- | ------------------------------- |
| `RANK()`             | \~120 –º–ª–Ω —Å—Ç—Ä–æ–∫/—Å (partitioned) |
| `CORR()`             | \~80 –º–ª–Ω —Å—Ç—Ä–æ–∫/—Å                |
| `KMEANS` (8 —Ü–µ–Ω—Ç—Ä–æ–≤) | \~10 –º–ª–Ω —Å—Ç—Ä–æ–∫/—Å                |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                          | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                |
| --------------------------------- | ------ | ------------------------------------------ |
| –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ | 100    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–∫–æ–Ω–Ω—ã—Ö –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π |
| –†–∞—Å–ø–∞—Ä–∞–ª–ª–µ–ª–∏–≤–∞–Ω–∏–µ –∏ –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è  | 100    | SIMD + –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å                     |
| –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ UDF            | 100    | C –∏ WASM UDF –¥–æ—Å—Ç—É–ø–Ω—ã                      |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```sql
SELECT id, RANK() OVER (PARTITION BY region ORDER BY sales DESC) AS rnk
FROM sales_data;

SELECT CORR(income, credit_score) FROM applicants;
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π Entropy, Mutual Information
* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º K
* –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞ (PlantUML)

```plantuml
@startuml
entity "SQLExecutor" as SE
entity "AnalyticFunctions" as AF
entity "StatAggregates" as SA
entity "RankingEngine" as RE
entity "UDFEngine" as UDF
SE --> AF
AF --> SA
AF --> RE
AF --> UDF
@enduml
```

## üè¢ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* BI-–¥–∞—à–±–æ—Ä–¥—ã —Å —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–µ–π
* –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø–æ–≤–µ–¥–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
* –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è ML-–ø–∞–π–ø–ª–∞–π–Ω–æ–≤

## üìú –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0: –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–Ω–≥–∞ –∏ –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª—è
* v1.1: –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è –∏ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –∏ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –æ–∫–æ–Ω–Ω—ã—Ö –∞–≥—Ä–µ–≥–∞—Ç–æ–≤
* –ò–∑–æ–ª—è—Ü–∏—è UDF-–∫–æ–¥–∞ –≤ sandbox
* –ó–∞—â–∏—Ç–∞ –æ—Ç OOM –≤ —Ä–∞—Å—á—ë—Ç–∞—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤

## üì¢ –°–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—à–∏–±–∫–∏

| –ö–æ–¥   | –°–æ–æ–±—â–µ–Ω–∏–µ                  | –û–ø–∏—Å–∞–Ω–∏–µ                               |
| ----- | -------------------------- | -------------------------------------- |
| AF001 | "Partition too large"      | –°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π partition –¥–ª—è –æ–∫–Ω–∞     |
| AF002 | "Invalid percentile value" | –ó–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª—è –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞      |
| AF003 | "UDF failure in k-means"   | –û—à–∏–±–∫–∞ –≤–Ω—É—Ç—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ |

