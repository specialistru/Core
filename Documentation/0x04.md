# üåê –ë–ª–æ–∫ 0.4 ‚Äî –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 500+ —Ñ–∏–ª–∏–∞–ª–æ–≤

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –ó–Ω–∞—á–µ–Ω–∏–µ                               |
| --------- | -------------------------------------- |
| üì¶ –ü–∞–∫–µ—Ç  | 0 ‚Äî –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–π —Å—Ç–∞—Ä—Ç    |
| üî¢ –ë–ª–æ–∫   | 0.4 ‚Äî –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ 500+ —Ñ–∏–ª–∏–∞–ª–æ–≤ |

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–¶–µ–ª—å –±–ª–æ–∫–∞ ‚Äî –æ–±–µ—Å–ø–µ—á–∏—Ç—å **–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ In-Memory –†–°–£–ë–î** –Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å **–±–æ–ª–µ–µ —á–µ–º 500 —Ñ–∏–ª–∏–∞–ª–∞–º–∏**, –∫–∞–∂–¥—ã–π –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å:

* –î–æ 9M –∑–∞–ø–∏—Å–µ–π/–¥–µ–Ω—å,
* –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –∏ —à–∞—Ä–¥—ã,
* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —Ä–µ—Å—É—Ä—Å—ã (CPU, IOPS, –ø–∞–º—è—Ç—å),
* –ü–æ–¥–¥–µ—Ä–∂–∫—É –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∏ failover.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞           | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                               |
| -------------------- | ---------------------------------------------------------------------- |
| –®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ         | –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ shard-–∫–ª—é—á–∞–º (—Ñ–∏–ª–∏–∞–ª, tenant\_id) |
| –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞         | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ shard'–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–µ               |
| –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤ | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `limits.conf` –Ω–∞ CPU, IOPS, –ø–∞–º—è—Ç—å –¥–ª—è —Å–µ—Å—Å–∏–π                |
| –ò–∑–æ–ª—è—Ü–∏—è —Å–µ—Å—Å–∏–π      | –ö–∞–∂–¥–∞—è —Å–µ—Å—Å–∏—è/—Ñ–∏–ª–∏–∞–ª –∏–º–µ–µ—Ç —Å–≤–æ—é –æ–±–ª–∞—Å—Ç—å –ø–∞–º—è—Ç–∏, WAL, TTL               |
| Cluster Discovery    | –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —É–∑–ª–æ–≤, –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ IP/region/zone                       |
| Failover             | –ê–∫—Ç–∏–≤–Ω–æ-–ø–∞—Å—Å–∏–≤–Ω—ã–π –∏ –∞–∫—Ç–∏–≤–Ω—ã–π –∫–≤–æ—Ä—É–º (RAFT)                             |

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏           | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                            | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                         |
| --------------------- | --------------------------------------------------- | ---------------------------------- |
| `db_session_open()`   | `db_session_t *db_session_open(db_t *, branch_id)`  | –û—Ç–∫—Ä—ã—Ç–∏–µ —Å–µ—Å—Å–∏–∏ –¥–ª—è —Ñ–∏–ª–∏–∞–ª–∞        |
| `shard_assign()`      | `uint32_t shard_assign(db_t *, uint64_t tenant_id)` | –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ shard –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `rebalance_trigger()` | `void rebalance_trigger(cluster_t *)`               | –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏       |
| `limit_check()`       | `bool limit_check(session_t *, limit_type, value)`  | –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤                   |
| `cluster_join()`      | `bool cluster_join(cluster_t *, const char *addr)`  | –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–ª–∞—Å—Ç–µ—Ä—É           |

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞                  | –ò—Å—Ç–æ—á–Ω–∏–∫                 | –¶–µ–ª—å     |
| ------------------------ | ------------------------ | -------- |
| `active_branches_total`  | –ö–æ–ª-–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ñ–∏–ª–∏–∞–ª–æ–≤ | > 500    |
| `session_latency_ms`     | –í—Ä–µ–º—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–µ—Å—Å–∏–∏    | < 3 –º—Å   |
| `rebalance_latency_ms`   | –í—Ä–µ–º—è –º–∏–≥—Ä–∞—Ü–∏–∏ shard     | < 50 –º—Å  |
| `branch_failover_time`   | –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —É–∑–ª–æ–≤       | < 500 –º—Å |
| `limit_violations_total` | –ü—Ä–µ–≤—ã—à–µ–Ω–∏—è IOPS/CPU      | = 0      |

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

```
src/cluster.c
src/shard.c
src/session.c
src/limits.c
src/config.c
src/failover.c
include/cluster.h
include/session.h
include/limits.h
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* NUMA-aware —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–π –∏ shard affinity
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ shard directory –¥–ª—è lookup –∏ migrate
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ tenant isolation —á–µ—Ä–µ–∑ resource policy
* Failover –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ RAFT/etcd-–º–µ—Ö–∞–Ω–∏–∑–º–∞—Ö
* –°–±–æ—Ä –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—è shard-–º–µ—Ç—Ä–∏–∫ –ø–æ cluster API

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

| –í–∏–¥ —Ç–µ—Å—Ç–∞    | –ú–µ—Ç–æ–¥–∏–∫–∞ / –ø–æ–∫—Ä—ã—Ç–∏–µ                       | –ì–¥–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω            |
| ------------ | ----------------------------------------- | ------------------------- |
| Cluster      | –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ 8 —É–∑–ª–æ–≤ —Å 512 —Ñ–∏–ª–∏–∞–ª–∞–º–∏     | `tests/cluster/test500.c` |
| Rebalance    | –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è 100 shard         | `tests/rebalance/test.c`  |
| Soak         | –ù–∞–≥—Ä—É–∑–∫–∞ –æ—Ç 5000 —Å–µ—Å—Å–∏–π —Å latency-–∑–∞–º–µ—Ä–æ–º | `tests/soak/branches.c`   |
| Fault Inject | Simulate node crash + recovery            | `fuzz/fuzz_failover.c`    |

---

## üìê PlantUML ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ñ–∏–ª–∏–∞–ª–æ–≤ –∏ —à–∞—Ä–¥–∏–Ω–≥–∞

```plantuml
@startuml
actor "–§–∏–ª–∏–∞–ª 1" as B1
actor "–§–∏–ª–∏–∞–ª 512" as B512
node "DB Node A" {
  component "Shard 0"
  component "Shard 1"
}
node "DB Node B" {
  component "Shard 2"
  component "Shard 3"
}
database "In-Memory Storage"

B1 --> "Shard 0" : db_session_open()
B512 --> "Shard 3" : db_session_open()

"Shard 0" --> "In-Memory Storage"
"Shard 3" --> "In-Memory Storage"
@enduml
```

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                      | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                       |
| ----------------------------- | ------ | --------------------------------- |
| 500+ —Ñ–∏–ª–∏–∞–ª–æ–≤                 | 100    | –°—Ç—Ä–µ—Å—Å-—Ç–µ—Å—Ç –Ω–∞ 512 —Ñ–∏–ª–∏–∞–ª–æ–≤       |
| NUMA-aware —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ      | 95     | –°–µ—Å—Å–∏–∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω—ã –∑–∞ —É–∑–ª–∞–º–∏       |
| Shard rebalance –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥  | 90     | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–µ—Ç—Ä–∏–∫ –∏ –∞–≤—Ç–æ-—Ä–µ–±–∞–ª–∞–Ω—Å–∞ |
| Failover –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å | 90     | –ê–∫—Ç–∏–≤-–ø–∞—Å—Å–∏–≤ –∏ RAFT               |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
db_t *db = db_instance_create();
db_session_t *s = db_session_open(db, 128); // —Ñ–∏–ª–∏–∞–ª 128
log_info("cluster", "–§–∏–ª–∏–∞–ª 128 –∑–∞–∫—Ä–µ–ø–ª—ë–Ω –∑–∞ —à–∞—Ä–¥–æ–º %u", shard_assign(db, 128));
```

---

## üìå –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Ç—ã—Å—è—á–∏ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –æ–¥–Ω–æ–π –°–£–ë–î
* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –º–µ—Ä–µ —Ä–æ—Å—Ç–∞ –Ω–∞–≥—Ä—É–∑–∫–∏
* –ü—Ä—è–º–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ multi-branch –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã ERP/—Ñ–∏–Ω—Ç–µ—Ö/retail
