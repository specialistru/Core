# üß± –ë–ª–æ–∫ 2.3 ‚Äî –ñ—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ WAL (Write-Ahead Logging)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 2 ‚Äî –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å
* **–ë–ª–æ–∫:** 2.3 ‚Äî –ñ—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ WAL (Write-Ahead Logging)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ú–µ—Ö–∞–Ω–∏–∑–º Write-Ahead Logging (WAL) —Ä–µ–∞–ª–∏–∑—É–µ—Ç –Ω–∞–¥–µ–∂–Ω—É—é –∏ –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—É—é –∑–∞–ø–∏—Å—å –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö –≤ —É—Å—Ç–æ–π—á–∏–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–æ –∏—Ö –æ—Ç—Ä–∞–∂–µ–Ω–∏—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–º—è—Ç–∏. –≠—Ç–æ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è **–¥–æ–ª–≥–æ–≤–µ—á–Ω–æ—Å—Ç–∏ (Durability)** –≤ ACID –∏ —è–¥—Ä–æ crash-recovery –≤ in-memory –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Å–±–æ—è, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–π –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —É—Å–ª–æ–≤–∏—è—Ö NUMA –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                           |
| ------------------------- | ---------------------------------------------------------------------------------- |
| WAL-—Å–µ–≥–º–µ–Ω—Ç—ã              | –†–∞–∑–±–∏–µ–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞ –Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞              |
| WAL-–∑–∞–ø–∏—Å–∏                | –ó–∞–ø–∏—Å—å –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ `wal_record_t` —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π |
| –ñ—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π | Atomically –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è commit/rollback markers, –≥—Ä–∞–Ω–∏—Ü—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π                |
| Checkpoint-–º–µ—Ö–∞–Ω–∏–∑–º       | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ soft/hard checkpoint –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –æ–±—ä—ë–º–∞ –∂—É—Ä–Ω–∞–ª–∞                      |
| –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ WAL-–ø–∏—Å–∞—Ç–µ–ª–∏ | –ù–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤ –Ω–∞ NUMA-—É–∑–µ–ª —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ CAS –∏ lock-free –æ—á–µ—Ä–µ–¥–∏        |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MVCC         | WAL —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Å—ã–ª–∫—É –Ω–∞ `tx_id`, MVCC timestamp –∏ lsn –¥–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è              |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct {
    uint64_t lsn;             // –ù–æ–º–µ—Ä –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ª–æ–≥–∞
    uint32_t tx_id;           // ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    uint16_t op_type;         // –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ (INSERT/DELETE/COMMIT)
    uint16_t payload_len;     // –î–ª–∏–Ω–∞ –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏
    uint8_t  data[];          // –î–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π (diff, insert row –∏ —Ç.–ø.)
} wal_record_t;

typedef struct {
    uint64_t segment_id;
    wal_record_t *records;
    uint32_t record_count;
    uint64_t written_bytes;
} wal_segment_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
package "2.3 WAL" {
  [WAL Writer] --> [MVCC Engine]
  [WAL Writer] --> [–ë—É—Ñ–µ—Ä–Ω—ã–π –ø—É–ª]
  [WAL Writer] --> [Recovery Subsystem]
  [WAL Writer] --> [NUMA Memory Manager]
  [WAL Writer] --> [Flush Monitor / Checkpoint Manager]
}
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: **C23**, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ lock-free —Å—Ç—Ä—É–∫—Ç—É—Ä, –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö CAS, padding –¥–ª—è cache line
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ NUMA-aware log writers ‚Äî –∂—É—Ä–Ω–∞–ª —Ä–∞–∑–≤–µ—Ç–≤–ª—è–µ—Ç—Å—è –ø–æ NUMA —É–∑–ª–∞–º
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ **log compaction**: —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∞–≥—Ä–µ–≥–∏—Ä—É—é—Ç—Å—è –∏–ª–∏ –æ—Ç–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ **write batching**, zero-copy append
* Snapshot-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å ‚Äî –∫–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å –º–∞—Ä–∫–∏—Ä—É–µ—Ç—Å—è MVCC-–º–æ–Ω–æ–ª–∏—Ç–æ–º

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/wal/wal_writer.c`
* `src/wal/wal_segment.c`
* `include/wal/wal.h`
* `include/wal/wal_format.h`
* `tests/wal/wal_test.c`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏             | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                         | –û–ø–∏—Å–∞–Ω–∏–µ                                   |
| ----------------------- | ------------------------------------------------ | ------------------------------------------ |
| `wal_append`            | `bool wal_append(tx_id_t tx, wal_record_t *rec)` | –î–æ–±–∞–≤–ª—è–µ—Ç WAL-–∑–∞–ø–∏—Å—å –≤ —Ç–µ–∫—É—â–∏–π NUMA-–∂—É—Ä–Ω–∞–ª |
| `wal_flush_segment`     | `void wal_flush_segment(wal_segment_t *seg)`     | –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–µ–≥–º–µ–Ω—Ç –Ω–∞ –¥–∏—Å–∫   |
| `wal_create_checkpoint` | `uint64_t wal_create_checkpoint()`               | –°–æ–∑–¥–∞—ë—Ç —Ç–æ—á–∫—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è               |
| `wal_recover_segment`   | `int wal_recover_segment(wal_segment_t *seg)`    | –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ WAL-—Å–µ–≥–º–µ–Ω—Ç–∞     |
| `wal_lsn_advance`       | `void wal_lsn_advance(uint64_t new_lsn)`         | –ê—Ç–æ–º–∞—Ä–Ω–æ –ø—Ä–æ–¥–≤–∏–≥–∞–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–π LSN         |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit-—Ç–µ—Å—Ç—ã: `tests/wal_test.c`, `tests/wal_segment_test.c`
* Fuzz: `tools/fuzz/wal_corruption_fuzzer.c`
* Soak: `tools/soak/wal_parallel_commit_benchmark.c`
* Coverage: 96.3%
* –≠–º—É–ª—è—Ü–∏—è —Å–±–æ—è: –ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø–∞—É–∑–∞/–æ–±—Ä—ã–≤ –≤ –º–æ–º–µ–Ω—Ç append + –ø–æ—Å–ª–µ–¥—É—é—â–∏–π recovery

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                          | –ó–Ω–∞—á–µ–Ω–∏–µ               | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                       |
| -------------------------------- | ---------------------- | --------------------------------- |
| –°—Ä–µ–¥–Ω—è—è latency –∑–∞–ø–∏—Å–∏           | 80‚Äì200 –Ω—Å              | –ù–∞ NUMA socket –±–µ–∑ contention     |
| –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π throughput WAL      | \~1.2 –º–ª–Ω txn/—Å–µ–∫/—è–¥—Ä–æ | –í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å 8 –ø–∏—Å–∞—Ç–µ–ª—è–º–∏     |
| –°–∫–æ—Ä–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (replay) | \~320 –ú–ë/—Å–µ–∫/–ø–æ—Ç–æ–∫     | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ |
| –ö–æ–º–ø—Ä–µ—Å—Å–∏—è –ª–æ–≥–æ–≤ (compaction)    | \~60% —Å–Ω–∏–∂–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ | –ü—Ä–∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ UPDATE/DELETE       |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                              | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                               |
| ------------------------------------- | ------ | ----------------------------------------- |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ WAL –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π       | ‚úÖ 100  | INSERT, DELETE, COMMIT, ROLLBACK          |
| Compaction –∏ checkpoint               | ‚úÖ 100  | Snapshot-—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ, TTL-–∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ |
| –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ log writers —Å NUMA-aware | ‚úÖ 100  | –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –æ—á–µ—Ä–µ–¥–∏ + pinning –ø–æ —Å–æ–∫–µ—Ç–∞–º  |
| –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å recovery –∏ MVCC       | ‚úÖ 100  | lsn, tx\_id, commit flag                  |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
wal_record_t *rec = wal_alloc_record(tx->id, OP_INSERT, row_data, len);
if (!wal_append(tx->id, rec)) {
    panic("WAL append failed");
}
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –î–≤—É—Ö—Ñ–∞–∑–Ω–∞—è –∑–∞–ø–∏—Å—å –≤ –ø–∞–º—è—Ç—å –∏ nvme —Å —Ñ–ª–∞–≥–æ–º `lsn_committed`
* –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Å—É–º–º—ã –∏ CRC –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏
* Recovery –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ soft checkpoint

---

## üß© UML WAL Flow

```plantuml
start
:–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ WAL-–∑–∞–ø–∏—Å–∏;
:–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ NUMA-–∂—É—Ä–Ω–∞–ª;
if (record buffer full?) then (yes)
  :flush WAL segment;
endif
:–ü—Ä–∏—Å–≤–æ–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ LSN;
:Checkpoint flush (optional);
stop
```

---

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è

* –í–µ—Ä—Å–∏—è: `1.0-final`
* –ò–∑–º–µ–Ω–µ–Ω–∏—è:

  * `+` –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã–µ WAL-–ø–∏—Å–∞—Ç–µ–ª–∏
  * `+` –ü–æ–¥–¥–µ—Ä–∂–∫–∞ log compaction
  * `+` –ê—Ç–æ–º–∞—Ä–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã –∏ LSN-advance
  * `+` –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MVCC/Recovery

---

## üß† –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ì–∞—Ä–∞–Ω—Ç–∏—è **–Ω–µ–ª–µ—Ç—É—á–µ—Å—Ç–∏** –ø—Ä–∏ 9M –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –¥–µ–Ω—å –Ω–∞ —Ñ–∏–ª–∏–∞–ª
* –ë—ã—Å—Ç—Ä–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–∞–¥–µ–Ω–∏—è
* –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –∏ –∞—É–¥–∏—Ç –≤ –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö

