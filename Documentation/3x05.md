# üß± –ë–ª–æ–∫ 3.5 ‚Äî Cost-Based –∏ Rule-Based Optimizer

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 3 ‚Äî SQL –∏ –Ø–∑—ã–∫–∏
* **–ë–ª–æ–∫:** 3.5 ‚Äî Cost-Based –∏ Rule-Based Optimizer

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ —Å–ª—É–∂–∏—Ç —è–¥—Ä–æ–º –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, –ø—Ä–µ–æ–±—Ä–∞–∑—É—è –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –¥–µ—Ä–µ–≤—å—è –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –ø–ª–∞–Ω—ã. –í –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥: Rule-Based Optimizer (RBO) –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π, –∞ Cost-Based Optimizer (CBO) ‚Äî –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏ –≤—ã–±–æ—Ä–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å —É—á—ë—Ç–æ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏, –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç–∏, —Å–µ–ª–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                   | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                          |
| ---------------------------- | ----------------------------------------------------------------- |
| Rule-Based Optimizer         | –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è: pushdown, join reorder, predicate simplification  |
| Cost-Based Optimizer         | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç NDV, histograms, selectivity, cardinality, cost-–º–æ–¥–µ–ª—å |
| Hybrid Planner               | –ö–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ + —Å—Ç–æ–∏–º–æ—Å—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–æ–¥–¥–µ—Ä–µ–≤—å–µ–≤             |
| Adaptivity                   | –†–µ–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ runtime-–º–µ—Ç—Ä–∏–∫–∞–º, feedback loop                  |
| –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö —É–∑–ª–æ–≤ | –í—ã–±–æ—Ä join-–∞–ª–≥–æ—Ä–∏—Ç–º–∞, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏, –∏–Ω–¥–µ–∫—Å–æ–≤, —Ñ–∏–ª—å—Ç—Ä–æ–≤              |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct plan_node_t {
    plan_node_type_t type;
    cost_t estimated_cost;
    struct plan_node_t **children;
    predicate_t *filters;
} plan_node_t;

typedef struct join_order_t {
    int left_table_id;
    int right_table_id;
    double estimated_cardinality;
} join_order_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[SQL Parser] --> [Logical Plan Builder]
[Optimizer] --> [Statistics Engine]
[Optimizer] --> [Execution Planner]
[Optimizer] --> [Catalog & Metadata]
[Execution Engine] --> [Runtime Feedback]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* CBO –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –º–æ–¥–µ–ª–∏ –æ—Ü–µ–Ω–∫–∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ CPU, IO, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
* –ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: table stats, column histograms, runtime feedback
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ query re-writing: merge projection, remove redundancy
* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è bushy join tree enumeration —Å pruning –ø–æ –≤–µ—Ä—Ö–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —à–∞–±–ª–æ–Ω visitor –¥–ª—è –æ–±—Ö–æ–¥–∞ –¥–µ—Ä–µ–≤—å–µ–≤ –ø–ª–∞–Ω–∞

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/sql/optimizer/cost_model.c`
* `include/sql/optimizer/cost_model.h`
* `src/sql/optimizer/rule_engine.c`
* `include/sql/optimizer/rule_engine.h`
* `src/sql/optimizer/plan_selector.c`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏                | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                   | –û–ø–∏—Å–∞–Ω–∏–µ                           |
| -------------------------- | ---------------------------------------------------------- | ---------------------------------- |
| `optimize_query_plan`      | `plan_node_t* optimize_query_plan(logical_plan_t *input);` | –û—Å–Ω–æ–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏   |
| `apply_optimization_rules` | `void apply_optimization_rules(plan_node_t *tree);`        | Rule-based —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏           |
| `estimate_plan_cost`       | `cost_t estimate_plan_cost(plan_node_t *plan);`            | –û—Ü–µ–Ω–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–ª–∞–Ω–∞             |
| `choose_join_order`        | `join_order_t* choose_join_order(stats_catalog_t *stats);` | –ê–ª–≥–æ—Ä–∏—Ç–º –≤—ã–±–æ—Ä–∞ –ø–æ—Ä—è–¥–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/optimizer/cost_test.c`, `tests/optimizer/rules_test.c`
* Fuzzing: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤, –ø—Ä–æ–≤–µ—Ä–∫–∞ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–Ω–æ—Å—Ç–∏
* Soak: –º–∞—Å—Å–æ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è SQL –∏–∑ OLAP –Ω–∞–≥—Ä—É–∑–æ–∫
* Coverage: 91% –¥–ª—è Rule Engine, 87% –¥–ª—è Cost Engine

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: \~250 –º–∫—Å (CBO), \~50 –º–∫—Å (RBO)
* –î–æ 18% –ø—Ä–∏—Ä–æ—Å—Ç –∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –Ω–∞–∏–≤–Ω—ã–º –ø–ª–∞–Ω–æ–º
* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–∞–∂–¥—ã–µ N –æ–ø–µ—Ä–∞—Ü–∏–π –∏–ª–∏ –ø–æ —Ç—Ä–∏–≥–≥–µ—Ä—É

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π               | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                                |
| ---------------------- | ------ | ---------------------------------------------------------- |
| Rule-based –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è | 100    | –í–∫–ª—é—á–∞–µ—Ç –≤—Å–µ –±–∞–∑–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ SQL Rewriting                 |
| Cost-based –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è | 90     | –†–∞—Å—à–∏—Ä—è–µ–º–∞—è –º–æ–¥–µ–ª—å —Å—Ç–æ–∏–º–æ—Å—Ç–∏, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ NDV, —Å–µ–ª–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ |
| –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è | 85     | –†–µ–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ feedback, –Ω–æ –±–µ–∑ –ø–æ–ª–Ω–æ–π plan reuse     |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
logical_plan_t *lp = parse_sql("SELECT * FROM orders WHERE price > 100");
plan_node_t *plan = optimize_query_plan(lp);
execute_plan(plan);
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å runtime stats: –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—É–±–ø–ª–∞–Ω–æ–≤ reuse / memoization
* –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ CBO —Å ML-–º–æ–¥–µ–ª—å—é –Ω–∞ –æ—Å–Ω–æ–≤–µ query features

## üß∞ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* BI-–∑–∞–ø—Ä–æ—Å—ã: –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–∂–æ–π–Ω–æ–≤, –æ–∫–æ–Ω, –∞–≥—Ä–µ–≥–∞—Ü–∏–π
* –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞: –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–∫–ª–∏–∫–∞
* ERP-—Ä–µ–ø–æ—Ä—Ç—ã: —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º —Å—Ö–µ–º –∏ –æ–±—ä—ë–º–æ–≤

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–∫–ª—é—á–∞–µ—Ç –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –∏ —Å—Ç–æ–ª–±—Ü—ã (ACL)
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –±–µ–∑ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
* –ê—É–¥–∏—Ç-–ª–æ–≥ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã—Ö –ø–ª–∞–Ω–æ–≤

## üßæ –°–æ–æ–±—â–µ–Ω–∏—è, –æ—à–∏–±–∫–∏, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

* `ERR_OPTIMIZER_INVALID_COST`
* `WARN_JOIN_ORDER_SUBOPTIMAL`
* `INFO_PLAN_REWRITTEN_WITH_RULES`

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî RBO + basic CBO, join reorder, cost estimation
* v1.1 ‚Äî runtime feedback, adaptive re-optimization
* v1.2 ‚Äî histogram stats, rule pipeline rewrite

## üìà UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
package "SQL Optimizer" {
  class RuleEngine {
    +apply_rules()
  }
  class CostModel {
    +estimate()
  }
  class PlanSelector {
    +choose_join_order()
  }

  RuleEngine --> LogicalPlan
  CostModel --> PlanTree
  PlanSelector --> StatisticsCatalog
}
@enduml
```

---

üì© –ì–æ—Ç–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –±–ª–æ–∫–æ–º **3.6 ‚Äî –†–µ–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å (Adaptive Re-Optimization)** ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ **–¥–∞**.

