# 5.4 ‚Äî ML-–∏–Ω—Ñ–µ—Ä–µ–Ω—Å –∏ –º–æ–¥–µ–ª–∏ (ONNX / Tensorflow / PyTorch)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 5 ‚Äî BI, ML –∏ OLAP**
**–ë–ª–æ–∫ 5.4 ‚Äî ML-–∏–Ω—Ñ–µ—Ä–µ–Ω—Å –∏ –º–æ–¥–µ–ª–∏ (ONNX / Tensorflow / PyTorch)**

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –±–ª–æ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ ML/–∏–Ω—Ñ–µ—Ä–µ–Ω—Å-–º–æ–¥–µ–ª–µ–π –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏. –û–Ω –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–≤—è–∑—å –º–µ–∂–¥—É SQL-–∑–∞–ø—Ä–æ—Å–∞–º–∏ –∏ –º–æ–¥–µ–ª—è–º–∏ –Ω–∞ ONNX, Tensorflow, PyTorch –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–æ–≤, –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏, –∞–Ω–æ–º–∞–ª–∏–π –∏ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞     | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                      |
| -------------- | --------------------------------------------- |
| SQL –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è | SQL-—Ñ—É–Ω–∫—Ü–∏–∏: ML\_EVAL(), PREDICT(), CLUSTER() |
| ONNX runtime   | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å onnxruntime C API                |
| Tensorflow     | –ß–µ—Ä–µ–∑ C++ –±–∏–Ω–¥–∏–Ω–≥–∏, –≤–∞–ª–∏–¥–∞—Ü–∏—è input/output    |
| PyTorch        | –ß–µ—Ä–µ–∑ TorchScript –∏–ª–∏ libtorch C++ API        |

## üíæ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è

```c
typedef struct model_runtime_t {
  char name[MAX_NAME];
  model_type_t type;  // ONNX, TENSORFLOW, TORCH
  void *handle;
  model_metadata_t meta;
} model_runtime_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```plantuml
SQLExecutor --> MLInterface
MLInterface --> ONNXRuntime
MLInterface --> TensorflowRuntime
MLInterface --> TorchRuntime
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

* –ö–µ—à –∏–Ω—Ñ–µ—Ä–µ–Ω—Å-–º–æ–¥–µ–ª–µ–π –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏
* NUMA-aware —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
* –ê–≤—Ç–æ-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤—ã–∑–æ–≤–æ–≤ inference

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/ml/ml_interface.c`
* `src/sql/ml_functions.c`
* `src/ml/onnx_runtime.c`
* `src/ml/tf_runtime.cc`
* `include/ml/model_runtime.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –ò–º—è              | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                         | –û–ø–∏—Å–∞–Ω–∏–µ                                       |
| ---------------- | ---------------------------------------------------------------- | ---------------------------------------------- |
| `ml_eval`        | `result_t ml_eval(db_session_t *s, const char *model, row_t *r)` | –í—ã–ø–æ–ª–Ω—è–µ—Ç –∏–Ω—Ñ–µ—Ä–µ–Ω—Å –º–æ–¥–µ–ª–∏ —Å –≤—Ö–æ–¥–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ r |
| `ml_load_model`  | `int ml_load_model(const char *path, model_type_t type)`         | –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏–Ω—Ñ–µ—Ä–µ–Ω—Å-–º–æ–¥–µ–ª—å —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º —Ç–∏–ø–æ–º    |
| `ml_predict_sql` | `result_t ml_predict_sql(ast_t *query, model_runtime_t *m)`      | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞ –≤ SQL-–ø–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è     |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/ml/test_ml_interface.c`
* Fuzz: –í–≤–æ–¥—ã –¥–∞–Ω–Ω—ã—Ö –≤ ONNX-–º–æ–¥–µ–ª–∏
* Integration: SQL-–∑–∞–ø—Ä–æ—Å—ã —Å –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–æ–º

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è              | –ú–µ—Ç—Ä–∏–∫–∞  |
| --------------------- | -------- |
| ONNX –ø—Ä–æ–≥–Ω–æ–∑ –≤ SQL    | < 1.3 –º—Å |
| Tensorflow –ø–æ CPU     | 5.2 –º—Å   |
| PyTorch —Å TorchScript | 3.8 –º—Å   |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                     | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                  |
| ---------------------------- | ------ | -------------------------------------------- |
| ONNX-–ø–æ–¥–¥–µ—Ä–∂–∫–∞               | 100    | –ß–µ—Ä–µ–∑ onnxruntime                            |
| Tensorflow –∏ PyTorch support | 100    | –°—Ç–∞–±–∏–ª—å–Ω–æ–µ API, C++ –±–∏–Ω–¥—ã                    |
| SQL-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞      | 100    | ML\_EVAL(), CLUSTER(), PREDICT() —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```sql
-- –ü—Ä–æ–≥–Ω–æ–∑ —Ü–µ–Ω—ã –Ω–∞ –∑–∞–≤—Ç—Ä–∞
SELECT ML_EVAL('model_forecast', price, volume, timestamp)
FROM stocks WHERE symbol = 'AAPL';
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ batch-inference
* –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
* –°—Ç—Ä–µ–º–∏–Ω–≥ inference (Kafka –≤—Ö–æ–¥)

## üìä UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity "SQLExecutor" as SQL
entity "MLInterface" as MLI
entity "ONNXRuntime" as ONNX
entity "TensorflowRuntime" as TF
entity "TorchRuntime" as TORCH

SQL --> MLI
MLI --> ONNX
MLI --> TF
MLI --> TORCH
@enduml
```

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ü—Ä–æ–≥–Ω–æ–∑ —Å–ø—Ä–æ—Å–∞ –∏ –ø–æ—Å—Ç–∞–≤–æ–∫
* –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞ –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–¥–µ–ª–æ–∫
* –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∞–Ω–æ–º–∞–ª–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
* ML-–∞–Ω–∞–ª–∏–∑ –ø–æ–≤–µ–¥–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –°–∞–Ω–¥–±–æ–∫—Å–∏–Ω–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π
* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ –º–æ–¥–µ–ª—è–º –ø–æ —Ä–æ–ª—è–º (RBAC)
* –ò–∑–æ–ª—è—Ü–∏—è –∏–Ω—Ñ–µ—Ä–µ–Ω—Å-–º–æ–¥–µ–ª–µ–π –≤ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –Ω–∞—á–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ONNX
* v1.1 ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ TensorFlow
* v1.2 ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è TorchScript –∏ libtorch
* v1.3 ‚Äî NUMA-aware –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π

## üõë –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

| –ö–æ–¥ / –¢–∏–ø          | –£—Å–ª–æ–≤–∏–µ                           | –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏                    |
| ------------------ | --------------------------------- | ---------------------------------- |
| `E_ML_NOT_FOUND`   | –ú–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞                 | –ó–∞–ø—Ä–æ—à–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞    |
| `E_ML_IO_MISMATCH` | –ù–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ input/output —Ñ–æ—Ä–º–∞—Ç–∞ | –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ |
| `W_ML_SLOW_EXEC`   | –ò–Ω—Ñ–µ—Ä–µ–Ω—Å –ø—Ä–µ–≤—ã—à–∞–µ—Ç 10 –º—Å          | –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ –≤—ã–∑–æ–≤–∞ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞        |

