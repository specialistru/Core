# üìò 4.8 ‚Äî CDC –∏ —Å—Ç—Ä–∏–º–∏–Ω–≥ –∏–∑–º–µ–Ω–µ–Ω–∏–π (Change Data Capture: Kafka, Pulsar, Debezium)

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* –ü–∞–∫–µ—Ç 4 ‚Äî –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
* –ë–ª–æ–∫ 4.8 ‚Äî CDC –∏ —Å—Ç—Ä–∏–º–∏–Ω–≥ –∏–∑–º–µ–Ω–µ–Ω–∏–π (Change Data Capture)

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ CDC (Change Data Capture) –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ—Ç–æ–∫–æ–≤–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –∏–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Ç–∞–±–ª–∏—Ü –°–£–ë–î –≤–æ –≤–Ω–µ—à–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã ‚Äî —Ç–∞–∫–∏–µ –∫–∞–∫ Kafka, Pulsar, Redis Streams –∏ Debezium. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏, ETL, –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º–∏ –∏ –≤–Ω–µ—à–Ω–∏–º–∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º–∏ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞             | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                       |
| ---------------------- | -------------------------------------------------------------- |
| Stream Push            | –ü—Ä—è–º–æ–π push –∏–∑–º–µ–Ω–µ–Ω–∏–π (INSERT/UPDATE/DELETE) –≤–æ –≤–Ω–µ—à–Ω–∏–µ —à–∏–Ω—ã   |
| Debezium-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å | –§–æ—Ä–º–∞—Ç—ã CDC (JSON/Avro) —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç Debezium                 |
| Kafka/Pulsar           | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–∞—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤, –ø–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –∫–ª—é—á–∞–º       |
| TTL & Snapshot Mode    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –¥–µ–ª—å—Ç—ã              |
| Replay & Offset        | –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ offset, –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ, "rewind" –∏–∑–º–µ–Ω–µ–Ω–∏–π |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct cdc_event_t {
    uint64_t tx_id;
    char *table_name;
    char *op_type; // "INSERT", "UPDATE", "DELETE"
    json_t *before_image;
    json_t *after_image;
    timestamp_t ts;
} cdc_event_t;

typedef struct cdc_stream_t {
    char *stream_id;
    char *target_uri;
    cdc_format_t format;
    bool is_active;
    uint64_t last_offset;
} cdc_stream_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[CDC Engine] --> [Transaction Commit Handler]
[CDC Engine] --> [WAL Reader]
[CDC Engine] --> [Kafka Producer]
[CDC Engine] --> [Debezium Encoder]
[CDC Engine] --> [Metrics/Offset Store]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* CDC –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ —Ñ–∞–∑—ã COMMIT: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π –ø—Ä–∏ —Ñ–∏–∫—Å–∞—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è WAL –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ "–∏—Å—Ç–∏–Ω—ã" –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è/—Ä–µ–ø–ª–µ—è
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Avro –∏ JSON —Å—Ö–µ–º, auto schema evolution
* –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å idempotent replay
* –§–æ–Ω–æ–≤—ã–π worker –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å –∫–æ–Ω—Ç—Ä–æ–ª–µ–º —Å–∫–æ—Ä–æ—Å—Ç–∏

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/cdc/cdc_engine.c`
* `include/cdc/cdc_engine.h`
* `src/cdc/encoder_debezium.c`
* `src/net/kafka_writer.c`
* `src/net/pulsar_writer.c`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏           | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                         | –û–ø–∏—Å–∞–Ω–∏–µ                                        |
| --------------------- | ------------------------------------------------ | ----------------------------------------------- |
| `cdc_register_stream` | `int cdc_register_stream(cdc_stream_t *stream);` | –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π —Å—Ç—Ä–∏–º –¥–ª—è CDC                |
| `cdc_process_txn`     | `int cdc_process_txn(tx_log_t *log);`            | –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ª–æ–≥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Å–æ–±—ã—Ç–∏—è |
| `cdc_send_event`      | `int cdc_send_event(cdc_event_t *evt);`          | –û—Ç–ø—Ä–∞–≤–∫–∞ CDC —Å–æ–±—ã—Ç–∏—è –≤ —à–∏–Ω—É                     |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è CDC —Å–æ–±—ã—Ç–∏–π, —Ñ–æ—Ä–º–∞—Ç—ã Avro/JSON
* Integration: –ø–æ–ª–Ω–æ–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Kafka, replay offset
* Soak: 24/7 –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å –Ω–∞–≥—Ä—É–∑–∫–æ–π
* Fuzz: corrupt WAL ‚Üí recovery, schema mismatch

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* –°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–æ Kafka: < 2 –º—Å
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ \~5M CDC —Å–æ–±—ã—Ç–∏–π –≤ —Å—É—Ç–∫–∏ –±–µ–∑ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏
* –†–∞—Å—Ö–æ–¥ CPU < 10% –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–π CDC (—Å–∂–∞—Ç—ã–µ —Å–æ–±—ã—Ç–∏—è)

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π               | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                      |
| ---------------------- | ------ | ------------------------------------------------ |
| –†–µ–∞–ª—å–Ω–æ–µ CDC           | 100    | CDC –≤—Å—Ç—Ä–æ–µ–Ω –≤ COMMIT + –ø–æ–¥–¥–µ—Ä–∂–∫–∞ WAL replay      |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Kafka/Pulsar | 95     | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏ topic partitioning |
| Debezium —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å | 90     | –°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ Avro/JSON —Å—Ö–µ–º—ã              |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
cdc_stream_t stream = {
    .stream_id = "orders_out",
    .target_uri = "kafka://broker:9092/orders",
    .format = CDC_FORMAT_JSON,
    .is_active = true
};
cdc_register_stream(&stream);
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* GraphQL Subscriptions –ø–æ–≤–µ—Ä—Ö CDC
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ CloudEvents –∏ OpenTelemetry
* REST CDC subscriptions —Å push/poll —Ä–µ–∂–∏–º–∞–º–∏

## üß∞ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–∫–∞–∑–æ–≤, —Ç–æ–≤–∞—Ä–æ–≤, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å BI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ (Kafka ‚Üí Druid/ClickHouse)
* –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –∞—É–¥–∏—Ç–æ—Ä—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏ –ø–æ—Ç–æ–∫–æ–≤–æ–µ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ CDC –ø–æ—Ç–æ–∫–æ–≤ (TLS, Kafka mTLS)
* –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ö–µ–º –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
* –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –≤—ã–Ω–æ—Å (policy-based)

## üßæ –°–æ–æ–±—â–µ–Ω–∏—è, –æ—à–∏–±–∫–∏, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

* `ERR_CDC_STREAM_NOT_FOUND`
* `ERR_CDC_SEND_FAILED`
* `WARN_CDC_EVENT_SKIPPED`

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî JSON CDC –¥–ª—è Kafka
* v1.1 ‚Äî Debezium —Ñ–æ—Ä–º–∞—Ç, WAL replay
* v1.2 ‚Äî Pulsar, Avro, schema evolution

## üìà UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
package "CDC Engine" {
  class CDCEvent {
    +tx_id
    +table_name
    +op_type
    +before_image
    +after_image
  }
  class CDCStream {
    +stream_id
    +target_uri
    +format
    +is_active
  }
  CDCEvent --> CDCStream : sent via
  CDCStream --> KafkaProducer
  CDCStream --> WALReader
}
@enduml
```
