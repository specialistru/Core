# üß± –ë–ª–æ–∫ 2.8 ‚Äî –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (Transaction Watchdog)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 2 ‚Äî –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –∏ –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å
* **–ë–ª–æ–∫:** 2.8 ‚Äî –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (Transaction Watchdog)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

Watchdog-–º–µ—Ö–∞–Ω–∏–∑–º —Å–ª—É–∂–∏—Ç –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –Ω–∞—Ä—É—à–∞—é—â–∏—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, –ª–∏–±–æ –ø–æ–ø–∞–≤—à–∏—Ö –≤ ¬´–ø–æ–¥–≤–µ—à–µ–Ω–Ω–æ–µ¬ª —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞, –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –∏–ª–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ MVCC. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                      | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                      |
| ------------------------------- | ------------------------------------------------------------- |
| –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∑–∞–≤–∏—Å—à–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π | –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ timeout –∏ MVCC-—Ñ–ª–∞–≥–∞–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏                  |
| –ê–≤–∞—Ä–∏–π–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ            | –í—ã–¥–∞—á–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ rollback, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ª–æ–≥–æ–≤      |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MVCC               | –°—á–∏—Ç—ã–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –∫–æ–Ω—Ç—Ä–æ–ª—å —Ñ–∞–∑ commit/rollback |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Recovery           | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–±–æ—è, –ø–µ—Ä–µ–¥–∞—á–∞ –≤ –ø–æ–¥—Å–∏—Å—Ç–µ–º—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è        |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ NUMA                  | –ó–∞–ø—É—Å–∫ watchdog-–ø–æ—Ç–æ–∫–∞ –Ω–∞ –∫–∞–∂–¥–æ–º NUMA-—É–∑–ª–µ –æ—Ç–¥–µ–ª—å–Ω–æ           |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
// watchdog_event_t: —Å–æ–±—ã—Ç–∏–µ —Å–±–æ—è –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
typedef struct {
  uint64_t tx_id;
  uint64_t timestamp_ns;
  enum { TX_STUCK, TX_OVERTIME, TX_PANIC } type;
  char reason[128];
} watchdog_event_t;

// tx_monitor_t: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è
typedef struct {
  uint32_t interval_ms;
  uint32_t timeout_ms;
  atomic_uint64_t last_checked_tx;
} tx_monitor_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏ (PlantUML)

```
TransactionWatchdog --> MVCC
TransactionWatchdog --> Recovery
TransactionWatchdog --> WAL
TransactionWatchdog --> QueryExecutor
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: C23
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ NUMA-aware –ª–æ–≥–∏–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–æ–∫ –ø–æ —è–¥—Ä–∞–º
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∏ memory barriers
* –û–±—Ä–∞–±–æ—Ç–∫–∞ edge-case: nested-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, long-living —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/tx/watchdog.c`
* `include/tx/watchdog.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è                   | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                            | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                      |
| --------------------- | --------------------------------------------------- | ----------------------------------------------- |
| `watchdog_start`      | `void watchdog_start(tx_monitor_t *mon);`           | –ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π   |
| `watchdog_check_tx`   | `bool watchdog_check_tx(tx_id_t id);`               | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏           |
| `watchdog_kill_stuck` | `void watchdog_kill_stuck(tx_id_t id);`             | –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ ¬´–∑–∞–≤–∏—Å—à–µ–π¬ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ |
| `watchdog_log_event`  | `void watchdog_log_event(watchdog_event_t *event);` | –ó–∞–ø–∏—Å—å —Å–æ–±—ã—Ç–∏—è –≤ –∂—É—Ä–Ω–∞–ª –∞–Ω–æ–º–∞–ª–∏–π                |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit-—Ç–µ—Å—Ç—ã: `tests/tx/test_watchdog.c`
* Fuzzing —Å—Ü–µ–Ω–∞—Ä–∏–∏: –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–µ deadlock –∏ starvation –ø–∞—Ç—Ç–µ—Ä–Ω—ã
* Soak-—Ç–µ—Å—Ç—ã –Ω–∞ –Ω–∞–≥—Ä—É–∑–∫—É 72—á
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å Recovery –∏ WAL

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                                | –ó–Ω–∞—á–µ–Ω–∏–µ                    |
| -------------------------------------- | --------------------------- |
| –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∑–∞–≤–∏—Å–∞–Ω–∏—è    | 12 –º—Å                       |
| –í–ª–∏—è–Ω–∏–µ watchdog –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | < 1.5% CPU per NUMA node    |
| –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å —Ñ–∏–∫—Å–∞—Ü–∏–∏ —Å–±–æ–µ–≤              | 100% –ø—Ä–∏ –∑–∞–¥–∞–Ω–Ω—ã—Ö —Ç–∞–π–º–∞—É—Ç–∞—Ö |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                        | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                      |
| ------------------------------- | ------ | -------------------------------- |
| –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∑–∞–≤–∏—Å—à–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π | 100    | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Å NUMA-aware polling |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MVCC –∏ Recovery    | 100    | –ü—Ä—è–º–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ API      |
| –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å   | 100    | –ü–æ –æ–¥–Ω–æ–º—É watchdog –Ω–∞ NUMA-—É–∑–µ–ª  |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
void watchdog_check_cycle(tx_monitor_t *mon) {
  for (tx_id_t id = mon->last_checked_tx; id < tx_get_max(); ++id) {
    if (watchdog_check_tx(id)) continue;
    watchdog_kill_stuck(id);
  }
  mon->last_checked_tx = tx_get_max();
}
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Prometheus alert)
* –û–±–æ–≥–∞—â–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –¥–µ—Ç–∞–ª—è–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (query hash, —Å–µ—Å—Å–∏—è)
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenTelemetry span –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∞–Ω–∏—è

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* Watchdog –Ω–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±–µ–∑ –∞—Ç–æ–º–∞—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
* –í—Å–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –∑–∞—â–∏—â—ë–Ω–Ω—ã–π WAL
* –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç false-positives —Å grace-–∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º

## üì§ –°–æ–æ–±—â–µ–Ω–∏—è –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

* `W_TX_OVERTIME`: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø—Ä–µ–≤—ã—Å–∏–ª–∞ –ª–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏
* `W_TX_STUCK`: –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∑–∞–≤–∏—Å—à–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
* `E_TX_KILLED`: –í—ã–ø–æ–ª–Ω–µ–Ω–æ –∞–≤–∞—Ä–∏–π–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ

## üß© UML-–¥–∏–∞–≥—Ä–∞–º–º–∞ (PlantUML)

```
@startuml
package "TX Watchdog (2.8)" {
  [TX Watchdog] --> [MVCC]
  [TX Watchdog] --> [Recovery]
  [TX Watchdog] --> [WAL]
  [TX Watchdog] --> [Query Executor]
}
@enduml
```

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v0.9 ‚Äî –±–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (2025-07-10)
* v1.0 ‚Äî NUMA-aware, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MVCC –∏ Recovery (2025-07-20)
* v1.1 ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ª–æ–≥–æ–≤, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenTelemetry (–≤ –ø–ª–∞–Ω–∞—Ö)
