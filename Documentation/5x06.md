# 5.6 ‚Äî –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã –∏ –∞–≥—Ä–µ–≥–∞—Ç—ã (Time Series, Gap-Fill, Retention)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 5 ‚Äî BI, ML –∏ OLAP**
**–ë–ª–æ–∫ 5.6 ‚Äî –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã –∏ –∞–≥—Ä–µ–≥–∞—Ç—ã (Time Series, Gap-Fill, Retention)**

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –±–ª–æ–∫ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –Ω–∞—Ç–∏–≤–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤ –≤ –°–£–ë–î, –≤–∫–ª—é—á–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏, –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–æ–≤ (gap-filling), downsampling –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (retention policy). –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∑–∞–¥–∞—á –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞, IoT, –º–µ—Ç—Ä–∏–∫, —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–µ—Ä–∏–π.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞            | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                           |
| --------------------- | -------------------------------------------------- |
| –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö TimeSeries | –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ç–∏–ø: `ts_point_t(timestamp, value)`    |
| Gap-Fill              | –§—É–Ω–∫—Ü–∏—è GAP\_FILL(...), –∞–ª–≥–æ—Ä–∏—Ç–º—ã –ª–∏–Ω–µ–π–Ω–æ–π/–Ω—É–ª–µ–≤–æ–π |
| Retention Policy      | TTL-–¥–≤–∏–∂–æ–∫, –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ –ø–æ —Å—Ä–æ–∫—É                  |
| –ê–≥—Ä–µ–≥–∞—Ü–∏–∏             | SQL-—Ñ—É–Ω–∫—Ü–∏–∏: ts\_downsample, ts\_agg, ts\_delta    |
| –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è            | –í—Ä–µ–º–µ–Ω–Ω–æ–π –∏–Ω–¥–µ–∫—Å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π range scan           |

## üíæ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è

```c
typedef struct ts_point_t {
  int64_t timestamp_ns;   // –Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥—ã
  double value;            // –∑–Ω–∞—á–µ–Ω–∏–µ
} ts_point_t;

typedef struct ts_series_t {
  char series_id[MAX_SERIES];
  ts_point_t *points;
  size_t count;
  ttl_policy_t ttl;
} ts_series_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```plantuml
TSFunctions --> StorageEngine
TSFunctions --> QueryPlanner
TSFunctions --> IndexManager
TSFunctions --> GC
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –ù–∞–Ω–æ—Å–µ–∫—É–Ω–¥–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫
* NUMA-aware —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ —Å–µ—Ä–∏—è–º
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ range scan, vectorized execution

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/ts/ts_functions.c`
* `src/ts/ts_engine.c`
* `include/ts/ts_types.h`
* `src/gc/gc_retention.c`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –ò–º—è               | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                     | –û–ø–∏—Å–∞–Ω–∏–µ                            |
| ----------------- | ---------------------------------------------------------------------------- | ----------------------------------- |
| `ts_insert_point` | `int ts_insert_point(const char *id, ts_point_t p)`                          | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—á–∫–∏ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —Å–µ—Ä–∏–∏ |
| `ts_downsample`   | `result_t ts_downsample(const char *id, interval_t window)`                  | –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –æ–∫–Ω–∞–º              |
| `ts_gap_fill`     | `result_t ts_gap_fill(const char *id, interval_t window, fill_policy_t pol)` | –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–æ–≤                |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/ts/test_ts_functions.c`
* Integration: —Ç–µ—Å—Ç—ã retention + GC
* Stress: –º–∏–ª–ª–∏–æ–Ω—ã —Ç–æ—á–µ–∫ —Å gap-fill

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è         | –ú–µ—Ç—Ä–∏–∫–∞        |
| ---------------- | -------------- |
| –í—Å—Ç–∞–≤–∫–∞ —Ç–æ—á–µ–∫    | > 2M —Ç–æ—á–µ–∫/—Å–µ–∫ |
| Gap-fill 1h –æ–∫–Ω–æ | < 1.2 –º—Å       |
| Downsample 24h   | < 0.9 –º—Å       |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π          | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                       |
| ----------------- | ------ | --------------------------------- |
| –¢–∏–ø TS + gap-fill | 100    | –ù–∞—Ç–∏–≤–Ω—ã–π —Ç–∏–ø –∏ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ |
| Retention policy  | 100    | TTL –∏ GC-–º–æ–¥—É–ª—å                   |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ SQL  | 100    | –§—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ SQL-–∑–∞–ø—Ä–æ—Å–∞—Ö   |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```sql
SELECT ts_downsample('temp01', INTERVAL '5 minutes')
FROM sensors
WHERE ts > NOW() - INTERVAL '1 day';
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö —Å–µ—Ä–∏–π (event time)
* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
* –ö–æ–º–ø—Ä–µ—Å—Å–∏—è –ø–æ –∞–ª–≥–æ—Ä–∏—Ç–º—É Gorilla

## üìä UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity TSFunctions
entity StorageEngine
entity QueryPlanner
entity IndexManager
entity GC

TSFunctions --> StorageEngine
TSFunctions --> QueryPlanner
TSFunctions --> IndexManager
TSFunctions --> GC
@enduml
```

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –û—Ç—á—ë—Ç—ã –ø–æ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è
* –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
* –ê–Ω–∞–ª–∏–∑ —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç–∏ –∏ –∞–Ω–æ–º–∞–ª–∏–π

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –ø–æ series\_id (RBAC)
* TTL —Å —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ–º –ø–æ –ø–æ–ª–∏—Ç–∏–∫–µ —Ö—Ä–∞–Ω–µ–Ω–∏—è
* Audit –ª–æ–≥ –ø–æ insert/delete —Ç–æ—á–µ–∫

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –±–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å—Ç–∞–≤–∫–∏ –∏ –∑–∞–ø—Ä–æ—Å–∞
* v1.1 ‚Äî gap-fill –∏ –∞–≥—Ä–µ–≥–∞—Ç—ã
* v1.2 ‚Äî retention + GC-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

## üõë –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

| –ö–æ–¥ / –¢–∏–ø          | –£—Å–ª–æ–≤–∏–µ                   | –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏                      |
| ------------------ | ------------------------- | ------------------------------------ |
| `E_TS_NOT_FOUND`   | –°–µ—Ä–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç       | ID –Ω–µ –Ω–∞–π–¥–µ–Ω                         |
| `W_TS_TRUNCATED`   | –ü—Ä–µ–≤—ã—à–µ–Ω TTL              | –î–∞–Ω–Ω—ã–µ –æ–±—Ä–µ–∑–∞–Ω—ã –ø–æ –ø–æ–ª–∏—Ç–∏–∫–µ —Ö—Ä–∞–Ω–µ–Ω–∏—è |
| `E_TS_INSERT_FAIL` | –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É | –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ —Ç–æ—á–∫–∏             |


