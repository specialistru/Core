# 8.8 ‚Äî –°–Ω–∏–º–∫–∏, –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ (Copy-on-write Snapshots, Backup & Restore)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* –ü–∞–∫–µ—Ç 8 ‚Äî –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
* –ë–ª–æ–∫ 8.8 ‚Äî –°–Ω–∏–º–∫–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

# üß± –ë–ª–æ–∫ 8.4 ‚Äî –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (Adaptive Joins: Hash, Merge, Nested Loop)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 8 ‚Äî –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
* **–ë–ª–æ–∫:** 8.4 ‚Äî –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (Adaptive Joins: Hash, Merge, Nested Loop)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–Ω–∏–º–∫–æ–≤ (snapshots) in-memory –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ç—Ä–∞–Ω–∏—Ü, –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π. –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¥–ª—è high-availability, –∞–≤–∞—Ä–∏–π–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è, –º–∏–≥—Ä–∞—Ü–∏–∏, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –∞ —Ç–∞–∫–∂–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –±–µ–∑ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è –Ω–∞ OLTP-–Ω–∞–≥—Ä—É–∑–∫—É.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                     | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                             |
| ------------------------------ | -------------------------------------------------------------------- |
| Copy-on-Write Snapshots        | –∞—Ç–æ–º–∞—Ä–Ω—ã–µ, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–ª—è NUMA-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ—Ç–¥–µ–ª—å–Ω–æ        |
| Backup (–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ) | –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º WAL + snapshot |
| –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ (Restore)       | –∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ, WAL replay + snapshot merge              |
| –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü            | –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ (metadata + snapshot ref)                                 |
| Retention Policy               | TTL-—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–Ω–∏–º–∫–∞–º–∏, auto-purge                                  |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
// –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–Ω–∏–º–∫–∞
typedef struct db_snapshot_t {
    uint64_t timestamp;
    uint32_t snapshot_id;
    char name[64];
    snapshot_metadata_t *meta;
    page_map_t *page_bitmap;
    wal_checkpoint_t *wal_ref;
} db_snapshot_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
package "2.4 –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ" {
  [WAL Recovery] --> [–°–Ω–∏–º–∫–∏]
}
[–°–Ω–∏–º–∫–∏] --> [–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á]
[–°–Ω–∏–º–∫–∏] --> [–ë—É—Ñ–µ—Ä–Ω–∞—è –∑–æ–Ω–∞]
[–°–Ω–∏–º–∫–∏] --> [–°–∏—Å—Ç–µ–º–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: C23
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è copy-on-write —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º overhead
* –°–Ω–∏–º–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ —Ñ–æ–Ω–µ, –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ OLTP
* –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–æ—Ä–æ–∂–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ MVCC
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≥–æ—Ä—è—á–µ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å consistent snapshot

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/storage/snapshot.c`
* `include/storage/snapshot.h`
* `src/storage/backup.c`
* `src/storage/restore.c`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏            | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                 | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                    |
| ---------------------- | ------------------------------------------------------------------------ | --------------------------------------------- |
| snapshot\_create       | `db_snapshot_t *snapshot_create(const char *name)`                       | –°–æ–∑–¥–∞—ë—Ç —Å–Ω–∏–º–æ–∫ –≤ —Ç–µ–∫—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏            |
| snapshot\_restore      | `int snapshot_restore(const db_snapshot_t *snap)`                        | –í—ã–ø–æ–ª–Ω—è–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Å–Ω–∏–º–∫–∞            |
| snapshot\_clone\_table | `int snapshot_clone_table(const char *src_table, const char *dst_table)` | –ö–ª–æ–Ω–∏—Ä—É–µ—Ç —Ç–∞–±–ª–∏—Ü—É –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–Ω–∏–º–∫–∞            |
| backup\_run            | `int backup_run(const char *path)`                                       | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è |
| restore\_from\_backup  | `int restore_from_backup(const char *path)`                              | –ó–∞–ø—É—Å–∫–∞–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –∏–∑ –±—ç–∫–∞–ø–∞       |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit-—Ç–µ—Å—Ç—ã: `tests/storage/test_snapshot.c`
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ: `tests/backup_restore/test_full.c`
* Stress/Soak: –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Å–Ω–∏–º–∫–æ–≤

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* Snapshot creation: < 3 –º—Å
* –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ: –∑–∞–≤–∏—Å–∏—Ç –æ—Ç WAL (\~30‚Äì60 –ú–ë/—Å + snapshot merge)
* –ó–∞–¥–µ—Ä–∂–∫–∞ OLTP: < 1 –º—Å –≤ –º–æ–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω–∏—è snapshot

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π              | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                            |
| --------------------- | ------ | -------------------------------------- |
| –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —Å–Ω–∏–º–∫–∏     | 100    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ COW –∏ –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ snapshot    |
| –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ | 100    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ WAL+Snapshot                 |
| –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü   | 100    | –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ —á–µ—Ä–µ–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ |
| TTL –∏ Retention       | 90     | –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ                   |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
// –°–æ–∑–¥–∞–Ω–∏–µ snapshot –≤ —Ñ–æ–Ω–µ
pthread_t tid;
pthread_create(&tid, NULL, (void*)snapshot_create, "nightly-snap");
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ snapshot-—ã
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ–±–ª–∞—á–Ω—ã–º–∏ S3-—Ö—Ä–∞–Ω–∏–ª–∏—â–∞–º–∏
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ snapshot-–æ–≤ –Ω–∞ —É—Ä–æ–≤–Ω–µ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –∏–ª–∏ –ø–∞—Ä—Ç–∏—Ü–∏–∏

## üõ° –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π (–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ)
* –ö–æ–Ω—Ç—Ä–æ–ª—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ WAL –∏ snapshot —á–µ—Ä–µ–∑ CRC64

## üßæ –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –±–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è snapshot + backup
* v1.1 ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∞ TTL –∏ auto-purge

## üß© –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –í—ã—Å–æ–∫–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
* –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–∏–≥—Ä–∞—Ü–∏–∏
* –†–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ç–æ—á–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤ SLA
