# üß± –ë–ª–æ–∫ 3.1 ‚Äî SQL-–æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 3 ‚Äî SQL –∏ –Ø–∑—ã–∫–∏
* **–ë–ª–æ–∫:** 3.2 ‚Äî SQL-–æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –ø–ª–∞–Ω–∞ –≤ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å —É—á—ë—Ç–æ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏, –∏–Ω–¥–µ–∫—Å–æ–≤, –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç–∏, —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π, —Å—Ö–µ–º—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –¥–∞–Ω–Ω—ã—Ö. –û–Ω –∏–≥—Ä–∞–µ—Ç –∫–ª—é—á–µ–≤—É—é —Ä–æ–ª—å –≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –°–£–ë–î, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Å–ª–æ–∂–Ω—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤. –í–∫–ª—é—á–∞–µ—Ç –∫–∞–∫ **rule-based**, —Ç–∞–∫ –∏ **cost-based** –ø–æ–¥—Ö–æ–¥—ã, –∞ —Ç–∞–∫–∂–µ **–∞–¥–∞–ø—Ç–∏–≤–Ω—É—é –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é** –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                     | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                     |
| ------------------------------ | ------------------------------------------------------------ |
| Rule-based –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è         | Projection pushdown, join reorder, –ø—Ä–µ–¥–∏–∫–∞—Ç–Ω–∞—è —Å–∏–º–ø–ª–∏—Ñ–∏–∫–∞—Ü–∏—è |
| Cost-based –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è         | –ú–æ–¥–µ–ª—å —Å—Ç–æ–∏–º–æ—Å—Ç–∏: IO, CPU, NDV, –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã, –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å  |
| Join —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏                 | Hash join, Merge join, Index-nested loop, Grace hash         |
| –ò–Ω–¥–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑               | –í—ã–±–æ—Ä –∏–Ω–¥–µ–∫—Å–æ–≤ (bitmap/B+/hash), –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ covering-index |
| –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è         | Re-optimization, feed-forward loop, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è    |
| –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ CTE –∏ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤ | Materialization vs Inline, pull-up and merge                 |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct opt_plan_node_t {
    opt_node_type_t type;
    double estimated_cost;
    size_t estimated_rows;
    struct opt_plan_node_t **children;
    void *physical_hint; // join type, index, scan mode
} opt_plan_node_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[SQL –û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä] --> [–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫]
[SQL –û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä] --> [–ö–∞—Ç–∞–ª–æ–≥]
[SQL –û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä] --> [–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏]
[SQL –û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä] --> [–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–≤–∞ –ø—Ä–æ—Ö–æ–¥–∞: rule-based ‚Üí cost-based
* –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (—Ä–µ–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–∏)
* –ò–º–µ–µ—Ç—Å—è –º–æ–¥—É–ª—å —Å–±–æ—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ runtime
* –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å —É—á—ë—Ç–æ–º NUMA, —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏—è, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/sql/optimizer.c`
* `include/sql/optimizer.h`
* `src/sql/join_optimizer.c`
* `include/sql/join_optimizer.h`
* `src/sql/stats.c`
* `include/sql/stats.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏         | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                               | –û–ø–∏—Å–∞–Ω–∏–µ                                 |
| ------------------- | ---------------------------------------------------------------------- | ---------------------------------------- |
| `optimize_query`    | `opt_plan_node_t* optimize_query(logical_plan_t *lp, catalog_t *cat);` | –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –ø–ª–∞–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞    |
| `opt_collect_stats` | `int opt_collect_stats(table_t *table);`                               | –°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –∏ –µ—ë –∫–æ–ª–æ–Ω–æ–∫ |
| `opt_join_order`    | `void opt_join_order(opt_plan_node_t *node);`                          | –ê–ª–≥–æ—Ä–∏—Ç–º –≤—ã–±–æ—Ä–∞ –ø–æ—Ä—è–¥–∫–∞ –¥–∂–æ–π–Ω–æ–≤          |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* –Æ–Ω–∏—Ç: `tests/sql/opt_test.c`, `tests/sql/stats_test.c`
* Integration: —Å–ª–æ–∂–Ω—ã–µ –ø–ª–∞–Ω—ã, –ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã, join –Ω–∞ 4+ —Ç–∞–±–ª–∏—Ü—ã
* Soak: –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è SELECT —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –¥–∞–Ω–Ω—ã—Ö
* Mutation: –∑–∞–º–µ–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π cost-–º–æ–¥–µ–ª–∏

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: 0.2‚Äì0.5 –º—Å
* –ü–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–æ 20‚Äì40√ó –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å na—óve execution
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 100K+ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –¥–µ–Ω—å –±–µ–∑ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                              |
| ----------------------- | ------ | -------------------------------------------------------- |
| Rule-based –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ | 100    | –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã                         |
| Cost-based –º–æ–¥–µ–ª—å       | 95     | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç–∏, NDV, CPU/IO –º–æ–¥–µ–ª–∏             |
| –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è  | 85     | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –±–∞–∑–æ–≤—ã–π re-optimization, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –≤ roadmap |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
logical_plan_t *lp = sql_to_ir(ast);
opt_plan_node_t *opt = optimize_query(lp, current_catalog);
execute_plan(opt);
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–ª–Ω—ã–π feedback loop (execution stats ‚Üí replan)
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ—Ä—Ä–µ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤
* –ü—Ä–æ–≥–Ω–æ–∑ selectivity —Å ML-–º–æ–¥–µ–ª—å—é

## üß∞ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –£—Å–∫–æ—Ä–µ–Ω–∏–µ –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏ –∏ BI-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏
* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è OLTP —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (INSERT ... SELECT, JOIN ON PK/FK)
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–ª–æ–∂–Ω—ã—Ö ERP-–∑–∞–ø—Ä–æ—Å–æ–≤ –±–µ–∑ —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π –Ω–∞ —ç—Ç–∞–ø–µ –≤—ã–±–æ—Ä–∞ –∏–Ω–¥–µ–∫—Å–æ–≤
* –£—á–µ—Ç row-level security –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø–ª–∞–Ω–∞
* –ó–∞–ø—Ä–µ—Ç execution hints –¥–ª—è –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üßæ –°–æ–æ–±—â–µ–Ω–∏—è, –æ—à–∏–±–∫–∏, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

* `ERR_OPT_NO_VALID_PLAN`
* `WARN_OPT_INDEX_NOT_USED`
* `INFO_OPT_REOPT_TRIGGERED`

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî rule-based pass, basic join planner
* v1.1 ‚Äî cost-based –º–æ–¥–µ–ª—å, NDV/gistograms
* v1.2 ‚Äî runtime re-optimizer, feedback API

## üìà UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
package "SQL Optimizer" {
  class Optimizer {
    +optimize()
  }
  class PlanNode {
    +estimated_cost
    +children
  }
  Optimizer --> PlanNode
  Optimizer --> Catalog
}
@enduml
```

---

üì© –ì–æ—Ç–æ–≤ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫ **3.3 ‚Äî –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã, —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ exec hooks** –ø–æ –∫–æ–º–∞–Ω–¥–µ **–¥–∞**.

