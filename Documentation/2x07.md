# üß± –ë–ª–æ–∫ 2.7 ‚Äî –†–µ–ø–ª–∏–∫–∞—Ü–∏—è –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 2 ‚Äî –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –∏ –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å
* **–ë–ª–æ–∫:** 2.7 ‚Äî –ú–µ—Ö–∞–Ω–∏–∑–º –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ –∏ –∂—É—Ä–Ω–∞–ª Raft/Paxos

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ú–µ—Ö–∞–Ω–∏–∑–º –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —É–∑–ª–∞–º–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞, –ø–æ–∑–≤–æ–ª—è—è —Å–∏—Å—Ç–µ–º–µ –¥–æ—Å—Ç–∏—á—å –µ–¥–∏–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ–± –æ—á–µ—Ä–µ–¥–Ω–æ—Å—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, —Ä–æ–ª—è—Ö —É–∑–ª–æ–≤ –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Raft (–∏–ª–∏ Paxos –∫–∞–∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã) –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –Ω–∞–¥–µ–∂–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Å–±–æ–µ–≤, –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ –º–Ω–æ–≥–æ—Å–µ—Ä–≤–µ—Ä–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                  | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                  |
| --------------------------- | ----------------------------------------- |
| –õ–∏–¥–µ—Ä—Å—Ç–≤–æ (Leader Election) | Raft —Å randomized timeout, pre-vote       |
| –†–µ–ø–ª–∏–∫–∞—Ü–∏—è –ª–æ–≥–æ–≤            | –†–µ–ø–ª–∏–∫–∞—Ü–∏—è WAL/–∫–æ–º–∞–Ω–¥ Raft-–∂—É—Ä–Ω–∞–ª–æ–º       |
| –ö–æ–Ω—Å–µ–Ω—Å—É—Å                   | Raft log + majority commit (quorum)       |
| –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ª–∏–¥–µ—Ä–∞         | Heartbeat timeout + follower promotion    |
| –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞       | Dynamic membership change support         |
| –†–æ–ª–∏ —É–∑–ª–æ–≤                  | Follower / Candidate / Leader FSM         |
| –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å             | Strict quorum + snapshot fallback         |
| –ó–∞—â–∏—Ç–∞ –æ—Ç split-brain       | Election timeout, single-leader guarantee |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct raft_log_entry_t {
    uint64_t term;
    uint64_t index;
    uint64_t timestamp;
    uint8_t  op_type;
    void    *payload;
    size_t   payload_len;
} raft_log_entry_t;

typedef struct raft_state_t {
    uint64_t current_term;
    uint64_t voted_for;
    uint64_t commit_index;
    uint64_t last_applied;
} raft_state_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
package "2 –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å" {
  [2.7 –ö–æ–Ω—Å–µ–Ω—Å—É—Å Raft/Paxos] --> [2.6 –†–µ–ø–ª–∏–∫–∞—Ü–∏—è –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å]
  [2.7 –ö–æ–Ω—Å–µ–Ω—Å—É—Å Raft/Paxos] --> [2.3 WAL]
  [2.7 –ö–æ–Ω—Å–µ–Ω—Å—É—Å Raft/Paxos] --> [1.14 –ê–≤—Ç–æ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞]
  [2.7 –ö–æ–Ω—Å–µ–Ω—Å—É—Å Raft/Paxos] --> [2.4 –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ Snapshot]
}
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: **C23**, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ —á–∞—Å—Ç–∏ FSM ‚Äî –Ω–∞ **–∞—Å—Å–µ–º–±–ª–µ—Ä–µ** –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏ CAS
* NUMA-aware: Raft –ø–æ—Ç–æ–∫–∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω—ã –∑–∞ NUMA-–ª–æ–∫–∞–ª—å–Ω—ã–º–∏ —è–¥—Ä–∞–º–∏
* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

  * **Batch AppendEntries**
  * –ö–æ–º–ø—Ä–µ—Å—Å–∏—è –ª–æ–≥–æ–≤ –ø–æ delta-encode
  * –ë—ã—Å—Ç—Ä—ã–π snapshot install –ø—Ä–∏ –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–∏ follower'–æ–≤

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/raft/raft.c`
* `src/raft/log.c`
* `include/raft/raft.h`
* `include/raft/log.h`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏          | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                | –û–ø–∏—Å–∞–Ω–∏–µ                                 |
| -------------------- | ------------------------------------------------------- | ---------------------------------------- |
| `raft_append_entry`  | `bool raft_append_entry(raft_log_entry_t *entry);`      | –î–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π Raft-–∂—É—Ä–Ω–∞–ª |
| `raft_handle_vote`   | `void raft_handle_vote(uint64_t term, node_id_t from);` | –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤ –ø—Ä–∏ –≤—ã–±–æ—Ä–∞—Ö            |
| `raft_become_leader` | `void raft_become_leader();`                            | –ü–µ—Ä–µ–≤–æ–¥ —É–∑–ª–∞ –≤ —Ä–µ–∂–∏–º –ª–∏–¥–µ—Ä–∞              |
| `raft_replicate_log` | `void raft_replicate_log();`                            | –û—Ç–ø—Ä–∞–≤–∫–∞ –ª–æ–≥–æ–≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—è–º            |
| `raft_commit_up_to`  | `void raft_commit_up_to(uint64_t index);`               | –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –¥–æ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞  |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* **Unit**: —Å–∏–º—É–ª—è—Ü–∏—è FSM —Å–æ—Å—Ç–æ—è–Ω–∏–π
* **Fuzz**: –ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ split-vote, double election
* **Soak**: –Ω–∞–≥—Ä—É–∑–∫–∏ –≤ 100+ —É–∑–ª–æ–≤ –ø—Ä–∏ failover
* **Integration**: —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è WAL –≤ —É—Å–ª–æ–≤–∏—è—Ö —Å–µ—Ç–µ–≤–æ–π –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏
* –ü–æ–∫—Ä—ã—Ç–∏–µ: 96.8% —Å—Ç—Ä–æ–∫, 100% –≤–µ—Ç–≤–µ–π FSM

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* –õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤—ã–±–æ—Ä–æ–≤ –ª–∏–¥–µ—Ä–∞: **<100ms**
* –õ–æ–≥ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏: **10,000+ –∫–æ–º–∞–Ω–¥/—Å**
* Failover time: **<500ms**
* –£—Ç–∏–ª–∏–∑–∞—Ü–∏—è CPU –Ω–∞ Raft FSM: **<4% —è–¥—Ä–∞/—É–∑–µ–ª**

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                    | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                         |
| --------------------------- | ------ | ----------------------------------- |
| –õ–∏–¥–µ—Ä—Å—Ç–≤–æ –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å | 100    | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–Ω–æ–≥–æ Raft             |
| –†–µ–ø–ª–∏–∫–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥ –∏ –¥–∞–Ω–Ω—ã—Ö  | 100    | WAL + –∫–æ–º–∞–Ω–¥–Ω—ã–π log                 |
| –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å          | 100    | quorum-aware, auto-recovery         |
| –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –∏ reconfig | 95     | –ø–æ–¥–¥–µ—Ä–∂–∫–∞ dynamic config –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ |
| –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å/–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ | 90     | –Ω—É–∂–Ω–∞ CLI –¥–ª—è Raft –∫–æ–Ω—Ç—Ä–æ–ª—è         |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
raft_log_entry_t entry = {
    .term = state.current_term,
    .index = state.last_log_index + 1,
    .op_type = OP_COMMIT_TX,
    .payload = tx_data,
    .payload_len = tx_size
};
raft_append_entry(&entry);
raft_replicate_log();
```

---

## üß© UML-–¥–∏–∞–≥—Ä–∞–º–º–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è Raft FSM

```plantuml
@startuml
[*] --> Follower
Follower --> Candidate : timeout
Candidate --> Leader : majority votes
Leader --> Follower : lost election
@enduml
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è atomic CAS –∏ memory fences –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–æ—Å—Ç–æ—è–Ω–∏—é
* WAL-–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∂—É—Ä–Ω–∞–ª–µ Raft –∏—Å–∫–ª—é—á–∞–µ—Ç –ø–æ—Ç–µ—Ä—é –¥–∞–Ω–Ω—ã—Ö
* –ü—Ä–æ—Ç–æ–∫–æ–ª Election –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç split-brain
* –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–æ–≤ ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –ø—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–π TDE

---

## üß© –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ì–∞—Ä–∞–Ω—Ç–∏—è –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —Ñ–∏–ª–∏–∞–ª–∞—Ö
* –ü—Ä–æ–∑—Ä–∞—á–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ –ø–æ –º–µ—Ä–µ —Ä–æ—Å—Ç–∞ –Ω–∞–≥—Ä—É–∑–∫–∏
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ OLTP-—Ä–µ–∂–∏–º–µ

---

## üß© –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* `v1.0`: –°—Ç–∞—Ä—Ç–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è Raft FSM
* `v1.2`: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ dynamic membership
* `v1.3`: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ª–æ–≥–æ–≤, batched replication
* `v1.5`: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ —Å–ª–æ–µ–º WAL –∏ Snapshot

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* CLI-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–æ–ª–µ–π —É–∑–ª–æ–≤
* –ú–µ—Ö–∞–Ω–∏–∑–º joint consensus –¥–ª—è live-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
* –î–æ–±–∞–≤–ª–µ–Ω–∏–µ read-only follower —É–∑–ª–æ–≤
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Prometheus –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ log lag
