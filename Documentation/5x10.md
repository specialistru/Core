# 5.10 ‚Äî –¢–∞–π–º—Å–µ—Ä–∏–∏ (Time Series Storage and Analysis)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 5 ‚Äî BI, ML –∏ OLAP**
**–ë–ª–æ–∫ 5.10 ‚Äî –¢–∞–π–º—Å–µ—Ä–∏–∏ (Time Series Storage and Analysis)**

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Ö—Ä–∞–Ω–µ–Ω–∏–µ, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –∑–∞–ø—Ä–æ—Å—ã –∏ –∞–Ω–∞–ª–∏–∑ —Ç–∞–π–º—Å–µ—Ä–∏–π –¥–∞–Ω–Ω—ã—Ö (—Ç–µ–º–ø–æ—Ä–∞–ª—å–Ω—ã—Ö –º–Ω–æ–∂–µ—Å—Ç–≤) —Å –≤—ã—Å–æ–∫–æ–π —Å—Ç–µ–ø–µ–Ω—å—é —Å–∂–∞—Ç–∏—è, –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π downsampling, –∏ gap-filling. –û–Ω —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø–æ—Ç–æ–∫–æ–≤–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤ –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –∏—Ö –¥–ª—è OLAP-–∑–∞–ø—Ä–æ—Å–æ–≤.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞       | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                     |
| ---------------- | ------------------------------------------------------------ |
| –•—Ä–∞–Ω–µ–Ω–∏–µ TS      | –ë–∏–Ω–∞—Ä–Ω–æ–µ –∫–æ–ª–æ–Ω–Ω–æ—á–Ω–æ–µ —Å–∂–∞—Ç–∏–µ + Frame of Reference + Delta     |
| Gap filling      | –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ SQL-–¥–≤–∏–∂–∫–∞ (LAG, LEAD, —Ñ—É–Ω–∫—Ü–∏–∏ –æ–∫–æ–Ω) |
| Downsampling     | RESAMPLE(interval, agg) –≤ —Å–∞–º–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ                    |
| Retention policy | –¢TL + –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ + —Å–Ω–∞–ø—à–æ—Ç—ã                             |

## üìÄ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è

```c
typedef struct ts_point_t {
    timestamp_ns_t ts;
    double value;
} ts_point_t;

typedef struct ts_series_t {
    char series_id[36];
    ts_point_t *points;
    size_t count;
} ts_series_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```plantuml
TSQueryEngine --> TSStorage
TSStorage --> ColumnarStore
TSQueryEngine --> SQLExecutor
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ–≥–æ ingestion
* NUMA-aware –∞–ª–ª–æ–∫–∞—Ü–∏—è –ø–æ —Å–µ—Ä–∏—è–º
* –ö–æ–º–ø–∞–∫—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ SSD/–æ–ø–µ—Ä–∞—Ç–∏–≤–∫–µ

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

* `src/timeseries/ts_storage.c`
* `src/timeseries/ts_query.c`
* `include/timeseries/ts_types.h`
* `src/sql/ts_sql_functions.c`

## üîß –§—É–Ω–∫—Ü–∏–∏

| –ò–º—è               | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                           | –û–ø–∏—Å–∞–Ω–∏–µ                       |
| ----------------- | ------------------------------------------------------------------ | ------------------------------ |
| `ts_insert_point` | `int ts_insert_point(const char *id, timestamp_ns_t ts, double v)` | –î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É –≤ —Å–µ—Ä–∏—é         |
| `ts_query_range`  | `result_t ts_query_range(const char *id, ts_range_t r)`            | –í—ã–≥—Ä—É–∑–∏—Ç—å —Å–µ—Ä–∏—é –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ    |
| `ts_gapfill`      | `result_t ts_gapfill(const char *id, ts_range_t r, int step_ms)`   | –î–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–æ–≤ –≤ —Å–µ—Ä–∏–∏ |

## üî´ –¢–µ—Å—Ç—ã

* `tests/timeseries/test_ts_storage.c`
* `tests/timeseries/test_ts_query.c`
* Fuzzing: ts\_point ingestion
* Soak: high-throughput inserts, TTL deletion

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è            | –ó–Ω–∞—á–µ–Ω–∏–µ      |
| ------------------- | ------------- |
| Insert throughput   | 3.5M points/s |
| Range query latency | < 1.2 –º—Å      |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π             | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                          |
| -------------------- | ------ | ------------------------------------ |
| Gap filling          | 100    | –ß–µ—Ä–µ–∑ SQL –æ–∫–Ω–∞, LAG/LEAD             |
| Downsampling         | 100    | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞       |
| TTL/—Ä–µ—Ç–µ–Ω—à–Ω/—Å–Ω–∞–ø—à–æ—Ç—ã | 100    | –¢–µ–º–ø–æ—Ä–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º |

## üìâ UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity "TSQueryEngine" as Q
entity "TSStorage" as S
entity "SQLExecutor" as E
entity "ColumnarStore" as C

Q --> S
Q --> E
S --> C
@enduml
```

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ê–Ω–∞–ª–∏–∑ –ø–æ —á–∞—Å–æ–≤–æ–π –∏ –¥–Ω–µ–≤–Ω–æ–π –¥–∏–Ω–∞–º–∏–∫–µ
* –ú–æ–¥–µ–ª–∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–º —Ä—è–¥–∞–º
* KPI-–¥–∞—à–±–æ—Ä–¥—ã –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –†–æ–ª–µ–≤–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–∏—è–º
* –°–Ω–∞–ø—à–æ—Ç-–∏–∑–æ–ª—è—Ü–∏—è –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏
* TTL-–æ—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å –∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º

## ‚åöÔ∏è –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

* v1.0 ‚Äî –∏–Ω–∏—Ü–∏–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä—è–¥–æ–≤
* v1.1 ‚Äî gap fill + interpolation
* v1.2 ‚Äî downsampling + retention
* v1.3 ‚Äî NUMA-aware

