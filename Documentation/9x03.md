# üß± –ë–ª–æ–∫ 9.3 ‚Äî SQL-–ø—Ä–æ—Ç–æ–∫–æ–ª (Binary Protocol, PostgreSQL Wire)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 9 ‚Äî –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å
* **–ë–ª–æ–∫:** 9.3 ‚Äî SQL-–ø—Ä–æ—Ç–æ–∫–æ–ª (Binary Protocol, PostgreSQL Wire)

---

## ‚ú® –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

SQL-–ø—Ä–æ—Ç–æ–∫–æ–ª –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤–æ–π —Å–µ—Ç–µ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–æ–º –∏ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö. –û–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –±–∏–Ω–∞—Ä–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª, –∞ —Ç–∞–∫–∂–µ PostgreSQL Wire Protocol –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ PostgreSQL.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞               | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                             |
| ------------------------ | ---------------------------------------------------- |
| –ë–∏–Ω–∞—Ä–Ω—ã–π SQL-–ø—Ä–æ—Ç–æ–∫–æ–ª    | –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥ in-memory |
| PostgreSQL Wire Protocol | –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å psql, pgAdmin, JDBC/–¥—Ä.              |
| –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π        | TLS/mTLS/–ø–æ–¥–ø–∏—Å—å JWT                                 |
| –°—Ç—Ä–∏–º–∏–Ω–≥ –æ—Ç–≤–µ—Ç–æ–≤         | –û—Ç–≤–µ—Ç—ã —á–∞—Å—Ç—è–º–∏, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ cursor-based —Å—Ö–µ–º          |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ COPY           | –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –≤–≤–æ–¥/–≤—ã–≤–æ–¥ –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö        |

## üíæ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct sql_packet_t {
    uint8_t type;
    uint32_t length;
    uint8_t *payload;
} sql_packet_t;
```

## üîÆ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[SQL-–ø—Ä–æ—Ç–æ–∫–æ–ª] --> [–û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä SQL]
[SQL-–ø—Ä–æ—Ç–æ–∫–æ–ª] --> [–≠–∫–∑–µ–∫—É—Ç–æ—Ä]
[SQL-–ø—Ä–æ—Ç–æ–∫–æ–ª] --> [–°–µ—Ç–µ–≤–æ–π –¥—Ä–∞–π–≤–µ—Ä]
[SQL-–ø—Ä–æ—Ç–æ–∫–æ–ª] --> [–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: C23
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ zero-copy –±—É—Ñ–µ—Ä–æ–≤ –∏ memory pooling
* –û–±—Ä–∞–±–æ—Ç–∫–∞ in-place –±–µ–∑ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤
* –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–±–æ—Ä–∞ –º–µ–∂–¥—É –±–∏–Ω–∞—Ä–Ω—ã–º –∏ —Ç–µ–∫—Å—Ç–æ–≤—ã–º —Ä–µ–∂–∏–º–æ–º

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/net/sql_protocol.c`
* `include/net/sql_protocol.h`
* `src/net/pg_wire.c`
* `include/net/pg_wire.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏          | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                           | –û–ø–∏—Å–∞–Ω–∏–µ                                                |
| -------------------- | ------------------------------------------------------------------ | ------------------------------------------------------- |
| `sql_protocol_init`  | `void sql_protocol_init(void);`                                    | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∏–Ω–∞—Ä–Ω–æ–≥–æ SQL-–ø—Ä–æ—Ç–æ–∫–æ–ª–∞                   |
| `handle_sql_packet`  | `void handle_sql_packet(int fd, const uint8_t *buf, size_t len);`  | –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö SQL-—Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –±–∏–Ω–∞—Ä–Ω–æ–º—É –ø—Ä–æ—Ç–æ–∫–æ–ª—É |
| `pgwire_init`        | `void pgwire_init(void);`                                          | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ PostgreSQL Wire Protocol        |
| `pgwire_process_msg` | `void pgwire_process_msg(int fd, const uint8_t *buf, size_t len);` | –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π PostgreSQL –∫–ª–∏–µ–Ω—Ç–æ–≤                 |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* unit-—Ç–µ—Å—Ç—ã: `tests/net/sql_protocol_test.c`
* fuzzing: AFL++ –Ω–∞ –ø–∞—Ä—Å–∏–Ω–≥ SQL –ø–∞–∫–µ—Ç–æ–≤
* soak-—Ç–µ—Å—Ç—ã: —Å—Ç—Ä–µ—Å—Å –ø–æ–¥ –≤—ã—Å–æ–∫–æ–π QPS-–Ω–∞–≥—Ä—É–∑–∫–æ–π

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* –û–±—Ä–∞–±–æ—Ç–∫–∞ > 100K QPS/—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
* –ó–∞–¥–µ—Ä–∂–∫–∞ < 100 –º–∫—Å
* –£—Ç–∏–ª–∏–∑–∞—Ü–∏—è CPU < 5% –Ω–∞ idle —Å–µ—Å—Å–∏—è—Ö

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                  | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                       |
| ------------------------- | ------ | ------------------------------------------------- |
| –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ | 100    | PostgreSQL wire protocol –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å        | 100    | –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –±–∏–Ω–∞—Ä–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω       |
| –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å             | 95     | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ COPY –∏ custom extension –≤ roadmap       |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å              | 100    | TLS/mTLS –∏ JWT —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã                        |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
void handle_sql_packet(int fd, const uint8_t *buf, size_t len) {
    if (buf[0] == 'Q') {
        const char *query = (const char *)(buf + 5);
        executor_run_sql(session_from_fd(fd), query);
    }
}
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É PostgreSQL Extended Query Protocol
* –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –±–∏–Ω–∞—Ä–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª –≤–µ—Ä—Å–∏–∏ 2.0 —Å –∫–æ–º–ø—Ä–µ—Å—Å–∏–µ–π
* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏ negotiation

## üß∞ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å BI, SQL-–∫–ª–∏–µ–Ω—Ç–∞–º–∏, ORM
* –†–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∏ –∞—É–¥–∏—Ç —Å–µ—Å—Å–∏–π

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö —Ñ—Ä–µ–π–º–æ–≤
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ TLS/mTLS
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ JWT —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø—Ä–∞–≤ –∏ –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏

## üßæ –°–æ–æ–±—â–µ–Ω–∏—è, –æ—à–∏–±–∫–∏, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

* `ERR_INVALID_FRAME_LENGTH` ‚Äî –æ—à–∏–±–∫–∞ –≤ —Ä–∞–∑–º–µ—Ä–µ SQL-–ø–∞–∫–µ—Ç–∞
* `ERR_UNSUPPORTED_PACKET_TYPE` ‚Äî –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø —Ñ—Ä–µ–π–º–∞
* `WARN_DEPRECATED_PG_CMD` ‚Äî —É—Å—Ç–∞—Ä–µ–≤—à–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ PostgreSQL –∫–ª–∏–µ–Ω—Ç–∞

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –ò–∑–Ω–∞—á–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –±–∏–Ω–∞—Ä–Ω–æ–≥–æ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
* v1.1 ‚Äî –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è PostgreSQL Wire Protocol
* v1.2 ‚Äî –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ COPY, TLS –∏ JWT
* v2.0 (–ø–ª–∞–Ω) ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –±–∏–Ω–∞—Ä–Ω–æ–π –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ –∏ multiplexing

## üìà UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
interface SqlProtocol {
    +init()
    +handle_packet()
}
interface PgWire {
    +init()
    +process_msg()
}
SqlProtocol --> PgWire
SqlProtocol --> Executor
SqlProtocol --> SqlOptimizer
@enduml
```

