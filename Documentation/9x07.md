# ðŸ§± Ð‘Ð»Ð¾Ðº 9.7 â€” SQL-Ð¿Ñ€Ð¾Ñ‚Ð¾ÐºÐ¾Ð» Ð¸ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ñ PostgreSQL wire protocol

---

## ðŸ†” Ð˜Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð±Ð»Ð¾ÐºÐ°

* **ÐŸÐ°ÐºÐµÑ‚:** 9 â€” Ð Ð°ÑÑˆÐ¸Ñ€ÑÐµÐ¼Ð¾ÑÑ‚ÑŒ
* **Ð‘Ð»Ð¾Ðº:** 9.7 â€” SQL-Ð¿Ñ€Ð¾Ñ‚Ð¾ÐºÐ¾Ð» Ð¸ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ñ PostgreSQL wire protocol

---

## ðŸŽ¯ ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ

Ð ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑÐ¾Ð±ÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð±Ð¸Ð½Ð°Ñ€Ð½Ð¾Ð³Ð¾ SQL-Ð¿Ñ€Ð¾Ñ‚Ð¾ÐºÐ¾Ð»Ð° Ð¸ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ñ PostgreSQL wire protocol Ð¾Ð±ÐµÑÐ¿ÐµÑ‡Ð¸Ð²Ð°ÐµÑ‚ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ ÑˆÐ¸Ñ€Ð¾ÐºÐ¾Ð³Ð¾ ÑÐ¿ÐµÐºÑ‚Ñ€Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¸Ñ… Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐº Ð¸ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð², Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ `psql`, `pgAdmin`, `DBeaver`, Ð° Ñ‚Ð°ÐºÐ¶Ðµ ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ñ‹Ðµ Ð´Ñ€Ð°Ð¹Ð²ÐµÑ€Ñ‹ `JDBC` Ð¸ `ODBC`. Ð­Ñ‚Ð¾ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð²Ð°Ð¶Ð½Ð¾ Ð´Ð»Ñ Ð¾Ð±ÐµÑÐ¿ÐµÑ‡ÐµÐ½Ð¸Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¸ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð¹ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹, ÑƒÐ¶Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‰Ð¸Ñ… PostgreSQL Ð² ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ðµ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ….

## âš™ï¸ Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ

| ÐŸÐ¾Ð´ÑÐ¸ÑÑ‚ÐµÐ¼Ð°           | Ð ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ / Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸                                         |
| -------------------- | ---------------------------------------------------------------- |
| Ð¡Ð¾Ð±ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ñ‚Ð¾ÐºÐ¾Ð» | Ð‘Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ñ‚Ð¾ÐºÐ¾Ð» Ñ length-prefixed ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÑÐ¼Ð¸, handshake, auth |
| PostgreSQL ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼ | ÐŸÐ¾Ð»Ð½Ð°Ñ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ startup/auth/query/describe/parse/bind/execute |
| Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ñ           | Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ñ PostgreSQL wire Ð¿Ñ€Ð¾Ñ‚Ð¾ÐºÐ¾Ð»Ð° (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, `COPY`, `BULK`)  |
| ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð²   | Ð¡Ð¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ñ PostgreSQL 13â€“15 ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°Ð¼Ð¸ Ð¸ Ð´Ñ€Ð°Ð¹Ð²ÐµÑ€Ð°Ð¼Ð¸          |
| Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ         | TLS, user/password auth, SCRAM-SHA-256, client certificate       |

## ðŸ’¾ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…

ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° PostgreSQL wire protocol Ñ€ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð° Ð² Ð²Ð¸Ð´Ðµ state machine Ð½Ð° C Ñ Ñ‡Ñ‘Ñ‚ÐºÐ¸Ð¼ ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸ÐµÐ¼ ÐºÐ°Ð¶Ð´Ð¾Ð¼Ñƒ Ñ‚Ð¸Ð¿Ñƒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ:

```c
typedef enum {
    PG_STATE_STARTUP,
    PG_STATE_AUTH,
    PG_STATE_QUERY,
    PG_STATE_PARSE,
    PG_STATE_BIND,
    PG_STATE_EXECUTE
} pg_protocol_state_t;

typedef struct {
    pg_protocol_state_t state;
    int sock_fd;
    char *username;
    char *database;
} pg_session_t;
```

## ðŸ”„ Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¸ ÑÐ²ÑÐ·Ð¸

```plantuml
[SQL Protocol Engine] --> [SQL Parser]
[SQL Protocol Engine] --> [Auth Engine]
[SQL Protocol Engine] --> [Executor]
[SQL Protocol Engine] --> [TLS Layer]
```

## ðŸ§  ÐžÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸

* Ð ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð½Ð° C23 Ñ zero-copy read/write Ð±ÑƒÑ„ÐµÑ€Ð°Ð¼Ð¸
* ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° multiplexed ÑÐµÑÑÐ¸Ð¹ (Ð¾Ð´Ð½Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ SQL-Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹)
* Ð ÐµÐ¶Ð¸Ð¼ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð²ÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· startup message
* Ð Ð°ÑÑˆÐ¸Ñ€ÑÐµÐ¼Ð¾ÑÑ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· Ð¿Ð»Ð°Ð³Ð¸Ð½-Ð¿Ñ€Ð¾Ñ‚Ð¾ÐºÐ¾Ð»Ñ‹ (REST/GraphQL/gRPC)

## ðŸ“‚ Ð¡Ð²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ Ð¼Ð¾Ð´ÑƒÐ»Ð¸ ÐºÐ¾Ð´Ð°

* `src/net/pg_protocol.c`
* `include/net/pg_protocol.h`
* `src/net/sql_server.c`
* `src/auth/auth_engine.c`

## ðŸ”§ ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð½Ð° C

| Ð˜Ð¼Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸                | ÐŸÑ€Ð¾Ñ‚Ð¾Ñ‚Ð¸Ð¿                                                             | ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ                     |
| -------------------------- | -------------------------------------------------------------------- | ---------------------------- |
| `pg_protocol_init`         | `int pg_protocol_init(pg_session_t *sess, int sock_fd);`             | Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑÐµÑÑÐ¸Ð¸         |
| `pg_protocol_handle_input` | `int pg_protocol_handle_input(pg_session_t *sess);`                  | ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð²Ñ…Ð¾Ð´ÑÑ‰Ð¸Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ |
| `pg_protocol_send_message` | `int pg_protocol_send_message(pg_session_t *sess, const void *buf);` | ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹  |

## ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

* Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ: `psql`, `pgAdmin`, `DBeaver`, `JDBC` Ð°Ð²Ñ‚Ð¾Ñ‚ÐµÑÑ‚Ñ‹
* Fuzzing: Ð¿Ð¾Ð±Ð¸Ñ‚Ð¾Ð²Ñ‹Ðµ Ð¼ÑƒÑ‚Ð°Ñ†Ð¸Ð¸ wire-Ð¿Ð°ÐºÐµÑ‚Ð¾Ð², state machine coverage
* Soak: Ð¼Ð½Ð¾Ð³Ð¾ÑÐµÑÑÐ¸Ð¾Ð½Ð½Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ñ TLS Ð¸ SCRAM Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸ÐµÐ¹
* ÐŸÐ¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ: 95% Ð¿Ð¾ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼ Ð¿ÑƒÑ‚ÑÐ¼

## ðŸ“Š ÐŸÑ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ

* Startup latency: \~1.5 Ð¼Ñ (Ð±ÐµÐ· TLS), \~3.2 Ð¼Ñ (Ñ TLS Ð¸ SCRAM)
* Query throughput (1 ÑÐ´Ñ€Ð¾): \~12K QPS `SELECT 1`
* ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° 500+ Ð¾Ð´Ð½Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð² (1 Ð¸Ð½ÑÑ‚Ð°Ð½Ñ)

## âœ… Ð¡Ð¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ SAP HANA+

| ÐšÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¹                 | ÐžÑ†ÐµÐ½ÐºÐ° | ÐšÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹                            |
| ------------------------ | ------ | -------------------------------------- |
| Ð¡Ð¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚ÑŒ PostgreSQL | 100    | ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ñ‚Ð¾ÐºÐ¾Ð» startup/bind/execute   |
| ÐŸÑ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ       | 95     | Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð½Ð° ÑƒÑ€Ð¾Ð²Ð½Ðµ Ð±ÑƒÑ„ÐµÑ€Ð¾Ð² |
| Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ             | 100    | SCRAM, TLS, client certs Ñ€ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ñ‹   |

## ðŸ“Ž ÐŸÑ€Ð¸Ð¼ÐµÑ€ ÐºÐ¾Ð´Ð°

```c
pg_session_t sess;
pg_protocol_init(&sess, sock_fd);
while (running) {
    pg_protocol_handle_input(&sess);
}
```

## ðŸ§© Ð‘ÑƒÐ´ÑƒÑ‰Ð¸Ðµ Ð´Ð¾Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸

* ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° PostgreSQL Logical Replication Ð¿Ñ€Ð¾Ñ‚Ð¾ÐºÐ¾Ð»Ð°
* Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ñ query trace/diagnostic tools
* Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ñ Ð½Ð° ÑƒÑ€Ð¾Ð²Ð½Ðµ wire protocol (streamed query, hints)

## ðŸ§° Ð¡Ð²ÑÐ·ÑŒ Ñ Ð±Ð¸Ð·Ð½ÐµÑ-Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑÐ¼Ð¸

* Ð¡Ð¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ñ BI-Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð°Ð¼Ð¸ Ð¸ middleware
* ÐœÐ¸Ð³Ñ€Ð°Ñ†Ð¸Ñ Ñ PostgreSQL Ð±ÐµÐ· Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¾Ð³Ð¾ ÐºÐ¾Ð´Ð°
* Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ð² enterprise-ÑÑ‚ÐµÐº Ñ‡ÐµÑ€ÐµÐ· JDBC/ODBC/SQL clients

## ðŸ” Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ñ…

* ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° TLS 1.3, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° fingerprint, PIN-ÐºÐ¾Ð´Ð¾Ð²
* SCRAM-SHA-256 Ñ Ð·Ð°Ñ‰Ð¸Ñ‚Ð¾Ð¹ Ð¾Ñ‚ replay-Ð°Ñ‚Ð°Ðº
* Rate-limiting Ð¸ ban Ð¿Ð¾ IP Ð½Ð° ÑƒÑ€Ð¾Ð²Ð½Ðµ handshake

## ðŸ§¾ Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ, Ð¾ÑˆÐ¸Ð±ÐºÐ¸, Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ñ

* `ERR_PG_BAD_AUTH`
* `ERR_PG_PARSE`
* `WARN_PG_UNSUPPORTED_MESSAGE`

## ðŸ•“ Ð’ÐµÑ€ÑÐ¸Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹

* v1.0 â€” startup/auth/query
* v1.1 â€” bind/parse/describe/execute
* v1.2 â€” SCRAM/TLS, multiplexing

## ðŸ“ˆ UML-Ð´Ð¸Ð°Ð³Ñ€Ð°Ð¼Ð¼Ð°

```plantuml
@startuml
package "SQL Protocol Engine" {
  class PgProtocol {
    +init(fd)
    +handle_input()
    +send_message()
  }
  PgProtocol --> AuthEngine
  PgProtocol --> SQLParser
  PgProtocol --> Executor
}
@enduml
```
