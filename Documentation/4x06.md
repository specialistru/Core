# üìò 4.6 ‚Äî –í–Ω–µ—à–Ω–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∏ –ø–ª–∞–≥–∏–Ω—ã (External Procedures, dlopen)

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* –ü–∞–∫–µ—Ç 4 ‚Äî –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
* –ë–ª–æ–∫ 4.6 ‚Äî –í–Ω–µ—à–Ω–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∏ –ø–ª–∞–≥–∏–Ω—ã (External Procedures, dlopen)

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –±–ª–æ–∫ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –≤–Ω–µ—à–Ω–∏—Ö –ø—Ä–æ—Ü–µ–¥—É—Ä (external procedures) –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π (–ø–ª–∞–≥–∏–Ω–æ–≤) —á–µ—Ä–µ–∑ –º–µ—Ö–∞–Ω–∏–∑–º—ã `dlopen`/`LoadLibrary`. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º –ø–æ–¥–∫–ª—é—á–∞—Ç—å –Ω–∞—Ç–∏–≤–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∞–ª–≥–æ—Ä–∏—Ç–º—ã —Ä–∞—Å—á—ë—Ç–∞, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É, —Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏) –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–∫–æ–º–ø–∏–ª—è—Ü–∏–∏ —è–¥—Ä–∞ –°–£–ë–î, —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –∏ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º —Ä–µ—Å—É—Ä—Å–æ–≤.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞              | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                        |
| ----------------------- | --------------------------------------------------------------- |
| –ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞–≥–∏–Ω–æ–≤       | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `dlopen` (Linux), `LoadLibrary` (Windows), `.so/.dll` |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SQL DSL    | –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π –∏–∑ SQL/DSL –∫–∞–∫ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ                         |
| –ò–∑–æ–ª—è—Ü–∏—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è     | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç–∞–π–º-–∞—É—Ç–æ–≤, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–∞–º—è—Ç–∏, CPU, sandbox          |
| –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ | C ABI-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω–∞—è —Å–∏–≥–Ω–∞—Ç—É—Ä–∞                          |
| –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –ø–æ —Ç–∏–ø–∞–º     | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏               |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct plugin_entry_t {
    char *symbol_name;
    void *fn_ptr;
    plugin_type_t type;
    plugin_sandbox_t *sandbox;
} plugin_entry_t;

typedef struct plugin_module_t {
    char *path;
    void *handle;
    plugin_entry_t *entries;
    size_t entry_count;
} plugin_module_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[Plugin Loader] --> [Execution Engine]
[Plugin Loader] --> [Memory Manager]
[SQL Parser] --> [External Procedure Dispatcher]
[Sandbox] --> [Plugin Execution Wrapper]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è –æ –≤—ã–∑–æ–≤–∞—Ö C ABI
* –ò–∑–æ–ª—è—Ü–∏—è –≤—ã–∑–æ–≤–∞: pre-fork wrapper, timer-based execution monitor
* –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö UDF —Ç–∏–ø–æ–≤, –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤, –∞–≥–≥—Ä–µ–≥–∞—Ç–æ–≤
* –†–∞—Å—à–∏—Ä—è–µ–º–∞—è –º–æ–¥–µ–ª—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –ø–ª–∞–≥–∏–Ω–æ–≤
* –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –º–æ–¥—É–ª–µ–π (–ø–æ —Ö—ç—à—É –ø—É—Ç–∏ –∏ sig)

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/plugin/plugin_loader.c`
* `include/plugin/plugin_loader.h`
* `src/plugin/plugin_dispatcher.c`
* `src/security/plugin_sandbox.c`
* `include/security/plugin_sandbox.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏          | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                              | –û–ø–∏—Å–∞–Ω–∏–µ                              |
| -------------------- | --------------------------------------------------------------------- | ------------------------------------- |
| `plugin_load`        | `int plugin_load(const char *path, plugin_module_t **out);`           | –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞–≥–∏–Ω–∞      |
| `plugin_invoke`      | `int plugin_invoke(const char *symbol, void *args, void *ret);`       | –í—ã–∑–æ–≤ –≤–Ω–µ—à–Ω–µ–π —Ñ—É–Ω–∫—Ü–∏–∏                 |
| `plugin_register_fn` | `int plugin_register_fn(plugin_module_t *mod, const char *sym, ...);` | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ –ø–ª–∞–≥–∏–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º–µ |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: –∑–∞–≥–ª—É—à–∫–∏, —Ç–µ—Å—Ç–æ–≤—ã–µ –ø–ª–∞–≥–∏–Ω—ã
* Integration: –∑–∞–≥—Ä—É–∑–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ `.so`, SQL –≤—ã–∑–æ–≤, sandbox
* Fuzzing: —Å–∏–≥–Ω–∞—Ç—É—Ä—ã, –ø—É—Ç–∏, env injection
* Stress: –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ 100+ –ø–ª–∞–≥–∏–Ω–æ–≤, –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –≤—ã–∑–æ–≤—ã

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* –°—Ä–µ–¥–Ω—è—è latency –≤—ã–∑–æ–≤–∞: \~8‚Äì12 –º–∫—Å (C plugin, in-process)
* –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å: 1000+ —Ñ—É–Ω–∫—Ü–∏–π –±–µ–∑ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏
* Overhead sandbox: < 3%

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                   | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                        |
| -------------------------- | ------ | -------------------------------------------------- |
| DSO –ø–ª–∞–≥–∏–Ω-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å       | 95     | –°–æ–≤–º–µ—Å—Ç–∏–º–æ —Å POSIX/Windows, –Ω–æ –Ω–µ—Ç JIT inline      |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è    | 90     | Sandbox –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, –Ω–æ –Ω–µ—Ç –ø–æ–ª–Ω–æ–π wasm-–∏–∑–æ–ª—è—Ü–∏–∏ |
| –ü–æ–¥–∫–ª—é—á–∞–µ–º–æ—Å—Ç—å –≤–Ω–µ—à–Ω–∏—Ö UDF | 100    | ABI-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å, –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ        |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
plugin_module_t *mod;
plugin_load("/opt/db/plugins/libinvoice.so", &mod);
plugin_invoke("calculate_tax", args_ptr, ret_ptr);
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ WASM-–ø–ª–∞–≥–∏–Ω–æ–≤ —Å JIT-–∫–æ–º–ø–∏–ª—è—Ü–∏–µ–π
* –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –¥–µ–∫–ª–∞—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤: —Ç–∏–ø—ã, –≤–µ—Ä—Å–∏—è, —É—Å–ª–æ–≤–∏—è
* UI-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–ª–∞–≥–∏–Ω–∞–º–∏ (enable/disable/inspect)

## üß∞ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –†–∞—Å—á—ë—Ç –±–æ–Ω—É—Å–æ–≤, –Ω–∞–ª–æ–≥–æ–≤, –∫–æ–º–∏—Å—Å–∏–π –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∑–∞–∫–∞–∑—á–∏–∫–∞
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ª–µ–≥–∞—Å–∏ API —á–µ—Ä–µ–∑ C-—à–ª—é–∑—ã
* –ú–∏–≥—Ä–∞—Ü–∏—è –∫–æ–¥–∞ –∏–∑ ERP/BI —Å–∏—Å—Ç–µ–º –≤ –ø–ª–∞–≥–∏–Ω-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ë–î

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –û—Ç–¥–µ–ª—å–Ω—ã–π heap/stack –Ω–∞ –≤—ã–∑–æ–≤
* –ü—Ä–µ–∫—Ä–∞—â–µ–Ω–∏–µ long-running plugin —á–µ—Ä–µ–∑ watchdog
* –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏/—á–µ–∫—Å—É–º–º—ã –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π

## üßæ –°–æ–æ–±—â–µ–Ω–∏—è, –æ—à–∏–±–∫–∏, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

* `ERR_PLUGIN_LOAD_FAIL`
* `ERR_PLUGIN_TIMEOUT`
* `WARN_PLUGIN_SANDBOX_EXIT`

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `dlopen`, –≤—ã–∑–æ–≤ C-—Ñ—É–Ω–∫—Ü–∏–π
* v1.1 ‚Äî –ö–æ–Ω—Ç—Ä–æ–ª—å CPU/Memory, —Å–∏–≥–Ω–∞—Ç—É—Ä—ã –≤—ã–∑–æ–≤–æ–≤
* v1.2 ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∞–≥—Ä–µ–≥–∞—Ç–æ–≤ –∏ —Ç–∏–ø–æ–≤

## üìà UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
package "Plugin System" {
  class PluginLoader {
    +load()
    +register()
  }
  class PluginDispatcher {
    +invoke()
  }
  PluginLoader --> PluginDispatcher
  PluginLoader --> MemoryManager
  PluginDispatcher --> Sandbox
}
@enduml
```
