# 5.9 ‚Äî –í—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫–Ω–∞ (Time Windows, Sliding, Tumbling)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 5 ‚Äî BI, ML –∏ OLAP**
**–ë–ª–æ–∫ 5.9 ‚Äî –í—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫–Ω–∞ (Time Windows, Sliding, Tumbling)**

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –±–ª–æ–∫ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫–æ–Ω –≤ SQL-–∑–∞–ø—Ä–æ—Å–∞—Ö –∏ –∞–≥—Ä–µ–≥–∏—Ä—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö –ø–æ –æ–∫–Ω–∞–º –≤—Ä–µ–º–µ–Ω–∏. –≠—Ç–æ –æ—Å–Ω–æ–≤–∞ –¥–ª—è time-series analytics, CEP –∏ –æ–Ω–ª–∞–π–Ω-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ OLAP-–Ω–∞–≥—Ä—É–∑–∫–∏.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                 | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                 |
| -------------------------- | -------------------------------------------------------- |
| Sliding Window             | –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –æ–∫–Ω–∞ —Å –Ω–∞–∫–ª–∞–¥–∫–æ–π (OVER RANGE ... PRECEDING) |
| Tumbling Window            | –†–∞–∑–±–∏–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –¥–∏—Å–∫—Ä–µ—Ç–Ω—ã–µ –æ–∫–Ω–∞                      |
| Gap-filling / Zero Padding | –§—É–Ω–∫—Ü–∏—è FILL() –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –æ–∫–æ–Ω           |

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è

```c
typedef struct time_window_t {
  timestamp_t window_start;
  timestamp_t window_end;
  aggregate_t *aggregates;
} time_window_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```plantuml
TimeSeriesEngine --> SQLExecutor
SQLExecutor --> Aggregator
Aggregator --> TimeWindowManager
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫–æ–Ω —Å –ø–æ–º–æ—â—å—é projection pruning
* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∞–≥—Ä–µ–≥–∞—Ç—ã –¥–ª—è –æ–∫–æ–Ω: avg, first, last, delta
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ interval-based WINDOW

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏

* `src/sql/window_functions.c`
* `src/engine/time_window.c`
* `include/time_window.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –ò–º—è                 | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                         | –û–ø–∏—Å–∞–Ω–∏–µ                              |
| ------------------- | ---------------------------------------------------------------- | ------------------------------------- |
| `window_eval`       | `result_t window_eval(time_window_t *w, const row_t *r)`         | –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∞–≥—Ä–µ–≥–∞—Ü–∏–π –¥–ª—è –æ–∫–Ω–∞         |
| `fill_missing_time` | `void fill_missing_time(series_t *s, interval_t granularity)`    | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–∫–æ–Ω –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö |
| `init_window`       | `time_window_t *init_window(timestamp_t start, timestamp_t end)` | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–∫–Ω–∞ –≤—Ä–µ–º–µ–Ω–∏            |

## üî™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/sql/test_window_functions.c`
* Integration: —Ü–µ–ø–æ—á–∫–∏ SQL —Å –æ–∫–Ω–æ–≤—ã–º–∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—è–º–∏
* Fuzz: –¥–∞—Ç–∞-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —à—É–º–æ–≤

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è                       | –ó–∞–¥–µ—Ä–∂–∫–∞ |
| ------------------------------ | -------- |
| Sliding window avg, 10K rows   | 1.1 –º—Å   |
| Tumbling window sum, 100K rows | 3.2 –º—Å   |
| Gap fill (minute granularity)  | 0.6 –º—Å   |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                 | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                             |
| ------------------------ | ------ | --------------------------------------- |
| Sliding/Tumbling windows | 100    | –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è OVER() —Å RANGE/GROUPS |
| Gap filling              | 100    | –§—É–Ω–∫—Ü–∏—è FILL –∏ —à–∞–±–ª–æ–Ω—ã –≤—Ä–µ–º–µ–Ω–∏          |

## üìå –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```sql
SELECT symbol,
       avg(price) OVER (PARTITION BY symbol ORDER BY ts RANGE BETWEEN INTERVAL '5m' PRECEDING AND CURRENT ROW)
FROM market_ticks;
```

## üß∞ –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ SESSION windows
* –°—Ç—Ä–µ–º–∏–Ω–≥ aggregation
* Sliding merge –¥–ª—è –ø–æ—Ç–æ–∫–æ–≤

## üìä UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity "SQLExecutor" as SQL
entity "Aggregator" as AGG
entity "TimeWindowManager" as TIME
SQL --> AGG
AGG --> TIME
@enduml
```

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* OLAP-–æ—Ç—á—ë—Ç—ã —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏
* –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ–º N –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º
* –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —à—É–º–æ–≤

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –°–∞–Ω–¥–±–æ–∫—Å –≤ SQL-—Ñ—É–Ω–∫—Ü–∏—è—Ö
* –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ WINDOW
* –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –æ–∫–Ω–∞—Ö

## üìÖ –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

* v1.0 ‚Äî Sliding Window, Tumbling, OVER()
* v1.1 ‚Äî Gap Filling + INTERVAL
* v1.2
