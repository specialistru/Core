# 6.7 ‚Äî –ê—É–¥–∏—Ç –∏ –ª–æ–≥–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (Immutable Chain Logging, DML/DDL Audit)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 6 ‚Äî –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
**–ë–ª–æ–∫ 6.7 ‚Äî –ê—É–¥–∏—Ç –∏ –ª–æ–≥–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (Immutable Chain Logging, DML/DDL Audit)**

---

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Å–∏—Å—Ç–µ–º—É –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ –∏ –Ω–µ–∏–∑–º–µ–Ω—è–µ–º–æ–≥–æ –∞—É–¥–∏—Ç–∞ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: –æ—Ç DDL-–∫–æ–º–∞–Ω–¥ –¥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö DML-–∑–∞–ø—Ä–æ—Å–æ–≤. –ê—É–¥–∏—Ç –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–π —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–∏, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º —Ä–µ–≥—É–ª—è—Ç–æ—Ä–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, GDPR, HIPAA, ISO/IEC 27001), –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Ü–∏—Ñ—Ä–æ–≤–æ–π —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ –∏ –≤—ã—è–≤–ª–µ–Ω–∏—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∞—Ç–∞–∫.

–ö–ª—é—á–µ–≤–∞—è –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ **—Ü–µ–ø–æ—á–∫–∏ –Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã—Ö –ª–æ–≥–æ–≤ (immutable chain)**, –æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–π –Ω–∞ —Ö—ç—à-—Ü–µ–ø–æ—á–∫–∞—Ö, –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–π blockchain, –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–π –Ω–µ–∏–∑–º–µ–Ω–Ω–æ—Å—Ç–∏ –∂—É—Ä–Ω–∞–ª–∞.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                  | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                              |
| --------------------------- | --------------------------------------------------------------------- |
| DDL/DML –∞—É–¥–∏—Ç               | –ó–∞–ø–∏—Å—å –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π CREATE, DROP, INSERT, UPDATE, DELETE             |
| Immutable chain log         | –•—ç—à-—Ü–µ–ø–æ—á–∫–∞ —Å –ø–æ–¥–ø–∏—Å—å—é –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏ SHA-256 + –ø–æ–¥–ø–∏—Å—å –ø—Ä–æ—à–ª–æ–≥–æ –±–ª–æ–∫–∞ |
| Audit event categorization  | –ö–∞—Ç–µ–≥–æ—Ä–∏–∏: `SECURITY`, `DATA`, `DDL`, `DML`, `ACCESS`, `LOGIN`        |
| –•—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∏–Ω–∞—Ä–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ | –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —á—Ç–µ–Ω–∏–µ                              |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ —ç–∫—Å–ø–æ—Ä—Ç–∞ | –ü–æ–¥–∫–ª—é—á–∞–µ–º—ã–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã: `syslog`, `SIEM`, `Kafka`                      |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å RBAC           | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–æ–ª–µ–π –∏ –ø—Ä–∞–≤ –≤ –º–æ–º–µ–Ω—Ç –¥–µ–π—Å—Ç–≤–∏—è                            |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct audit_log_entry_t {
  uint64_t timestamp_ns;
  audit_event_type_t type;
  char user[MAX_USER];
  char object[MAX_NAME];
  char action[MAX_ACTION];
  char details[MAX_DETAILS];
  uint8_t hash[32];       // SHA-256 —Ç–µ–∫—É—â–µ–≥–æ –±–ª–æ–∫–∞
  uint8_t prev_hash[32];  // –•–µ—à –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –±–ª–æ–∫–∞
} audit_log_entry_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
DBExecutor --> AuditLogger
SQLParser --> AuditLogger
SecurityEngine --> AuditLogger
AuditLogger --> FileSink
AuditLogger --> SyslogSink
AuditLogger --> SIEMSink
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –ù–∞–ø–∏—Å–∞–Ω –Ω–∞ **C23**, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **SHA-256 –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π**
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–µ–∂–∏–º–æ–≤: **in-memory**, **–∂—É—Ä–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª**, **stream output**
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ **–ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—ã—Ö sink-–º–æ–¥—É–ª–µ–π** —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **lock-free –æ—á–µ—Ä–µ–¥—å** –¥–ª—è –∑–∞–ø–∏—Å–∏ –∞—É–¥–∏—Ç–∞ —Å –≤—ã—Å–æ–∫–æ–π –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å—é
* –í—Å–µ —Ö–µ—à–∏ ‚Äî –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º—ã–µ, –∞—É–¥–∏—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω –≤–Ω–µ—à–Ω–µ

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/security/audit_logger.c`
* `src/log/sha256.c`
* `include/security/audit_log_entry.h`
* `src/net/siem_export.c`
* `src/tools/audit_verifier.c`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –ò–º—è                    | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                     | –û–ø–∏—Å–∞–Ω–∏–µ                              |
| ---------------------- | ---------------------------------------------------------------------------- | ------------------------------------- |
| `audit_log_write`      | `void audit_log_write(const audit_log_entry_t *entry)`                       | –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –≤ –ª–æ–≥         |
| `audit_chain_verify`   | `bool audit_chain_verify(const char *path)`                                  | –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ü–µ–ø–æ—á–∫—É –Ω–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å      |
| `audit_log_init`       | `int audit_log_init(const char *path, audit_mode_t mode)`                    | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –∞—É–¥–∏—Ç–∞          |
| `audit_event_from_sql` | `audit_log_entry_t audit_event_from_sql(ast_t *stmt, db_session_t *session)` | –§–æ—Ä–º–∏—Ä—É–µ—Ç –∞—É–¥–∏—Ç-–∑–∞–ø–∏—Å—å –∏–∑ SQL-–∫–æ–º–∞–Ω–¥—ã |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit-—Ç–µ—Å—Ç—ã: `tests/security/test_audit_logger.c`
* Fuzz: –ø–æ–¥–¥–µ–ª—å–Ω—ã–µ / –∏—Å–∫–∞–∂—ë–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
* Integration: –∑–∞–ø—É—Å–∫ SQL —Å –∞—É–¥–∏—Ç–æ—Ä—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π
* Audit replay: –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ü–µ–ø–æ—á–µ–∫ —Ö–µ—à–µ–π –Ω–∞ replay-—Å–∫—Ä–∏–ø—Ç–∞—Ö

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è               | –ú–µ—Ç—Ä–∏–∫–∞            |
| ---------------------- | ------------------ |
| –ó–∞–ø–∏—Å—å –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏    | < 5.3 –º–∫—Å          |
| –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ SHA-256    | \~650 –Ω—Å           |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ø–æ—á–∫–∏ (10K) | \~12 –º—Å            |
| –≠–∫—Å–ø–æ—Ä—Ç –≤ Kafka        | < 3 –º—Å / —Å–æ–æ–±—â–µ–Ω–∏–µ |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π            | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                          |
| ------------------- | ------ | ------------------------------------ |
| DDL/DML –∞—É–¥–∏—Ç       | 100    | –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è              |
| –ò–º–º—É—Ç–∞–±–µ–ª—å–Ω—ã–π –∞—É–¥–∏—Ç | 100    | –•—ç—à-—Ü–µ–ø–æ—á–∫–∞, –≤–Ω–µ—à–Ω—è—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è     |
| –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å    | 100    | Sink-based –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, async –∑–∞–ø–∏—Å—å |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SIEM   | 100    | Kafka –∏ syslog –¥–æ—Å—Ç—É–ø–Ω—ã              |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```sql
-- –ê—É–¥–∏—Ç–∏—Ä—É–µ–º–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
DELETE FROM clients WHERE id = 42;

-- –í –ª–æ–≥ –∑–∞–ø–∏—à–µ—Ç—Å—è:
-- user = 'alice', action = 'DELETE', object = 'clients', details = 'id=42'
```

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ü–µ–ø–æ—á–∫–∏ Merkle –¥–ª—è —à–∞—Ä–¥–∏–Ω–≥–∞
* –ê—É–¥–∏—Ç –≤—ã–∑–æ–≤–æ–≤ UDF –∏ –≤–Ω–µ—à–Ω–∏—Ö –ø—Ä–æ—Ü–µ–¥—É—Ä
* –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è: –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏, deadlock, resource usage

---

## üìä UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity "SQLParser" as PARSER
entity "DBExecutor" as EXEC
entity "SecurityEngine" as SEC
entity "AuditLogger" as AUDIT
database "FileSink" as FILE
cloud "SyslogSink" as SYSLOG
cloud "SIEMSink" as SIEM

PARSER --> AUDIT
EXEC --> AUDIT
SEC --> AUDIT
AUDIT --> FILE
AUDIT --> SYSLOG
AUDIT --> SIEM
@enduml
```

---

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º —Ä–µ–≥—É–ª—è—Ç–æ—Ä–æ–≤
* –ö—Ä–∏–º–∏–Ω–∞–ª–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø–æ—Å–ª–µ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–æ–≤
* –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –í—Å–µ –ª–æ–≥–∏ ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è
* –ü–æ–¥–ø–∏—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –Ω–∞ snapshot-–∞—É–¥–∏—Ç–∞—Ö
* –ü—Ä–æ–≤–µ—Ä–∫–∞ –∂—É—Ä–Ω–∞–ª–æ–≤ –≤ —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –∞—É–¥–∏—Ç-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ö

---

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –í–µ—Ä—Å–∏—è | –ò–∑–º–µ–Ω–µ–Ω–∏–µ                                    |
| ------ | -------------------------------------------- |
| v1.0   | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–∞–∑–æ–≤–æ–≥–æ –∞—É–¥–∏—Ç–∞ DDL/DML            |
| v1.1   | –•—ç—à-—Ü–µ–ø–æ—á–∫–∞ SHA-256                          |
| v1.2   | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SIEM/Kafka                      |
| v1.3   | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ in-memory sink –∏ –≤–Ω–µ—à–Ω–µ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ |

---

## üõë –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

| –ö–æ–¥                  | –£—Å–ª–æ–≤–∏–µ                        | –û–ø–∏—Å–∞–Ω–∏–µ                                       |
| -------------------- | ------------------------------ | ---------------------------------------------- |
| `E_AUDIT_WRITE`      | –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ –ª–æ–≥            | –§–∞–π–ª –ª–æ–≥–∞ –ø–æ–≤—Ä–µ–∂–¥—ë–Ω –∏–ª–∏ –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω            |
| `W_AUDIT_CHAIN_MISS` | –ù–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ö–µ—à–µ–π             | –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏—è –∂—É—Ä–Ω–∞–ª–∞            |
| `E_SINK_DOWN`        | Sink (Kafka/syslog) –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω | –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è, –ø–∏—à–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ |
