# ðŸ“˜ 4.4 â€” ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° WebSocket Ð¸ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¾Ðº

## ðŸ†” Ð˜Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð±Ð»Ð¾ÐºÐ°

* ÐŸÐ°ÐºÐµÑ‚ 4 â€” Ð˜Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÑ‹ Ð¸ Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¸
* Ð‘Ð»Ð¾Ðº 4.4 â€” ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° WebSocket Ð¸ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¾Ðº

## ðŸŽ¯ ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ

Ð”Ð°Ð½Ð½Ñ‹Ð¹ Ð±Ð»Ð¾Ðº Ð¾Ð±ÐµÑÐ¿ÐµÑ‡Ð¸Ð²Ð°ÐµÑ‚ Ð´Ð²ÑƒÐ½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½ÑƒÑŽ Ð¸ Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½ÑƒÑŽ ÐºÐ¾Ð¼Ð¼ÑƒÐ½Ð¸ÐºÐ°Ñ†Ð¸ÑŽ Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°Ð¼Ð¸ Ñ‡ÐµÑ€ÐµÐ· WebSocket-Ð¿Ñ€Ð¾Ñ‚Ð¾ÐºÐ¾Ð». ÐžÐ½ Ñ€ÐµÐ°Ð»Ð¸Ð·ÑƒÐµÑ‚ Ð¼ÐµÑ…Ð°Ð½Ð¸Ð·Ð¼ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ Ð½Ð° Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… (data subscriptions), ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸Ð¹, ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¸ Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ñ‹Ðµ Ð²Ñ‹Ð·Ð¾Ð²Ñ‹. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð´Ð»Ñ Ð¿Ð¾ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¸Ñ real-time UI, Ñ€ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ð¾Ð¹ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¸ Ñ Ð²Ð½ÐµÑˆÐ½Ð¸Ð¼Ð¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ð°Ð¼Ð¸ Ð¸ Ð½Ð¾Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¹.

## âš™ï¸ Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ

| ÐŸÐ¾Ð´ÑÐ¸ÑÑ‚ÐµÐ¼Ð°          | Ð ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ / Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸                                             |
| ------------------- | -------------------------------------------------------------------- |
| WebSocket Server    | RFC 6455-ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð°Ñ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ñ TLS/mTLS                           |
| ÐŸÐ¾Ð´Ð¿Ð¸ÑÐºÐ¸ Ð½Ð° ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ | SQL-Ð¾Ñ€Ð¸ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ Ð¿Ð¾ ÑˆÐ°Ð±Ð»Ð¾Ð½Ð°Ð¼ (Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°, ÐºÐ¾Ð»Ð¾Ð½ÐºÐ°, ÑƒÑÐ»Ð¾Ð²Ð¸Ðµ) |
| Delivery Engine     | ÐžÑ‡ÐµÑ€ÐµÐ´ÑŒ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹, Ð±ÑƒÑ„ÐµÑ€Ð¸Ð·Ð°Ñ†Ð¸Ñ, QoS                           |
| Client Session      | ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° ÑÐµÑÑÐ¸Ð¹, Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸, multiplexing Ð¿Ð¾ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ°Ð¼             |
| Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…      | JSON, Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ðµ Ñ„Ñ€ÐµÐ¹Ð¼Ñ‹, Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° protobuf/MessagePack                |

## ðŸ’¾ Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…

```c
typedef struct ws_subscription_t {
    char *topic;
    char *filter_expr;
    ws_qos_t qos_level;
    ws_client_t *subscriber;
} ws_subscription_t;

typedef struct ws_event_t {
    char *event_name;
    json_value_t *payload;
    uint64_t timestamp_ns;
} ws_event_t;
```

## ðŸ”„ Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¸ ÑÐ²ÑÐ·Ð¸

```plantuml
[WebSocket Layer] --> [Event Dispatcher]
[Event Dispatcher] --> [Storage Engine]
[WebSocket Layer] --> [Auth Engine]
[WebSocket Layer] --> [Session Tracker]
```

## ðŸ§  ÐžÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸

* Ð¡ÐµÑ€Ð²ÐµÑ€Ð½Ð°Ñ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ WebSocket Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¾Ð¹ TLS Ð¸ ping/pong
* ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° multiplexed Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¾Ðº Ð² Ð¾Ð´Ð½Ð¾Ð¹ ÑÐµÑÑÐ¸Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
* QoS 0/1: fire-and-forget Ð¸ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ
* Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ñ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹ Ð¿Ð¾ SQL-ÑƒÑÐ»Ð¾Ð²Ð¸ÑÐ¼ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, `price > 100`)
* Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ñ CDC Ð¸ WAL Ð´Ð»Ñ Ñ€ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ð¾Ð¹ Ð¿Ð¾Ñ‚Ð¾ÐºÐ¾Ð²Ð¾Ð¹ Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‡Ð¸

## ðŸ“‚ Ð¡Ð²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ Ð¼Ð¾Ð´ÑƒÐ»Ð¸ ÐºÐ¾Ð´Ð°

* `src/ws/ws_server.c`
* `include/ws/ws_server.h`
* `src/ws/ws_dispatch.c`
* `include/ws/ws_dispatch.h`
* `src/ws/ws_event.c`

## ðŸ”§ ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð½Ð° C

| Ð˜Ð¼Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸        | ÐŸÑ€Ð¾Ñ‚Ð¾Ñ‚Ð¸Ð¿                                                                        | ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ                     |
| ------------------ | ------------------------------------------------------------------------------- | ---------------------------- |
| `ws_start_server`  | `int ws_start_server(const ws_config_t *cfg);`                                  | Ð—Ð°Ð¿ÑƒÑÐº WebSocket-ÑÐµÑ€Ð²ÐµÑ€Ð°     |
| `ws_subscribe`     | `int ws_subscribe(ws_client_t *client, const char *topic, const char *filter);` | Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸         |
| `ws_publish_event` | `int ws_publish_event(const ws_event_t *event);`                                | ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÑ‡Ð¸ÐºÐ°Ð¼ |

## ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

* Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹: `tests/ws/ws_test.c`, ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¸ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸/Ð¾Ñ‚Ð¿Ð¸ÑÐºÐ¸/ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹
* Soak-Ñ‚ÐµÑÑ‚Ñ‹: Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ >10K ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð², Ð¼Ð°ÑÑÐ¾Ð²Ð°Ñ Ñ€Ð°ÑÑÑ‹Ð»ÐºÐ° ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹
* Fuzzing: Ð²Ñ…Ð¾Ð´ÑÑ‰Ð¸Ðµ JSON Ñ„Ñ€ÐµÐ¹Ð¼Ñ‹, Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹
* ÐŸÐ¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ: 94%

## ðŸ“Š ÐŸÑ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ

* Ð¡Ñ€ÐµÐ´Ð½ÑÑ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ° Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ: \~300 Ð¼ÐºÑ
* ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Ð´Ð¾ 50K Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¾Ðº Ð½Ð° ÑƒÐ·ÐµÐ»
* ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ½Ð°Ñ ÑÐ¿Ð¾ÑÐ¾Ð±Ð½Ð¾ÑÑ‚ÑŒ: \~1 Ð¼Ð»Ð½ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹/ÑÐµÐº Ð¿Ñ€Ð¸ QoS 0

## âœ… Ð¡Ð¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ðµ SAP HANA+

| ÐšÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¹           | ÐžÑ†ÐµÐ½ÐºÐ° | ÐšÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹                                               |
| ------------------ | ------ | --------------------------------------------------------- |
| WebSocket server   | 100    | ÐŸÐ¾Ð»Ð½Ð°Ñ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ð¾ RFC, TLS, multiplexed                |
| ÐŸÐ¾Ð´Ð¿Ð¸ÑÐºÐ¸ Ð½Ð° Ð´Ð°Ð½Ð½Ñ‹Ðµ | 95     | Ð ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð¾ Ð¿Ð¾ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñƒ/Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ðµ, Ð±ÐµÐ· GraphQL Subscriptions |

## ðŸ“Ž ÐŸÑ€Ð¸Ð¼ÐµÑ€ ÐºÐ¾Ð´Ð°

```c
ws_event_t evt = {
    .event_name = "product_price_update",
    .payload = json_from_kv("price", "199.99"),
    .timestamp_ns = current_time_ns()
};
ws_publish_event(&evt);
```

## ðŸ§© Ð‘ÑƒÐ´ÑƒÑ‰Ð¸Ðµ Ð´Ð¾Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸

* ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° GraphQL Subscriptions Ñ‡ÐµÑ€ÐµÐ· WebSocket
* Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸Ðµ QoS ÑƒÑ€Ð¾Ð²Ð½ÐµÐ¹, reconnect replay
* ÐžÐ±ÑŠÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¾Ðº Ñ CDC Ð¸ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¾Ð¹

## ðŸ§° Ð¡Ð²ÑÐ·ÑŒ Ñ Ð±Ð¸Ð·Ð½ÐµÑ-Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑÐ¼Ð¸

* UI-Ñ€ÐµÐ°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ: Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ†ÐµÐ½, Ð·Ð°ÐºÐ°Ð·Ð¾Ð², Ð»Ð¾Ð³Ð¾Ð² Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸
* ERP: ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸ÑÑ… Ð² SCM, HR, CRM
* BI-Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¸: Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ° Ð½Ð° Ð´ÐµÐ»ÑŒÑ‚Ñ‹ Ð¸ Ñ‚Ñ€Ð¸Ð³Ð³ÐµÑ€Ñ‹ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¸

## ðŸ” Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ñ…

* ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° RBAC Ð½Ð° ÑƒÑ€Ð¾Ð²Ð½Ðµ topic/ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹
* ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð¶Ð¸Ð·Ð½Ð¸ ÑÐµÑÑÐ¸Ð¸, Ð°Ð½Ñ‚Ð¸-ÑÐ¿ÑƒÑ„Ð¸Ð½Ð³, TLS Ð¼Ð°Ð½Ð´Ð°Ñ‚Ñ‹
* Rate limiting Ð¸ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ

## ðŸ§¾ Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ, Ð¾ÑˆÐ¸Ð±ÐºÐ¸, Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ñ

* `ERR_WS_TOPIC_INVALID`
* `WARN_WS_DISCONNECT_TIMEOUT`
* `INFO_WS_SUBSCRIBED_SUCCESS`

## ðŸ•“ Ð’ÐµÑ€ÑÐ¸Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹

* v1.0 â€” WebSocket API, Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸, JSON-Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚
* v1.1 â€” QoS, Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ, CDC binding
* v1.2 â€” topic-Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹, Ð°Ð½Ñ‚Ð¸-Ñ„Ð»ÑƒÐ´ Ð·Ð°Ñ‰Ð¸Ñ‚Ð°, heartbeat

## ðŸ“ˆ UML-Ð´Ð¸Ð°Ð³Ñ€Ð°Ð¼Ð¼Ð°

```plantuml
@startuml
package "WebSocket Engine" {
  class WebSocketServer {
    +start_server()
    +stop_server()
  }
  class SubscriptionManager {
    +subscribe()
    +unsubscribe()
  }
  class EventDispatcher {
    +publish_event()
  }
  WebSocketServer --> SubscriptionManager
  SubscriptionManager --> EventDispatcher
  EventDispatcher --> StorageEngine
}
@enduml
```
