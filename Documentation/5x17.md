# 5.17 ‚Äî –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ Query Tracing

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 5 ‚Äî BI, ML –∏ OLAP**
**–ë–ª–æ–∫ 5.17 ‚Äî –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ Query Tracing**

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL-–∑–∞–ø—Ä–æ—Å–æ–≤: —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫—É, –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é ¬´—Ç—è–∂—ë–ª—ã—Ö¬ª –∑–∞–ø—Ä–æ—Å–æ–≤, —É–∑–∫–∏—Ö –º–µ—Å—Ç –∏ –≤–∑–∞–∏–º–æ–±–ª–æ–∫–∏—Ä–æ–≤–æ–∫. –ö—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è DevOps-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ä–∏—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ SLA.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                    | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                         |
| ----------------------------- | ------------------------------------------------ |
| Query Tracing                 | –í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è, –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Ñ–∞–∑–∞–º |
| –ú–µ—Ç—Ä–∏–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è            | –í—Ä–µ–º—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è, —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏     |
| –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ | JSON/binary, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ stderr/syslog             |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenTelemetry    | –°–ø–∞–Ω—ã, –ª–µ–π–±–ª—ã, –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã                         |

## üíæ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è

```c
typedef struct query_trace_t {
  uuid_t query_id;
  uint64_t plan_time_ns;
  uint64_t exec_time_ns;
  uint64_t io_time_ns;
  trace_phase_t *phases;
  size_t phase_count;
} query_trace_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
QueryExecutor --> QueryTracer
QueryTracer --> Logger
QueryTracer --> OpenTelemetryExporter
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –í—ã—Å–æ–∫–æ—Ç–æ—á–Ω–∞—è –≤—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞ (–Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥—ã)
* –ó–∞–ø–∏—Å—å —Ñ–∞–∑: parse, plan, execute, io, fetch
* –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å: –ø–æ–¥–∫–ª—é—á–∞–µ–º—ã–µ —ç–∫—Å–ø–æ—Ä—Ç—ë—Ä—ã
* NUMA-aware –±—É—Ñ–µ—Ä—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/query/tracer.c`
* `src/log/logger.c`
* `src/telemetry/otel_exporter.c`
* `include/query/tracer.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –ò–º—è                  | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                          | –û–ø–∏—Å–∞–Ω–∏–µ                          |
| -------------------- | ----------------------------------------------------------------- | --------------------------------- |
| `query_trace_start`  | `void query_trace_start(query_trace_t *trace)`                    | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ |
| `query_trace_phase`  | `void query_trace_phase(query_trace_t *trace, const char *phase)` | –û—Ç–º–µ—Ç–∫–∞ –Ω–∞—á–∞–ª–∞ –Ω–æ–≤–æ–π —Ñ–∞–∑—ã         |
| `query_trace_finish` | `void query_trace_finish(query_trace_t *trace)`                   | –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∏ —ç–∫—Å–ø–æ—Ä—Ç —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ |
| `trace_export_otel`  | `void trace_export_otel(const query_trace_t *trace)`              | –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ OpenTelemetry   |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/query/test_tracer.c`
* Integration: —Ç–µ—Å—Ç—ã —Å OpenTelemetry backend
* Stress: 1M+ –∑–∞–ø—Ä–æ—Å–æ–≤/—á–∞—Å, –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                       | –ó–Ω–∞—á–µ–Ω–∏–µ |
| ----------------------------- | -------- |
| –ù–∞–∫–ª–∞–¥–Ω—ã–µ –Ω–∞ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫—É      | < 2.1%   |
| –í—Ä–µ–º—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (JSON)     | < 0.8 –º—Å |
| –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è —á–∞—Å—Ç–æ—Ç–∞ —Å–ø–∞–Ω–æ–≤ | > 20K/s  |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                   | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                |
| -------------------------- | ------ | ------------------------------------------ |
| Tracing –∏ span-–ª–æ–≥–∏–∫–∞      | 100    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–∞–∑, JSON, OTEL, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å DevOps-—Å—Ä–µ–¥–æ–π | 100    | Prometheus, OpenTelemetry, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ     |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
query_trace_t trace;
query_trace_start(&trace);
query_trace_phase(&trace, "parse");
// –ø–∞—Ä—Å–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–∞...
query_trace_phase(&trace, "plan");
// –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...
query_trace_finish(&trace);
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Zipkin, Jaeger
* –†–µ—Ç—Ä–æ—Å–ø–µ–∫—Ç–∏–≤–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø–ª–∞–Ω–æ–≤
* –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è timeline –≤ UI

## üìä UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity "QueryExecutor" as EXEC
entity "QueryTracer" as TRACER
entity "Logger" as LOG
entity "OpenTelemetryExporter" as OTEL

EXEC --> TRACER
TRACER --> LOG
TRACER --> OTEL
@enduml
```

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* SLA –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞—É–¥–∏—Ç–∞ –∏ –æ—Ç–ª–∞–¥–∫–∏
* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —É–∑–∫–∏—Ö –º–µ—Å—Ç

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –û—Ç—Å–µ—á–µ–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏
* RBAC-–¥–æ—Å—Ç—É–ø –∫ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞–º –ø–æ —Å–µ—Å—Å–∏–∏/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –±–∞–∑–æ–≤—ã–π tracer
* v1.1 ‚Äî OpenTelemetry —ç–∫—Å–ø–æ—Ä—Ç
* v1.2 ‚Äî NUMA-aware –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∞–Ω—ã

## üõë –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

| –ö–æ–¥ / –¢–∏–ø          | –£—Å–ª–æ–≤–∏–µ                     | –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏                      |
| ------------------ | --------------------------- | ------------------------------------ |
| `E_TRACE_DISABLED` | –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞      | –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ |
| `W_TRACE_SKIPPED`  | –ü—Ä–æ–ø—É—Å–∫ —Ñ–∞–∑—ã –∏–∑-–∑–∞ –Ω–∞–≥—Ä—É–∑–∫–∏ | –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ ‚Äî –ø—Ä–æ–ø—É—â–µ–Ω —Å–ø–∞–Ω     |


