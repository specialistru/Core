# 5.21 ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞ BI: Materialized Views, CUBE/ROLLUP, –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∞–≥—Ä–µ–≥–∞—Ç—ã

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 5 ‚Äî BI, ML –∏ OLAP**
**–ë–ª–æ–∫ 5.21 ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞ BI: Materialized Views, CUBE/ROLLUP, –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∞–≥—Ä–µ–≥–∞—Ç—ã**

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (BI) –≤ —Å–∏—Å—Ç–µ–º–µ. –û–Ω –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö, –≤–∫–ª—é—á–∞—è –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (materialized views), –º–Ω–æ–≥–æ–º–µ—Ä–Ω—É—é –∞–≥—Ä–µ–≥–∞—Ü–∏—é (CUBE, ROLLUP) –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∞–≥—Ä–µ–≥–∞—Ç—ã, —Ä–µ–∞–≥–∏—Ä—É—é—â–∏–µ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö. –≠—Ç–∏ –º–µ—Ö–∞–Ω–∏–∑–º—ã –∫—Ä–∏—Ç–∏—á–Ω—ã –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏, OLAP-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≤ real-time BI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ö.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                      | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                              |
| ------------------------------- | --------------------------------------------------------------------- |
| –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è | –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ Changefeed, –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞             |
| ROLLUP –∏ CUBE                   | –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ SQL-–ø–∞—Ä—Å–µ—Ä–∞, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ group sets, hierarchical grouping   |
| –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∞–≥—Ä–µ–≥–∞—Ç—ã             | –ê–≥—Ä–µ–≥–∞—Ç—ã —Å TTL, –ø–µ—Ä–µ—Å—á—ë—Ç –ø–æ –∏–≤–µ–Ω—Ç–∞–º, –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏ |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct matview_t {
  char name[MAX_NAME];
  ast_t *definition;
  table_t *storage;
  timestamp_t last_refresh;
  refresh_policy_t policy;
} matview_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
SQLParser --> AggregationPlanner
AggregationPlanner --> MaterializedViewManager
MaterializedViewManager --> ChangefeedEngine
QueryExecutor --> AdaptiveAggregator
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ –º–µ—Ö–∞–Ω–∏–∑–º—ã CDC (change data capture)
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ column-store –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–≥—Ä–µ–≥–∞—Ç–æ–≤
* Runtime-–¥–µ—Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—è –∏ —Ä–µ–∫–æ–º–ø–∏–ª—è—Ü–∏—è ROLLUP-–ø–ª–∞–Ω–æ–≤
* NUMA-aware —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/sql/rollup.c`
* `src/sql/matview.c`
* `src/sql/adaptive_agg.c`
* `include/sql/matview.h`
* `include/sql/agg_planner.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è                       | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                 | –û–ø–∏—Å–∞–Ω–∏–µ                                               |
| ------------------------- | ------------------------------------------------------------------------ | ------------------------------------------------------ |
| `matview_refresh`         | `int matview_refresh(matview_t *mv)`                                     | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è            |
| `plan_rollup_query`       | `plan_t *plan_rollup_query(ast_t *ast)`                                  | –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ —Å —É—á–µ—Ç–æ–º ROLLUP –∏–ª–∏ CUBE              |
| `adaptive_aggregate_eval` | `result_t adaptive_aggregate_eval(const char *agg, const rowset_t *set)` | –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–≥—Ä–µ–≥–∞—Ç–æ–≤ —Å –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π –ø–µ—Ä–µ—Å—á—ë—Ç–∞ |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/sql/test_matview.c`, `tests/sql/test_rollup.c`
* Fuzz: –∞–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–≥—Ä–µ–≥–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Å group sets
* Soak: –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã –Ω–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
* Coverage: >92% –ø–æ —Å—Ç—Ä–æ–∫–∞–º, >88% –ø–æ –≤–µ—Ç–≤–ª–µ–Ω–∏—è–º

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è                    | –ú–µ—Ç—Ä–∏–∫–∞                  |
| --------------------------- | ------------------------ |
| –ú–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π SELECT    | < 2.1 –º—Å                 |
| ROLLUP-–∑–∞–ø—Ä–æ—Å –Ω–∞ 10^6 —Å—Ç—Ä–æ–∫ | \~ 3.9 –º—Å                |
| –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π COUNT\_DISTINCT  | 1.7 –º—Å, \~3% –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                     | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                      |
| ---------------------------- | ------ | ------------------------------------------------ |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ materialized views | 100    | –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∞, CDC                 |
| ROLLUP –∏ CUBE –≤ SQL          | 100    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Å–æ–≥–ª–∞—Å–Ω–æ SQL:2011+      |
| –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∞–≥—Ä–µ–≥–∞—Ç—ã          | 95     | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ TTL –∏ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏, –≤ –ø–ª–∞–Ω–∞—Ö ‚Äî ML-–∞–Ω–∞–ª–∏–∑ |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```sql
-- –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å —Å CUBE
SELECT region, product, SUM(sales)
FROM sales_data
GROUP BY CUBE (region, product);

-- –°–æ–∑–¥–∞–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
CREATE MATERIALIZED VIEW mv_sales_summary AS
SELECT region, SUM(sales) FROM sales_data GROUP BY region;

CALL REFRESH MATERIALIZED VIEW mv_sales_summary;
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è ML-—ç–≤—Ä–∏—Å—Ç–∏–∫–∞ –¥–ª—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∞–≥—Ä–µ–≥–∞—Ç–æ–≤
* –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è –Ω–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –∫–ª–∞—Å—Ç–µ—Ä–∞—Ö
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∞–≥—Ä–µ–≥–∞—Ç–æ–≤ –≤ materialized views

## üìä UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity "SQLParser" as PARSER
entity "AggregationPlanner" as PLANNER
entity "MaterializedViewManager" as MV
entity "ChangefeedEngine" as CDC
entity "QueryExecutor" as EXEC
entity "AdaptiveAggregator" as AAGG

PARSER --> PLANNER
PLANNER --> MV
MV --> CDC
EXEC --> AAGG
@enduml
```

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* BI-–æ—Ç—á—ë—Ç—ã –∏ –¥–µ—à–±–æ—Ä–¥—ã —Å –Ω–∏–∑–∫–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
* –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è –≤ real-time –∞–Ω–∞–ª–∏—Ç–∏–∫–µ

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π (RBAC)
* –ò–∑–æ–ª—è—Ü–∏—è materialized view –æ—Ç –∏—Å—Ö–æ–¥–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–≥—Ä–µ–≥–∞—Ç–æ–≤

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –ë–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è materialized views
* v1.1 ‚Äî –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ SQL: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ ROLLUP –∏ CUBE
* v1.2 ‚Äî –í–Ω–µ–¥—Ä–µ–Ω–∏–µ adaptive aggregation
* v1.3 ‚Äî CDC-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–ª—è auto-refresh

## üõë –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

| –ö–æ–¥ / –¢–∏–ø           | –£—Å–ª–æ–≤–∏–µ                           | –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏                       |
| ------------------- | --------------------------------- | ------------------------------------- |
| `E_MV_REFRESH_FAIL` | –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Å—á—ë—Ç–µ              | –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å MV                |
| `W_AGG_INCOMPLETE`  | –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ | –í–æ–∑–º–æ–∂–Ω–æ, –∞–≥—Ä–µ–≥–∞—Ü–∏—è —á–∞—Å—Ç–∏—á–Ω–∞          |
| `E_ROLLUP_SYNTAX`   | –û—à–∏–±–∫–∞ –≤ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–µ CUBE/ROLLUP   | –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ group sets |
