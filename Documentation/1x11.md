# üß± –ë–ª–æ–∫ 1.11 ‚Äî –ö–æ–º–ø–∞–∫—Ç–∞—Ü–∏—è –∏ —Å–∂–∞—Ç–∏–µ –¥–∞–Ω–Ω—ã—Ö

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.11 ‚Äî –ö–æ–º–ø–∞–∫—Ç–∞—Ü–∏—è –∏ —Å–∂–∞—Ç–∏–µ –¥–∞–Ω–Ω—ã—Ö

---

üéØ **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**

–ú–æ–¥—É–ª—å –∫–æ–º–ø–∞–∫—Ç–∞—Ü–∏–∏ –∏ —Å–∂–∞—Ç–∏—è –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–∞–º—è—Ç–∏ –∏ –Ω–∞ NVMe/SSD, —Å–Ω–∏–∂–∞—è –æ–±—ä—ë–º –∑–∞–Ω–∏–º–∞–µ–º–æ–π –ø–∞–º—è—Ç–∏ –∏ –ø–æ–≤—ã—à–∞—è –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫—ç—à–∞ CPU. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –≤ column-store, —Ç–∞–∫ –∏ –≤ WAL –∏ MVCC-—Ü–µ–ø–æ—á–∫–∞—Ö. –ö–ª—é—á–µ–≤–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤—ã—Å–æ–∫–æ–π –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ —Å–∫–æ—Ä–æ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–∞.

---

‚öôÔ∏è **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞               | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                     |
| ------------------------ | ------------------------------------------------------------ |
| –°–ª–æ–≤–∞—Ä–Ω–æ–µ —Å–∂–∞—Ç–∏–µ         | Hash/Trie —Å–ª–æ–≤–∞—Ä–∏, SIMD-—É—Å–∫–æ—Ä–µ–Ω–∏–µ                            |
| Run-Length Encoding      | –î–µ—Ç–µ–∫—Ü–∏—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π, —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ RLE |
| Delta Encoding           | –î–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π (TS)                       |
| Frame-of-Reference       | –£–ø–ª–æ—Ç–Ω–µ–Ω–∏–µ –ø–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ–π –±–∞–∑–µ –∑–Ω–∞—á–µ–Ω–∏–π                    |
| Vectorized decompression | –°—Ç—Ä–æ–≥–æ –ø–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–µ, –≤–µ–∫—Ç–æ—Ä–Ω–æ–µ —á—Ç–µ–Ω–∏–µ                        |
| –ö–æ–º–ø–∞–∫—Ç–∞—Ü–∏—è MVCC         | –°–∂–∞—Ç–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –≤–µ—Ä—Å–∏–π, –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Ü–µ–ø–æ—á–µ–∫                |
| –ö–æ–º–ø–∞–∫—Ç–∞—Ü–∏—è WAL          | –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —à–∞–±–ª–æ–Ω–æ–≤                           |

---

üíæ **–§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö**

```c
// –°–ª–æ–≤–∞—Ä–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞
typedef struct dict_column_t {
    const char **dictionary;
    uint32_t dict_size;
    uint32_t *indexes;
    uint32_t count;
} dict_column_t;

// RLE-–∫–æ–ª–æ–Ω–∫–∞
typedef struct rle_pair_t {
    uint32_t value;
    uint32_t run_length;
} rle_pair_t;
```

---

üîÑ **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏**

```plantuml
[1.11 Data Compaction] --> [1.2 Column Store]
[1.11 Data Compaction] --> [1.8 WAL]
[1.11 Data Compaction] --> [2.3 MVCC Chains]
[1.11 Data Compaction] --> [5.1 BI Aggregates]
```

---

üß† **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**

* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ SIMD-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –¥–ª—è RLE –∏ dictionary
* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –∫–µ—à-–ª–∏–Ω–∏–∏
* NUMA-aware: –ª–æ–∫–∞–ª—å–Ω–æ—Å—Ç—å –ø–∞–º—è—Ç–∏ –ø—Ä–∏ —Å–∂–∞—Ç–∏–µ–º
* –§–æ–Ω–æ–≤–∞—è –∫–æ–º–ø–∞–∫—Ç–∞—Ü–∏—è –≤ idle-–ø–µ—Ä–∏–æ–¥—ã

---

üìÇ **–°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞**

* `src/compression.c`
* `include/compression.h`
* `src/column_store.c`

---

üîß **–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C**

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏            | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                  | –û–ø–∏—Å–∞–Ω–∏–µ                            |
| ---------------------- | ------------------------------------------------------------------------- | ----------------------------------- |
| `compress_dict_column` | `bool compress_dict_column(dict_column_t *col)`                           | –°–∂–∞—Ç–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –º–µ—Ç–æ–¥–æ–º —Å–ª–æ–≤–∞—Ä—è      |
| `compress_rle_column`  | `bool compress_rle_column(uint32_t *input, size_t len, rle_pair_t **out)` | –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ RLE-—Å–∂–∞—Ç–∏—è               |
| `delta_encode_column`  | `bool delta_encode_column(uint64_t *data, size_t len)`                    | Delta-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ                   |
| `frame_encode_column`  | `bool frame_encode_column(int32_t *data, size_t len, int32_t base)`       | –£–ø–ª–æ—Ç–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ frame-of-reference |
| `compact_mvcc_chain`   | `void compact_mvcc_chain(mvcc_entry_t **chain)`                           | –£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –≤–µ—Ä—Å–∏–π          |
| `compact_wal_log`      | `void compact_wal_log(void)`                                              | –û—á–∏—Å—Ç–∫–∞ –∏ —Å–∂–∞—Ç–∏–µ WAL                |

---

üß™ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

* Unit: `tests/test_compression.c`
* Fuzz: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ/–¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
* Soak: –∫–æ–º–ø–∞–∫—Ç–∞—Ü–∏—è –º–∏–ª–ª–∏–æ–Ω–∞ —Å—Ç—Ä–æ–∫ —Å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è–º–∏
* Coverage: 93.8%

---

üìä **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**

* –°–∂–∞—Ç–∏–µ —Å—Ç—Ä–æ–∫: –¥–æ 7.5x (dictionary + RLE)
* –°–∫–æ—Ä–æ—Å—Ç—å —Å–∂–∞—Ç–∏—è: –¥–æ 1.8 –ì–ë/—Å –Ω–∞ –ø–æ—Ç–æ–∫ (SIMD)
* –í—Ä–µ–º—è –∫–æ–º–ø–∞–∫—Ç–∞—Ü–∏–∏ MVCC: \~15 –º–∫—Å/—Ü–µ–ø–æ—á–∫—É

---

‚úÖ **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+**

| –ö—Ä–∏—Ç–µ—Ä–∏–π                   | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                  |
| -------------------------- | ------ | -------------------------------------------- |
| Dictionary compression     | 100    | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ, —Å SIMD                          |
| RLE                        | 100    | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è                               |
| Delta + Frame-of-Reference | 95     | –ù–µ –≤—Å–µ —Ç–∏–ø—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è (—Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ–≤—ã–µ) |
| Vectorized decompression   | 90     | –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ, —Ç—Ä–µ–±—É–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è     |
| Background compaction      | 100    | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è                               |

---

üìé **–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞**

```c
if (!compress_dict_column(col)) {
    log_error("compression", "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∂–∞—Ç—å –∫–æ–ª–æ–Ω–∫—É —Å–ª–æ–≤–∞—Ä—ë–º");
}
```

---

üß© **–ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏**

* –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ SIMD-—è–¥—Ä–æ –¥–ª—è –≤—Å–µ—Ö –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ nested-–¥–µ–∫–æ–¥–µ—Ä–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, RLE –ø–æ–≤–µ—Ä—Ö dictionary)
* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –ª—É—á—à–µ–≥–æ –º–µ—Ç–æ–¥–∞ –ø–æ –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º–µ

---

üìê **UML-–¥–∏–∞–≥—Ä–∞–º–º–∞**

```plantuml
@startuml
class dict_column_t {
  +const char** dictionary
  +uint32_t dict_size
  +uint32_t* indexes
  +uint32_t count
}

class rle_pair_t {
  +uint32_t value
  +uint32_t run_length
}
@enduml
```

---

üßæ **–°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏**

* –°–Ω–∏–∂–µ–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç –Ω–∞ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—É—é –ø–∞–º—è—Ç—å
* –ü–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ BI-–∑–∞–ø—Ä–æ—Å–æ–≤
* –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π –∏ –ª–æ–≥–æ–≤

---

üìú **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π**

* v0.1: —Å–ª–æ–≤–∞—Ä–Ω–æ–µ –∏ RLE-—Å–∂–∞—Ç–∏–µ
* v0.2: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ delta –∏ frame
* v0.3: NUMA-aware, SIMD, background GC

---

üîí **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö**

* –ö–æ–Ω—Ç—Ä–æ–ª—å CRC –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏–µ–π
* –ó–∞—â–∏—Ç–∞ –æ—Ç RLE overflows –∏ corrupted dictionary
* –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–ø—É—Å—Ç–∏–º–æ—Å—Ç–∏ base/frame –ø—Ä–∏ —Å–∂–∞—Ç–∏–∏

---

üìù **–°–æ–æ–±—â–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞**

```text
[INFO] –°–∂–∞—Ç–∏–µ –∫–æ–ª–æ–Ω–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ: –º–µ—Ç–æ–¥=RLE, —Ñ–∞–∫—Ç–æ—Ä=6.2x
[ERROR] compression: —Å–±–æ–π —Å–ª–æ–≤–∞—Ä–Ω–æ–π –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ (dict_size=0)
[DEBUG] –£–¥–∞–ª–µ–Ω–æ 1024 —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö MVCC-–∑–∞–ø–∏—Å–µ–π
```
