# 6.2 ‚Äî –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∏ –∑–∞—â–∏—Ç–∞ –Ω–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–º/–¥–∏—Å–∫–æ–≤–æ–º —É—Ä–æ–≤–Ω–µ (TLS, TDE, Forward Secrecy)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 6 ‚Äî –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
**–ë–ª–æ–∫ 6.2 ‚Äî –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∏ –∑–∞—â–∏—Ç–∞ –Ω–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–º/–¥–∏—Å–∫–æ–≤–æ–º —É—Ä–æ–≤–Ω–µ (TLS, TDE, Forward Secrecy)**

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∑–∞—â–∏—Ç—É –¥–∞–Ω–Ω—ã—Ö –∫–∞–∫ –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ –ø–æ —Å–µ—Ç–∏, —Ç–∞–∫ –∏ –ø—Ä–∏ —Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ –ø–∞–º—è—Ç–∏ –∏ –Ω–∞ NVMe-–¥–∏—Å–∫–∞—Ö. –û–Ω —Ä–µ–∞–ª–∏–∑—É–µ—Ç TLS/mTLS –¥–ª—è —Å–µ—Ç–µ–≤–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞, —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ç—Ä–∞–Ω–∏—Ü (TDE ‚Äî Transparent Data Encryption), –∞ —Ç–∞–∫–∂–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã —Å –ø—Ä—è–º–æ–π —Å–µ–∫—Ä–µ—Ç–Ω–æ—Å—Ç—å—é (Forward Secrecy), —á—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –∑–∞—â–∏—Ç—ã –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –∏ –ø—É–±–ª–∏—á–Ω—ã—Ö —Å—Ä–µ–¥–∞—Ö.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞         | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                     |
| ------------------ | ------------------------------------------------------------ |
| TLS / mTLS         | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ TLS 1.3 —Å mTLS, —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –∏ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã |
| TDE                | –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü WAL –∏ Snapshot —Å –ø–µ—Ä-—Ç–∞–±–ª–∏—á–Ω—ã–º–∏ –∫–ª—é—á–∞–º–∏   |
| Forward Secrecy    | ECDHE + ephemeral session keys                               |
| –ö–ª—é—á–µ–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ | –ó–∞—â–∏—Ç–∞ –∫–ª—é—á–µ–π –≤ –ø–∞–º—è—Ç–∏, KMIP —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å                   |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct encryption_context_t {
  uint8_t master_key[32];
  uint8_t table_key[32];
  uint8_t iv[16];
  cipher_alg_t alg;
} encryption_context_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
Client <--> TLS_Engine
TLS_Engine --> CertificateStore
StorageEngine --> TDE_Encryptor
WALWriter --> TDE_Encryptor
SnapshotManager --> TDE_Encryptor
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è AES-256-GCM / ChaCha20-Poly1305
* –ê–ø–ø–∞—Ä–∞—Ç–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ —á–µ—Ä–µ–∑ AES-NI / AVX2
* –ü–µ—Ä–µ–∑–∞–ø–∏—Å—å –∫–ª—é—á–µ–π –≤ –ø–∞–º—è—Ç–∏ (zero-on-free)
* –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–º–µ–Ω—ã –∫–ª—é—á–µ–π –∏ key rotation

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/security/tls_engine.c`
* `src/security/tde_encryptor.c`
* `src/security/keyvault.c`
* `include/security/encryption_context.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è                | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                      | –û–ø–∏—Å–∞–Ω–∏–µ                            |
| ------------------ | ------------------------------------------------------------- | ----------------------------------- |
| `tls_init_server`  | `int tls_init_server(const char *cert, const char *key)`      | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TLS-—Å–µ—Ä–≤–µ—Ä–∞           |
| `tde_encrypt_page` | `void tde_encrypt_page(page_t *p, encryption_context_t *ctx)` | –®–∏—Ñ—Ä—É–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –∑–∞–ø–∏—Å–∏         |
| `tde_decrypt_page` | `bool tde_decrypt_page(page_t *p, encryption_context_t *ctx)` | –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏     |
| `key_rotate_table` | `int key_rotate_table(const char *table)`                     | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/security/test_tls.c`, `test_tde.c`
* Integration: TLS handshake, WAL encrypted replay
* Soak: –¥–ª–∏—Ç–µ–ª—å–Ω—ã–µ TLS-—Å–µ—Å—Å–∏–∏, –º–∞—Å—Å–æ–≤–∞—è —Å–º–µ–Ω–∞ –∫–ª—é—á–µ–π

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è                | –ú–µ—Ç—Ä–∏–∫–∞         |
| ----------------------- | --------------- |
| TLS Handshake (ECDHE)   | < 5.1 –º—Å        |
| WAL Encryption per page | \~1.8 ¬µs        |
| Decryption throughput   | >1.1 GB/s (AES) |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π        | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                 |
| --------------- | ------ | --------------------------- |
| TLS / mTLS      | 100    | –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è      |
| TDE             | 100    | –ü–æ —Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–º—É —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—é   |
| Forward Secrecy | 100    | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è ECDHE        |
| Key management  | 100    | –ü–µ—Ä–µ–∑–∞–ø–∏—Å—å –∏ —Ä–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–µ–π |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
// –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã WAL
page_t *p = ...;
encryption_context_t ctx = get_encryption_ctx("orders");
tde_encrypt_page(p, &ctx);
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ HSM (Hardware Security Module)
* –ê—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è TDE
* KMIP-–ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö Vault-—Å–∏—Å—Ç–µ–º

## üìä UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
package "6.2 –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ" {
  [Client] <--> [TLS_Engine]
  [TLS_Engine] --> [CertificateStore]
  [StorageEngine] --> [TDE_Encryptor]
  [WALWriter] --> [TDE_Encryptor]
  [SnapshotManager] --> [TDE_Encryptor]
}
@enduml
```

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ó–∞—â–∏—Ç–∞ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
* –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–æ—Ä–º–∞—Ç–∏–≤–∞–º: ISO 27001, GDPR, FIPS-140
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å BI/ETL-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ó–∞—â–∏—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–µ–¥–∞—á–µ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–∏
* –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–ª—é—á–µ–π –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∏—Å—Ç–µ–º—ã
* –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–æ–ø—É—Å–∫–∞ –∫ –∫–ª—é—á–∞–º: RBAC –∏ –∑–æ–Ω—ã –¥–æ–≤–µ—Ä–∏—è

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî TLS 1.2 / 1.3
* v1.1 ‚Äî TDE –¥–ª—è WAL + Snapshots
* v1.2 ‚Äî –≠—Ñ–µ–º–µ—Ä–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –∏ Forward Secrecy
* v1.3 ‚Äî AES-NI —É—Å–∫–æ—Ä–µ–Ω–∏–µ –∏ —Ä–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–µ–π

## üõë –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

| –ö–æ–¥ / –¢–∏–ø          | –£—Å–ª–æ–≤–∏–µ                        | –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏              |
| ------------------ | ------------------------------ | ---------------------------- |
| `E_TLS_HANDSHAKE`  | –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è TLS-—Å–µ—Å—Å–∏–∏ | –ù–µ–≤–µ—Ä–Ω—ã–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏–ª–∏ –∫–ª—é—á |
| `E_TDE_ENCRYPTION` | –û—à–∏–±–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã     | –ü—Ä–æ–±–ª–µ–º–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∏–ª–∏ IV |
| `W_KEY_ROTATION`   | –ò—Å—Ç–µ–∫ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –∫–ª—é—á–∞      | –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–µ–π     |
