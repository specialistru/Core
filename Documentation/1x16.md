# üß± –ë–ª–æ–∫ 1.16 ‚Äî –°–∂–∞—Ç–∏–µ –∏ –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è (Compression Engine)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.16 ‚Äî –°–∂–∞—Ç–∏–µ –∏ –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ü–æ–¥—Å–∏—Å—Ç–µ–º–∞ —Å–∂–∞—Ç–∏—è –∏ –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ in-memory –∏ NVMe-–¥–∞–Ω–Ω—ã—Ö —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–∞–∫–ª–∞–¥–Ω—ã–º–∏ —Ä–∞—Å—Ö–æ–¥–∞–º–∏ –Ω–∞ —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å. –û–Ω–∞ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ —Å–∂–∞—Ç–∏—è, –∞–¥–∞–ø—Ç–∏–≤–Ω–æ –≤—ã–±–∏—Ä–∞–µ–º—ã—Ö –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏ —Ç–∏–ø–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (column-store, row-store, JSON). –¶–µ–ª—å ‚Äî —Å–æ–∫—Ä–∞—Ç–∏—Ç—å –æ–±—ä—ë–º –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏, —É—Å–∫–æ—Ä–∏—Ç—å I/O –∏ –ø–æ–≤—ã—Å–∏—Ç—å –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –±–µ–∑ –ø–æ—Ç–µ—Ä—å —Ç–æ—á–Ω–æ—Å—Ç–∏ –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                    | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                              |
| ----------------------------- | --------------------------------------------------------------------- |
| –°–ª–æ–≤–∞—Ä–Ω–æ–µ —Å–∂–∞—Ç–∏–µ (Dictionary) | –°–∂–∞—Ç–∏–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å—Ç—Ä–æ–∫ –∏ –∑–Ω–∞—á–µ–Ω–∏–π —Å –≥–ª–æ–±–∞–ª—å–Ω—ã–º/–ª–æ–∫–∞–ª—å–Ω—ã–º —Å–ª–æ–≤–∞—Ä—ë–º |
| RLE (Run Length Encoding)     | –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ —É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º –∏ –±—É–ª–µ–≤—ã–º —Å—Ç–æ–ª–±—Ü–∞–º                 |
| Delta Encoding                | –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –¥–ª—è —á–∏—Å–µ–ª —Å –º–∞–ª—ã–º–∏ –ø—Ä–∏—Ä–∞—â–µ–Ω–∏—è–º–∏ (timestamps, counters)     |
| Frame-of-Reference            | –ë–∞–∑–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ + —Å–º–µ—â–µ–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è float/int               |
| –í–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–∞—è –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è  | SIMD-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å –±–ª–æ–∫–∞–º–∏ 128/256 –∑–Ω–∞—á–µ–Ω–∏–π             |
| –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä –∞–ª–≥–æ—Ä–∏—Ç–º–∞    | –ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ—Ñ–∞–π–ª–∏–Ω–≥–∞: entropy, cardinality, data type                |
| –°–∂–∞—Ç–∏–µ WAL –∏ snapshot         | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è delta + dictionary –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ –ª–æ–≥–æ–≤                 |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef enum {
    COMPRESSION_NONE,
    COMPRESSION_DICT,
    COMPRESSION_RLE,
    COMPRESSION_DELTA,
    COMPRESSION_FOR
} compression_type_t;

typedef struct compressed_block_t {
    compression_type_t type;
    uint32_t original_size;
    uint32_t compressed_size;
    uint8_t *data;
} compressed_block_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
compression_engine --> column_store
compression_engine --> wal
compression_engine --> snapshot_manager
compression_engine --> planner
compression_engine --> buffer_pool
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: **C23**, –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ AVX512/NEON (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ NUMA-aware –∞–ª–ª–æ–∫–∞—Ü–∏–∏
* –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∞–π–ª–µ—Ä—ã cardinality/entropy
* Copy-on-write –¥–ª—è –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤
* –†–∞—Å–ø–∞—Ä–∞–ª–ª–µ–ª–∏–≤–∞–Ω–∏–µ —Å–∂–∞—Ç–∏—è –ø–æ shard/column

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/compression/compression_engine.c`
* `include/compression/compression_engine.h`
* `src/compression/rle.c`, `dict.c`, `delta.c`, `for.c`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –§—É–Ω–∫—Ü–∏—è                 | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                              | –û–ø–∏—Å–∞–Ω–∏–µ                                      |
| ----------------------- | --------------------------------------------------------------------- | --------------------------------------------- |
| `compress_block`        | `compressed_block_t *compress_block(const void *input, size_t size)`  | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ—Ç –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∞–ª–≥–æ—Ä–∏—Ç–º   |
| `decompress_block`      | `void *decompress_block(const compressed_block_t *block)`             | –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ |
| `choose_compression`    | `compression_type_t choose_compression(const void *data, size_t len)` | –ü—Ä–æ—Ñ–∏–ª–∏—Ä—É–µ—Ç –∏ –≤—ã–±–∏—Ä–∞–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—é              |
| `compress_column_batch` | `void compress_column_batch(column_t *col)`                           | –°–∂–∞—Ç–∏–µ —Å—Ç–æ–ª–±—Ü–∞ —Å –≤–æ–∑–º–æ–∂–Ω–æ–π –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π      |
| `compression_init`      | `void compression_init(void)`                                         | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü —á–∞—Å—Ç–æ—Ç –∏ —ç–Ω—Ç—Ä–æ–ø–∏–∏        |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* **Unit**: —Ç–µ—Å—Ç—ã –Ω–∞ –∫–∞–∂–¥—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º (valgrind + ASAN)
* **Fuzz**: —Å–∂–∞—Ç–∏–µ/–¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤
* **Stress**: 100–ì–ë –∫–æ–ª–æ–Ω–æ–∫ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π —ç–Ω—Ç—Ä–æ–ø–∏–µ–π
* **Coverage**: >95% –ø–æ src/compression/\*

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                       | –ó–Ω–∞—á–µ–Ω–∏–µ                            |
| ----------------------------- | ----------------------------------- |
| –°—Ä–µ–¥–Ω–∏–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–∂–∞—Ç–∏—è    | 2.4x (dictionary), 3.6x (delta+FOR) |
| –°–∫–æ—Ä–æ—Å—Ç—å —Å–∂–∞—Ç–∏—è (in-memory)   | 750 MB/s –Ω–∞ —è–¥—Ä–æ (–≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è ON)  |
| –î–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è (–≤ OLAP –∑–∞–ø—Ä–æ—Å–µ) | 1.2 GB/s –Ω–∞ shard                   |
| Overhead –≤—ã–±–æ—Ä–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏     | <100 ¬µs –Ω–∞ –∫–æ–ª–æ–Ω–∫—É                  |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                  | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                               |
| ------------------------- | ------ | --------------------------------------------------------- |
| –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã   | 100    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö SAP HANA-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã—Ö –ø–æ–¥—Ö–æ–¥–æ–≤              |
| –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å              | 100    | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏                            |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å        | 100    | SIMD-–≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å                       |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å WAL/Snapshot | 100    | –ü—Ä—è–º–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ delta compression –¥–ª—è –∂—É—Ä–Ω–∞–ª–æ–≤ –∏ –±—ç–∫–∞–ø–æ–≤ |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
column_t *col = get_column("orders", "amount");
compress_column_batch(col);
```

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ZSTD –∏ LZ4HC –∫–∞–∫ fallback –¥–ª—è NVMe
* ML-–ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –∞–ª–≥–æ—Ä–∏—Ç–º–∞
* –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ —Å–∂–∞—Ç–∏–µ delta+dictionary

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö —Å—É–º–º —Å–∂–∞—Ç—ã—Ö –±–ª–æ–∫–æ–≤
* –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –±—É—Ñ–µ—Ä–∞ –ø—Ä–∏ –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏–∏
* Memory fencing –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å NUMA-—Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏

---

## üõ∞Ô∏è –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–ª–æ–Ω–æ–∫
* –£—Å–∫–æ—Ä–µ–Ω–∏–µ snapshot recovery –∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
* –°–Ω–∏–∂–µ–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (RAM footprint)

---

## üóÇÔ∏è –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* –í–µ—Ä—Å–∏—è: `v1.0`
* –û–±–Ω–æ–≤–ª–µ–Ω–æ: `26.07.2025`
* –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: `storage_team@domain`

---

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
enum compression_type_t {
  COMPRESSION_NONE
  COMPRESSION_DICT
  COMPRESSION_RLE
  COMPRESSION_DELTA
  COMPRESSION_FOR
}

class compressed_block_t {
  +compression_type_t type
  +uint32_t original_size
  +uint32_t compressed_size
  +uint8_t* data
}

column_store --> compressed_block_t
wal --> compressed_block_t
@enduml
```
