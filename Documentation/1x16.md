# üß± –ë–ª–æ–∫ 1.16 ‚Äî –°–∂–∞—Ç–∏–µ –∏ –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è (Compression Engine)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.16 ‚Äî –°–∂–∞—Ç–∏–µ –∏ –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ü–æ–¥—Å–∏—Å—Ç–µ–º–∞ —Å–∂–∞—Ç–∏—è –∏ –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ –∏ NVMe-–Ω–æ—Å–∏—Ç–µ–ª—è—Ö. –û–Ω–∞ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∞–¥–∞–ø—Ç–∏–≤–Ω–æ –≤—ã–±–∏—Ä–∞–µ–º—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã —Å–∂–∞—Ç–∏—è, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–¥ —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö (—Å—Ç—Ä–æ–∫–∏, —á–∏—Å–ª–∞, –±—É–ª–µ–≤—ã –∏ –ø—Ä.) –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä –Ω–∞–≥—Ä—É–∑–∫–∏ (OLTP, OLAP, time-series). –û—Å–Ω–æ–≤–Ω—ã–µ —Ü–µ–ª–∏:

* —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –æ–±—ä—ë–º–∞ –∑–∞–Ω–∏–º–∞–µ–º–æ–π –ø–∞–º—è—Ç–∏,
* —É—Å–∫–æ—Ä–µ–Ω–∏–µ —á—Ç–µ–Ω–∏—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è,
* —Å–Ω–∏–∂–µ–Ω–∏–µ I/O-–Ω–∞–≥—Ä—É–∑–∫–∏ –∏ –∑–∞—Ç—Ä–∞—Ç –Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É,
* –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å WAL –∏ snapshot –¥–ª—è –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                    | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                              |
| ----------------------------- | ------------------------------------------------------------------------------------- |
| –°–ª–æ–≤–∞—Ä–Ω–æ–µ —Å–∂–∞—Ç–∏–µ (Dictionary) | –î–ª—è —Å—Ç—Ä–æ–∫ —Å –Ω–∏–∑–∫–æ–π –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é; –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –∏ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Å–ª–æ–≤–∞—Ä–µ–π         |
| RLE (Run Length Encoding)     | –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –¥–ª—è –±—É–ª–µ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –∏ –ø–æ–≤—Ç–æ—Ä–æ–≤ –≤ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–ª–æ–Ω–∫–∞—Ö                 |
| Delta Encoding                | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –º–æ–Ω–æ—Ç–æ–Ω–Ω—ã—Ö —á–∏—Å–ª–æ–≤—ã—Ö –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π (timestamps, counters –∏ –ø—Ä.) |
| Frame-of-Reference            | –•—Ä–∞–Ω–∏—Ç –±–∞–∑–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏ —Å–º–µ—â–µ–Ω–∏—è; –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è float/int                          |
| –í–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–∞—è –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è  | SIMD (AVX2/AVX512/NEON), –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–ª–æ–∫–æ–≤ –ø–æ 128/256 —ç–ª–µ–º–µ–Ω—Ç–æ–≤                        |
| –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä –∞–ª–≥–æ—Ä–∏—Ç–º–∞    | –ü—Ä–æ—Ñ–∞–π–ª–∏–Ω–≥ –ø–æ —ç–Ω—Ç—Ä–æ–ø–∏–∏, –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç–∏, NULL ratio –∏ –¥–ª–∏–Ω–µ –∑–Ω–∞—á–µ–Ω–∏–π                   |
| –°–∂–∞—Ç–∏–µ WAL –∏ snapshot         | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è delta+dictionary –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö –ª–æ–≥–æ–≤ –∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö —Å–Ω–∏–º–∫–æ–≤      |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef enum {
    COMPRESSION_NONE,
    COMPRESSION_DICT,
    COMPRESSION_RLE,
    COMPRESSION_DELTA,
    COMPRESSION_FOR
} compression_type_t;

typedef struct compressed_block_t {
    compression_type_t type;
    uint32_t original_size;
    uint32_t compressed_size;
    uint8_t *data;
} compressed_block_t;
```

–ö–∞–∂–¥—ã–π –±–ª–æ–∫ —Å–æ–¥–µ—Ä–∂–∏—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: —Ç–∏–ø, —Ä–∞–∑–º–µ—Ä—ã, –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É—é —Å—É–º–º—É. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ –≤ RAM, –∏ –≤ snapshot –Ω–∞ NVMe.

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
compression_engine --> column_store
compression_engine --> wal
compression_engine --> snapshot_manager
compression_engine --> planner
compression_engine --> buffer_pool
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: **C23**
* SIMD: AVX2 / AVX512 / NEON, fallback –Ω–∞ scalar
* NUMA-aware –∞–ª–ª–æ–∫–∞—Ü–∏—è
* Copy-on-write –¥–ª—è —Å–∂–∞—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö
* Inline-–ø—Ä–æ—Ñ–∞–π–ª–µ—Ä—ã (entropy, cardinality)
* –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –ø–æ shard/column
* –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: lock-free –æ—á–µ—Ä–µ–¥–∏

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/compression/compression_engine.c`
* `include/compression/compression_engine.h`
* `src/compression/rle.c`, `dict.c`, `delta.c`, `for.c`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏             | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                              | –û–ø–∏—Å–∞–Ω–∏–µ                                            |
| ----------------------- | --------------------------------------------------------------------- | --------------------------------------------------- |
| `compress_block`        | `compressed_block_t *compress_block(const void *input, size_t size)`  | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–∞         |
| `decompress_block`      | `void *decompress_block(const compressed_block_t *block)`             | –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –±–ª–æ–∫–∞ –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ           |
| `choose_compression`    | `compression_type_t choose_compression(const void *data, size_t len)` | –ü—Ä–æ—Ñ–∞–π–ª–∏–Ω–≥ –∏ –≤—ã–±–æ—Ä –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ —Ç–∏–ø–∞                 |
| `compress_column_batch` | `void compress_column_batch(column_t *col)`                           | –°–∂–∞—Ç–∏–µ –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è column-store                     |
| `compression_init`      | `void compression_init(void)`                                         | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Å—Ç–æ—Ç–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü, —Å–ª–æ–≤–∞—Ä–µ–π –∏ —ç–≤—Ä–∏—Å—Ç–∏–∫ |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* **Unit**: –Ω–∞ –∫–∞–∂–¥—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º (ASAN + valgrind)
* **Fuzz**: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–ª—É—á–∞–π–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤
* **Stress**: ‚â•100‚ÄØ–ì–ë —Å–∂–∞—Ç–∏—è/–¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
* **Soak**: –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ WAL + snapshot
* **Coverage**: >95% `src/compression/`

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                     | –ó–Ω–∞—á–µ–Ω–∏–µ                                          |
| --------------------------- | ------------------------------------------------- |
| –°—Ä–µ–¥–Ω–∏–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–∂–∞—Ç–∏—è  | 2.4x (dictionary), 3.6x (delta+FOR), 1.6x (mixed) |
| –°–∫–æ—Ä–æ—Å—Ç—å —Å–∂–∞—Ç–∏—è (in-memory) | 750 MB/s –Ω–∞ —è–¥—Ä–æ (SIMD)                           |
| –°–∫–æ—Ä–æ—Å—Ç—å –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏–∏       | 1.2 GB/s –Ω–∞ shard –≤ OLAP                          |
| Overhead –≤—ã–±–æ—Ä–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏   | <100 –º–∫—Å –Ω–∞ –∫–æ–ª–æ–Ω–∫—É                               |
| –ü–∞–º—è—Ç—å –Ω–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ        | <0.5% –æ—Ç –æ–±—â–µ–≥–æ –æ–±—ä–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö                     |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                  | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                                  |
| ------------------------- | ------ | ------------------------------------------------------------ |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ | 100    | Dict, RLE, delta, FOR, –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è                          |
| Runtime-–¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è      | 100    | SIMD + streaming OLAP —Å–æ–≤–º–µ—Å—Ç–∏–º—ã —Å HANA                      |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å WAL/Snapshot | 100    | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≥–∏–±—Ä–∏–¥–Ω–æ–µ —Å–∂–∞—Ç–∏–µ                                |
| –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å              | 100    | –ê–ª–≥–æ—Ä–∏—Ç–º –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è –¥–∞–Ω–Ω—ã—Ö |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
column_t *col = get_column("orders", "amount");
compress_column_batch(col);
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Å—É–º–º—ã (CRC32/XXH64)
* –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü –±—É—Ñ–µ—Ä–æ–≤ –ø—Ä–∏ –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏–∏
* Memory fencing –¥–ª—è NUMA
* Read-only snapshot mode

---

## üõ∞Ô∏è –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–ª–æ–Ω–æ–∫
* –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Å–±–æ–µ–≤
* –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ RAM/SSD
* –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ —Ä–æ—Å—Ç–∞ –∑–∞—Ç—Ä–∞—Ç

---

## üóÇÔ∏è –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* **–í–µ—Ä—Å–∏—è:** `v1.0.2`
* **–û–±–Ω–æ–≤–ª–µ–Ω–æ:** `26.07.2025`
* **–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:** `storage_team@domain`
* **–ò—Å—Ç–æ—Ä–∏—è:**

  * `v1.0` ‚Äî –Ω–∞—á–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
  * `v1.0.1` ‚Äî NUMA –∏ SIMD fallback
  * `v1.0.2` ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –∏ snapshot-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

---

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
enum compression_type_t {
  COMPRESSION_NONE
  COMPRESSION_DICT
  COMPRESSION_RLE
  COMPRESSION_DELTA
  COMPRESSION_FOR
}

class compressed_block_t {
  +compression_type_t type
  +uint32_t original_size
  +uint32_t compressed_size
  +uint8_t* data
}

column_store --> compressed_block_t
wal --> compressed_block_t
@enduml
```
