# 9.1 ‚Äî –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ (UDF / UDAF)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* –ü–∞–∫–µ—Ç 9 ‚Äî –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å
* –ë–ª–æ–∫ 9.1 ‚Äî –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ (UDF / UDAF)

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π (UDF ‚Äî User-Defined Functions –∏ UDAF ‚Äî User-Defined Aggregates) –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å —è–¥—Ä–∞ –°–£–ë–î –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –ø–æ–¥ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ –¥–æ–º–µ–Ω—ã (ERP, BI, ML, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤) –∏ —Å–æ–∑–¥–∞–Ω–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –≤ —Å—Ç–∏–ª–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                               |
| ------------------------- | ------------------------------------------------------ |
| –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è UDF           | –ß–µ—Ä–µ–∑ SQL: `CREATE FUNCTION` –∏–ª–∏ API                   |
| –Ø–∑—ã–∫–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏          | C/C++, Lua, JS, WebAssembly (WASM), Python             |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ     | Sandbox, timeouts, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –ø–∞–º—è—Ç—å –∏ CPU         |
| –ê–≥—Ä–µ–≥–∞—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (UDAF) | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏, merge, —Ñ–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è |
| –†–∞—Å—à–∏—Ä–µ–Ω–∏—è —á–µ—Ä–µ–∑ –º–æ–¥—É–ª–∏   | Dlopen / LoadLibrary, –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞            |
| –ò–Ω—Ç—Ä–æ—Å–ø–µ–∫—Ü–∏—è –∏ –¥–µ–±–∞–≥      | `SHOW FUNCTIONS`, –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∫–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è              |
| –í–µ—Ä—Å–∏–∏ —Ñ—É–Ω–∫—Ü–∏–π            | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π –∏ rollback           |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

–§—É–Ω–∫—Ü–∏–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö –∫–∞—Ç–∞–ª–æ–≥–∞ (`system.udf_functions`, `system.udaf_functions`) —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–æ–ª—è–º–∏:

```c
typedef struct {
    char name[64];
    char language[16];
    char source_code[2048];
    bool is_aggregate;
    uint64_t version;
    bool is_sandboxed;
} udf_entry_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
package "9. –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å" {
  [9.1 –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏] --> [3.1 SQL –Ø–¥—Ä–æ –∏ –ü–∞—Ä—Å–µ—Ä]
  [9.1 –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏] --> [3.2 SQL-–æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä]
  [9.1 –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏] --> [4.5 –í–Ω–µ—à–Ω–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∏ Webhooks]
  [9.1 –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏] --> [9.3 Sandbox API]
}
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –Ω–∞ C/C++ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –∫–∞–∫ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∏–ª–∏ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é.
* UDF –≤ Lua –∏ JS –∏—Å–ø–æ–ª–Ω—è—é—Ç—Å—è —á–µ—Ä–µ–∑ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä—ã —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º —Å—ç–Ω–¥–±–æ–∫—Å–æ–º.
* WASM-–º–æ–¥—É–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏ –∏–∑–æ–ª–∏—Ä—É–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é wasm runtime (–Ω–∞–ø—Ä–∏–º–µ—Ä, Wasmtime –∏–ª–∏ WAMR).
* –ö–æ–Ω—Ç—Ä–æ–ª—å —Ä–µ—Å—É—Ä—Å–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –≤—Ä–µ–º—è, –ø–∞–º—è—Ç—å –∏ –∏–∑–æ–ª—è—Ü–∏—é —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–µ namespace.

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/udf/udf.c`
* `src/udf/udf_lua.c`
* `src/udf/udf_wasm.c`
* `include/udf.h`
* `include/catalog/udf_catalog.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏         | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                 | –û–ø–∏—Å–∞–Ω–∏–µ                                       |
| ------------------- | ------------------------------------------------------------------------ | ---------------------------------------------- |
| `udf_register`      | `bool udf_register(udf_entry_t *entry);`                                 | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏                      |
| `udf_execute`       | `bool udf_execute(const char *name, db_value_t *args, db_value_t *ret);` | –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ –∏–º–µ–Ω–∏                    |
| `udaf_merge`        | `bool udaf_merge(void *state, db_value_t *value);`                       | –°–ª–∏—è–Ω–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –∞–≥—Ä–µ–≥–∞—Ç–æ–≤                |
| `udf_load_dynamic`  | `bool udf_load_dynamic(const char *path);`                               | –ó–∞–≥—Ä—É–∑–∫–∞ –≤–Ω–µ—à–Ω–µ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏                    |
| `udf_sandbox_check` | `bool udf_sandbox_check(const udf_entry_t *entry);`                      | –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–ª–∏—Ç–∏–∫–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit-—Ç–µ—Å—Ç—ã: `tests/udf/test_udf.c`
* Fuzzing –¥–ª—è Lua/JS –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä–æ–≤
* Stress-—Ç–µ—Å—Ç—ã –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ UDF
* Coverage-–∞–Ω–∞–ª–∏–∑: `make coverage-udf`

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* –ó–∞–¥–µ—Ä–∂–∫–∞ –≤—ã–∑–æ–≤–∞ UDF (C): \~70‚Äì150 –Ω—Å
* –ó–∞–¥–µ—Ä–∂–∫–∞ –≤—ã–∑–æ–≤–∞ UDF (Lua): \~500‚Äì1200 –Ω—Å
* WASM cold start: \~2‚Äì3 –º—Å, –≥–æ—Ä—è—á–µ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ \~500‚Äì700 –Ω—Å
* –ü–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ UDF –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ –¥–æ 2 MB –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                          | –í—ã–ø–æ–ª–Ω–µ–Ω–æ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                      |
| --------------------------------- | --------- | ------------------------------------------------ |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ UDF/UDAF                | ‚úÖ         | –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —è–∑—ã–∫–∏, –≤–∫–ª—é—á–∞—è WASM                |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ             | ‚úÖ         | Sandbox + –∫–æ–Ω—Ç—Ä–æ–ª—å —Ä–µ—Å—É—Ä—Å–æ–≤                      |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π | ‚úÖ         | Dlopen / LoadLibrary + runtime –∑–∞–≥—Ä—É–∑–∫–∞          |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SQL                  | ‚úÖ         | –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ CREATE FUNCTION / DROP FUNCTION |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
udf_entry_t entry = {
  .name = "add_one",
  .language = "C",
  .source_code = "int add_one(int x) { return x + 1; }",
  .is_aggregate = false,
  .version = 1,
  .is_sandboxed = true
};
udf_register(&entry);
```

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏
* –ó–∞–ø—Ä–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤, –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ç–∏, —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ
* –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è, –ª–∏–º–∏—Ç–æ–≤ –∏ –≤–µ—Ä—Å–∏–π

## üîÑ UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
class udf_entry_t {
  +char name[64]
  +char language[16]
  +char source_code[2048]
  +bool is_aggregate
  +uint64_t version
  +bool is_sandboxed
}
```

## üíº –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã –¥–ª—è ERP/BI —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤, –≤–∫–ª—é—á–∞—è —Ä–∞—Å—á—ë—Ç—ã, –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å, –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∞–≥—Ä–µ–≥–∞—Ç—ã, –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É.

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Å–µ–º–∞–Ω—Ç–∏–∫–∞ –≤–µ—Ä—Å–∏–π UDF
* –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∞ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é
* –ê—É–¥–∏—Ç –≤—Å–µ—Ö CREATE / ALTER / DROP FUNCTION

## üì¢ –û—à–∏–±–∫–∏ –∏ —Å–æ–æ–±—â–µ–Ω–∏—è

* `ERR_UDF_NOT_FOUND` ‚Äî –ø–æ–ø—ã—Ç–∫–∞ –≤—ã–∑–æ–≤–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏
* `ERR_UDF_SECURITY` ‚Äî –Ω–∞—Ä—É—à–µ–Ω–∏–µ sandbox-–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
* `ERR_UDF_COMPILE` ‚Äî –æ—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –≤–Ω–µ—à–Ω–µ–π —Ñ—É–Ω–∫—Ü–∏–∏
* `WARN_UDF_DEPRECATED` ‚Äî –≤—ã–∑–æ–≤ —É—Å—Ç–∞—Ä–µ–≤—à–µ–π –≤–µ—Ä—Å–∏–∏ —Ñ—É–Ω–∫—Ü–∏–∏

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Python —á–µ—Ä–µ–∑ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä —Å sandbox
* –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –∫–æ–º–ø–∏–ª—è—Ü–∏—è UDF –≤ LLVM
* –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π
* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ UDF

# 9.2 ‚Äî –í–Ω–µ—à–Ω–∏–µ –º–æ–¥—É–ª–∏ (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞: dlopen / LoadLibrary)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* –ü–∞–∫–µ—Ç 9 ‚Äî –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å
* –ë–ª–æ–∫ 9.2 ‚Äî –í–Ω–µ—à–Ω–∏–µ –º–æ–¥—É–ª–∏ (dlopen / LoadLibrary)

## ‚ú® –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é –∑–∞–≥—Ä—É–∑–∫—É –≤–Ω–µ—à–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ (–Ω–∞–ø—Ä., –º–æ–¥—É–ª–∏ –Ω–∞ C/C++, —Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è) –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –±–µ–∑ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ —è–¥—Ä–∞ –°–£–ë–î.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞            | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                          |
| --------------------- | ------------------------------------------------- |
| dlopen (Linux)        | POSIX API, RTLD\_NOW / RTLD\_LOCAL                |
| LoadLibrary (Windows) | WinAPI –¥–ª—è –¥–∏–Ω–∞–º. –∑–∞–≥—Ä—É–∑–∫–∏ DLL                    |
| –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è API       | –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –æ–±—Ä–∞–∑–µ—Ü –¥–ª—è entry points              |
| –ú–µ—Ö–∞–Ω–∏–∑–º —Å–∞–Ω–¥–±–æ–∫—Å–∞    | –û—Ç–¥–µ–ª—å–Ω—ã–µ PID/–Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ syscalls / —Å–µ–∫—é—Ä–Ω–æ–µ API |

## üìÇ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è

–ú–æ–¥—É–ª–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∫–∞—Ç–∞–ª–æ–≥–µ `/usr/lib/udb/modules` –∏–ª–∏ –ø–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è ELF, PE –∏ Mach-O —Ñ–æ—Ä–º–∞—Ç—ã.

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: C17 / C23
* –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –ø–æ—Ç–æ–∫–æ–≤–∞—è –∏–∑–æ–ª—è—Ü–∏—è, –æ–±–µ—Ä—Ç–∫–∏ API, –≤–∞–ª–∏–¥–∞—Ü–∏—è entry points
* NUMA-aware –∑–∞–≥—Ä—É–∑–∫–∞ –∏ –∫–µ—à-–∞—Ñ—Ñ–∏–Ω–Ω–æ—Å—Ç—å –º–æ–¥—É–ª–µ–π

## üìÅ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/plugins/loader.c`
* `include/plugin_loader.h`
* `src/security/sandbox.c`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –ò–º—è              | –ü—Ä–æ—Ç–æ—Ç–∏–ø                              | –û–ø–∏—Å–∞–Ω–∏–µ                             |
| ---------------- | ------------------------------------- | ------------------------------------ |
| plugin\_load     | `bool plugin_load(const char *path);` | –ó–∞–≥—Ä—É–∑–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏                  |
| plugin\_register | `bool plugin_register(void *handle);` | –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è entry points |
| plugin\_sandbox  | `bool plugin_sandbox(pid_t pid);`     | –ó–∞–ø—É—Å–∫ –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–π —Å—Ä–µ–¥–µ          |
| plugin\_unload   | `bool plugin_unload(void *handle);`   | –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è                    |

## üîÆ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/plugin_loader_test.c`
* Fuzz: AFL++ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–æ–≤ ELF / PE
* Stress: –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ —Ü–∏–∫–ª—ã –∑–∞–≥—Ä—É–∑–∫–∏/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* –ù–µ–≤–æ–∑–º—É—â–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ < 20 –º—Å
* –û—Ç–≤–µ—Ç –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é API < 5 –º—Å

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                 | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                  |
| ------------------------ | ------ | ---------------------------- |
| –î–∏–Ω–∞–º–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏        | 100    | –ë–µ–∑ —Ä–µ—Å—Ç–∞—Ä—Ç–∞ –∏ —Å –æ—Ç–∫–∞—Ç–æ–º API |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —Å–∞–Ω–¥–±–æ–∫—Å—ã | 100    | –°–µ–∫—å—é—Ä–Ω—ã–π PID/—Ç—Ä–∞–ø—ã/—Ñ–æ—Ä–∫     |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ñ–æ—Ä–º–∞—Ç–æ–≤       | 95     | ELF / PE / Mach-O            |

## üìå –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
void *handle = dlopen("/usr/lib/udb/modules/libmy_ext.so", RTLD_NOW);
if (handle) {
   plugin_register(handle);
}
```

## üß∞ –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –º–æ–¥—É–ª–µ–π (–∑–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ HTTP/S)
* –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –ø–æ–¥–ø–∏—Å—å –ø–ª–∞–≥–∏–Ω–æ–≤
* –†–æ–ª–µ–≤–æ–π –¥–æ—Å—Ç—É–ø –∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º –º–æ–¥—É–ª—è–º

## üîç UML-–¥–∏–∞–≥—Ä–∞–º–º–∞ (PlantUML)

```plantuml
@startuml
package "9.2 –í–Ω–µ—à–Ω–∏–µ –º–æ–¥—É–ª–∏" {
  [plugin_loader.c] --> [plugin_register]
  [plugin_register] --> [plugin_sandbox]
  [plugin_sandbox] --> [plugin_unload]
}
@enduml
```

## üìÑ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–ª–∞–≥–∏–Ω–æ–≤ –¥–ª—è ERP/–í

# 9.3 ‚Äî SQL-–ø—Ä–æ—Ç–æ–∫–æ–ª (Binary Protocol, PostgreSQL Wire)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* –ü–∞–∫–µ—Ç 9 ‚Äî –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å
* –ë–ª–æ–∫ 9.3 ‚Äî SQL-–ø—Ä–æ—Ç–æ–∫–æ–ª (Binary Protocol, PostgreSQL Wire)

## ‚ú® –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

SQL-–ø—Ä–æ—Ç–æ–∫–æ–ª –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤–æ–π —Å–µ—Ç–µ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–æ–º –∏ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö. –û–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –±–∏–Ω–∞—Ä–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª, –∞ —Ç–∞–∫–∂–µ PostgreSQL Wire Protocol –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ PostgreSQL.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞               | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                             |
| ------------------------ | ---------------------------------------------------- |
| –ë–∏–Ω–∞—Ä–Ω—ã–π SQL-–ø—Ä–æ—Ç–æ–∫–æ–ª    | –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥ in-memory |
| PostgreSQL Wire Protocol | –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å psql, pgAdmin, JDBC/–¥—Ä.              |
| –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π        | TLS/mTLS/–ø–æ–¥–ø–∏—Å—å JWT                                 |
| –°—Ç—Ä–∏–º–∏–Ω–≥ –æ—Ç–≤–µ—Ç–æ–≤         | –û—Ç–≤–µ—Ç—ã —á–∞—Å—Ç—è–º–∏, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ cursor-based —Å—Ö–µ–º          |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ COPY           | –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –≤–≤–æ–¥/–≤—ã–≤–æ–¥ –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö        |

## üíæ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct sql_packet_t {
    uint8_t type;
    uint32_t length;
    uint8_t *payload;
} sql_packet_t;
```

## üîÆ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[SQL-–ø—Ä–æ—Ç–æ–∫–æ–ª] --> [–û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä SQL]
[SQL-–ø—Ä–æ—Ç–æ–∫–æ–ª] --> [–≠–∫–∑–µ–∫—É—Ç–æ—Ä]
[SQL-–ø—Ä–æ—Ç–æ–∫–æ–ª] --> [–°–µ—Ç–µ–≤–æ–π –¥—Ä–∞–π–≤–µ—Ä]
[SQL-–ø—Ä–æ—Ç–æ–∫–æ–ª] --> [–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: C23
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ zero-copy –±—É—Ñ–µ—Ä–æ–≤ –∏ memory pooling
* –û–±—Ä–∞–±–æ—Ç–∫–∞ in-place –±–µ–∑ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–≤
* –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–±–æ—Ä–∞ –º–µ–∂–¥—É –±–∏–Ω–∞—Ä–Ω—ã–º –∏ —Ç–µ–∫—Å—Ç–æ–≤—ã–º —Ä–µ–∂–∏–º–æ–º

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/net/sql_protocol.c`
* `include/net/sql_protocol.h`
* `src/net/pg_wire.c`
* `include/net/pg_wire.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏          | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                           | –û–ø–∏—Å–∞–Ω–∏–µ                                                |
| -------------------- | ------------------------------------------------------------------ | ------------------------------------------------------- |
| `sql_protocol_init`  | `void sql_protocol_init(void);`                                    | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∏–Ω–∞—Ä–Ω–æ–≥–æ SQL-–ø—Ä–æ—Ç–æ–∫–æ–ª–∞                   |
| `handle_sql_packet`  | `void handle_sql_packet(int fd, const uint8_t *buf, size_t len);`  | –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö SQL-—Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –±–∏–Ω–∞—Ä–Ω–æ–º—É –ø—Ä–æ—Ç–æ–∫–æ–ª—É |
| `pgwire_init`        | `void pgwire_init(void);`                                          | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ PostgreSQL Wire Protocol        |
| `pgwire_process_msg` | `void pgwire_process_msg(int fd, const uint8_t *buf, size_t len);` | –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π PostgreSQL –∫–ª–∏–µ–Ω—Ç–æ–≤                 |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* unit-—Ç–µ—Å—Ç—ã: `tests/net/sql_protocol_test.c`
* fuzzing: AFL++ –Ω–∞ –ø–∞—Ä—Å–∏–Ω–≥ SQL –ø–∞–∫–µ—Ç–æ–≤
* soak-—Ç–µ—Å—Ç—ã: —Å—Ç—Ä–µ—Å—Å –ø–æ–¥ –≤—ã—Å–æ–∫–æ–π QPS-–Ω–∞–≥—Ä—É–∑–∫–æ–π

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* –û–±—Ä–∞–±–æ—Ç–∫–∞ > 100K QPS/—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
* –ó–∞–¥–µ—Ä–∂–∫–∞ < 100 –º–∫—Å
* –£—Ç–∏–ª–∏–∑–∞—Ü–∏—è CPU < 5% –Ω–∞ idle —Å–µ—Å—Å–∏—è—Ö

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                  | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                       |
| ------------------------- | ------ | ------------------------------------------------- |
| –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –∫–ª–∏–µ–Ω—Ç–∞–º–∏ | 100    | PostgreSQL wire protocol –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å        | 100    | –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –±–∏–Ω–∞—Ä–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω       |
| –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å             | 95     | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ COPY –∏ custom extension –≤ roadmap       |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å              | 100    | TLS/mTLS –∏ JWT —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã                        |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
void handle_sql_packet(int fd, const uint8_t *buf, size_t len) {
    if (buf[0] == 'Q') {
        const char *query = (const char *)(buf + 5);
        executor_run_sql(session_from_fd(fd), query);
    }
}
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É PostgreSQL Extended Query Protocol
* –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –±–∏–Ω–∞—Ä–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª –≤–µ—Ä—Å–∏–∏ 2.0 —Å –∫–æ–º–ø—Ä–µ—Å—Å–∏–µ–π
* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ –∏ negotiation

## üß∞ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å BI, SQL-–∫–ª–∏–µ–Ω—Ç–∞–º–∏, ORM
* –†–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∏ –∞—É–¥–∏—Ç —Å–µ—Å—Å–∏–π

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥—è—â–∏—Ö —Ñ—Ä–µ–π–º–æ–≤
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ TLS/mTLS
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ JWT —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø—Ä–∞–≤ –∏ –≤—Ä–µ–º–µ–Ω–∏ –∂–∏–∑–Ω–∏

## üßæ –°–æ–æ–±—â–µ–Ω–∏—è, –æ—à–∏–±–∫–∏, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

* `ERR_INVALID_FRAME_LENGTH` ‚Äî –æ—à–∏–±–∫–∞ –≤ —Ä–∞–∑–º–µ—Ä–µ SQL-–ø–∞–∫–µ—Ç–∞
* `ERR_UNSUPPORTED_PACKET_TYPE` ‚Äî –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø —Ñ—Ä–µ–π–º–∞
* `WARN_DEPRECATED_PG_CMD` ‚Äî —É—Å—Ç–∞—Ä–µ–≤—à–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ PostgreSQL –∫–ª–∏–µ–Ω—Ç–∞

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –ò–∑–Ω–∞—á–∞–ª—å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –±–∏–Ω–∞—Ä–Ω–æ–≥–æ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
* v1.1 ‚Äî –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è PostgreSQL Wire Protocol
* v1.2 ‚Äî –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ COPY, TLS –∏ JWT
* v2.0 (–ø–ª–∞–Ω) ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –±–∏–Ω–∞—Ä–Ω–æ–π –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ –∏ multiplexing

## üìà UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
interface SqlProtocol {
    +init()
    +handle_packet()
}
interface PgWire {
    +init()
    +process_msg()
}
SqlProtocol --> PgWire
SqlProtocol --> Executor
SqlProtocol --> SqlOptimizer
@enduml
```

# 9.5 ‚Äî DSL/UDF –¥–ª—è ERP –∏ ETL-—Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* –ü–∞–∫–µ—Ç 9 ‚Äî –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å
* –ë–ª–æ–∫ 9.5 ‚Äî DSL/UDF –¥–ª—è ERP –∏ ETL-—Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º–æ–≥–æ —è–∑—ã–∫–∞ –¥–æ–º–µ–Ω–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (DSL), –∞ —Ç–∞–∫–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π (UDF/UDAF) –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –≤ —Ä–∞–º–∫–∞—Ö ERP/ETL –ø—Ä–æ—Ü–µ—Å—Å–æ–≤. –û–Ω –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã—Ä–∞–∂–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ –ª–æ–≥–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤–Ω—É—Ç—Ä–∏ –°–£–ë–î –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤–Ω–µ—à–Ω–∏—Ö –¥–≤–∏–∂–∫–æ–≤ –∏–ª–∏ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ –∫–æ–¥–∞, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, —É—Å–ª–æ–≤–∏—è, —Ü–∏–∫–ª—ã –∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö –ø—Ä–æ—Ü–µ–¥—É—Ä.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞     | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                            |
| -------------- | ------------------------------------------------------------------- |
| DSL            | –Ø–∑—ã–∫ –≤ —Å—Ç–∏–ª–µ PL/SQL/ABAP, –ø—Ä–æ—Ü–µ–¥—É—Ä—ã, —É—Å–ª–æ–≤–∏—è, —Ü–∏–∫–ª—ã, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏     |
| UDF/UDAF       | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–∞ C, Lua, JS, WebAssembly, sandbox-–∏–∑–æ–ª—è—Ü–∏—è              |
| ERP-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ | –ú–∞–ø–ø–∏–Ω–≥ –Ω–∞ –±–∏–∑–Ω–µ—Å-—Å—É—â–Ω–æ—Å—Ç–∏, —Ç–∞–±–ª–∏—Ü—ã –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, —Ñ–∏–ª—å—Ç—Ä—ã –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ |
| ETL-–æ–ø–µ—Ä–∞—Ü–∏–∏   | –ü–∞—Ä—Å–∏–Ω–≥, —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è, –≤–∞–ª–∏–¥–∞—Ü–∏—è, –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö                  |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å   | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤, timeouts, scope execution                     |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

UDF/DSL —Å—É—â–Ω–æ—Å—Ç–∏ —Å–µ—Ä–∏–∞–ª–∏–∑—É—é—Ç—Å—è –≤ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ AST (Abstract Syntax Tree):

```c
typedef struct dsl_proc_t {
    char *name;
    dsl_ast_node_t *ast_root;
    dsl_scope_t *scope;
} dsl_proc_t;

typedef struct udf_fn_t {
    char *name;
    udf_lang_t lang;
    void *compiled_fn;
} udf_fn_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[DSL Engine] --> [SQL –Ø–¥—Ä–æ]
[UDF Runtime] --> [–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π]
[ETL –ú–æ–¥—É–ª—å] --> [–•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö]
[DSL Engine] --> [–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞–Ω–∏–π]
[UDF Runtime] --> [–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–∞–º—è—Ç–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* DSL –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä –Ω–∞ C23, –ø–∞—Ä—Å–µ—Ä –ø–æ—Å—Ç—Ä–æ–µ–Ω —á–µ—Ä–µ–∑ recursive descent
* UDF-–ø–µ—Å–æ—á–Ω–∏—Ü—ã: WASM runtime, LuaJIT, JS embedded engine
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ç–∞–±–ª–∏—Ü–∞–º–∏ —Å–∏—Å—Ç–µ–º—ã ERP —á–µ—Ä–µ–∑ –±–∏–∑–Ω–µ—Å-—Å–ª–æ–≤–∞—Ä–∏
* –ö–æ–Ω—Ç—Ä–æ–ª—å CPU, –ø–∞–º—è—Ç–∏, IOPS –Ω–∞ –≤—ã–∑–æ–≤
* –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Ç—Ä–∞–Ω—Å–ª—è—Ç–æ—Ä AST ‚Üí bytecode

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/dsl/dsl_engine.c`
* `include/dsl/dsl_engine.h`
* `src/udf/udf_runtime.c`
* `include/udf/udf_runtime.h`
* `src/etl/etl_ops.c`
* `include/etl/etl_ops.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏     | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                           | –û–ø–∏—Å–∞–Ω–∏–µ                             |
| --------------- | ------------------------------------------------------------------ | ------------------------------------ |
| `dsl_eval`      | `int dsl_eval(const char *script, dsl_context_t *ctx);`            | –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è DSL-–∫–æ–¥–∞               |
| `udf_register`  | `int udf_register(const char *name, udf_lang_t lang, void *code);` | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ |
| `etl_transform` | `int etl_transform(etl_job_t *job);`                               | –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö      |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã: `tests/dsl/dsl_test.c`, `tests/udf/udf_test.c`
* Fuzzing: DSL-–≤—ã—Ä–∞–∂–µ–Ω–∏—è, —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –≤—ã–∑–æ–≤—ã UDF
* Soak: –¥–ª–∏—Ç–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ DSL/ETL-—Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
* –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞: 92% –¥–ª—è —è–¥—Ä–∞ DSL/UDF

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* DSL: –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–æ 50K —Å—Ç—Ä–æ–∫/—Å–µ–∫ –Ω–∞ —è–¥—Ä–æ
* UDF (Lua): latency < 20–º–∫—Å, WASM latency \~30–º–∫—Å
* ETL throughput: \~500K —Å—Ç—Ä–æ–∫/—Å–µ–∫ —Å –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π           | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                                   |
| ------------------ | ------ | ------------------------------------------------------------- |
| DSL/–ø—Ä–æ—Ü–µ–¥—É—Ä—ã      | 95     | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —É—Å–ª–æ–≤–∏–π, —Ü–∏–∫–ª–æ–≤, –∫–æ–º–ø–∏–ª—è—Ü–∏—è AST                     |
| UDF/UDAF           | 100    | Sandbox, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω—ã—Ö —è–∑—ã–∫–æ–≤, C/Lua/WASM/JS         |
| ERP/ETL –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ | 90     | –ë–∞–∑–æ–≤—ã–µ —à–∞–±–ª–æ–Ω—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã, —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
const char *dsl_script = "BEGIN IF total > 100 THEN INSERT INTO audit_log VALUES (...); END;";
dsl_eval(dsl_script, session_context);
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* DSL ‚Üí LLVM JIT –∫–æ–º–ø–∏–ª—è—Ü–∏—è –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ DataFrames –∫–∞–∫ –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∞—Å—Å–∞ –≤ DSL
* –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ ETL DSL —à–∞–±–ª–æ–Ω–∞–º–∏ –∏ –≥—Ä–∞—Ñ–æ–≤–æ–π –º–æ–¥–µ–ª—å—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

## üß∞ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–∫–∞–∑–æ–≤, —Ä–∞—Å—á—ë—Ç–æ–≤, –∞—É–¥–∏—Ç–∞
* ERP-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–∞—Å—á—ë—Ç–æ–≤ –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π
* –†–∞—Å—à–∏—Ä—è–µ–º—ã–µ ETL —Ü–µ–ø–æ—á–∫–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* Sandbox per —Ñ—É–Ω–∫—Ü–∏—è (memory limits, CPU ticks, —Ç–∞–π–º–µ—Ä—ã)
* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º –ø–æ —Ä–æ–ª—è–º –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
* –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –æ—Ç–∫–∞–∑–∞ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞—Ä—É—à–µ–Ω–∏–π

## üßæ –°–æ–æ–±—â–µ–Ω–∏—è, –æ—à–∏–±–∫–∏, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

* `ERR_DSL_PARSE_FAILED`
* `ERR_UDF_TIMEOUT`
* `WARN_ETL_ROW_SKIPPED`

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî DSL/IF/LOOP, Lua UDF, –±–∞–∑–æ–≤—ã–µ ETL transform
* v1.1 ‚Äî WASM –ø–æ–¥–¥–µ—Ä–∂–∫–∞, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
* v1.2 ‚Äî DSL-to-Bytecode, UDF lifecycle callbacks

## üìà UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
package "DSL/UDF Engine" {
  interface DSLInterpreter {
    +eval(script)
  }
  interface UDFManager {
    +register()
    +invoke()
  }
  class ETLOps {
    +transform()
  }
  DSLInterpreter --> SQLCore
  UDFManager --> MemoryManager
  ETLOps --> Storage
}
@enduml
```

–ü—Ä–∏–Ω—è—Ç–æ. –°–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫:

---

# 9.6 ‚Äî –†–∞—Å—à–∏—Ä–µ–Ω–∏—è —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–∏–µ –º–æ–¥—É–ª–∏ (dlopen / LoadLibrary)

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* –ü–∞–∫–µ—Ç 9 ‚Äî –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å
* –ë–ª–æ–∫ 9.6 ‚Äî –†–∞—Å—à–∏—Ä–µ–Ω–∏—è —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–∏–µ –º–æ–¥—É–ª–∏ (dlopen / LoadLibrary)

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –±–ª–æ–∫ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –≤–Ω–µ—à–Ω–∏—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π (shared libraries), –ø–æ–∑–≤–æ–ª—è—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø–æ–¥–∫–ª—é—á–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –Ω–∞ —ç—Ç–∞–ø–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ —è–¥—Ä–∞ –°–£–ë–î. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤—ã—Å–æ–∫—É—é –≥–∏–±–∫–æ—Å—Ç—å –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –≤–Ω–µ—à–Ω–∏–º–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –º–∞—Å—à—Ç–∞–±–Ω–æ–≥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏, –≤–∫–ª—é—á–∞—è –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                  | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                |
| --------------------------- | ------------------------------------------------------- |
| –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª–µ–π            | `dlopen` (Unix) / `LoadLibrary` (Windows), lazy binding |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —è–¥—Ä–æ–º          | –ö–æ–Ω—Ç—Ä–∞–∫—Ç API —Å —è–¥—Ä–æ–º (init, register, shutdown)         |
| –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ UDF/UDAF         | –í–Ω–µ—à–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –º–æ–≥—É—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–∏ —Ñ—É–Ω–∫—Ü–∏–∏    |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏       | –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–∏–≥–Ω–∞—Ç—É—Ä, –∫–æ–Ω—Ç—Ä–æ–ª—å –ø—É—Ç–µ–π, sandboxing        |
| –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º | –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è, –≤—ã–≥—Ä—É–∑–∫–∞                    |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct db_extension_t {
    char *name;
    void *handle;
    int (*init_fn)(void);
    int (*register_fn)(void);
    int (*shutdown_fn)(void);
} db_extension_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[Extension Loader] --> [UDF Runtime]
[Extension Loader] --> [–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–∞–º—è—Ç–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏]
[Extension Loader] --> [–†–µ–µ—Å—Ç—Ä —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –Ω–∞ C23 —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º POSIX API (`dlopen`, `dlsym`) –∏ Windows API (`LoadLibrary`)
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≥–æ—Ä—è—á–µ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –≤—ã–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª–µ–π –±–µ–∑ —Ä–µ—Å—Ç–∞—Ä—Ç–∞
* –ö–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Ä—Å–∏–π —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ ABI
* –ò–∑–æ–ª—è—Ü–∏—è –≤ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–º namespace (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è, scope)

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/udf/ext_loader.c`
* `include/udf/ext_loader.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏          | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                     | –û–ø–∏—Å–∞–Ω–∏–µ                                 |
| -------------------- | ------------------------------------------------------------ | ---------------------------------------- |
| `extension_load`     | `int extension_load(const char *path, db_extension_t *ext);` | –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ –º–æ–¥—É–ª—è |
| `extension_unload`   | `int extension_unload(db_extension_t *ext);`                 | –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –≤—ã–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª—è  |
| `extension_register` | `int extension_register(db_extension_t *ext);`               | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π       |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã: `tests/ext/ext_loader_test.c`
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ: –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö UDF –∏–∑ `.so`/`.dll`
* Negative testing: –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏, –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ ABI
* –ü–æ–∫—Ä—ã—Ç–∏–µ: 89%

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏: \~5‚Äì10 –º—Å –Ω–∞ –º–æ–¥—É–ª—å
* –í–ª–∏—è–Ω–∏–µ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ UDF: < 0.5%
* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π: 1024+

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                      | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                      |
| ----------------------------- | ------ | ------------------------------------------------ |
| –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª–µ–π | 100    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–∞ –≤—Å–µ—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö                     |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å                  | 95     | –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Ç–µ–π –∏ —Å–∏–≥–Ω–∞—Ç—É—Ä —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞            |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —è–¥—Ä–æ–º            | 100    | –ß—ë—Ç–∫–∏–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç API —Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π –∏ –≤—ã–≥—Ä—É–∑–∫–æ–π |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
db_extension_t mod;
extension_load("libanalytics_ext.so", &mod);
extension_register(&mod);
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ABI-–º–∞—Ä—à–∞–ª–∏–Ω–≥–∞ —á–µ—Ä–µ–∑ FlatBuffers
* –°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ manifest-—Ñ–∞–π–ª—ã
* –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏: eBPF, TPM, —Ü–∏—Ñ—Ä–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å–∏

## üß∞ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –º–æ–¥—É–ª–µ–π —Ä–∞—Å—á—ë—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏, –ª–æ–≥–∏—Å—Ç–∏–∫–∏, –∞—É–¥–∏—Ç–∞
* –í–Ω–µ–¥—Ä–µ–Ω–∏–µ –¥–æ–º–µ–Ω–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ –±–µ–∑ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –°–£–ë–î

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ò–∑–æ–ª—è—Ü–∏—è —á–µ—Ä–µ–∑ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π scope
* –ü—Ä–æ–≤–µ—Ä–∫–∞ API-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –¥–æ—Å—Ç—É–ø –∫ —Å–∏—Å—Ç–µ–º–Ω—ã–º –≤—ã–∑–æ–≤–∞–º (–≤ –±—É–¥—É—â–µ–º —á–µ—Ä–µ–∑ seccomp/eBPF)

## üßæ –°–æ–æ–±—â–µ–Ω–∏—è, –æ—à–∏–±–∫–∏, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

* `ERR_EXT_NOT_FOUND`
* `ERR_EXT_INIT_FAIL`
* `WARN_EXT_UNSAFE_CALL`

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –ó–∞–≥—Ä—É–∑–∫–∞, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –≤—ã–≥—Ä—É–∑–∫–∞
* v1.1 ‚Äî –ö–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Ä—Å–∏–π, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ ABI
* v1.2 ‚Äî –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–µ—Å–æ—á–Ω–∏—Ü–µ–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é

## üìà UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
package "Extension Loader" {
  class ExtensionManager {
    +load(path)
    +register()
    +unload()
  }
  ExtensionManager --> UDFEngine
  ExtensionManager --> MemoryManager
}
@enduml
```

---


–ì–æ—Ç–æ–≤–æ. –ù–∏–∂–µ —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫:

---

# 9.7 ‚Äî SQL-–ø—Ä–æ—Ç–æ–∫–æ–ª –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å PostgreSQL wire protocol

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* –ü–∞–∫–µ—Ç 9 ‚Äî –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å
* –ë–ª–æ–∫ 9.7 ‚Äî SQL-–ø—Ä–æ—Ç–æ–∫–æ–ª –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å PostgreSQL wire protocol

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –±–∏–Ω–∞—Ä–Ω–æ–≥–æ SQL-–ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å PostgreSQL wire protocol –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —à–∏—Ä–æ–∫–æ–≥–æ —Å–ø–µ–∫—Ç—Ä–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, –≤–∫–ª—é—á–∞—è `psql`, `pgAdmin`, `DBeaver`, –∞ —Ç–∞–∫–∂–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –¥—Ä–∞–π–≤–µ—Ä—ã `JDBC` –∏ `ODBC`. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –∏ –±—ã—Å—Ç—Ä–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É—é—â–∏—Ö PostgreSQL –≤ –∫–∞—á–µ—Å—Ç–≤–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞           | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                         |
| -------------------- | ---------------------------------------------------------------- |
| –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª | –ë–∏–Ω–∞—Ä–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª —Å length-prefixed —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏, handshake, auth |
| PostgreSQL —Å–æ–≤–º–µ—Å—Ç–∏–º | –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è startup/auth/query/describe/parse/bind/execute |
| –†–∞—Å—à–∏—Ä–µ–Ω–∏—è           | –†–∞—Å—à–∏—Ä–µ–Ω–∏—è PostgreSQL wire –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `COPY`, `BULK`)  |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤   | –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å PostgreSQL 13‚Äì15 –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –∏ –¥—Ä–∞–π–≤–µ—Ä–∞–º–∏          |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å         | TLS, user/password auth, SCRAM-SHA-256, client certificate       |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

–û–±—Ä–∞–±–æ—Ç–∫–∞ PostgreSQL wire protocol —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –≤–∏–¥–µ state machine –Ω–∞ C —Å —á—ë—Ç–∫–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ–º –∫–∞–∂–¥–æ–º—É —Ç–∏–ø—É —Å–æ–æ–±—â–µ–Ω–∏—è:

```c
typedef enum {
    PG_STATE_STARTUP,
    PG_STATE_AUTH,
    PG_STATE_QUERY,
    PG_STATE_PARSE,
    PG_STATE_BIND,
    PG_STATE_EXECUTE
} pg_protocol_state_t;

typedef struct {
    pg_protocol_state_t state;
    int sock_fd;
    char *username;
    char *database;
} pg_session_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[SQL Protocol Engine] --> [SQL Parser]
[SQL Protocol Engine] --> [Auth Engine]
[SQL Protocol Engine] --> [Executor]
[SQL Protocol Engine] --> [TLS Layer]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ C23 —Å zero-copy read/write –±—É—Ñ–µ—Ä–∞–º–∏
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ multiplexed —Å–µ—Å—Å–∏–π (–æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ SQL-–∑–∞–ø—Ä–æ—Å—ã)
* –†–µ–∂–∏–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –≤–∫–ª—é—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ startup message
* –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ –ø–ª–∞–≥–∏–Ω-–ø—Ä–æ—Ç–æ–∫–æ–ª—ã (REST/GraphQL/gRPC)

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/net/pg_protocol.c`
* `include/net/pg_protocol.h`
* `src/net/sql_server.c`
* `src/auth/auth_engine.c`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏                | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                             | –û–ø–∏—Å–∞–Ω–∏–µ                     |
| -------------------------- | -------------------------------------------------------------------- | ---------------------------- |
| `pg_protocol_init`         | `int pg_protocol_init(pg_session_t *sess, int sock_fd);`             | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–∏         |
| `pg_protocol_handle_input` | `int pg_protocol_handle_input(pg_session_t *sess);`                  | –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π |
| `pg_protocol_send_message` | `int pg_protocol_send_message(pg_session_t *sess, const void *buf);` | –û—Ç–ø—Ä–∞–≤–∫–∞ –±–∏–Ω–∞—Ä–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π  |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ: `psql`, `pgAdmin`, `DBeaver`, `JDBC` –∞–≤—Ç–æ—Ç–µ—Å—Ç—ã
* Fuzzing: –ø–æ–±–∏—Ç–æ–≤—ã–µ –º—É—Ç–∞—Ü–∏–∏ wire-–ø–∞–∫–µ—Ç–æ–≤, state machine coverage
* Soak: –º–Ω–æ–≥–æ—Å–µ—Å—Å–∏–æ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Å TLS –∏ SCRAM –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
* –ü–æ–∫—Ä—ã—Ç–∏–µ: 95% –ø–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–º –ø—É—Ç—è–º

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* Startup latency: \~1.5 –º—Å (–±–µ–∑ TLS), \~3.2 –º—Å (—Å TLS –∏ SCRAM)
* Query throughput (1 —è–¥—Ä–æ): \~12K QPS `SELECT 1`
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ 500+ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ (1 –∏–Ω—Å—Ç–∞–Ω—Å)

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                 | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                            |
| ------------------------ | ------ | -------------------------------------- |
| –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å PostgreSQL | 100    | –ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª startup/bind/execute   |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å       | 95     | –í–æ–∑–º–æ–∂–Ω—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –±—É—Ñ–µ—Ä–æ–≤ |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å             | 100    | SCRAM, TLS, client certs —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã   |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
pg_session_t sess;
pg_protocol_init(&sess, sock_fd);
while (running) {
    pg_protocol_handle_input(&sess);
}
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ PostgreSQL Logical Replication –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å query trace/diagnostic tools
* –†–∞—Å—à–∏—Ä–µ–Ω–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ wire protocol (streamed query, hints)

## üß∞ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å BI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ –∏ middleware
* –ú–∏–≥—Ä–∞—Ü–∏—è —Å PostgreSQL –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –∫–æ–¥–∞
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ enterprise-—Å—Ç–µ–∫ —á–µ—Ä–µ–∑ JDBC/ODBC/SQL clients

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ TLS 1.3, –ø—Ä–æ–≤–µ—Ä–∫–∞ fingerprint, PIN-–∫–æ–¥–æ–≤
* SCRAM-SHA-256 —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç replay-–∞—Ç–∞–∫
* Rate-limiting –∏ ban –ø–æ IP –Ω–∞ —É—Ä–æ–≤–Ω–µ handshake

## üßæ –°–æ–æ–±—â–µ–Ω–∏—è, –æ—à–∏–±–∫–∏, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

* `ERR_PG_BAD_AUTH`
* `ERR_PG_PARSE`
* `WARN_PG_UNSUPPORTED_MESSAGE`

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî startup/auth/query
* v1.1 ‚Äî bind/parse/describe/execute
* v1.2 ‚Äî SCRAM/TLS, multiplexing

## üìà UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
package "SQL Protocol Engine" {
  class PgProtocol {
    +init(fd)
    +handle_input()
    +send_message()
  }
  PgProtocol --> AuthEngine
  PgProtocol --> SQLParser
  PgProtocol --> Executor
}
@enduml
```

---

–°–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫:

---

# 9.6 ‚Äî –í–Ω–µ—à–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã: REST, gRPC –∏ JSON\:API

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* –ü–∞–∫–µ—Ç 9 ‚Äî –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å
* –ë–ª–æ–∫ 9.6 ‚Äî –í–Ω–µ—à–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã: REST, gRPC –∏ JSON\:API

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –±–ª–æ–∫ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏, –≤–∫–ª—é—á–∞—è RESTful API, –¥–≤–æ–∏—á–Ω—ã–π –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª gRPC –∏ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—é JSON\:API. –û–Ω –∏–≥—Ä–∞–µ—Ç –∫–ª—é—á–µ–≤—É—é —Ä–æ–ª—å –≤ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –°–£–ë–î –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã, –æ–±–ª–∞—á–Ω—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –∏ –≤–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã, –ø–æ–∑–≤–æ–ª—è—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∞–∑—É –∫–∞–∫ —á–∞—Å—Ç—å API-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞     | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                  |
| -------------- | ------------------------------------------------------------------------- |
| REST API       | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ OpenAPI 3.0, –∞–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ö–µ–º, JSON/HTTP                     |
| gRPC           | –ü—Ä–æ—Ç–æ–∫–æ–ª IDL + ProtoBuf, –¥–≤–æ–∏—á–Ω–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è, TLS, bidirectional stream |
| JSON\:API      | –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ JSON\:API v1.1, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ sparse fieldsets      |
| Routing Engine | –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ –º–µ—Ç–æ–¥–∞–º, –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º, —Å—Ö–µ–º–∞–º                              |
| AuthN/AuthZ    | JWT, OAuth2 scopes, IP-based access, TLS client certs                     |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é —Å—Ç—Ä—É–∫—Ç—É—Ä SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–∞—Ö JSON –∏–ª–∏ ProtoBuf. REST –∏ JSON\:API –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–±—ä–µ–∫—Ç–Ω—É—é –º–æ–¥–µ–ª—å:

```c
typedef struct {
    char *endpoint;
    http_method_t method;
    json_object_t *payload;
} rest_request_t;

typedef struct {
    char *proto_service;
    char *method;
    grpc_message_t *message;
} grpc_call_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[REST Engine] --> [SQL Executor]
[gRPC Engine] --> [SQL Executor]
[Auth Manager] --> [REST Engine]
[Auth Manager] --> [gRPC Engine]
[REST Engine] --> [Schema Registry]
[gRPC Engine] --> [Security Module]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ libmicrohttpd –¥–ª—è REST –∏ gRPC C-core runtime
* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è OpenAPI/Swagger —Å—Ö–µ–º
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ HTTP/2 –¥–ª—è gRPC —Å multiplexed streams
* Bidirectional streaming –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ gRPC
* –°–∂–∞—Ç–∏–µ JSON-–æ—Ç–≤–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ Gzip/Deflate –ø–æ Accept-Encoding

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/net/rest_api.c`
* `src/net/grpc_server.c`
* `include/net/rest_api.h`
* `include/net/grpc_api.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏         | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                        | –û–ø–∏—Å–∞–Ω–∏–µ                                         |
| ------------------- | --------------------------------------------------------------- | ------------------------------------------------ |
| `rest_dispatch`     | `int rest_dispatch(rest_request_t *req, rest_response_t *res);` | –û–±—Ä–∞–±–æ—Ç–∫–∞ REST-–∑–∞–ø—Ä–æ—Å–∞                           |
| `grpc_handle_call`  | `int grpc_handle_call(grpc_call_t *call);`                      | –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–∑–æ–≤–∞ gRPC                            |
| `jsonapi_transform` | `int jsonapi_transform(json_t *input, sql_query_t *query);`     | –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ JSON\:API-–∑–∞–ø—Ä–æ—Å–∞ –≤ SQL-–≤—ã—Ä–∞–∂–µ–Ω–∏–µ |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* REST/Swagger —Ç–µ—Å—Ç—ã —á–µ—Ä–µ–∑ Postman, cURL, Autotests
* gRPC: integration tests —á–µ—Ä–µ–∑ `grpc_cli`, proto-—Ñ–∞–π–ª—ã
* –ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ: wrk2 (REST), ghz (gRPC) —Å TLS –∏ streaming
* –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞: >90% –ø–æ API-—Å–ª–æ—é

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* REST latency (avg): 3‚Äì5 –º—Å
* gRPC latency (avg): 1.2 –º—Å
* Throughput (REST): 12K RPS
* Throughput (gRPC): 30K RPS

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π      | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                      |
| ------------- | ------ | ------------------------------------------------ |
| REST/HTTP API | 100    | –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ OpenAPI, –∞–≤—Ç–æ-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è, JWT |
| gRPC          | 100    | –î–≤—É–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫, TLS, protobuf, streaming  |
| JSON\:API     | 90     | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è, –Ω–æ –±–µ–∑ bulk insert     |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
rest_request_t req = { .endpoint="/query", .method=POST, .payload=json_payload };
rest_dispatch(&req, &response);
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ GraphQL –≤ –≤–∏–¥–µ –Ω–∞–¥—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–¥ SQL Executor
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ WebSockets –¥–ª—è push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
* REST-—Å–æ–±—ã—Ç–∏—è CDC —á–µ—Ä–µ–∑ SSE (Server-Sent Events)

## üß∞ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ REST/gRPC –∫–∞–∫ API-—à–ª—é–∑–∞ –¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö ERP —Å–∏—Å—Ç–µ–º
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –æ–±–ª–∞—á–Ω—ã–º–∏ ETL/BI —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ —á–µ—Ä–µ–∑ HTTP/gRPC
* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ö–µ–º–∞–º–∏ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö UI

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* TLS 1.3, HTTPS-only —Ä–µ–∂–∏–º, —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞
* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ IP, –≤—Ä–µ–º–µ–Ω–∏, —Ä–∞–∑–º–µ—Ä—É —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
* JWT-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Å –ø–æ–¥–ø–∏—Å—å—é, expiration, scopes

## üßæ –°–æ–æ–±—â–µ–Ω–∏—è, –æ—à–∏–±–∫–∏, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

* `ERR_HTTP_400_BAD_REQUEST`
* `ERR_GRPC_CALL_FAILED`
* `WARN_JSONAPI_DEPRECATED_FIELD`

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî REST GET/POST, gRPC –±–∞–∑–æ–≤—ã–µ –≤—ã–∑–æ–≤—ã
* v1.1 ‚Äî TLS, JWT, OpenAPI –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–π swagger.json
* v1.2 ‚Äî JSON\:API, streaming RPC, gzip support

## üìà UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
package "External API Interfaces" {
  class RESTEngine {
    +dispatch()
  }
  class gRPCEngine {
    +handle_call()
  }
  class JSONAPIAdapter {
    +transform()
  }

  RESTEngine --> SQLExecutor
  gRPCEngine --> SQLExecutor
  JSONAPIAdapter --> SQLParser
  RESTEngine --> AuthManager
  gRPCEngine --> AuthManager
}
@enduml
```

–í–æ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π Markdown-–¥–æ–∫—É–º–µ–Ω—Ç –±–ª–æ–∫–∞ 9.4 –≤ —Ä–∞–º–∫–∞—Ö –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:

---

# 9.4 ‚Äî REST, gRPC –∏ JSON\:API

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* –ü–∞–∫–µ—Ç: 9 ‚Äî –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å
* –ë–ª–æ–∫: 9.4 ‚Äî REST, gRPC –∏ JSON\:API

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ 9.4 —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∫–ª—é—á–µ–≤—ã–µ –≤–Ω–µ—à–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è In-Memory –†–°–£–ë–î —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏, –≤–∫–ª—é—á–∞—è RESTful API, gRPC –∏ JSON\:API. –≠—Ç–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å ERP-—Å–∏—Å—Ç–µ–º–∞–º–∏, –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π, —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥-—Ä–µ—à–µ–Ω–∏—è–º–∏ –∏ –≤–Ω–µ—à–Ω–∏–º–∏ BI/ETL-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏. –ë–ª–æ–∫ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–æ–≤–∞–Ω–Ω—ã–π, –±–µ–∑–æ–ø–∞—Å–Ω—ã–π, —Ä–∞—Å—à–∏—Ä—è–µ–º—ã–π –∏ –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º –∏ —É–ø—Ä–∞–≤–ª—è—é—â–∏–º –æ–ø–µ—Ä–∞—Ü–∏—è–º –≤ –±–∞–∑–µ.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞         | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                      |
| ------------------ | ----------------------------------------------------------------------------- |
| REST API           | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ OpenAPI 3.0/Swagger, –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è, HTTP 1.1/2, JSON-–æ—Ç–≤–µ—Ç—ã         |
| gRPC               | ProtoBuf, full-duplex streaming, multiplexing, TLS 1.3, schema-first API      |
| JSON\:API          | –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ JSON\:API v1.1, sparse fieldsets, sorting, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è, –ø–∞–≥–∏–Ω–∞—Ü–∏—è |
| Auth & Access Ctrl | JWT, OAuth2 scopes, IP whitelisting, TLS client certs                         |
| Load Limiting      | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ IP, rate limiting, request body size                           |
| Content Encoding   | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ gzip/deflate –≤ –æ—Ç–≤–µ—Ç–∞—Ö REST                                         |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct rest_request_t {
  char *path;
  http_method_t method;
  char *query_string;
  json_object_t *body;
} rest_request_t;

typedef struct grpc_call_t {
  char *service;
  char *method;
  grpc_message_t *payload;
  grpc_stream_flags_t flags;
} grpc_call_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[REST Engine] --> [SQL Executor]
[gRPC Engine] --> [SQL Executor]
[REST Engine] --> [Auth Module]
[gRPC Engine] --> [Security Subsystem]
[JSONAPI Layer] --> [SQL Parser]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ C23 —Å libmicrohttpd (REST) –∏ C-core gRPC (native C ABI)
* –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ HTTP/2: multiplexed, pipelined, prioritized streams
* ProtoBuf ‚Üí SQL AST mapping —á–µ—Ä–µ–∑ SQL intermediate layer
* Swagger/OpenAPI autogen –∏–∑ SQL-–º–æ–¥–µ–ª–µ–π –∏ introspection
* TLS 1.3 + client cert pinning, mTLS handshake, ALPN negotiation

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/net/rest_api.c`
* `src/net/grpc_server.c`
* `src/net/jsonapi_adapter.c`
* `include/net/rest_api.h`
* `include/net/grpc_api.h`
* `include/net/jsonapi.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏         | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                     | –û–ø–∏—Å–∞–Ω–∏–µ                                    |
| ------------------- | ---------------------------------------------------------------------------- | ------------------------------------------- |
| `rest_dispatch`     | `int rest_dispatch(rest_request_t *req, rest_response_t *res);`              | –û—Å–Ω–æ–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ REST Layer             |
| `grpc_handle_call`  | `int grpc_handle_call(grpc_call_t *call);`                                   | –û–±—Ä–∞–±–æ—Ç–∫–∞ ProtoBuf-–∑–∞–ø—Ä–æ—Å–∞ –∏ –º–∞–ø–ø–∏–Ω–≥ –Ω–∞ SQL |
| `jsonapi_transform` | `int jsonapi_transform(json_t *in, jsonapi_meta_t *meta, sql_query_t *out);` | –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ JSON\:API –≤ SQL AST          |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* REST: Postman-—Å–∫—Ä–∏–ø—Ç—ã, –∞–≤—Ç–æ—Ç–µ—Å—Ç—ã —á–µ—Ä–µ–∑ cURL, Swagger Validator
* gRPC: `grpc_cli`, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Streaming / TLS / Error Paths
* JSON\:API: –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤, —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏, sparse/paginate
* Fuzzing: URI/path traversal, malformed headers, body injection
* –ü–æ–∫—Ä—ã—Ç–∏–µ: 93% REST, 88% gRPC, 92% JSON\:API

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞            | REST             | gRPC                     |
| ------------------ | ---------------- | ------------------------ |
| –°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞   | \~4.8 –º—Å         | \~1.4 –º—Å                 |
| –ü–∏–∫–æ–≤–∞—è –ø—Ä–æ–ø—É—Å–∫–Ω–∞—è | \~10K RPS (JSON) | \~28K RPS                |
| Streaming latency  | ‚Äî                | \~0.9 –º—Å (bidirectional) |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π           | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                    |
| ------------------ | ------ | ---------------------------------------------- |
| REST API           | 100    | Swagger/OpenAPI 3.0, compress, scopes, audit   |
| gRPC               | 100    | Streaming, TLS, multiplexing, binary perf      |
| JSON\:API          | 90     | –û—Ç–ª–∏—á–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ, –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç bulk-insert |
| Auth, mTLS, scopes | 100    | mTLS, IP ACL, JWT scopes, expiration           |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
rest_request_t req = {
  .path = "/v1/query",
  .method = POST,
  .body = json_parse("{\"sql\": \"SELECT * FROM clients\"}")
};
rest_dispatch(&req, &response);
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ GraphQL (schema-to-SQL transpiler)
* WebSocket push-–Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è CDC —Å–æ–±—ã—Ç–∏–π
* REST-based CDC API —á–µ—Ä–µ–∑ Server-Sent Events (SSE)

## üß∞ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è BI/ERP/CRM —Å–∏—Å—Ç–µ–º —á–µ—Ä–µ–∑ REST/gRPC
* –î–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–∞–º –∫–ª–∏–µ–Ω—Ç–æ–≤, –∑–∞–∫–∞–∑–æ–≤, –ª–æ–≥–æ–≤
* –í–Ω–µ—à–Ω—è—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è (–∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è, –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å)

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* IP rate limiting, access scopes, TLS only endpoints
* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ —Ä–∞–∑–º–µ—Ä—É, —Ç–∞–π–º-–∞—É—Ç—É, —Ç–∏–ø—É –∑–∞–ø—Ä–æ—Å–æ–≤
* JWT-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: –ø–æ–¥–ø–∏—Å–∏, mTLS-–ø—Ä–∏–≤—è–∑–∫–∞, revoke

## üßæ –°–æ–æ–±—â–µ–Ω–∏—è, –æ—à–∏–±–∫–∏, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

* `ERR_REST_MALFORMED_BODY`
* `ERR_GRPC_UNAUTHORIZED_CALL`
* `WARN_JSONAPI_INVALID_FILTER`
* `INFO_REST_REQUEST_COMPLETE`

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –í–µ—Ä—Å–∏—è | –ò–∑–º–µ–Ω–µ–Ω–∏—è                                             |
| ------ | ----------------------------------------------------- |
| 1.0    | REST+gRPC –±–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è                          |
| 1.1    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ JSON\:API, –º–∞–ø–ø–∏–Ω–≥ —Ñ–∏–ª—å—Ç—Ä–æ–≤                 |
| 1.2    | TLS 1.3, JWT-—Å–µ—Å—Å–∏–∏, gzip –æ—Ç–≤–µ—Ç–æ–≤                     |
| 1.3    | Streaming gRPC, full OpenAPI, IP ACL, SSE –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è |

## üìà UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
package "–í–Ω–µ—à–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã API" {
  class RESTEngine {
    +dispatch(request)
  }
  class gRPCEngine {
    +handle_call(call)
  }
  class JSONAPIAdapter {
    +transform(json)
  }

  RESTEngine --> SQLExecutor
  gRPCEngine --> SQLExecutor
  JSONAPIAdapter --> SQLParser
  RESTEngine --> AuthManager
  gRPCEngine --> SecurityManager
}
@enduml
```
