# üß± –ë–ª–æ–∫ 2.9 ‚Äî –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–∏—Å—Ç–µ–º–Ω–æ–µ –≤—Ä–µ–º—è (System-Versioned Tables + AS OF Queries)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 2 ‚Äî –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –∏ –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å
* **–ë–ª–æ–∫:** 2.9 ‚Äî –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–∏—Å—Ç–µ–º–Ω–æ–µ –≤—Ä–µ–º—è (System-Versioned Tables + AS OF Queries)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ü–æ–¥—Å–∏—Å—Ç–µ–º–∞ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –ø–µ—Ä–∏–æ–¥–∞–º–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Å—Ç—Ä–æ–∫ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. –û–Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞ –¥–ª—è –∞—É–¥–∏—Ç–∞, –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –æ—Ç–∫–∞—Ç–∞ –∫ —Å–æ—Å—Ç–æ—è–Ω–∏—é –ë–î –≤ –ø—Ä–æ—à–ª–æ–º.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                     | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                      |
| ------------------------------ | ----------------------------------------------------------------------------- |
| –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã       | `SYSTEM VERSIONED` —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ SQL, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–æ–≤ –≤—Ä–µ–º–µ–Ω–∏ |
| –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã           | `AS OF SYSTEM TIME` –∏ `VERSIONS BETWEEN` –∑–∞–ø—Ä–æ—Å—ã                              |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MVCC              | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ MVCC chain –∏ snapshot isolation –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞          |
| TTL –∏ Retention Policy         | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –≤–µ—Ä—Å–∏–π, –ø–æ–ª–∏—Ç–∏–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏       |
| –ê—É–¥–∏—Ç –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π | –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ª–∏–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é –¥–æ –Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥                |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
// version_entry_t: –æ–¥–Ω–∞ –≤–µ—Ä—Å–∏—è —Å—Ç—Ä–æ–∫–∏
typedef struct {
  tx_id_t created_by;
  tx_id_t deleted_by;
  timestamp_t valid_from;
  timestamp_t valid_to;
  row_data_t payload;
} version_entry_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏ (PlantUML)

```
SystemVersioning --> MVCC
SystemVersioning --> QueryEngine
SystemVersioning --> Storage
SystemVersioning --> SnapshotIsolation
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: C23
* –ú–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ —Å –Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é (atomic `timestamp_t`)
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∂–∞—Ç—ã—Ö MVCC-—Ü–µ–ø–æ—á–µ–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–µ—Ä—Å–∏–π
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫: —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/tx/versioning.c`
* `include/tx/versioning.h`
* `src/sql/as_of.c`
* `include/sql/as_of.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è                     | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                          | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                         |
| ----------------------- | ----------------------------------------------------------------- | -------------------------------------------------- |
| `version_insert`        | `void version_insert(table_t *t, row_data_t *r, timestamp_t ts);` | –í—Å—Ç–∞–≤–∫–∞ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ —Å—Ç—Ä–æ–∫–∏ —Å –º–µ—Ç–∫–æ–π –≤—Ä–µ–º–µ–Ω–∏       |
| `version_query_as_of`   | `bool version_query_as_of(tx_snapshot_t *snap, timestamp_t ts);`  | –ü–æ–∏—Å–∫ —Å—Ç—Ä–æ–∫–∏, –≤–∞–ª–∏–¥–Ω–æ–π –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏ |
| `version_purge_expired` | `void version_purge_expired(table_t *t, timestamp_t now);`        | –û—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –≤–µ—Ä—Å–∏–π —Å—Ç—Ä–æ–∫                    |
| `version_range_query`   | `iter_t *version_range_query(...);`                               | –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏    |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã: `tests/tx/test_versioning.c`
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ: `tests/sql/test_asof_query.sql`
* Stress: –º–∞—Å—Å–æ–≤—ã–µ –≤–µ—Ä—Å–∏–∏, TTL-purge –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π
* Fuzz: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–º–∏ –º–µ—Ç–∫–∞–º–∏ –≤—Ä–µ–º–µ–Ω–∏

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                     | –ó–Ω–∞—á–µ–Ω–∏–µ                             |
| --------------------------- | ------------------------------------ |
| –ó–∞–¥–µ—Ä–∂–∫–∞ AS OF-–∑–∞–ø—Ä–æ—Å–∞      | < 1.2 –º—Å –ø—Ä–∏ –≥–ª—É–±–∏–Ω–µ 10K –≤–µ—Ä—Å–∏–π      |
| –°–∫–æ—Ä–æ—Å—Ç—å –æ—á–∏—Å—Ç–∫–∏ TTL        | \~5M –∑–∞–ø–∏—Å–µ–π/—Å –Ω–∞ shard              |
| –†–∞—Å—Ö–æ–¥ –ø–∞–º—è—Ç–∏ –Ω–∞ 100 –≤–µ—Ä—Å–∏–π | \~3.8x –æ—Ç –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ —Å –∫–æ–º–ø—Ä–µ—Å—Å–∏–µ–π |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                   | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                            |
| -------------------------- | ------ | ------------------------------------------------------ |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ SYSTEM VERSIONED | 100    | –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ SQL + –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è –≤—Ä–µ–º–µ–Ω–∏           |
| –ó–∞–ø—Ä–æ—Å—ã AS OF / BETWEEN    | 100    | –ß–µ—Ä–µ–∑ snapshot-aware MVCC API                          |
| TTL, Purge, Retention      | 95     | –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è policy –Ω–∞ –æ—Å–Ω–æ–≤–µ access pattern |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
if (version_query_as_of(&session->snapshot, ts)) {
  return payload->field[0];
} else {
  return NULL;
}
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ TTL –∏ –ø–æ–ª–∏—Ç–∏–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ—Å—Ç—É–ø–∞
* –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–µ—Ä—Å–∏–π –Ω–∞ –¥–∏—Å–∫ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Parquet
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å BI/–∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –≤–µ—Ä—Å–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø—Ä–∞–≤
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª–∏—Ç–∏–∫–∏ ¬´immutable past¬ª –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
* –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∑–∞—â–∏—â—ë–Ω–Ω—ã–π WAL

## üì§ –°–æ–æ–±—â–µ–Ω–∏—è –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

* `I_ASOF_NO_ROW`: –Ω–µ—Ç —Å—Ç—Ä–æ–∫–∏, –≤–∞–ª–∏–¥–Ω–æ–π –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
* `E_TTL_PURGED`: —Å—Ç—Ä–æ–∫–∞ —É–¥–∞–ª–µ–Ω–∞ –ø–æ–ª–∏—Ç–∏–∫–æ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è
* `W_VERSION_CONFLICT`: –∫–æ–Ω—Ñ–ª–∏–∫—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ

## üß© UML-–¥–∏–∞–≥—Ä–∞–º–º–∞ (PlantUML)

```
@startuml
package "System Time Versioning (2.9)" {
  [System Versioning] --> [MVCC]
  [System Versioning] --> [Storage Engine]
  [System Versioning] --> [Query Engine]
  [System Versioning] --> [Snapshot Isolation]
}
@enduml
```

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v0.8 ‚Äî —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑–æ–≤–æ–≥–æ INSERT/AS OF (2025-07-10)
* v1.0 ‚Äî TTL –∏ TTL purge (2025-07-18)
* v1.1 ‚Äî –±—É–¥—É—â–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º (–≤ –ø–ª–∞–Ω–∞—Ö)
