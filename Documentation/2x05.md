# üß± –ë–ª–æ–∫ 2.5 ‚Äî –ú–µ—Ö–∞–Ω–∏–∑–º —Ñ–æ–Ω–æ–≤–æ–π –æ—á–∏—Å—Ç–∫–∏ (Garbage Collection)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 2 ‚Äî –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å
* **–ë–ª–æ–∫:** 2.5 ‚Äî –ú–µ—Ö–∞–Ω–∏–∑–º —Ñ–æ–Ω–æ–≤–æ–π –æ—á–∏—Å—Ç–∫–∏ (Garbage Collection)

---

### üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ú–µ—Ö–∞–Ω–∏–∑–º —Ñ–æ–Ω–æ–≤–æ–π –æ—á–∏—Å—Ç–∫–∏ (GC) –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ –æ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –≤–µ—Ä—Å–∏–π –∑–∞–ø–∏—Å–µ–π, —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –º–Ω–æ–≥–æ–≤–µ—Ä—Å–∏–æ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è (MVCC). –í —É—Å–ª–æ–≤–∏—è—Ö –ø–æ–ª–Ω–æ–π in-memory –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã GC –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ä–∞–∑—Ä–∞—Å—Ç–∞–Ω–∏—è —Ü–µ–ø–æ—á–µ–∫ –≤–µ—Ä—Å–∏–π (version chains), –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –Ω–∏–∑–∫–æ–π –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏, —É–º–µ–Ω—å—à–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –∫—ç—à –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ –∏ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –≤—ã—Å–æ–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π.

---

### ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                         |
| ------------------------- | ---------------------------------------------------------------- |
| –°–±–æ—Ä–∫–∞ –º—É—Å–æ—Ä–∞ MVCC        | –ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–≤–∏–¥–∏–º—ã—Ö –≤–µ—Ä—Å–∏–π (invisible versions)      |
| –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Ü–µ–ø–æ—á–µ–∫      | GC –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–µ —Ü–µ–ø–æ—á–∫–∏ –∏ —É–¥–∞–ª—è–µ—Ç –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã |
| NUMA-aware –æ—á–∏—Å—Ç–∫–∞        | –ö–∞–∂–¥–æ–º—É NUMA-–¥–æ–º–µ–Ω—É ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ GC                         |
| Deferred unlink           | –£–¥–∞–ª–µ–Ω–∏–µ MVCC-–∑–∞–ø–∏—Å–µ–π –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –¥–æ safe snapshot             |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ö–æ–ª–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö | GC –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –≤ —Ö–æ–ª–æ–¥–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω—ã             |
| –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å WAL      | GC —É—á–∏—Ç—ã–≤–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π –¥–æ —Ñ–ª–∞—à–∏–Ω–≥–∞ WAL    |

---

### üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct mvcc_entry_t {
    tx_id_t created_by;
    tx_id_t deleted_by;
    void *record_data;
    struct mvcc_entry_t *next_version;
    bool visible;
} mvcc_entry_t;

typedef struct gc_task_t {
    mvcc_entry_t *head;
    tx_snapshot_t *snapshot;
    uint64_t pages_reclaimed;
    uint32_t chain_length;
} gc_task_t;
```

---

### üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
@startuml
package "2.5 GC" {
  [GC Scheduler] --> [GC Worker]
  [GC Worker] --> [MVCC Chains]
  [GC Worker] --> [Buffer Pool]
  [GC Worker] --> [WAL]
  [GC Worker] --> [Snapshot Manager]
}
@enduml
```

---

### üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: **C23**
* –ú–µ—Ö–∞–Ω–∏–∑–º –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á: GC-–æ—á–µ—Ä–µ–¥—å —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É –≤–µ—Ä—Å–∏–∏
* NUMA-aware —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏: GC –ø–æ—Ç–æ–∫–∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω—ã –∑–∞ NUMA-–¥–æ–º–µ–Ω–∞–º–∏ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Ü–µ–ø–æ—á–µ–∫
* –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ: —á–µ—Ä–µ–∑ deferred unlink —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π snapshot visibility
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ in-flight —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —á–µ—Ä–µ–∑ epoch-based memory reclamation
* –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ GC –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–∞–≤–ª–µ–Ω–∏—è –Ω–∞ –ø–∞–º—è—Ç—å

---

### üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/tx/gc.c`
* `include/tx/gc.h`
* `src/storage/mvcc_chain.c`
* `include/storage/mvcc.h`

---

### üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏      | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                         | –û–ø–∏—Å–∞–Ω–∏–µ                                             |
| ---------------- | ---------------------------------------------------------------- | ---------------------------------------------------- |
| `gc_schedule`    | `void gc_schedule(gc_task_t *task);`                             | –ü–ª–∞–Ω–∏—Ä—É–µ—Ç –∑–∞–¥–∞—á—É –æ—á–∏—Å—Ç–∫–∏ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π MVCC-—Ü–µ–ø–æ—á–∫–µ   |
| `gc_perform`     | `void gc_perform(void);`                                         | –ì–ª–∞–≤–Ω—ã–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å —Ñ–æ–Ω–æ–≤—ã—Ö GC-–∑–∞–¥–∞—á                 |
| `gc_purge_chain` | `bool gc_purge_chain(mvcc_entry_t *chain, tx_snapshot_t *snap);` | –û—á–∏—â–∞–µ—Ç —Ü–µ–ø–æ—á–∫—É –≤–µ—Ä—Å–∏–π, –Ω–µ–≤–∏–¥–∏–º—ã—Ö –≤ —Ç–µ–∫—É—â–µ–º —Å–Ω–∞–ø—à–æ—Ç–µ |
| `gc_stats`       | `void gc_stats(struct gc_metrics_t *out);`                       | –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏: reclaimed pages, latency         |

---

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* **Unit-—Ç–µ—Å—Ç—ã:** `tests/unit/test_gc.c`
* **Fuzz-—Ç–µ—Å—Ç—ã:** `tests/fuzz/gc_chain_fuzz.c` ‚Äî —Ä–∞–Ω–¥–æ–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–ø–æ—á–∫–∏
* **Soak-—Ç–µ—Å—Ç—ã:** –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ mixed workload
* **Stress-—Ç–µ—Å—Ç—ã:** –≤—Å—Ç–∞–≤–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ >10M –∑–∞–ø–∏—Å–µ–π/—Å–µ–∫—É–Ω–¥—É
* **Coverage:** >92% –ø–æ–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–æ–¥—É GC

---

### üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å                | –ó–Ω–∞—á–µ–Ω–∏–µ                                  |
| ------------------------- | ----------------------------------------- |
| –°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞ GC       | < 5 –º—Å –Ω–∞ —Ü–µ–ø–æ—á–∫—É –¥–ª–∏–Ω–æ–π 100+ –≤–µ—Ä—Å–∏–π      |
| –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏       | > 1 GB/sec –Ω–∞ –ø–æ—Ç–æ–∫                       |
| NUMA-aware throughput     | –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –ª–∏–Ω–µ–π–Ω–æ –¥–æ 128 –ø–æ—Ç–æ–∫–æ–≤     |
| –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å snapshot GC | –¥–æ 80% –≤–µ—Ä—Å–∏–π —É–¥–∞–ª—è—é—Ç—Å—è –≤ deferred —Ä–µ–∂–∏–º–µ |

---

### ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                    | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                       |
| --------------------------- | ------ | ------------------------------------------------- |
| NUMA-aware —Ñ–æ–Ω–æ–≤—ã–π GC       | ‚úÖ 100  | –ü–æ—Ç–æ–∫–∏ GC –∑–∞–∫—Ä–µ–ø–ª–µ–Ω—ã –∑–∞ NUMA-—É–∑–ª–∞–º–∏               |
| Deferred unlink –∏ epoch GC  | ‚úÖ 100  | –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞                                  |
| –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å WAL –∏ MVCC | ‚úÖ 100  | –ñ—ë—Å—Ç–∫–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è                                |
| –ú–µ—Ç—Ä–∏–∫–∏ –∏ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ    | ‚úÖ 100  | –≠–∫—Å–ø–æ—Ä—Ç —á–µ—Ä–µ–∑ Prometheus, flamegraph, gc\_metrics |

---

### üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
void gc_perform(void) {
    while (gc_has_tasks()) {
        gc_task_t task = gc_dequeue();
        if (gc_purge_chain(task.head, task.snapshot)) {
            task.pages_reclaimed++;
        }
    }
}
```

---

### üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∏–∑ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö snapshot'–æ–≤
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ transactional-safe deferred unlink
* –ñ—É—Ä–Ω–∞–ª–∏—Ä—É—é—Ç—Å—è –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è GC –ø—Ä–∏ —É—Ä–æ–≤–Ω–µ –∞—É–¥–∏—Ç–∞ "full"

---

### üß© UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
title GC State Transitions

[*] --> Idle
Idle --> Scheduled : gc_schedule()
Scheduled --> Running : gc_perform()
Running --> Idle : done or yield()

@enduml
```

---

### üìå –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
* –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –ø–∞—É–∑ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–π –≤—Å—Ç–∞–≤–∫–µ/—É–¥–∞–ª–µ–Ω–∏–∏
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Å –≤—ã—Å–æ–∫–∏–º —É—Ä–æ–≤–Ω–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

### üóÇÔ∏è –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –ü–µ—Ä–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å deferred unlink
* v1.1 ‚Äî NUMA-aware GC, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
* v1.2 ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –º–µ—Ç—Ä–∏–∫ –∏ flamegraph

