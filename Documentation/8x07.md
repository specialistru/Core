# 8.7 ‚Äî –§–æ—Ä–º–∞—Ç—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è PAX / Apache Arrow (PAX / Arrow Layouts)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* –ü–∞–∫–µ—Ç 8 ‚Äî –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
* –ë–ª–æ–∫ 8.7 ‚Äî –§–æ—Ä–º–∞—Ç—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è PAX / Apache Arrow (PAX / Arrow Layouts)

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –±–ª–æ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –≤—ã–±–æ—Ä –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —Ñ–æ—Ä–º–∞—Ç–æ–≤ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏, –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞ –≤—ã—Å–æ–∫—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏ OLTP-–∑–∞–ø—Ä–æ—Å–æ–≤. –í —á–∞—Å—Ç–Ω–æ—Å—Ç–∏, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–∞–∫ PAX (Partition Attributes Across) –¥–ª—è —Å—Ç—Ä–æ—á–Ω–æ-–∫–æ–ª–æ–Ω–æ—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è, —Ç–∞–∫ –∏ Apache Arrow –¥–ª—è –∫–æ–ª–æ–Ω–æ—á–Ω–æ–≥–æ in-memory —Ñ–æ—Ä–º–∞—Ç–∞ —Å –Ω—É–ª–µ–≤–æ–π —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞              | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                            |
| ----------------------- | ----------------------------------------------------------------------------------- |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ PAX           | –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –∫—ç—à—É, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π layout –≤ page, —É—Å–∫–æ—Ä–µ–Ω–∏–µ OLTP                     |
| Apache Arrow            | Zero-copy –¥–æ—Å—Ç—É–ø, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –≤–Ω–µ—à–Ω–∏–º–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏ (NumPy, Pandas, TensorFlow) |
| –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–æ–≤    | Vectorized layout transforms –º–µ–∂–¥—É row, PAX –∏ Arrow                                 |
| –ö–æ–ª–æ–Ω–æ—á–Ω—ã–µ –≤–µ–∫—Ç–æ—Ä–∞      | SIMD-–¥—Ä—É–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–∞—Å—Å–∏–≤—ã, memory-aligned –±—É—Ñ–µ—Ä—ã                                   |
| Layout-aware –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ | –û–ø–µ—Ä–∞—Ç–æ—Ä—ã —É—á–∏—Ç—ã–≤–∞—é—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è                                      |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
// –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è PAX layout
struct pax_page_t {
    uint8_t *column_data[MAX_COLUMNS];
    uint16_t row_count;
    uint16_t column_count;
};

// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Arrow Column
struct arrow_column_t {
    void *buffer;
    size_t length;
    size_t offset;
    uint32_t null_bitmap;
};
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[8.7 –§–æ—Ä–º–∞—Ç—ã PAX / Arrow] --> [8.1 –í–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ]
[8.7 –§–æ—Ä–º–∞—Ç—ã PAX / Arrow] --> [3.2 SQL-–æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä]
[8.7 –§–æ—Ä–º–∞—Ç—ã PAX / Arrow] --> [1.3 Column-Store Engine]
[8.7 –§–æ—Ä–º–∞—Ç—ã PAX / Arrow] --> [5.1 BI –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –ù–∞–ø–∏—Å–∞–Ω–æ –Ω–∞ C23, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç memory-aligned allocation
* SIMD-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è Arrow column access
* Zero-copy —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Å Arrow
* NUMA-aware —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç layout hints –æ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–∞ –∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/storage/pax.c`
* `src/storage/arrow.c`
* `include/storage/pax.h`
* `include/storage/arrow.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏                   | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                     | –û–ø–∏—Å–∞–Ω–∏–µ                              |
| ----------------------------- | ------------------------------------------------------------ | ------------------------------------- |
| pax\_page\_create             | `pax_page_t *pax_page_create(uint16_t col_count)`            | –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π PAX-—Å—Ç—Ä–∞–Ω–∏—Ü—ã           |
| pax\_page\_insert             | `bool pax_page_insert(pax_page_t *, uint16_t row, void **)`  | –í—Å—Ç–∞–≤–∫–∞ —Å—Ç—Ä–æ–∫–∏ –≤ PAX layout           |
| arrow\_column\_init           | `void arrow_column_init(arrow_column_t *, size_t len)`       | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–ª–æ–Ω–∫–∏ –≤ Arrow —Ñ–æ—Ä–º–∞—Ç–µ |
| arrow\_column\_from\_pax      | `bool arrow_column_from_pax(pax_page_t *, arrow_column_t *)` | –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ PAX –≤ Arrow   |
| vectorized\_layout\_transform | `bool vectorized_layout_transform(...)`                      | –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π layout —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ç–æ—Ä    |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã: `tests/storage/test_pax.c`, `test_arrow.c`
* –ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã: `soak/test_layout_soak.c`
* –ü–æ–∫—Ä—ã—Ç–∏–µ: >90%
* –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Pandas/Arrow API —á–µ—Ä–µ–∑ C-bindings

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* –£—Å–∫–æ—Ä–µ–Ω–∏–µ OLTP-–≤—Å—Ç–∞–≤–∫–∏ –¥–æ 3.7x –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å row-store
* –ö–æ–ª–æ–Ω–æ—á–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ Arrow –≤–µ–∫—Ç–æ—Ä–æ–º: \~1.2 GB/s/core
* –°—Ä–µ–¥–Ω—è—è –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å layout transform < 15 –º–∫—Å
* PAX layout –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ª—É—á—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –Ω–∞ mixed workload (TPC-C + TPC-H)

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                       | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                                   |
| ------------------------------ | ------ | ------------------------------------------------------------- |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ column-store         | ‚úÖ      | Apache Arrow –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º                              |
| –í—ã—Å–æ–∫–∞—è –ø—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å | ‚úÖ      | SIMD + zero-copy –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å |
| –ì–∏–±–∫–æ—Å—Ç—å —Ñ–æ—Ä–º–∞—Ç–æ–≤ —Ö—Ä–∞–Ω–µ–Ω–∏—è     | ‚úÖ      | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ PAX, row, Arrow                                     |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å BI/ML             | ‚úÖ      | Arrow –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞–º–∏       |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
pax_page_t *page = pax_page_create(4);
void *row[4] = { &id, &name, &age, &salary };
pax_page_insert(page, 0, row);
arrow_column_t col;
arrow_column_from_pax(page, &col);
```

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –≤ –±–ª–æ–∫–µ

* –í—Å–µ –±—É—Ñ–µ—Ä—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –Ω–∞ –≥—Ä–∞–Ω–∏—Ü—ã
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è zero-initialization –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –Ω–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
* –ö–æ–Ω—Ç—Ä–æ–ª—å –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Arrow Flight RPC –¥–ª—è —É–¥–∞–ª—ë–Ω–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö
* Layout autotuning –Ω–∞ –æ—Å–Ω–æ–≤–µ query feedback loop
* –°–∂–∞—Ç–∏–µ –∏ –¥–µ–∫–æ–º–ø—Ä–µ—Å—Å–∏—è –≤–Ω—É—Ç—Ä–∏ Arrow –∫–æ–ª–æ–Ω–æ–∫

## üß¨ –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ PAX layout –¥–ª—è OLTP (2024-03)
* v1.1 ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω Arrow layout + API —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (2024-08)
* v1.2 ‚Äî layout-aware execution –≤ executor pipeline (2025-01)

## üí¨ –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö / –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

* `E_PAX_OVERFLOW` ‚Äî –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ PAX-—Å—Ç—Ä–∞–Ω–∏—Ü—ã
* `E_ARROW_INVALID_LAYOUT` ‚Äî –æ—à–∏–±–∫–∞ –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ–≥–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è
* `W_ARROW_ALIGNMENT` ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è

## üß© –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* BI-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ (OLAP) –∏ –æ—Ç—á—ë—Ç—ã
* ML-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Arrow
* –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –¥–µ—à–∏—Ñ—Ä–æ–≤–∫–∏ –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
