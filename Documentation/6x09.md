# 6.9 ‚Äî –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∏ –¥–≤–∏–∂–æ–∫ Access Policy Engine

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 6 ‚Äî –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
**–ë–ª–æ–∫ 6.9 ‚Äî –ü–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∏ –¥–≤–∏–∂–æ–∫ Access Policy Engine**

---

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

Access Policy Engine (APE) ‚Äî —ç—Ç–æ –º–æ–¥—É–ª—å –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ç—Ä–æ–∫, —Å—Ç–æ–ª–±—Ü–æ–≤ –∏ —É—Å–ª–æ–≤–∏–π –∑–∞–ø—Ä–æ—Å–∞. –û–Ω –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ–µ –∏ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤ SQL-–ø–ª–∞–Ω–∞—Ö, –∞ —Ç–∞–∫–∂–µ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏, –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º–∏ (ABAC, RBAC).

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞              | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                            |
| ----------------------- | --------------------------------------------------- |
| Row-Level Security      | –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å—Ç—Ä–æ–∫ –ø–æ user/role/attribute             |
| Column-Level Security   | –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ/—Å–∫—Ä—ã—Ç–∏–µ —Å—Ç–æ–ª–±—Ü–æ–≤                       |
| RBAC                    | –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è —Ä–æ–ª–µ–≤–∫–∞, –≤–ª–æ–∂–µ–Ω–Ω—ã–µ —Ä–æ–ª–∏                |
| ABAC                    | –ê—Ç—Ä–∏–±—É—Ç–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å (user.attr == X) |
| Policy DSL              | –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —è–∑—ã–∫ –ø–æ–ª–∏—Ç–∏–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏                |
| Enforcement Engine      | –ò–Ω–∂–µ–∫—Ü–∏—è –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ AST SQL                         |
| Context-aware execution | –ü—Ä–∏–≤—è–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (tenant\_id, region, clearance)  |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct access_policy_t {
  char policy_id[64];
  policy_scope_t scope;      // ROW, COLUMN
  expr_ast_t *condition;     // AST –≤—ã—Ä–∞–∂–µ–Ω–∏–µ
  char target_table[64];
  char target_column[64];    // optional
  char role[64];             // optional
} access_policy_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
SQLParser --> AccessPolicyEngine
AccessPolicyEngine --> ContextManager
AccessPolicyEngine --> RoleManager
AccessPolicyEngine --> ExpressionEvaluator
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ compile-time –∏ runtime enforcement
* –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ SQL AST —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –ø–æ–ª–∏—Ç–∏–∫
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ tenant isolation, multi-tenant-—Ä–µ–∂–∏–º
* Runtime context propagation (—á–µ—Ä–µ–∑ db\_session\_t)
* –ö–æ–º–ø–∏–ª—è—Ü–∏—è –ø–æ–ª–∏—Ç–∏–∫ –≤ BPF-–ø–æ–¥–æ–±–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã (–≤ –±—É–¥—É—â–µ–º)

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/security/access_policy_engine.c`
* `src/sql/sql_parser.c`
* `src/sql/policy_injector.c`
* `include/security/access_policy.h`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –ò–º—è                     | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                | –û–ø–∏—Å–∞–Ω–∏–µ                                     |
| ----------------------- | ----------------------------------------------------------------------- | -------------------------------------------- |
| `policy_eval_ast`       | `void policy_eval_ast(ast_t *tree, db_session_t *s)`                    | –ò–Ω–∂–µ–∫—Ü–∏—è –ø–æ–ª–∏—Ç–∏–∫ –≤ –¥–µ—Ä–µ–≤–æ SQL-–∑–∞–ø—Ä–æ—Å–∞        |
| `policy_register`       | `int policy_register(access_policy_t *p)`                               | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–π –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞           |
| `policy_list_for_user`  | `list_t *policy_list_for_user(const char *user, const char *table)`     | –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏–º–µ–Ω–∏–º—ã—Ö –ø–æ–ª–∏—Ç–∏–∫          |
| `context_set_attribute` | `void context_set_attribute(db_session_t *s, const char *key, val_t v)` | –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/security/test_policy_engine.c`
* Soak: —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Å 10k+ –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏ –Ω–∞ —Ä–∞–∑–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
* Fuzz: AST-–º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–∏ —Ä–∞–∑–Ω—ã—Ö SQL —à–∞–±–ª–æ–Ω–∞—Ö
* Integration: RLS+ABAC –Ω–∞ –º–Ω–æ–≥–æ—Ç–µ–Ω–∞–Ω—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è                     | –ú–µ—Ç—Ä–∏–∫–∞       |
| ---------------------------- | ------------- |
| –ò–Ω–∂–µ–∫—Ü–∏—è –ø–æ–ª–∏—Ç–∏–∫ –≤ AST       | \~ 400‚Äì600 –Ω—Å |
| –í—ã–±–æ—Ä–∫–∞ RLS+ABAC             | < 1.5 –º—Å      |
| –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞ | \~ 80‚Äì150 –Ω—Å  |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π              | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                               |
| --------------------- | ------ | ----------------------------------------- |
| Row-Level Security    | 100    | –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å—Ç—Ä–æ–∫              |
| Column-Level Security | 100    | –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ, —É—Å–ª–æ–≤–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è         |
| ABAC-–ø–æ–¥–¥–µ—Ä–∂–∫–∞        | 100    | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ user-–∞—Ç—Ä–∏–±—É—Ç—ã |
| DSL –¥–ª—è –ø–æ–ª–∏—Ç–∏–∫       | 100    | –î–æ—Å—Ç—É–ø–µ–Ω –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å          |
| Runtime –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã     | 100    | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ per-session      |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```sql
-- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ SQL
SELECT * FROM accounts
WHERE region = CURRENT_USER_CONTEXT('region')
  AND role = 'auditor';
```

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* JIT-–∫–æ–º–ø–∏–ª—è—Ü–∏—è –ø–æ–ª–∏—Ç–∏–∫ –≤ bytecode
* –ö–æ–Ω—Å–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø–æ–ª–∏—Ç–∏–∫ (web)
* –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –Ω–∞ CDC –∏ –≤–Ω–µ—à–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏

---

## üìä UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity "SQLParser" as SQL
entity "AccessPolicyEngine" as APE
entity "ContextManager" as CTX
entity "RoleManager" as RM
entity "ExpressionEvaluator" as EE

SQL --> APE
APE --> CTX
APE --> RM
APE --> EE
@enduml
```

---

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å—Ç—Ä–æ–∫–∞–º/–ø–æ–ª—è–º –ø–æ –æ—Ç–¥–µ–ª–∞–º
* –ó–∞—â–∏—Ç–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏ –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–π —Ç–∞–π–Ω—ã
* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏ –¥–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ –∏ –º—É–ª—å—Ç–∏-–∞—Ä–µ–Ω–¥—ã

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ê—É–¥–∏—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª–∏—Ç–∏–∫
* –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ–ª–∏—Ç–∏–∫ –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
* –û—Ç–∫–∞–∑ –æ—Ç "–æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞" –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

---

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –í–µ—Ä—Å–∏—è | –ò–∑–º–µ–Ω–µ–Ω–∏–µ                              |
| ------ | -------------------------------------- |
| v1.0   | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ RLS –∏ RBAC                   |
| v1.1   | ABAC –∏ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –≤ –ø–æ–ª–∏—Ç–∏–∫–µ            |
| v1.2   | Runtime –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã –∏ session-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ |
| v1.3   | DSL-—Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∏ –∫–æ–º–ø–∏–ª—è—Ü–∏—è –ø–æ–ª–∏—Ç–∏–∫     |

---

## üõë –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

| –ö–æ–¥                 | –£—Å–ª–æ–≤–∏–µ                         | –û–ø–∏—Å–∞–Ω–∏–µ                                    |
| ------------------- | ------------------------------- | ------------------------------------------- |
| `E_POLICY_DENIED`   | –ü–æ–ª–∏—Ç–∏–∫–∞ –∑–∞–ø—Ä–µ—Ç–∏–ª–∞ –∑–∞–ø—Ä–æ—Å       | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º      |
| `W_POLICY_FALLBACK` | –ù–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã | –ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (–ª–æ–≥–∏—Ä—É–µ—Ç—Å—è) |
