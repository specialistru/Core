# 5.14 ‚Äî –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å (Extensibility, UDF/UDAF)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 5 ‚Äî BI, ML –∏ OLAP**
**–ë–ª–æ–∫ 5.14 ‚Äî –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å (Extensibility, UDF/UDAF)**

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–≠—Ç–æ—Ç –±–ª–æ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ä–∞—Å—à–∏—Ä—è–µ–º–æ–π –ª–æ–≥–∏–∫–∏ –≤–Ω—É—Ç—Ä–∏ –°–£–ë–î —á–µ—Ä–µ–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ (UDF), –∞–≥—Ä–µ–≥–∞—Ç—ã (UDAF) –∏ –ø–ª–∞–≥–∏–Ω—ã. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è Lua, WASM, JS, C/C++, –ø–æ–∑–≤–æ–ª—è—è –¥–æ–±–∞–≤–ª—è—Ç—å –ª—é–±—É—é –ª–æ–≥–∏–∫—É –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞          | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                        |
| ------------------- | ----------------------------------------------- |
| UDF (Lua, JS, WASM) | –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤ –ø–µ—Å–æ—á–Ω–∏—Ü–µ, JIT –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è       |
| C/C++ UDF           | –†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–æ–¥—É–ª–µ–π          |
| UDAF                | –ê–≥—Ä–µ–≥–∞—Ç—ã: state-init, state-update, state-merge |

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä—ã

```c
// C-API –¥–ª—è UDF
typedef struct udf_context_t {
  db_session_t *session;
  const char *args_json;
  void *userdata;
} udf_context_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```plantuml
SQLExecutor --> UDFEngine
UDFEngine --> LuaRuntime
UDFEngine --> WASMRuntime
UDFEngine --> CExtensionLoader
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

* RBAC-–∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∫ UDF
* –¢–µ—Å—Ç–∏—Ä—É–µ–º—ã–µ, –æ—Ç–ª–∞–∂–∏–≤–∞–µ–º—ã–µ Lua/–° –ø—Ä–æ—Ü–µ–¥—É—Ä—ã
* –°–µ—Å—Å–∏–æ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, context-based API

## üìÇ –ö–æ–¥

* `src/udf/udf_engine.c`
* `src/udf/wasm_runtime.c`
* `src/udf/lua_runtime.c`
* `include/udf/udf_api.h`

## üîß –§—É–Ω–∫—Ü–∏–∏

| –ò–º—è            | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                             | –û–ø–∏—Å–∞–Ω–∏–µ                        |
| -------------- | ---------------------------------------------------- | ------------------------------- |
| `udf_register` | `int udf_register(const char *name, udf_func_t *fn)` | –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç UDF –ø–æ –∏–º–µ–Ω–∏       |
| `udf_call`     | `result_t udf_call(udf_context_t *ctx)`              | –í—ã–∑—ã–≤–∞–µ—Ç UDF –≤ —Å–µ—Å—Å–∏–∏           |
| `udaf_reduce`  | `result_t udaf_reduce(udaf_state_t *s, row_t *row)`  | –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞–≥—Ä–µ–≥–∞—Ç–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è |

## ü•∫ –¢–µ—Å—Ç—ã

* Unit: `tests/udf/test_udf.c`
* Integration: SQL + Lua runtime
* Fuzz: WASM UDF input fuzzing

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –°—Ü–µ–Ω–∞—Ä–∏–π         | –ú–µ—Ç—Ä–∏–∫–∞  |
| ---------------- | -------- |
| Lua UDF          | < 2.1 –º—Å |
| WASM sandbox UDF | < 3.5 –º—Å |
| C inline UDF     | < 0.4 –º—Å |

## ‚úÖ SAP HANA+ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ

| –ö—Ä–∏—Ç–µ—Ä–∏–π         | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                           |
| ---------------- | ------ | ------------------------------------- |
| Lua/WASM runtime | 100    | –°—Ç–∞–±–∏–ª—å–Ω–∞—è JIT + sandbox              |
| C/C++ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è | 100    | –î–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π              |
| UDAF support     | 100    | –ü–æ–ª–Ω—ã–π lifecycle: init, merge, result |

## üìå –ü—Ä–∏–º–µ—Ä SQL

```sql
SELECT my_custom_udf(symbol, price, volume)
FROM trades
WHERE symbol = 'AAPL';
```

## üìä UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity "SQLExecutor" as SQL
entity "UDFEngine" as UDF
entity "LuaRuntime" as LUA
entity "WASMRuntime" as WASM
entity "CExtensionLoader" as CEXT

SQL --> UDF
UDF --> LUA
UDF --> WASM
UDF --> CEXT
@enduml
```

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å–æ–º

* –í—ã—á–∏—Å–ª—è–µ–º—ã–µ –ø–æ–ª—è, –æ—Ü–µ–Ω–∫–∏, –¥–æ–ø.–ª–æ–≥–∏–∫–∞
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ERP/–ø–ª–∞–Ω–∏—Ä–æ–≤–æ—á–Ω—ã—Ö UDF

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

* RBAC –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∏ –≤—ã–∑–æ–≤ UDF
* Sandbox Lua/WASM —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏ CPU/–≤—Ä–µ–º–µ–Ω–∏

## ‚åöÔ∏è –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –±–∞–∑–æ–≤—ã–π Lua/UDF
* v1.1 ‚Äî WASM –ø–æ–¥–¥–µ—Ä–∂–∫–∞ + –ø–µ—Å–æ—á–Ω–∏—Ü—ã
* v1.2 ‚Äî UDAF –ø–æ–¥–¥–µ—Ä–∂–∫–∞ + –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è C

## ‚ö†Ô∏è –û—à–∏–±–∫–∏ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

| –ö–æ–¥ / —Ç–∏–ø          | –£—Å–ª–æ–≤–∏–µ                     | –û–ø–∏—Å–∞–Ω–∏–µ              |
| ------------------ | --------------------------- | --------------------- |
| E\_UDF\_NOT\_FOUND | –ò–º—è UDF –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ | –û—à–∏–±–∫–∞ –≤—ã–∑–æ–≤–∞         |
| E\_UDF\_RUNTIME    | –û—à–∏–±–∫–∞ –≤ Lua/–° –∫–æ–¥–µ         | –†–∞–∑—Ä—ã–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è UDF |
| W\_UDF\_TIMEOUT    | –£–∫–∞–∑–∞–Ω –ª–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏        | UDF –ø—Ä–µ               |
