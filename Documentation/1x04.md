# üß± –ë–ª–æ–∫ 1.4 ‚Äî –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WAL (–∂—É—Ä–Ω–∞–ª –ø—Ä–µ–¥–∑–∞–ø–∏—Å–∏)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.4 ‚Äî –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WAL (–∂—É—Ä–Ω–∞–ª –ø—Ä–µ–¥–∑–∞–ø–∏—Å–∏)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

WAL (Write-Ahead Logging) –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥—ë–∂–Ω—É—é –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—É—é –∑–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ —Ñ–∏–∫—Å–∞—Ü–∏–µ–π –≤ –ø–∞–º—è—Ç–∏ –∏–ª–∏ NVMe. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WAL –Ω–∞ —Å—Ç–∞—Ä—Ç–µ –°–£–ë–î –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç:

* –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º–∞ –∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ —Å—Ç–∞—Ä—Ç–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π,
* –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∞–≤–∞—Ä–∏–π–Ω–æ–º—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é –∏ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏,
* —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å —Å MVCC –∏ snapshot-–º–µ–Ω–µ–¥–∂–µ—Ä–æ–º.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞          | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                  |
| ------------------- | --------------------------------------------------------- |
| –ë—É—Ñ–µ—Ä WAL           | Ring-buffer –Ω–∞ –ø–∞–º—è—Ç—å —Å mmap –∏–ª–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç—å—é      |
| –ú–µ—Ö–∞–Ω–∏–∑–º –ø—Ä–µ–¥–∑–∞–ø–∏—Å–∏ | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ –≤–Ω–µ—Å–µ–Ω–∏—è –≤ in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–µ             |
| WAL writer          | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π, —Å–∂–∞—Ç–∏–µ –ª–æ–≥–æ–≤, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è                  |
| Snapshot –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ snapshot recovery              |
| WAL —Ñ–æ—Ä–º–∞—Ç          | –ë–∏–Ω–∞—Ä–Ω—ã–π, –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ        |
| –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞         | –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ wal\_path, –¥–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
// WAL header + –∑–∞–ø–∏—Å—å –∏–∑–º–µ–Ω–µ–Ω–∏–π
typedef struct wal_entry_t {
    uint64_t tx_id;
    uint64_t timestamp;
    wal_op_type_t op_type;
    uint32_t data_len;
    uint8_t  data[]; // –°–∂–∞—Ç–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
} wal_entry_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[1.2 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è] --> [1.4 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WAL]
[1.4 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WAL] --> [2.4 MVCC-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ]
[1.4 –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WAL] --> [2.6 –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ Snapshot]
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: **C23**
* –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ mmap –±—É—Ñ–µ—Ä—ã
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö WAL writer‚Äô–æ–≤
* –°–µ–≥–º–µ–Ω—Ç–∏—Ä—É–µ–º–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∫–æ–º–ø–∞–∫—Ü–∏—è WAL
* NUMA-aware –±—É—Ñ–µ—Ä—ã WAL –≤ –±—É–¥—É—â–µ–º —Ä–µ–ª–∏–∑–µ

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

| –ü—É—Ç—å             | –û–ø–∏—Å–∞–Ω–∏–µ              |
| ---------------- | --------------------- |
| `src/wal.c`      | –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ WAL   |
| `include/wal.h`  | –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã |
| `src/snapshot.c` | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å recovery |

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏    | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                     | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                             |
| -------------- | -------------------------------------------- | -------------------------------------- |
| `wal_init`     | `bool wal_init(const char *path);`           | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è WAL |
| `wal_append`   | `bool wal_append(const wal_entry_t *entry);` | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –∂—É—Ä–Ω–∞–ª             |
| `wal_flush`    | `void wal_flush(void);`                      | –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–∞ –¥–∏—Å–∫   |
| `wal_rotate`   | `void wal_rotate(void);`                     | –°–º–µ–Ω–∞ WAL-—Å–µ–≥–º–µ–Ω—Ç–∞                     |
| `wal_shutdown` | `void wal_shutdown(void);`                   | –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ WAL –∏ –æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤      |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* `tests/unit/test_wal.c` ‚Äî —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –æ–ø–µ—Ä–∞—Ü–∏–π
* `tests/integration/test_tx_crash.c` ‚Äî –ø–∞–¥–µ–Ω–∏–µ + recovery
* `tests/fuzz/fuzz_wal_parser.c` ‚Äî —Ñ—É–∑–∑–∏–Ω–≥ WAL-–∑–∞–ø–∏—Å–µ–π
* –ü–æ–∫—Ä—ã—Ç–∏–µ: > 93% –ø–æ —Å—Ç—Ä–æ–∫–∞–º, mutation safe

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                    | –ó–Ω–∞—á–µ–Ω–∏–µ                        |
| -------------------------- | ------------------------------- |
| –°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞ append    | 210‚Äì330 –Ω—Å                      |
| –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å WAL | –¥–æ 1.5 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π/—Å–µ–∫ –ø—Ä–∏ SSD  |
| –°–∂–∞—Ç–∏–µ –ª–æ–≥–æ–≤               | \~2.7√ó (custom delta+RLE codec) |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                         | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                        |
| -------------------------------- | ------ | ---------------------------------- |
| Write-Ahead Logging              | 100    | –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è           |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å recovery / snapshot | 100    | –î–∞, —á–µ—Ä–µ–∑ snapshot.c –∏ checkpoint  |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –∏ —Å–∂–∞—Ç–∏—è     | 100    | –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –∫–æ–º–ø–∞–∫—Ü–∏—è –∏ —Ä–æ—Ç–∞—Ü–∏—è WAL |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
if (!wal_init(config_get_wal_path())) {
    log_error("WAL", "–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ WAL");
    exit(EXIT_FAILURE);
}
```

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* NUMA-aware WAL writer (—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å–æ–∫–µ—Ç–∞–º CPU)
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ WAL –≤ in-memory –±–µ–∑ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã (RAM-disk fallback)
* WAL streaming –¥–ª—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ (Raft + Changefeed)

---

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞ (.puml)

```plantuml
@startuml
package "1.4 WAL (–∂—É—Ä–Ω–∞–ª –ø—Ä–µ–¥–∑–∞–ø–∏—Å–∏)" {
  class wal_entry_t {
    +uint64_t tx_id
    +uint64_t timestamp
    +wal_op_type_t op_type
    +uint32_t data_len
    +uint8_t data[]
  }

  class wal.c
  class wal.h
  class snapshot.c
  wal.c --> wal_entry_t
  snapshot.c --> wal_entry_t
}
@enduml
```

---

## üßæ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ì–∞—Ä–∞–Ω—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–∏ —Å–±–æ—è—Ö
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –≤ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ
* –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–∫–∞—Ç–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É snapshot

---

## üìú –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –í–µ—Ä—Å–∏—è | –î–∞—Ç–∞       | –ê–≤—Ç–æ—Ä      | –ò–∑–º–µ–Ω–µ–Ω–∏—è                          |
| ------ | ---------- | ---------- | ---------------------------------- |
| 1.0    | 2025-07-26 | –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä | –ù–∞—á–∞–ª—å–Ω—ã–π —Ä–µ–ª–∏–∑ WAL-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã |

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥ WAL
* WAL-—Ñ–∞–π–ª—ã –º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã (–±—É–¥—É—â–∏–π —Ä–µ–ª–∏–∑)
* –ò–º–º—É—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–µ–π –ø–æ—Å–ª–µ commit

---

## üìù –°–æ–æ–±—â–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞ (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)

| –£—Ä–æ–≤–µ–Ω—å | –°–æ–æ–±—â–µ–Ω–∏–µ                                     | –£—Å–ª–æ–≤–∏–µ                           |
| ------- | --------------------------------------------- | --------------------------------- |
| INFO    | `[WAL] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞`                 | –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –∑–∞–ø—É—Å–∫–µ wal\_init    |
| ERROR   | `[WAL] –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ %s`         | –ï—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ WAL –∫–∞—Ç–∞–ª–æ–≥—É   |
| DEBUG   | `[WAL] –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å tx=%lu len=%u`        | –ü—Ä–∏ –∫–∞–∂–¥–æ–º wal\_append            |
| WARN    | `[WAL] –ü—Ä–æ–ø—É—â–µ–Ω–∞ –∑–∞–ø–∏—Å—å: –æ—á–µ—Ä–µ–¥—å –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∞` | –ü—Ä–∏ —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ–º –ø–æ—Ç–æ–∫–µ append |
