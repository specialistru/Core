# üì¶ –ü–∞–∫–µ—Ç 2 ‚Äî –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å

| ‚Ññ –±–ª–æ–∫–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞                                                                 |
| ------- | ------------------------------------------------------------------------------ |
| 2.1     | MVCC (Compressed Chains + Snapshot Isolation)                                  |
| 2.2     | –£—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (RC, RR, SI, SERIALIZABLE)                          |
| 2.3     | –ñ—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ WAL (Write-Ahead Logging)                                       |
| 2.4     | –°–Ω–∏–º–∫–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ (Snapshots + Recovery)                                 |
| 2.5     | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ (Transaction Manager)                                  |
| 2.6     | Active-Active / Active-Passive —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è                                      |
| 2.7     | –ö–æ–Ω—Å–µ–Ω—Å—É—Å–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª (Raft/Paxos)                                             |
| 2.8     | Watchdog –∏ Failover                                                            |
| 2.9     | –§–æ–Ω–æ–≤–∞—è —Å–±–æ—Ä–∫–∞ –º—É—Å–æ—Ä–∞ (Garbage Collector, Vacuum)                              |
| 2.10    | –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ (crash recovery, fault injection, —Å—Ç—Ä–µ—Å—Å –∏ soak-—Ç–µ—Å—Ç—ã) |

---

# üß± –ë–ª–æ–∫ 2.1 ‚Äî MVCC (Compressed Chains + Snapshot Isolation)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 2. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å
* **–ë–ª–æ–∫:** 2.1 MVCC (Compressed Chains + Snapshot Isolation)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ú–µ—Ö–∞–Ω–∏–∑–º –º–Ω–æ–≥–æ–≤–µ—Ä—Å–∏–æ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏ (MVCC) –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∏–∑–æ–ª—è—Ü–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫, –∏—Å–ø–æ–ª—å–∑—É—è –∫–æ–º–ø—Ä–µ—Å—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–ø–æ—á–∫–∏ –≤–µ—Ä—Å–∏–π –∑–∞–ø–∏—Å–µ–π (`compressed chains`) –∏ –∏–∑–æ–ª—è—Ü–∏—é —Å–Ω–∏–º–∫–æ–≤ (`snapshot isolation`). –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º OLTP/OLAP-–∑–∞–ø—Ä–æ—Å–∞–º –≤–∏–¥–µ—Ç—å —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É –±–∞–∑—ã –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è real-time –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞           | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                        |
| -------------------- | ------------------------------------------------------------------------------- |
| –í–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–µ–π | –ö–æ–º–ø—Ä–µ—Å—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–ø–æ—á–∫–∏ `mvcc_entry_t`                                        |
| –í–∏–¥–∏–º–æ—Å—Ç—å –∑–∞–ø–∏—Å–µ–π    | –°—Ä–∞–≤–Ω–µ–Ω–∏–µ TID, `tx_snapshot_t` –∏ bitmask –¥–ª—è concurrent/committed state         |
| Undo-—Ü–µ–ø–æ—á–∫–∞         | –û–±—Ä–∞—Ç–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≤–µ—Ä—Å–∏–∏ (single-writer, multiple-reader)           |
| –ò–∑–æ–ª—è—Ü–∏—è —Å–Ω–∏–º–∫–æ–≤     | Snapshot isolation —Å –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–º `tx_snapshot_t` –∏ deferred commit visibility |
| –û—á–∏—Å—Ç–∫–∞ –≤–µ—Ä—Å–∏–π (GC)  | –§–æ–Ω–æ–≤—ã–π —Å–±–æ—Ä—â–∏–∫ –º—É—Å–æ—Ä–∞, reentrant, NUMA-aware                                   |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å WAL     | –ü—Ä–∏–≤—è–∑–∫–∞ `mvcc_entry` –∫ LSN, –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø—Ä–∏ recovery                       |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct mvcc_entry_t {
    uint64_t tid_begin;       // TID –Ω–∞—á–∞–ª–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏
    uint64_t tid_end;         // TID –∫–æ–Ω—Ü–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ (–∏–ª–∏ 0)
    uint64_t lsn;             // LSN –≤ WAL
    struct mvcc_entry_t *prev;// –°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é
    void *payload;            // –£–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –¥–∞–Ω–Ω—ã–µ (row/column)
} mvcc_entry_t;

typedef struct tx_snapshot_t {
    uint64_t tid_current;     // –¢–µ–∫—É—â–∏–π TID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    uint64_t *visible_tids;   // –°–ø–∏—Å–æ–∫ –≤–∏–¥–∏–º—ã—Ö TID
    size_t visible_count;     // –†–∞–∑–º–µ—Ä —Å–ø–∏—Å–∫–∞
} tx_snapshot_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
package "2.1 MVCC" {
  [MVCC Engine] --> [Transaction Manager]
  [MVCC Engine] --> [WAL Writer]
  [MVCC Engine] --> [Garbage Collector]
  [MVCC Engine] --> [Query Executor]
  [MVCC Engine] --> [Snapshot Manager]
}
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: **C23**, NUMA-aware —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ —Ü–µ–ø–æ—á–µ–∫
* Payload-–∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç immutability –º–µ–∂–¥—É –≤–µ—Ä—Å–∏—è–º–∏
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `system-versioned` —Ç–∞–±–ª–∏—Ü (AS OF)
* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ (`mvcc_visible_vector`)
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∂–∞—Ç–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ `payload` –≤ —Ü–µ–ø–æ—á–∫–µ
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ rollback, reapply –∏ time-travel query

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/tx/mvcc.c`
* `src/tx/mvcc_gc.c`
* `include/tx/mvcc.h`
* `include/tx/tx_snapshot.h`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏         | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                         | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                     |
| ------------------- | ---------------------------------------------------------------- | ---------------------------------------------- |
| `mvcc_visible`      | `bool mvcc_visible(const mvcc_entry_t *, const tx_snapshot_t *)` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∑–∞–ø–∏—Å–∏ –≤ snapshot           |
| `mvcc_insert`       | `mvcc_entry_t *mvcc_insert(void *payload, uint64_t tid)`         | –í—Å—Ç–∞–≤–∫–∞ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ –∑–∞–ø–∏—Å–∏                    |
| `mvcc_gc_step`      | `void mvcc_gc_step()`                                            | –û–¥–∏–Ω —à–∞–≥ GC-—Ü–∏–∫–ª–∞: —É–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Ü–µ–ø–æ—á–µ–∫ |
| `mvcc_chain_append` | `void mvcc_chain_append(mvcc_entry_t *head, mvcc_entry_t *new)`  | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ –∫ —Ü–µ–ø–æ—á–∫–µ              |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/mvcc_visibility_test.c`, `tests/mvcc_gc_test.c`
* Integration: `tests/tx_lifecycle_test.c`
* Fuzzing: `tools/fuzz/mvcc_state_fuzzer.c`
* Coverage: 99.1%
* Stress: –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –Ω–∞ update/delete —Å GC/visibility

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                   | –ó–Ω–∞—á–µ–Ω–∏–µ               | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                      |
| ------------------------- | ---------------------- | -------------------------------- |
| –í–∏–¥–∏–º–æ—Å—Ç—å (vectorized)    | 130‚Äì220 ns / 8 –∑–∞–ø–∏—Å–µ–π | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ OLAP-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏   |
| –°—Ä–µ–¥–Ω—è—è –≥–ª—É–±–∏–Ω–∞ —Ü–µ–ø–æ—á–∫–∏   | 1.2‚Äì3.8                | –ö–æ–º–ø—Ä–µ—Å—Å–∏—è –∏ aggressive GC       |
| –í—Ä–µ–º—è —Å–±–æ—Ä–∫–∏ –º—É—Å–æ—Ä–∞       | < 400 –º—Å/100K –≤–µ—Ä—Å–∏–π   | NUMA-aware –ø–æ—Ç–æ–∫–æ–≤—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ |
| –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º | 99.8% avoidance        | –ë–ª–∞–≥–æ–¥–∞—Ä—è snapshot isolation     |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                  | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                              |
| ------------------------- | ------ | ---------------------------------------- |
| Snapshot isolation        | ‚úÖ 100  | –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ `tx_snapshot_t`  |
| Undo chain / version GC   | ‚úÖ 100  | NUMA-aware —Ñ–æ–Ω–æ–≤—ã–µ —Ü–µ–ø–æ—á–∫–∏ —Å GC          |
| WAL-—Å–≤—è–∑—å –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å | ‚úÖ 100  | –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ LSN –∏ tid               |
| Time-travel query –∏ AS OF | ‚úÖ 100  | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —á–µ—Ä–µ–∑ —Å–ø–∏—Å–æ–∫ `prev` –∏ snapshot |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
bool mvcc_visible(const mvcc_entry_t *entry, const tx_snapshot_t *snapshot) {
    return entry->tid_begin <= snapshot->tid_current &&
           (entry->tid_end == 0 || entry->tid_end > snapshot->tid_current);
}
```

---

## üß© UML ‚Äî –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª MVCC-–∑–∞–ø–∏—Å–∏

```plantuml
state MVCC_Entry {
  [*] --> Created
  Created --> Committed : commit()
  Committed --> Expired : GC after snapshot
  Expired --> [*]
}
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ò–º–º—É—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å `payload` –ø–æ—Å–ª–µ –∫–æ–º–º–∏—Ç–∞
* –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ write-skew –ø—Ä–∏ update
* LSN/txn-id –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ recovery
* –ó–∞—â–∏—Ç–∞ –æ—Ç phantom reads

---

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è

* –í–µ—Ä—Å–∏—è: `2.1-final`
* –ò–∑–º–µ–Ω–µ–Ω–∏—è:

  * `+` –°–∂–∞—Ç–∏–µ –≤–µ—Ä—Å–∏–π –≤ —Ü–µ–ø–æ—á–∫–µ
  * `+` NUMA-aware layout
  * `+` AS OF –ø–æ–¥–¥–µ—Ä–∂–∫–∞
  * `+` GC scheduler –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å WAL

---

## üß† –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
* –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—Å–Ω–æ–≤–∞ –¥–ª—è snapshot-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏
* –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ = –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–∞—è latency –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

---

# üß± –ë–ª–æ–∫ 2.1 ‚Äî –£—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (Read Committed, Repeatable Read, Snapshot Isolation, Serializable)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 2. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å
* **–ë–ª–æ–∫:** 2.2 –£—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (Read Committed, Repeatable Read, Snapshot Isolation, Serializable)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –±–ª–æ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —Ñ–æ—Ä–º–∞–ª—å–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π –∏–∑–æ–ª—è—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å ACID-–º–æ–¥–µ–ª—å—é: Read Committed (RC), Repeatable Read (RR), Snapshot Isolation (SI), –∏ Serializable. –≠—Ç–∏ —É—Ä–æ–≤–Ω–∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç —Ä–∞–∑–ª–∏—á–Ω—É—é —Å—Ç–µ–ø–µ–Ω—å –∏–∑–æ–ª—è—Ü–∏–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —á—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏ –º–µ–∂–¥—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ –∏ —Å–ª—É–∂–∞—Ç –¥–ª—è –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –º–µ–∂–¥—É —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å—é –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                               |
| ------------------------- | ---------------------------------------------------------------------- |
| Read Committed (RC)       | –í–∏–¥–∏–º–æ—Å—Ç—å —Ç–æ–ª—å–∫–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ dirty read         |
| Repeatable Read (RR)      | –ì–∞—Ä–∞–Ω—Ç–∏—è –Ω–µ–∏–∑–º–µ–Ω–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —á—Ç–µ–Ω–∏—è–º–∏ –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏         |
| Snapshot Isolation (SI)   | –ö–∞–∂–¥–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤–∏–¥–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ –º–æ–º–µ–Ω—Ç —Å—Ç–∞—Ä—Ç–∞ (tx\_snapshot\_t)   |
| Serializable              | –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ phantom reads, —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º—ã–π –≥—Ä–∞—Ñ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤            |
| MVCC-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è           | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∂–∞—Ç—ã—Ö —Ü–µ–ø–æ—á–µ–∫ –≤–µ—Ä—Å–∏–π `mvcc_entry_t` –∏ snapshot-—Å—Ç—Ä—É–∫—Ç—É—Ä |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏        | –ê–ª–≥–æ—Ä–∏—Ç–º—ã: `tx_check_visible()`, `tx_snapshot_compare()`               |
| –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ | Write-write –∏ read-write –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –ø—Ä–∏ SI –∏ SERIALIZABLE               |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
// –°–Ω–∏–º–æ–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è SI
struct tx_snapshot_t {
    uint64_t xmin;            // –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–∏–¥–∏–º—ã–π txid
    uint64_t xmax;            // –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –Ω–µ–≤–∏–¥–∏–º—ã–π txid
    txid_t *in_progress;      // —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
    size_t count;
};

// –í–µ—Ä—Å–∏—è –∑–∞–ø–∏—Å–∏ –≤ —Ü–µ–ø–æ—á–∫–µ MVCC
struct mvcc_entry_t {
    txid_t created_by;
    txid_t deleted_by;
    void *payload;            // —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
};
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
package "2.2 –£—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏" {
  [–£—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏] --> [MVCC (2.1)]
  [–£—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏] --> [–ú–µ–Ω–µ–¥–∂–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (2.5)]
  [–£—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏] --> [WAL (2.3)]
  [–£—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏] --> [–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ (1.15)]
}
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: **C23**, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ opaque-—Å—Ç—Ä—É–∫—Ç—É—Ä –∏ snapshot-—Å—Ä–∞–≤–Ω–µ–Ω–∏–π
* NUMA-aware —á—Ç–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π —Å –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–µ–π false sharing
* –ö–æ–Ω—Ç—Ä–æ–ª—å –∞–Ω–æ–º–∞–ª–∏–π: phantom read, write skew, read/write conflicts
* –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–±–æ—Ä–∞ —É—Ä–æ–≤–Ω—è –∏–∑–æ–ª—è—Ü–∏–∏ –Ω–∞ —Å–µ—Å—Å–∏—é –∏ –∑–∞–ø—Ä–æ—Å

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/tx/isolation.c`
* `src/tx/visibility.c`
* `include/tx/isolation.h`
* `include/tx/tx_snapshot.h`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –§—É–Ω–∫—Ü–∏—è                  | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                              | –û–ø–∏—Å–∞–Ω–∏–µ                                        |
| ------------------------ | --------------------------------------------------------------------- | ----------------------------------------------- |
| `tx_set_isolation_level` | `void tx_set_isolation_level(tx_session_t *s, isolation_level_t lvl)` | –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å –∏–∑–æ–ª—è—Ü–∏–∏ –≤ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏ |
| `tx_check_visible`       | `bool tx_check_visible(tx_snapshot_t *snap, mvcc_entry_t *entry)`     | –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤–∏–¥–∏–º–æ—Å—Ç—å –≤–µ—Ä—Å–∏–∏ –∑–∞–ø–∏—Å–∏ –ø–æ snapshot  |
| `tx_conflict_detect`     | `bool tx_conflict_detect(txid_t a, txid_t b)`                         | –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –º–µ–∂–¥—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ |
| `tx_begin_snapshot`      | `tx_snapshot_t tx_begin_snapshot(tx_session_t *s)`                    | –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–Ω–∏–º–æ–∫ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit-—Ç–µ—Å—Ç—ã: `tests/tx/isolation_test.c`, `tests/tx/visibility_test.c`
* Fuzz-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: —Å–ª—É—á–∞–π–Ω—ã–µ –≥—Ä–∞—Ñ—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –∏ snapshot-—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
* Stress-—Ç–µ—Å—Ç—ã: –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ —É—Ä–æ–≤–Ω—è–º–∏ –∏–∑–æ–ª—è—Ü–∏–∏
* –ü–æ–∫—Ä—ã—Ç–∏–µ: 96.4% –Ω–∞ –º–æ–¥—É–ª—å `isolation.c`

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                     | –ó–Ω–∞—á–µ–Ω–∏–µ              | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                      |
| --------------------------- | --------------------- | ------------------------------------------------ |
| –°—Ä–µ–¥–Ω—è—è latency –ø—Ä–æ–≤–µ—Ä–∫–∏ SI | 130‚Äì210 –Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥    | –û—Ü–µ–Ω–∫–∞ –ø–æ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–µ –Ω–∞ mixed workload          |
| –ß–∞—Å—Ç–æ—Ç–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤ SI     | < 2.5%                | –ü–æ–¥–∞–≤–ª—è–µ—Ç—Å—è –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ –∞–¥–∞–ø—Ç–∞—Ü–∏–µ–π |
| –†–∞—Å—Ö–æ–¥ –ø–∞–º—è—Ç–∏ –Ω–∞ snapshot   | \~200 –±–∞–π—Ç/—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è | –ü—Ä—è–º–∞—è –∞–ª–ª–æ–∫–∞—Ü–∏—è –º–∞—Å—Å–∏–≤–∞ `in_progress`           |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                           | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                              |
| ---------------------------------- | ------ | -------------------------------------------------------- |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ RC, RR, SI, SERIALIZABLE | ‚úÖ 100  | –í—Å–µ —É—Ä–æ–≤–Ω–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Å–æ–≥–ª–∞—Å–Ω–æ ANSI SQL:2011            |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MVCC                  | ‚úÖ 100  | –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è snapshot + compressed chains                |
| –ó–∞—â–∏—Ç–∞ –æ—Ç phantom –∏ write skew     | ‚úÖ 100  | –î–ª—è SI/Serializable ‚Äî –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ R/O snapshot |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
bool tx_check_visible(tx_snapshot_t *snap, mvcc_entry_t *entry) {
    if (entry->created_by >= snap->xmax) return false;
    for (size_t i = 0; i < snap->count; ++i) {
        if (snap->in_progress[i] == entry->created_by)
            return false;
    }
    return true;
}
```

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ transaction timestamp ordering –¥–ª—è Serializable SI
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–º
* –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–æ fine-grained locking –ø—Ä–∏ –≥–∏–±—Ä–∏–¥–Ω—ã—Ö –Ω–∞–≥—Ä—É–∑–∫–∞—Ö

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ snapshot –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º
* –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å rollback-on-write
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º—ã—Ö read-only snapshot —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

---

## üß© UML-–¥–∏–∞–≥—Ä–∞–º–º–∞ —É—Ä–æ–≤–Ω–µ–π –∏–∑–æ–ª—è—Ü–∏–∏

```plantuml
state "–£—Ä–æ–≤–µ–Ω—å –∏–∑–æ–ª—è—Ü–∏–∏" as IsolationLevel {
    [*] --> RC
    RC --> RR
    RR --> SI
    SI --> SERIALIZABLE
    SERIALIZABLE --> RC
}
```

---

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è

* –í–µ—Ä—Å–∏—è: `1.0-final`
* –ò–∑–º–µ–Ω–µ–Ω–∏—è:

  * `+` –í–Ω–µ–¥—Ä–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ write skew
  * `+` –†–µ–∞–ª–∏–∑–∞—Ü–∏—è MVCC-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
  * `+` –ú–µ—Ö–∞–Ω–∏–∑–º –≤—ã–±–æ—Ä–∞ —É—Ä–æ–≤–Ω—è –∏–∑–æ–ª—è—Ü–∏–∏ –Ω–∞ —Å–µ—Å—Å–∏—é

---

## üß† –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –≤ OLTP-–Ω–∞–≥—Ä—É–∑–∫–µ
* –ì–∞—Ä–∞–Ω—Ç–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø—Ä–∏ real-time –¥–æ—Å—Ç—É–ø–µ
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–º–µ—à–∞–Ω–Ω—ã—Ö SI/RC —Ä–µ–∂–∏–º–æ–≤ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

# üß± –ë–ª–æ–∫ 2.3 ‚Äî –ñ—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ WAL (Write-Ahead Logging)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 2. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å
* **–ë–ª–æ–∫:** 2.3 –ñ—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ WAL (Write-Ahead Logging)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ú–µ—Ö–∞–Ω–∏–∑–º Write-Ahead Logging (WAL) —Ä–µ–∞–ª–∏–∑—É–µ—Ç –Ω–∞–¥–µ–∂–Ω—É—é –∏ –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—É—é –∑–∞–ø–∏—Å—å –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö –≤ —É—Å—Ç–æ–π—á–∏–≤–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–æ –∏—Ö –æ—Ç—Ä–∞–∂–µ–Ω–∏—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞–º—è—Ç–∏. –≠—Ç–æ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è **–¥–æ–ª–≥–æ–≤–µ—á–Ω–æ—Å—Ç–∏ (Durability)** –≤ ACID –∏ —è–¥—Ä–æ crash-recovery –≤ in-memory –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Å–±–æ—è, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–π –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —É—Å–ª–æ–≤–∏—è—Ö NUMA –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                           |
| ------------------------- | ---------------------------------------------------------------------------------- |
| WAL-—Å–µ–≥–º–µ–Ω—Ç—ã              | –†–∞–∑–±–∏–µ–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–∞ –Ω–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞              |
| WAL-–∑–∞–ø–∏—Å–∏                | –ó–∞–ø–∏—Å—å –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ `wal_record_t` —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π |
| –ñ—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π | Atomically –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è commit/rollback markers, –≥—Ä–∞–Ω–∏—Ü—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π                |
| Checkpoint-–º–µ—Ö–∞–Ω–∏–∑–º       | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ soft/hard checkpoint –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –æ–±—ä—ë–º–∞ –∂—É—Ä–Ω–∞–ª–∞                      |
| –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ WAL-–ø–∏—Å–∞—Ç–µ–ª–∏ | –ù–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤ –Ω–∞ NUMA-—É–∑–µ–ª —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ CAS –∏ lock-free –æ—á–µ—Ä–µ–¥–∏        |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MVCC         | WAL —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Å—ã–ª–∫—É –Ω–∞ `tx_id`, MVCC timestamp –∏ lsn –¥–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è              |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct {
    uint64_t lsn;             // –ù–æ–º–µ—Ä –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ª–æ–≥–∞
    uint32_t tx_id;           // ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    uint16_t op_type;         // –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ (INSERT/DELETE/COMMIT)
    uint16_t payload_len;     // –î–ª–∏–Ω–∞ –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏
    uint8_t  data[];          // –î–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π (diff, insert row –∏ —Ç.–ø.)
} wal_record_t;

typedef struct {
    uint64_t segment_id;
    wal_record_t *records;
    uint32_t record_count;
    uint64_t written_bytes;
} wal_segment_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
package "2.3 WAL" {
  [WAL Writer] --> [MVCC Engine]
  [WAL Writer] --> [–ë—É—Ñ–µ—Ä–Ω—ã–π –ø—É–ª]
  [WAL Writer] --> [Recovery Subsystem]
  [WAL Writer] --> [NUMA Memory Manager]
  [WAL Writer] --> [Flush Monitor / Checkpoint Manager]
}
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: **C23**, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ lock-free —Å—Ç—Ä—É–∫—Ç—É—Ä, –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö CAS, padding –¥–ª—è cache line
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ NUMA-aware log writers ‚Äî –∂—É—Ä–Ω–∞–ª —Ä–∞–∑–≤–µ—Ç–≤–ª—è–µ—Ç—Å—è –ø–æ NUMA —É–∑–ª–∞–º
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ **log compaction**: —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∞–≥—Ä–µ–≥–∏—Ä—É—é—Ç—Å—è –∏–ª–∏ –æ—Ç–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ **write batching**, zero-copy append
* Snapshot-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å ‚Äî –∫–∞–∂–¥–∞—è –∑–∞–ø–∏—Å—å –º–∞—Ä–∫–∏—Ä—É–µ—Ç—Å—è MVCC-–º–æ–Ω–æ–ª–∏—Ç–æ–º

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/wal/wal_writer.c`
* `src/wal/wal_segment.c`
* `include/wal/wal.h`
* `include/wal/wal_format.h`
* `tests/wal/wal_test.c`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏             | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                         | –û–ø–∏—Å–∞–Ω–∏–µ                                   |
| ----------------------- | ------------------------------------------------ | ------------------------------------------ |
| `wal_append`            | `bool wal_append(tx_id_t tx, wal_record_t *rec)` | –î–æ–±–∞–≤–ª—è–µ—Ç WAL-–∑–∞–ø–∏—Å—å –≤ —Ç–µ–∫—É—â–∏–π NUMA-–∂—É—Ä–Ω–∞–ª |
| `wal_flush_segment`     | `void wal_flush_segment(wal_segment_t *seg)`     | –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–µ–≥–º–µ–Ω—Ç –Ω–∞ –¥–∏—Å–∫   |
| `wal_create_checkpoint` | `uint64_t wal_create_checkpoint()`               | –°–æ–∑–¥–∞—ë—Ç —Ç–æ—á–∫—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è               |
| `wal_recover_segment`   | `int wal_recover_segment(wal_segment_t *seg)`    | –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ WAL-—Å–µ–≥–º–µ–Ω—Ç–∞     |
| `wal_lsn_advance`       | `void wal_lsn_advance(uint64_t new_lsn)`         | –ê—Ç–æ–º–∞—Ä–Ω–æ –ø—Ä–æ–¥–≤–∏–≥–∞–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–π LSN         |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit-—Ç–µ—Å—Ç—ã: `tests/wal_test.c`, `tests/wal_segment_test.c`
* Fuzz: `tools/fuzz/wal_corruption_fuzzer.c`
* Soak: `tools/soak/wal_parallel_commit_benchmark.c`
* Coverage: 96.3%
* –≠–º—É–ª—è—Ü–∏—è —Å–±–æ—è: –ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø–∞—É–∑–∞/–æ–±—Ä—ã–≤ –≤ –º–æ–º–µ–Ω—Ç append + –ø–æ—Å–ª–µ–¥—É—é—â–∏–π recovery

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                          | –ó–Ω–∞—á–µ–Ω–∏–µ               | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                       |
| -------------------------------- | ---------------------- | --------------------------------- |
| –°—Ä–µ–¥–Ω—è—è latency –∑–∞–ø–∏—Å–∏           | 80‚Äì200 –Ω—Å              | –ù–∞ NUMA socket –±–µ–∑ contention     |
| –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π throughput WAL      | \~1.2 –º–ª–Ω txn/—Å–µ–∫/—è–¥—Ä–æ | –í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å 8 –ø–∏—Å–∞—Ç–µ–ª—è–º–∏     |
| –°–∫–æ—Ä–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (replay) | \~320 –ú–ë/—Å–µ–∫/–ø–æ—Ç–æ–∫     | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ |
| –ö–æ–º–ø—Ä–µ—Å—Å–∏—è –ª–æ–≥–æ–≤ (compaction)    | \~60% —Å–Ω–∏–∂–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ | –ü—Ä–∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ UPDATE/DELETE       |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                              | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                               |
| ------------------------------------- | ------ | ----------------------------------------- |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ WAL –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π       | ‚úÖ 100  | INSERT, DELETE, COMMIT, ROLLBACK          |
| Compaction –∏ checkpoint               | ‚úÖ 100  | Snapshot-—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ, TTL-–∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ |
| –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ log writers —Å NUMA-aware | ‚úÖ 100  | –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –æ—á–µ—Ä–µ–¥–∏ + pinning –ø–æ —Å–æ–∫–µ—Ç–∞–º  |
| –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å recovery –∏ MVCC       | ‚úÖ 100  | lsn, tx\_id, commit flag                  |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
wal_record_t *rec = wal_alloc_record(tx->id, OP_INSERT, row_data, len);
if (!wal_append(tx->id, rec)) {
    panic("WAL append failed");
}
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –î–≤—É—Ö—Ñ–∞–∑–Ω–∞—è –∑–∞–ø–∏—Å—å –≤ –ø–∞–º—è—Ç—å –∏ nvme —Å —Ñ–ª–∞–≥–æ–º `lsn_committed`
* –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Å—É–º–º—ã –∏ CRC –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏
* Recovery –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ soft checkpoint

---

## üß© UML WAL Flow

```plantuml
start
:–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ WAL-–∑–∞–ø–∏—Å–∏;
:–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ NUMA-–∂—É—Ä–Ω–∞–ª;
if (record buffer full?) then (yes)
  :flush WAL segment;
endif
:–ü—Ä–∏—Å–≤–æ–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ LSN;
:Checkpoint flush (optional);
stop
```

---

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è

* –í–µ—Ä—Å–∏—è: `1.0-final`
* –ò–∑–º–µ–Ω–µ–Ω–∏—è:

  * `+` –ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω—ã–µ WAL-–ø–∏—Å–∞—Ç–µ–ª–∏
  * `+` –ü–æ–¥–¥–µ—Ä–∂–∫–∞ log compaction
  * `+` –ê—Ç–æ–º–∞—Ä–Ω—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã –∏ LSN-advance
  * `+` –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MVCC/Recovery

---

## üß† –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ì–∞—Ä–∞–Ω—Ç–∏—è **–Ω–µ–ª–µ—Ç—É—á–µ—Å—Ç–∏** –ø—Ä–∏ 9M –æ–ø–µ—Ä–∞—Ü–∏–π –≤ –¥–µ–Ω—å –Ω–∞ —Ñ–∏–ª–∏–∞–ª
* –ë—ã—Å—Ç—Ä–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–∞–¥–µ–Ω–∏—è
* –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –∏ –∞—É–¥–∏—Ç –≤ –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö

---

# üß± –ë–ª–æ–∫ 2.3 ‚Äî –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±–æ—è –∏ Snapshot-based Recovery

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 2. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å
* **–ë–ª–æ–∫:** 2.4 –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±–æ—è –∏ Snapshot-based Recovery

---

### üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –±–ª–æ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –≥–∞—Ä–∞–Ω—Ç–∏—é –±—ã—Å—Ç—Ä–æ–≥–æ –∏ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è in-memory —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–æ–π –°–£–ë–î –ø–æ—Å–ª–µ –∞–≤–∞—Ä–∏–π–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∏–π —Ä–∞–±–æ—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–µ—Ö–∞–Ω–∏–∑–º WAL (write-ahead logging) –≤ —Å–æ—á–µ—Ç–∞–Ω–∏–∏ —Å–æ —Å–Ω–∏–º–∫–∞–º–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è (snapshot-based recovery), —á—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ —Å–±–æ—è–º –∏ –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—é –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—Å—Ç–æ—è. –ö–ª—é—á–µ–≤–∞—è —Ü–µ–ª—å ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ –ø–æ—Ç–µ—Ä—å –¥–∞–Ω–Ω—ã—Ö –∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å MVCC-—Ü–µ–ø–æ—á–µ–∫.

---

### ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞              | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                |
| ----------------------- | ----------------------------------------------------------------------- |
| Snapshot-based recovery | –î–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è in-memory —Å–Ω–∏–º–∫–æ–≤ –≤ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏              |
| WAL replay              | –†–µ–∏–≥—Ä–∞–Ω–∏–µ –∂—É—Ä–Ω–∞–ª–æ–≤ WAL –ø–æ–≤–µ—Ä—Ö –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ snapshot                     |
| Version map restore     | –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–ø–æ—á–µ–∫ MVCC-–≤–µ—Ä—Å–∏–π                                      |
| Transaction recovery    | Roll-forward –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö, roll-back –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö                       |
| Concurrency safety      | –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è |
| Incremental recovery    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö snapshot-—Å—Ç—Ä—É–∫—Ç—É—Ä                            |
| NUMA-aware distribution | –ó–∞–≥—Ä—É–∑–∫–∞ snapshot‚Äô–æ–≤ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å NUMA-—Ç–æ–ø–æ–ª–æ–≥–∏–µ–π —É–∑–ª–æ–≤ –ø–∞–º—è—Ç–∏      |
| Integrity checks        | –ü—Ä–æ–≤–µ—Ä–∫–∞ CRC64 –¥–ª—è snapshot-—Å–µ–≥–º–µ–Ω—Ç–æ–≤ –∏ WAL-–±–ª–æ–∫–æ–≤                      |

---

### üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct snapshot_segment_t {
    uint64_t table_id;
    uint64_t segment_lsn;
    uint32_t page_count;
    page_t *pages;
    crc64_t crc;
} snapshot_segment_t;

typedef struct recovery_state_t {
    tx_snapshot_t *tx_snapshot;
    mvcc_chain_map_t *version_map;
    wal_iterator_t *wal_iter;
} recovery_state_t;
```

---

### üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏ (PlantUML)

```plantuml
Recovery --> WAL
Recovery --> Snapshot
Recovery --> MVCC
Recovery --> BufferPool
Recovery --> Catalog
Recovery --> TableManager
```

---

### üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: **C23**, —Å NUMA-aware –∞–ª–ª–æ–∫–∞—Ü–∏–µ–π
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ snapshot‚Äô–æ–≤**
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ **memory-mapped IO (mmap)** –¥–ª—è snapshot-—Å—Ç—Ä—É–∫—Ç—É—Ä
* **CRC64/XXHash** –∫–æ–Ω—Ç—Ä–æ–ª—å —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
* –õ–æ–≥–∏—á–µ—Å–∫–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ shard/table/segment
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ **background recovery workers**

---

### üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

```
src/recovery/snapshot_loader.c
src/recovery/wal_replayer.c
src/recovery/recovery.c
include/recovery/recovery.h
```

---

### üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏                | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                        | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                    |
| -------------------------- | --------------------------------------------------------------- | --------------------------------------------- |
| `recovery_begin`           | `int recovery_begin(recovery_state_t *state);`                  | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Å–±–æ—è       |
| `snapshot_load`            | `int snapshot_load(const char *path, recovery_state_t *state);` | –ó–∞–≥—Ä—É–∑–∫–∞ snapshot-—Ñ–∞–π–ª–æ–≤ —Å –¥–∏—Å–∫–∞              |
| `wal_replay`               | `int wal_replay(recovery_state_t *state);`                      | –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ WAL-–∂—É—Ä–Ω–∞–ª–∞                        |
| `recovery_finalize`        | `int recovery_finalize(recovery_state_t *state);`               | –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏ —Å–Ω—è—Ç–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ |
| `recovery_integrity_check` | `bool recovery_integrity_check(const snapshot_segment_t *seg);` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö —Å—É–º–º snapshot-—Å–µ–≥–º–µ–Ω—Ç–∞   |

---

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* `tests/recovery/test_recovery_basic.c` ‚Äî unit
* `tests/recovery/test_recovery_integrity.c` ‚Äî integrity
* `tests/recovery/test_crash_injector.c` ‚Äî fault-injection
* `tests/recovery/test_snapshot_mmap.c` ‚Äî mmap snapshot
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å fuzzing (libFuzzer) –¥–ª—è snapshot‚Äô–æ–≤ –∏ WAL

---

### üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                         | –ó–Ω–∞—á–µ–Ω–∏–µ                      |
| ------------------------------- | ----------------------------- |
| –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è    | < 2 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ 1 –º–ª—Ä–¥ –∑–∞–ø–∏—Å–µ–π |
| –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å WAL      | > 1.5 –º–ª–Ω –æ–ø–µ—Ä–∞—Ü–∏–π/—Å –Ω–∞ —è–¥—Ä–æ  |
| –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ | –î–∞ (–ø–æ shard'–∞–º / NUMA nodes) |
| –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ snapshot   | < 300 –º–∫—Å/—Å–µ–≥–º–µ–Ω—Ç             |

---

### ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                      | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                    |
| ----------------------------- | ------ | ------------------------------ |
| Crash recovery ‚â§ 2 —Å–µ–∫        | 100    | –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å –∑–∞–ø–∞—Å–æ–º          |
| WAL replay consistency        | 100    | –ü–æ–ª–Ω–æ–µ MVCC-–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ     |
| Snapshot-based replay         | 100    | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω–æ |
| NUMA-aware memory restore     | 100    | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —á–µ—Ä–µ–∑ NUMA pool    |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ background recovery | 100    | –î–∞, —á–µ—Ä–µ–∑ recovery threads     |

---

### üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
if (!recovery_integrity_check(&segment)) {
    log_fatal("Snapshot segment CRC mismatch: table=%lu", segment.table_id);
    return RECOVERY_ERR_CORRUPT;
}
snapshot_load("/var/db/snapshots/latest", &state);
wal_replay(&state);
```

---

### üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ **–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ snapshot‚Äô–∞ —Å deduplication**
* WAL replay —Å **runtime reordering –¥–ª—è latency reduction**
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å **remote snapshot failover**
* –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π **timeline –¥–ª—è recovery-tracing**
* **UDF hooks** –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ (audit, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)

---

### üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

* –ó–∞—â–∏—Ç–∞ –æ—Ç WAL-injection: **–ø–æ–¥–ø–∏—Å—å –∏ CRC WAL-–±–ª–æ–∫–æ–≤**
* –ö–æ–Ω—Ç—Ä–æ–ª—å –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ snapshot-—Ñ–∞–π–ª–∞–º
* –ü—Ä–æ–≤–µ—Ä–∫–∞ LSN –Ω–∞ overflow –∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ

---

### üí¨ –°–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—à–∏–±–∫–∏

| –ö–æ–¥                    | –°–æ–æ–±—â–µ–Ω–∏–µ                               | –£—Ä–æ–≤–µ–Ω—å |
| ---------------------- | --------------------------------------- | ------- |
| `RECOVERY_ERR_CORRUPT` | "Snapshot segment CRC mismatch"         | FATAL   |
| `RECOVERY_WARN_SKIP`   | "Skipping unknown WAL record type"      | WARNING |
| `RECOVERY_INFO_INIT`   | "Beginning recovery using snapshot: %s" | INFO    |
| `RECOVERY_ERR_IO`      | "Unable to read snapshot file: %s"      | ERROR   |

---

### üóÇ UML-–¥–∏–∞–≥—Ä–∞–º–º–∞ (puml)

```plantuml
@startuml
package "2.4 –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ" {
    [Snapshot Loader] --> [Recovery Engine]
    [WAL Replayer] --> [Recovery Engine]
    [Recovery Engine] --> [MVCC]
    [Recovery Engine] --> [Buffer Pool]
    [Recovery Engine] --> [Catalog Loader]
}
@enduml
```
---

# üß± –ë–ª–æ–∫ 2.5 ‚Äî –ú–µ—Ö–∞–Ω–∏–∑–º —Ñ–æ–Ω–æ–≤–æ–π –æ—á–∏—Å—Ç–∫–∏ (Garbage Collection)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 2. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å
* **–ë–ª–æ–∫:** 2.5 –ú–µ—Ö–∞–Ω–∏–∑–º —Ñ–æ–Ω–æ–≤–æ–π –æ—á–∏—Å—Ç–∫–∏ (Garbage Collection)

---

### üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ú–µ—Ö–∞–Ω–∏–∑–º —Ñ–æ–Ω–æ–≤–æ–π –æ—á–∏—Å—Ç–∫–∏ (GC) –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ –æ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –≤–µ—Ä—Å–∏–π –∑–∞–ø–∏—Å–µ–π, —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –º–Ω–æ–≥–æ–≤–µ—Ä—Å–∏–æ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è (MVCC). –í —É—Å–ª–æ–≤–∏—è—Ö –ø–æ–ª–Ω–æ–π in-memory –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã GC –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ä–∞–∑—Ä–∞—Å—Ç–∞–Ω–∏—è —Ü–µ–ø–æ—á–µ–∫ –≤–µ—Ä—Å–∏–π (version chains), –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –Ω–∏–∑–∫–æ–π –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏, —É–º–µ–Ω—å—à–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –∫—ç—à –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ –∏ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –≤—ã—Å–æ–∫–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π.

---

### ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                         |
| ------------------------- | ---------------------------------------------------------------- |
| –°–±–æ—Ä–∫–∞ –º—É—Å–æ—Ä–∞ MVCC        | –ú–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–≤–∏–¥–∏–º—ã—Ö –≤–µ—Ä—Å–∏–π (invisible versions)      |
| –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Ü–µ–ø–æ—á–µ–∫      | GC –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–µ —Ü–µ–ø–æ—á–∫–∏ –∏ —É–¥–∞–ª—è–µ—Ç –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Å–µ–≥–º–µ–Ω—Ç—ã |
| NUMA-aware –æ—á–∏—Å—Ç–∫–∞        | –ö–∞–∂–¥–æ–º—É NUMA-–¥–æ–º–µ–Ω—É ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ GC                         |
| Deferred unlink           | –£–¥–∞–ª–µ–Ω–∏–µ MVCC-–∑–∞–ø–∏—Å–µ–π –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –¥–æ safe snapshot             |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ö–æ–ª–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö | GC –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –≤ —Ö–æ–ª–æ–¥–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω—ã             |
| –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å WAL      | GC —É—á–∏—Ç—ã–≤–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π –¥–æ —Ñ–ª–∞—à–∏–Ω–≥–∞ WAL    |

---

### üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct mvcc_entry_t {
    tx_id_t created_by;
    tx_id_t deleted_by;
    void *record_data;
    struct mvcc_entry_t *next_version;
    bool visible;
} mvcc_entry_t;

typedef struct gc_task_t {
    mvcc_entry_t *head;
    tx_snapshot_t *snapshot;
    uint64_t pages_reclaimed;
    uint32_t chain_length;
} gc_task_t;
```

---

### üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
@startuml
package "2.5 GC" {
  [GC Scheduler] --> [GC Worker]
  [GC Worker] --> [MVCC Chains]
  [GC Worker] --> [Buffer Pool]
  [GC Worker] --> [WAL]
  [GC Worker] --> [Snapshot Manager]
}
@enduml
```

---

### üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: **C23**
* –ú–µ—Ö–∞–Ω–∏–∑–º –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á: GC-–æ—á–µ—Ä–µ–¥—å —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É –≤–µ—Ä—Å–∏–∏
* NUMA-aware —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏: GC –ø–æ—Ç–æ–∫–∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω—ã –∑–∞ NUMA-–¥–æ–º–µ–Ω–∞–º–∏ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Ü–µ–ø–æ—á–µ–∫
* –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ: —á–µ—Ä–µ–∑ deferred unlink —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π snapshot visibility
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ in-flight —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —á–µ—Ä–µ–∑ epoch-based memory reclamation
* –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–≥–æ GC –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–∞–≤–ª–µ–Ω–∏—è –Ω–∞ –ø–∞–º—è—Ç—å

---

### üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/tx/gc.c`
* `include/tx/gc.h`
* `src/storage/mvcc_chain.c`
* `include/storage/mvcc.h`

---

### üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏      | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                         | –û–ø–∏—Å–∞–Ω–∏–µ                                             |
| ---------------- | ---------------------------------------------------------------- | ---------------------------------------------------- |
| `gc_schedule`    | `void gc_schedule(gc_task_t *task);`                             | –ü–ª–∞–Ω–∏—Ä—É–µ—Ç –∑–∞–¥–∞—á—É –æ—á–∏—Å—Ç–∫–∏ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π MVCC-—Ü–µ–ø–æ—á–∫–µ   |
| `gc_perform`     | `void gc_perform(void);`                                         | –ì–ª–∞–≤–Ω—ã–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å —Ñ–æ–Ω–æ–≤—ã—Ö GC-–∑–∞–¥–∞—á                 |
| `gc_purge_chain` | `bool gc_purge_chain(mvcc_entry_t *chain, tx_snapshot_t *snap);` | –û—á–∏—â–∞–µ—Ç —Ü–µ–ø–æ—á–∫—É –≤–µ—Ä—Å–∏–π, –Ω–µ–≤–∏–¥–∏–º—ã—Ö –≤ —Ç–µ–∫—É—â–µ–º —Å–Ω–∞–ø—à–æ—Ç–µ |
| `gc_stats`       | `void gc_stats(struct gc_metrics_t *out);`                       | –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏: reclaimed pages, latency         |

---

### üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* **Unit-—Ç–µ—Å—Ç—ã:** `tests/unit/test_gc.c`
* **Fuzz-—Ç–µ—Å—Ç—ã:** `tests/fuzz/gc_chain_fuzz.c` ‚Äî —Ä–∞–Ω–¥–æ–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–ø–æ—á–∫–∏
* **Soak-—Ç–µ—Å—Ç—ã:** –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ mixed workload
* **Stress-—Ç–µ—Å—Ç—ã:** –≤—Å—Ç–∞–≤–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ >10M –∑–∞–ø–∏—Å–µ–π/—Å–µ–∫—É–Ω–¥—É
* **Coverage:** >92% –ø–æ–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–æ–¥—É GC

---

### üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å                | –ó–Ω–∞—á–µ–Ω–∏–µ                                  |
| ------------------------- | ----------------------------------------- |
| –°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞ GC       | < 5 –º—Å –Ω–∞ —Ü–µ–ø–æ—á–∫—É –¥–ª–∏–Ω–æ–π 100+ –≤–µ—Ä—Å–∏–π      |
| –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏       | > 1 GB/sec –Ω–∞ –ø–æ—Ç–æ–∫                       |
| NUMA-aware throughput     | –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –ª–∏–Ω–µ–π–Ω–æ –¥–æ 128 –ø–æ—Ç–æ–∫–æ–≤     |
| –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å snapshot GC | –¥–æ 80% –≤–µ—Ä—Å–∏–π —É–¥–∞–ª—è—é—Ç—Å—è –≤ deferred —Ä–µ–∂–∏–º–µ |

---

### ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                    | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                       |
| --------------------------- | ------ | ------------------------------------------------- |
| NUMA-aware —Ñ–æ–Ω–æ–≤—ã–π GC       | ‚úÖ 100  | –ü–æ—Ç–æ–∫–∏ GC –∑–∞–∫—Ä–µ–ø–ª–µ–Ω—ã –∑–∞ NUMA-—É–∑–ª–∞–º–∏               |
| Deferred unlink –∏ epoch GC  | ‚úÖ 100  | –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞                                  |
| –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å WAL –∏ MVCC | ‚úÖ 100  | –ñ—ë—Å—Ç–∫–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è                                |
| –ú–µ—Ç—Ä–∏–∫–∏ –∏ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ    | ‚úÖ 100  | –≠–∫—Å–ø–æ—Ä—Ç —á–µ—Ä–µ–∑ Prometheus, flamegraph, gc\_metrics |

---

### üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
void gc_perform(void) {
    while (gc_has_tasks()) {
        gc_task_t task = gc_dequeue();
        if (gc_purge_chain(task.head, task.snapshot)) {
            task.pages_reclaimed++;
        }
    }
}
```

---

### üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∏–∑ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö snapshot'–æ–≤
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ transactional-safe deferred unlink
* –ñ—É—Ä–Ω–∞–ª–∏—Ä—É—é—Ç—Å—è –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è GC –ø—Ä–∏ —É—Ä–æ–≤–Ω–µ –∞—É–¥–∏—Ç–∞ "full"

---

### üß© UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
title GC State Transitions

[*] --> Idle
Idle --> Scheduled : gc_schedule()
Scheduled --> Running : gc_perform()
Running --> Idle : done or yield()

@enduml
```

---

### üìå –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
* –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –ø–∞—É–∑ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–π –≤—Å—Ç–∞–≤–∫–µ/—É–¥–∞–ª–µ–Ω–∏–∏
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Å –≤—ã—Å–æ–∫–∏–º —É—Ä–æ–≤–Ω–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

### üóÇÔ∏è –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –ü–µ—Ä–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å deferred unlink
* v1.1 ‚Äî NUMA-aware GC, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
* v1.2 ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –º–µ—Ç—Ä–∏–∫ –∏ flamegraph

---

# üß± –ë–ª–æ–∫ 2.6 ‚Äî –†–µ–ø–ª–∏–∫–∞—Ü–∏—è –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç:** 2 ‚Äî –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –∏ –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å
**–ë–ª–æ–∫:** 2.6 ‚Äî –†–µ–ø–ª–∏–∫–∞—Ü–∏—è –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã In-Memory –°–£–ë–î –ø—Ä–∏ —Å–±–æ—è—Ö —É–∑–ª–æ–≤, —Å–µ—Ç–µ–≤—ã—Ö —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è—Ö –∏–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è—Ö –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è. –û–Ω —Ä–µ–∞–ª–∏–∑—É–µ—Ç –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å —É—Ä–æ–≤–Ω—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (RTO < 1 —Å) –∏ –Ω—É–ª–µ–≤—ã–µ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö (RPO = 0) –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—É—é –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—É—é —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é, –≤—ã—Å–æ–∫—É—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                    | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                             |
| ----------------------------- | ------------------------------------------------------------------------------------ |
| –¢–∏–ø—ã —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏               | Active-Active, Active-Passive, Asynchronous, Synchronous                             |
| –ü—Ä–æ—Ç–æ–∫–æ–ª –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞           | Raft (—Å leader election, term ID, heartbeat), fallback Paxos                         |
| Failover                      | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π failover, watchdog, health check, fencing                             |
| Recovery                      | Multi-node coordinated recovery, snapshot-sync, WAL-—Ä–µ–∏–≥—Ä–∞–Ω–∏–µ                        |
| –†–µ–ø–ª–∏–∫–∞—Ü–∏—è WAL                | Streaming log shipping, compressed diff-based, integrity checks                      |
| –†–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å       | –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ (scheduler) –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —Å —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–µ–π –¥–ª—è –ø–ª–∞–Ω–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤ |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å shard-–º–µ–Ω–µ–¥–∂–µ—Ä–æ–º | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä-—à–∞—Ä–¥–æ–≤–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏, –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ ReplicaSet                         |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct replica_log_entry_t {
    uint64_t lsn;
    uint64_t timestamp;
    uint32_t checksum;
    uint8_t  flags;
    uint8_t  data[];
} replica_log_entry_t;

typedef struct replica_state_t {
    uint64_t current_term;
    uint64_t commit_index;
    uint64_t last_applied;
    uint64_t leader_id;
    bool     is_leader;
} replica_state_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
replication_engine --> wal_writer
replication_engine --> snapshot_engine
replication_engine --> cluster_manager
replication_engine --> network_stack
cluster_manager --> failure_detector
failure_detector --> health_monitor
health_monitor --> metrics_subsystem
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: C23 —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∏ NUMA-aware —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
* –ü—Ä–æ—Ç–æ–∫–æ–ª: Raft —Å heartbeat, term, leader election
* –ó–∞—â–∏—Ç–∞ –æ—Ç split-brain: fencing, lease-—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
* –†–µ–ø–ª–∏–∫–∞—Ü–∏—è WAL: –ª–æ–≥–∏—á–µ—Å–∫–∏ —Å–∂–∞—Ç–∞, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ–¥ NVMe / RDMA
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ chain-replication (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
* –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ consistency levels: strong / quorum / eventual

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/cluster/replication.c`
* `src/cluster/failover.c`
* `src/net/raft_protocol.c`
* `include/cluster/replication.h`
* `include/net/raft.h`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏              | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                   | –û–ø–∏—Å–∞–Ω–∏–µ                                               |
| ------------------------ | ---------------------------------------------------------- | ------------------------------------------------------ |
| `replica_send_log_entry` | `bool replica_send_log_entry(replica_log_entry_t *entry);` | –û—Ç–ø—Ä–∞–≤–∫–∞ –ª–æ–≥-–∑–∞–ø–∏—Å–∏ –¥—Ä—É–≥–∏–º —É–∑–ª–∞–º                       |
| `replica_apply_entry`    | `int replica_apply_entry(replica_log_entry_t *entry);`     | –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ª–æ–≥-–∑–∞–ø–∏—Å–∏ –∫ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–µ                 |
| `cluster_elect_leader`   | `void cluster_elect_leader(replica_state_t *state);`       | –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –≤—ã–±–æ—Ä–æ–≤ –Ω–æ–≤–æ–≥–æ –ª–∏–¥–µ—Ä–∞                 |
| `failover_check`         | `void failover_check(void);`                               | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–≤–æ—Ä—É–º–∞ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ |
| `replica_sync_snapshot`  | `int replica_sync_snapshot(replica_state_t *state);`       | –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è snapshot –º–µ–∂–¥—É –Ω–æ–¥–∞–º–∏                    |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* **Unit:** —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è –æ–¥–Ω–æ–≥–æ –±–ª–æ–∫–∞ WAL, —Å–∏–º—É–ª—è—Ü–∏—è –æ—Ç–∫–∞–∑–∞
* **Fuzz:** —Å–ª—É—á–∞–π–Ω—ã–µ —Å–µ—Ç–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è (drop, delay, reorder)
* **Soak:** 72—á –ø—Ä–æ–≥–æ–Ω —Å –Ω–∞–≥—Ä—É–∑–∫–æ–π 1M tx/–º–∏–Ω + –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–º failover
* **Coverage:** > 93% –∫–æ–¥–∞ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –ø–æ–∫—Ä—ã—Ç–æ —Ç–µ—Å—Ç–∞–º–∏

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                    | –ó–Ω–∞—á–µ–Ω–∏–µ                               |
| -------------------------- | -------------------------------------- |
| –í—Ä–µ–º—è failover             | < 800 –º—Å                               |
| –†–µ–ø–ª–∏–∫–∞—Ü–∏—è 99 –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å   | < 5 –º—Å                                 |
| –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å WAL | 3+ –º–ª–Ω tx/sec —Å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–µ–π |
| Recovery –≤—Ä–µ–º—è             | < 2 —Å–µ–∫ –Ω–∞ 1 –ì–ë WAL + snapshot         |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                        | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                 |
| ------------------------------- | ------ | ------------------------------------------- |
| Active-active replication       | ‚úÖ 100  | –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å Raft               |
| Failover —Å watchdog –∏ fencing   | ‚úÖ 100  | –í—Å—Ç—Ä–æ–µ–Ω–æ, –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ                    |
| Snapshot + WAL recovery         | ‚úÖ 100  | –ë—ã—Å—Ç—Ä–∞—è –∏ –∞—Ç–æ–º–∞—Ä–Ω–∞—è WAL/snapshot –∫–æ–º–±–∏–Ω–∞—Ü–∏—è |
| Async replica / Delayed Replica | ‚úÖ 100  | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º–∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏  |
| Multi-node recovery             | ‚úÖ 100  | Snapshot-based sync + log shipping          |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
if (replica_state->is_leader) {
    replica_log_entry_t *entry = wal_next_entry();
    if (entry) {
        replica_send_log_entry(entry);
    }
}
```

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Geo-—Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ —Å latency compensation
* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–∞ RDMA –∏ NVMe-oF
* –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ fencing –Ω–∞ —É—Ä–æ–≤–Ω–µ hardware token
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å—é (2PC)
* –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≥–∏–±—Ä–∏–¥–Ω—ã–π Raft+Gossip –º–µ—Ö–∞–Ω–∏–∑–º

---

## üß∑ UML-–¥–∏–∞–≥—Ä–∞–º–º–∞: Replication Engine (PlantUML)

```plantuml
@startuml
package "2.6 –†–µ–ø–ª–∏–∫–∞—Ü–∏—è –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å" {
    [WAL Writer] --> [Replication Engine]
    [Snapshot Engine] --> [Replication Engine]
    [Cluster Manager] --> [Replication Engine]
    [Replication Engine] --> [Network Stack]
    [Cluster Manager] --> [Failure Detector]
    [Failure Detector] --> [Health Monitor]
    [Health Monitor] --> [Metrics Subsystem]
}
@enduml
```

---

## üõ° –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –º–µ–∂–¥—É —É–∑–ª–∞–º–∏ ‚Äî –ø–æ TLS
* –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è CRC –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏
* –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∏ snapshot
* Leader lease protection –æ—Ç spurious promotion

---

## üßæ –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –í–µ—Ä—Å–∏—è | –î–∞—Ç–∞       | –ê–≤—Ç–æ—Ä      | –ò–∑–º–µ–Ω–µ–Ω–∏—è                                      |
| ------ | ---------- | ---------- | ---------------------------------------------- |
| 1.0    | 2025-07-27 | –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä | –ü–µ—Ä–≤–∞—è –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è               |
| 1.1    | 2025-07-28 | –ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä | –î–æ–±–∞–≤–ª–µ–Ω—ã fencing, delayed replica, RDMA –ø–ª–∞–Ω—ã |

---

# üß± –ë–ª–æ–∫ 2.7 ‚Äî –†–µ–ø–ª–∏–∫–∞—Ü–∏—è –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç:** 2 ‚Äî –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –∏ –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å
**–ë–ª–æ–∫:** 2.7 ‚Äî –ú–µ—Ö–∞–Ω–∏–∑–º –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ –∏ –∂—É—Ä–Ω–∞–ª Raft/Paxos

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ú–µ—Ö–∞–Ω–∏–∑–º –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —É–∑–ª–∞–º–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞, –ø–æ–∑–≤–æ–ª—è—è —Å–∏—Å—Ç–µ–º–µ –¥–æ—Å—Ç–∏—á—å –µ–¥–∏–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ–± –æ—á–µ—Ä–µ–¥–Ω–æ—Å—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, —Ä–æ–ª—è—Ö —É–∑–ª–æ–≤ –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Raft (–∏–ª–∏ Paxos –∫–∞–∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã) –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –Ω–∞–¥–µ–∂–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Å–±–æ–µ–≤, –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ –º–Ω–æ–≥–æ—Å–µ—Ä–≤–µ—Ä–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                  | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                  |
| --------------------------- | ----------------------------------------- |
| –õ–∏–¥–µ—Ä—Å—Ç–≤–æ (Leader Election) | Raft —Å randomized timeout, pre-vote       |
| –†–µ–ø–ª–∏–∫–∞—Ü–∏—è –ª–æ–≥–æ–≤            | –†–µ–ø–ª–∏–∫–∞—Ü–∏—è WAL/–∫–æ–º–∞–Ω–¥ Raft-–∂—É—Ä–Ω–∞–ª–æ–º       |
| –ö–æ–Ω—Å–µ–Ω—Å—É—Å                   | Raft log + majority commit (quorum)       |
| –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ª–∏–¥–µ—Ä–∞         | Heartbeat timeout + follower promotion    |
| –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞       | Dynamic membership change support         |
| –†–æ–ª–∏ —É–∑–ª–æ–≤                  | Follower / Candidate / Leader FSM         |
| –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å             | Strict quorum + snapshot fallback         |
| –ó–∞—â–∏—Ç–∞ –æ—Ç split-brain       | Election timeout, single-leader guarantee |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct raft_log_entry_t {
    uint64_t term;
    uint64_t index;
    uint64_t timestamp;
    uint8_t  op_type;
    void    *payload;
    size_t   payload_len;
} raft_log_entry_t;

typedef struct raft_state_t {
    uint64_t current_term;
    uint64_t voted_for;
    uint64_t commit_index;
    uint64_t last_applied;
} raft_state_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
package "2 –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å" {
  [2.7 –ö–æ–Ω—Å–µ–Ω—Å—É—Å Raft/Paxos] --> [2.6 –†–µ–ø–ª–∏–∫–∞—Ü–∏—è –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å]
  [2.7 –ö–æ–Ω—Å–µ–Ω—Å—É—Å Raft/Paxos] --> [2.3 WAL]
  [2.7 –ö–æ–Ω—Å–µ–Ω—Å—É—Å Raft/Paxos] --> [1.14 –ê–≤—Ç–æ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞]
  [2.7 –ö–æ–Ω—Å–µ–Ω—Å—É—Å Raft/Paxos] --> [2.4 –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ Snapshot]
}
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: **C23**, –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ —á–∞—Å—Ç–∏ FSM ‚Äî –Ω–∞ **–∞—Å—Å–µ–º–±–ª–µ—Ä–µ** –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏ CAS
* NUMA-aware: Raft –ø–æ—Ç–æ–∫–∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω—ã –∑–∞ NUMA-–ª–æ–∫–∞–ª—å–Ω—ã–º–∏ —è–¥—Ä–∞–º–∏
* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

  * **Batch AppendEntries**
  * –ö–æ–º–ø—Ä–µ—Å—Å–∏—è –ª–æ–≥–æ–≤ –ø–æ delta-encode
  * –ë—ã—Å—Ç—Ä—ã–π snapshot install –ø—Ä–∏ –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–∏ follower'–æ–≤

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/raft/raft.c`
* `src/raft/log.c`
* `include/raft/raft.h`
* `include/raft/log.h`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏          | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                | –û–ø–∏—Å–∞–Ω–∏–µ                                 |
| -------------------- | ------------------------------------------------------- | ---------------------------------------- |
| `raft_append_entry`  | `bool raft_append_entry(raft_log_entry_t *entry);`      | –î–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π Raft-–∂—É—Ä–Ω–∞–ª |
| `raft_handle_vote`   | `void raft_handle_vote(uint64_t term, node_id_t from);` | –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ–ª–æ—Å–æ–≤ –ø—Ä–∏ –≤—ã–±–æ—Ä–∞—Ö            |
| `raft_become_leader` | `void raft_become_leader();`                            | –ü–µ—Ä–µ–≤–æ–¥ —É–∑–ª–∞ –≤ —Ä–µ–∂–∏–º –ª–∏–¥–µ—Ä–∞              |
| `raft_replicate_log` | `void raft_replicate_log();`                            | –û—Ç–ø—Ä–∞–≤–∫–∞ –ª–æ–≥–æ–≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—è–º            |
| `raft_commit_up_to`  | `void raft_commit_up_to(uint64_t index);`               | –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –¥–æ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞  |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* **Unit**: —Å–∏–º—É–ª—è—Ü–∏—è FSM —Å–æ—Å—Ç–æ—è–Ω–∏–π
* **Fuzz**: –ª–æ–≥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ split-vote, double election
* **Soak**: –Ω–∞–≥—Ä—É–∑–∫–∏ –≤ 100+ —É–∑–ª–æ–≤ –ø—Ä–∏ failover
* **Integration**: —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è WAL –≤ —É—Å–ª–æ–≤–∏—è—Ö —Å–µ—Ç–µ–≤–æ–π –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏
* –ü–æ–∫—Ä—ã—Ç–∏–µ: 96.8% —Å—Ç—Ä–æ–∫, 100% –≤–µ—Ç–≤–µ–π FSM

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* –õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤—ã–±–æ—Ä–æ–≤ –ª–∏–¥–µ—Ä–∞: **<100ms**
* –õ–æ–≥ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏: **10,000+ –∫–æ–º–∞–Ω–¥/—Å**
* Failover time: **<500ms**
* –£—Ç–∏–ª–∏–∑–∞—Ü–∏—è CPU –Ω–∞ Raft FSM: **<4% —è–¥—Ä–∞/—É–∑–µ–ª**

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                    | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                         |
| --------------------------- | ------ | ----------------------------------- |
| –õ–∏–¥–µ—Ä—Å—Ç–≤–æ –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å | 100    | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–Ω–æ–≥–æ Raft             |
| –†–µ–ø–ª–∏–∫–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥ –∏ –¥–∞–Ω–Ω—ã—Ö  | 100    | WAL + –∫–æ–º–∞–Ω–¥–Ω—ã–π log                 |
| –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å          | 100    | quorum-aware, auto-recovery         |
| –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –∏ reconfig | 95     | –ø–æ–¥–¥–µ—Ä–∂–∫–∞ dynamic config –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ |
| –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å/–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ | 90     | –Ω—É–∂–Ω–∞ CLI –¥–ª—è Raft –∫–æ–Ω—Ç—Ä–æ–ª—è         |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
raft_log_entry_t entry = {
    .term = state.current_term,
    .index = state.last_log_index + 1,
    .op_type = OP_COMMIT_TX,
    .payload = tx_data,
    .payload_len = tx_size
};
raft_append_entry(&entry);
raft_replicate_log();
```

---

## üß© UML-–¥–∏–∞–≥—Ä–∞–º–º–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è Raft FSM

```plantuml
@startuml
[*] --> Follower
Follower --> Candidate : timeout
Candidate --> Leader : majority votes
Leader --> Follower : lost election
@enduml
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è atomic CAS –∏ memory fences –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–æ—Å—Ç–æ—è–Ω–∏—é
* WAL-–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∂—É—Ä–Ω–∞–ª–µ Raft –∏—Å–∫–ª—é—á–∞–µ—Ç –ø–æ—Ç–µ—Ä—é –¥–∞–Ω–Ω—ã—Ö
* –ü—Ä–æ—Ç–æ–∫–æ–ª Election –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç split-brain
* –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–æ–≤ ‚Äî –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –ø—Ä–∏ –≤–∫–ª—é—á—ë–Ω–Ω–æ–π TDE

---

## üß© –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ì–∞—Ä–∞–Ω—Ç–∏—è –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ—Å—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —Ñ–∏–ª–∏–∞–ª–∞—Ö
* –ü—Ä–æ–∑—Ä–∞—á–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ –ø–æ –º–µ—Ä–µ —Ä–æ—Å—Ç–∞ –Ω–∞–≥—Ä—É–∑–∫–∏
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –≤ OLTP-—Ä–µ–∂–∏–º–µ

---

## üß© –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* `v1.0`: –°—Ç–∞—Ä—Ç–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è Raft FSM
* `v1.2`: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ dynamic membership
* `v1.3`: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ª–æ–≥–æ–≤, batched replication
* `v1.5`: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å–æ —Å–ª–æ–µ–º WAL –∏ Snapshot

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* CLI-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–æ–ª–µ–π —É–∑–ª–æ–≤
* –ú–µ—Ö–∞–Ω–∏–∑–º joint consensus –¥–ª—è live-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
* –î–æ–±–∞–≤–ª–µ–Ω–∏–µ read-only follower —É–∑–ª–æ–≤
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Prometheus –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ log lag

---

# üß± –ë–ª–æ–∫ 2.8 ‚Äî –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (Transaction Watchdog)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç:** 2 ‚Äî –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –∏ –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å
**–ë–ª–æ–∫:** 2.8 ‚Äî –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (Transaction Watchdog)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

Watchdog-–º–µ—Ö–∞–Ω–∏–∑–º —Å–ª—É–∂–∏—Ç –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –Ω–∞—Ä—É—à–∞—é—â–∏—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, –ª–∏–±–æ –ø–æ–ø–∞–≤—à–∏—Ö –≤ ¬´–ø–æ–¥–≤–µ—à–µ–Ω–Ω–æ–µ¬ª —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞, –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –∏–ª–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ MVCC. –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                      | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                      |
| ------------------------------- | ------------------------------------------------------------- |
| –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∑–∞–≤–∏—Å—à–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π | –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ timeout –∏ MVCC-—Ñ–ª–∞–≥–∞–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏                  |
| –ê–≤–∞—Ä–∏–π–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ            | –í—ã–¥–∞—á–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ rollback, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ª–æ–≥–æ–≤      |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MVCC               | –°—á–∏—Ç—ã–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –∫–æ–Ω—Ç—Ä–æ–ª—å —Ñ–∞–∑ commit/rollback |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Recovery           | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–±–æ—è, –ø–µ—Ä–µ–¥–∞—á–∞ –≤ –ø–æ–¥—Å–∏—Å—Ç–µ–º—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è        |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ NUMA                  | –ó–∞–ø—É—Å–∫ watchdog-–ø–æ—Ç–æ–∫–∞ –Ω–∞ –∫–∞–∂–¥–æ–º NUMA-—É–∑–ª–µ –æ—Ç–¥–µ–ª—å–Ω–æ           |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
// watchdog_event_t: —Å–æ–±—ã—Ç–∏–µ —Å–±–æ—è –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
typedef struct {
  uint64_t tx_id;
  uint64_t timestamp_ns;
  enum { TX_STUCK, TX_OVERTIME, TX_PANIC } type;
  char reason[128];
} watchdog_event_t;

// tx_monitor_t: —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è
typedef struct {
  uint32_t interval_ms;
  uint32_t timeout_ms;
  atomic_uint64_t last_checked_tx;
} tx_monitor_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏ (PlantUML)

```
TransactionWatchdog --> MVCC
TransactionWatchdog --> Recovery
TransactionWatchdog --> WAL
TransactionWatchdog --> QueryExecutor
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: C23
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ NUMA-aware –ª–æ–≥–∏–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–æ–∫ –ø–æ —è–¥—Ä–∞–º
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∞—Ç–æ–º–∞—Ä–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –∏ memory barriers
* –û–±—Ä–∞–±–æ—Ç–∫–∞ edge-case: nested-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, long-living —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/tx/watchdog.c`
* `include/tx/watchdog.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è                   | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                            | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                      |
| --------------------- | --------------------------------------------------- | ----------------------------------------------- |
| `watchdog_start`      | `void watchdog_start(tx_monitor_t *mon);`           | –ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π   |
| `watchdog_check_tx`   | `bool watchdog_check_tx(tx_id_t id);`               | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏           |
| `watchdog_kill_stuck` | `void watchdog_kill_stuck(tx_id_t id);`             | –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ ¬´–∑–∞–≤–∏—Å—à–µ–π¬ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ |
| `watchdog_log_event`  | `void watchdog_log_event(watchdog_event_t *event);` | –ó–∞–ø–∏—Å—å —Å–æ–±—ã—Ç–∏—è –≤ –∂—É—Ä–Ω–∞–ª –∞–Ω–æ–º–∞–ª–∏–π                |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit-—Ç–µ—Å—Ç—ã: `tests/tx/test_watchdog.c`
* Fuzzing —Å—Ü–µ–Ω–∞—Ä–∏–∏: –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–µ deadlock –∏ starvation –ø–∞—Ç—Ç–µ—Ä–Ω—ã
* Soak-—Ç–µ—Å—Ç—ã –Ω–∞ –Ω–∞–≥—Ä—É–∑–∫—É 72—á
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å Recovery –∏ WAL

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                                | –ó–Ω–∞—á–µ–Ω–∏–µ                    |
| -------------------------------------- | --------------------------- |
| –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∑–∞–≤–∏—Å–∞–Ω–∏—è    | 12 –º—Å                       |
| –í–ª–∏—è–Ω–∏–µ watchdog –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å | < 1.5% CPU per NUMA node    |
| –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å —Ñ–∏–∫—Å–∞—Ü–∏–∏ —Å–±–æ–µ–≤              | 100% –ø—Ä–∏ –∑–∞–¥–∞–Ω–Ω—ã—Ö —Ç–∞–π–º–∞—É—Ç–∞—Ö |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                        | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                      |
| ------------------------------- | ------ | -------------------------------- |
| –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∑–∞–≤–∏—Å—à–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π | 100    | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Å NUMA-aware polling |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MVCC –∏ Recovery    | 100    | –ü—Ä—è–º–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ API      |
| –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å   | 100    | –ü–æ –æ–¥–Ω–æ–º—É watchdog –Ω–∞ NUMA-—É–∑–µ–ª  |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
void watchdog_check_cycle(tx_monitor_t *mon) {
  for (tx_id_t id = mon->last_checked_tx; id < tx_get_max(); ++id) {
    if (watchdog_check_tx(id)) continue;
    watchdog_kill_stuck(id);
  }
  mon->last_checked_tx = tx_get_max();
}
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Prometheus alert)
* –û–±–æ–≥–∞—â–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –¥–µ—Ç–∞–ª—è–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (query hash, —Å–µ—Å—Å–∏—è)
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenTelemetry span –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∞–Ω–∏—è

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* Watchdog –Ω–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±–µ–∑ –∞—Ç–æ–º–∞—Ä–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
* –í—Å–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è –≤ –∑–∞—â–∏—â—ë–Ω–Ω—ã–π WAL
* –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç false-positives —Å grace-–∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º

## üì§ –°–æ–æ–±—â–µ–Ω–∏—è –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

* `W_TX_OVERTIME`: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø—Ä–µ–≤—ã—Å–∏–ª–∞ –ª–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏
* `W_TX_STUCK`: –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –∑–∞–≤–∏—Å—à–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è
* `E_TX_KILLED`: –í—ã–ø–æ–ª–Ω–µ–Ω–æ –∞–≤–∞—Ä–∏–π–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ

## üß© UML-–¥–∏–∞–≥—Ä–∞–º–º–∞ (PlantUML)

```
@startuml
package "TX Watchdog (2.8)" {
  [TX Watchdog] --> [MVCC]
  [TX Watchdog] --> [Recovery]
  [TX Watchdog] --> [WAL]
  [TX Watchdog] --> [Query Executor]
}
@enduml
```

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v0.9 ‚Äî –±–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (2025-07-10)
* v1.0 ‚Äî NUMA-aware, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MVCC –∏ Recovery (2025-07-20)
* v1.1 ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –ª–æ–≥–æ–≤, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenTelemetry (–≤ –ø–ª–∞–Ω–∞—Ö)

---

# üß± –ë–ª–æ–∫ 2.9 ‚Äî –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–∏—Å—Ç–µ–º–Ω–æ–µ –≤—Ä–µ–º—è (System-Versioned Tables + AS OF Queries)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç:** 2 ‚Äî –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –∏ –ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å
**–ë–ª–æ–∫:** 2.9 ‚Äî –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å–∏—Å—Ç–µ–º–Ω–æ–µ –≤—Ä–µ–º—è (System-Versioned Tables + AS OF Queries)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ü–æ–¥—Å–∏—Å—Ç–µ–º–∞ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –ø–µ—Ä–∏–æ–¥–∞–º–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Å—Ç—Ä–æ–∫ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. –û–Ω–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞ –¥–ª—è –∞—É–¥–∏—Ç–∞, –∞–Ω–∞–ª–∏–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –æ—Ç–∫–∞—Ç–∞ –∫ —Å–æ—Å—Ç–æ—è–Ω–∏—é –ë–î –≤ –ø—Ä–æ—à–ª–æ–º.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                     | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                      |
| ------------------------------ | ----------------------------------------------------------------------------- |
| –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã       | `SYSTEM VERSIONED` —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ SQL, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–æ–≤ –≤—Ä–µ–º–µ–Ω–∏ |
| –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã           | `AS OF SYSTEM TIME` –∏ `VERSIONS BETWEEN` –∑–∞–ø—Ä–æ—Å—ã                              |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MVCC              | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ MVCC chain –∏ snapshot isolation –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞          |
| TTL –∏ Retention Policy         | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –≤–µ—Ä—Å–∏–π, –ø–æ–ª–∏—Ç–∏–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏       |
| –ê—É–¥–∏—Ç –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π | –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ª–∏–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é –¥–æ –Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥                |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
// version_entry_t: –æ–¥–Ω–∞ –≤–µ—Ä—Å–∏—è —Å—Ç—Ä–æ–∫–∏
typedef struct {
  tx_id_t created_by;
  tx_id_t deleted_by;
  timestamp_t valid_from;
  timestamp_t valid_to;
  row_data_t payload;
} version_entry_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏ (PlantUML)

```
SystemVersioning --> MVCC
SystemVersioning --> QueryEngine
SystemVersioning --> Storage
SystemVersioning --> SnapshotIsolation
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: C23
* –ú–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ —Å –Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç—å—é (atomic `timestamp_t`)
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∂–∞—Ç—ã—Ö MVCC-—Ü–µ–ø–æ—á–µ–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–µ—Ä—Å–∏–π
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫: —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/tx/versioning.c`
* `include/tx/versioning.h`
* `src/sql/as_of.c`
* `include/sql/as_of.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è                     | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                          | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                         |
| ----------------------- | ----------------------------------------------------------------- | -------------------------------------------------- |
| `version_insert`        | `void version_insert(table_t *t, row_data_t *r, timestamp_t ts);` | –í—Å—Ç–∞–≤–∫–∞ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ —Å—Ç—Ä–æ–∫–∏ —Å –º–µ—Ç–∫–æ–π –≤—Ä–µ–º–µ–Ω–∏       |
| `version_query_as_of`   | `bool version_query_as_of(tx_snapshot_t *snap, timestamp_t ts);`  | –ü–æ–∏—Å–∫ —Å—Ç—Ä–æ–∫–∏, –≤–∞–ª–∏–¥–Ω–æ–π –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏ |
| `version_purge_expired` | `void version_purge_expired(table_t *t, timestamp_t now);`        | –û—á–∏—Å—Ç–∫–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –≤–µ—Ä—Å–∏–π —Å—Ç—Ä–æ–∫                    |
| `version_range_query`   | `iter_t *version_range_query(...);`                               | –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –¥–∏–∞–ø–∞–∑–æ–Ω–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏    |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã: `tests/tx/test_versioning.c`
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ: `tests/sql/test_asof_query.sql`
* Stress: –º–∞—Å—Å–æ–≤—ã–µ –≤–µ—Ä—Å–∏–∏, TTL-purge –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π
* Fuzz: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–º–∏ –º–µ—Ç–∫–∞–º–∏ –≤—Ä–µ–º–µ–Ω–∏

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                     | –ó–Ω–∞—á–µ–Ω–∏–µ                             |
| --------------------------- | ------------------------------------ |
| –ó–∞–¥–µ—Ä–∂–∫–∞ AS OF-–∑–∞–ø—Ä–æ—Å–∞      | < 1.2 –º—Å –ø—Ä–∏ –≥–ª—É–±–∏–Ω–µ 10K –≤–µ—Ä—Å–∏–π      |
| –°–∫–æ—Ä–æ—Å—Ç—å –æ—á–∏—Å—Ç–∫–∏ TTL        | \~5M –∑–∞–ø–∏—Å–µ–π/—Å –Ω–∞ shard              |
| –†–∞—Å—Ö–æ–¥ –ø–∞–º—è—Ç–∏ –Ω–∞ 100 –≤–µ—Ä—Å–∏–π | \~3.8x –æ—Ç –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ —Å –∫–æ–º–ø—Ä–µ—Å—Å–∏–µ–π |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                   | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                            |
| -------------------------- | ------ | ------------------------------------------------------ |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ SYSTEM VERSIONED | 100    | –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ SQL + –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è –≤—Ä–µ–º–µ–Ω–∏           |
| –ó–∞–ø—Ä–æ—Å—ã AS OF / BETWEEN    | 100    | –ß–µ—Ä–µ–∑ snapshot-aware MVCC API                          |
| TTL, Purge, Retention      | 95     | –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è policy –Ω–∞ –æ—Å–Ω–æ–≤–µ access pattern |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
if (version_query_as_of(&session->snapshot, ts)) {
  return payload->field[0];
} else {
  return NULL;
}
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ TTL –∏ –ø–æ–ª–∏—Ç–∏–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –¥–æ—Å—Ç—É–ø–∞
* –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–µ—Ä—Å–∏–π –Ω–∞ –¥–∏—Å–∫ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Parquet
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å BI/–∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –≤–µ—Ä—Å–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø—Ä–∞–≤
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª–∏—Ç–∏–∫–∏ ¬´immutable past¬ª –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
* –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∑–∞—â–∏—â—ë–Ω–Ω—ã–π WAL

## üì§ –°–æ–æ–±—â–µ–Ω–∏—è –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

* `I_ASOF_NO_ROW`: –Ω–µ—Ç —Å—Ç—Ä–æ–∫–∏, –≤–∞–ª–∏–¥–Ω–æ–π –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
* `E_TTL_PURGED`: —Å—Ç—Ä–æ–∫–∞ —É–¥–∞–ª–µ–Ω–∞ –ø–æ–ª–∏—Ç–∏–∫–æ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è
* `W_VERSION_CONFLICT`: –∫–æ–Ω—Ñ–ª–∏–∫—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ

## üß© UML-–¥–∏–∞–≥—Ä–∞–º–º–∞ (PlantUML)

```
@startuml
package "System Time Versioning (2.9)" {
  [System Versioning] --> [MVCC]
  [System Versioning] --> [Storage Engine]
  [System Versioning] --> [Query Engine]
  [System Versioning] --> [Snapshot Isolation]
}
@enduml
```

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v0.8 ‚Äî —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑–æ–≤–æ–≥–æ INSERT/AS OF (2025-07-10)
* v1.0 ‚Äî TTL –∏ TTL purge (2025-07-18)
* v1.1 ‚Äî –±—É–¥—É—â–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º (–≤ –ø–ª–∞–Ω–∞—Ö)
