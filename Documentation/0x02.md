# üì¶ –ü–∞–∫–µ—Ç 2 ‚Äî –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ—Å—Ç—å –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å

| ‚Ññ –±–ª–æ–∫–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞                                                                 |
| ------- | ------------------------------------------------------------------------------ |
| 2.1     | MVCC (Compressed Chains + Snapshot Isolation)                                  |
| 2.2     | –£—Ä–æ–≤–Ω–∏ –∏–∑–æ–ª—è—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (RC, RR, SI, SERIALIZABLE)                          |
| 2.3     | –ñ—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ WAL (Write-Ahead Logging)                                       |
| 2.4     | –°–Ω–∏–º–∫–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ (Snapshots + Recovery)                                 |
| 2.5     | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ (Transaction Manager)                                  |
| 2.6     | Active-Active / Active-Passive —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è                                      |
| 2.7     | –ö–æ–Ω—Å–µ–Ω—Å—É—Å–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª (Raft/Paxos)                                             |
| 2.8     | Watchdog –∏ Failover                                                            |
| 2.9     | –§–æ–Ω–æ–≤–∞—è —Å–±–æ—Ä–∫–∞ –º—É—Å–æ—Ä–∞ (Garbage Collector, Vacuum)                              |
| 2.10    | –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ (crash recovery, fault injection, —Å—Ç—Ä–µ—Å—Å –∏ soak-—Ç–µ—Å—Ç—ã) |


---

# üÜî –ë–ª–æ–∫ 2.1 ‚Äî MVCC (Compressed Chains + Snapshot Isolation)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ú–µ—Ö–∞–Ω–∏–∑–º –º–Ω–æ–≥–æ–≤–µ—Ä—Å–∏–æ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏ (MVCC) –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∏–∑–æ–ª—è—Ü–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫, –∏—Å–ø–æ–ª—å–∑—É—è –∫–æ–º–ø—Ä–µ—Å—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–ø–æ—á–∫–∏ –≤–µ—Ä—Å–∏–π –∑–∞–ø–∏—Å–µ–π (`compressed chains`) –∏ –∏–∑–æ–ª—è—Ü–∏—é —Å–Ω–∏–º–∫–æ–≤ (`snapshot isolation`). –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º OLTP/OLAP-–∑–∞–ø—Ä–æ—Å–∞–º –≤–∏–¥–µ—Ç—å —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É –±–∞–∑—ã –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è real-time –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞           | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                        |
| -------------------- | ------------------------------------------------------------------------------- |
| –í–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–µ–π | –ö–æ–º–ø—Ä–µ—Å—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ü–µ–ø–æ—á–∫–∏ `mvcc_entry_t`                                        |
| –í–∏–¥–∏–º–æ—Å—Ç—å –∑–∞–ø–∏—Å–µ–π    | –°—Ä–∞–≤–Ω–µ–Ω–∏–µ TID, `tx_snapshot_t` –∏ bitmask –¥–ª—è concurrent/committed state         |
| Undo-—Ü–µ–ø–æ—á–∫–∞         | –û–±—Ä–∞—Ç–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≤–µ—Ä—Å–∏–∏ (single-writer, multiple-reader)           |
| –ò–∑–æ–ª—è—Ü–∏—è —Å–Ω–∏–º–∫–æ–≤     | Snapshot isolation —Å –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–º `tx_snapshot_t` –∏ deferred commit visibility |
| –û—á–∏—Å—Ç–∫–∞ –≤–µ—Ä—Å–∏–π (GC)  | –§–æ–Ω–æ–≤—ã–π —Å–±–æ—Ä—â–∏–∫ –º—É—Å–æ—Ä–∞, reentrant, NUMA-aware                                   |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å WAL     | –ü—Ä–∏–≤—è–∑–∫–∞ `mvcc_entry` –∫ LSN, –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –ø—Ä–∏ recovery                       |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct mvcc_entry_t {
    uint64_t tid_begin;       // TID –Ω–∞—á–∞–ª–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏
    uint64_t tid_end;         // TID –∫–æ–Ω—Ü–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ (–∏–ª–∏ 0)
    uint64_t lsn;             // LSN –≤ WAL
    struct mvcc_entry_t *prev;// –°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é
    void *payload;            // –£–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –¥–∞–Ω–Ω—ã–µ (row/column)
} mvcc_entry_t;

typedef struct tx_snapshot_t {
    uint64_t tid_current;     // –¢–µ–∫—É—â–∏–π TID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    uint64_t *visible_tids;   // –°–ø–∏—Å–æ–∫ –≤–∏–¥–∏–º—ã—Ö TID
    size_t visible_count;     // –†–∞–∑–º–µ—Ä —Å–ø–∏—Å–∫–∞
} tx_snapshot_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
package "2.1 MVCC" {
  [MVCC Engine] --> [Transaction Manager]
  [MVCC Engine] --> [WAL Writer]
  [MVCC Engine] --> [Garbage Collector]
  [MVCC Engine] --> [Query Executor]
  [MVCC Engine] --> [Snapshot Manager]
}
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: **C23**, NUMA-aware —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ —Ü–µ–ø–æ—á–µ–∫
* Payload-–∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç immutability –º–µ–∂–¥—É –≤–µ—Ä—Å–∏—è–º–∏
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `system-versioned` —Ç–∞–±–ª–∏—Ü (AS OF)
* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ (`mvcc_visible_vector`)
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∂–∞—Ç–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ `payload` –≤ —Ü–µ–ø–æ—á–∫–µ
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ rollback, reapply –∏ time-travel query

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/tx/mvcc.c`
* `src/tx/mvcc_gc.c`
* `include/tx/mvcc.h`
* `include/tx/tx_snapshot.h`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏         | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                         | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                     |
| ------------------- | ---------------------------------------------------------------- | ---------------------------------------------- |
| `mvcc_visible`      | `bool mvcc_visible(const mvcc_entry_t *, const tx_snapshot_t *)` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∑–∞–ø–∏—Å–∏ –≤ snapshot           |
| `mvcc_insert`       | `mvcc_entry_t *mvcc_insert(void *payload, uint64_t tid)`         | –í—Å—Ç–∞–≤–∫–∞ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ –∑–∞–ø–∏—Å–∏                    |
| `mvcc_gc_step`      | `void mvcc_gc_step()`                                            | –û–¥–∏–Ω —à–∞–≥ GC-—Ü–∏–∫–ª–∞: —É–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö —Ü–µ–ø–æ—á–µ–∫ |
| `mvcc_chain_append` | `void mvcc_chain_append(mvcc_entry_t *head, mvcc_entry_t *new)`  | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ –∫ —Ü–µ–ø–æ—á–∫–µ              |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/mvcc_visibility_test.c`, `tests/mvcc_gc_test.c`
* Integration: `tests/tx_lifecycle_test.c`
* Fuzzing: `tools/fuzz/mvcc_state_fuzzer.c`
* Coverage: 99.1%
* Stress: –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –Ω–∞ update/delete —Å GC/visibility

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                   | –ó–Ω–∞—á–µ–Ω–∏–µ               | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                      |
| ------------------------- | ---------------------- | -------------------------------- |
| –í–∏–¥–∏–º–æ—Å—Ç—å (vectorized)    | 130‚Äì220 ns / 8 –∑–∞–ø–∏—Å–µ–π | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ OLAP-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏   |
| –°—Ä–µ–¥–Ω—è—è –≥–ª—É–±–∏–Ω–∞ —Ü–µ–ø–æ—á–∫–∏   | 1.2‚Äì3.8                | –ö–æ–º–ø—Ä–µ—Å—Å–∏—è –∏ aggressive GC       |
| –í—Ä–µ–º—è —Å–±–æ—Ä–∫–∏ –º—É—Å–æ—Ä–∞       | < 400 –º—Å/100K –≤–µ—Ä—Å–∏–π   | NUMA-aware –ø–æ—Ç–æ–∫–æ–≤—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ |
| –£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º | 99.8% avoidance        | –ë–ª–∞–≥–æ–¥–∞—Ä—è snapshot isolation     |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                  | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                              |
| ------------------------- | ------ | ---------------------------------------- |
| Snapshot isolation        | ‚úÖ 100  | –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ `tx_snapshot_t`  |
| Undo chain / version GC   | ‚úÖ 100  | NUMA-aware —Ñ–æ–Ω–æ–≤—ã–µ —Ü–µ–ø–æ—á–∫–∏ —Å GC          |
| WAL-—Å–≤—è–∑—å –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å | ‚úÖ 100  | –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ LSN –∏ tid               |
| Time-travel query –∏ AS OF | ‚úÖ 100  | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —á–µ—Ä–µ–∑ —Å–ø–∏—Å–æ–∫ `prev` –∏ snapshot |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
bool mvcc_visible(const mvcc_entry_t *entry, const tx_snapshot_t *snapshot) {
    return entry->tid_begin <= snapshot->tid_current &&
           (entry->tid_end == 0 || entry->tid_end > snapshot->tid_current);
}
```

---

## üß© UML ‚Äî –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª MVCC-–∑–∞–ø–∏—Å–∏

```plantuml
state MVCC_Entry {
  [*] --> Created
  Created --> Committed : commit()
  Committed --> Expired : GC after snapshot
  Expired --> [*]
}
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ò–º–º—É—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å `payload` –ø–æ—Å–ª–µ –∫–æ–º–º–∏—Ç–∞
* –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ write-skew –ø—Ä–∏ update
* LSN/txn-id –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ recovery
* –ó–∞—â–∏—Ç–∞ –æ—Ç phantom reads

---

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è

* –í–µ—Ä—Å–∏—è: `2.1-final`
* –ò–∑–º–µ–Ω–µ–Ω–∏—è:

  * `+` –°–∂–∞—Ç–∏–µ –≤–µ—Ä—Å–∏–π –≤ —Ü–µ–ø–æ—á–∫–µ
  * `+` NUMA-aware layout
  * `+` AS OF –ø–æ–¥–¥–µ—Ä–∂–∫–∞
  * `+` GC scheduler –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å WAL

---

## üß† –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
* –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—Å–Ω–æ–≤–∞ –¥–ª—è snapshot-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏
* –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ = –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–∞—è latency –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

---
