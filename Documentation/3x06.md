–í–æ—Ç —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫:

---

### üìò 3.6 ‚Äî –†–µ–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ –û–±—Ä–∞—Ç–Ω–∞—è –°–≤—è–∑—å (Adaptive Re-Optimization & Feedback Loop)

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* –ü–∞–∫–µ—Ç 3 ‚Äî SQL –∏ –Ø–∑—ã–∫–∏
* –ë–ª–æ–∫ 3.6 ‚Äî –†–µ–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ –û–±—Ä–∞—Ç–Ω–∞—è –°–≤—è–∑—å

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –±–ª–æ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∞–¥–∞–ø—Ç–∏–≤–Ω—É—é —Ä–µ–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–ª—É—á–∞–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –º–µ–∂–¥—É –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–æ–π –∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π —Å–µ–ª–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é, –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é –∏–ª–∏ –∑–∞—Ç—Ä–∞—Ç–∞–º–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è. –°–∏—Å—Ç–µ–º–∞ —Å–±–æ—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (runtime feedback) –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –±—É–¥—É—â–∏—Ö –ø–ª–∞–Ω–æ–≤ –∏ —Ä–µ–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ long-running –∏–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞          | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                            |
| ------------------- | ------------------------------------------------------------------- |
| Runtime Feedback    | –°–±–æ—Ä —Ä–µ–∞–ª—å–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ (cardinality, latency)   |
| Trigger-based Reopt | –ü–ª–∞–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–º–µ–Ω—ë–Ω –Ω–∞ –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –ø–æ —Ö–æ–¥—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è     |
| Feedback Catalog    | –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |
| Plan Introspection  | –î–æ—Å—Ç—É–ø –∫ –¥–µ—Ç–∞–ª—è–º —Ä–∞–±–æ—Ç—ã –ø–ª–∞–Ω–∞: —É–∑–ª—ã, –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞          |
| Replanning Engine   | –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∏—è –≤–æ –≤—Ä–µ–º—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct feedback_entry_t {
    query_hash_t query_id;
    uint32_t plan_id;
    double estimated_cardinality;
    double actual_cardinality;
    timestamp_t collected_at;
} feedback_entry_t;

typedef struct reopt_context_t {
    plan_node_t *current_plan;
    feedback_entry_t *feedback_data;
} reopt_context_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[Execution Engine] --> [Runtime Feedback Collector]
[Runtime Feedback Collector] --> [Feedback Catalog]
[Reopt Engine] --> [Cost-Based Optimizer]
[Optimizer] --> [Plan Selector]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–±—Ä–æ—Å–∞ –º–µ–∂–¥—É –æ–∂–∏–¥–∞–µ–º–æ–π –∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é
* –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–Ω–ª–∞–π–Ω –∑–∞–º–µ–Ω—ã –ø–ª–∞–Ω–∞ –±–µ–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
* –ì–∏–±—Ä–∏–¥–Ω—ã–π —Å–ø–æ—Å–æ–±: —á–∞—Å—Ç–∏—á–Ω—ã–π replan (–ø–æ–¥–¥–µ—Ä–µ–≤–æ) –∏–ª–∏ –ø–æ–ª–Ω—ã–π reopt
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ trace-—Ñ–ª–∞–≥–æ–≤ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π –ª–æ–≥–∏–∫–∏
* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å introspection (EXPLAIN FEEDBACK) –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/sql/optimizer/feedback.c`
* `src/sql/optimizer/reopt_engine.c`
* `include/sql/optimizer/feedback.h`
* `include/sql/optimizer/reopt_engine.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏            | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                               | –û–ø–∏—Å–∞–Ω–∏–µ                                    |
| ---------------------- | ---------------------------------------------------------------------- | ------------------------------------------- |
| `collect_feedback`     | `void collect_feedback(exec_stats_t *stats, feedback_entry_t *entry);` | –°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤–æ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è         |
| `store_feedback_entry` | `int store_feedback_entry(feedback_entry_t *entry);`                   | –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥          |
| `trigger_reoptimize`   | `plan_node_t* trigger_reoptimize(reopt_context_t *ctx);`               | –ò–Ω–∏—Ü–∏–∞—Ü–∏—è –ø–µ—Ä–µ–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∏–¥–±–µ–∫–∞ |
| `explain_feedback`     | `char* explain_feedback(const query_hash_t *query);`                   | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞ –ø–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è–º             |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit-—Ç–µ—Å—Ç—ã: `tests/optimizer/reopt_test.c`
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ: —Ñ–∏–¥–±–µ–∫ –ø—Ä–∏ OLAP-–∑–∞–ø—Ä–æ—Å–∞—Ö —Å –æ—à–∏–±–æ—á–Ω–æ–π —Å–µ–ª–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é
* Fuzz-—Ç–µ—Å—Ç—ã: —Å–ª—É—á–∞–π–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ replan
* Soak: –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω—ã–π –∑–∞–ø—É—Å–∫ —Å –≤–∫–ª—é—á–µ–Ω–Ω—ã–º feedback loop

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* –í—Ä–µ–º—è —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫: < 5 –º–∫—Å –Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä
* –î–æ 30% —É—Å–∫–æ—Ä–µ–Ω–∏—è long-running –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
* –£–º–µ–Ω—å—à–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–µ–Ω—É–∂–Ω—ã—Ö merge/hash join –Ω–∞ 40% –≤ —Ç–µ—Å—Ç–∞—Ö

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                  | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                 |
| ------------------------- | ------ | ------------------------------------------- |
| Runtime Feedback          | 100    | –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Å–±–æ—Ä–∞, —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è |
| Triggered Re-Optimization | 90     | –ß–∞—Å—Ç–∏—á–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–Ω–ª–∞–π–Ω –ø–µ—Ä–µ–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏  |
| Explain + Trace           | 85     | –ë–∞–∑–æ–≤—ã–µ –æ—Ç—á—ë—Ç—ã, –±–µ–∑ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–∫–∞       |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
if (needs_reopt(stats)) {
    plan = trigger_reoptimize(&reopt_ctx);
}
execute_plan(plan);
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –í–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–ª–∞–Ω–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ feedback
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ML-–∞–Ω–∞–ª–∏–∑–æ–º –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞ NDV/–≥–∏—Å—Ç–æ–≥—Ä–∞–º–º –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

## üß∞ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –£–ª—É—á—à–µ–Ω–∏–µ SLA –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
* –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–π –≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ —Å–µ–∑–æ–Ω–Ω—ã–µ/—á–∞—Å–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö, —Ç–æ–ª—å–∫–æ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
* –î–æ—Å—Ç—É–ø –∫ explain\_feedback —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç—Å—è –ø–æ —Ä–æ–ª—è–º
* –ú–µ—Ö–∞–Ω–∏–∑–º—ã TTL –∏ –æ—á–∏—Å—Ç–∫–∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤

## üßæ –°–æ–æ–±—â–µ–Ω–∏—è, –æ—à–∏–±–∫–∏, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

* `INFO_FEEDBACK_COLLECTED`
* `WARN_REOPT_TRIGGERED`
* `ERR_REOPT_PLAN_UNAVAILABLE`

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî Basic feedback, runtime cardinality
* v1.1 ‚Äî Triggered reoptimization, plan substitution
* v1.2 ‚Äî Feedback catalog, EXPLAIN FEEDBACK

## üìà UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
package "Adaptive Optimizer" {
  class FeedbackCollector {
    +collect()
    +store()
  }
  class Reoptimizer {
    +trigger()
    +apply()
  }
  class FeedbackCatalog {
    +insert()
    +query()
  }

  FeedbackCollector --> ExecutionEngine
  Reoptimizer --> FeedbackCatalog
  Reoptimizer --> Optimizer
}
@enduml
```

---

üü¢ –ì–æ—Ç–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –±–ª–æ–∫–æ–º **3.7 ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–∫–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π, ROLLUP –∏ CUBE** ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ **–¥–∞**.

