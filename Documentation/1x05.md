# üß± –ë–ª–æ–∫ 1.5 ‚Äî –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–Ω–∏–º–∫–∞ (Snapshot Recovery)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.5 ‚Äî –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–Ω–∏–º–∫–∞ (Snapshot Recovery)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–Ω–∏–º–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–∏—Å—Ç–µ–º—ã –∏–ª–∏ –ø–æ—Å–ª–µ —Å–±–æ—è. –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö, –º–∏–Ω–∏–º–∏–∑–∏—Ä—É—è –ø–æ—Ç–µ—Ä–∏ —Å —É—á—ë—Ç–æ–º WAL –∏ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö snapshot-—Ñ–∞–π–ª–æ–≤.

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞         | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è/–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                           |
| ------------------ | ---------------------------------------------------------------- |
| –°–Ω–∏–º–∫–∏             | –•—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ SSD –≤ —Ñ–æ—Ä–º–∞—Ç–µ page-diff –∏–ª–∏ full-page                |
| –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ     | –ß—Ç–µ–Ω–∏–µ snapshot, –∑–∞—Ç–µ–º –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏–µ WAL –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ checkpoint |
| –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MVCC | –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö txid –∏ snapshot\_id                         |
| –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å    | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö —Å—É–º–º, –≤–µ—Ä—Å–∏–π –∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∑–∞–ø–∏—Å–µ–π          |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
// snapshot.h
typedef struct snapshot_header_t {
    uint64_t snapshot_id;
    uint64_t last_wal_lsn;
    uint64_t timestamp;
    uint32_t crc32;
} snapshot_header_t;

typedef struct snapshot_record_t {
    uint64_t page_id;
    uint16_t length;
    uint8_t  data[MAX_PAGE_SIZE];
} snapshot_record_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
package "1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã" {
  [1.4 WAL Init] --> [1.5 Snapshot Recovery]
  [1.5 Snapshot Recovery] --> [2.1 MVCC Engine]
  [1.5 Snapshot Recovery] --> [2.2 –¢–∞–±–ª–∏—Ü—ã / –¥–∞–Ω–Ω—ã–µ]
}
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: C23
* –•—Ä–∞–Ω–µ–Ω–∏–µ snapshot –Ω–∞ NVMe/SSD (–≤–Ω–µ in-memory –ø—É—Ç–∏)
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ frame-of-reference –ø—Ä–∏ —Å–∂–∞—Ç–∏–∏ snapshot
* –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö —Å—É–º–º, fail-fast recovery
* Prefetch —Å—Ç—Ä–∞–Ω–∏—Ü –≤ –ø–∞–º—è—Ç—å –Ω–∞ —Å—Ç–∞—Ä—Ç–µ

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

| –§–∞–π–ª                 | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                  |
| -------------------- | --------------------------- |
| `src/snapshot.c`     | –ó–∞–≥—Ä—É–∑–∫–∞, –ø—Ä–æ–≤–µ—Ä–∫–∞ snapshot |
| `src/wal.c`          | WAL replay                  |
| `include/snapshot.h` | –§–æ—Ä–º–∞—Ç snapshot-—Ñ–∞–π–ª–∞       |

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –§—É–Ω–∫—Ü–∏—è                   | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                               | –û–ø–∏—Å–∞–Ω–∏–µ                              |
| ------------------------- | ---------------------------------------------------------------------- | ------------------------------------- |
| `snapshot_load`           | `bool snapshot_load(db_t *db, const char *path)`                       | –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç snapshot + WAL  |
| `snapshot_verify_crc`     | `bool snapshot_verify_crc(const void *data, size_t len, uint32_t crc)` | –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É—é —Å—É–º–º—É           |
| `snapshot_prefetch_pages` | `void snapshot_prefetch_pages(const snapshot_record_t *records)`       | –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤ –ø–∞–º—è—Ç—å —É–∫–∞–∑–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã: `tests/test_snapshot.c`
* Fuzz: Fuzzing –ø–æ –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–º snapshot-—Ñ–∞–π–ª–∞–º
* Soak test: –¥–æ–ª–≥–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ + —Å–±–æ–∏ –ø–∏—Ç–∞–Ω–∏—è (crash recovery)
* Coverage > 92%

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                   | –ó–Ω–∞—á–µ–Ω–∏–µ                                 |
| ------------------------- | ---------------------------------------- |
| –í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è      | < 150 –º—Å –ø—Ä–∏ snapshot+WAL < 500 –ú–ë       |
| –°–∫–æ—Ä–æ—Å—Ç—å prefetch         | 2.1 GB/s (NVMe read throughput)          |
| –ö–æ–ª-–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü –≤ snapshot | 80k - 500k —Å—Ç—Ä–∞–Ω–∏—Ü (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ë–î) |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π          | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                         |
| ----------------- | ------ | --------------------------------------------------- |
| Snapshot Recovery | 100    | –ï—Å—Ç—å –ø–æ–ª–Ω–∞—è –ø–æ–¥–≥—Ä—É–∑–∫–∞, prefetch, crash-consistency  |
| WAL replay        | 100    | Replay –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ LSN                            |
| –°–∂–∞—Ç–∏–µ            | 90     | –ü–æ–∫–∞ –Ω–µ –≤—Å–µ page-type –∏—Å–ø–æ–ª—å–∑—É—é—Ç frame-of-reference |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
if (!snapshot_load(db, config_get_snapshot_path())) {
    log_error("snapshot", "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–µ—Ä–≤–∞–Ω–∞");
    exit(EXIT_FAILURE);
}
```

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ snapshot'—ã
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ multithreaded replay WAL
* –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π snapshot scheduler

---

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞ (.puml)

```plantuml
@startuml
entity "snapshot_header_t" {
  +uint64_t snapshot_id
  +uint64_t last_wal_lsn
  +uint64_t timestamp
  +uint32_t crc32
}

entity "snapshot_record_t" {
  +uint64_t page_id
  +uint16_t length
  +uint8_t data[MAX_PAGE_SIZE]
}

snapshot_header_t --> snapshot_record_t : —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–∞–ø–∏—Å–∏
@enduml
```

---

## üßæ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ì–∞—Ä–∞–Ω—Ç–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –∞–≤–∞—Ä–∏–π
* –°–Ω–∏–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—Å—Ç–æ—è (RTO)
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ SLA –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

---

## üìú –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

| –í–µ—Ä—Å–∏—è | –ê–≤—Ç–æ—Ä  | –ò–∑–º–µ–Ω–µ–Ω–∏–µ                                |
| ------ | ------ | ---------------------------------------- |
| 1.0    | system | –ü–µ—Ä–≤–∏—á–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è snapshot + recovery |
| 1.1    | tofa   | –î–æ–±–∞–≤–ª–µ–Ω prefetch –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ CRC         |

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* CRC32 –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥–æ–≥–æ snapshot-—Ñ–∞–π–ª–∞
* –í–∞–ª–∏–¥–∞—Ü–∏—è offset/—Ä–∞–∑–º–µ—Ä–∞ –∑–∞–ø–∏—Å–µ–π –ø–µ—Ä–µ–¥ —á—Ç–µ–Ω–∏–µ–º
* –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –±—É—Ñ–µ—Ä–∞ (bounds check)

---

## üìù –°–æ–æ–±—â–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞ (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)

| –£—Ä–æ–≤–µ–Ω—å | –°–æ–æ–±—â–µ–Ω–∏–µ                                        | –£—Å–ª–æ–≤–∏–µ                                          |
| ------- | ------------------------------------------------ | ------------------------------------------------ |
| INFO    | \[Snapshot] –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ snapshot\_id=%lu   | –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è                        |
| DEBUG   | \[Snapshot] –ü—Ä–µ—Ñ–µ—Ç—á —Å—Ç—Ä–∞–Ω–∏—Ü—ã %lu                 | –ü—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–∑ snapshot                  |
| WARN    | \[Snapshot] CRC –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, snapshot –ø–æ–≤—Ä–µ–∂–¥—ë–Ω | –ü—Ä–∏ –Ω–µ—É–¥–∞—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Å—É–º–º—ã         |
| ERROR   | \[Snapshot] –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å: %s        | –ü—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–µ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ |
