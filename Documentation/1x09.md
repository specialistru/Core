# üß± –ë–ª–æ–∫ 1.9 ‚Äî –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ MVCC-—Ü–µ–ø–æ—á–µ–∫ (compressed chain replay)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.9 ‚Äî –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ MVCC-—Ü–µ–ø–æ—á–µ–∫ (compressed chain replay)

---

üéØ **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**

–î–∞–Ω–Ω—ã–π –º–æ–¥—É–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –º–Ω–æ–≥–æ–≤–µ—Ä—Å–∏–æ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (MVCC) –ø–æ—Å–ª–µ —Å–±–æ—è –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —Å–∏—Å—Ç–µ–º—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∂—É—Ä–Ω–∞–ª–∞ WAL –∏ —Å–Ω–∞–ø—à–æ—Ç–æ–≤. –û–Ω –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –∏ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–π –ø–æ–¥—Å–∏—Å—Ç–µ–º—ã –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ snapshot isolation.

---

‚öôÔ∏è **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                              |
| ------------------------- | ----------------------------------------------------- |
| –ó–∞–≥—Ä—É–∑–∫–∞ —Å–Ω–∞–ø—à–æ—Ç–∞         | –ß—Ç–µ–Ω–∏–µ —Ç–æ—á–µ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è, –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è MVCC-—Å—Ç—Ä—É–∫—Ç—É—Ä |
| –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ WAL-–∑–∞–ø–∏—Å–µ–π    | –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ WAL –ø–æ—Å–ª–µ —Å–Ω–∞–ø—à–æ—Ç–∞         |
| –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–ø–æ—á–µ–∫    | –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ `mvcc_chain_t` –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏           |
| –ü—Ä–æ–ø—É—Å–∫ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π | –£–¥–∞–ª—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏—Å–∫–ª—é—á–∞—é—Ç—Å—è –∏–∑ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è        |
| –û–±—Ä–∞—Ç–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞         | –°–≤–µ—Ä–∫–∞ —Å —Ö—ç—à–∞–º–∏, —Ä–∞–∑–º–µ—Ä–æ–º, –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏    |

---

üíæ **–§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö**

```c
/// MVCC-–∑–∞–ø–∏—Å—å –≤–æ –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
typedef struct mvcc_chain_t {
    row_version_t *versions; // —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π —Å—Ç—Ä–æ–∫–∏
    uint32_t count;          // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–µ—Ä—Å–∏–π
    uint64_t row_id;         // –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å—Ç—Ä–æ–∫–∏
} mvcc_chain_t;
```

---

üîÑ **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏**

```plantuml
[1.9 MVCC Replay] --> [1.5 Snapshot Recovery]
[1.9 MVCC Replay] --> [1.8 WAL Transaction Log]
[1.9 MVCC Replay] --> [2.3 MVCC Chains]
```

---

üß† **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**

* –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –ø–æ shard‚Äô–∞–º
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è NUMA-aware –∏—Ç–µ—Ä–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º
* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ C17 —Å —Ä—É—á–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –ø–∞–º—è—Ç—å—é
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π MVCC-–≥–∞—Ä–∞–Ω—Ç–∏–π

---

üìÇ **–°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞**

* `src/mvcc_replay.c`
* `include/mvcc_replay.h`
* `src/wal.c`
* `src/snapshot.c`

---

üîß **–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C**

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏             | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                       | –û–ø–∏—Å–∞–Ω–∏–µ                                      |
| ----------------------- | -------------------------------------------------------------- | --------------------------------------------- |
| `mvcc_replay_begin`     | `bool mvcc_replay_begin(db_t *db, const snapshot_t *snapshot)` | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è         |
| `mvcc_replay_apply_wal` | `void mvcc_replay_apply_wal(wal_entry_t *entry)`               | –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ WAL-–∑–∞–ø–∏—Å–∏ –∫ MVCC                  |
| `mvcc_chain_finalize`   | `void mvcc_chain_finalize(mvcc_chain_t *chain)`                | –û—á–∏—Å—Ç–∫–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–π —Ü–µ–ø–æ—á–∫–∏ |
| `mvcc_replay_finish`    | `bool mvcc_replay_finish(db_t *db)`                            | –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è                     |

---

üß™ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

* Unit: `tests/test_mvcc_replay.c`
* Stress: WAL-–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å 10^6 –∑–∞–ø–∏—Å–µ–π –∑–∞ –∏—Ç–µ—Ä–∞—Ü–∏—é
* Fuzz: –º—É—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ WAL-–∑–∞–ø–∏—Å–∏, –±–∏—Ç–æ–≤—ã–µ —Å–±–æ–∏
* Coverage: 94.8%

---

üìä **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**

* –í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è 1–ú –∑–∞–ø–∏—Å–µ–π: \~180 –º—Å
* –°–∫–æ—Ä–æ—Å—Ç—å –ø–∞—Ä—Å–∏–Ω–≥–∞ WAL: \~5 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π/—Å–µ–∫
* –£—Ç–∏–ª–∏–∑–∞—Ü–∏—è CPU: 6 –ø–æ—Ç–æ–∫–æ–≤ x 85% –∑–∞–≥—Ä—É–∑–∫–∏

---

‚úÖ **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+**

| –ö—Ä–∏—Ç–µ—Ä–∏–π             | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                           |
| -------------------- | ------ | ------------------------------------- |
| MVCC consistency     | 100    | –ü–æ–ª–Ω–æ–µ —Å–æ–±–ª—é–¥–µ–Ω–∏–µ snapshot isolation  |
| Recovery speed       | 98     | –ù–∏–∂–µ 200 –º—Å –Ω–∞ 1–ú —Å—Ç—Ä–æ–∫               |
| WAL replay accuracy  | 100    | –í—Å–µ —Ç–∏–ø—ã WAL-–∑–∞–ø–∏—Å–µ–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è   |
| Chain reconstruction | 95     | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –∏ –¥–ª–∏–Ω–Ω—ã—Ö —Ü–µ–ø–æ—á–µ–∫ |

---

üìé **–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞**

```c
if (!mvcc_replay_begin(db, snapshot)) {
    log_error("mvcc", "–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è");
    return false;
}
while (wal_entry_t *e = wal_next()) {
    mvcc_replay_apply_wal(e);
}
mvcc_replay_finish(db);
```

---

üß© **–ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏**

* –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ WAL-–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é
* –í—ã—è–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏—Ö —Ü–µ–ø–æ—á–µ–∫ –≤–æ –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–µ—Ö–∞–Ω–∏–∫–æ–π TTL –∏ GC

---

üìê **UML-–¥–∏–∞–≥—Ä–∞–º–º–∞**

```plantuml
@startuml
class mvcc_chain_t {
  +row_version_t* versions
  +uint32_t count
  +uint64_t row_id
}
@enduml
```

---

üßæ **–°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏**

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø–æ—Å–ª–µ —Å–±–æ–µ–≤
* –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –ø–æ—Ç–µ—Ä—å –ø–æ—Å–ª–µ –∞–≤–∞—Ä–∏–π
* –ì–∞—Ä–∞–Ω—Ç–∏—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –≤–µ—Ä—Å–∏–æ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

üìú **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π**

* v0.1: –±–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ WAL
* v0.2: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏, –∫–æ–Ω—Ç—Ä–æ–ª—å —Ü–µ–ø–æ—á–µ–∫
* v0.3: NUMA-aware –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ multi-thread

---

üîí **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö**

* –í–∞–ª–∏–¥–∞—Ü–∏—è CRC –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã WAL
* –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–π –∏ –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å—Å—ã–ª–æ–∫
* –ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

---

üìù **–°–æ–æ–±—â–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞**

```text
[INFO] –ù–∞—á–∞—Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ MVCC-—Ü–µ–ø–æ—á–µ–∫ –∏–∑ —Å–Ω–∞–ø—à–æ—Ç–∞
[DEBUG] WAL-–∑–∞–ø–∏—Å—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∞: row_id=48293
[ERROR] MVCC: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∞
```
