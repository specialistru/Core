# üß± –ë–ª–æ–∫ 9.6 ‚Äî –†–∞—Å—à–∏—Ä–µ–Ω–∏—è —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–∏–µ –º–æ–¥—É–ª–∏ (dlopen / LoadLibrary)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 9 ‚Äî –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å
* **–ë–ª–æ–∫:** 9.6 ‚Äî –†–∞—Å—à–∏—Ä–µ–Ω–∏—è —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–∏–µ –º–æ–¥—É–ª–∏ (dlopen / LoadLibrary)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –±–ª–æ–∫ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –≤–Ω–µ—à–Ω–∏—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π (shared libraries), –ø–æ–∑–≤–æ–ª—è—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø–æ–¥–∫–ª—é—á–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –Ω–∞ —ç—Ç–∞–ø–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ —è–¥—Ä–∞ –°–£–ë–î. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤—ã—Å–æ–∫—É—é –≥–∏–±–∫–æ—Å—Ç—å –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã, —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –≤–Ω–µ—à–Ω–∏–º–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –º–∞—Å—à—Ç–∞–±–Ω–æ–≥–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–∞–¥–∞—á–∏, –≤–∫–ª—é—á–∞—è –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                  | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                |
| --------------------------- | ------------------------------------------------------- |
| –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª–µ–π            | `dlopen` (Unix) / `LoadLibrary` (Windows), lazy binding |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —è–¥—Ä–æ–º          | –ö–æ–Ω—Ç—Ä–∞–∫—Ç API —Å —è–¥—Ä–æ–º (init, register, shutdown)         |
| –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ UDF/UDAF         | –í–Ω–µ—à–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –º–æ–≥—É—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–∏ —Ñ—É–Ω–∫—Ü–∏–∏    |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏       | –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–∏–≥–Ω–∞—Ç—É—Ä, –∫–æ–Ω—Ç—Ä–æ–ª—å –ø—É—Ç–µ–π, sandboxing        |
| –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º | –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è, –≤—ã–≥—Ä—É–∑–∫–∞                    |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct db_extension_t {
    char *name;
    void *handle;
    int (*init_fn)(void);
    int (*register_fn)(void);
    int (*shutdown_fn)(void);
} db_extension_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[Extension Loader] --> [UDF Runtime]
[Extension Loader] --> [–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–∞–º—è—Ç–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏]
[Extension Loader] --> [–†–µ–µ—Å—Ç—Ä —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –Ω–∞ C23 —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º POSIX API (`dlopen`, `dlsym`) –∏ Windows API (`LoadLibrary`)
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≥–æ—Ä—è—á–µ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –≤—ã–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª–µ–π –±–µ–∑ —Ä–µ—Å—Ç–∞—Ä—Ç–∞
* –ö–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Ä—Å–∏–π —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ ABI
* –ò–∑–æ–ª—è—Ü–∏—è –≤ –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–º namespace (–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è, scope)

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/udf/ext_loader.c`
* `include/udf/ext_loader.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏          | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                     | –û–ø–∏—Å–∞–Ω–∏–µ                                 |
| -------------------- | ------------------------------------------------------------ | ---------------------------------------- |
| `extension_load`     | `int extension_load(const char *path, db_extension_t *ext);` | –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ –º–æ–¥—É–ª—è |
| `extension_unload`   | `int extension_unload(db_extension_t *ext);`                 | –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –≤—ã–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª—è  |
| `extension_register` | `int extension_register(db_extension_t *ext);`               | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π       |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã: `tests/ext/ext_loader_test.c`
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ: –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö UDF –∏–∑ `.so`/`.dll`
* Negative testing: –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏, –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ ABI
* –ü–æ–∫—Ä—ã—Ç–∏–µ: 89%

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏: \~5‚Äì10 –º—Å –Ω–∞ –º–æ–¥—É–ª—å
* –í–ª–∏—è–Ω–∏–µ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ UDF: < 0.5%
* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π: 1024+

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                      | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                      |
| ----------------------------- | ------ | ------------------------------------------------ |
| –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª–µ–π | 100    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–∞ –≤—Å–µ—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö                     |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å                  | 95     | –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Ç–µ–π –∏ —Å–∏–≥–Ω–∞—Ç—É—Ä —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞            |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —è–¥—Ä–æ–º            | 100    | –ß—ë—Ç–∫–∏–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç API —Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π –∏ –≤—ã–≥—Ä—É–∑–∫–æ–π |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
db_extension_t mod;
extension_load("libanalytics_ext.so", &mod);
extension_register(&mod);
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ABI-–º–∞—Ä—à–∞–ª–∏–Ω–≥–∞ —á–µ—Ä–µ–∑ FlatBuffers
* –°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ manifest-—Ñ–∞–π–ª—ã
* –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏: eBPF, TPM, —Ü–∏—Ñ—Ä–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å–∏

## üß∞ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –º–æ–¥—É–ª–µ–π —Ä–∞—Å—á—ë—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏, –ª–æ–≥–∏—Å—Ç–∏–∫–∏, –∞—É–¥–∏—Ç–∞
* –í–Ω–µ–¥—Ä–µ–Ω–∏–µ –¥–æ–º–µ–Ω–Ω—ã—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ –±–µ–∑ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –°–£–ë–î

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ò–∑–æ–ª—è—Ü–∏—è —á–µ—Ä–µ–∑ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π scope
* –ü—Ä–æ–≤–µ—Ä–∫–∞ API-—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ –¥–æ—Å—Ç—É–ø –∫ —Å–∏—Å—Ç–µ–º–Ω—ã–º –≤—ã–∑–æ–≤–∞–º (–≤ –±—É–¥—É—â–µ–º —á–µ—Ä–µ–∑ seccomp/eBPF)

## üßæ –°–æ–æ–±—â–µ–Ω–∏—è, –æ—à–∏–±–∫–∏, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

* `ERR_EXT_NOT_FOUND`
* `ERR_EXT_INIT_FAIL`
* `WARN_EXT_UNSAFE_CALL`

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –ó–∞–≥—Ä—É–∑–∫–∞, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –≤—ã–≥—Ä—É–∑–∫–∞
* v1.1 ‚Äî –ö–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Ä—Å–∏–π, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ ABI
* v1.2 ‚Äî –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–µ—Å–æ—á–Ω–∏—Ü–µ–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é

## üìà UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
package "Extension Loader" {
  class ExtensionManager {
    +load(path)
    +register()
    +unload()
  }
  ExtensionManager --> UDFEngine
  ExtensionManager --> MemoryManager
}
@enduml
```
