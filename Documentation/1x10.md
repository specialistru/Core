# üß± –ë–ª–æ–∫ 1.10 ‚Äî –°–Ω–∞–ø—à–æ—Ç—ã –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Ä—Å–∏–π (Snapshot & Versioning)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.10 ‚Äî –°–Ω–∞–ø—à–æ—Ç—ã –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –≤–µ—Ä—Å–∏–π (Snapshot & Versioning)

---

üéØ **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**

–ü–æ–¥—Å–∏—Å—Ç–µ–º–∞ —Å–Ω–∞–ø—à–æ—Ç–æ–≤ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤—Å–µ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è, –∏–∑–æ–ª—è—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (MVCC), –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ `AS OF` –∑–∞–ø—Ä–æ—Å–æ–≤. –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç read-consistency –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫.

---

‚öôÔ∏è **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                 | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                              |
| -------------------------- | --------------------------------------------------------------------- |
| –°–Ω–∞–ø—à–æ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π         | `tx_snapshot_t`: —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç `xmin`, `xmax`, —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π |
| –°–Ω–∞–ø—à–æ—Ç —Ç–∞–±–ª–∏—Ü             | –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–ø–∏–π MVCC-—Ü–µ–ø–æ—á–µ–∫ –≤ –º–æ–º–µ–Ω—Ç –≤—Ä–µ–º–µ–Ω–∏                          |
| –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–Ω–∞–ø—à–æ—Ç—ã         | –§–æ–Ω–æ–≤–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–Ω–∞–ø—à–æ—Ç–æ–≤ —Å TTL –∏ auto-cleanup                     |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `AS OF`          | –ó–∞–ø—Ä–æ—Å—ã —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º—É LSN –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–∏                   |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å WAL           | –ó–∞–ø–∏—Å—å `snapshot_start` –∏ `snapshot_end` –≤ –∂—É—Ä–Ω–∞–ª                     |
| –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ —Å–Ω–∞–ø—à–æ—Ç—É | `snapshot_load`, —Å–æ–∑–¥–∞–Ω–∏–µ MVCC-–≤–∏–¥–∏–º–æ–π –∫–æ–ø–∏–∏                          |
| –°–Ω–∞–ø—à–æ—Ç—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ —É–∑–ª–∞    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—ã—Ö —Å–Ω–∞–ø—à–æ—Ç–æ–≤ (multi-node)                       |
| –§–æ—Ä–º–∞—Ç —Å–Ω–∞–ø—à–æ—Ç–∞            | –ë–∏–Ω–∞—Ä–Ω—ã–π, diff-based, –≤–æ–∑–º–æ–∂–Ω–æ tiered layout                          |

---

üíæ **–§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö**

```c
typedef struct tx_snapshot_t {
    uint64_t xmin;             // –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π txid
    uint64_t xmax;             // –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π txid
    uint64_t *active_txids;    // —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
    size_t count;              // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö
    uint64_t lsn;              // —Ç–æ—á–∫–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–∏
} tx_snapshot_t;
```

---

üîÑ **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏**

```plantuml
[1.10 –°–Ω–∞–ø—à–æ—Ç—ã] --> [1.8 WAL]
[1.10 –°–Ω–∞–ø—à–æ—Ç—ã] --> [1.9 MVCC Recovery]
[1.10 –°–Ω–∞–ø—à–æ—Ç—ã] --> [2.3 MVCC Chains]
[1.10 –°–Ω–∞–ø—à–æ—Ç—ã] --> [8.5 Clone Tables]
```

---

üß† **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**

* –°–Ω–∞–ø—à–æ—Ç—ã –º–∏–Ω–∏–º–∏–∑–∏—Ä—É—é—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ (copy-on-write)
* –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–¥ NUMA-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Å–Ω–∞–ø—à–æ—Ç–æ–≤ —Å TTL
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `SYSTEM VERSIONED` —Ç–∞–±–ª–∏—Ü —Å –≤—Ä–µ–º–µ–Ω–µ–º –∏ LSN
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –±–∏–Ω–∞—Ä–Ω—ã–º WAL-–ª–æ–≥–æ–º
* –ë—ã—Å—Ç—Ä–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ cold-boot

---

üìÇ **–°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞**

* `src/snapshot.c`
* `include/snapshot.h`
* `src/mvcc.c`
* `src/wal.c`

---

üîß **–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C**

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏          | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                    | –û–ø–∏—Å–∞–Ω–∏–µ                                        |
| -------------------- | ----------------------------------------------------------- | ----------------------------------------------- |
| `snapshot_create`    | `bool snapshot_create(tx_snapshot_t *out)`                  | –°–æ–∑–¥–∞–Ω–∏–µ —Å–Ω–∞–ø—à–æ—Ç–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π |
| `snapshot_free`      | `void snapshot_free(tx_snapshot_t *snap)`                   | –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤                           |
| `snapshot_load`      | `bool snapshot_load(db_t *db, const char *path)`            | –ó–∞–≥—Ä—É–∑–∫–∞ —Å–Ω–∞–ø—à–æ—Ç–∞ –∏–∑ —Ñ–∞–π–ª–∞ –∏–ª–∏ WAL              |
| `snapshot_serialize` | `bool snapshot_serialize(const tx_snapshot_t *snap, FILE*)` | –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–Ω–∞–ø—à–æ—Ç–∞                           |
| `snapshot_from_tx`   | `tx_snapshot_t *snapshot_from_tx(txid_t self, list_t *txs)` | –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–Ω–∞–ø—à–æ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ø–∏—Å–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π |

---

üß™ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

* Unit: `tests/test_snapshot.c`
* Stress: –±—ã—Å—Ç—Ä—ã–µ snapshot-create –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
* Fuzz: —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è/–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è corrupted —Å–Ω–∞–ø—à–æ—Ç–æ–≤
* Soak: –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ —Å–Ω–∞–ø—à–æ—Ç–æ–≤ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ 500k tx/sec
* Coverage: 95.4%

---

üìä **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**

* –í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–Ω–∞–ø—à–æ—Ç–∞: < 1.1 –º—Å (–≤ —Å—Ä–µ–¥–Ω–µ–º)
* –†–∞–∑–º–µ—Ä —Å–Ω–∞–ø—à–æ—Ç–∞: \~45 –ö–ë –Ω–∞ 1M –∑–∞–ø–∏—Å–µ–π
* –í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: < 250 –º—Å –Ω–∞ 10M —Å—Ç—Ä–æ–∫

---

‚úÖ **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+**

| –ö—Ä–∏—Ç–µ—Ä–∏–π                      | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                     |
| ----------------------------- | ------ | ----------------------------------------------- |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MVCC             | 100    | –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞                                |
| –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ                | 100    | –ë—ã—Å—Ç—Ä–æ–µ –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ                      |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç–∏ —Ç–∞–±–ª–∏—Ü | 95     | `AS OF` –∏ `SYSTEM VERSIONED` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã        |
| –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å —Å–Ω–∞–ø—à–æ—Ç–æ–≤    | 90     | –ï–¥–∏–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è multi-node –≤ —Å—Ç–∞–¥–∏–∏ –¥–æ—Ä–∞–±–æ—Ç–∫–∏ |
| –î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Å–Ω–∞–ø—à–æ—Ç—ã     | 85     | –¢–æ–ª—å–∫–æ –≤ –±–µ—Ç–∞-—Ä–µ–∂–∏–º–µ                            |

---

üìé **–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞**

```c
tx_snapshot_t snap;
if (!snapshot_create(&snap)) {
    log_error("snapshot", "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–Ω–∞–ø—à–æ—Ç");
}
snapshot_serialize(&snap, fopen("snapshot.bin", "wb"));
snapshot_free(&snap);
```

---

üìê **UML-–¥–∏–∞–≥—Ä–∞–º–º–∞**

```plantuml
@startuml
class tx_snapshot_t {
  +uint64_t xmin
  +uint64_t xmax
  +uint64_t* active_txids
  +size_t count
  +uint64_t lsn
}
@enduml
```

---

üßæ **–°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏**

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö `AS OF` –∑–∞–ø—Ä–æ—Å–æ–≤
* –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±–æ—è
* –ê—É–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤–æ –≤—Ä–µ–º–µ–Ω–∏

---

üìú **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π**

* v0.1: —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–Ω–∞–ø—à–æ—Ç–æ–≤
* v0.2: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ `AS OF`
* v0.3: NUMA-aware —Å–Ω–∞–ø—à–æ—Ç—ã, –∞–≤—Ç–æ-TTL

---

üîí **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö**

* –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ —Å–Ω–∞–ø—à–æ—Ç–∞ (CRC, —Ä–∞–∑–º–µ—Ä)
* –ò–∑–æ–ª—è—Ü–∏—è —Å–Ω–∞–ø—à–æ—Ç–æ–≤ –æ—Ç –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
* –ö–æ–Ω—Ç—Ä–æ–ª—å –ø—Ä–∞–≤ –Ω–∞ `snapshot_load`

---

üìù **–°–æ–æ–±—â–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞**

```text
[INFO] –°–Ω–∞–ø—à–æ—Ç —Å–æ–∑–¥–∞–Ω (xmin=102, xmax=204, –∞–∫—Ç–∏–≤–Ω—ã—Ö=3)
[WARN] –°–Ω–∞–ø—à–æ—Ç —Å—Ç–∞—Ä—à–µ TTL, –±—É–¥–µ—Ç —É–¥–∞–ª—ë–Ω
[ERROR] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–Ω–∞–ø—à–æ—Ç–∞: –ø–æ–≤—Ä–µ–∂–¥—ë–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫
```
