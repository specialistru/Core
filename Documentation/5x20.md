# 5.20 ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫–æ–Ω –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ Time Series (gap-fill, downsampling, retention)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 5 ‚Äî BI, ML –∏ OLAP**
**–ë–ª–æ–∫ 5.20 ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫–æ–Ω –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ Time Series (gap-fill, downsampling, retention)**

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –±–ª–æ–∫ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤ (time series) –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö, –º–µ–Ω—è—é—â–∏—Ö—Å—è –≤–æ –≤—Ä–µ–º–µ–Ω–∏. –≠—Ç–æ –≤–∫–ª—é—á–∞–µ—Ç –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –ø–æ –æ–∫–Ω–∞–º, –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π (`gap-filling`), –∞–≥—Ä–µ–≥–∞—Ü–∏—é –ø–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º (`downsampling`), –∞ —Ç–∞–∫–∂–µ –∫–æ–Ω—Ç—Ä–æ–ª—å –≤—Ä–µ–º–µ–Ω–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è (`retention policies`). –û–Ω —è–≤–ª—è–µ—Ç—Å—è –∫–ª—é—á–µ–≤—ã–º –¥–ª—è —Ä–µ–∞–ª—Ç–∞–π–º-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞, IoT –∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞            | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                |
| --------------------- | ------------------------------------------------------- |
| –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö TimeSeries | –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π TS-—Ç–∏–ø —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –º–µ—Ç–∫–∞–º–∏    |
| Gap-Fill              | –ú–µ—Ç–æ–¥–∏–∫–∞ –ª–∏–Ω–µ–π–Ω–æ–π/–Ω—É–ª–µ–≤–æ–π/–ø—Ä–µ–¥–∏–∫—Ç–∏–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏     |
| Downsampling          | RESAMPLE, TIME\_BUCKET, AVG, MIN, MAX, SUM              |
| Retention Policy      | TTL, auto-eviction –ø–æ age / size                        |
| Time-Based Windows    | TUMBLE, HOP, SLIDE –¥–ª—è –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ SQL              |
| SQL-—Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è        | `WITH GAP_FILL`, `ASOF`, `RESAMPLE BY`, `INTERVAL JOIN` |

## üíæ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct ts_entry_t {
  timestamp_ns_t ts;
  double value;
  uint8_t quality;
} ts_entry_t;

typedef struct ts_series_t {
  char name[MAX_NAME];
  ts_entry_t *data;
  size_t len;
  ts_metadata_t meta;
} ts_series_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
TimeSeriesEngine --> ColumnStore
TimeSeriesEngine --> SQLExecutor
TimeSeriesEngine --> CompressionEngine
TimeSeriesEngine --> RetentionManager
SQLExecutor --> TimeSeriesFunctions
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* NUMA-aware —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–∏—Ç–º–∞–ø –∏ dictionary compression
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ (timestamp\_ns\_t)
* –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä—ã —Å SIMD
* –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π runtime gap-fill —á–µ—Ä–µ–∑ SQL AST-–ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/timeseries/ts_engine.c`
* `src/sql/ts_functions.c`
* `src/storage/retention.c`
* `include/timeseries/ts_types.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è                | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                         | –û–ø–∏—Å–∞–Ω–∏–µ                                        |
| ------------------ | ---------------------------------------------------------------- | ----------------------------------------------- |
| `ts_insert`        | `int ts_insert(ts_series_t *s, timestamp_ns_t ts, double value)` | –í—Å—Ç–∞–≤–∫–∞ –Ω–æ–≤–æ–π —Ç–æ—á–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ä—è–¥–∞             |
| `ts_gap_fill`      | `int ts_gap_fill(ts_series_t *s, ts_policy_t policy)`            | –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π               |
| `ts_downsample`    | `int ts_downsample(ts_series_t *s, interval_t i, agg_t agg)`     | Downsampling —Å –∑–∞–¥–∞–Ω–Ω–æ–π –∞–≥—Ä–µ–≥–∞—Ü–∏–µ–π              |
| `ts_retention_run` | `void ts_retention_run()`                                        | –£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º —Ö—Ä–∞–Ω–µ–Ω–∏—è |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/timeseries/test_ts_engine.c`
* Fuzz: –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã —Å –≥—Ä–∞–Ω–∏—á–Ω—ã–º–∏ timestamp
* Soak: –º–Ω–æ–≥–æ–Ω–µ–¥–µ–ª—å–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞ –∏ downsampling
* Coverage: >93%

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è            | –ú–µ—Ç—Ä–∏–∫–∞          |
| ------------------- | ---------------- |
| –í—Å—Ç–∞–≤–∫–∞ 1M —Ç–æ—á–µ–∫    | \~310K —Ç–æ—á–µ–∫/—Å–µ–∫ |
| Gap-fill (linear)   | < 2.1 –º—Å –Ω–∞ 100K |
| Downsample (1h avg) | < 3.4 –º—Å –Ω–∞ 1M   |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π       | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                  |
| -------------- | ------ | -------------------------------------------- |
| TimeSeries —Ç–∏–ø | 100    | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é –¥–æ –Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥         |
| Gap-filling    | 100    | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç linear/forward-fill             |
| Downsampling   | 100    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ SQL –∏ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–π –∞–≥—Ä–µ–≥–∞—Ü–∏–∏        |
| Retention/TTL  | 100    | –ß–µ—Ä–µ–∑ RetentionManager                       |
| SQL-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è | 100    | `WITH GAP_FILL`, `RESAMPLE`, `INTERVAL JOIN` |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```sql
-- –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø—É—Å–∫–æ–≤ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ —á–∞—Å—É
SELECT time_bucket('1 hour', ts) AS bucket,
       AVG(value) AS avg_val
FROM sensor_data
WITH GAP_FILL
WHERE ts BETWEEN now() - interval '1 day' AND now()
GROUP BY bucket;
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Prometheus exposition format
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ irregular time ranges
* TSML/AutoML forecast –∏–∑ —Ä—è–¥–∞

## üìä UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity "TimeSeriesEngine"
entity "SQLExecutor"
entity "ColumnStore"
entity "RetentionManager"
entity "CompressionEngine"

SQLExecutor --> TimeSeriesEngine
TimeSeriesEngine --> ColumnStore
TimeSeriesEngine --> RetentionManager
TimeSeriesEngine --> CompressionEngine
@enduml
```

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø—Ä–æ—Å–∞, –æ—Ç–∫–∞–∑–æ–≤ –∏ –∑–∞–≥—Ä—É–∑–∫–∏
* –ê–≥—Ä–µ–≥–∞—Ü–∏–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–º –æ–∫–Ω–∞–º –¥–ª—è BI
* –û—Ç—á—ë—Ç—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ —Ç—Ä–µ–Ω–¥–∞–º
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ IoT, —Å–µ–Ω—Å–æ—Ä–Ω—ã—Ö –∏ –ª–æ–≥-—Å–æ–±—ã—Ç–∏–π

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ü–æ–ª–∏—Ç–∏–∫–∏ TTL –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —É—Ç–µ—á–µ–∫
* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ —Ä–æ–ª—è–º –Ω–∞ series INSERT
* –ò–∑–æ–ª—è—Ü–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–º –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º –ø—Ä–∏ JOIN

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ time\_bucket –∏ AVG
* v1.1 ‚Äî gap\_fill linear –∏ zero
* v1.2 ‚Äî TTL –∏ RetentionEngine
* v1.3 ‚Äî SQL-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å WITH GAP\_FILL

## üõë –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

| –ö–æ–¥ / –¢–∏–ø         | –£—Å–ª–æ–≤–∏–µ                      | –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏                    |
| ----------------- | ---------------------------- | ---------------------------------- |
| `E_TS_INVALID_TS` | –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç timestamp    | –û–∂–∏–¥–∞–µ—Ç—Å—è timestamp –≤ –Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥–∞—Ö |
| `E_TS_TOO_OLD`    | –î–∞–Ω–Ω—ã–µ —É—Å—Ç–∞—Ä–µ–ª–∏ –ø–æ TTL       | –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è        |
| `W_TS_NO_DATA`    | –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è | –í–µ—Ä–Ω—ë—Ç—Å—è NULL                      |


