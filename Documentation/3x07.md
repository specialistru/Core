# üß± –ë–ª–æ–∫ 3.3 ‚Äî –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã, —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ exec hooks

---
–í–æ—Ç –±–ª–æ–∫ **3.7 ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–∫–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π, ROLLUP –∏ CUBE**:

---

## üìò 3.7 ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–∫–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π, ROLLUP –∏ CUBE

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* –ü–∞–∫–µ—Ç 3 ‚Äî SQL –∏ –Ø–∑—ã–∫–∏
* –ë–ª–æ–∫ 3.7 ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–∫–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π, ROLLUP –∏ CUBE

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–≠—Ç–æ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å SQL: –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (`OVER`), –∞–≥—Ä–µ–≥–∞—Ç—ã —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞–º–∏ `ROLLUP` –∏ `CUBE`, –∞ —Ç–∞–∫–∂–µ –∏—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏. –≠—Ç–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∫—Ä–∏—Ç–∏—á–Ω—ã –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è OLAP-–æ—Ç—á—ë—Ç–æ–≤, BI-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ —Å–ª–æ–∂–Ω–æ–π –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –ø–æ—Å—Ç–æ–±—Ä–∞–±–æ—Ç–∫–∏.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞            | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                    |
| --------------------- | --------------------------------------------------------------------------- |
| –û–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏       | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ROWS/RANGE, PARTITION BY, ORDER BY, frame types                   |
| –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ | RANK, DENSE\_RANK, NTILE, LAG, LEAD, FIRST\_VALUE, LAST\_VALUE              |
| ROLLUP                | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏—Ö –≥—Ä—É–ø–ø–∏—Ä–æ–≤–æ–∫                          |
| CUBE                  | –ü–æ–ª–Ω–∞—è –¥–µ–∫–∞—Ä—Ç–æ–≤–∞ –∞–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ –≤—Å–µ–º –∫–æ–º–±–∏–Ω–∞—Ü–∏—è–º –≥—Ä—É–ø–ø                        |
| GROUPING SETS         | –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö –≥—Ä—É–ø–ø–∏—Ä–æ–≤–æ–∫ —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –∞–≥—Ä–µ–≥–∞—Ç–æ–≤ |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct window_frame_t {
    int64_t start_offset;
    int64_t end_offset;
    bool is_rows;
} window_frame_t;

typedef struct rollup_group_t {
    int *group_cols;
    size_t num_levels;
} rollup_group_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[SQL Parser] --> [Window Function Planner]
[Window Function Planner] --> [Executor Engine]
[ROLLUP/CUBE Planner] --> [Aggregator]
[Aggregator] --> [Columnar Store]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö frame modes: UNBOUNDED, CURRENT ROW, N PRECEDING/FOLLOWING
* –í–µ–∫—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–∫–æ–Ω–Ω—ã—Ö –∞–≥—Ä–µ–≥–∞—Ç–æ–≤
* –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–π CUBE-–ø–æ–¥—Å—á—ë—Ç –±–µ–∑ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö –ø–µ—Ä–µ—Å—á—ë—Ç–æ–≤
* Pushdown ROLLUP –≤ planner –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è materialize-—ç—Ç–∞–ø–æ–≤
* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è GROUPING SETS

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/sql/window/window_exec.c`
* `src/sql/aggregate/rollup_cube.c`
* `include/sql/window/window_frame.h`
* `include/sql/aggregate/grouping_sets.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏        | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                     | –û–ø–∏—Å–∞–Ω–∏–µ                                        |
| ------------------ | ------------------------------------------------------------ | ----------------------------------------------- |
| `exec_window_func` | `int exec_window_func(window_ctx_t *ctx, const row_t *row);` | –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–∫–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞–¥ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–æ–∫–æ–π  |
| `plan_rollup`      | `group_plan_t* plan_rollup(group_ctx_t *ctx);`               | –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–π –∞–≥—Ä–µ–≥–∞—Ü–∏–∏        |
| `exec_cube`        | `int exec_cube(cube_ctx_t *ctx, row_batch_t *input);`        | –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–≥—Ä–µ–≥–∞—Ç–æ–≤ –ø–æ –≤—Å–µ–º –∫–æ–º–±–∏–Ω–∞—Ü–∏—è–º        |
| `grouping_id`      | `uint32_t grouping_id(const group_ctx_t *ctx);`              | –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –≥—Ä—É–ø–ø—ã (GROUPING\_ID) |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã: `tests/sql/window_test.c`, `tests/sql/grouping_test.c`
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ: `ROLLUP + HAVING`, `CUBE + ORDER`, `window join lateral`
* Fuzzing: —Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏—è frame –≥—Ä–∞–Ω–∏—Ü, —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö, –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏—Ö—Å—è –∞–≥—Ä–µ–≥–∞—Ç–æ–≤
* Soak: –æ—Ç—á—ë—Ç—ã BI-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Å –º–Ω–æ–≥–æ–≥—Ä—É–ø–ø–æ–≤—ã–º–∏ –∞–≥—Ä–µ–≥–∞—Ç–∞–º–∏

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* –í–µ–∫—Ç–æ—Ä–Ω—ã–π executor: 5‚Äì20 –º–ª–Ω —Å—Ç—Ä–æ–∫/—Å–µ–∫ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –æ–∫–æ–Ω–Ω—ã—Ö –∞–≥—Ä–µ–≥–∞—Ç–æ–≤
* –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π `CUBE`: \~10√ó –±—ã—Å—Ç—Ä–µ–µ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø–æ–ª–Ω—ã–º –≤–ª–æ–∂–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º
* ROLLUP: auto-prune –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ \~30% –≤ –≥–ª—É–±–æ–∫–æ–π –∏–µ—Ä–∞—Ä—Ö–∏–∏

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π        | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                          |
| --------------- | ------ | ---------------------------------------------------- |
| –û–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ | 100    | –ü–æ–ª–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö frame, PARTITION BY, ORDER BY |
| ROLLUP          | 95     | –ê–≤—Ç–æ–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è, pushdown –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—è —Å –∏–µ—Ä–∞—Ä—Ö–∏–µ–π    |
| CUBE            | 90     | –ë—ã—Å—Ç—Ä–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –ø–æ–∫–∞ –±–µ–∑ GPU-—É—Å–∫–æ—Ä–µ–Ω–∏—è           |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
exec_window_func(&ctx, row);
exec_cube(&cube_ctx, batch);
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–∫–æ–Ω–Ω—ã—Ö –∞–≥—Ä–µ–≥–∞—Ç–æ–≤ –Ω–∞–¥ –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏ (time-bucketed)
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è–º–∏ –¥–ª—è pre-aggregates
* GPU-—É—Å–∫–æ—Ä–µ–Ω–∏–µ –¥–ª—è –æ–∫–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –≤ OLAP-—Ä–µ–∂–∏–º–µ

## üß∞ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –†–∞—Å—á—ë—Ç—ã –≤ BI-–¥—ç—à–±–æ—Ä–¥–∞—Ö: —Å–∫–æ–ª—å–∑—è—â–∏–µ —Å—É–º–º—ã, —Å—Ä–µ–¥–Ω–∏–µ, —Ä–∞–Ω–≥–∏
* –ò–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–µ –æ—Ç—á—ë—Ç—ã (–ø–æ –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏, –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º, —É—Ä–æ–≤–Ω—è–º)
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ KPI-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ OLAP drill-down

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ –æ–∫–æ–Ω–Ω—ã—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
* –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ max frame size, row count
* –ó–∞—â–∏—Ç–∞ –æ—Ç –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –∞–≥—Ä–µ–≥–∞—Ü–∏–π (LIMIT/GROUP –∫–æ–Ω—Ç—Ä–æ–ª—å)

## üßæ –°–æ–æ–±—â–µ–Ω–∏—è, –æ—à–∏–±–∫–∏, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

* `ERR_FRAME_BOUND_INVALID`
* `WARN_CUBE_ROWS_EXCEEDED`
* `INFO_ROLLUP_AGG_STARTED`

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî PARTITION BY, frame modes, basic ROLLUP
* v1.1 ‚Äî GROUPING SETS, CUBE, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π
* v1.2 ‚Äî GROUPING\_ID, dynamic frame evaluation

## üìà UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
package "Analytics SQL" {
  class WindowExecutor {
    +exec()
    +rank()
  }
  class GroupingPlanner {
    +plan_rollup()
    +plan_cube()
  }
  WindowExecutor --> RowBatch
  GroupingPlanner --> Aggregator
}
@enduml
```

---

üü¢ –ì–æ—Ç–æ–≤ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –±–ª–æ–∫–æ–º **3.8 ‚Äî JSON –∏ semi-structured —Ñ—É–Ω–∫—Ü–∏–∏ SQL** ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ **–¥–∞**.

