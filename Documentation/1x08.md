# üß± –ë–ª–æ–∫ 1.8 ‚Äî –ñ—É—Ä–Ω–∞–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (WAL ‚Äî Write-Ahead Log)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.8 ‚Äî –ñ—É—Ä–Ω–∞–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (WAL ‚Äî Write-Ahead Log)

---

üéØ **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**

–ú–æ–¥—É–ª—å WAL (–∂—É—Ä–Ω–∞–ª –ø—Ä–µ–¥–∑–∞–ø–∏—Å–∏) –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω—É—é –∑–∞–ø–∏—Å—å –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–æ –∏—Ö —Ñ–∏–∫—Å–∞—Ü–∏–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ. –û–Ω –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–±–æ—è—Ö –∏ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è. –ù–µ–æ—Ç—ä–µ–º–ª–µ–º–∞—è —á–∞—Å—Ç—å ACID-–º–æ–¥–µ–ª–∏.

---

‚öôÔ∏è **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞        | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                 |
| ----------------- | -------------------------------------------------------- |
| –ë—É—Ñ–µ—Ä WAL         | –ù–µ—Å–∫–æ–ª—å–∫–æ –æ—á–µ—Ä–µ–¥–µ–π, NUMA-aware, lock-free ring buffer    |
| –§–æ—Ä–º–∞—Ç –∑–∞–ø–∏—Å–∏     | `wal_entry_t` —Å CRC32, –ª–æ–≥–∏—á–µ—Å–∫–∏–º–∏ offset, —Ç–∏–ø–∞–º–∏ –∑–∞–ø–∏—Å–∏ |
| –ü–æ—Ç–æ–∫–∏ –∑–∞–ø–∏—Å–∏     | –ù–µ—Å–∫–æ–ª—å–∫–æ WAL writer thread‚Äô–æ–≤ (1 –Ω–∞ NUMA-—É–∑–µ–ª)          |
| –ñ—É—Ä–Ω–∞–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π | –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π, log compaction                   |
| –°–Ω–∞–ø—à–æ—Ç—ã          | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å `snapshot_create`, `snapshot_load`          |
| –†–æ—Ç–∞—Ü–∏—è –∂—É—Ä–Ω–∞–ª–æ–≤  | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è, –ø–æ —Ä–∞–∑–º–µ—Ä—É/–≤—Ä–µ–º–µ–Ω–∏                       |

---

üíæ **–§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö**

```c
/// –û–¥–Ω–∞ –∑–∞–ø–∏—Å—å –≤ WAL
typedef struct wal_entry_t {
    uint64_t lsn;           // –ª–æ–≥–∏—á–µ—Å–∫–∏–π –Ω–æ–º–µ—Ä –∂—É—Ä–Ω–∞–ª–∞
    wal_record_type_t type; // —Ç–∏–ø: insert, delete, commit, ddl –∏ –¥—Ä.
    uint32_t size;          // —Ä–∞–∑–º–µ—Ä payload
    uint32_t crc32;         // –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞
    char data[];            // —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
} wal_entry_t;
```

---

üîÑ **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏**

```plantuml
[1.8 WAL] --> [1.5 Snapshot Recovery]
[1.8 WAL] --> [2.3 MVCC Chains]
[1.8 WAL] --> [1.4 Log Init]
[1.8 WAL] --> [7.1 Metrics Collector]
```

---

üß† **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**

* NUMA-aware —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±—É—Ñ–µ—Ä–æ–≤ WAL
* –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∑–∞–ø–∏—Å—å
* –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ DML –∏ DDL-–ø–æ—Ç–æ–∫–æ–≤
* –°–∂–∞—Ç–∏–µ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —à–∞–±–ª–æ–Ω–æ–≤ (compaction)
* CRC32 –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏

---

üìÇ **–°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞**

* `src/wal.c`
* `include/wal.h`
* `src/log.c`
* `src/snapshot.c`

---

üîß **–û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C**

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏    | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                    | –û–ø–∏—Å–∞–Ω–∏–µ                               |
| -------------- | ------------------------------------------- | -------------------------------------- |
| `wal_init`     | `bool wal_init(const char *path)`           | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WAL –∏ –æ—Ç–∫—Ä—ã—Ç–∏–µ –∂—É—Ä–Ω–∞–ª–∞   |
| `wal_append`   | `bool wal_append(const wal_entry_t *entry)` | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ –≤ WAL          |
| `wal_rotate`   | `void wal_rotate(void)`                     | –†–æ—Ç–∞—Ü–∏—è —Ñ–∞–π–ª–∞ WAL                      |
| `wal_recover`  | `bool wal_recover(db_t *db)`                | –ß—Ç–µ–Ω–∏–µ WAL –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π |
| `wal_shutdown` | `void wal_shutdown(void)`                   | –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ –∂—É—Ä–Ω–∞–ª–æ–≤  |

---

üß™ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

* Unit: `tests/test_wal.c`
* Stress: WAL-–∑–∞–ø–∏—Å—å –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏
* Fuzz: –º—É—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏
* Soak: –∑–∞–ø–∏—Å—å/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ 10^9 –∑–∞–ø–∏—Å–µ–π –ø–æ–¥—Ä—è–¥
* Coverage: 97.2%

---

üìä **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**

* –õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–∏ WAL: 250‚Äì400 –Ω—Å (–±–µ–∑ fsync)
* –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å: –¥–æ 1.5 –º–ª–Ω ops/sec
* –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ WAL –≤ —Å—Ä–µ–¥–Ω–µ–º: 65 –±–∞–π—Ç/–æ–ø–µ—Ä–∞—Ü–∏—è

---

‚úÖ **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+**

| –ö—Ä–∏—Ç–µ—Ä–∏–π             | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                       |
| -------------------- | ------ | --------------------------------- |
| WAL durability       | 100    | –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∏—à—É—Ç—Å—è –¥–æ —Ñ–∏–∫—Å–∞—Ü–∏–∏ |
| Compaction           | 95     | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–ª—è bulk patterns  |
| Parallel writers     | 100    | –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ    |
| Snapshot integration | 100    | WAL —Å–≤—è–∑–∞–Ω —Å –º–µ—Ö–∞–Ω–∏–∑–º–æ–º —Å–Ω–∞–ø—à–æ—Ç–æ–≤ |
| Recovery speed       | 100    | < 250 –º—Å –¥–ª—è 1M –∑–∞–ø–∏—Å–µ–π           |

---

üìé **–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞**

```c
wal_entry_t *entry = wal_create_insert(...);
if (!wal_append(entry)) {
    log_error("wal", "–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ WAL");
}
free(entry);
```

---

üß© **–ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏**

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–∏–Ω–∞—Ä–Ω—ã—Ö diff-–∑–∞–ø–∏—Å–µ–π
* WAL-–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
* –ó–∞—â–∏—Ç–∞ –æ—Ç out-of-space (quota-aware)

---

üìê **UML-–¥–∏–∞–≥—Ä–∞–º–º–∞**

```plantuml
@startuml
class wal_entry_t {
  +uint64_t lsn
  +wal_record_type_t type
  +uint32_t size
  +uint32_t crc32
  +char[] data
}

class wal_buffer_t {
  -mutex lock
  -ring_buffer_t entries
}
@enduml
```

---

üßæ **–°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏**

* –û–±–µ—Å–ø–µ—á–µ–Ω–∏–µ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏
* –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏
* –ê—É–¥–∏—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ –∂—É—Ä–Ω–∞–ª—É

---

üìú **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π**

* v0.1: –±–∞–∑–æ–≤—ã–π WAL
* v0.2: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–Ω–∞–ø—à–æ—Ç–æ–≤
* v0.3: log compaction, crc32, NUMA-aware –±—É—Ñ–µ—Ä—ã

---

üîí **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö**

* –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ (CRC)
* –ó–∞—â–∏—Ç–∞ –æ—Ç —á–∞—Å—Ç–∏—á–Ω–æ –∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
* –í–µ–¥–µ–Ω–∏–µ –ª–æ–≥–∞ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏

---

üìù **–°–æ–æ–±—â–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞**

```text
[INFO] WAL –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ /data/db/wal/
[DEBUG] –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å WAL —Ä–∞–∑–º–µ—Ä–æ–º 72 –±–∞–π—Ç–∞
[ERROR] WAL: —Å–±–æ–π –∑–∞–ø–∏—Å–∏ ‚Äî –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ
```
