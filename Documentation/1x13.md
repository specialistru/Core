# üß± –ë–ª–æ–∫ 1.13 ‚Äî –ë—É—Ñ–µ—Ä–Ω–∞—è –∑–æ–Ω–∞ (Buffer Pool / Page Cache)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 1 ‚Äî –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –•—Ä–∞–Ω–∏–ª–∏—â–µ
* **–ë–ª–æ–∫:** 1.13 ‚Äî –ë—É—Ñ–µ—Ä–Ω–∞—è –∑–æ–Ω–∞ (Buffer Pool / Page Cache)

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë—É—Ñ–µ—Ä–Ω–∞—è –∑–æ–Ω–∞ (Buffer Pool) –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü —Ç–∞–±–ª–∏—Ü –∏ –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ –ø–∞–º—è—Ç–∏, —Å —Ü–µ–ª—å—é –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ NVMe-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º –≤ —Å–ª—É—á–∞—è—Ö, –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã–µ –≤—ã—Ç–µ—Å–Ω—è—é—Ç—Å—è –∏–∑ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ (in-memory fallback). –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å "–≥–æ—Ä—è—á–∏—Ö" —Å—Ç—Ä–∞–Ω–∏—Ü, —É—Å–∫–æ—Ä—è–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±–æ—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º—ã –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –≤—ã–±–æ—Ä–∫–∏ (prefetch).

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞        | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                   |
| ----------------- | ---------------------------------------------------------- |
| –ó–∞–º–µ—â–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü | –ê–ª–≥–æ—Ä–∏—Ç–º—ã LRU, ARC —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ |
| Dirty tracking    | –§–ª–∞–≥–∏ dirty/clean, —Ñ–æ–Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è                   |
| Prefetch          | –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É—é—â–∏–π prefetch –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º –¥–æ—Å—Ç—É–ø–∞               |
| NUMA-awareness    | Page placement, CPU-affinity –∏ memory locality             |
| –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å   | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ snapshot –∏ –≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü                  |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct page_t {
    uint64_t page_id;
    uint8_t *data;
    bool dirty;
    uint64_t last_access_ns;
    uint32_t pin_count;
    numa_node_t numa_node;
} page_t;

typedef struct buffer_pool_t {
    page_t **pages;
    size_t capacity;
    eviction_policy_t policy; // LRU –∏–ª–∏ ARC
    rwlock_t lock;
} buffer_pool_t;
```

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
buffer_pool --> storage_engine
buffer_pool --> wal
buffer_pool --> snapshot_manager
buffer_pool --> eviction_manager
buffer_pool --> metrics_collector
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –Ω–∞ —è–∑—ã–∫–µ **C23**
* –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–æ–¥ **NUMA-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É** –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü
* **Prefetch** –∏ **page coloring** —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ –º–æ–¥—É–ª–µ `prefetch.c`
* –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–º–µ–µ—Ç –≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å (snapshot\_id) –∏ dirty-—Ñ–ª–∞–≥
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ **pin/unpin API** –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/storage/buffer_pool.c`
* `include/storage/buffer_pool.h`
* `src/storage/eviction.c`
* `src/utils/prefetch.c`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –§—É–Ω–∫—Ü–∏—è                   | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                 | –û–ø–∏—Å–∞–Ω–∏–µ                             |
| ------------------------- | ------------------------------------------------------------------------ | ------------------------------------ |
| `buffer_pool_init`        | `bool buffer_pool_init(size_t capacity, eviction_policy_t policy)`       | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—É–ª–∞ —Å—Ç—Ä–∞–Ω–∏—Ü           |
| `buffer_pool_get_page`    | `page_t *buffer_pool_get_page(uint64_t page_id, bool create_if_missing)` | –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã      |
| `buffer_pool_mark_dirty`  | `void buffer_pool_mark_dirty(page_t *page)`                              | –ü–æ–º–µ—Ç–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞–∫ –∏–∑–º–µ–Ω—ë–Ω–Ω–æ–π      |
| `buffer_pool_evict`       | `void buffer_pool_evict()`                                               | –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤—ã—Ç–µ—Å–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü    |
| `buffer_pool_flush_dirty` | `void buffer_pool_flush_dirty()`                                         | –§–æ–Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å dirty-—Å—Ç—Ä–∞–Ω–∏—Ü –Ω–∞ –¥–∏—Å–∫ |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* **–Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã**: `tests/test_buffer_pool.c`
* **Fuzzing**: –≤—Å—Ç–∞–≤–∫–∞ —Å–ª—É—á–∞–π–Ω—ã—Ö `page_id` –∏ `evict` –æ–ø–µ—Ä–∞—Ü–∏–π
* **Soak**: –Ω–∞–≥—Ä—É–∑–∫–∞ 30M+ –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞ —Å—É—Ç–∫–∏
* **Coverage**: > 94% –ø–æ–∫—Ä—ã—Ç–∏–µ
* **Mutation**: —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ eviction policy

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                          | –ó–Ω–∞—á–µ–Ω–∏–µ                           |
| -------------------------------- | ---------------------------------- |
| –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–µ | \~95 –Ω—Å (–≥–æ—Ä—è—á–∞—è –ø–∞–º—è—Ç—å)           |
| –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –≤—ã—Ç–µ—Å–Ω–µ–Ω–∏—è         | \~99.7% –ø–æ–ø–∞–¥–∞–Ω–∏—è –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º LRU |
| –ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –¥–æ—Å—Ç—É–ø–∞              | –¥–æ 128 –ø–æ—Ç–æ–∫–æ–≤                     |
| –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å           | 2.1 –º–ª–Ω —Å—Ç—Ä–∞–Ω–∏—Ü/—Å                  |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                   | –û—Ü–µ–Ω–∫–∞ (0‚Äì100) | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                 |
| -------------------------- | -------------- | ------------------------------------------- |
| NUMA-awareness             | 100            | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç affinity –∏ node-aware allocation |
| –í—ã—Ç–µ—Å–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü         | 100            | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ LRU –∏ ARC                         |
| Dirty tracking             | 100            | –§–æ–Ω–æ–≤—ã–π sync –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å consistency         |
| Prefetch / –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ | 95             | –†–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º |
| –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å         | 100            | >2 –º–ª–Ω —Å—Ç—Ä–∞–Ω–∏—Ü/—Å–µ–∫                          |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
page_t *page = buffer_pool_get_page(12345, true);
memcpy(page->data, new_data, PAGE_SIZE);
buffer_pool_mark_dirty(page);
```

---

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –£–ª—É—á—à–µ–Ω–∏–µ prefetch —á–µ—Ä–µ–∑ ML-–ø–∞—Ç—Ç–µ—Ä–Ω—ã
* –ì–∏–±—Ä–∏–¥–Ω—ã–π eviction —Å —É—á–µ—Ç–æ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–π –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏
* –û—Ç–ª–∞–¥–∫–∞ NUMA hot-spots –Ω–∞ –º–Ω–æ–≥–æ—Å–æ–∫–µ—Ç–Ω—ã—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞—Ö

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –°—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞—â–∏—â–µ–Ω—ã `rwlock`
* Dirty —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —Å WAL
* Snapshot —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç consistent view

---

## üõ∞Ô∏è –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ì–∞—Ä–∞–Ω—Ç–∏—è –±—ã—Å—Ç—Ä–æ–π —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ OLTP/OLAP-–∑–∞–ø—Ä–æ—Å—ã
* –ù–∏–∑–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –¥–æ—Å—Ç—É–ø–µ –∫ "–≥–æ—Ä—è—á–∏–º" –¥–∞–Ω–Ω—ã–º

---

## üóÇÔ∏è –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* –í–µ—Ä—Å–∏—è: `v1.0`
* –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: `26.07.2025`
* –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: `storage_team_lead@domain`

---

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
class buffer_pool_t {
  +page_t **pages
  +size_t capacity
  +eviction_policy_t policy
  +rwlock_t lock
}

class page_t {
  +uint64_t page_id
  +uint8_t *data
  +bool dirty
  +uint64_t last_access_ns
  +uint32_t pin_count
  +numa_node_t numa_node
}

buffer_pool_t --> page_t : —Å–æ–¥–µ—Ä–∂–∏—Ç
@enduml
```
