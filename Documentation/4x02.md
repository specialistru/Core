## üìò 4.2 ‚Äî REST, gRPC –∏ JSON\:API

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* –ü–∞–∫–µ—Ç 4 ‚Äî –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
* –ë–ª–æ–∫ 4.2 ‚Äî REST, gRPC –∏ JSON\:API

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏ –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏ —á–µ—Ä–µ–∑ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ API-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã: REST (Representational State Transfer), gRPC (Google Remote Procedure Calls) –∏ JSON\:API (—Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö). –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –º–æ–±–∏–ª—å–Ω—ã–º–∏, –æ–±–ª–∞—á–Ω—ã–º–∏, –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏ –∏ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π, –∞ —Ç–∞–∫–∂–µ –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º –≤ —Ñ–æ—Ä–º–∞—Ç–µ, —É–¥–æ–±–Ω–æ–º –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞     | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                 |
| -------------- | ------------------------------------------------------------------------ |
| REST API       | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ OpenAPI 3.0, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è JWT, CORS, —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è JSON          |
| gRPC           | –ü—Ä–æ—Ç–æ—Ñ–∞–π–ª—ã, —Å–∂–∞—Ç–∏–µ, –¥–≤—É–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç—Ä–∏–º—ã, –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ |
| JSON\:API      | –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–≤–µ—Ä—Ö REST, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–≤—è–∑–µ–π, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏, –ø–∞–≥–∏–Ω–∞—Ü–∏–∏       |
| –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ RPC | –í—ã–∑–æ–≤—ã –ø—Ä–æ—Ü–µ–¥—É—Ä, –æ–ø–µ—Ä–∞—Ü–∏–π –Ω–∞–¥ —Ç–∞–±–ª–∏—Ü–∞–º–∏, –º–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è                 |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å   | Rate limiting, –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è, HTTPS (TLS 1.3), scoped tokens            |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä—ã:

* REST / JSON\:API ‚Äî `json_serialize_row(...)` ‚Üí `application/json`
* gRPC ‚Äî `protobuf` —Å—Ö–µ–º—ã, –¥–≤–æ–∏—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç

```c
typedef struct rest_request_t {
    http_method_t method;
    char *path;
    json_value_t *payload;
    auth_context_t *auth;
} rest_request_t;

typedef struct grpc_call_t {
    char *method_name;
    void *protobuf_payload;
    grpc_metadata_t *meta;
} grpc_call_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[REST Gateway] --> [SQL Engine]
[gRPC Endpoint] --> [Executor]
[REST Gateway] --> [Auth Engine]
[REST Gateway] --> [Query Router]
[gRPC Endpoint] --> [Metrics & Tracing]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* REST —Å–µ—Ä–≤–µ—Ä –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ `libmicrohttpd`, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç async worker pool
* gRPC –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `grpc-c` runtime, —Å multiplexed channels
* JSON\:API —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –∏ –ø–∞–≥–∏–Ω–∞—Ü–∏—é –ø–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ 1.1
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ trace-id –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
* REST –æ—Ç–≤–µ—Ç –∫—ç—à–∏—Ä—É–µ–º –ø—Ä–∏ GET + ETag, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Ä–æ–≤–Ω—è –∑–∞–ø—Ä–æ—Å–∞

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/net/rest_api.c`
* `include/net/rest_api.h`
* `src/net/grpc_server.c`
* `include/net/grpc_server.h`
* `src/json/json_api.c`
* `include/json/json_api.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏           | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                  | –û–ø–∏—Å–∞–Ω–∏–µ                      |
| --------------------- | --------------------------------------------------------- | ----------------------------- |
| `rest_handle_request` | `int rest_handle_request(rest_request_t *req);`           | –û–±—Ä–∞–±–æ—Ç–∫–∞ REST-–∑–∞–ø—Ä–æ—Å–∞        |
| `grpc_dispatch_call`  | `int grpc_dispatch_call(grpc_call_t *call);`              | –í—ã–∑–æ–≤ gRPC-–º–µ—Ç–æ–¥–∞             |
| `jsonapi_serialize`   | `int jsonapi_serialize(table_t *table, json_buf_t *out);` | –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ JSON\:API-–æ—Ç–≤–µ—Ç–∞ |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* REST: `tests/net/rest_test.c` ‚Äî —Å–∏–º—É–ª—è—Ü–∏—è HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤
* gRPC: `tests/net/grpc_test.c`, Protobuf mocking
* JSON\:API: —Ç–µ—Å—Ç—ã —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏—é –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ curl / grpcurl
* –ü–æ–∫—Ä—ã—Ç–∏–µ: \~88% –¥–ª—è REST/gRPC, \~94% –¥–ª—è JSON\:API –º–æ–¥—É–ª—è

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* REST latency (GET): \~0.8 –º—Å (–Ω–∞ 95 –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª–µ)
* gRPC call: 250K –≤—ã–∑–æ–≤–æ–≤/—Å–µ–∫ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –æ–¥–Ω–æ–≥–æ —É–∑–ª–∞
* JSON\:API: \~90K —Å—Ç—Ä–æ–∫/—Å–µ–∫, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è < 1.5 –º—Å

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π  | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                  |
| --------- | ------ | -------------------------------------------- |
| REST API  | 95     | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ OpenAPI, ETag, –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –≤—ã–∑–æ–≤—ã   |
| gRPC      | 90     | –°—Ç—Ä–∏–º–∏–Ω–≥, TLS, –Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è introspection |
| JSON\:API | 100    | –ü–æ–ª–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞              |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```bash
curl -H "Authorization: Bearer $TOKEN" \
     "https://db.local/api/v1/orders?filter[status]=active"
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* WebSocket-API –¥–ª—è real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
* GraphQL —Å–ª–æ–π –ø–æ–≤–µ—Ä—Ö REST/SQL —è–¥—Ä–∞
* REST-–ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ (Explain JSON + Timeline)

## üß∞ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å ERP UI (SAP Fiori, WebUI)
* REST/gRPC –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º–∏ –ª–æ–≥–∏—Å—Ç–∏–∫–∏, —Ä–∞—Å—á—ë—Ç–æ–≤, –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
* JSON\:API ‚Äî –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ BI –∏ –æ—Ç—á—ë—Ç–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* HTTPS-only + TLS 1.3
* Scoped access tokens, –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
* –ó–∞—â–∏—Ç–∞ –æ—Ç SQL-–∏–Ω—ä–µ–∫—Ü–∏–π –∏ DoS (–ª–∏–º–∏—Ç—ã, timeouts)

## üßæ –°–æ–æ–±—â–µ–Ω–∏—è, –æ—à–∏–±–∫–∏, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

* `ERR_REST_UNAUTHORIZED`
* `ERR_GRPC_MALFORMED_PAYLOAD`
* `WARN_JSONAPI_FIELD_IGNORED`

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî REST API v1, JSON\:API –±–∞–∑–æ–≤–∞—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
* v1.1 ‚Äî gRPC —Å–µ—Ä–≤–µ—Ä, trace-id, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤ JSON\:API
* v1.2 ‚Äî ETag, WebUI —Ç–æ–∫–µ–Ω—ã, –º–µ—Ç—Ä–∏–∫–∏ REST/gRPC

## üìà UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
package "API Gateway" {
  class RestHandler {
    +handle()
    +serialize()
  }
  class GrpcServer {
    +dispatch()
    +stream()
  }
  class JsonAPI {
    +serialize()
    +filter()
  }
  RestHandler --> SQLExecutor
  GrpcServer --> SQLExecutor
  JsonAPI --> RestHandler
}
@enduml
```
