
## üìò 3.10 ‚Äî UDF/UDAF –∏ —Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ —è–∑—ã–∫–∏ (C/Lua/WASM/JS)

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* –ü–∞–∫–µ—Ç 3 ‚Äî SQL –∏ –Ø–∑—ã–∫–∏
* –ë–ª–æ–∫ 3.10 ‚Äî UDF/UDAF –∏ —Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ —è–∑—ã–∫–∏ (C/Lua/WASM/JS)

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–≠—Ç–æ—Ç –±–ª–æ–∫ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å SQL-–¥–≤–∏–∂–∫–∞ —á–µ—Ä–µ–∑ –º–µ—Ö–∞–Ω–∏–∑–º UDF (User Defined Function) –∏ UDAF (User Defined Aggregate Function), —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —è–∑—ã–∫–∞—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è, —Ç–∞–∫–∏—Ö –∫–∞–∫ C, Lua, WebAssembly (WASM) –∏ JavaScript. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É, –º–æ–¥–µ–ª–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π, –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –≤ —è–¥—Ä–æ –°–£–ë–î –±–µ–∑ –ø–æ—Ç–µ—Ä—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ —Å –∏–∑–æ–ª—è—Ü–∏–µ–π –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞      | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                |
| --------------- | ----------------------------------------------------------------------- |
| UDF             | –û–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C, Lua, JS, WASM, –≤—ã–∑—ã–≤–∞–µ–º—ã–µ –≤ SQL              |
| UDAF            | –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∞–≥—Ä–µ–≥–∞—Ç—ã —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π `INIT`, `ACCUMULATE`, `FINALIZE` |
| –†–∞–Ω—Ç–∞–π–º UDF     | –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ sandbox-–¥–≤–∏–∂–∫–∏: LuaJIT, QuickJS, WASM runtime                |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å    | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ CPU, –ø–∞–º—è—Ç–∏, –≤—Ä–µ–º–µ–Ω–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è, sandbox-–ø–µ—Å–æ—á–Ω–∏—Ü—ã          |
| –†–µ–≥–∏—Å—Ç—Ä —Ñ—É–Ω–∫—Ü–∏–π | –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∏ —Å–µ—Å—Å–∏–æ–Ω–Ω—ã–π —Ä–µ–µ—Å—Ç—Ä—ã, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ hot-reload                   |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

–í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ UDF/UDAF —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º–∞—è –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ —É–∫–∞–∑–∞—Ç–µ–ª–∏ –Ω–∞ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π –∫–æ–¥:

```c
typedef struct udf_fn_t {
    char *name;
    udf_lang_t lang;
    void *compiled_ptr;
    void *sandbox;
    uint64_t flags;
} udf_fn_t;

typedef struct udaf_ctx_t {
    void *accumulator;
    udf_fn_t *fn;
} udaf_ctx_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[SQL Executor] --> [UDF Runtime]
[UDF Runtime] --> [Lua Engine]
[UDF Runtime] --> [WASM Runtime]
[UDF Runtime] --> [JS Engine]
[UDF Runtime] --> [Memory Control / Sandbox]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ JIT (LuaJIT), –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è (QuickJS), sandbox WASM runtime
* –í—ã–∑–æ–≤ –∏–∑ SQL —Å –ø–µ—Ä–µ–¥–∞—á–µ–π –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ –≤–æ–∑–≤—Ä–∞—Ç–æ–º –∑–Ω–∞—á–µ–Ω–∏—è (–≤–∫–ª—é—á–∞—è JSON)
* Hot-reload —Ñ—É–Ω–∫—Ü–∏–π –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ —è–¥—Ä–∞
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ UDF stateful/UDAF —á–µ—Ä–µ–∑ life-cycle callbacks
* –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ sandbox-–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (CPU ticks, mem pool, —Ç–∞–π–º–µ—Ä—ã)

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/udf/udf_runtime.c`
* `src/udf/udf_registry.c`
* `src/udf/engines/lua_engine.c`
* `src/udf/engines/wasm_engine.c`
* `include/udf/udf_runtime.h`
* `include/udf/udf_registry.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏    | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                            | –û–ø–∏—Å–∞–Ω–∏–µ                                        |
| -------------- | ------------------------------------------------------------------- | ----------------------------------------------- |
| `udf_register` | `int udf_register(const char *name, udf_lang_t lang, void *ptr);`   | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–π UDF —Ñ—É–Ω–∫—Ü–∏–∏                   |
| `udf_invoke`   | `int udf_invoke(udf_fn_t *fn, db_row_t *args, db_value_t *result);` | –í—ã–∑–æ–≤ UDF –≤–Ω—É—Ç—Ä–∏ SQL –∑–∞–ø—Ä–æ—Å–∞                    |
| `udaf_step`    | `int udaf_step(udaf_ctx_t *ctx, db_value_t *val);`                  | –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º –∞–≥—Ä–µ–≥–∞—Ç–µ |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* –Æ–Ω–∏—Ç: `tests/udf/udf_test.c`, `tests/udaf/udaf_test.c`
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è: SQL ‚Üí Lua/WASM/JS, –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
* Fuzz: –≤—ã—Ä–∞–∂–µ–Ω–∏—è —Å UDF, –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
* Soak: –¥–ª–∏—Ç–µ–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ UDAF –ø–æ–¥ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
* –ü–æ–∫—Ä—ã—Ç–∏–µ: >92% –º–æ–¥—É–ª–µ–π udf\_runtime / registry

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* C: –¥–æ 200M –≤—ã–∑–æ–≤–æ–≤/—Å–µ–∫ –Ω–∞ —è–¥—Ä–æ (–±–µ–∑ sandbox)
* Lua: \~1.2 –º–ª–Ω –≤—ã–∑–æ–≤–æ–≤/—Å–µ–∫, latency < 20Œºs
* WASM: \~800K –≤—ã–∑–æ–≤–æ–≤/—Å–µ–∫, latency \~30‚Äì50Œºs
* JS (QuickJS): \~500K –≤—ã–∑–æ–≤–æ–≤/—Å–µ–∫

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π             | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                                   |
| -------------------- | ------ | ------------------------------------------------------------- |
| UDF –ø–æ–¥–¥–µ—Ä–∂–∫–∞        | 100    | –í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —è–∑—ã–∫–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —Å sandbox –∏ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º —Ä–µ—Å—É—Ä—Å–æ–≤ |
| UDAF –ø–æ–¥–¥–µ—Ä–∂–∫–∞       | 95     | –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞–≥—Ä–µ–≥–∞—Ç–æ–≤ –≤ distributed planner      |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤—ã–∑–æ–≤–æ–≤ | 100    | –í—Å–µ –≤—ã–∑–æ–≤—ã sandboxed, –∫–æ–Ω—Ç—Ä–æ–ª—å CPU, mem, I/O –ø–æ –∫–≤–æ—Ç–∞–º        |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```sql
SELECT my_udf(name) FROM customers;

CREATE AGGREGATE FUNCTION sum_squared(x DOUBLE) RETURNS DOUBLE
LANGUAGE 'lua' AS '
  function init() return 0 end
  function accumulate(acc, x) return acc + x*x end
  function finalize(acc) return acc end
';
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `stateful` UDAF –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö –ø–ª–∞–Ω–∞—Ö
* DSL –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è UDF –ø—Ä—è–º–æ –≤ SQL —Å –∞–≤—Ç–æ-JIT
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ONNX runtime —á–µ—Ä–µ–∑ UDF wrapper

## üß∞ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ (ONNX-in-UDF)
* ERP-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å—á—ë—Ç–∞ (–Ω–∞–ª–æ–≥–∏, –ø—Ä–∞–≤–∏–ª–∞)
* –°—Ü–µ–Ω–∞—Ä–∏–∏ ETL, –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ò–∑–æ–ª—è—Ü–∏—è –≤—ã–∑–æ–≤–æ–≤, –∫–æ–Ω—Ç—Ä–æ–ª—å –≤—Ä–µ–º–µ–Ω–∏ –∏ –ø–∞–º—è—Ç–∏
* –ó–∞–ø—Ä–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∏—Å—Ç–µ–º–Ω—ã–º API –≤ JS/Lua/WASM
* –ê—É–¥–∏—Ç –≤—ã–∑–æ–≤–æ–≤, –∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

## üßæ –°–æ–æ–±—â–µ–Ω–∏—è, –æ—à–∏–±–∫–∏, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

* `ERR_UDF_TIMEOUT`
* `ERR_UDF_MEMORY_LIMIT`
* `WARN_UDAF_INIT_SKIPPED`

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî Lua/C, –æ–¥–Ω–æ—Å—Ç—Ä–æ—á–Ω—ã–µ UDF
* v1.1 ‚Äî WASM runtime + JS –¥–≤–∏–∂–æ–∫ + UDAF lifecycle
* v1.2 ‚Äî –ö–æ–Ω—Ç—Ä–æ–ª—å CPU/mem, hot-reload

## üìà UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
package "UDF Runtime" {
  class UDFRegistry {
    +register()
    +lookup()
  }
  class UDFExecutor {
    +invoke()
  }
  class UDAFState {
    +init()
    +step()
    +finalize()
  }
  UDFExecutor --> UDFRegistry
  UDAFState --> UDFExecutor
}
@enduml
```
