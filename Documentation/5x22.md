# 5.22 ‚Äî –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã: gap-fill, downsampling, retention

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞
**–ü–∞–∫–µ—Ç 5 ‚Äî BI, ML –∏ OLAP**  
**–ë–ª–æ–∫ 5.22 ‚Äî –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä—è–¥—ã: gap-fill, downsampling, retention**

---

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ü–æ–¥—Å–∏—Å—Ç–µ–º–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏, —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –º–µ—Ç–∫–∞–º–∏, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã—Ö –¥–ª—è —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏, —Å–µ–Ω—Å–æ—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∫–æ—Ç–∏—Ä–æ–≤–æ–∫, –ª–æ–≥–æ–≤. –û–Ω–∞ —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É –¥–ª—è –∑–∞–¥–∞—á:
- –ó–∞–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–ø—É—Å–∫–æ–≤ (`gap-fill`)
- –ê–≥–≥—Ä–µ–≥–∞—Ü–∏–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (`downsampling`)
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–µ–º —Ö—Ä–∞–Ω–µ–Ω–∏—è (`retention policies`)

---

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                  | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                              |
|-----------------------------|----------------------------------------------------------------------------------------|
| –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö                 | `ts_t`, `ts_range_t`, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ ISO8601, –Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å                       |
| Gap-fill                    | –ê–ª–≥–æ—Ä–∏—Ç–º—ã –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏: –ª–∏–Ω–µ–π–Ω–∞—è, last-value, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ                       |
| Downsampling                | –ê–≥—Ä–µ–≥–∞—Ç—ã: AVG, MIN, MAX, SUM, STDDEV –ø–æ –∑–∞–¥–∞–Ω–Ω–æ–º—É –æ–∫–Ω—É –≤—Ä–µ–º–µ–Ω–∏                       |
| Retention Policies          | TTL (time-to-live), background eviction, cold/hot tier migration                      |
| –•—Ä–∞–Ω–µ–Ω–∏–µ                    | –ö–æ–º–ø—Ä–µ—Å—Å–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (delta encoding, Gorilla), –∏–Ω–¥–µ–∫—Å –ø–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–º –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º      |
| –ó–∞–ø—Ä–æ—Å—ã                     | `GAP_FILL()`, `RESAMPLE()`, `RETENTION_POLICY()` ‚Äî SQL-—Ñ—É–Ω–∫—Ü–∏–∏ –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è        |

---

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct ts_point_t {
  timestamp_ns_t ts;
  double value;
} ts_point_t;

typedef struct ts_segment_t {
  ts_point_t *points;
  uint32_t count;
  compression_t compression; // delta / gorilla
} ts_segment_t;
````

---

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
TimeseriesEngine --> StorageEngine
TimeseriesEngine --> QueryPlanner
TimeseriesEngine --> SQLFunctions
TimeseriesEngine --> CompressionLayer
```

---

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –•—Ä–∞–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Å–µ–≥–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (columnar compressed store)
* NUMA-aware –∞–ª–ª–æ–∫–∞—Ü–∏—è —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
* –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∏ –æ—á–∏—Å—Ç–∫–∏ –ø–æ `retention window`
* –ê–ø–ø–∞—Ä–∞—Ç–Ω–æ-—É—Å–∫–æ—Ä–µ–Ω–Ω–∞—è –∞–≥—Ä–µ–≥–∞—Ü–∏—è —á–µ—Ä–µ–∑ SIMD

---

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/timeseries/timeseries_engine.c`
* `src/sql/timeseries_sql.c`
* `src/storage/compression/delta_encoding.c`
* `include/timeseries/ts_types.h`

---

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è                  | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                             | –û–ø–∏—Å–∞–Ω–∏–µ                                                    |
| -------------------- | -------------------------------------------------------------------- | ----------------------------------------------------------- |
| `ts_gap_fill`        | `int ts_gap_fill(ts_series_t *s, gap_fill_policy_t p)`               | –ó–∞–ø–æ–ª–Ω—è–µ—Ç –ø—Ä–æ–ø—É—Å–∫–∏ –≤ —Ä—è–¥—É —Å–æ–≥–ª–∞—Å–Ω–æ –ø–æ–ª–∏—Ç–∏–∫–µ                 |
| `ts_downsample`      | `int ts_downsample(ts_series_t *s, ts_interval_t win, agg_func_t f)` | –ü—Ä–∏–º–µ–Ω—è–µ—Ç –∞–≥—Ä–µ–≥–∞—Ü–∏—é –ø–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–º –æ–∫–Ω–∞–º                      |
| `ts_apply_retention` | `void ts_apply_retention(ts_series_t *s, timestamp_ns_t cutoff)`     | –£–¥–∞–ª—è–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ —Ç–æ—á–∫–∏, –ø–æ–ø–∞–¥–∞—é—â–∏–µ –≤–Ω–µ `retention window` |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/timeseries/test_gapfill.c`, `test_downsampling.c`
* Fuzz: —Å–ª—É—á–∞–π–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –≤—Ä–µ–º–µ–Ω–∏ —Å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
* Soak: –¥–ª–∏—Ç–µ–ª—å–Ω—ã–µ retention-–Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ 30+ –¥–Ω–µ–π
* Coverage: >92% –¥–ª—è —è–¥—Ä–∞

---

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è              | –†–µ–∑—É–ª—å—Ç–∞—Ç                   |
| --------------------- | --------------------------- |
| Gap-fill 10k —Ç–æ—á–µ–∫    | < 1.8 –º—Å                    |
| Downsampling 1M —Ä—è–¥–æ–≤ | < 90 –º—Å (—Å SIMD –∞–≥—Ä–µ–≥–∞—Ü–∏–µ–π) |
| –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ retention | < 10 –º—Å –Ω–∞ 100k —Ç–æ—á–µ–∫       |

---

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π         | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                               |
| ---------------- | ------ | ----------------------------------------- |
| Gap-fill SQL     | 100    | GAP\_FILL —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω                      |
| Downsampling SQL | 100    | RESAMPLE() —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≤—Å–µ—Ö –∞–≥—Ä–µ–≥–∞—Ç–æ–≤    |
| TTL –∏ Retention  | 100    | –ü—Ä–æ—Ñ–∏–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ |
| –°–∂–∞—Ç–∏–µ           | 100    | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Gorilla –∏ delta encoding     |

---

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ SQL

```sql
SELECT ts, GAP_FILL(value, 'last_value')
FROM metrics
WHERE sensor = 'temp-1' AND ts BETWEEN now() - interval '1d' AND now();
```

---

## üìä UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity "TimeseriesEngine" as TS
entity "StorageEngine" as ST
entity "QueryPlanner" as QP
entity "CompressionLayer" as CL
entity "SQLFunctions" as SQL

TS --> ST
TS --> QP
TS --> CL
TS --> SQL
@enduml
```

---

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–º –º–µ—Ç–∫–∞–º
* –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—å –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å–µ–Ω—Å–æ—Ä–∞–º
* –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –∞–≥—Ä–µ–≥–∞—Ç—ã –ø–æ –º–∏–Ω—É—Ç–∞–º/—á–∞—Å–∞–º
* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—ä—ë–º–æ–º —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –¢–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞/—Ä–æ–ª–∏
* –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫ –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
* –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∫ gap-fill –∏ retention –æ–ø–µ—Ä–∞—Ü–∏—è–º

---

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞ downsampling
* v1.1 ‚Äî Gap-fill –Ω–∞ SQL
* v1.2 ‚Äî Retention policies + eviction
* v1.3 ‚Äî –ö–æ–º–ø—Ä–µ—Å—Å–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏

---

## üõë –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

| –ö–æ–¥ / –¢–∏–ø         | –£—Å–ª–æ–≤–∏–µ                             | –û–ø–∏—Å–∞–Ω–∏–µ                         |
| ----------------- | ----------------------------------- | -------------------------------- |
| `E_TS_BAD_TS`     | –ù–µ–≤–∞–ª–∏–¥–Ω–∞—è –≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞          | –ü—Ä–æ–ø—É—Å–∫ —Ç–æ—á–∫–∏ –ø—Ä–∏ gap-fill       |
| `W_TS_GAP_MISSED` | –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏–Ω—Ç–µ—Ä–ø–æ–ª–∏—Ä–æ–≤–∞—Ç—å          | Gap-fill —Å –ø—Ä–æ–ø—É—Å–∫–æ–º –ø–æ –ø–æ–ª–∏—Ç–∏–∫–µ |
| `E_TS_NO_AGGR`    | –ù–µ —É–∫–∞–∑–∞–Ω–∞ –∞–≥—Ä–µ–≥–∞—Ü–∏—è –ø—Ä–∏ downsample | –û—à–∏–±–∫–∞ SQL-—Ñ—É–Ω–∫—Ü–∏–∏               |


