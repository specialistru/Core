–í–æ—Ç –±–ª–æ–∫ **3.3 ‚Äî –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã, —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ exec hooks**, –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã–π –ø–æ –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–º—É —à–∞–±–ª–æ–Ω—É:

---

### üìò 3.3 ‚Äî –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã, —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ exec hooks

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 3 ‚Äî SQL –∏ –Ø–∑—ã–∫–∏
* **–ë–ª–æ–∫:** 3.3 ‚Äî –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã, —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ exec hooks

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ–¥—É—Ä, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –∏ exec hooks (–∏—Å–ø–æ–ª–Ω—è–µ–º—ã—Ö —Ö—É–∫–æ–≤), –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∑–≤–æ–ª—è—é—Ç —Ä–∞—Å—à–∏—Ä—è—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, DML/DDL-–æ–ø–µ—Ä–∞—Ü–∏–π, –∞ —Ç–∞–∫–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å –≥–∏–±–∫—É—é –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –ø—Ä—è–º–æ –≤–Ω—É—Ç—Ä–∏ –°–£–ë–î. –≠—Ç–æ –∫–ª—é—á–µ–≤–æ–π –º–µ—Ö–∞–Ω–∏–∑–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ –∏ —Å–æ–±—ã—Ç–∏–π–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–Ω—É—Ç—Ä–∏ ERP/ETL-–Ω–∞–≥—Ä—É–∑–æ–∫.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞           | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                           |
| -------------------- | ------------------------------------------------------------------ |
| –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ CREATE PROCEDURE/EXECUTE, —Å–∏–≥–Ω–∞—Ç—É—Ä—ã, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã           |
| –¢—Ä–∏–≥–≥–µ—Ä—ã             | BEFORE/AFTER INSERT/UPDATE/DELETE, row-level –∏ statement-level     |
| Exec hooks           | –í—ã–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ö—É–∫–æ–≤ –≤ –∫–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (DDL, TX) |
| –Ø–∑—ã–∫–∏                | SQL-–ø–æ–¥–æ–±–Ω—ã–π DSL, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ –≤—ã–∑–æ–≤–∞ (Lua/WASM/JS)          |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MVCC    | –¢—Ä–∏–≥–≥–µ—Ä—ã –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã —É—á–∞—Å—Ç–≤—É—é—Ç –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ          |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct db_proc_t {
    char *name;
    char **args;
    dsl_ast_node_t *ast;
    bool is_transactional;
} db_proc_t;

typedef struct trigger_t {
    char *table_name;
    trigger_event_t event;
    trigger_time_t time;
    db_proc_t *callback;
} trigger_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[SQL –Ø–¥—Ä–æ] --> [–ü—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–π –¥–≤–∏–∂–æ–∫]
[–ü—Ä–æ—Ü–µ–¥—É—Ä–Ω—ã–π –¥–≤–∏–∂–æ–∫] --> [MVCC Engine]
[–¢—Ä–∏–≥–≥–µ—Ä–Ω—ã–π –¥–≤–∏–∂–æ–∫] --> [Storage]
[Exec Hooks] --> [Transaction Manager]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è –ø—Ä–æ—Ü–µ–¥—É—Ä —á–µ—Ä–µ–∑ DSL-–∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä
* –¢—Ä–∏–≥–≥–µ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å –≤–∏–¥–∏–º–æ—Å—Ç—å—é MVCC –∏ snapshot isolation
* Exec hooks –º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —Å–æ–±—ã—Ç–∏—è COMMIT, ROLLBACK, ALTER
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ sandbox –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –Ω–∞ Lua/WASM

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/sql/procedure.c`
* `include/sql/procedure.h`
* `src/sql/trigger.c`
* `include/sql/trigger.h`
* `src/tx/exec_hooks.c`
* `include/tx/exec_hooks.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏        | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                    | –û–ø–∏—Å–∞–Ω–∏–µ                                |
| ------------------ | ----------------------------------------------------------- | --------------------------------------- |
| `proc_register`    | `int proc_register(db_proc_t *proc);`                       | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –ø—Ä–æ—Ü–µ–¥—É—Ä—ã        |
| `trigger_register` | `int trigger_register(trigger_t *trigger);`                 | –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ           |
| `exec_hook_fire`   | `void exec_hook_fire(hook_event_t evt, tx_context_t *ctx);` | –í—ã–∑–æ–≤ —Ö—É–∫–æ–≤ –ø—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/sql/proc_test.c`, `tests/sql/trigger_test.c`
* Fuzz: —Å–ª—É—á–∞–π–Ω—ã–µ AST –≤ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞—Ö –∏ —Ç—Ä–∏–≥–≥–µ—Ä–∞—Ö
* Soak: 100K —Å–æ–±—ã—Ç–∏–π INSERT/DELETE —Å —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏
* Coverage: 88% –ø–æ trigger.c, 91% –ø–æ procedure.c

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* Latency —Ç—Ä–∏–≥–≥–µ—Ä–∞ –Ω–∞ INSERT: <15 –º–∫—Å (row-level), <5 –º–∫—Å (statement-level)
* Exec hook latency: \~3 –º–∫—Å
* –ü—Ä–æ—Ü–µ–¥—É—Ä—ã: —Å—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è DSL –¥–æ 40K —Å—Ç—Ä–æ–∫/—Å

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π   | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                                      |
| ---------- | ------ | ---------------------------------------------------------------- |
| –ü—Ä–æ—Ü–µ–¥—É—Ä—ã  | 95     | SQL-–ø–æ–¥–æ–±–Ω—ã–π DSL, runtime, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, sandbox                    |
| –¢—Ä–∏–≥–≥–µ—Ä—ã   | 90     | –í—Å–µ —Ç–∏–ø—ã —Å–æ–±—ã—Ç–∏–π –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞         |
| Exec Hooks | 85     | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ COMMIT/ROLLBACK/DDL, –Ω–æ –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö rollback-—Ö–µ–Ω–¥–ª–µ—Ä–æ–≤ |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
db_proc_t *proc = parse_procedure("CREATE PROCEDURE audit_log(...) BEGIN ... END;");
proc_register(proc);

trigger_t *trg = make_trigger("AFTER INSERT ON orders", "CALL audit_log(...)");
trigger_register(trg);
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ OUT/INOUT –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
* –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –∏–∑ —à–∞–±–ª–æ–Ω–æ–≤ (template engine)
* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä

## üß∞ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∞—É–¥–∏—Ç–∞ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã
* –†–µ–∞–∫—Ü–∏—è –Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –≤–Ω—É—Ç—Ä–∏ ERP

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* Sandbox –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–æ—Ü–µ–¥—É—Ä (Lua/WASM)
* –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∫ –≤—ã–∑–æ–≤—É –ø—Ä–æ—Ü–µ–¥—É—Ä –ø–æ —Ä–æ–ª—è–º
* Exec hooks –ø–æ–¥–ø–∏—Å–∞–Ω—ã –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω—ã –ø–æ scope

## üßæ –°–æ–æ–±—â–µ–Ω–∏—è, –æ—à–∏–±–∫–∏, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

* `ERR_PROC_PARSE_FAIL`
* `WARN_TRIGGER_REDECLARED`
* `ERR_HOOK_INVALID_SCOPE`

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –ø—Ä–æ—Ü–µ–¥—É—Ä—ã + row-level —Ç—Ä–∏–≥–≥–µ—Ä—ã
* v1.1 ‚Äî exec\_hooks + DSL AST binding
* v1.2 ‚Äî –≤–Ω–µ—à–Ω–∏–µ –≤—ã–∑–æ–≤—ã Lua/JS, –∞—É–¥–∏—Ç–æ—Ä—Å–∫–∏–µ —Ö—É–∫–∏

## üìà UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
package "Procedure Engine" {
  class Procedure {
    +eval()
  }
  class Trigger {
    +fire()
  }
  class ExecHook {
    +invoke()
  }
  Procedure --> Trigger
  ExecHook --> TransactionManager
}
@enduml
```

---

üì© –ì–æ—Ç–æ–≤ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫ **3.4 ‚Äî –†–∞—Å—à–∏—Ä–µ–Ω–∏—è JSON, –∞–≥—Ä–µ–≥–∞—Ç—ã, FILTER –∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏** –ø–æ –∫–æ–º–∞–Ω–¥–µ **–¥–∞**.

