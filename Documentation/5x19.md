# 5.19 ‚Äî CDC –∏ –ø–æ—Ç–æ–∫–æ–≤–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è (Kafka, Pulsar, Changefeed)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 5 ‚Äî BI, ML –∏ OLAP**
**–ë–ª–æ–∫ 5.19 ‚Äî CDC –∏ –ø–æ—Ç–æ–∫–æ–≤–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è (Kafka, Pulsar, Changefeed)**

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–≠—Ç–æ—Ç –±–ª–æ–∫ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º Change Data Capture (CDC) –∏ –ø–æ—Ç–æ–∫–æ–≤–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ in-memory –°–£–ë–î –≤ –≤–Ω–µ—à–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã (Kafka, Apache Pulsar, Debezium-compatible –ø–æ–¥–ø–∏—Å—á–∏–∫–∏ –∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ Changefeed-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏). –û–Ω –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ real-time –∞–Ω–∞–ª–∏—Ç–∏–∫–∏, –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω—ã—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞            | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                 |
| --------------------- | -------------------------------------------------------- |
| CDC –ª–æ–≥–∏–∫–∞            | –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ç—Ä–æ–∫/—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π        |
| Kafka/Pulsar –±—Ä–æ–∫–µ—Ä—ã  | Async-–ø—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π —á–µ—Ä–µ–∑ backpressure-aware –∫–ª–∏–µ–Ω—Ç |
| Changefeed API        | SQL-–ø–æ–¥–ø–∏—Å–∫–∏ –∏ –≤–Ω–µ—à–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —á–µ—Ä–µ–∑ WebSocket/gRPC  |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Debezium    | –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å JSON-—Ñ–æ—Ä–º–∞—Ç–æ–º Debezium                   |
| –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π | Runtime —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä—ã: map/filter/flatten                 |

## üíæ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è

```c
typedef struct cdc_event_t {
  tx_id_t tx_id;
  char table[MAX_NAME];
  enum event_type_t { INSERT, UPDATE, DELETE } type;
  row_data_t before;
  row_data_t after;
  timestamp_t ts;
} cdc_event_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```plantuml
ChangeLogger --> CDCQueue
CDCQueue --> KafkaPublisher
CDCQueue --> PulsarPublisher
CDCQueue --> ChangefeedDispatcher
ChangefeedDispatcher --> WebsocketStream
ChangefeedDispatcher --> gRPCStream
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

* Vectorized —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ CDC —Å–æ–±—ã—Ç–∏–π
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ TTL –∏ –∫–æ–º–ø—Ä–µ—Å—Å–∏–∏ —Å–æ–±—ã—Ç–∏–π
* NUMA-aware –∫–æ–ª—å—Ü–µ–≤–∞—è –æ—á–µ—Ä–µ–¥—å CDCQueue
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã—Ö retries –∏ backpressure control
* –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –Ω–∞ –º–æ–º–µ–Ω—Ç commit (snapshot isolation)

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/tx/cdc_logger.c`
* `src/net/cdc_kafka.c`
* `src/net/cdc_pulsar.c`
* `src/api/changefeed_api.c`
* `include/cdc/cdc_event.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –ò–º—è                 | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                | –û–ø–∏—Å–∞–Ω–∏–µ                                                      |
| ------------------- | ----------------------------------------------------------------------- | ------------------------------------------------------------- |
| `cdc_log_event`     | `int cdc_log_event(const row_change_t *change)`                         | –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏                          |
| `cdc_publish_kafka` | `int cdc_publish_kafka(const cdc_event_t *ev)`                          | –ü—É–±–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏—è –≤ Kafka                                    |
| `cdc_stream_feed`   | `void cdc_stream_feed(session_t *s, const char *table, feed_opts_t *o)` | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∏–º–∏–Ω–≥–æ–≤–æ–≥–æ –∫–∞–Ω–∞–ª–∞ –¥–ª—è Changefeed-–ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/tx/test_cdc_logger.c`
* Soak: –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è UPDATE/DELETE
* Fuzz: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è CDC-–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π —Å –Ω–∞—Ä—É—à–µ–Ω–∏—è–º–∏ –ø–æ—Ä—è–¥–∫–∞
* Integration: end-to-end –ø–æ—Ç–æ–∫ –≤ Kafka –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ Flink

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                | –ó–Ω–∞—á–µ–Ω–∏–µ            |
| ---------------------- | ------------------- |
| Kafka throughput       | –¥–æ 1 –º–ª–Ω events/sec |
| Latency end-to-end     | < 15 –º—Å             |
| –°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä —Å–æ–±—ã—Ç–∏—è | 320 –±–∞–π—Ç            |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                  | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                               |
| ------------------------- | ------ | ----------------------------------------- |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ CDC             | 100    | –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ INSERT/UPDATE/DELETE         |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Kafka/Pulsar | 100    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏          |
| API –¥–ª—è Changefeed        | 100    | SQL/WebSocket/gRPC –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```sql
-- –°–æ–∑–¥–∞–Ω–∏–µ Changefeed-–ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Ç–∞–±–ª–∏—Ü—É orders
CREATE CHANGEFEED FOR TABLE orders
WITH FORMAT = 'json', SINK = 'kafka://localhost:9092/orders';
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ CDC –Ω–∞ —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (DDL)
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Avro/Protobuf payload
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Exactly-Once delivery —Å –ø–æ–º–æ—â—å—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π Kafka

## üìä UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity "ChangeLogger" as CL
entity "CDCQueue" as Q
entity "KafkaPublisher" as KAF
entity "PulsarPublisher" as PUL
entity "ChangefeedDispatcher" as DISP
entity "WebsocketStream" as WS
entity "gRPCStream" as GRPC

CL --> Q
Q --> KAF
Q --> PUL
Q --> DISP
DISP --> WS
DISP --> GRPC
@enduml
```

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –û–Ω–ª–∞–π–Ω ETL / Streaming data pipelines
* –†–µ–ø–ª–∏–∫–∞—Ü–∏—è –º–µ–∂–¥—É –∫–ª–∞—Å—Ç–µ—Ä–∞–º–∏ –≤ —Ä–µ–∂–∏–º–µ near real-time
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å BI/–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º–∏

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ RBAC –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ç–∞–±–ª–∏—Ü –∏ –ø–æ—Ç–æ–∫–æ–≤
* –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ CDC —Å–æ–±—ã—Ç–∏–π
* –ê—É–¥–∏—Ç –ø–æ–¥–ø–∏—Å–æ–∫ –∏ —Å—Ç—Ä–∏–º–æ–≤

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –±–∞–∑–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è Kafka CDC
* v1.1 ‚Äî Pulsar backend –∏ Changefeed API
* v1.2 ‚Äî NUMA-aware CDC –æ—á–µ—Ä–µ–¥—å, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ retries
* v1.3 ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –ø—Ä–µ–¥–∏–∫–∞—Ç–∞–º

## üõë –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

| –ö–æ–¥ / –¢–∏–ø           | –£—Å–ª–æ–≤–∏–µ                                | –û–ø–∏—Å–∞–Ω–∏–µ                               |
| ------------------- | -------------------------------------- | -------------------------------------- |
| `E_CDC_STREAM_FAIL` | –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞–Ω–∞–ª–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ | –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±—Ä–æ–∫–µ—Ä—É      |
| `W_CDC_DROP_EVENT`  | –ü—Ä–µ–≤—ã—à–µ–Ω —Ä–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ CDC            | –°–æ–±—ã—Ç–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ –ø–æ –ø—Ä–∏—á–∏–Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ |
| `E_CDC_PAYLOAD_FMT` | –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç CDC —Å–æ–±—ã—Ç–∏—è        | –û—à–∏–±–∫–∞ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–æ–±—ã—Ç–∏—è            |


