# 7.2 ‚Äî –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è (Query Timeline / Zipkin / Jaeger)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç 7 ‚Äî Observability –∏ DevOps**
* **–ë–ª–æ–∫ 7.2 ‚Äî –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ (Query Execution Tracing)**

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–≠—Ç–æ—Ç –±–ª–æ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∑–∞—Ö–≤–∞—Ç, –∞–Ω–∞–ª–∏–∑ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —É—Ä–æ–≤–Ω–µ —ç—Ç–∞–ø–æ–≤ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è (execution stages), –≤–∫–ª—é—á–∞—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é, –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤–≤–æ–¥–∞-–≤—ã–≤–æ–¥–∞ –∏ —Å–µ—Ç–µ–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–π –º–æ–¥–µ–ª–∏ —Å–ø–∞–Ω–æ–≤ (spans) –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–ª–Ω—É—é –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏–∞–≥—Ä–∞–º–º—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞, –≤—ã—è–≤–∏—Ç—å —É–∑–∫–∏–µ –º–µ—Å—Ç–∞, –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –æ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–∫–ª–∏–∫–∞ –∏ –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏ –ø–ª–∞–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞. –≠–∫—Å–ø–æ—Ä—Ç –≤ —Ç–∞–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∫–∞–∫ **Jaeger** –∏ **Zipkin** –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã observability. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–µ—Å—Å–∏–∏, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É –∑–∞–ø—Ä–æ—Å–∞.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞             | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                     |
| ---------------------- | ---------------------------------------------------------------------------- |
| –°–±–æ—Ä –∏–µ—Ä–∞—Ä—Ö–∏–∏ —Å–ø–∞–Ω–æ–≤   | –°—Ç—Ä—É–∫—Ç—É—Ä–∞ `trace_span_t`, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π, –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã     |
| –ö–æ–Ω—Ç–µ–∫—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è    | session\_id, query\_id, tx\_id, user, node\_id                               |
| –≠–∫—Å–ø–æ—Ä—Ç                | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Jaeger, Zipkin, OpenTelemetry                           |
| –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è           | HTML-—Ç–∞–π–º–ª–∞–π–Ω, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ web-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∫–∏                       |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SQL —è–¥—Ä–æ–º | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ø–∞–Ω–æ–≤ –Ω–∞ —Å—Ç–∞–¥–∏–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–∞ (executor stages) |

## üíæ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è

```c
typedef struct trace_span_t {
  char span_id[32];
  char parent_id[32];
  char operation[MAX_NAME];
  uint64_t start_ns;
  uint64_t duration_ns;
  char session_id[64];
  char query_id[64];
  char tx_id[64];
  char user[64];
  char node_id[32];
} trace_span_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```plantuml
Executor --> Tracer
Optimizer --> Tracer
Storage --> Tracer
Tracer --> ExporterJaeger
Tracer --> ExporterZipkin
Tracer --> UIProfiler
```

## üßê –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ NUMA-aware –±—É—Ñ–µ—Ä–æ–≤ –¥–ª—è —Å–ø–∞–Ω–æ–≤ (NUMA locality-aware trace buffers)
* –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏ –≤ –±—É—Ñ–µ—Ä –∏ batched —ç–∫—Å–ø–æ—Ä—Ç
* –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–≤—è–∑—ã–≤–∞–Ω–∏—è —Å–ø–∞–Ω–æ–≤ —Å —Å–æ–±—ã—Ç–∏—è–º–∏ –∏–∑ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫–∞ –∏ –ª–æ–≥–æ–≤
* –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ TRACE / DEBUG
* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ä–∞–±–æ—Ç—É –≤ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ (lock-free —Å—Ç—Ä—É–∫—Ç—É—Ä—ã)

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏

* `src/metrics/tracer.c`
* `src/metrics/tracer_internal.c`
* `include/metrics/trace.h`
* `src/net/export_zipkin.c`
* `src/net/export_jaeger.c`
* `src/ui/web_trace_timeline.c`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –ò–º—è            | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                          | –û–ø–∏—Å–∞–Ω–∏–µ                                                              |
| -------------- | --------------------------------------------------------------------------------- | --------------------------------------------------------------------- |
| `trace_begin`  | `trace_span_t *trace_begin(const char *op, const char *parent_span_id)`           | –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ —Å–ø–∞–Ω–∞ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ —Ä–æ–¥–∏—Ç–µ–ª—è            |
| `trace_end`    | `void trace_end(trace_span_t *span)`                                              | –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–ø–∞–Ω–∞: —Ñ–∏–∫—Å–∞—Ü–∏—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ                  |
| `trace_export` | `void trace_export(const trace_span_t *spans[], size_t count, export_format_t f)` | –ú–∞—Å—Å–æ–≤—ã–π —ç–∫—Å–ø–æ—Ä—Ç –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (JSON, Jaeger proto, Zipkin JSON) |
| `trace_flush`  | `void trace_flush(void)`                                                          | –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç –±—É—Ñ–µ—Ä–∞ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏                             |

## ü•∫ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit-—Ç–µ—Å—Ç—ã: `tests/trace/test_trace.c`
* Fuzz: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö —Å–ø–∞–Ω–æ–≤ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏
* Soak-—Ç–µ—Å—Ç—ã: –Ω–∞–≥—Ä—É–∑–∫–∞ 1 –º–ª–Ω. –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–æ–π, –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–∫—Å–ø–æ—Ä—Ç–∞
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ: —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Zipkin UI, Jaeger CLI, Kibana Timeline Panel

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                      | –ó–Ω–∞—á–µ–Ω–∏–µ            |
| ---------------------------- | ------------------- |
| –°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–∞–Ω–∞               | < 180 ns            |
| –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è     | < 120 ns            |
| –≠–∫—Å–ø–æ—Ä—Ç 1000 —Å–ø–∞–Ω–æ–≤ –≤ Zipkin | \~0.85‚Äì1.1 –º—Å       |
| –ü–∏–∫–æ–≤–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏   | 1.2 –ú–ë / 10K —Å–ø–∞–Ω–æ–≤ |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                        | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                       |
| ------------------------------- | ------ | ------------------------------------------------- |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏–µ—Ä–∞—Ä—Ö–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è   | 100    | –í–ª–æ–∂–µ–Ω–Ω—ã–µ —Å–ø–∞–Ω—ã, –¥–µ—Ä–µ–≤–æ –≤—ã–∑–æ–≤–æ–≤                   |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ | 100    | –≠–∫—Å–ø–æ—Ä—Ç Jaeger, Zipkin, OpenTelemetry             |
| –ö–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π  | 100    | –°–≤—è–∑—å —Å —Å–µ—Å—Å–∏–µ–π, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º, query\_id, tx\_id |
| –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —à–∫–∞–ª–µ | 100    | –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ timeline —Å —Ü–≤–µ—Ç–æ–≤–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π          |

## üìå –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```c
trace_span_t *span = trace_begin("HashJoin", parent_id);
// –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ HashJoin
trace_end(span);
trace_flush();
```

## üß∞ –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ trace context propagation —á–µ—Ä–µ–∑ gRPC –∏ REST API
* –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π (–∞–Ω–∞–ª–∏–∑ –ø–ª–∞–Ω–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ª–æ–≥–∞–º–∏ –∞—É–¥–∏—Ç–∞ –∏ —Å–æ–±—ã—Ç–∏–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
* –í—ã–≤–æ–¥ –¥–∏–∞–≥—Ä–∞–º–º –≤—Ä–µ–º–µ–Ω–∏ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

## üìà UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
actor "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" as U
entity "SQLExecutor" as Exec
entity "Tracer" as Trace
entity "JaegerExporter" as J
entity "ZipkinExporter" as Z
entity "WebTimeline" as UI

U --> Exec : –û—Ç–ø—Ä–∞–≤–∫–∞ SQL
Exec --> Trace : trace_begin()
Trace --> J : export_to_jaeger()
Trace --> Z : export_to_zipkin()
Trace --> UI : render_timeline()
@enduml
```

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ SLA –∏ –∑–∞–¥–µ—Ä–∂–µ–∫ –Ω–∞ —É—Ä–æ–≤–Ω–µ —ç—Ç–∞–ø–æ–≤
* –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ —É–∑–ª–∞–º (cluster-wide tracing)
* –û—Ç–ª–∞–¥–∫–∞ –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ span-–ø–æ–ª—è—Ö
* –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∫ trace-–¥–∞–Ω–Ω—ã–º (RBAC)
* –ê—É–¥–∏—Ç –≤—ã–∑–æ–≤–æ–≤ —ç–∫—Å–ø–æ—Ä—Ç–∞ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî –±–∞–∑–æ–≤–∞—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –∏ —ç–∫—Å–ø–æ—Ä—Ç JSON
* v1.1 ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Zipkin exporter
* v1.2 ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Jaeger exporter
* v1.3 ‚Äî NUMA-aware trace –±—É—Ñ–µ—Ä—ã, timeline-UI
* v1.4 ‚Äî –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## üõë –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

| –ö–æ–¥ / –¢–∏–ø          | –£—Å–ª–æ–≤–∏–µ                               | –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏                    |
| ------------------ | ------------------------------------- | ---------------------------------- |
| `E_TRACE_BUF_OVF`  | –ü—Ä–µ–≤—ã—à–µ–Ω —Ä–∞–∑–º–µ—Ä trace-–±—É—Ñ–µ—Ä–∞          | –°–ø–∞–Ω—ã –Ω–µ –ø–æ–º–µ—â–∞—é—Ç—Å—è –≤ –ø–∞–º—è—Ç—å       |
| `E_TRACE_EXPORT`   | –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Jaeger/Zipkin       | –ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ç—å—é –∏–ª–∏ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π |
| `W_TRACE_DISABLED` | –¢—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –ø–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ | –ü—Ä–æ–ø—É—â–µ–Ω —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö               |
