# 5.16 ‚Äî –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ sandbox API (Lua, WASM, C)

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 5 ‚Äî BI, ML –∏ OLAP**
**–ë–ª–æ–∫ 5.16 ‚Äî –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ sandbox API (Lua, WASM, C)**

## ‚ú® –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ —é–∑–µ—Ä—Å–∫–∏—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏ —Ñ—É–Ω–∫—Ü–∏–π, –Ω–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö –Ω–∞ Lua, WASM –∏ –Ω–∞ —Å–∏/—Å–∏++. –¶–µ–ª—å ‚Äî —Å–¥–µ–ª–∞—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ SQL/–æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç—ã –ø—Ä–∏ –ø–æ–ª–Ω–æ–π –∏–∑–æ–ª—è—Ü–∏–∏ –æ—Ç —è–¥—Ä–∞ –°–£–ë–î.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞    | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                          |
| ------------- | ------------------------------------------------- |
| Lua sandbox   | Lua 5.4, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤, —á–µ—Ä–µ–∑ luaL\_sandbox |
| WASM runtime  | WAMR/–£–∑–µ–ª—å–Ω–æ–π API, –º–µ–º–æ—Ä–∏-–ª–∏–º–∏—Ç—ã, –¥–µ—Ç–µ–∫—Ü–∏—è loop   |
| C/C++ —Ñ—É–Ω–∫—Ü–∏–∏ | –ß–µ—Ä–µ–∑ dlopen/–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –ø–ª–∞–≥–∏–Ω—ã                 |

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct sandbox_context_t {
  char name[64];
  enum sandbox_type_e { LUA, WASM, NATIVE } type;
  void *env;
  size_t mem_limit;
} sandbox_context_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```plantuml
UserScript --> SandboxAPI
SandboxAPI --> LuaEngine
SandboxAPI --> WasmRuntime
SandboxAPI --> NativePluginLoader
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

* NUMA-aware —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤
* –°–±–æ—Ä —Å—Ç–µ–∫–æ–≤ –∏ –æ—Ç–ª–∞–¥–∫–∞ –ø–æ–ª–µ—Ç–æ–≤ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
* –û—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ —Ç—Ä–∏–≥–≥–µ—Ä–∞–º

## üìÇ –§–∞–π–ª—ã –∫–æ–¥–∞

* `src/sandbox/sandbox_api.c`
* `src/sandbox/lua_engine.c`
* `src/sandbox/wasm_runtime.c`
* `include/sandbox/sandbox_context.h`

## üîß –§—É–Ω–∫—Ü–∏–∏ C

| –ò–º—è               | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                              | –û–ø–∏—Å–∞–Ω–∏–µ                             |
| ----------------- | --------------------------------------------------------------------- | ------------------------------------ |
| `sandbox_run`     | `int sandbox_run(sandbox_context_t *ctx, const char *code)`           | –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ |
| `sandbox_load`    | `sandbox_context_t *sandbox_load(const char *name, sandbox_type_e t)` | –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ –∏–º–µ–Ω–∏ –∏ —Ç–∏–ø—É   |
| `sandbox_destroy` | `void sandbox_destroy(sandbox_context_t *ctx)`                        | –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞                   |

## üî´ –¢–µ—Å—Ç—ã

* `tests/sandbox/test_lua.c`
* `tests/sandbox/test_wasm.c`
* Fuzz: WASM –±–∞–π—Ç–∫–æ–¥—ã
* Coverage: >85%

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ        | –ó–∞–¥–µ—Ä–∂–∫–∞ |
| ----------------- | -------- |
| Lua sandbox       | \~1.2 –º—Å |
| WASM runtime      | \~1.8 –º—Å |
| Native plugin (C) | \~0.6 –º—Å |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                          |
| ----------------------- | ------ | ------------------------------------ |
| Lua sandbox             | 100    | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è, –∏–∑–æ–ª—è—Ü–∏—è                |
| WASM runtime            | 100    | –°–µ—Ç–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π, loop detection    |
| Native plugins (dlopen) | 100    | –†–æ–ª–µ–≤–æ–π –¥–æ—Å—Ç—É–ø, –∏–∑–æ–ª—è—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö |

## üìå –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```sql
-- Lua
CREATE FUNCTION hello() RETURNS TEXT
AS LUA $$ return 'Hello, world!' $$;
```

## üß∞ –ë—É–¥—É—â–∏–µ –∏–¥–µ–∏

* –°–±–æ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —Å–∫—Ä–∏–ø—Ç–∞–º
* –§–∏—Ä–º–µ–Ω–Ω–∞—è JIT-–∫–æ–º–ø–∏–ª—è—Ü–∏—è Lua/WASM
* –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ —Ö—ç–Ω–¥–ª–µ—Ä—ã –≤ Lua

## üìä UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
entity "UserScript" as US
entity "SandboxAPI" as API
entity "LuaEngine" as LUA
entity "WasmRuntime" as WASM
entity "NativePluginLoader" as NPL

US --> API
API --> LUA
API --> WASM
API --> NPL
@enduml
```

## üîó –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-–∑–∞–¥–∞—á–∞–º–∏

* ERP/–±–∏–∑–Ω–µ—Å-—Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
* –°–µ—Ä–≤–∏—Å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
* –§—É–Ω–∫—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

* RBAC/—Ä–æ–ª–µ–≤–æ–π –¥–æ—Å—Ç—É–ø –∫ –º–æ–¥—É–ª—è–º
* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏/–ø–∞–º—è—Ç–∏/–ø–æ—Ç–æ–∫–∞–º
* –°–∞–Ω–¥–±–æ–∫—Å —Å —Ç–æ—á–∫–æ–π –æ—Ç–∫–∞–∑


