# üì¶ –ü–∞–∫–µ—Ç 0 ‚Äî –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–π —Å—Ç–∞—Ä—Ç

| ‚Ññ –±–ª–æ–∫–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞                                                                           |
| ------- | ---------------------------------------------------------------------------------------- |
| 0.1     | –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (main)                                                     |

# üß± –ë–ª–æ–∫ 0.1 ‚Äî –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (main)

---

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 0. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–π —Å—Ç–∞—Ä—Ç
* **–ë–ª–æ–∫:** 0.1 –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (main)

---

| ‚Ññ –±–ª–æ–∫–∞ | –ù–∞–∑–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞                                           |
| ------: | -------------------------------------------------------- |
|     3.1 | SQL –Ø–¥—Ä–æ –∏ –ü–∞—Ä—Å–µ—Ä ANSI:2011+                             |
|     3.2 | SQL-–æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä                                          |
|     3.3 | –†–∞—Å—à–∏—Ä–µ–Ω–∏—è SQL: JSON, FILTER, –∞–≥—Ä–µ–≥–∞—Ç—ã, MATCH\_RECOGNIZE |
|     3.4 | –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π DSL –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π                           |
|     3.5 | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ UDF/UDAF: Lua, WASM, JS, C/C++                 |
|     3.6 | –Ø–∑—ã–∫ –ø—Ä–æ—Ü–µ–¥—É—Ä –∏ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ (PL/SQL-–ø–æ–¥–æ–±–Ω—ã–π)              |
|     3.7 | –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã: –æ–∫–Ω–∞, –ø—Ä–æ–≥–Ω–æ–∑, –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è       |


# 3.1 ‚Äî SQL –Ø–¥—Ä–æ –∏ –ü–∞—Ä—Å–µ—Ä ANSI:2011+

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 3 ‚Äî SQL –∏ –Ø–∑—ã–∫–∏**
**–ë–ª–æ–∫ 3.1 ‚Äî SQL –Ø–¥—Ä–æ –∏ –ü–∞—Ä—Å–µ—Ä ANSI:2011+**

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Ä–∞–∑–±–æ—Ä SQL-–∑–∞–ø—Ä–æ—Å–æ–≤, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É ANSI SQL:2011+, –≤–∫–ª—é—á–∞—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –¥–ª—è –æ–∫–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π, CTE, MERGE, JSON-–≤—ã—Ä–∞–∂–µ–Ω–∏–π –∏ –ø—Ä–æ—á–∏—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π. –û–Ω –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ª–µ–∫—Å–∏—á–µ—Å–∫–∏–π, —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–π –∏ —á–∞—Å—Ç–∏—á–Ω–æ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑, –ø—Ä–µ–æ–±—Ä–∞–∑—É—è –∑–∞–ø—Ä–æ—Å –≤ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ (AST/IR), –ø—Ä–∏–≥–æ–¥–Ω–æ–µ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ä—Å–µ—Ä–∞ –∫—Ä–∏—Ç–∏—á–Ω–∞ –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º SQL, —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç–∏ —è–∑—ã–∫–∞ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π, –ø—Ä–æ—Ü–µ–¥—É—Ä –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                      | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                                          |
| ------------------------------- | --------------------------------------------------------------------------------- |
| –õ–µ–∫—Å–µ—Ä (Tokenizer)              | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ª–∏—Ç–µ—Ä–∞–ª–æ–≤, escape, —Å–∏–º–≤–æ–ª–æ–≤ Unicode   |
| –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–π –ø–∞—Ä—Å–µ—Ä           | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è AST, —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π —Å–ø—É—Å–∫, –ø—Ä–µ–¥–∏–∫–∞—Ç–Ω–∞—è –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞ ANSI:2011+               |
| –†–∞—Å—à–∏—Ä–µ–Ω–∏—è —è–∑—ã–∫–∞                | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `WINDOW`, `FILTER`, `LATERAL`, `MERGE`, `MATCH_RECOGNIZE`, `JSON_TABLE` |
| –†–∞–∑–±–æ—Ä DML/DDL                  | INSERT, SELECT, UPDATE, DELETE, CREATE, ALTER, DROP, GRANT, CALL                  |
| –ö–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è WITH –∏ CTE          | `WITH RECURSIVE`, `MATERIALIZED`, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö CTE                        |
| –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Å–µ–º–∞–Ω—Ç–∏–∫–∞       | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤, —Ç–∏–ø–æ–≤, —Ñ—É–Ω–∫—Ü–∏–∏ –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ scoping                  |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ UDF/Stored Procedures | –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞ –¥–ª—è SQL-–ø—Ä–æ—Ü–µ–¥—É—Ä –∏ –≤—ã–∑–æ–≤–æ–≤ —Ö—Ä–∞–Ω–∏–º—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π                |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
typedef struct sql_ast_node_t {
  sql_ast_type_t type;
  union {
    struct select_stmt_t *select;
    struct insert_stmt_t *insert;
    struct ddl_stmt_t *ddl;
    ...
  } data;
  struct sql_ast_node_t *next;
} sql_ast_node_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏ (PlantUML)

```
SQLParser --> ASTBuilder
SQLParser --> FunctionRegistry
SQLParser --> StorageCatalog
SQLParser --> TypeSystem
SQLParser --> ErrorReporter
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: C23
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è peg-like –ø–∞—Ä—Å–µ—Ä —Å backtracking –∏ –ø—Ä–µ–¥–∏–∫–∞—Ç–∞–º–∏
* –ö–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ SQL —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –º–æ–¥—É–ª—å–Ω–æ ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–µ –º–æ–¥—É–ª–∏ –¥–ª—è –≤—ã—Ä–∞–∂–µ–Ω–∏–π, –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤, –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π, –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, escape-—Å–∏–º–≤–æ–ª–æ–≤ –∏ case-insensitive –ª–µ–∫—Å–µ–º
* –ß–∞—Å—Ç–∏—á–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è ANTLR-–≥—Ä–∞–º–º–∞—Ç–∏–∫–∏ SQL:2011 (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π DSL-–ø–æ–¥—Ö–æ–¥)

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/sql/parser.c`
* `src/sql/lexer.c`
* `include/sql/parser.h`
* `include/sql/ast.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏          | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                            | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                             |
| -------------------- | ------------------------------------------------------------------- | ------------------------------------------------------ |
| `sql_parse`          | `sql_ast_node_t *sql_parse(const char *query, parse_error_t *err);` | –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–∞—Ä—Å–µ—Ä–∞ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç AST –∏–ª–∏ –æ—à–∏–±–∫—É |
| `sql_ast_free`       | `void sql_ast_free(sql_ast_node_t *root);`                          | –û—á–∏—Å—Ç–∫–∞ AST-–¥–µ—Ä–µ–≤–∞ –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è                 |
| `sql_is_valid_ident` | `bool sql_is_valid_ident(const char *s);`                           | –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ SQL-–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞                 |
| `sql_parse_cte`      | `cte_node_t *sql_parse_cte(sql_ast_node_t *node);`                  | –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ CTE –∏–∑ —É–∑–ª–∞ –∑–∞–ø—Ä–æ—Å–∞                         |
| `sql_parse_window`   | `window_def_t *sql_parse_window(sql_ast_node_t *node);`             | –†–∞–∑–±–æ—Ä –æ–∫–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π                                 |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã: `tests/sql/test_parser.c`, `test_ast.c`
* Fuzz: `fuzz/sql_fuzz.c` ‚Äî —Å–ª—É—á–∞–π–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è SQL-–∑–∞–ø—Ä–æ—Å–æ–≤
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã: `tests/sql/test_queries.sql`
* Snapshot-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è IR

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                       | –ó–Ω–∞—á–µ–Ω–∏–µ                       |
| ----------------------------- | ------------------------------ |
| –°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø–∞—Ä—Å–∏–Ω–≥–∞     | \~120K –∑–∞–ø—Ä–æ—Å–æ–≤/—Å (–Ω–∞ 1 –ø–æ—Ç–æ–∫) |
| –ì–ª—É–±–∏–Ω–∞ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ | –¥–æ 64 —É—Ä–æ–≤–Ω–µ–π –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤      |
| –ó–∞–¥–µ—Ä–∂–∫–∞ –Ω–∞ —Å–ª–æ–∂–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ   | < 0.9 –º—Å –ø—Ä–∏ 10+ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞—Ö   |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                  | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                              |
| ------------------------- | ------ | -------------------------------------------------------- |
| ANSI SQL:2011+            | 100    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö –∫–ª—é—á–µ–≤—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π                      |
| –†–∞—Å—à–∏—Ä–µ–Ω–∏—è FILTER, WINDOW | 100    | –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–∫–æ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π                    |
| JSON / MERGE / LATERAL    | 95     | –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥–≤–∏–¥—ã –≤ —Ä–∞–±–æ—Ç–µ (`JSON_TABLE`, `MERGE USING`) |
| CTE –∏ WITH RECURSIVE      | 100    | –í–∫–ª—é—á–∞—è materialized/non-materialized                    |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ UDF/–ø—Ä–æ—Ü–µ–¥—É—Ä    | 90     | –ß–∞—Å—Ç–∏—á–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤ –≥—Ä–∞–º–º–∞—Ç–∏–∫–µ –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–æ–≥–æ —è–∑—ã–∫–∞      |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
sql_ast_node_t *ast = sql_parse("SELECT * FROM users WHERE age > 30", &err);
if (ast && !err.has_error) {
  execute_query(ast);
}
sql_ast_free(ast);
```

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ –Ω–∞ SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏
* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≥–ª—É–±–∏–Ω—ã —Ä–µ–∫—É—Ä—Å–∏–∏
* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –¥–ª–∏–Ω—É –∑–∞–ø—Ä–æ—Å–∞
* –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ —Å—Ç—Ä–æ–≥–æ—Å—Ç–∏ (STRICT vs LENIENT)

## üì§ –°–æ–æ–±—â–µ–Ω–∏—è –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

* `E_SQL_SYNTAX`: —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞
* `E_UNSUPPORTED_CLAUSE`: –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
* `W_AMBIGUOUS_COLUMN`: –Ω–µ–æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ–µ –∏–º—è —Å—Ç–æ–ª–±—Ü–∞
* `I_PARSE_OK`: —Ä–∞–∑–±–æ—Ä —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω

## üß© UML-–¥–∏–∞–≥—Ä–∞–º–º–∞ (PlantUML)

```plantuml
@startuml
package "3.1 SQL –Ø–¥—Ä–æ –∏ –ü–∞—Ä—Å–µ—Ä" {
  [SQL Parser] --> [AST Builder]
  [SQL Parser] --> [Function Registry]
  [SQL Parser] --> [Storage Catalog]
  [SQL Parser] --> [Type System]
  [SQL Parser] --> [Error Reporter]
}
@enduml
```

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v0.7 ‚Äî –±–∞–∑–æ–≤–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ SELECT/INSERT/UPDATE
* v0.9 ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω—ã –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, FILTER, LATERAL
* v1.0 ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ JSON\_EXPR, CTE, WITH RECURSIVE
* v1.1 ‚Äî –±—É–¥—É—â–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ MERGE USING, MATCH\_RECOGNIZE

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ MATCH\_RECOGNIZE –∏ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è PEG/ANTLR-–≥—Ä–∞–º–º–∞—Ç–∏–∫–∏ –¥–ª—è —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç–∏
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ PARSE JSON –∏ JSON\_TABLE
* –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ IR –¥–ª—è –∫–æ–¥–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

---

# 3.2 ‚Äî SQL-–æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 3 ‚Äî SQL –∏ –Ø–∑—ã–∫–∏**
**–ë–ª–æ–∫ 3.2 ‚Äî SQL-–æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä (Cost-based / Rule-based / Adaptive)**

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

SQL-–æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –≤—ã—Å–æ–∫–æ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –ø–ª–∞–Ω—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è. –ï–≥–æ –∫–ª—é—á–µ–≤–∞—è –∑–∞–¥–∞—á–∞ ‚Äî –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ —Å—á—ë—Ç –≤—ã–±–æ—Ä–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏, –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º. –û–Ω –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ —É—Å–ª–æ–≤–∏—è—Ö –≤—ã—Å–æ–∫–æ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∏ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç–∏.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞                    | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                              |
| ----------------------------- | --------------------------------------------------------------------- |
| Cost-Based Optimization (CBO) | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç NDV, –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã, –∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å, –æ—Ü–µ–Ω–∫—É —Å–µ–ª–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏     |
| Rule-Based Optimization (RBO) | Pushdown —Ñ–∏–ª—å—Ç—Ä–æ–≤, —É–ø—Ä–æ—â–µ–Ω–∏–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–π, –ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–∏–∫–∞—Ç–æ–≤ |
| Adaptive Optimization         | Runtime feedback loop, re-optimization –ø–æ—Å–ª–µ –ø–µ—Ä–≤—ã—Ö –±–ª–æ–∫–æ–≤            |
| Join Reordering               | –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (Greedy/DP —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏)      |
| Projection Pruning            | –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤                                      |
| Subquery Rewrite              | Unnesting, –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ EXISTS/IN –≤ JOIN                            |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
// –ü–ª–∞–Ω —É–∑–ª–∞
typedef struct plan_node_t {
  plan_type_t type;
  double cost;
  struct plan_node_t **children;
  size_t child_count;
  filter_expr_t *predicate;
  projection_list_t *projection;
} plan_node_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏ (PlantUML)

```
SQLParser --> SQLOptimizer
SQLOptimizer --> PlanGenerator
SQLOptimizer --> CostModel
SQLOptimizer --> StatisticsEngine
SQLOptimizer --> Storage
SQLOptimizer --> Catalog
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: C23
* –ê–ª–≥–æ—Ä–∏—Ç–º—ã: Greedy, Dynamic Programming, Cascades
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ—Ä—Ä–µ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤ –∏ lateral join
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–≥–æ–º–µ—Ä–Ω–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏: latency, memory, I/O
* NUMA-aware CostModel (–ø—Ä–∏ –≤—ã–±–æ—Ä–µ hash join vs merge join)

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/sql/optimizer.c`
* `include/sql/optimizer.h`
* `src/sql/cost_model.c`
* `include/sql/cost_model.h`
* `src/sql/plan_rules.c`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è                       | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                   | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ                                 |
| ------------------------- | ---------------------------------------------------------- | ------------------------------------------ |
| `optimizer_generate_plan` | `plan_node_t *optimizer_generate_plan(ast_node_t *query);` | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–∞–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ AST –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ |
| `cost_estimate_node`      | `double cost_estimate_node(plan_node_t *n);`               | –û—Ü–µ–Ω–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —É–∑–ª–∞ –ø–ª–∞–Ω–∞                |
| `rewrite_subqueries`      | `ast_node_t *rewrite_subqueries(ast_node_t *q);`           | –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤                  |
| `reorder_joins`           | `void reorder_joins(join_tree_t *j);`                      | –ü–µ—Ä–µ—É–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–Ω–∏–µ –¥–µ—Ä–µ–≤—å–µ–≤ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π     |
| `prune_projection`        | `void prune_projection(plan_node_t *p);`                   | –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–Ω—É–∂–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ü–∏–π –∏–∑ –ø–ª–∞–Ω–∞        |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/sql/test_optimizer.c`
* Integration: `tests/sql/test_queries.sql`
* Fuzz: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö AST + —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫
* Regression: –ø–ª–∞–Ω—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ cost\_model

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞                   | –ó–Ω–∞—á–µ–Ω–∏–µ                                           |
| ------------------------- | -------------------------------------------------- |
| –í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–∞     | \~0.6‚Äì1.5 –º—Å –Ω–∞ —Å–ª–æ–∂–Ω—ã–π SELECT —Å JOIN –∏ –∞–≥—Ä–µ–≥–∞—Ç–∞–º–∏ |
| –ì–ª—É–±–∏–Ω–∞ join reorder      | –¥–æ 8 —Ç–∞–±–ª–∏—Ü (DP + pruning)                         |
| –°–∫–æ—Ä–æ—Å—Ç—å subquery rewrite | \~200K –∑–∞–ø—Ä–æ—Å–æ–≤/—Å                                  |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π           | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                         |
| ------------------ | ------ | --------------------------------------------------- |
| Cost-based plan    | 100    | NDV, –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã, feedback loop                     |
| Rule-based rewrite | 100    | –ü—Ä–∞–≤–∏–ª–∞ pushdown/unnest/prune —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã           |
| Adaptive reopt     | 95     | Feedback –≤–∫–ª—é—á—ë–Ω, –Ω–æ –Ω–µ –≤—Å–µ–≥–¥–∞ –∞–∫—Ç–∏–≤–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –Ω–∞ C

```c
plan_node_t *plan = optimizer_generate_plan(ast);
if (plan->cost > MAX_COST) {
  fallback_to_index_hint();
}
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* Cost-based reorder –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤
* ML-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–Ω–∞–±–ª—é–¥–∞–µ–º–æ–µ –æ–±—É—á–µ–Ω–∏–µ)
* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ gRPC-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ explain –ø–ª–∞–Ω–æ–≤

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
* –î–æ—Å—Ç—É–ø –∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ —Ç–∞–±–ª–∏—Ü –æ–≥—Ä–∞–Ω–∏—á–µ–Ω ACL
* –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—è –ø–æ–≤–µ–¥–µ–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–∞ —á–µ—Ä–µ–∑ –ø—Ä–æ—Ñ–∏–ª–∏

## üì§ –°–æ–æ–±—â–µ–Ω–∏—è –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

* `I_OPTIMIZED_PLAN`: –ø–ª–∞–Ω —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω
* `W_HIGH_COST_PLAN`: —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ø–æ—Ä–æ–≥
* `E_INVALID_STATISTICS`: –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã NDV/gist –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã

## üß© UML-–¥–∏–∞–≥—Ä–∞–º–º–∞ (PlantUML)

```
@startuml
package "SQL Optimizer (3.2)" {
  [Optimizer] --> [Cost Model]
  [Optimizer] --> [Plan Generator]
  [Optimizer] --> [Statistics Engine]
  [Optimizer] --> [Catalog]
  [Optimizer] --> [SQL Parser]
}
@enduml
```

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v0.7 ‚Äî –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π CostModel –∏ RuleEngine (2025-06-28)
* v0.9 ‚Äî Join Reorder, Projection Prune (2025-07-08)
* v1.0 ‚Äî –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π reopt (2025-07-19)

# 3.3 ‚Äî –†–∞—Å—à–∏—Ä–µ–Ω–∏—è SQL: JSON, FILTER, –∞–≥—Ä–µ–≥–∞—Ç—ã, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, MATCH\_RECOGNIZE

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 3 ‚Äî SQL –∏ –Ø–∑—ã–∫–∏**
**–ë–ª–æ–∫ 3.3 ‚Äî –†–∞—Å—à–∏—Ä–µ–Ω–∏—è SQL: JSON, FILTER, –∞–≥—Ä–µ–≥–∞—Ç—ã, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, MATCH\_RECOGNIZE**

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–î–∞–Ω–Ω—ã–π –±–ª–æ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ SQL-—Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞, –≤–∫–ª—é—á–∞—è JSON-–æ–ø–µ—Ä–∞—Ç–æ—Ä—ã, FILTER-–∫–ª–∞—É–∑—ã –¥–ª—è –∞–≥—Ä–µ–≥–∞—Ç–æ–≤, –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ MATCH\_RECOGNIZE –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤. –≠—Ç–æ –∫–ª—é—á–µ–≤–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –æ–ª–∞–ø-–∞–Ω–∞–ª–∏—Ç–∏–∫–∏, ETL-—Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –∏ —Ä–µ–∞–ª—å–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤ –≤ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–∞—Ö.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞       | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è                                                       |
| ---------------- | ---------------------------------------------------------------- |
| JSON support     | JSON\_VALUE, JSON\_QUERY, JSON\_TABLE, JSON\_OBJECT, JSON\_ARRAY |
| FILTER           | SELECT COUNT(\*) FILTER (WHERE col > 10)                         |
| –ê–≥—Ä–µ–≥–∞—Ç—ã         | COUNT, SUM, AVG, MIN, MAX, GROUPING SETS, ROLLUP, CUBE           |
| –ê–Ω–∞–ª–∏—Ç–∏–∫–∞        | WINDOW FUNCTIONS (RANK, LAG, LEAD, NTILE)                        |
| MATCH\_RECOGNIZE | –®–∞–±–ª–æ–Ω—ã –≤ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–∞—Ö, PATTERN, DEFINE                       |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
// JSON-–æ–±—ä–µ–∫—Ç
typedef struct json_value_t {
  enum { JSON_NULL, JSON_BOOL, JSON_NUMBER, JSON_STRING, JSON_ARRAY, JSON_OBJECT } type;
  union {
    bool b;
    double num;
    char *str;
    struct json_value_t **elements;
    struct { char **keys; struct json_value_t **values; } object;
  } data;
} json_value_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```
SQLExtensions --> SQLParser
SQLExtensions --> SQLOptimizer
SQLExtensions --> ExpressionEngine
SQLExtensions --> WindowEngine
SQLExtensions --> JSONEngine
SQLExtensions --> PatternEngine
```

## üßê –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: C23 (+ optional Lua –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –∞–≥—Ä–µ–≥–∞—Ç–æ–≤)
* JSON parser: –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, zero-copy
* Window engine: –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–∞—Å—Å —Å –≤–µ–∫—Ç–æ—Ä–Ω—ã–º –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ–º
* Pattern engine: NFA-–ø–æ–¥–æ–±–Ω—ã–π, stateful –¥–µ—Ç–µ–∫—Ç–æ—Ä –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —à–∞–±–ª–æ–Ω–æ–≤

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/sql/extensions.c`
* `include/sql/extensions.h`
* `src/sql/json_engine.c`
* `src/sql/window_engine.c`
* `src/sql/pattern_engine.c`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è                    | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                              | –û–ø–∏—Å–∞–Ω–∏–µ                  |
| ---------------------- | --------------------------------------------------------------------- | ------------------------- |
| `eval_json_path`       | `json_value_t *eval_json_path(json_value_t *root, const char *path);` | –ü–æ–∏—Å–∫ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ –ø—É—Ç–∏    |
| `apply_filter_clause`  | `bool apply_filter_clause(row_t *r, expr_t *predicate);`              | –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –¥–ª—è –∞–≥–≥—Ä–µ–≥–∞—Ç–æ–≤ |
| `window_rank`          | `int *window_rank(rowset_t *rs, partition_t *p);`                     | RANK/—Ä–µ–π—Ç–∏–Ω–≥ –ø–æ –æ–∫–Ω—É      |
| `match_recognize_eval` | `bool match_recognize_eval(rowset_t *ts, pattern_def_t *p);`          | –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤      |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/sql/test_json.c`, `test_window.c`, `test_pattern.c`
* Fuzz: —Å–ª—É—á–∞–π–Ω—ã–µ JSON –∏ PATTERN
* Coverage: 96% JSON, 92% WINDOW, 88% PATTERN

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞          | –ó–Ω–∞—á–µ–Ω–∏–µ             |
| ---------------- | -------------------- |
| JSON –æ–±—Ä–∞–±–æ—Ç–∫–∞   | –¥–æ 1.2 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π/—Å |
| –û–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏  | \~1.8 –º–ª–Ω –æ–ø–µ—Ä–∞—Ü–∏–π/—Å |
| MATCH\_RECOGNIZE | \~480K —à–∞–±–ª–æ–Ω–æ–≤/—Å    |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π          | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                 |
| ----------------- | ------ | ------------------------------------------- |
| JSON —Ñ—É–Ω–∫—Ü–∏–∏      | 100    | –ü–æ–ª–Ω–∞—è ANSI-–ø–æ–¥–¥–µ—Ä–∂–∫–∞                       |
| FILTER –∏ –∞–≥—Ä–µ–≥–∞—Ç—ã | 100    | –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å + ROLLUP/CUBE         |
| MATCH\_RECOGNIZE  | 95     | –ï—Å—Ç—å NFA, –Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –≥–ª—É–±–∏–Ω–µ PATTERN |

## üìå –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```sql
SELECT JSON_VALUE(data, '$.customer.name') AS name,
       COUNT(*) FILTER (WHERE amount > 1000),
       RANK() OVER (PARTITION BY region ORDER BY amount DESC)
  FROM orders
MATCH_RECOGNIZE (
  PARTITION BY account_id
  ORDER BY event_time
  PATTERN (A B+)
  DEFINE
    A AS A.amount < 100,
    B AS B.amount > 1000
)
```

## ü§ñ –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–ª–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è JSON\_SCHEMA
* MATCH\_RECOGNIZE —Å –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞–º–∏ –∞


# 3.4 ‚Äî –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π DSL –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 3 ‚Äî SQL –∏ –Ø–∑—ã–∫–∏**
**–ë–ª–æ–∫ 3.4 ‚Äî –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π DSL –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–≤ —Å—Ç–∏–ª–µ ABAP/PL/SQL)**

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –æ–ø–∏—Å—ã–≤–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Å –ø–æ–º–æ—â—å—é –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–æ–≥–æ —è–∑—ã–∫–∞, –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –≤ –°–£–ë–î. DSL (Domain-Specific Language) –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—É—é —Å ACID-—Å–µ–º–∞–Ω—Ç–∏–∫–æ–π, –≤–∫–ª—é—á–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã, —Ü–∏–∫–ª—ã, —É—Å–ª–æ–≤–∏—è, –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏ —Ö—É–∫–∏.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞    | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                             |
| ------------- | ---------------------------------------------------- |
| –Ø–¥—Ä–æ DSL      | –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä –≤ —Å—Ç–∏–ª–µ PL/SQL / ABAP       |
| –ü—Ä–æ—Ü–µ–¥—É—Ä—ã     | `BEGIN ... END`, `DECLARE`, `EXCEPTION`, `CALL`      |
| –•—É–∫–∏          | `BEFORE INSERT`, `AFTER UPDATE`, `ON DELETE`         |
| –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `DECLARE`, `SET`, `IF`, `WHILE`, `FOR`     |
| –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏    | –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ `BEGIN TRANSACTION`, `COMMIT`, `ROLLBACK` |
| –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å | –ú–∞–∫—Ä–æ—Å—ã, —à–∞–±–ª–æ–Ω—ã, –≤–∫–ª—é—á–µ–Ω–∏–µ UDF/UDTF                 |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
// –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ–º–æ–π –ø—Ä–æ—Ü–µ–¥—É—Ä—ã DSL
typedef struct dsl_proc_t {
  const char *name;
  stmt_list_t *statements;
  symbol_table_t *locals;
  hook_point_t hook;
} dsl_proc_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```
SQLParser --> DSLParser
Planner --> DSLPlanner
Executor --> DSLRuntime
Storage --> TxManager
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: C23
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–µ–∫–æ–≤–∞—è –º–∞—à–∏–Ω–∞ (stack VM) –¥–ª—è –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è DSL
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ sandbox-—Ä–µ–∂–∏–º–∞ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞
* –ö–æ–Ω—Ç—Ä–æ–ª—å –ø–∞–º—è—Ç–∏, rollback-–Ω–∞–≤–∏–≥–∞—Ü–∏—è, –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∫–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/dsl/dsl_parser.c`
* `src/dsl/dsl_runtime.c`
* `include/dsl/dsl.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è                   | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                        | –û–ø–∏—Å–∞–Ω–∏–µ                                        |
| --------------------- | ------------------------------------------------------------------------------- | ----------------------------------------------- |
| `dsl_parse_procedure` | `dsl_proc_t *dsl_parse_procedure(const char *source);`                          | –ü–∞—Ä—Å–∏–Ω–≥ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã DSL                    |
| `dsl_execute`         | `result_t *dsl_execute(dsl_proc_t *proc, db_session_t *session);`               | –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã DSL –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ |
| `dsl_hook_register`   | `void dsl_hook_register(table_t *table, hook_point_t point, dsl_proc_t *proc);` | –ü—Ä–∏–≤—è–∑–∫–∞ DSL –∫ —Å–æ–±—ã—Ç–∏—é                          |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/dsl/test_parser.c`, `test_runtime.c`
* Fuzz: —Å–ª—É—á–∞–π–Ω–æ–µ –ø–æ—Ä–æ–∂–¥–µ–Ω–∏–µ –±–ª–æ–∫–æ–≤ DSL
* Soak: –¥–ª–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Å rollback/commit –≤ —Ä–∞–∑–Ω—ã—Ö –≤–µ—Ç–∫–∞—Ö
* Coverage: –ø–æ–∫—Ä—ã—Ç–∏–µ –ª–æ–≥–∏–∫–∏ control flow > 90%

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è        | –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å              |
| --------------- | ----------------------- |
| –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ DSL  | \~4.5 –º–ª–Ω –æ–ø–µ—Ä–∞—Ü–∏–π/—Å    |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ö—É–∫–æ–≤ | < 1 –º–∫—Å –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π         | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                 |
| ---------------- | ------ | ------------------------------------------- |
| –Ø–∑—ã–∫ DSL         | 100    | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å SQL | 100    | –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –≤—ã–∑–æ–≤ SQL –∏ UDF –∏–∑ DSL           |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```sql
BEGIN
  DECLARE total INT;
  SELECT COUNT(*) INTO total FROM orders;
  IF total > 1000 THEN
    CALL archive_old_orders();
  END IF;
END;
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ—à–∞–≥–æ–≤–æ–π –æ—Ç–ª–∞–¥–∫–∏ DSL-–ø—Ä–æ—Ü–µ–¥—É—Ä
* –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–ª–æ–∫–æ–≤ TRY/CATCH
* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∏–∑ –∫–æ–¥–∞ DSL

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞ (PlantUML)

```plantuml
@startuml
entity "DSLParser" as DP
entity "DSLRuntime" as DR
entity "TxManager" as TX
DP --> DR
DR --> TX
@enduml
```

## üè¢ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª (–≤–∞–ª–∏–¥–∞—Ü–∏—è, –º–∞—Ä—à—Ä—É—Ç—ã)
* ETL –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –±–µ–∑ –≤–Ω–µ—à–Ω–µ–≥–æ –∫–æ–¥–∞
* –§–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏ —à–∞–±–ª–æ–Ω—ã –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤

## üìú –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0: DSL –ø–∞—Ä—Å–µ—Ä –∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä (–∞–≤–≥—É—Å—Ç 2025)
* v1.1: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ö—É–∫–æ–≤ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, —É–ª—É—á—à–µ–Ω–∏–µ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ DSL

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∫ –æ–±—ä–µ–∫—Ç–∞–º –∏ –ø–∞–º—è—Ç–∏ DSL
* –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–Ω–æ–º–æ—á–∏–π –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä
* –õ–∏–º–∏—Ç—ã –≤—Ä–µ–º–µ–Ω–∏ –∏ –≥–ª—É–±–∏–Ω—ã —Ä–µ–∫—É—Ä—Å–∏–∏

## üì¢ –°–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—à–∏–±–∫–∏

| –ö–æ–¥      | –°–æ–æ–±—â–µ–Ω–∏–µ                  | –û–ø–∏—Å–∞–Ω–∏–µ                                    |
| -------- | -------------------------- | ------------------------------------------- |
| `DSL001` | "Syntax error in DSL"      | –û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ DSL –≤—ã—Ä–∞–∂–µ–Ω–∏—è                |
| `DSL002` | "Hook target not found"    | –£–∫–∞–∑–∞–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∏–ª–∏ —Å–æ–±—ã—Ç–∏–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç |
| `DSL003` | "Execution stack overflow" | –ü—Ä–µ–≤—ã—à–µ–Ω–∞ –≥–ª—É–±–∏–Ω–∞ —Ä–µ–∫—É—Ä—Å–∏–∏ –∏–ª–∏ call stack   |

# 3.5 ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞ UDF/UDAF: Lua, WASM, JS, C/C++

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 3 ‚Äî SQL –∏ –Ø–∑—ã–∫–∏**
**–ë–ª–æ–∫ 3.5 ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∫–∞ UDF/UDAF: Lua, WASM, JS, C/C++**

## üåü –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–∞—Å—à–∏—Ä—è—Ç—å SQL-—è–¥—Ä–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –∏ –∞–≥—Ä–µ–≥–∞—Ç–∞–º–∏ (UDF/UDAF) –Ω–∞ —è–∑—ã–∫–∞—Ö –≤—ã—Å–æ–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è (–∫–∞–∫ Lua, JavaScript, WebAssembly), —Ç–∞–∫ –∏ C/C++, –≤ —Ç–æ–º —á–∏—Å–ª–µ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π sandbox –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞            | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                        |
| --------------------- | ----------------------------------------------- |
| Lua UDF runtime       | –õ—ë–≥–∫–∏–π –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ç–æ—Ä Lua, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ coroutine   |
| WASM sandbox          | –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–æ–¥—É–ª–∏, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –ø–∞–º—è—Ç–∏       |
| JS runtime (optional) | –°–≤—è–∑—å —Å Duktape/V8, –≤ —Å–∞–Ω–¥–±–æ–∫—Å–µ —Å –ª–∏–º–∏—Ç–∞–º–∏      |
| C/C++ Native UDF      | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ dlopen/–ø–ª–∞–≥–∏–Ω—ã, –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ API |
| –ê–≥—Ä–µ–≥–∞—Ç—ã (UDAF)       | –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è, merge –∏ finalize-—à–∞–≥–∏     |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ UDF
typedef struct udf_entry_t {
  const char *name;
  udf_language_t lang;
  void *compiled_ptr;
  bool is_aggregate;
} udf_entry_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```
SQLParser --> UDFRegistry
Executor --> UDFEngine
UDFEngine --> LuaRuntime
UDFEngine --> WasmSandbox
UDFEngine --> NativePluginManager
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: C23 + WASM Toolchain
* –û—Ç–¥–µ–ª—å–Ω—ã–µ —Å—Ç–µ–∫–∏ –¥–ª—è Lua/WASM/JS
* –°–±–æ—Ä–∫–∞ –º—É—Å–æ—Ä–∞ –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –º–∞—à–∏–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
* –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –±–∞–π—Ç–∫–æ–¥–∞ –¥–ª—è –∑–∞—â–∏—Ç—ã

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/udf/udf_engine.c`
* `src/udf/lua_runtime.c`
* `src/udf/wasm_runtime.c`
* `include/udf/udf.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è            | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                | –û–ø–∏—Å–∞–Ω–∏–µ                       |
| -------------- | ----------------------------------------------------------------------- | ------------------------------ |
| `udf_register` | `void udf_register(const char *name, udf_language_t lang, void *code);` | –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è UDF —Å–µ—Å—Å–∏–∏         |
| `udf_execute`  | `value_t udf_execute(const char *name, const value_t *args, int argc);` | –í—ã–∑–æ–≤ UDF –≤ SQL-–∑–∞–ø—Ä–æ—Å–µ        |
| `udf_list`     | `list_t *udf_list(void);`                                               | –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö UDF |

## üßö‚Äç‚ôÇÔ∏è –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `test/udf/test_lua.c`, `test_udf_wasm.c`
* Fuzz: –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å—Ç–µ–∫ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
* Sandbox: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –ø–∞–º—è—Ç–∏, —Ç–µ—Å—Ç –æ—Ç–∫–∞—Ç–∞

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –°—Ü–µ–Ω–∞—Ä–∏–π               | –ú–µ—Ç—Ä–∏–∫–∞   |
| ---------------------- | --------- |
| Lua-Fibonacci(20)      | 1.1 –º–ª–Ω/—Å |
| WASM-avg(x, y)         | 4.2 –º–ª–Ω/—Å |
| C++ native normalize() | 6.3 –º–ª–Ω/—Å |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π     | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                      |
| ------------ | ------ | -------------------------------- |
| Lua/WASM/JS  | 100    | –°–∞–Ω–¥–±–æ–∫—Å –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –ø–∞–º—è—Ç–∏ |
| Native C/C++ | 100    | –ß–µ—Ä–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é dlopen + ACL   |

## üìå –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```lua
function cube(x)
  return x * x * x
end
```

## üß∞ –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Python (MicroPython)
* –î–µ–±–∞–≥–≥–µ—Ä –∏ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤—â–∏–∫ DSL
* –ö—ç—à-–ø—Ä–æ—Ñ–∏–ª—å UDF –Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ –≤—ã–∑–æ–≤–æ–≤

## üìä UML-PlantUML

```plantuml
@startuml
component UDFRegistry
component LuaRuntime
component WasmSandbox
component NativePluginManager
UDFRegistry --> LuaRuntime
UDFRegistry --> WasmSandbox
UDFRegistry --> NativePluginManager
@enduml
```

## üè¢ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–Ω–æ–º–∞–ª–∏–π, —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä–∞—Å—á—ë

# 3.6 ‚Äî PL/SQL-–ø–æ–¥–æ–±–Ω—ã–π —è–∑—ã–∫: –ø—Ä–æ—Ü–µ–¥—É—Ä—ã, —Ç—Ä–∏–≥–≥–µ—Ä—ã, exec hooks

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 3 ‚Äî SQL –∏ –Ø–∑—ã–∫–∏**
**–ë–ª–æ–∫ 3.6 ‚Äî PL/SQL-–ø–æ–¥–æ–±–Ω—ã–π —è–∑—ã–∫: –ø—Ä–æ—Ü–µ–¥—É—Ä—ã, —Ç—Ä–∏–≥–≥–µ—Ä—ã, exec hooks**

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–æ–≥–æ —è–∑—ã–∫–∞, –ø–æ–¥–æ–±–Ω–æ–≥–æ PL/SQL, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–≥–æ –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤, —Ö—Ä–∞–Ω–∏–º—ã—Ö –ø—Ä–æ—Ü–µ–¥—É—Ä –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ (execution hooks). –û–Ω –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø—Ä–∏–∫–ª–∞–¥–Ω—É—é –ª–æ–≥–∏–∫—É –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞ –∏ —Ä–∞—Å—à–∏—Ä—è—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤–Ω–µ—à–Ω–µ–≥–æ –∫–æ–¥–∞.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞       | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                         |
| ---------------- | ---------------------------------------------------------------- |
| –ü—Ä–æ—Ü–µ–¥—É—Ä—ã        | `CREATE PROCEDURE`, `BEGIN ... END`, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã IN/OUT, RETURN    |
| –¢—Ä–∏–≥–≥–µ—Ä—ã         | `CREATE TRIGGER ... BEFORE/AFTER INSERT/UPDATE/DELETE`           |
| Execution Hooks  | –•—É–∫–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è: pre-query, post-query, pre-commit, on-exception |
| Control Flow     | `IF`, `CASE`, `LOOP`, `WHILE`, `EXIT`, `GOTO`                    |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ | `EXCEPTION`, `WHEN`, `RAISE`                                     |
| –ú–æ–¥—É–ª–∏           | –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä –≤ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –º–æ–¥—É–ª–∏                         |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
// –•—Ä–∞–Ω–∏–º–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞
typedef struct plsql_proc_t {
  char *name;
  plsql_stmt_list_t *body;
  param_list_t *params;
  bool is_trigger;
  exec_hook_t hook_type;
} plsql_proc_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```
SQLParser --> PLParser
Planner --> PLPlanner
Executor --> PLRuntime
PLRuntime --> TxManager
PLRuntime --> Storage
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: C23
* –°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–≥–Ω–∞—Ç—É—Ä –ø—Ä–æ—Ü–µ–¥—É—Ä
* –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ rollback, resume, continue
* –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∫–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è —Å —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–æ–π
* –ö–æ–Ω—Ç—Ä–æ–ª—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –≥–ª—É–±–∏–Ω—ã –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/plsql/pl_parser.c`
* `src/plsql/pl_runtime.c`
* `include/plsql/plsql.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è                      | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                       | –û–ø–∏—Å–∞–Ω–∏–µ                    |
| ------------------------ | ------------------------------------------------------------------------------ | --------------------------- |
| `plsql_parse`            | `plsql_proc_t *plsql_parse(const char *source);`                               | –ü–∞—Ä—Å–∏–Ω–≥ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã           |
| `plsql_exec`             | `result_t *plsql_exec(plsql_proc_t *proc, db_session_t *s);`                   | –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã        |
| `plsql_trigger_register` | `void plsql_trigger_register(table_t *t, trigger_event_t e, plsql_proc_t *p);` | –ü—Ä–∏–≤—è–∑–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/plsql/test_parser.c`, `test_runtime.c`
* Fuzz: –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏ –∏ —Ü–∏–∫–ª–∞–º–∏
* Soak: –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã –ø—Ä–æ—Ü–µ–¥—É—Ä –≤ —Ü–∏–∫–ª–∞—Ö
* Coverage: –∫–æ–Ω—Ç—Ä–æ–ª—å –ø–æ–∫—Ä—ã—Ç–∏–π —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤, —Ö—É–∫–æ–≤, –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è                 | –ú–µ—Ç—Ä–∏–∫–∞            |
| ------------------------ | ------------------ |
| –í—ã–∑–æ–≤ —Ö—Ä–∞–Ω–∏–º–æ–π –ø—Ä–æ—Ü–µ–¥—É—Ä—ã | \~3 –º–ª–Ω –æ–ø–µ—Ä–∞—Ü–∏–π/—Å |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ AFTER-—Ç—Ä–∏–≥–≥–µ—Ä–∞ | < 1 –º–∫—Å            |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π                       | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                  |
| ------------------------------ | ------ | -------------------------------------------- |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä –∏ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ | 100    | –°–æ–≤–º–µ—Å—Ç–∏–º–æ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏ PL/SQL             |
| Execution Hooks                | 95     | –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è, —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ on-fail |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```sql
CREATE PROCEDURE archive_orders()
BEGIN
  DELETE FROM orders WHERE status = 'archived';
  INSERT INTO log (msg) VALUES ('Orders archived');
END;
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ CURSOR –∏ FETCH –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
* –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏
* –û—Ç–ª–∞–¥—á–∏–∫ –∏ –ø–æ—à–∞–≥–æ–≤–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞ (PlantUML)

```plantuml
@startuml
entity "PLParser" as PP
entity "PLRuntime" as PR
entity "TxManager" as TX
PP --> PR
PR --> TX
@enduml
```

## üè¢ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª –Ω–∞ —É—Ä–æ–≤–Ω–µ –±–∞–∑—ã
* –ê—É–¥–∏—Ç, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ —Å–æ–±—ã—Ç–∏—è–º
* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ERP/ETL –±–µ–∑ –≤–Ω–µ—à–Ω–µ–≥–æ –∫–æ–¥–∞

## üìú –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0: –•—Ä–∞–Ω–∏–º—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã, –±–∞–∑–æ–≤—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã
* v1.1: Execution hooks, –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∫–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ò–∑–æ–ª—è—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–¥—É—Ä
* –ö–æ–Ω—Ç—Ä–æ–ª—å –ø—Ä–∞–≤ –Ω–∞ CREATE TRIGGER / PROCEDURE
* –õ–∏–º–∏—Ç—ã –Ω–∞ –≥–ª—É–±–∏–Ω—É –∏ —Å—Ç–µ–∫ –≤—ã–∑–æ–≤–æ–≤

## üì¢ –°–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—à–∏–±–∫–∏

| –ö–æ–¥     | –°–æ–æ–±—â–µ–Ω–∏–µ                    | –û–ø–∏—Å–∞–Ω–∏–µ                                 |
| ------- | ---------------------------- | ---------------------------------------- |
| `PL001` | "Syntax error in procedure"  | –û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ            |
| `PL002` | "Hook registration failed"   | –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å exec hook    |
| `PL003` | "Procedure call depth limit" | –ü—Ä–µ–≤—ã—à–µ–Ω–∞ –¥–æ–ø—É—Å—Ç–∏–º–∞—è –≥–ª—É–±–∏–Ω–∞ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ |

# 3.7 ‚Äî –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã: –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è, –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ

## üè¢ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

**–ü–∞–∫–µ—Ç 3 ‚Äî SQL –∏ –Ø–∑—ã–∫–∏**
**–ë–ª–æ–∫ 3.7 ‚Äî –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã: –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è, –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ**

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—Ç —Å–æ–±–æ–π –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –≤—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã SQL-–¥–≤–∏–∂–∫–∞, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ–∞–ª–∏–∑—É—é—Ç —Å–ª–æ–∂–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –≤–∫–ª—é—á–∞—è –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∞–Ω–∞–ª–∏–∑. –≠—Ç–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –ø–æ–∑–≤–æ–ª—è—é—Ç –±–µ–∑ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ –∫–æ–¥–∞ –ø—Ä–æ–≤–æ–¥–∏—Ç—å –∞–≥—Ä–µ–≥–∞—Ü–∏–∏, —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ, —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—é –∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ SQL-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞            | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                       |
| --------------------- | -------------------------------------------------------------- |
| –û–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏       | RANK, DENSE\_RANK, NTILE, LAG, LEAD, FIRST\_VALUE, LAST\_VALUE |
| –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è         | K-means, DBSCAN, HDBSCAN                                       |
| –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ       | ARIMA, Exponential Smoothing, Prophet (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π API)         |
| –ü—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö | –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏, —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å, –≤—ã–±—Ä–æ—Å—ã                                |
| –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å         | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ UDF-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –º–æ–¥–µ–ª—å—é –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è             |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

```c
// –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–∫–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
typedef struct window_fn_t {
  const char *name;
  enum window_type_e type;
  expr_t *partition_by;
  expr_t *order_by;
  frame_spec_t *frame;
} window_fn_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```
QueryPlanner --> WindowFunctionResolver
QueryPlanner --> MLFunctionResolver
Executor --> WindowFunctionExecutor
Executor --> ForecastEngine
Optimizer --> WindowPushdown
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* –Ø–∑—ã–∫: C23
* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä —Ñ—Ä–µ–π–º–æ–≤ (frame compiler) –∏ –ø—Ä–µ–¥–∞–≥—Ä–µ–≥–∞—Ü–∏—è
* –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è –∫–∞–∫ –ø–æ—Ç–æ–∫–æ–≤—ã–π –ø–ª–∞–Ω (streamed plan)
* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –≤–µ–∫—Ç–æ—Ä–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ, SIMD-aware

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/sql/window.c`
* `src/sql/forecast.c`
* `src/sql/clustering.c`
* `include/sql/window.h`
* `include/sql/forecast.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è              | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                  | –û–ø–∏—Å–∞–Ω–∏–µ                      |
| ---------------- | ------------------------------------------------------------------------- | ----------------------------- |
| `window_fn_exec` | `result_t *window_fn_exec(window_fn_t *fn, exec_ctx_t *ctx);`             | –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–∫–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏    |
| `forecast_run`   | `forecast_result_t *forecast_run(model_t *model, series_t *input);`       | –ó–∞–ø—É—Å–∫ –º–æ–¥–µ–ª–∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è |
| `cluster_exec`   | `cluster_result_t *cluster_exec(cluster_model_t *model, table_t *input);` | –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö          |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/sql/test_window.c`, `test_forecast.c`
* Fuzz: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö –æ–∫–æ–Ω–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π –∏ –≤—Ö–æ–¥–æ–≤
* Soak: –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–∫–æ–Ω–Ω—ã—Ö –∞–≥—Ä–µ–≥–∞—Ü–∏–π –Ω–∞ –±–æ–ª—å—à–∏—Ö –Ω–∞–±–æ—Ä–∞—Ö
* Coverage: > 93% –ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –æ–∫–Ω–∞–º

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è              | –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å                            |
| --------------------- | ------------------------------------- |
| LAG/LEAD –æ–∫–æ–Ω–Ω—ã–µ      | < 700 –Ω—Å                              |
| –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ ARIMA | \~3 –º–ª–Ω –∑–∞–ø–∏—Å–µ–π/—Å                     |
| K-means –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è | 1 –º–ª–Ω —Ç–æ—á–µ–∫ –∑–∞ \~0.45 —Å (8 –∫–ª–∞—Å—Ç–µ—Ä–æ–≤) |

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π        | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                     |
| --------------- | ------ | ----------------------------------------------- |
| –û–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ | 100    | –ü–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ SQL:2011 –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π           |
| –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ | 95     | –ß–∞—Å—Ç–∏—á–Ω–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ ONNX-–º–æ–¥—É–ª—è        |
| –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è   | 100    | –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤, –≤–∫–ª—é—á–∞—è DBSCAN |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```sql
SELECT customer_id,
       RANK() OVER (PARTITION BY region ORDER BY total_spent DESC) AS rank,
       FORECAST(total_spent, 12) AS prediction
  FROM customer_spending
 WHERE year = 2025;
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ONNX-–∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞ –Ω–∞–ø—Ä—è–º—É—é –≤ SQL
* –í–∏–∑—É–∞–ª—å–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π (Explainable ML)
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≥–∏–±—Ä–∏–¥–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π (AutoML + –ø—Ä–∞–≤–∏–ª–∞)

## üìê UML-–¥–∏–∞–≥—Ä–∞–º–º–∞ (PlantUML)

```plantuml
@startuml
entity "WindowFnResolver" as WF
entity "ForecastEngine" as FE
entity "ClusterEngine" as CE
WF --> FE
WF --> CE
Executor --> WF
Executor --> FE
@enduml
```

## üè¢ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –û—Ü–µ–Ω–∫–∞ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è, –ø—Ä–æ–≥–Ω–æ–∑ –ø—Ä–æ–¥–∞–∂
* –°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ ABC-–∞–Ω–∞–ª–∏–∑
* –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤ –±–µ–∑ –≤–Ω–µ—à–Ω–µ–≥–æ –∫–æ–¥–∞

## üìú –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0: –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –∞–≥—Ä–µ–≥–∞—Ç—ã (–∏—é–ª—å 2025)
* v1.1: –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏–∏ –∏ ARIMA (–∞–≤–≥—É—Å—Ç 2025)
* v1.2: –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (—Å–µ–Ω—Ç—è–±—Ä—å 2025)

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –º–æ–¥–µ–ª–∏ (–≤ —Å–ª—É—á–∞–µ UDF)
* –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ CPU –ø—Ä–∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–∏
* –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∫ –æ–±—É—á–∞—é—â–∏–º –¥–∞–Ω–Ω—ã–º

## üì¢ –°–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—à–∏–±–∫–∏

| –ö–æ–¥     | –°–æ–æ–±—â–µ–Ω–∏–µ                       | –û–ø–∏—Å–∞–Ω–∏–µ                                    |
| ------- | ------------------------------- | ------------------------------------------- |
| `WF001` | "Invalid frame specification"   | –û—à–∏–±–∫–∞ –≤ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ä–∞–º–∫–∏ –æ–∫–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ |
| `FC002` | "Forecast model not found"      | –£–∫–∞–∑–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞        |
| `CL003` | "Clustering failed to converge" | –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ –¥–æ—Å—Ç–∏–≥–ª–∞ —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏      |
