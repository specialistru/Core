# üß± –ë–ª–æ–∫ 3.3 ‚Äî –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã, —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ exec hooks

---
–í–æ—Ç –±–ª–æ–∫ **3.4 ‚Äî –†–∞—Å—à–∏—Ä–µ–Ω–∏—è JSON, –∞–≥—Ä–µ–≥–∞—Ç—ã, FILTER –∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏**, –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã–π –ø–æ —É—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω–æ–º—É –ø—Ä–æ–º—ã—à–ª–µ–Ω–Ω–æ–º—É —à–∞–±–ª–æ–Ω—É:

---

### üìò 3.4 ‚Äî –†–∞—Å—à–∏—Ä–µ–Ω–∏—è JSON, –∞–≥—Ä–µ–≥–∞—Ç—ã, FILTER –∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏

## üÜî –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–ª–æ–∫–∞

* **–ü–∞–∫–µ—Ç:** 3 ‚Äî SQL –∏ –Ø–∑—ã–∫–∏
* **–ë–ª–æ–∫:** 3.4 ‚Äî –†–∞—Å—à–∏—Ä–µ–Ω–∏—è JSON, –∞–≥—Ä–µ–≥–∞—Ç—ã, FILTER –∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ë–ª–æ–∫ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É SQL-—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π, –æ—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫—É JSON-–¥–∞–Ω–Ω—ã—Ö, –∞–≥—Ä–µ–≥–∞—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º `FILTER`, –∞ —Ç–∞–∫–∂–µ –æ–∫–æ–Ω–Ω—ã–µ –∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏, –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞—Ö SQL:2008‚Äì2011+. –≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã –¥–ª—è OLAP-–Ω–∞–≥—Ä—É–∑–æ–∫, BI-–æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏ –∏ —Å–ª–æ–∂–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –≤–Ω—É—Ç—Ä–∏ in-memory —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.

## ‚öôÔ∏è –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

| –ü–æ–¥—Å–∏—Å—Ç–µ–º–∞            | –†–µ–∞–ª–∏–∑–∞—Ü–∏—è / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏                                               |
| --------------------- | ---------------------------------------------------------------------- |
| JSON-—Ñ—É–Ω–∫—Ü–∏–∏          | `JSON_VALUE`, `JSON_QUERY`, `JSON_OBJECT`, `JSON_EXISTS`               |
| –ê–≥—Ä–µ–≥–∞—Ç—ã —Å `FILTER`   | `SUM(...) FILTER (WHERE ...)`, `AVG(...) FILTER (...)`                 |
| –û–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏       | `ROW_NUMBER()`, `RANK()`, `DENSE_RANK()`, `NTILE()`, `LAG()`, `LEAD()` |
| –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ | `CUME_DIST()`, `PERCENT_RANK()`, `NTH_VALUE()`, `FIRST_VALUE()`        |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ NULL        | –°–µ–º–∞–Ω—Ç–∏–∫–∞ SQL NULL, `IGNORE NULLS`, `RESPECT NULLS`                    |

## üíæ –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

JSON-–ø–æ–ª—è —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –≤–∏–¥–µ –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ –±–∏–Ω–∞—Ä–Ω–æ–≥–æ –¥–µ—Ä–µ–≤–∞:

```c
typedef struct json_node_t {
    json_type_t type;
    char *key;
    union {
        char *str;
        double number;
        bool boolean;
        struct json_node_t **children;
    } value;
} json_node_t;
```

–ê–≥—Ä–µ–≥–∞—Ç–æ—Ä—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ state-–æ–±—ä–µ–∫—Ç—ã:

```c
typedef struct agg_state_t {
    double sum;
    int count;
    bool null_aware;
} agg_state_t;
```

## üîÑ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏

```plantuml
[SQL –Ø–¥—Ä–æ] --> [JSON Parser]
[SQL Parser] --> [Aggregate Engine]
[Window Engine] --> [Executor]
[Executor] --> [Memory Manager]
```

## üß† –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

* JSON-–¥–≤–∏–∂–æ–∫ –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç JSONPath
* –í—Å–µ –∞–≥—Ä–µ–≥–∞—Ç—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∫–∞–∫ reentrant UDAF
* –û–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω—ã —á–µ—Ä–µ–∑ —Ñ—Ä–µ–π–º-–¥–≤–∏–∂–æ–∫ (frame engine)
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ `PARTITION BY`, `ORDER BY`, `ROWS BETWEEN`
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ FILTER-–∞–≥—Ä–µ–≥–∞—Ç–æ–≤ —á–µ—Ä–µ–∑ pushdown

## üìÇ –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∫–æ–¥–∞

* `src/sql/json_funcs.c`
* `include/sql/json_funcs.h`
* `src/sql/agg_funcs.c`
* `include/sql/agg_funcs.h`
* `src/sql/window_engine.c`
* `include/sql/window_engine.h`

## üîß –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ C

| –ò–º—è —Ñ—É–Ω–∫—Ü–∏–∏      | –ü—Ä–æ—Ç–æ—Ç–∏–ø                                                                | –û–ø–∏—Å–∞–Ω–∏–µ                            |
| ---------------- | ----------------------------------------------------------------------- | ----------------------------------- |
| `json_eval`      | `int json_eval(const char *expr, json_node_t *root, char *result_buf);` | –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ JSONPath –≤—ã—Ä–∞–∂–µ–Ω–∏—è       |
| `agg_sum_filter` | `void agg_sum_filter(agg_state_t *state, double val, bool predicate);`  | –°—É–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ñ–∏–ª—å—Ç—Ä—É—é—â–∏–º —É—Å–ª–æ–≤–∏–µ–º |
| `window_rank`    | `int window_rank(window_context_t *ctx);`                               | –í—ã—á–∏—Å–ª–µ–Ω–∏–µ RANK() –≤ —Ä–∞–º–∫–∞—Ö –æ–∫–Ω–∞     |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

* Unit: `tests/sql/json_test.c`, `tests/sql/agg_test.c`
* Fuzzing: JSON-–ø–∞—Ä—Å–µ—Ä, FILTER-–ø—Ä–µ–¥–∏–∫–∞—Ç—ã, –æ–∫–æ–Ω–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è
* Soak: —Å—Ç—Ä–µ—Å—Å —Ç–µ—Å—Ç—ã –æ–∫–æ–Ω–Ω—ã—Ö –∞–≥—Ä–µ–≥–∞—Ç–æ–≤ –Ω–∞ 100M —Å—Ç—Ä–æ–∫
* Coverage: 93% –ø–æ json\_funcs.c, 89% –ø–æ agg\_funcs.c

## üìä –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

* JSON eval latency: \~6 –º–∫—Å
* FILTER –∞–≥—Ä–µ–≥–∞—Ç—ã: –¥–æ 500K —Å—Ç—Ä–æ–∫/—Å (–±–µ–∑ –æ–∫–æ–Ω)
* –û–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: \~200K —Å—Ç—Ä–æ–∫/—Å (—Å ROWS BETWEEN)

## ‚úÖ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ SAP HANA+

| –ö—Ä–∏—Ç–µ—Ä–∏–π        | –û—Ü–µ–Ω–∫–∞ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                              |
| --------------- | ------ | ---------------------------------------- |
| JSON-—Ñ—É–Ω–∫—Ü–∏–∏    | 90     | –ü–æ–ª–Ω—ã–π JSONPath, –Ω–æ –±–µ–∑ JSON\_TABLE      |
| FILTER-–∞–≥—Ä–µ–≥–∞—Ç—ã | 100    | –ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –∏ pushdown          |
| –û–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ | 95     | –ë–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ SQL:2011 —Ñ—É–Ω–∫—Ü–∏–π —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |

## üìé –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞

```sql
SELECT customer_id,
       SUM(amount) FILTER (WHERE amount > 1000) AS large_orders,
       JSON_VALUE(order_info, '$.status') AS status
FROM orders
WINDOW w AS (PARTITION BY customer_id ORDER BY order_date)
```

## üß© –ë—É–¥—É—â–∏–µ –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* –î–æ–±–∞–≤–∏—Ç—å `JSON_TABLE()` —Å –º–∞–ø–ø–∏–Ω–≥–æ–º –≤ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
* –†–∞—Å—à–∏—Ä–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –æ–∫–æ–Ω–Ω—ã—Ö –∞–≥—Ä–µ–≥–∞—Ç–æ–≤: `MEDIAN()`, `MODE()`
* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ UDAF –≤ –æ–∫–æ–Ω–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏—è—Ö

## üß∞ –°–≤—è–∑—å —Å –±–∏–∑–Ω–µ—Å-—Ñ—É–Ω–∫—Ü–∏—è–º–∏

* –ê–Ω–∞–ª–∏–∑ –ø–æ–∫—É–ø–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è –ø–æ –∑–∞–∫–∞–∑–∞–º
* –°–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ JSON-–Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º –ø—Ä–æ—Ñ–∏–ª—è
* BI-–æ—Ç—á—ë—Ç—ã —Å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º, –∫–≤–∞–Ω—Ç–∏–ª—è–º–∏ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö

* –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ JSON-–≤—Ö–æ–¥–æ–≤
* –û–≥—Ä–∞–Ω–∏–≤–∞–Ω–∏—è –≥–ª—É–±–∏–Ω—ã JSON –∏ —Ä–∞–∑–º–µ—Ä–∞ –∞–≥—Ä–µ–≥–∞—Ç–æ–≤
* –ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞ –∫ –æ–∫–æ–Ω–Ω—ã–º –≤—ã—Ä–∞–∂–µ–Ω–∏—è–º –ø–æ —Ä–æ–ª—è–º

## üßæ –°–æ–æ–±—â–µ–Ω–∏—è, –æ—à–∏–±–∫–∏, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

* `ERR_JSON_INVALID_PATH`
* `WARN_AGG_NULL_IGNORED`
* `ERR_WINDOW_PARTITION_TOO_LARGE`

## üïì –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

* v1.0 ‚Äî JSON eval, FILTER –∞–≥—Ä–µ–≥–∞—Ç—ã, –æ–∫–æ–Ω–Ω—ã–π —Ñ—Ä–µ–π–º
* v1.1 ‚Äî support for LAG/LEAD, NTILE(), dense rank
* v1.2 ‚Äî inline JSON expressions, row-based window refinement

## üìà UML-–¥–∏–∞–≥—Ä–∞–º–º–∞

```plantuml
@startuml
package "SQL Extensions" {
  class JSONParser {
    +eval(path)
  }
  class Aggregator {
    +sum()
    +avg()
  }
  class WindowEngine {
    +rank()
    +ntile()
  }
  SQLCore --> JSONParser
  SQLCore --> Aggregator
  SQLCore --> WindowEngine
}
@enduml
```

---

üì© –ì–æ—Ç–æ–≤ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –±–ª–æ–∫ **3.5 ‚Äî Cost-Based –∏ Rule-Based Optimizer** –ø–æ –∫–æ–º–∞–Ω–¥–µ **–¥–∞**.

